Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),r=n.length>>>0,i=arguments[1],a=0;a<r;a++)if(t=n[a],e.call(i,t,a,n))return t}}),String.prototype.splice||(String.prototype.splice=function(e,t,n){"use strict";return this.slice(0,e)+n+this.slice(e+Math.abs(t))}),String.prototype.capitalize||(String.prototype.capitalize=function(){"use strict";return this.toUpperCase()+this.slice(1)}),String.prototype.repeat||(String.prototype.repeat=function(e){"use strict";if(null===this)throw new TypeError("can't convert "+this+" to object");var t=String(this),n=Number(e);if(n!==e&&(e=0),n<0)throw new RangeError("repeat count must be non-negative");if(n===1/0)throw new RangeError("repeat count must be less than infinity");if(n=Math.floor(n),0===t.length||0===n)return"";if(t.length*n>=1<<28)throw new RangeError("repeat count must not overflow maximum string size");for(var r="";1==(1&n)&&(r+=t),0!==(n>>>=1);)t+=t;return r});var compareUnorderedArray=function(e,t){if(e.length!==t.length)return!1;var n={};return e.forEach(function(e){n[e]=++n[e]||1}),t.every(function(e){return n[e]--})},anonymizePhoneNumber=function(e){if(null==e)return null;if(config&&config.debug)return e;var t="";return 0===e.indexOf("+")&&(t="+"),t=4<e.length?t+"*".repeat(e.length-4-t.length)+e.slice(e.length-4):e},sortObjectByProperty=function(n){return function(e,t){return e[n]<t[n]?-1:e[n]>t[n]?1:0}},minFirefoxWebRTCVersion=38,minChromeWebRTCVersion=42,minEdgeWebRTCVersion=25;function serializeAllPromises(t,n){return 0===t?Promise.resolve():n[t-=1].then(function(){serializeAllPromises(t,n)}).catch(function(e){serializeAllPromises(t,n)})}function RBError(e,t){this.name="RainbowError",this.message=e,this.details=t,this.stack=(new Error).stack}RBError.prototype=Object.create(Error.prototype),RBError.prototype.constructor=RBError;var version="1.48.2";window.sdkversion="1.48.1",window.app=angular.module("rainbow",["angular-jwt"]),window.rainbowAdmin=angular.module("rainbowAdmin",[]),window.rainbow=angular.module("rainbow",["rainbowAdmin"]),angular.module("rainbow").factory("Company",[function(){"use strict";function r(t){var n=this;r.attributes.forEach(function(e){angular.isDefined(t[e.name])?n[e.name]=t[e.name]:angular.isDefined(e.defaultValue)&&(n[e.name]=e.defaultValue)}),this.state=t.state?t.state:"USA"===t.country?"ALABAMA":null,this.logo=null,this.filterName=this.name.toLowerCase(),this.updateFromData=function(t){r.attributes.forEach(function(e){angular.isDefined(t[e.name])&&(n[e.name]=t[e.name])})},this.isActive=function(){return"active"===this.status},this.isInitializing=function(){return"initializing"===this.status},this.isInvited=function(){return"invited"===this.status},this.isFreemium=function(){return"freemium"===this.offerType},this.isPremium=function(){return"premium"===this.offerType}}return r.createFromData=function(e){return new r(e)},r.create=function(e,t){return new r({id:e,name:t})},r.prune=function(e,t){var n=Object.assign({},e);return delete n.dataLocation,n.isBP||(delete n.bpType,delete n.bpBusinessModel,delete n.bpApplicantNumber,delete n.bpCRDid,delete n.bpHasRightToSell,delete n.bpHasRightToConnect,delete n.bpIsContractAccepted),t&&(t.isSuperadmin()||t.isBPAdminFinance())||(delete n.bpType,delete n.adminHasRightToUpdateSubscriptions,delete n.adminAllowedUpdateSubscriptionsOps),""===n.economicActivityClassification&&delete n.economicActivityClassification,t&&(t.isSuperadmin()||null!==n.supportEmail&&""!==n.supportEmail)||delete n.supportEmail,t&&(t.isSuperadmin()||null!==n.privateDC&&""!==n.privateDC)||delete n.privateDC,n},r.StatusValues=["initializing","active","alerting","hold","terminated"],r.VisibilityValues=["private","organization","public"],r.VisibilityValuesWithoutOrg=["private","public"],r.SizeValues=["self-employed","1-10 employees","11-50 employees","51-200 employees","201-500 employees","501-1000 employees","1001-5000 employees","5001-10,000 employees","10,001+ employees"],r.OfferTypes=["freemium","premium"],r.BPTypes=["VAD","DR","IR"],r.BPTypeLabels={IR:"Indirect Reseller",VAD:"Value Added Distributor",DR:"Direct Reseller"},r.BPBusinessModels=["resell"],r.BPBusinessModelLabels={resell:"Resell",referral:"Referral"},r.adminAllowedUpdateSubscriptionsOperations=["all","increase_only"],r.EconomicActivityClassificationTypes={NONE:"notDefined-f",A:"agriculture",B:"mining",C:"manufacturing",D:"electricity",E:"water supply",F:"construction",G:"wholesale",H:"transportation",I:"accommodation",J:"information and communication",K:"financial",L:"real estate activities",M:"professional",N:"administrative",O:"public administration",P:"education",Q:"human health",R:"arts",S:"other service activities",T:"activities of households as employer",U:"activities of extraterritorial organisations and bodies"},r.PrivateDCValues=["HDS"],r.attributes=[{name:"id",defaultValue:void 0},{name:"name",defaultValue:""},{name:"companyContactId",defaultValue:void 0},{name:"adminEmail",defaultValue:""},{name:"supportEmail",defaultValue:void 0},{name:"status",defaultValue:"active"},{name:"economicActivityClassification",defaultValue:"NONE"},{name:"website",defaultValue:void 0},{name:"description",defaultValue:void 0},{name:"visibility",defaultValue:"private"},{name:"visibleBy",defaultValue:[]},{name:"organisationId",defaultValue:""},{name:"userSelfRegisterEnabled",defaultValue:!1},{name:"userSelfRegisterAllowedDomains",defaultValue:[]},{name:"offerType",defaultValue:"freemium"},{name:"country",defaultValue:void 0},{name:"state",defaultValue:null},{name:"size",defaultValue:void 0},{name:"slogan",defaultValue:void 0},{name:"isBP",defaultValue:!1},{name:"bpType",defaultValue:void 0},{name:"bpBusinessModel",defaultValue:void 0},{name:"bpApplicantNumber",defaultValue:void 0},{name:"bpCRDid",defaultValue:void 0},{name:"bpHasRightToSell",defaultValue:void 0},{name:"bpId",defaultValue:void 0},{name:"bpHasRightToConnect",defaultValue:void 0},{name:"adminHasRightToUpdateSubscriptions",defaultValue:!1},{name:"adminAllowedUpdateSubscriptionsOps",defaultValue:"all"},{name:"externalReference",defaultValue:void 0},{name:"externalReference2",defaultValue:void 0},{name:"lastAvatarUpdateDate",defaultValue:null},{name:"lastBannerUpdateDate",defaultValue:null},{name:"avatarShape",defaultValue:"circle"},{name:"catalogId",defaultValue:void 0},{name:"office365Tenant",defaultValue:void 0},{name:"isCentrex",defaultValue:void 0},{name:"tenantCallNumber",defaultValue:void 0},{name:"tenantName",defaultValue:void 0},{name:"numberUsers",defaultValue:void 0},{name:"giphyEnabled",defaultValue:!0},{name:"dataLocation",defaultValue:void 0},{name:"privateDC",defaultValue:void 0}],r}]),angular.module("rainbow").filter("companyOfferFilter",[function(){"use strict";return function(e){return"freemium"===e?"Freemium":"premium"===e?"Premium":e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():e}}]),angular.module("rainbow").factory("CompanyInvitation",[function(){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d,u,f,h){this.id=e,this.companyId=t,this.companyName=n,this.invitedUserId=r,this.invitedUserEmail=i,this.invitingAdminId=a,this.invitingAdminLoginEmail=o,this.invitationDate=s,this.lastNotificationDate=c,this.requestedNotificationLanguage=l,this.status=d,this.acceptationDate=u,this.declinationDate=f,this.invitedToBeCompanyAdmin=h}return t.createFromData=function(e){return new t(e.id,e.companyId,e.companyName,e.invitedUserId,e.invitedUserEmail,e.invitingAdminId,e.invitingAdminLoginEmail,e.invitationDate,e.lastNotificationDate,e.requestedNotificationLanguage,e.status,e.acceptationDate,e.declinationDate,e.invitedToBeCompanyAdmin)},t}]);var FileState=function(){function e(){}return e.DELETED="deleted",e.UPLOADING="uploading",e.UPLOADED="uploaded",e.NOT_UPLOADED="not_uploaded",e.DOWNLOADING="downloading",e.UNKNOWN="unknown",e}(),ThumbnailPlaceholder=function(e,t){this.icon=e,this.style=t},Thumbnail=function(){function e(e){e?(this.availableThumbnail=e.availableThumbnail,this.md5sum=e.md5sum,this.size=e.size,this.wantThumbnailDate=e.wantThumbnailDate):this.availableThumbnail=!1}return e.prototype.isThumbnailAvailable=function(){return this.availableThumbnail},e}(),FileDescriptor=function(){function e(e,t,n,r,i,a,o,s,c,l,d,u,f,h){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===a&&(a=null),void 0===o&&(o=null),void 0===s&&(s=null),void 0===c&&(c=null),void 0===l&&(l=null),void 0===d&&(d=null),void 0===u&&(u=null),void 0===f&&(f=null),this.id=e,this.url=t,this.ownerId=n,this.fileName=r,this.extension=i,this.typeMIME=a,this.thumbnailPlaceholder=this.getThumbnailPlaceholderFromMimetype(a),this.size=o,this.registrationDate=s,this.uploadedDate=c,this.dateToSort=l,this.viewers=d,this.state=u,this.thumbnail=new Thumbnail(f),this.fileToSend=void 0,this.previewBlob=void 0,this.orientation=h||void 0}return e.prototype.isMicrosoftFile=function(){var t=this;return["docx","doc","ppt","pptx","xls","xlsx"].some(function(e){return e===t.extension})},e.prototype.isThumbnailPossible=function(){return this.isImage()||this.isPDF()},e.prototype.isPDF=function(){return"application/pdf"===this.typeMIME},e.prototype.isImage=function(){var e="image/";return this.typeMIME&&this.typeMIME.length>=e.length&&this.typeMIME.slice(0,e.length)===e},e.prototype.isAudioVideo=function(){var t=this;return["avi","mpg","wma","mp3","wmv","mkv","mov","wav","ogg","mp4","aac"].some(function(e){return e===t.extension})},e.prototype.isUploaded=function(){return this.state&&this.state===FileState.UPLOADED},e.prototype.isAlreadyFileViewer=function(t){return!(!this.ownerId||this.ownerId!==t)||!!this.viewers&&this.viewers.some(function(e){return e.viewerId===t})},e.prototype.getDisplayName=function(){return this.fileName.replace(/\.[^/.]+$/,"")},e.prototype.getDisplayNameTruncated=function(){var e=this.fileName.replace(/\.[^/.]+$/,"");return[e.substring(0,e.length-4),e.slice(-4)]},e.prototype.getExtension=function(){return this.fileName.toUpperCase()===this.extension.toUpperCase()?"":"."+this.extension},e.prototype.getThumbnailPlaceholderFromMimetype=function(e){return e?0===e.indexOf("image")?new ThumbnailPlaceholder("icon_image","imageStyle"):"application/msword"===e||/^application\/vnd.openxmlformats-officedocument.wordprocessingml.*$/.test(e)||"application/vnd.oasis.opendocument.text"===e?new ThumbnailPlaceholder("icon_doc","docStyle"):/^application\/vnd.ms-powerpoint.*$/.test(e)||/^application\/vnd.openxmlformats-officedocument.presentationml.*$/.test(e)||"application/vnd.oasis.opendocument.presentation"===e?new ThumbnailPlaceholder("icon_ppt","pptStyle"):0===e.indexOf("application/vnd.ms-excel")||/^application\/vnd.openxmlformats-officedocument.spreadsheetml.*$/.test(e)?new ThumbnailPlaceholder("icon_xls","xlsStyle"):"application/pdf"===e||"application/vnd.oasis.opendocument.spreadsheet"===e?new ThumbnailPlaceholder("icon_pdf","pdfStyle"):0===e.indexOf("video/")||0===e.indexOf("audio/")?new ThumbnailPlaceholder("icon_file-video","imageStyle"):new ThumbnailPlaceholder("icon_filestandard","otherStyle"):new ThumbnailPlaceholder("icon_filestandard","otherStyle")},e.prototype.releaseURL=function(){this.localURL=void 0},e}();function FileDescriptorFactory(){return function(e,t,n,r,i,a,o,s,c,l,d,u,f,h){return new FileDescriptor(e,t,n,r,i,a,o,s,c,l,d,u,f,h)}}angular.module("rainbow").factory("fileDescriptorFactory",[FileDescriptorFactory]);var FileViewerType=function(){function e(){}return e.USER="user",e.ROOM="room",e}(),FileViewer=function(){function e(e,t,n,r,i){void 0===r&&(r=null),void 0===i&&(i=null),this.contactService=r,this.channelService=i,this.viewerId=e,this.type=t,this.contact=n}return Object.defineProperty(e.prototype,"avatarSrc",{get:function(){var t=this;if("user"===this.type&&this.contact)this._avatarSrc=this.contact.avatar.src;else if("channel"===this.type&&this.channel)this._avatarSrc=this.channel.getAvatarSrc();else if(this._avatarSrc=null,"user"===this.type&&this.contactService.getContactByDBId(this.viewerId).then(function(e){t.contact=e,t._avatarSrc=t.contact.avatar.src}),"channel"===this.type){var e=this.channelService.getChannelFromCache(this.viewerId,!1);e&&(this.channel=e,this._avatarSrc=this.channel.getAvatarSrc())}return this._avatarSrc},enumerable:!0,configurable:!0}),e}();function FileViewerFactory(){return function(e){for(var t=[],n=0,r=e;n<r.length;n++){var i=r[n];t.push(new FileViewer(i.viewerId,i.type,i.contact,i.contactService,i.channelService))}return t}}function FileViewerElementFactory(){return function(e,t,n,r,i){return new FileViewer(e,t,n,r,i)}}angular.module("rainbow").factory("fileViewerFactory",[FileViewerFactory]),angular.module("rainbow").factory("fileViewerElementFactory",[FileViewerElementFactory]),angular.module("rainbow").factory("CompanyRequest",[function(){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d){this.id=e,this.requestingUserId=t,this.requestingUserLoginEmail=n,this.requestedCompanyId=r,this.requestedCompanyName=i,this.status=a,this.requestingDate=o,this.requestedNotificationLanguage=s,this.lastNotificationDate=c,this.requestedToCompanyAdmin=l,this.requestedCompanyInvitationId=d}return t.createFromData=function(e){return new t(e.id,e.requestingUserId,e.requestingUserLoginEmail,e.requestedCompanyId,e.requestedCompanyName,e.status,e.requestingDate,e.requestedNotificationLanguage,e.lastNotificationDate,e.requestedToCompanyAdmin,e.requestedCompanyInvitationId)},t}]),angular.module("rainbow").factory("CompanyBpLinkInvitation",[function(){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d,u,f,h,p){this.id=e,this.invitedCompanyId=t,this.invitedCompanyName=n,this.invitedToBeBpIr=r,this.invitingAdminId=i,this.invitingAdminLoginEmail=a,this.invitingCompanyId=o,this.invitingCompanyName=s,this.invitationDate=c,this.lastNotificationDate=l,this.requestedNotificationLanguage=d,this.status=u,this.acceptationDate=f,this.cancelationDate=h,this.declinationDate=p}return t.createFromData=function(e){return new t(e.id,e.invitedCompanyId,e.invitedCompanyName,e.invitedToBeBpIr,e.invitingAdminId,e.invitingAdminLoginEmail,e.invitingCompanyId,e.invitingCompanyName,e.invitationDate,e.lastNotificationDate,e.requestedNotificationLanguage,e.status,e.acceptationDate,e.cancelationDate,e.declinationDate)},t}]),angular.module("rainbow").factory("CompanyBpLinkRequest",[function(){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d,u,f,h,p){this.id=e,this.requestingAdminId=t,this.requestingAdminLoginEmail=n,this.requestingCompanyId=r,this.requestingCompanyName=i,this.requestedCompanyId=a,this.requestedCompanyName=o,this.requestedToBeBpIr=s,this.requestDate=c,this.lastNotificationDate=l,this.requestedNotificationLanguage=d,this.status=u,this.acceptationDate=f,this.cancelationDate=h,this.declinationDate=p}return t.createFromData=function(e){return new t(e.id,e.requestingAdminId,e.requestingAdminLoginEmail,e.requestingCompanyId,e.requestingCompanyName,e.requestedCompanyId,e.requestedCompanyName,e.requestedToBeBpIr,e.requestDate,e.lastNotificationDate,e.requestedNotificationLanguage,e.status,e.acceptationDate,e.cancelationDate,e.declinationDate)},t}]),angular.module("rainbow").factory("Conference",[function(){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d,u,f){this.companyId=e,this.id=t,this.mediaType=n,this.name=r,this.passCodes=i||[],this.scheduled=a,this.scheduledDuration=o,this.scheduledEndDate=s,this.scheduledStartDate=c,this.lastUpdateDate=l,this.scheduledTimezone=d,this.userId=u,this.confDialOutDisabled=f,this.updateFromData=function(e){this.companyId=e.companyId,this.id=e.id,this.mediaType=e.mediaType,this.name=e.name,this.passCodes=e.passCodes,this.scheduled=e.scheduled,this.scheduledDuration=e.scheduledDuration,this.scheduledEndDate=e.scheduledEndDate,this.scheduledStartDate=e.scheduledStartDate,this.lastUpdateDate=e.lastUpdateDate,this.scheduledTimezone=e.scheduledTimezone,this.userId=e.userId,this.confDialOutDisabled=e.confDialOutDisabled}}return t.createFromData=function(e){return new t(e.companyId,e.id,e.mediaType,e.name,e.passCodes,e.scheduled,e.scheduledDuration,e.scheduledEndDate,e.scheduledStartDate,e.lastUpdateDate,e.scheduledTimezone,e.userId,e.confDialOutDisabled)},t}]),angular.module("rainbow").factory("ConferenceSession",["$log","ConferenceParticipant","contactService","$q",function(a,o,s,c){"use strict";function i(e,t,n,r){var i=this;i.id=e,i.participants=t,i.active=n,i.talkerActive=void 0,i.recordingStarted=void 0,i.talkers=void 0,i.isLeaderAlreadyConnected=!1,i.status=null,i.localStreams=[],i.sessions={},i.publishers=[],i.type=r,i.callId=null,i.hasLocalVideo=!1,i.jingleJid=null,i.localVideoSessionId=null,i.localSharingSessionId=null,i.haveJoined=!1,i.cleanupSessionData=function(){a.debug("[ConferenceSession] Cleanup for conferenceSession "+i.id),i.participants=[],i.talkerActive=void 0,i.recordingStarted=void 0,i.talkers=void 0,i.isLeaderAlreadyConnected=!1,i.localStreams=[],i.sessions={},i.publishers=[],i.hasLocalVideo=!1,i.metricsState="",i.recordingStarted=!1,i.status="ended",i.hasLocalSharing=!1,i.reversedVideos=!1,i.jingleJid=null,i.localVideoSessionId=null,i.localSharingSessionId=null,i.haveJoined=!1},i.updateFromData=function(e,t,n){i.id=e,i.participants=t,i.active=n},i.updateActiveState=function(e){i.active=e},i.updateStateFromData=function(e,t,n){i.active=e,i.talkerActive=t,i.recordingStarted=n},i.updateParticipants=function(t){return c(function(e){var n=!1;t||e(!1),i.participants||(i.participants=[]),t.forEach(function(e){if(e.participantId){a.debug("[conferenceSession] updateParticipants participantId="+e.participantId);var t=i.getParticipantById(e.participantId);t?(a.debug("[conferenceSession] updateParticipants update participantId="+e.participantId),t.updateFromData(e)):(a.debug("[conferenceSession] updateParticipants create participantId="+e.participantId),i.participants.push(o.createFromData(e)),n=!0)}}),e(n)})},i.removeParticipants=function(e){e&&e.forEach(function(e){var t=i.getParticipantIndexById(e);-1!==t&&(a.debug("[conferenceSession] removeParticipants remove participantId="+e),i.participants.splice(t,1))})},i.removePublisher=function(e){if(e){var t=i.getPublisherIndexById(e);-1!==t&&(a.debug("[conferenceSession] removePublisher remove participantId="+e),i.publishers.splice(t,1))}},i.updateTalkers=function(e){a.debug("[conferenceSession] updateTalkers talkers="+e),i.talkers=e},i.isActive=function(){return void 0!==i.active&&i.active},i.isTalkerActive=function(){return void 0!==i.talkerActive&&i.talkerActive},i.isRecordingStarted=function(){return void 0!==i.recordingStarted&&i.recordingStarted},i.getParticipants=function(){return i.participants},i.getConnectedParticipants=function(){return i.participants?i.participants.filter(function(e){return"disconnected"!==e.state}):void 0},i.getConnectedParticipantsExceptLeader=function(){return i.participants?i.participants.filter(function(e){return"disconnected"!==e.state&&"moderator"!==e.role}):void 0},i.getConnectedParticipantsExcept=function(t){return i.participants?i.participants.filter(function(e){return e.jid_im!==t&&"disconnected"!==e.state}):void 0},i.getLeaderParticipant=function(){return i.participants?i.participants.find(function(e){return"moderator"===e.role&&"disconnected"!==e.state}):void 0},i.getParticipantById=function(t){return i.participants?i.participants.find(function(e){return e.participantId===t}):void 0},i.getParticipantByJid=function(t){return i.participants?i.participants.find(function(e){return e.jid_im===t}):void 0},i.getParticipantIndexById=function(t){return i.participants?i.participants.findIndex(function(e){return e.participantId===t}):-1},i.getPublisherIndexById=function(t){return i.publishers?i.publishers.findIndex(function(e){return e.participantId===t}):-1},i.isParticipantConnectedByJid=function(t){return void 0!==i.participants&&i.participants.some(function(e){return e.jid_im===t&&"connected"===e.state})},i.isParticipantRingingByJid=function(t){return void 0!==i.participants&&i.participants.some(function(e){return e.jid_im===t&&"ringing"===e.state})},i.isParticipantConnectedWithThisUAByJid=function(t){return i.haveJoined&&void 0!==i.participants&&i.participants.some(function(e){return e.jid_im===t&&"connected"===e.state})},i.getTalkers=function(){return i.talkers},i.setCallId=function(e){i.callId=e},i.getListOfRemoteVideoPublishers=function(){var e=[];if(i.publishers)for(var t=0;t<i.publishers.length;t++)"video"===i.publishers[t].mediaType&&i.publishers[t].jid_im!==s.userContact.jid&&e.push(i.publishers[t]);return e}}return i.createFromData=function(e,t,n,r){return r||(r="pstnAudio"),new i(e,t,n,r)},i}]),angular.module("rainbow").factory("ConferenceParticipant",[function(){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d){this.participantId=e,this.userId=t,this.jid_im=n,this.jid_tel=r,this.role=i,this.mute=a,this.held=o,this.confStartDate=s,this.startDate=c,this.phoneNumber=l,this.state=d,this.updateFromData=function(e){e.userId&&(this.userId=e.userId),this.jid_im=e.jid_im,e.jid_tel&&(this.jid_tel=e.jid_tel),this.role=e.participantRole,this.mute=e.mute,this.held=e.held,this.confStartDate=e.confStartDate,this.startDate=e.startDate,this.phoneNumber=e.phoneNumber,this.state=e.participantState}}return t.createFromData=function(e){return new t(e.participantId,e.userId,e.jid_im,e.jid_tel,e.participantRole,e.mute,e.held,e.confStartDate,e.startDate,e.phoneNumber,e.participantState)},t}]);var ConferenceUser=function(e,t,n,r,i,a,o,s,c){this.id=e,this.providerUserId=t,this.providerCompanyId=n,this.confCompanyId=r,this.userId=i,this.companyId=a,this.firstName=o,this.lastName=s,this.providerType=c};function ConferenceUserFactory(){return function(e){return new ConferenceUser(e.id,e.providerUserId,e.providerCompanyId,e.confCompanyId,e.userId,e.companyId,e.firstName,e.lastName,e.providerType)}}angular.module("rainbow").factory("conferenceUserFactory",ConferenceUserFactory);var Channel=function(){function t(e,t,n,r,i,a,o,s,c,l,d,u){this.userRole="none",this.messageRetrieved=!1,this.messages=[],this.subscribed=!1,this.deleted=!1,this.invited=!1,this.type="SIMPLE",this.pageIndex=0,this.isLoading=!1,this.complete=!1,this.users=[],this.publishersRetreived=!1,this.name=e,this.id=t,this.visibility=n,this.topic=r,this.creatorId=i,this.companyId=a,this.creationDate=o,this.users_count=s,this.lastAvatarUpdateDate=c;var f=this.lastAvatarUpdateDate?(new Date).getTime():null;this.avatar=config.restServerUrl+"/api/channel-avatar/"+t+"?size=256&ts="+f,void 0!==l&&(this.subscribed=l),void 0!==d&&(this.userRole=d),void 0!==u&&(this.invited=u)}return t.prototype.isNotMember=function(){return this.userRole="none"},t.prototype.isOwner=function(){return"owner"===this.userRole},t.prototype.isPublisher=function(){return this.subscribed&&("owner"===this.userRole||"publisher"===this.userRole)},t.prototype.isMember=function(){return"member"===this.userRole},t.prototype.getAvatarSrc=function(){return this.lastAvatarUpdateDate?this.avatar:"/resources/skins/rainbow/images/channels/default_channel_avatar.png"},t.ChannelFactory=function(){return function(e){return new t(e.name,e.id,e.visibility,e.topic,e.creatorId,e.companyId,e.creationDate,e.users_count,e.lastAvatarUpdateDate,e.subscribed,e.type,e.invited)}},t}();angular.module("rainbow").factory("Channel",Channel.ChannelFactory);var SearchTextMsgResult=function(){function e(){this.body=void 0,this.date=void 0,this.isRoom=!1,this.isSent=!1,this.messageId=void 0}return e.SearchTextMsgResultFactory=function(){return function(){return new e}},e}(),SearchTextResult=function(){function e(e){this.totalCount=-1,this.convRes=[],this.otherJid=e}return e.prototype.getResultFromMsgId=function(e){for(var t=0,n=this.convRes;t<n.length;t++){var r=n[t];if(r.messageId===e)return r}},e.prototype.addMsgItem=function(e){this.convRes.push(e)},e.prototype.isRoom=function(){return!!this.conversation&&null!=this.conversation.room},e}(),SearchTextConvResults=function(){function e(){this.searchedText="",this.results=[],this.queryIds=[],this.totalCount=0,this.searchCounter=0}return e.prototype.isEmpty=function(){return 0===this.queryIds.length||0===Object.keys(this.results).length},e.prototype.searchCount=function(){this.searchCounter++},e.prototype.getAvailableCount=function(){for(var e=0,t=0,n=this.results;t<n.length;t++){e+=n[t].convRes.length}return e},e.prototype.getTotalCount=function(){return this.totalCount},e.prototype.clearAll=function(){this.queryIds=[],this.totalCount=0,this.clearMessagesResults()},e.prototype.clearMessagesResults=function(){this.results.splice(0,this.results.length)},e.prototype.isCurrentQuery=function(e){return-1<this.queryIds.indexOf(e)},e.prototype.getItemForConvId=function(e){for(var t=0,n=this.results;t<n.length;t++){var r=n[t];if(r.otherJid===e)return r}},e.prototype.createNewResult=function(e){var t=this.getItemForConvId(e);return t||(t=new SearchTextResult(e),this.results.push(t)),t},e.prototype.addNewItemResult=function(e,t){var n=this.getItemForConvId(e);n||(n=new SearchTextResult(e),this.results.push(n)),n.getResultFromMsgId(t.messageId)||n.addMsgItem(t)},e.prototype.splitText=function(e,t){var n="",r="",i="",a=this.cleanUpSpecialChars(e).toLowerCase(),o=this.cleanUpSpecialChars(t).toLowerCase(),s=a.indexOf(o);return 0<=s?(0<s&&(n=e.slice(0,s)),r=e.slice(s,s+t.length),e.length>t.length+s&&(i=e.slice(s+t.length,e.length))):n=e,[n,r,i]},e.prototype.cleanUpSpecialChars=function(e){return e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/[ÀÁÂÃÄÅ]/g,"A")).replace(/[àáâãäå]/g,"a")).replace(/[ÈÉÊË]/g,"E")).replace(/[éèëê]/g,"e")).replace(/[ÎÏ]/g,"I")).replace(/[îï]/g,"i")).replace(/[ÔÖÕ]/g,"O")).replace(/[ôöõ]/g,"o")).replace(/[ùûü]/g,"u")).replace(/[ç]/g,"c")},e}();function SearchTextConvResultsFactory(){return function(){return new SearchTextConvResults}}angular.module("rainbow").factory("SearchTextConvResultsFactory",SearchTextConvResultsFactory),angular.module("rainbow").factory("SearchTextMsgResultFactory",SearchTextMsgResult.SearchTextMsgResultFactory),angular.module("rainbowAdmin").factory("Offer",[function(){"use strict";function n(e,t,n,r,i,a,o,s,c,l,d,u){this.id=e,this.name=t,this.description=n,this.offerReference=r,this.profileId=i,this.canBeSold=a||!1,this.businessModel=o,this.isPrepaid=l,this.prepaidDuration=d,this.autoSubscribe=u,this.isDefault=s,this.isExclusive=c;var f=this.name.toLowerCase();f&&(-1!==f.indexOf("enterprise")?f="enterprise":-1!==f.indexOf("business")?f="business":-1!==f.indexOf("conference")&&(f="conference")),this.logo="logo-offer-"+f+".svg",this.isEnterprise=function(){return this.name.toLowerCase().startsWith("enterprise")},this.isBusiness=function(){return this.name.toLowerCase().startsWith("business")},this.isEssential=function(){return this.name.toLowerCase().startsWith("essential")},this.isUserLicense=function(){return this.isDefault||"nb_users"===this.businessModel||"usage"===this.businessModel},this.isFixedLicense=function(){return"flat_fee"===this.businessModel},this.isUserBasedLicense=function(){return"nb_users"===this.businessModel},this.isUsageBasedLicense=function(){return"usage"===this.businessModel}}return n.createFromData=function(e){return new n(e.id,e.name,e.description,e.offerReference,e.profileId,e.canBeSold,e.businessModel,e.isDefault,e.isExclusive,e.isPrepaid,e.prepaidDuration,e.autoSubscribe)},n.createFromSubscriptionData=function(e){return new n(e.offerId,e.offerName,void 0,e.offerReference,e.profileId,e.canBeSold,e.businessModel,e.isDefault,e.isExclusive,e.isPrepaid,void 0)},n.createFromSubscriptionCountersData=function(e){return new n(e.offerId,e.offerName,void 0,e.offerReference,void 0,e.canBeSold,e.businessModel,e.isDefault,e.isExclusive,e.isPrepaid,e.prepaidDuration)},n.createFromProfileData=function(e){return new n(e.offerId,e.offerName,void 0,void 0,e.profileId,!1,void 0,e.isDefault,e.isExclusive,e.isPrepaid,e.prepaidDuration)},n.createFromOperationLog=function(e){var t="delete"===e.operationType?e.previousData:e.newData;return new n(t.offerId,t.offerName,t.offerDescription,t.offerReference,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration)},n.offerComparator=function(t,n){var e=["Essential","Business","Enterprise","Conference"],r=e.findIndex(function(e){return t.name.startsWith(e)}),i=e.findIndex(function(e){return n.name.startsWith(e)});return(r=-1===r?e.length:r)<(i=-1===i?e.length:i)?-1:i<r?1:t.name>n.name?r===e.length?1:-1:t.name<n.name?r===e.length?-1:1:0},n.isExclusive=function(e){return e.isDefault||e.isExclusive},n.isOptional=function(e){return!n.isExclusive(e)},n.isEssential=function(e){return e.isDefault},n.isNotEssential=function(e){return!e.isDefault},n.isModelByNbUsers=function(e){return"nb_users"===e.businessModel},n.isPrepaid=function(e){return e.isPrepaid},n.isNotPrepaid=function(e){return!e.isPrepaid},n}]),angular.module("rainbow").factory("Contact",["$q","$rootScope","$interval","$document","$translate","settingsService","Company","$log","randomString","xmppService","authService","utilService",function(o,s,n,c,i,l,t,d,e,a,u,f){"use strict";function h(e,t,n){var r=this;this.id=e,this.jid=e,this.fullJid=null,this.jidtel=null,this.dbId=null,this.login=null,this.temp=!1,this.status="unknown",this.telStatus="",this.imStatus="offline",this.imStatusStamp=[],this.resources={},this.loginEmail="",this.lastname="",this.firstname="",this.company=n,this.nickname="",this.title="",this.jobTitle="",this.country="",this.defaultAvatar=null,this._avatar=null,this._avatarLoading=!1,this.avatarSrc=null,this.timezone="",this.roles=null,this.confId="",this.phonePro="",this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro="",this.mobileProCan="",this.phonePerso="",this.phonePersoCan="",this.mobilePerso="",this.mobilePersoCan="",this.emailPro="",this.emailPerso="",this.oldImStatus=null,this.roster=!1,this.initialized=!1,this._displayName=t||e,this.name={value:this._displayName},this.initials="",this.message="",this.cellStyle="",this.ask="none",this.subscription="none",this.conversation=null,this.adminType=null,this.capabilities=null,this.groups=null,this.mobileResource=null,this.language=null,this.lastActivityDate=null,this.nameUpdatePrio=h.NameUpdatePrio.MAX_UPDATE_PRIO,this.isInDefaultCompany=!1,this.calendarState={},this.guest=!1,this.openInviteId=null,this.isVirtualTerm=!1,s.$on("$destroy",s.$on("ON_DISPLAY_ORDER_EVENT",function(){r.computeDisplayName()})),this.openRoomId=null,s.$on("$destroy",s.$on("ON_DISPLAY_ORDER_EVENT",function(){r.computeDisplayName()}))}return h.create=function(e,t,n,r,i){var a=new h(e,null,r);return t&&n&&(t=t.charAt(0).toUpperCase()+t.slice(1),n=n.charAt(0).toUpperCase()+n.slice(1),a.computeCompleteDisplayName(t,n)),a.login=i,a},h.createByPhoneNumber=function(e){var t=new h(null,e);return t.id=e,t},h.createBotContact=function(e,t,n){var r=new h(e),i=new Image;return i.src="/resources/skins/rainbow/images/emily.jpg",r.lastname=t,r.isBot=!0,r.computeDisplayName(),r.status="online",r.imStatus="online",r.subscription="both",r.avatar=i,r.dbId=n,r},h.updateContactToBot=function(e,t,n){var r=new Image;return r.src="/resources/skins/rainbow/images/emily.jpg",e.lastname=t,e.isBot=!0,e.computeDisplayName(),e.status="online",e.imStatus="online",e.subscription="both",e.avatar=r,e.dbId=n,e},h.AdminType={ORGANIZATION_ADMIN:"organization_admin",COMPANY_ADMIN:"company_admin",SITE_ADMIN:"site_admin",UNDEFINED:"undefined"},h.NameUpdatePrio={NO_UPDATE_PRIO:0,OUTLOOK_UPDATE_PRIO:1,SERVER_UPDATE_PRIO:2,MAX_UPDATE_PRIO:99},Object.defineProperty(h.prototype,"avatar",{set:function(e){this._avatar=e},get:function(){var t=this;if(t._avatar)return t._avatar;if(!t._avatarLoading&&t.avatarSrc){t._avatarLoading=!0;var e=new Image;e.onload=function(){var e=this;n(function(){t._avatar=e,t._avatarLoading=!1,d.log("[contact] Lazily load avatar for "+t.displayNameForLog()+" success"),s.$broadcast("ON_CONTACT_AVATAR_UPDATE",t.jid)},0,1,!0)},e.onerror=function(){d.warn("[contact] Lazily load avatar for "+t.displayNameForLog()+" failure : use text avatar"),t._avatar=t.defaultAvatar,t._avatarLoading=!1},e.src=t.avatarSrc}return t.defaultAvatar}}),Object.defineProperty(h.prototype,"displayName",{set:function(e){this._displayName=e,this.name.value=e,this.displayNameMD5=MD5.hexdigest(e)},get:function(){return this._displayName}}),Object.defineProperty(h.prototype,"lastActivityDate",{set:function(e){this._lastActivityDate=e,this.updateLastActivityMessage()},get:function(){return this._lastActivityDate}}),Object.defineProperty(h.prototype,"statusMessage",{get:function(){if((this._currentStatus!==this.status||this._currentLastActivityMessage!==this.lastActivityMessage||this._currentMessage!==this.message)&&(this._currentStatus=this.status,this._currentMessage=this.message,this._currentLastActivityMessage=this.lastActivityMessage,"unknown"===this.status?this._statusMessage=this.company&&this.company.name?this.company.name:i.instant("unknown"):"offline"===this.status&&""===this.lastActivityMessage?this._statusMessage=i.instant("offlineFilter"):"away"===this.status&&""===this.lastActivityMessage?this._statusMessage=i.instant("shortAway"):this._statusMessage=i.instant(this.status,{offlineDate:this.lastActivityMessage}),this.message)){var e=i.instant(this.message);"("!==e.charAt(0)&&(e="("+e+")"),this._statusMessage+=" "+e}return this._statusMessage}}),Object.defineProperty(h.prototype,"lastActivityMessage",{get:function(){var r=this;if(!r._lastActivityMessage&&!r._lastActivityInProgress){r._lastActivityInProgress=!0;try{a.connection.lastactivity.query(r.jid,{onResponse:function(e){var t=1e3*$(e).find("query").attr("seconds"),n=(new Date).getTime()-t;r.lastActivityDate=new Date(n),r._lastActivityInProgress=!1}})}catch(e){d.error("[Contact] lastActivityDate getter accessor for contact "+r.jid_im+" -- failure : "+e),r._lastActivityInProgress=!1}return null}return this._lastActivityMessage}}),h.prototype.updateLastActivityMessage=function(){if(this._lastActivityDate){var e=moment(this._lastActivityDate);moment.locale().startsWith("de")?this._lastActivityMessage=e.fromNow(!0).replace("Tage","Tagen"):this._lastActivityMessage=e.fromNow(!0)}else this._lastActivityMessage=""},h.prototype.getLastAvailableDate=function(){var n=null,r=this.imStatusStamp;return Object.keys(r).forEach(function(e){var t=r[e];n?n<t&&(n=t):n=t}),n},h.prototype.updateCalendarPresenceInfo=function(){var e=this.calendarState,t=null,n=null,r=e.iconId=null;e.autoReplyOn?(e.iconId="icon_outofoffice",n="<div style='text-align:left'>"+f.escapeHtml(e.autoReplyInfos.message).replace(/\n/g,"<br/>")+"</div>",t={meetingDate:e.autoReplyInfos.until,message:n},r=e.autoReplyInfos.until?e.autoReplyInfos.untilDate?"calendarAutoReply-date":"calendarAutoReply":"calendarAutoReplySimple"):("busy"===e.message?(e.iconId="icon_inameeting",r=e.untilDate?"calendar-busy-date":"calendar-busy"):"out_of_office"===e.message&&(e.iconId="icon_outofoffice",r=e.untilDate?"calendar-outofoffice-date":"calendar-outofoffice"),t={meetingDate:e.until}),r&&(e.tooltip=i.instant(r,t))},h.prototype.displayNameForLog=function(){return config&&config.debug?this.displayName:this.displayNameMD5},h.prototype.isMobileResource=function(e){return-1!==e.indexOf("mobile_android")||-1!==e.indexOf("mobile_ios")},h.prototype.calculateStatusFromResources=function(e){var t="offline",n="",r="",i="",a=this.fullJid,o=!1,s=config.webrtcWithMobiles;for(var c in this.resources)if(this.resources.hasOwnProperty(c)){if("dnd"===this.resources[c].show&&"phone"===this.resources[c].status){t="busy",n="audioPhone",o=!0,a=c;break}if("xa"===this.resources[c].show||"dnd"===this.resources[c].show&&""===this.resources[c].status){var l=!1;this.resources[c].initStamp?r?this.resources[c].initStamp.getTime()>r.getTime()&&(r=this.resources[c].initStamp,l=!0):(r=this.resources[c].initStamp,l=!0):i?this.resources[c].stamp.getTime()>i.getTime()&&(i=this.resources[c].stamp,r=this.resources[c].stamp,l=!0):(i=this.resources[c].stamp,r=this.resources[c].stamp,l=!0),l&&(t=this.resources[c].show,n=this.resources[c].status)}else if("xa"!==t&&("dnd"!==t||"dnd"===t&&""!==n)&&"dnd"===this.resources[c].show&&""!==this.resources[c].status)"presentation"===this.resources[c].status?(t=this.resources[c].show,n="presentation"):(t="busy",n=this.resources[c].status),a=c,o=!0;else{if(e&&"online"===this.resources[c].show&&"mode=auto"===this.resources[c].status&&c===this.fullJid){t="online",n="",this.resources[c].status="",this.isMobileResource(c)?t="online-mobile":o=!0;break}"online"===this.resources[c].show&&"xa"!==t&&"dnd"!==t&&"busy"!==t?(n="","online-mobile"!==t&&(t="online"),this.resources[c].status="",this.isMobileResource(c)?t="online-mobile":(a=c,o=!0),s&&(a=c)):"away"===this.resources[c].show&&"offline"===t&&(t="away",n="",a=c)}"mode=auto"===this.resources[c].status&&(this.resources[c].status="")}for(var c in this.resources)this.resources.hasOwnProperty(c)&&"mode=auto"===this.resources[c].status&&(this.resources[c].status="");return e||this.fullJid||(this.fullJid=a),"online-mobile"===t&&o?(t="online",n=""):"online-mobile"!==t||e||s||(this.fullJid=null,n=""),{presence:t,message:n}},h.prototype.hasAdminRights=function(){return this.isSuperadmin()||this.isAdmin()||this.isBPAdmin()},h.prototype.isSuperadmin=function(){return 0<=this.roles.indexOf("superadmin")},h.prototype.isCPaaSGuest=function(){return 0<=this.roles.indexOf("guest")},h.prototype.isGuest=function(){return this.guestMode},h.prototype.isAdmin=function(){return 0<=this.roles.indexOf("admin")&&(!this.isOrganizationAdmin()||!this.isBPAdmin())},h.prototype.isOrganizationAdmin=function(){return 0<=this.roles.indexOf("admin")&&this.adminType===h.AdminType.ORGANIZATION_ADMIN},h.prototype.isCompanyAdmin=function(){return 0<=this.roles.indexOf("admin")&&this.adminType===h.AdminType.COMPANY_ADMIN},h.prototype.isSiteAdmin=function(){return 0<=this.roles.indexOf("admin")&&this.adminType===h.AdminType.SITE_ADMIN},h.prototype.getAdminType=function(){return 0<=this.roles.indexOf("admin")?this.adminType:h.AdminType.UNDEFINED},h.prototype.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},h.prototype.isBPAdminOperations=function(){return 0<=this.roles.indexOf("bp_admin")},h.prototype.isBPAdminFinance=function(){return 0<=this.roles.indexOf("bp_finance")},h.prototype.updateIMStatus=function(e,t){if(this.imStatusStamp[e.jid]&&this.imStatusStamp[e.jid]>e.stamp)d.info("[Contact] Ignore obsolete presence message for contact "+this.jid);else{d.info("[Contact] updateIMStatus "+JSON.stringify(e)),this.imStatusStamp[e.jid]=e.stamp,e.status&&(this.imStatus=e.status);var n=e.message?e.message:"";if("offline"===this.imStatus)this.fullJid===e.jid&&(this.fullJid=null),delete this.resources[e.jid],delete this.imStatusStamp[e.jid],0===this.resources.length&&(this.message="");else{this.resources[e.jid]?(this.resources[e.jid].show=this.imStatus,this.resources[e.jid].status=n,this.resources[e.jid].stamp=e.stamp):this.resources[e.jid]={show:this.imStatus,status:n,initStamp:e.stamp,stamp:e.stamp},d.info("[Contact] updateIMStatus user resources after update "+JSON.stringify(this.resources)),this.isMobileResource(e.jid)||t||(this.fullJid=e.jid);var r=config.webrtcWithMobiles;!t&&r&&(this.fullJid=e.jid)}if(this.updateRichStatus(t),t&&this.isMobileResource(e.jid)&&("offline"!==e.status&&null===this.mobileResource&&(this.mobileResource=e.jid,d.info("[telephonyService] === STARTED ==="),s.$broadcast("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","started")),"offline"===e.status)){var i=null;for(var a in this.resources)if(this.resources.hasOwnProperty(a)&&this.isMobileResource(a)){i=a;break}this.mobileResource=i,null===this.mobileResource&&s.$broadcast("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","stopped")}}},h.prototype.updateTelephonyStatus=function(e,t){this.telStatus=e,this.updateRichStatus(t)},h.prototype.updatePresenceStatus=function(e){this.status=e},h.prototype.updateRichStatus=function(e){if("EVT_SERVICE_INITIATED"===this.telStatus||"EVT_ESTABLISHED"===this.telStatus)this.status="busy",this.message="audioPhone";else if("subscribe"===this.ask)this.status="wait";else if("none"===this.subscription||"from"===this.subscription)this.status="unknown";else{var t=this.calculateStatusFromResources(e);"xa"===t.presence&&(""!==t.message||e?"away"===t.message&&(t.presence="away",t.message=""):t.presence="offline"),this.status=t.presence,this.message=t.message,e?d.info("[Contact] updateRichStatus MY PRESENCE : "+t.presence+" || message : "+t.message):d.info("[Contact] updateRichStatus presence : "+t.presence+" || message : "+t.message),"offline"!==this.status&&(this.lastActivityDate=null)}e&&s.$broadcast("ON_UPDATE_MYCONTACT_EVENT"),s.$broadcast("ON_UPDATE_CONTACT_RICH_STATUS_EVENT",this)},h.prototype.updateFromUserData=function(e){this.dbId=e.id,this.loginEmail=e.loginEmail,this.firstname=e.firstName,this.lastname=e.lastName,this.nickname=e.nickName?e.nickName:"",this.title=e.title?e.title:"",this.jobTitle=e.jobTitle?e.jobTitle:"",this.organisationId=e.organisationId,this.siteId=e.siteId,this.country=e.country?e.country:"FRA",this.timezone=e.timezone,this.roles=e.roles,this.adminType=e.adminType,this.isBot=!1,this.isTerminated=e.isTerminated,this.isInDefaultCompany=e.isInDefaultCompany,this.lastAvatarUpdateDate=e.lastAvatarUpdateDate,this.initialized=e.isInitialized,this.guestMode=!!e.guestMode&&e.guestMode,this.openInviteId=e.openInviteId?e.openInviteId:this.openInviteId,this.openRoomId=e.openRoomId?e.openRoomId:this.openRoomId,e.jid_im&&(this.id=e.jid_im,this.jid=e.jid_im,this.jidtel=e.jid_tel),this.company&&this.company.id===e.companyId||(this.company=t.create(e.companyId,e.companyName)),this.phonePro=this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro=this.mobileProCan="",this.phonePerso=this.phonePersoCan="",this.mobilePerso=this.mobilePersoCan="",this.voicemailNumber="",this.hasPhoneNumber=!1;var i=this;e.emails&&(i.emailPerso="",e.emails.forEach(function(e){switch(e.type){case"work":i.emailPro=e.email;break;case"home":i.emailPerso=e.email}})),e.phoneNumbers&&(e.phoneNumbers.forEach(function(e){var t=e.number,n=e.numberE164,r=e.deviceType;switch(i.hasPhoneNumber=!0,e.type){case"work":"landline"===r&&(i.phonePro=t,i.phoneProCan=n,e.isFromSystem&&(i.phonePbx=e.shortNumber,e.internalNumber&&(i.phoneInternalNumber=e.internalNumber,"Remote extension"!==e.deviceName&&"TERM_ANY_DEVICE"!==e.deviceName||(i.isVirtualTerm=!0)),i.pbxId=e.pbxId,i.voicemailNumber=e.voiceMailNumber)),"mobile"===r&&(i.mobilePro=t,i.mobileProCan=n);break;case"home":"landline"===r&&(i.phonePerso=t,i.phonePersoCan=n),"mobile"===r&&(i.mobilePerso=t,i.mobilePersoCan=n)}}),this.phoneNumbersInitialized=!0),this.computeDisplayName()},h.prototype.updateName=function(e,t){this.firstname=e,this.lastname=t,this.computeDisplayName(),this.getAvatar()},h.prototype.getNameUpdatePrio=function(){return this.nameUpdatePrio},h.prototype.setNameUpdatePrio=function(e){switch(e){case h.NameUpdatePrio.NO_UPDATE_PRIO:case h.NameUpdatePrio.OUTLOOK_UPDATE_PRIO:case h.NameUpdatePrio.SERVER_UPDATE_PRIO:case h.NameUpdatePrio.MAX_UPDATE_PRIO:this.nameUpdatePrio=e}},h.prototype.containsEmail=function(e){var t=e.toLowerCase();return!(!this.loginEmail||this.loginEmail.toLowerCase()!==t)||(!(!this.emailPro||this.emailPro.toLowerCase()!==t)||!(!this.emailPerso||this.emailPerso.toLowerCase()!==t))},h.prototype.computeDisplayName=function(){var e=this.firstname?this.firstname.charAt(0).toUpperCase()+this.firstname.slice(1):null,t=this.lastname?this.lastname.charAt(0).toUpperCase()+this.lastname.slice(1):null,n=this.nickname?this.nickname.charAt(0).toUpperCase()+this.nickname.slice(1):null;t&&e?this.computeCompleteDisplayName(e,t):t&&!e?(this.displayName=t,this.initials=t.charAt(0)):n?(this.displayName=n,this.initials=n.charAt(0)):this.loginEmail?(this.displayName=this.loginEmail,this.initials=this.loginEmail.substring(0,2).toUpperCase()):(this.displayName="Anonymous",this.initials="A")},h.prototype.computeCompleteDisplayName=function(e,t){var n="",r="";1!==t.length&&2!==e.length?"firstLast"===l.getSetting("displayOrder")?(n=e+" "+t,r=e.charAt(0)+t.charAt(0)):(n=t+" "+e,r=t.charAt(0)+e.charAt(0)):(n="firstLast"===l.getSetting("displayOrder")?e+" "+t:t+" "+e,r=e.charAt(0)+e.charAt(1)),this.displayName=n,this.initials=r;for(var i=this.displayName.toUpperCase(),a=0,o=0;o<i.length;o++)a+=i.charCodeAt(o);this.colorIndex=a%12,this.color=h.textAvatarColor[this.colorIndex]},h.prototype.getAvatarInBase64=function(){var i=this,a=this;return o(function(t){try{if(i&&i.avatar&&i.avatar.src||t(),i.avatar.src&&!i.avatar.src.startsWith("data:image/png")){var e=new Image,n=c[0].createElement("canvas");n.width=120,n.height=120;var r=n.getContext("2d");r.rect(0,0,120,120),r.fillStyle=a.color,r.fill(),e.onload=function(){r.drawImage(this,0,0,120,120);var e=n.toDataURL("image/png");t(e)},e.src=i.avatar.src}else t(i.avatar.src)}catch(e){d.warn("[contactService] getAvatarInBase64 error "+e),t()}})},h.prototype.getAvatar=function(e,t){var n=this;if(n.dbId&&n.lastAvatarUpdateDate){var r=config.webservices.protocol+"://"+config.webservices.currentServer;s.cdn&&(r=s.cdnServer);var i=r+"/api/avatar/"+n.dbId+"?size="+(e||256);i+="&update="+MD5.hexdigest(n.lastAvatarUpdateDate),n.avatarSrc=i}return u.fromSDK?(n.createTextAvatarImage(),o.when()):o(function(e){n.createTextAvatarImage(),!t&&n.lastAvatarUpdateDate||(n.avatar=null),e(n)})},h.prototype.createTextAvatarImage=function(){var e=new Image,t=c[0].createElement("canvas");t.width=e.width=225,t.height=e.height=225;var n=t.getContext("2d");n.rect(0,0,225,225),n.fillStyle=this.color,n.fill(),n.font="bold 100px Helvetica",n.textAlign="center",n.fillStyle="white",n.fillText(this.initials,110,150),e.src=t.toDataURL("image/png"),this.defaultAvatar=e},h.prototype.getGroups=function(){return this.groups},h.prototype.setGroups=function(e){this.groups=e},h.prototype.getOpenInviteId=function(){return this.openInviteId},h.prototype.setOpenInviteId=function(e){this.openInviteId=e},h.prototype.getOpenRoomId=function(){return this.openRoomId},h.prototype.setOpenRoomId=function(e){this.openRoomId=e},h.textAvatarColor=["#ff4500","#d38700","#348833","#007356","#00b2a9","#00b0e5","#0085ca","#6639b7","#91278a","#cf0072","#a50034","#d20000"],h}]),angular.module("rainbow").factory("Conversation",["$log","$rootScope","$interval","$filter","contactService","xmppService","fileTransfertService","Message","uuid4","utilService","fileStorageService","fileServerService","$q","fileViewerFactory","Call","roomService","pstnConferenceService",function(l,d,s,c,u,f,n,h,e,r,p,v,m,g,t,S,C){"use strict";function E(e){this.id=e,this.dbId=null,this.type=null,this.owner=null,this.contact=null,this.room=null,this.capabilities=null,this.avatar=null,this.presenceStatus=null,this.name=function(){return{}},this.filterName="",this.missedCounter=0,this.missedCalls=0,this.messages=[],this.participantStatuses={},this.draft="",this.uploadFiles=null,this.status=E.Status.ACTIVE,this.historyIndex=-1,this.historyMessages=[],this.historyDefered=null,this.historyComplete=!1,this.lastModification=void 0,this.creationDate=new Date,this.lastMessageText="",this.lastMessageSender="",this.pip=!0,this.videoCall={status:t.Status.UNKNOWN},this.audioCall=null,this.pstnConferenceSession=null,this.webConferenceSession=null,this.isMutedAudio=!1,this.isMutedVideo=!1,this.infoVisible=!1,this.muted=!1}E.ChatstatesNS="http://jabber.org/protocol/chatstates",E.ReceiptNS="urn:xmpp:receipts",E.Type={ONE_TO_ONE:0,ROOM:1,BOT:2},E.EventType={NEW:0,IM:1,CAPABILITIES:2,FILE:3},E.Status={ACTIVE:{key:0,value:"active"},INACTIVE:{key:1,value:"inactive"},COMPOSING:{key:2,value:"composing"},PAUSED:{key:3,value:"paused"}},E.createOneToOneConversation=function(e){l.info("[Conversation] Create one to one conversation ("+e.id+")");var t=new E(e.id);return(t.contact=e).conversation=t,e.isBot?(t.avatar="",t.type=E.Type.BOT):(t.avatar=e.avatar?e.avatar.src:null,t.type=E.Type.ONE_TO_ONE),t.name=e.name,e.displayName&&(t.filterName=r.removeDiacritis(e.displayName.toLowerCase())),t},E.createRoomConversation=function(e){l.info("[Conversation] Create room conversation ("+e.jid+")");var t=new E(e.jid);return t.type=E.Type.ROOM,t.room=e,t.filterName=r.removeDiacritis(e.name.toLowerCase()),t.infoVisible=!0,t};var i=e.generate(),a=0;return E.getUniqueMessageId=function(){var e="web_"+i+a;return a++,e},E.stringToStatus=function(e){switch(e){case"composing":return E.Status.COMPOSING;case"paused":return E.Status.PAUSED;default:return E.Status.ACTIVE}},E.prototype.reset=function(){this.messages=[],this.historyIndex=-1,this.historyMessages=[],this.historyComplete=!1,this.currentHistoryId=null,this.lastMessageText=null,this.chatRenderer&&this.chatRenderer.removeAllMessages()},E.prototype.isInCall=function(){return this.pstnConferenceSession?this.pstnConferenceSession.isParticipantConnectedByJid(u.userContact.jid):this.webConferenceSession?this.webConferenceSession.isParticipantConnectedByJid(u.userContact.jid):this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value&&"incommingCall"!==this.audioCall.status.value&&"queued"!==this.audioCall.status.value},E.prototype.isNotInCall=function(){return!(this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value||"busy"===u.userContact.status&&""!==u.userContact.message)},E.prototype.isActive=function(){return this.videoCall&&this.videoCall.status&&"active"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"active"===this.audioCall.status.value},E.prototype.isHeld=function(){return this.videoCall&&this.videoCall.status&&"held"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"held"===this.audioCall.status.value},E.prototype.getMessageById=function(t){return this.messages.find(function(e){return e.id===t})},E.prototype.sendChatMessage=function(e){var t=c("emojiShortToUnicode")(e),n=null,r=this,i=E.getUniqueMessageId();if(this.type===E.Type.ONE_TO_ONE){var a=this.contact.jid;n=$msg({to:a,type:"chat",id:i,"xml:lang":u.currentLanguage}).c("body",{"xml:lang":u.currentLanguage}).t(t).up().c("request",{xmlns:E.ReceiptNS}).up().c("active",{xmlns:E.ChatstatesNS}).up()}else n=$msg({to:this.room.jid,type:"groupchat",id:i}).c("body",{"xml:lang":u.currentLanguage}).t(t).up().c("request",{xmlns:E.ReceiptNS}).up().c("active",{xmlns:E.ChatstatesNS}).up();var o=null;return(o=this.addChatMessage(u.userContact,new Date,t,i,!0))?(o.serverAckTimer=s(function(){o.receiptStatus=h.ReceiptStatus.ERROR,r.updateMessage(o)},1e4),f.send(n),o):null},E.prototype.sendIsTypingState=function(e){var t=null,n=E.getUniqueMessageId(),r=e?"composing":"active";if(this.type===E.Type.ONE_TO_ONE){var i=this.contact.jid;t=$msg({to:i,type:"chat",id:n,"xml:lang":u.currentLanguage}).c(r,{xmlns:E.ChatstatesNS}).up()}else t=$msg({to:this.room.jid,type:"groupchat",id:n}).c(r,{xmlns:E.ChatstatesNS}).up();f.send(t)},E.prototype.sendRecordingMessage=function(e){var t=c("emojiShortToUnicode")(e),n=null,r=this,i=E.getUniqueMessageId();if(this.type===E.Type.ONE_TO_ONE){var a=this.contact.jid;n=$msg({to:a,type:"chat",id:i,"xml:lang":u.currentLanguage}).c("body",{"xml:lang":u.currentLanguage}).up().c("recording",{xmlns:"jabber:iq:recordingP2P"}).t(t).up().c("request",{xmlns:E.ReceiptNS}).up().c("active",{xmlns:E.ChatstatesNS}).up()}e=null;return(e=this.addRecordingMessage(u.userContact,new Date,t,i))?(e.serverAckTimer=s(function(){e.receiptStatus=h.ReceiptStatus.ERROR,r.updateMessage(e)},1e4),f.send(n),e):null},E.prototype.sendExistingFSMessage=function(e,t){if(!e)return null;var n=e.data,r=null,i=e.id;if(this.type===E.Type.ONE_TO_ONE){var a=this.contact.jid;r=$msg({to:a,type:"chat",id:i,"xml:lang":u.currentLanguage}).c("body",{"xml:lang":u.currentLanguage}).t(n).up().c("request",{xmlns:E.ReceiptNS}).up().c("active",{xmlns:E.ChatstatesNS}).up()}else r=$msg({to:this.room.jid,type:"groupchat",id:i}).c("body",{"xml:lang":u.currentLanguage}).t(n).up().c("request",{xmlns:E.ReceiptNS}).up().c("active",{xmlns:E.ChatstatesNS}).up();var o=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+t.id;return r.c("x",{xmlns:"jabber:x:oob"}).c("url",{},o).c("mime",{},t.typeMIME).c("filename",{},t.fileName).c("size",{},t.size).up().up().c("store",{xmlns:"urn:xmpp:hints"}),e.fileId=t.id,e.setReceiptStatus(h.ReceiptStatus.SENT),this.updateMessage(e),f.send(r),e},E.prototype.sendAckReceivedMessage=function(e){if(!(e.receiptStatus>=h.ReceiptStatus.UNREAD)){l.info("[Conversation] "+this.id+" send received ack for message "+e.id);var t=this.type===E.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,n=u.userContact.jid,r=$msg({to:t,from:n,type:"chat"}).c("received",{xmlns:E.ReceiptNS,event:"received",entity:"client",id:e.id});this.type!==E.Type.ONE_TO_ONE&&(r=$msg({to:t,from:n,type:"groupchat"}).c("received",{xmlns:E.ReceiptNS,event:"received",entity:"client",type:"muc",id:e.id})),f.send(r),e.setReceiptStatus(h.ReceiptStatus.UNREAD)}},E.prototype.sendAckReadMessage=function(e){if(e.receiptStatus!==h.ReceiptStatus.READ){l.info("[Conversation] "+this.id+" send read ack for message "+e.id);var t=this.type===E.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,n=u.userContact.jid,r=$msg({to:t,from:n,type:"chat"}).c("received",{xmlns:E.ReceiptNS,event:"read",entity:"client",id:e.id});this.type!==E.Type.ONE_TO_ONE&&(r=$msg({to:t,from:n,type:"groupchat"}).c("received",{xmlns:E.ReceiptNS,event:"read",entity:"client",type:"muc",id:e.id})),f.send(r),e.setReceiptStatus(h.ReceiptStatus.READ)}},E.prototype.sendAckReadMessages=function(){l.info("[Conversation] "+this.id+" sendAckReadMessages");var t=!1,n=this;return this.messages.forEach(function(e){e.receiptStatus!==h.ReceiptStatus.SENT&&e.receiptStatus!==h.ReceiptStatus.UNREAD||e.side!==h.Side.LEFT&&e.side!==h.Side.ADMIN||(n.sendAckReadMessage(e),t=!0)}),t},E.prototype.sendFTMessage=function(e,t){var a=new FileTransfert(null,null,e.name,e.size,e.type,null,t);this.addFTMessage(u.userContact,new Date,a,E.getUniqueMessageId());var o=this,s=this.contact.jid;n.sendFile(e,this.contact.fullJid,t,a).then(function(){var e=E.getUniqueMessageId(),t=a.message+"||"+a.filename+"||"+a.filesize+"||"+a.filetype+"||done||"+a.transfertId,n=$msg({to:s,type:"file",id:e}).c("body").t(t).up();f.send(n),o.addFileMessage(u.userContact,new Date,t,e)}).catch(function(e){var t="refused";-1!==e.toString().indexOf("timed out")&&(t="expired");var n=E.getUniqueMessageId(),r=a.message+"||"+a.filename+"||"+a.filesize+"||"+a.filetype+"||"+t+"||"+a.transfertId,i=$msg({to:s,type:"file",id:n}).c("body").t(r).up();f.send(i),o.addFileMessage(u.userContact,new Date,r,n)})},E.prototype.sendFSMessage=function(e,n){l.debug("[conversation] >sendFSMessage");var r,t=m.defer(),i=this,a=e.name.split(".").pop(),o=e.type,s=[],c="object"==typeof n?n:void 0;return s=this.type===E.Type.ONE_TO_ONE?g([{viewerId:this.contact.dbId,type:"user"}]):g([{viewerId:this.room.dbId,type:"room"}]),p.createFileDescriptor(e.name,a,e.size,s).then(function(t){return(r=t).fileToSend=e,t.isImage()&&e.preview&&(t.previewBlob=e.preview),c||(c=i.addFSMessage(t.id,o,n,"uploading")),c.fileId=t.id,c.fileName=t.fileName,t.state="uploading",i.chatRenderer&&i.chatRenderer.updateFileTransferState(c,t),v.uploadAFileByChunk(t,e,c,function(e,t){i.chatRenderer&&i.chatRenderer.updateFileTransferState(e,t)}).then(function(e){return l.debug("uploadAFileByChunk success"),i.chatRenderer&&i.chatRenderer.updateFileTransferState(c,e),m.resolve(t)},function(e){l.debug("uploadAFileByChunk error"),p.deleteFileDescriptor(r.id);var t=e.translatedMessage?e.translatedMessage:"Unable to share file";return d.$broadcast("ON_SHOW_INFO_MESSAGE",{type:"error",messageKey:t}),r.state="uploadError",c.receiptStatus=h.ReceiptStatus.ERROR,c.fileErrorMsg=t,i.updateMessage(c),m.reject(e)})}).then(function(e){e.state="uploaded",e.chunkPerformed=0,e.chunkTotalNumber=0,i.sendExistingFSMessage(c,e),t.resolve(c)},function(e){l.debug("createFileDescriptor error"),t.reject(e)}),t.promise},E.prototype.sendEFSMessage=function(e,t){var n=this,r=e.extension,i="",a=null,o=this.addFSMessage(e.id,r,t,e.state);return this.type===E.Type.ONE_TO_ONE?(i="user",a=this.contact.dbId):(i="room",a=this.room.dbId),p.addFileViewer(e.id,a,i).then(function(){n.sendExistingFSMessage(o,e)}).catch(function(e){var t=e.translatedMessage?e.translatedMessage:"Unable to share file";d.$broadcast("ON_SHOW_INFO_MESSAGE",{type:"error",messageKey:t}),o.receiptStatus=h.ReceiptStatus.ERROR,n.updateMessage(o)}),o},E.prototype.addAdminBubbleMessage=function(e,t,n,r){if(this.getMessageById(r))return l.info("[Conversation] "+this.id+" add addAdminBubbleMessage message ("+r+") already exists."),null;l.info("[Conversation] "+this.id+" add addAdminBubbleMessage from "+e.jid+" : "+n);var i=n+"MsgRoom",a=h.Side.ADMIN,o=h.create(r,t,e,a,i,!1);return o.setReceiptStatus(h.ReceiptStatus.SENT),this.addMessage(o)},E.prototype.addFTMessage=function(e,t,n,r){l.info("[Conversation] "+this.id+" add FT message from "+e.jid+" : "+n.message);var i=u.isUserContact(e)?"R":"L",a=h.createFTMessage(r,t,e,i,n.message,!1,n);return this.addMessage(a)},E.prototype.addFSMessage=function(e,t,n,r){l.info("[Conversation] "+this.id+" add FS message from me");var i=E.getUniqueMessageId(),a=c("emojiShortToUnicode")(n),o=new Date;l.info("[Conversation] "+this.id+" add FILE SHARING message from me");var s=h.createFileSharingMessage(i,o,u.userContact,"R",a,r,e);return s.setReceiptStatus(h.ReceiptStatus.IN_PROGRESS),this.addMessage(s)},E.prototype.addChatMessage=function(e,t,n,r,i,a,o){if(this.getMessageById(r))return l.info("[Conversation] "+this.id+" add CHAT message ("+r+") already exists."),null;l.info("[Conversation] "+this.id+" add CHAT message ("+r+") from "+e.jid);var s=u.isUserContact(e)?"R":"L",c=h.create(r,t,e,s,n,!1,a,o);return i?c.setReceiptStatus(h.ReceiptStatus.IN_PROGRESS):c.setReceiptStatus(h.ReceiptStatus.SENT),this.addMessage(c)},E.prototype.addRecordingMessage=function(e,t,n,r){var i=h.createRecordingAdminMessage(r,t,e,"ADMIN",n);return this.addMessage(i)},E.prototype.addFileMessage=function(e,t,n,r){l.info("[Conversation] "+this.id+" add FILE message from "+e.jid+" : "+n);var i=u.isUserContact(e)?"R":"L",a=h.createFileMessage(r,t,e,i,n,!1);return this.addMessage(a)},E.prototype.addFileSharingMessage=function(e,t,n,r,i,a){l.info("[Conversation] "+this.id+" add FILE SHARING message from "+e.jid+" : "+n);var o=u.isUserContact(e)?"R":"L",s=h.createFileSharingMessage(r,t,e,o,n,!1,i,a);return this.addMessage(s)},E.prototype.addConferenceMessage=function(e,t,n,r){if("reminder"===r.type){var i=S.getRoomByJid(r.roomjid),a=C.conferenceSessions[i.getPstnConfEndpointId()];if(a&&a.isActive()&&a.isParticipantConnectedByJid(u.userContact.jid))return}l.info("[Conversation] "+this.id+" add CONFERENCE message from "+e.jid);var o=h.createConferenceMessage(n,t,e,"ADMIN",!1,r);return this.addMessage(o)},E.prototype.addWebRTCMessage=function(e,t,n,r){if(this.getMessageById(r))return l.info("[Conversation] "+this.id+" add addWebRTCMessage message ("+r+") already exists."),null;l.info("[Conversation] "+this.id+" add WebRTC message from "+e.jid+" : "+n);var i=u.isUserContact(e)?h.Side.RIGHT:h.Side.LEFT,a=h.createWebRTCMessage(r,t,e,i,n,!1);return this.addMessage(a)},E.prototype.updateMessage=function(e){this.chatRenderer&&this.chatRenderer.updateMessage(e,this.room)},E.prototype.addMessage=function(t){return this.messages.find(function(e){return e.id===t.id})?l.info("[Conversation] "+this.id+" try to add an already stored message with id "+t.id):(t.side===h.Side.LEFT&&(t.type===h.Type.WEBRTC&&(this.missedCalls+=1),this.setStatusMessage(t.from,E.Status.ACTIVE)),this.messages.push(t),this.chatRenderer&&this.chatRenderer.appendMessages([t],this.room),this.lastModification=new Date,this.lastMessageText=t.data,d.$broadcast("ON_CONVERSATION_UPDATED_EVENT",this.id)),t},E.prototype.removeMessage=function(e){var t=this.messages.lastIndexOf(e);-1!==t&&this.messages.splice(t,1)},E.prototype.sendChatStatus=function(e){if(l.info("[Conversation] "+this.id+" setStatus "+e.value),this.status!==e&&(this.status=e)!==E.Status.IDLE){var t=null,n="";this.type===E.Type.ONE_TO_ONE?(n=this.contact.jid,t=$msg({to:n,type:"chat"}).c(e.value,{xmlns:E.ChatstatesNS})):(n=this.room.jid,t=$msg({to:n,type:"groupchat"}).c(e.value,{xmlns:E.ChatstatesNS}));try{f.connection.send(t)}catch(e){l.error("[Conversation] sendChatStatus error "+e)}}},E.prototype.setStatusMessage=function(e,t){l.info("[Conversation] "+this.id+" add status message from "+e.jid+" : "+t.value),this.participantStatuses[e.jid]=t,this.chatRenderer&&this.chatRenderer.updateStatuses&&this.chatRenderer.updateStatuses()},E.prototype.sendInvitation=function(e){try{var t=e.jid,n={xmlns:"jabber:x:conference",jid:this.id},r=$msg({from:f.connection.jid,to:t}).c("x",n);f.connection.send(r)}catch(e){l.error("[Conversation] sendInvitation error "+e)}},E.prototype.ackReadAllMessages=function(){var t=this;this.messages.forEach(function(e){e.receiptStatus!==h.ReceiptStatus.SENT&&e.receiptStatus!==h.ReceiptStatus.UNREAD||(e.setReceiptStatus(h.ReceiptStatus.READ),t.chatRenderer&&t.chatRenderer.updateMessage(e,t.room))})},E}]),angular.module("rainbow").factory("Message",["$log","$filter","$interval","roomService",function(t,l,n,d){"use strict";function u(e,t,n,r,i,a,o,s,c,l,d){this.id=e,this.index=null,this.type=t,this.date=n,this.from=r,this.side=i,this.data=a,this.status=o,this.receiptStatus=u.ReceiptStatus.NONE,this.serverAckTimer=null,this.fileId=s,this.fileName=d,this.isMarkdown=c,this.subject=l}return u.Type={CHAT:{key:0,value:"Chat"},FILE:{key:1,value:"File"},FS:{key:2,value:"FileSharing"},FT:{key:3,value:"FileTransfert"},WEBRTC:{key:4,value:"WebRTC CAll"},RECORDING:{key:5,value:"Recording"}},u.ReceiptStatus={NONE:0,ERROR:1,IN_PROGRESS:2,SENT:3,UNREAD:4,READ:5},u.Side={LEFT:"L",RIGHT:"R",ADMIN:"ADMIN"},u.ReceiptStatusText=["none","ko","inProgress","sent","received","read"],u.create=function(e,t,n,r,i,a,o,s){var c=l("emojiUnicodeToShort")(i);return new u(e,u.Type.CHAT,t,n,r,c,a,null,o,s,null)},u.createFileSharingMessage=function(e,t,n,r,i,a,o,s){var c=l("emojiUnicodeToShort")(i);return new u(e,u.Type.FS,t,n,r,c,a,o,null,null,s)},u.createConferenceMessage=function(e,t,n,r,i,a){var o=d.getRoomByJid(a.roomjid),s="";switch(a.type){case"invite":s=l("translate")("headerConferenceMessage",{sender:n._displayName,firstname:n.firstname,bubblename:o.name});break;case"reminder":s=o&&o.owner?l("translate")("conferenceReminderMessageforOwner",{sender:n._displayName}):l("translate")("conferenceReminderMessage",{sender:n._displayName});break;default:s=l("translate")("headerConferenceMessage",{sender:n._displayName,firstname:n.firstname,bubblename:o.name})}o.desc&&(s+="<br>"+l("translate")("conferenceSuject")+o.desc);var c=s;return new u(e,u.Type.CHAT,t,n,r,c,i)},u.createFileMessage=function(e,t,n,r,i,a){return new u(e,u.Type.FILE,t,n,r,i,a)},u.createWebRTCMessage=function(e,t,n,r,i,a){return new u(e,u.Type.WEBRTC,t,n,r,i,a)},u.createFTMessage=function(e,t,n,r,i,a,o){var s=new u(e,u.Type.FT,t,n,r,i,a);return s.fileTransfert=o,s},u.createBubbleAdminMessage=function(e,t,n,r){var i=r+"MsgRoom",a=u.Side.ADMIN;return u.create(e,t,n,a,i,!1)},u.createRecordingAdminMessage=function(e,t,n,r,i){var a=r+"Recording";i&&(a+=i);var o=u.Side.ADMIN;return new u(e,u.Type.RECORDING,t,n,o,a,!1)},u.prototype.setReceiptStatus=function(e){return this.serverAckTimer&&e>u.ReceiptStatus.IN_PROGRESS&&(n.cancel(this.serverAckTimer),this.serverAckTimer=null),e>this.receiptStatus&&(this.receiptStatus=e,t.info("[Message] "+this.id+" : "+u.ReceiptStatusText[e])),this},u}]),angular.module("rainbow").factory("Room",[function(){"use strict";function d(e,t,n,r,i,a,o,s,c,l){this.dbId=e,this.jid=t,this.name=n,this.desc=r,this.type=d.Type.PRIVATE,this.users=[],this.history=o||d.History.NONE,this.customData=s||{},this.ownerContact=null,this.organizers=[],this.members=[],this.avatarContacts=[],this.owner=!1,this.isModerator=!1,this.confEndpoints=a||[],this.conference=void 0!==c?c:null,this.status="none",this.creationDate=i,this.initPresPromise=null,this.avatar=l,this.guestEmails=[],d.prototype.toString=function(){return"Room "+this.dbId+" "+this.name+" "+this.jid},d.prototype.updateAvatarInfo=function(){var e=[],t=this.users.slice();if(!this.avatar){t.sort(function(e,t){return new Date(e.date)-new Date(t.date)});for(var n=0;n<t.length;n++){var r=t[n].contact,i=t[n].status;if(r.dbId!==this.ownerContact.dbId&&("accepted"!==i&&"invited"!==i||e.push(r),2===e.length))break}this.avatarContacts=e}},d.prototype.isUserOwner=function(e){return!!e&&this.ownerContact.jid===e.jid},d.prototype.isUserModerator=function(e){return void 0!==this.getOrganizerFromContactJid(e.jid)},d.prototype.isUserStatusAccepted=function(e){var t=this.getUserByJid(e.jid);return void 0!==t&&"accepted"===t.status},d.prototype.isUserStillBelongToRoom=function(e){var t=this.getUserByJid(e);return!t||"unsubscribed"!==t.status&&"deleted"!==t.status},d.prototype.getOrganizerFromContactJid=function(t){var n;return this.organizers.forEach(function(e){e.contact.jid===t&&(n=e)}),n},d.prototype.getUserByJid=function(e){for(var t=0;t<this.users.length;t++)if(e===this.users[t].contact.jid)return this.users[t];return null},d.prototype.getPstnConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if("pstnAudio"===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},d.prototype.getSFUConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if("webrtc"===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},d.prototype.getSFUSharingConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if("webrtcSharingOnly"===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},d.prototype.isMeetingRoom=function(){return this.conference&&"pstnAudio"===this.conference.mediaType},d.prototype.isWebConferenceRoom=function(){return this.conference&&"pstnAudio"!==this.conference.mediaType&&this.getSFUConfEndpointId()},d.prototype.isMeetingOrWebConferenceRoom=function(){return this.isMeetingRoom()||this.getSFUConfEndpointId()}}return d.Type={PRIVATE:0,PUBLIC:1},d.Privilege={USER:"user",MODERATOR:"moderator",GUEST:"guest"},d.History={ALL:"all",NONE:"none"},d.create=function(e,t,n,r,i,a,o,s,c,l){return new d(e,t,n,r,i,a,o,s,c,l)},d}]),angular.module("rainbow").factory("Call",["$log",function(i){"use strict";function a(e,t,n,r){this.status=e,this.id=t,this.conversationId=null,this.connectionId=null,this.type=n,this.isVm=!1,this.contact=r,this.remoteMedia=0,this.localMedia=0,this.isEscalated=!1,this.startDate=new Date,this.isInitiator=!1,this.participants=null,this.isRemoteVideoMuted=!1,this.isConference=!1,this.avatars=r&&r.avatar?[this.contact.avatar.src]:[],this.subject=void 0,this.currentCalled={contactPhoneNumber:"",contact:null,participantsPhoneNumbers:[],participants:[]},this.fullJid="",this.mediaPillarCall=null,this.isSecondary=!1,this.relevant=!0,this.relevantEquipmentId="unknown",i.debug("[CALL] createCall : "+this)}return a.Status={UNKNOWN:{key:0,value:"Unknown"},DIALING:{key:1,value:"dialing"},QUEUED_INCOMMING:{key:2,value:"queuedIncomming"},QUEUED_OUTGOING:{key:10,value:"queuedOutGoing"},RINGING_INCOMMING:{key:3,value:"incommingCall"},RINGING_OUTGOING:{key:4,value:"ringingOutgoing"},ACTIVE:{key:5,value:"active"},HOLD:{key:6,value:"held"},PUT_ON_HOLD:{key:7,value:"putOnHold"},RELEASING:{key:8,value:"releasing"},ANSWERING:{key:9,value:"answering"},CONNECTING:{key:12,value:"connecting"},ERROR:{key:11,value:"error"}},a.Type={WEBRTC:{key:1,value:"Video"},PHONE:{key:2,value:"Phone"}},a.Media={AUDIO:1,VIDEO:2,PHONE:4,SHARING:8},a.create=function(e,t,n,r){return new a(e,t,n,r)},a.prototype.setCallId=function(e){this.id=e,i.debug("[CALL] setId : "+this)},a.prototype.isInConversationWithMobile=function(){return!!this.fullJid&&(-1!==this.fullJid.indexOf("mobile_android")||-1!==this.fullJid.indexOf("mobile_ios"))},a.prototype.setConversationId=function(e){this.conversationId=e,i.debug("[CALL] setConversationId : "+this)},a.prototype.setConnectionId=function(e){this.connectionId=e,this.id=a.getIdFromConnectionId(e),i.debug("[CALL] setId : "+this)},a.prototype.setStatus=function(e){this.status=e,i.debug("[CALL] setStatus : "+this)},a.prototype.setType=function(e){this.type=e,i.debug("[CALL] setType : "+this)},a.prototype.setIsVm=function(e){this.isVm=e,i.debug("[CALL] setVm : "+this)},a.prototype.setContact=function(e){this.contact=e,this.avatars=[this.contact.avatar.src],i.debug("[CALL] setContact : "+e)},a.prototype.setParticipants=function(e){this.participants=e,this.avatars=[];var t=this;this.participants.forEach(function(e){t.avatars.push(e.avatar.src)}),i.debug("[CALL] setParticipants : "+e.join())},a.prototype.setSubject=function(e){this.subject=e},a.prototype.getCurrentCalled=function(){return this.currentCalled},a.prototype.setCurrentCalled=function(e){e?this.contact&&this.contact.id?(this.currentCalled.contactPhoneNumber=e.contactPhoneNumber&&""!==e.contactPhoneNumber?e.contactPhoneNumber:"",this.currentCalled.contact=e.contact?e.contact:null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null,i.debug("[Call] setCurrentCalled contactPhoneNumber : "+e.contactPhoneNumber),i.debug("[Call] setCurrentCalled call "+this.id+" contactPhoneNumber = "+e.contactPhoneNumber)):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=e.participantsPhoneNumbers&&0<e.participantsPhoneNumbers.length?e.participantsPhoneNumbers:null,this.currentCalled.participants=e.participants&&0<e.participants.length?e.participants:null,this.currentCalled.participantsPhoneNumbers&&0<this.currentCalled.participantsPhoneNumbers.length&&(i.debug("[Call] setCurrentCalled participantsPhoneNumbers : "+e.participantsPhoneNumbers.join()),i.debug("[Call] setCurrentCalled "+this.id+" participantsPhoneNumbers : "+e.participantsPhoneNumbers.join()))):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null)},a.prototype.setCurrentCalledContactNumber=function(e){i.debug("[Call] setCurrentCalledContactNumber call "+this.id+" phoneNumber = "+e),this.currentCalled.contactPhoneNumber=e},a.prototype.setRelevantEquipmentId=function(e){this.relevantEquipmentId=e},a.getIdFromConnectionId=function(e){return e?e.split("#")[0]:null},a.getDeviceIdFromConnectionId=function(e){return e?e.split("#")[1]:null},a.prototype.getMediaPillarCall=function(){return this.mediaPillarCall},a.prototype.setMediaPillarCall=function(e){this.mediaPillarCall=e||null},a.prototype.isMediaPillarCall=function(){return null!==this.mediaPillarCall},a.prototype.toString=function(){return"(type:"+this.type.value+", id:"+this.id+", status:"+this.status.value+(this.vm?"(voicemail))":")")},a.prototype.isInCallWithMediaPillar=function(){return this.fullJid&&-1!==this.fullJid.indexOf("mp_")},a}]),function(){"use strict";angular.module("rainbow").factory("RBNotification",["$log","$rootScope","$notification","$filter","notify",function(t,r,i,a,o){var n=8e5,s=this;function c(e){t.info("[RBNotification] Create notification"),this.icon=e.icon,this.displayName=e.displayName,this.message=e.body,this.type=e.type,this.tag=e.tag,this.title=e.title,this.tooltip=e.tooltip,this.delay=e.delay?e.delay:n,this.focusAction=e.focusAction,this.sound=null,this.answerAudioButton=null,this.answerVideoButton=null,this.answerSharingButton=null,this.answerAudioButtonDisabled=null,this.answerClick=!1,this.declineButton=null,this.declineClick=!1,this.answerWithTemplateIMClick=!1,this.answerWithIMButton=null,this.bottomRightButton=null,this.handler=null,this.ascope=null,this.isSent=!1}return c.notifs=[],c.create=function(e){var t=c.notifs[e.id];return t?(t.update(e),t):(t=new c(e),c.notifs[e.id]=t)},c.hide=function(e){var t=c.notifs[e];t&&t.handler.close(),delete c.notifs[e]},c.createNotificationListener=function(n){r.$on("$destroy",r.$on("NOTIFICATION_EVENT",function(e,t){t.display(n)}))},c.prototype.update=function(e){t.info("[RBNotification] >update"),this.icon=e.icon,this.displayName=e.displayName,this.message=e.body,this.type=e.type,this.tag=e.tag,this.delay=e.delay?e.delay:n,this.focusAction=e.focusAction},c.prototype.send=function(){this.isSent||(this.isSent=!0,r.$broadcast("NOTIFICATION_EVENT",this))},c.prototype.addAnswerAudioButton=function(e){this.answerAudioButton=e},c.prototype.addAnswerVideoButton=function(e){this.answerVideoButton=e},c.prototype.addAnswerSharingButton=function(e){this.answerSharingButton=e},c.prototype.addAnswerAudioButtonDisabled=function(e){this.answerAudioButtonDisabled=e},c.prototype.addDeclineButton=function(e){this.declineButton=e},c.prototype.addAnswerWithIMButton=function(e){this.answerWithIMButton=e},c.prototype.addBottomRightButton=function(e){this.bottomRightButton=e},c.prototype.display=function(e){if(!r.appVisible){var t=i(this.displayName,{tag:this.tag,body:this.message,icon:this.icon,delay:4e3});this.focusAction&&t.$on("click",this.focusAction)}s.answerClick=!1,s.declineClick=!1,s.answerWithTemplateIMClick=!1;var n=null;this.ascope||(this.ascope=e.$new(!0),(this.ascope.notification=this).ascope.showIMTemplates=!1,this.ascope.answerAudioButtonClick=function(e){s.answerClick||(e.answerAudioButton.action(),s.answerClick=!0)},this.ascope.answerVideoButtonClick=function(e){s.answerClick||(e.answerVideoButton.action(),s.answerClick=!0)},this.ascope.answerSharingButtonClick=function(e){s.answerClick||(e.answerSharingButton.action(),s.answerClick=!0)},this.ascope.declineButtonClick=function(e){s.declineClick||(e.declineButton.action(),s.declineClick=!0)},this.ascope.answerWithIMButtonClick=function(e){if(e.ascope.showIMTemplates)e.ascope.showIMTemplates=!1,e.ascope.templatesIM=[];else{var t=[];(n=e).answerWithIMButton&&Array.isArray(e.answerWithIMButton.choice)&&e.answerWithIMButton.choice.forEach(function(e){t.push(e)}),e.ascope.templatesIM=t,e.ascope.showIMTemplates=!0}},this.ascope.addBottomRightButtonClick=function(e){e.bottomRightButton.action()},this.ascope.answerWithTemplateIM=function(e){if(!s.answerWithTemplateIMClick){if(n){var t="";n.answerWithIMButton.label!==e.label&&(t=a("translate")(e.label)),n.answerWithIMButton.action(t)}s.answerWithTemplateIMClick=!0}}),this.handler||(this.handler=o({container:document.getElementById("leftArea"),position:"left",templateUrl:"notificationCallTemplate.html",message:this.title,duration:this.delay,startTop:80,scope:this.ascope}))},c}])}(),angular.module("rainbow").factory("CallLog",[function(){"use strict";function d(e,t,n,r,i,a,o,s,c,l){this.id=e,this.contact=t,this.state=n,this.duration=r,this.direction=s,this.callSubject=c,this.isLatestCall=l,i="unknown"===i||"audio"===i||"webrtc"===i?d.Type.WEBRTC:"telephone"===i?d.Type.TELEPHONE:d.Type.CONFERENCE,this.type=i,this.read=a,this.date=o}return d.create=function(e,t,n,r,i,a,o,s,c,l){return new d(e,t,n,r,i,a,o,s,c,l)},d.getNames=function(e){var t={firstname:"",lastname:""};return e&&e.contact&&(t.firstname=e.contact.firstname.toUpperCase(),t.lastname=e.contact.lastname.toUpperCase(),e&&e.date&&(t.date=e.date.getTime())),t},d.getDate=function(e){return e&&e.date?e.date.getTime():0},d.sortByContact=function(e,t){var n=-1;if(e&&e.value.lastname&&t&&t.value.lastname){var r=e.value.lastname,i=t.value.lastname;0===(n=r.localeCompare(i))&&(r=e.value.firstname,i=t.value.firstname,0===(n=r.localeCompare(i))&&t.value.date&&e.value.date&&(n=t.value.date-e.value.date))}return n},d.sortByDate=function(e,t){var n=1;return e&&t&&(n=t.value-e.value),n},d.Type={WEBRTC:"webrtc",TELEPHONE:"telephone",CONFERENCE:"conference"},d}]);var FileTransfertIndex=12,FileTransfert=function(e,t,n,r,i,a,o){"use strict";this.index=FileTransfertIndex,this.from=e,this.requestId=a,this.transfertId=t,this.filename=n,this.filesize=r,this.filetype=i,this.message=o,this.buffer=null,this.status=FileTransfert.Status.WAIT,this.progressValue=0,this.progressSurvey=null,this.progressHandler=null,this.acceptHandler=null,FileTransfertIndex+=1};FileTransfert.Status={WAIT:0,TRANSFER:1,FINISH:2,REJECT:3},FileTransfert.prototype.toString=function(){"use strict";return"[FileTransfert] "+this.transfertId+" "+this.filename},function(){"use strict";angular.module("rainbow").factory("Document",["$log","$filter",function(o,t){function n(e,t,n,r,i,a){this.publisher=e,this.item_id=i,this.data=t,this.timestamp=n,this.authorjid=r,this.pub_id=a,o.debug("[Document] createActu : "+this)}return n.create=function(e,t){return new n(e,t,Date.now(),e.jid)},n.createForSharing=function(e,t){return console.log(t.item_id),""===t.item_id?new n(e,"Repost",Date.now(),t.authorjid,t.pub_id):new n(e,"Repost",Date.now(),t.authorjid,t.item_id)},n.createFromXML=function(e,t){return new n(e,t.childNodes[0].childNodes[0].nodeValue,parseInt(t.childNodes[1].childNodes[0].nodeValue,10),t.childNodes[2].childNodes[0].nodeValue,1!==t.childNodes[3].childNodes.length?"":t.childNodes[3].childNodes[0].nodeValue,t.parentNode.attributes.getNamedItem("id").nodeValue)},n.prototype.messageFilter=function(e){return t("quoteFilter")(t("emojione")(t("linky")(t("emojiUnicodeToShort")(e,"_blank"))))},n.prototype.setPubId=function(e){this.pub_id=e},n.prototype.setItemId=function(e){this.item_id=e},n.prototype.getXML=function(){return[{data:$build("entry").c("data",this.data).up().c("timestamp",this.timestamp).up().c("jidauthor",this.authorjid).up().c("item_id",this.item_id).tree()}]},n.prototype.getTime=function(e){return moment(this.timestamp).format(e)},n.prototype.toString=function(){return"(jid:"+this.contact+", id:"+this.pub_id+", data:"+this.data+", tsmp:"+this.timestamp+" )"},n}])}(),angular.module("rainbow").factory("Group",[function(){"use strict";function t(e,t,n,r){this.id=e,this.name=t,this.comment=n||"",this.isFavorite=r||!1,this.users=[],this.sortedUserList=[]}return t.createFromData=function(e){return new t(e.id,e.name,e.comment,e.isFavorite)},t}]),angular.module("rainbow").factory("Invitation",["userInfoService",function(f){"use strict";function u(e,t,n,r,i,a,o,s,c,l,d,u){this.id=e,this.invitedUserId=t,this.invitedUserEmail=n,this.invitedPhoneNumber=u,this.invitingUserId=r,this.invitingUserEmail=i,this.requestNotificationLanguage=a,this.invitingDate=o,this.lastNotificationDate=s,this.status=c,this.type=l,this.defaultAvatar=null,this.inviteToJoinMeeting=d,this.createDefaultAvatar=function(){if(!this.defaultAvatar&&this.invitedUserEmail){var e=f.computeUserColor(this.invitedUserEmail),t=this.invitedUserEmail.substring(0,2).toUpperCase();this.defaultAvatar=f.createDefaultAvatarImage(t,e)}}}return u.create=function(e,t,n,r,i,a,o,s,c,l,d){return new u(e,t,n,r,i,a,o,s,c,l,d)},u.createFromData=function(e){var t=new u(e.id,e.invitedUserId,e.invitedUserEmail,e.invitingUserId,e.invitingUserEmail,e.requestNotificationLanguage,e.invitingDate,e.lastNotificationDate,e.status,e.type,e.inviteToJoinMeeting,e.invitedPhoneNumber);return t.createDefaultAvatar(),t},u}]),angular.module("rainbow").factory("VoiceMail",["profileService",function(e){"use strict";function t(){this.VMFlag=!1,this.VMCounter=0,this.infoMsg="",this.voiceMailFeatureEnabled=e.isFeatureEnabled(e.FeaturesEnum.TELEPHONY_VOICE_MAIL),this.setVMFlag=function(e){this.VMFlag=e},this.getVMFlag=function(){return this.VMFlag},this.setVMCounter=function(e){0<e?(this.VMFlag=!0,this.VMCounter=e):this.VMCounter=0},this.getVMCounter=function(){return this.VMCounter},this.setInfoMsg=function(e){this.infoMsg=e},this.getInfoMsg=function(){return this.infoMsg},this.getDisplayState=function(){return this.voiceMailFeatureEnabled}}return t.create=function(){return new t},t}]),angular.module("rainbow").factory("Organisation",[function(){"use strict";function t(e,t,n){this.id=e,this.name=t,this.visibility=n,this.companies=[]}return t.createFromData=function(e){return new t(e.id,e.name,e.visibility)},t}]),angular.module("rainbow").factory("Site",[function(){"use strict";function i(e,t,n,r,i,a){this.id=e,this.name=t||"",this.status=n||"",this.companyId=r||"",this.settings=i||"",angular.isDefined(a)&&(this.isCentrex=a)}return i.createFromData=function(e){return new i(e.id,e.name,e.status,e.companyId,e.settings,e.isCentrex)},i.create=function(e,t,n,r){return new i(e,t,n,r)},i.StatusValues=["active","alerting","hold","terminated"],i}]),angular.module("rainbow").factory("System",[function(){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d,u,f,h,p,v,m){this.id=e||null,this.jid_pbxagent=n||"",this.jid_password=r||"",this.pbxMainBundlePrefix=i||["0"],this.usePbxMainBundlePrefix=!angular.isDefined(p)||p,this.pbxNumberingTranslator=v||[],this.type=o||null,this.country=d||"FRA",this.name=u||"",this.jid_pbxagent_password=f||"",this.jid_pbxagent_password_activating=h||"",l&&(this.siteId=l),t&&(this.pbxId=t),a&&(this.serverPingTimeout=a),s&&(this.status=s),c&&(this.version=c),angular.isDefined(m)&&(this.isCentrex=m)}return t.createFromData=function(e){return new t(e.id,e.pbxId,e.jid_pbxagent,e.jid_password,e.pbxMainBundlePrefix,e.serverPingTimeout,e.type,e.status,e.version,e.siteId,e.country,e.name,e.jid_pbxagent_password,e.jid_pbxagent_password_activating,e.usePbxMainBundlePrefix,e.pbxNumberingTranslator,e.isCentrex)},t.create=function(){return new t},t.StatusValues=["created","activating","activated"],t}]),angular.module("rainbow").filter("serverTypeFilter",[function(){"use strict";return function(e){return"oxo"===e?"OXO Connect":"oxe"===e?"OmniPCX Enterprise":"third_party"===e?"Third party PBX":e}}]),angular.module("rainbow").filter("systemStateFilter",[function(){"use strict";return function(e){return"created"===e?"pending":"activating"===e?"connecting":"activated"===e?"normal":void 0}}]),angular.module("rainbow").filter("systemStateColorFilter",[function(){"use strict";return function(e){return"created"===e?"color_orange":"activating"===e?"color_red":"activated"===e?"color_green":void 0}}]),angular.module("rainbow").factory("SystemsGroup",[function(){"use strict";function i(e,t,n,r){this.id=e||null,this.name=t,this.companies=n||[],this.systems=r,this.containsSystem=function(t){return!!this.systems&&this.systems.some(function(e){return e.systemId===t})}}return i.createFromData=function(e){return new i(e.id,e.name,e.companies,e.systems)},i.create=function(e,t,n,r){return new i(e,t,n,r)},i}]),angular.module("rainbow").factory("User",["Subscription","userInfoService",function(i,a){"use strict";function o(t,n){var r=this;o.attributes.forEach(function(e){t&&angular.isDefined(t[e.name])?r[e.name]=t[e.name]:!n&&angular.isDefined(e.defaultValue)&&(r[e.name]=e.defaultValue)}),this.subscriptions=[],this.updateFromData=function(t){o.attributes.forEach(function(e){angular.isDefined(t[e.name])&&(r[e.name]=t[e.name])})},this.fillSubscriptionMap=function(){var t={};this.subscriptions.forEach(function(e){t[e.id]=e}),this.subscriptionMap=t},this.fillMainSubscriptionField=function(){var e=this.subscriptions.filter(i.isExclusive).sort(i.subscriptionComparator);0<e.length&&(this.mainSubscription=e[e.length-1],this.mainSubscriptionName=this.mainSubscription.offerName);var t=this.subscriptions.filter(i.isOptional);0<t.length&&(this.optionalSubscriptionNames=t.map(function(e){return e.offerName}).join(", ")),this.subscriptionNames=this.mainSubscriptionName+(this.optionalSubscriptionNames?", "+this.optionalSubscriptionNames:"")},this.getMainSubscription=function(){return this.mainSubscription||this.fillMainSubscriptionField(),this.mainSubscription},this.getOptionalSubscriptions=function(){return this.subscriptions.filter(i.isOptional)},this.getMainSubscriptionName=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.mainSubscriptionName},this.getOptionalSubscriptionNames=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.optionalSubscriptionNames},this.hasUserRoleOnly=function(){return 1===this.roles.length&&-1!==this.roles.indexOf(o.RoleValues.USER)},this.isAdmin=function(){return-1!==this.roles.indexOf(o.RoleValues.ADMIN)},this.isOrganizationAdmin=function(){return!!this.isAdmin()&&"organization_admin"===this.adminType},this.isSiteAdmin=function(){return!!this.isAdmin()&&"site_admin"===this.adminType},this.isCompanyAdmin=function(){return!!this.isAdmin()&&"company_admin"===this.adminType},this.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},this.isBPAdminOperations=function(){return-1!==this.roles.indexOf(o.RoleValues.BP_ADMIN_OPERATIONS)},this.isBPAdminFinance=function(){return-1!==this.roles.indexOf(o.RoleValues.BP_ADMIN_FINANCE)},this.isSuperadmin=function(){return-1!==this.roles.indexOf(o.RoleValues.SUPERADMIN)},this.isPublicChannelsAdmin=function(){return-1!==this.roles.indexOf(o.RoleValues.PUBLIC_CHANNELS_ADMIN)},this.isPrivateChannelsAdmin=function(){return-1!==this.roles.indexOf(o.RoleValues.PRIVATE_CHANNELS_ADMIN)},this.computeDisplayName=function(){var e=a.getNameInformation(this.firstName,this.lastName);this.displayName=e.displayName,this.initials=e.initials},this.getPhoneNumbers=function(t,n){return this.phoneNumbers?this.phoneNumbers.filter(function(e){return e.type===t&&e.deviceType===n}):[]},this.getSystemPhoneNumber=function(){return this.phoneNumbers?this.phoneNumbers.find(function(e){return angular.isDefined(e.systemId)}):void 0},this.getActivePhoneNumber=function(e,t){var n=this.getPhoneNumbers(e,t);if(1<n.length){var r=n.find(function(e){return angular.isDefined(e.systemId)});if(r)return r}return n[0]}}return o.createFromData=function(e,t){var n=new o(e,t);return e.profiles&&(e.profiles.forEach(function(e){var t=i.createFromData(e);t.isTerminated()||n.subscriptions.push(t)}),n.fillMainSubscriptionField()),n.computeDisplayName(),n},o.create=function(){return new o},o.prune=function(e,t){return Object.assign({},e)},o.VisibilityValues=["private","public"],o.RoleValues={USER:"user",GUEST:"guest",SUPERADMIN:"superadmin",SUPPORT:"support",ADMIN:"admin",BP_ADMIN_OPERATIONS:"bp_admin",BP_ADMIN_FINANCE:"bp_finance",PUBLIC_CHANNELS_ADMIN:"public_channels_admin",PRIVATE_CHANNELS_ADMIN:"private_channels_admin"},o.attributes=[{name:"id",defaultValue:null},{name:"loginEmail",defaultValue:""},{name:"firstName",defaultValue:""},{name:"lastName",defaultValue:""},{name:"displayName",defaultValue:""},{name:"nickName",defaultValue:""},{name:"title",defaultValue:""},{name:"jobTitle",defaultValue:""},{name:"companyId",defaultValue:""},{name:"companyName",defaultValue:""},{name:"siteId",defaultValue:""},{name:"systemId",defaultValue:""},{name:"accountType",defaultValue:"free"},{name:"country",defaultValue:"FRA"},{name:"timezone",defaultValue:"Europe/Paris"},{name:"emails",defaultValue:[]},{name:"phoneNumbers",defaultValue:[]},{name:"roles",defaultValue:["user"]},{name:"adminType",defaultValue:"company_admin"},{name:"isActive",defaultValue:!1},{name:"isInitialized",defaultValue:!1},{name:"password",defaultValue:void 0},{name:"jid_im",defaultValue:""},{name:"jid_tel",defaultValue:""},{name:"language",defaultValue:"en"},{name:"lastAvatarUpdateDate",defaultValue:null},{name:"visibility",defaultValue:void 0}],o}]),angular.module("rainbow").factory("Subscription",["Offer",function(i){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d,u,f,h,p,v,m,g,S,C,E,b,R,y){this.id=e,this.offerId=t,this.offerName=n,this.offerReference=r,this.profileId=i,this.profileName=a,this.maxNumberUsers=o,this.numberAssignedUsers=s,this.status=c,this.syncOngoing=l||!1,this.updatingMaxNumberUsers=d,void 0!==u&&(this.nbBPLicences=u),void 0!==f&&(this.nbAssignedBPUsers=f),void 0!==h&&(this.nbLicencesAssignedToECs=h),void 0!==p&&(this.nbLicencesUsed=p),void 0!==v&&(this.nbFreeLicences=v),this.businessModel=m,this.canBeSold=g,this.isPrepaid=E,this.expirationDate=b,this.autoRenew=R,this.hasConference=y,this.isDefault=S,this.isExclusive=C,this.isEnterprise=function(){return this.offerName.toLowerCase().startsWith("enterprise")},this.isBusiness=function(){return this.offerName.toLowerCase().startsWith("business")},this.isEssential=function(){return this.offerName.toLowerCase().startsWith("essential")},this.isTerminated=function(){return"terminated"===this.status},this.isUserLicense=function(){return this.isDefault||"nb_users"===this.businessModel||"usage"===this.businessModel}}return t.createFromData=function(e){return new t(e.id?e.id:e.subscriptionId,e.offerId,e.offerName,e.offerReference,e.profileId,e.profileName,e.maxNumberUsers,e.numberAssignedUsers,e.status,e.syncOngoing,e.updatingMaxNumberUsers,e.nbBPLicences,e.nbAssignedBPUsers,e.nbLicencesAssignedToECs,e.nbLicencesUsed,e.nbFreeLicences,e.businessModel,e.canBeSold,e.isDefault,e.isExclusive,e.isPrepaid,e.expirationDate,e.autoRenew,e.hasConference)},t.subscriptionComparator=function(e,t){var n=new i(e.offerId,e.offerName,null,null,e.profileId,e.canBeSold,e.businessModel,e.isDefault,e.isExclusive,e.isPrepaid),r=new i(t.offerId,t.offerName,null,null,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid);return i.offerComparator(n,r)},t.isUserLicense=function(e){return e.isDefault||"nb_users"===e.businessModel||"usage"===e.businessModel},t.isExclusive=function(e){return e.isDefault||e.isExclusive},t.isOptional=function(e){return!t.isExclusive(e)},t.isConference=function(e){return t.isOptional(e)&&(e.hasConference||"usage"===e.businessModel)},t.isNotConference=function(e){return t.isOptional(e)&&!(e.hasConference||"usage"===e.businessModel)},t.withLicenses=function(e){return e.isDefault||"usage"===e.businessModel||"nb_users"===e.businessModel&&0<e.maxNumberUsers},t.isPrepaid=function(e){return e.isPrepaid},t.isMonthly=function(e){return!e.isPrepaid},t}]),angular.module("rainbow").factory("IceServer",[function(){"use strict";function t(e,t,n,r){this.id=e,this.urls=t,this.username=n,this.credential=r}return t.createFromData=function(e){return new t(e.id,e.urls,e.username,e.credential)},t}]),angular.module("rainbow").factory("PhoneNumber",[function(){"use strict";function t(e,t,n,r,i,a,o,s,c,l,d,u,f,h,p,v,m,g){this.id=e,this.shortNumber=t,this.number=n,this.numberE164=r,this.pbxUserId=i,this.userId=a,this.type=o,this.deviceType=s,this.pbxId=c,this.isFromSystem=l,this.isMonitored=d,this.systemId=u,this.country=f,this.voiceMailNumber=h,this.deviceName=p,this.firstName=v,this.lastName=m,this.internalNumber=g}return t.createFromData=function(e){return new t(e.id?e.id:e.phoneNumberId,e.shortNumber,e.number,e.numberE164,e.pbxUserId,e.userId,e.type,e.deviceType,e.pbxId,e.isFromSystem,e.isMonitored,e.systemId,e.country,e.voiceMailNumber,e.deviceName,e.firstName,e.lastName,e.internalNumber)},t}]),angular.module("rainbow").service("helpersService",[function(){"use strict";this.findIndex=function(e,t){return e.findIndex(t)},this.checkBrowser=function(e){return-1!==navigator.userAgent.indexOf(e)}}]),angular.module("rainbow").service("userInfoService",["$q","$log","$interval","$rootScope","settingsService",function(e,d,u,f,r){"use strict";var h=this;h.userColors=["#ff4500","#d38700","#348833","#007356","#00b2a9","#00b0e5","#0085ca","#6639b7","#91278a","#cf0072","#a50034","#d20000"],h.getAvatarImage=function(a,o,s,c,l){return e(function(t){l=void 0!==l&&l;var e=o?h.createDefaultAvatarImage(o,s):null;if(l){var n=config.webservices.protocol+"://"+config.webservices.currentServer;f.cdn&&(n=f.cdnServer);var r=n+"/api/avatar/"+a+"?size="+(c||256);l&&(r+="&update="+MD5.hexdigest(l));var i=new Image;i.onload=function(){var e=this;u(function(){d.log("[avatarService] Load avatar for "+a+" success"),t(e)},1,1)},i.onerror=function(){u(function(){d.warn("[avatarService] Load avatar for "+a+" failure : use text avatar"),t(e)},1,1)},i.src=r}else t(e)})},h.getNameInformation=function(e,t){var n={displayName:"",initials:""};return 1!==t.length&&2!==e.length?"firstLast"===r.getSetting("displayOrder")?(n.displayName=e+" "+t,n.initials=e.charAt(0).toUpperCase()+t.charAt(0).toUpperCase()):(n.displayName=t+" "+e,n.initials=t.charAt(0).toUpperCase()+e.charAt(0).toUpperCase()):("firstLast"===r.getSetting("displayOrder")?n.displayName=e+" "+t:n.displayName=t+" "+e,n.initials=e.charAt(0).toUpperCase()+e.charAt(1).toUpperCase()),n},h.createDefaultAvatarImage=function(e,t){var n=new Image,r=document.createElement("canvas");r.width=n.width=225,r.height=n.height=225;var i=r.getContext("2d");return i.rect(0,0,225,225),i.fillStyle=t,i.fill(),i.font="bold 100px Helvetica",i.textAlign="center",i.fillStyle="white",i.fillText(e,110,150),n.src=r.toDataURL("image/png"),n},h.computeUserColor=function(e){try{for(var t={colorIndex:0,color:h.userColors[0]},n=e.toUpperCase(),r=0,i=0;i<n.length;i++)r+=n.charCodeAt(i);t.colorIndex=r%12,t.color=h.userColors[t.colorIndex]}catch(e){d.error("[UserInfoService] computeUserColor failure"),t.colorIndex=1,t.color=h.userColors[t.colorIndex]}return t}}]),angular.module("rainbow").service("errorHelperService",["$filter",function(o){"use strict";var s=this;s.ErrorCodeLabels={0:"errorNoServerResponse",400210:"invalidPhoneNumber",400400:"errorWrongPassword",400500:"invalidFile",400504:"companyNameAlreadyExist",400505:"BPCompanyWithoutPaymentConfigurationData",400506:"NoActiveSubscriptionToOffer",400511:"ActiveDirectoryDomainAlreadyUsed",400552:"BPCompanyAndECCompanyMustNotBeSame",400973:"noCreateUserPermission",400975:"userAlreadyExistsInOtherCompany",400983:"userAlreadyExistsInOtherCompany",400990:"noUserFound",400993:"noUserFound",401202:"errorInvalidToken",401500:"errorUnauthorized",401501:"errorLoginForbidden",401510:"errorUserUnauthorized",401520:"errorUserNotActive",401521:"errorUserNotActive",403:"Forbidden",403000:"accessDeniedNotRequiredRole",403001:"accessDeniedNotOwner",403034:"cantDeselectDefaultWebRTCGateway",403035:"cantDeleteDefaultWebRTCGateway",403200:"notAllowedToChangeRole",403203:"notAllowedToChangeRole",403204:"notAllowedToMoveExistingUserToThisCompany",403301:"notAllowedToManageCompany",403304:"notAllowedToAddAnotherAdmin",403311:"errorRemoveSyncOngoingSubscriptionForbidden",403315:"errorRemoveSubscriptionForbidden",403316:"errorRemoveAdminAllocatedSubscriptionForbidden",403317:"errorRemoveClientAllocatedSubscriptionForbidden",403500:"notAllowedBlacklistedEmail",403501:"notAllowedBlacklistedEmail",403503:"NotAllowedSelfRegistrationEmail",403504:"notAllowedLoggedInUserEmail",403507:"notAllowedSupportEmail",403513:"companyNotABpCompany",403516:"companyNotABpCompany",403517:"companySeenAsTerminated",403518:"companyBpTypeIncompatible",403519:"companyAlreadyLinkedToBp",403520:"companyNotVadBp",403531:"resetPasswordBlocked",403532:"resetPasswordForbidden",403608:"errorAssignSubscriptionSyncOngoing",403609:"errorAssignSubscriptionSyncOngoing",403610:"maxSubscriptionAllocationReached",403611:"notAllowedToCreateAnEquipment",403615:"maximumNumberConferenceParticipantsReach",403616:"subscriptionCompanyAdminEssentialAlreadyExists",403617:"roleCompanyAdminEssentialAlreadyExists",403620:"MaximumNumberRoomUsersReach",403630:"uploadErrorMaxQuotaReached",403655:"userAlreadyCompanyMember",403700:"errorDeleteSiteWithSystems",403701:"errorDeleteOrganisationLinkedCompany",403702:"errorDeleteCompanyWithSubscriptions",403703:"errorDeleteCompanyWithSites",403704:"errorDeleteCompanyWithUsers",403705:"errorDeleteCompanyStillTerminated",403706:"errorRemoveBusinessPartnerRole",404:"resourceNotFound",404000:"resourceNotFound",404001:"resourceNotFoundUpdateImpossible",404002:"resourceNotFoundDeleteImpossible",404300:"noValidOfferReferenceInACTISFile",404301:"offerNotFound",409000:"userAlreadyCreated",409011:"noMessagesToExport",409552:"internalNumberAlreadyUsed",409600:"userAlreadyExist",409601:"invitationReSentConflict",409602:"userAlreadyNetworkMember",409603:"invitationReSentConflict",409620:"offerAlreadySubscribed",409625:"errorUpdateSyncOngoingSubscriptionForbidden",409800:"companyNotIrBp",409801:"companyNotLinkedToBp",409802:"actisCompanyAdminMismatch",409803:"actisCompanyNameMismatch",413000:"uploadErrorTooLarge",500:"errorInternalServerError",1001:"extensionNotLinkedToEquipment",1002:"extensionHasNoIdentifier",1003:"extensionDoesNotExist",1004:"extensionLookupFailure",1005:"extensionConflict",1006:"nonUniqueEquipmentForExtension",1007:"userAlreadyAssociatedToExtension",1008:"extensionAssociatedToAnotherUser",1009:"failedToAttachExtension",1010:"userHasNoExtension",1011:"userHasTooManyExtensions",1012:"failedToDetachExtension"},s.portalErrorCodeLabels={massprovisioning:{400502:"invalidColumnName",400506:"invalidValueInActionColumn",403610:"errorMaxSubscriptionReached"}},s.handleErrorMessage=function(e,t){s.getErrorFullMessage(e,t)},s.handleError=function(e,t){var n=s.getPortal(e),r=e.status;e.data&&e.data.errorDetailsCode&&(r=e.data.errorDetailsCode);var i=new Error(s.getDetailedErrorMessage(e));return i.status=e.status,i.fieldErrors=s.getBadRequestFieldErrors(e),i.errorDetailsCode=r,i.errorDetailsLabel=s.getErrorCodeLabel(r,n),i.translatedMessage=s.getTranslatedErrorMessage(e,t,n),i.portal=n,i},s.getPortal=function(e){var t=e.config?e.config.url:void 0,n=t?t.match(/api\/rainbow\/(\w+)\//):void 0;return n?n[1]:void 0},s.getBadRequestFieldErrors=function(e){var t={};return 400===e.status&&(e.data&&e.data.errorDetails instanceof Array&&e.data.errorDetails.forEach(function(e){t[e.param]||(t[e.param]={ok:!1,message:e.msg,value:e.value})}),e.data&&400511===e.data.errorDetailsCode&&(t.office365Tenant={ok:!1,message:s.ErrorCodeLabels[400511]})),t},s.getErrorMessage=function(e){var t=s.getStatusErrorMessage(e);return e.data&&e.data.errorMsg&&(t="",e.data.errorDetails?e.data.errorDetails instanceof Array?t+="one or more fields are invalid":e.data.errorDetails.msg?t+=e.data.errorDetails.msg:t+=e.data.errorDetails:t+=e.data.errorMsg),t},s.getStatusErrorMessage=function(e){return 500===e.status?"Internal server error":415===e.status?"Unsupported Media Type":413===e.status?"Request Entity Too Large":404===e.status?"Resource not found":403===e.status?"Access is forbidden":401===e.status?"Authorization failure":400===e.status?"Bad request":e.statusText?e.statusText:"Unknown error"},s.getDetailedErrorMessage=function(e){var t=s.getErrorMessage(e);return e.data&&e.data.errorDetails&&e.data.errorDetails instanceof Array&&0<e.data.errorDetails.length&&(t+=" : "+e.data.errorDetails[0].msg),t},s.getTranslatedErrorMessage=function(e,t,n){if(500===e.status)return s.getLocalizedError("500");var r=null;e.data&&e.data.errorDetailsCode&&(r=e.data.errorDetailsCode);var i=null;return i=e.data&&e.data.errorDetailsData?Object.assign(e.data.errorDetailsData,t):t,s.getTranslatedErrorMessageByDetailsCode(r,i,s.getErrorMessage(e),n)},s.getTranslatedErrorMessageByDetailsCode=function(e,t,n,r){var i;return e&&(i=s.getLocalizedError(e,t,r)),i||(i=e?o("translate")("anErrorOccurred",{errorcode:e}):o("translate")("anErrorOccurred"),n&&(i+=" ("+o("translate")(n)+")")),i},s.getLocalizedError=function(e,t,n){var r;if(e){var i=s.getErrorCodeLabel(e,n);if(i){var a=o("translate")(i,t);a!==i&&(r=a)}}return r},s.getErrorCodeLabel=function(e,t){return t&&s.portalErrorCodeLabels[t]&&s.portalErrorCodeLabels[t][e]?s.portalErrorCodeLabels[t][e]:s.ErrorCodeLabels[e]},s.getErrorFullMessage=function(e,t){var n=t?t+" failure : ":"";return e.data?(n+=e.data.errorMsg,e.data.errorDetails&&(n+=" - ",e.data.errorDetails instanceof Array?e.data.errorDetails.forEach(function(e){n+=e.msg}):e.data.errorDetails.msg?n+=e.data.errorDetails.msg:n+=e.data.errorDetails)):n+="Unknow error - Something goes really wrong",n}}]),angular.module("rainbow").service("pushImageHelperService",["$log","$q","$http","authService","errorHelperService",function(c,l,d,u,f){"use strict";var h=this;h.pushImage=function(a,o,s){return l(function(n,r){var e=null;if(s&&s.nosize)e=function(){var e=new Image;return e.src=o,l.when(e)};else{var t=s&&s.width?s.width:512,i=s&&s.height?s.height:512;e=function(){return h.resizeImage(o,t,i)}}e().then(function(e){var t=h.getBinaryData(e);d({method:"POST",url:a,headers:u.getPostHeader("image/"+t.type),data:t.data,transformRequest:[]}).then(function(){c.info("[pushImageHelperService] pushImage : success"),n()},function(e){var t=f.handleError(e);r(t),c.error("[pushImageHelperService] "+f.getErrorFullMessage(e,"pushImage"))})})})},h.resizeImage=function(e,o,s){return l(function(i){var a=new Image;a.src=e,a.onload=function(){var e=a.width,t=a.height;t<e?o<e&&(t*=o/e,e=o):s<t&&(e*=s/t,t=s);var n=document.createElement("canvas");n.width=e,n.height=t,a.width=e,a.height=t,n.getContext("2d").drawImage(this,0,0,e,t);var r=new Image;r.src=n.toDataURL("image/png"),i(r)}})},h.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}}}]),angular.module("rainbow").service("$localStorage",["$q",function(r){"use strict";this.get=function(e){for(var t={},n=0;n<e.length;n++)t[e[n]]=localStorage.getItem(e[n]);return r.when(t)},this.set=function(e){for(var t=Object.keys(e),n=0;n<t.length;n++)localStorage.setItem(t[n],e[t[n]]);return r.when()},this.remove=function(e){for(var t=0;t<e.length;t++)localStorage.removeItem(e[t]);return r.when()}}]),angular.module("rainbow").service("authService",["$http","$q","$window","$log","$localStorage","$interval","$rootScope","jwtHelper","settingsService",function(o,s,c,l,d,u,f,h,t){"use strict";var p=this;p.onInit=function(){l.info("[authService] === INITIALIZATION ==="),p.login=null,p.token=null,p.jidIm=null,p.jidTel=null,p.jidPwd=null,p.initialized=null,p.renewAppTokenInterval=null,p.renewTokenInterval=null,p.userData=null,p.firstUse=null===localStorage.getItem("firstUse"),p.browserFingerprint=null,p.isGuest=!1,config.appModuleKey||(config.appModuleKey=angular.module("rainbow").moduleIds?angular.module("rainbow").moduleIds.join(""):"default"),p.sdkHostForced=null,p.appToken=null,p.fromSDK=!1,p.firstUseNewVersion=!1;var e=localStorage.getItem("version");p.getMajorVersion(e)!==p.getMajorVersion(version)&&(p.firstUseNewVersion=!0),d.set({version:version})},p.getMajorVersion=function(e){if(!e)return null;var t=/\d+\.\d+/g.exec(e);return t&&0<t.length?t[0]:null},p.registerEventsHandler=function(){p.visibilityHandlerRemoval&&p.visibilityHandlerRemoval(),p.visibilityHandlerRemoval=f.$on("ON_APP_VISIBLE_CHANGE_EVENT",function(e,t){t&&p.startTokenSurvey()})},p.isInitialized=function(){return p.initialized},p.isFirstUse=function(){return p.firstUse},p.getRequestHeader=function(){var e={Authorization:"Bearer "+p.token,Accept:"application/json"};return p.fromSDK&&p.appToken,e},p.getRequestHeaderWithRange=function(e){var t=p.getRequestHeader();return t.Range=e,t},p.getPostHeader=function(e){var t=p.getRequestHeader(),n=e||"application/json";return t["Content-Type"]=n,t},p.getPostHeaderWithRange=function(e,t){var n=p.getPostHeader(t);return n["Content-Range"]=e,n},p.authenticateOnHost=function(e,t,n,r,i){return p.sdkHostForced=n,p.appToken=r,p.fromSDK=!0,i?(config.xmpp.currentServer=p.sdkHostForced,config.webservices.currentServer=p.sdkHostForced,config.restServerUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port,p.authenticateWithToken(i)):p.authenticate(e,t,!1)},p.authenticate=function(n,r,i){return s(function(e,t){l.info('[authService] authenticate with "'+n+'"'),p.getLocalStorageAuthInfo(!1).then(function(){return p.logon(n,r,i)}).then(function(){p.registerEventsHandler(),e()}).catch(function(e){l.error("[authService] authenticate failure -- "+e.message),t(e)})})},p.logon=function(i,n,a){return s(function(t,r){var e={Authorization:"Basic "+c.btoa(unescape(encodeURIComponent(i+":"+n))),Accept:"application/json"};p.setInformationHeaders(e),config.rainbowApiClientKey&&(e["x-rainbow-app-auth"]="Basic "+c.btoa(unescape(encodeURIComponent(config.rainbowApiClientKey+":"+CryptoJS.SHA256(config.appModuleKey+n))))),p.fromSDK&&p.appToken&&p.appToken.appID&&(e["x-rainbow-app-auth"]="Basic "+c.btoa(unescape(encodeURIComponent(p.appToken.appID+":"+CryptoJS.SHA256(p.appToken.appSecret+n))))),o({method:"GET",withCredentials:!0,url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/login",headers:e,timeout:15e3}).then(function(e){l.info('[authService] authenticate with "'+i+'" success'),f.disconnected=!1,p.userData=e.data.loggedInUser,p.token=e.data.token,p.userId=e.data.loggedInUser.id,p.login=e.data.loggedInUser.loginEmail,p.jidIm=e.data.loggedInUser.jid_im,p.jidTel=e.data.loggedInUser.jid_tel,p.jidPwd=e.data.loggedInUser.jid_password,p.initialized=e.data.loggedInUser.isInitialized,p.companyId=e.data.loggedInUser.companyId,p.firstUse=!1,p.isGuest=e.data.loggedInUser.guestMode,p.xmppDomain=p.jidIm.split("@")[1],p.handleUserLanguage(),d.set({firstUse:"false"}),a?(l.info("[authService] store credentials"),d.set({token:p.token,login:p.login,id:p.userId}),p.startTokenSurvey(!0)):p.removeCredentials(),t()},function(e){var t='authenticate for login "'+i+'" failure : ',n="errorUltimateUnknownError";e||(t+="Ultimate unknown error"),0===e.status||-1===e.status?(t+="No server response",n="errorNoServerResponse"):401===e.status?(p.removeCredentials(),t+=e.data.errorDetails,401500===e.data.errorDetailsCode?n="errorUnauthorized":401501===e.data.errorDetailsCode&&(n="errorLoginForbidden")):500===e.status&&(t+=e.data.errorDetails,n="errorInternalServerError"),l.info("[authService] "+t),r(new RBError(t,n))})})},p.setInformationHeaders=function(e){e["x-rainbow-client"]=p.getInformationHeadersApp(),e["x-rainbow-client-version"]=p.getInformationHeadersAppVersion()},p.getInformationHeadersApp=function(){return"web_sdk"},p.getInformationHeadersAppVersion=function(){return window.sdkversion?window.sdkversion:"9.9.99"},p.authenticateWithToken=function(e){var t=h.decodeToken(e);return p.token=e,p.login=t.user.loginEmail,p.userId=t.user.id,s(function(e,n){p.startTokenSurvey().then(function(){return p.getUserData()}).then(function(){p.registerEventsHandler(),e()}).catch(function(e){var t=e?e.message:"unknown error";l.error("[authService] authenticateWithToken failure -- "+t),n()})})},p.authenticateWithLocalCredentials=function(n){return s(function(e,t){p.getLocalStorageAuthInfo(!0).then(function(){return n&&p.login!==n?s.reject(new Error("Login account mismatch")):s.resolve()}).then(function(){return p.startTokenSurvey()}).then(function(){return p.getUserData()}).then(function(){p.registerEventsHandler(),e()}).catch(function(e){l.error("[authService] authenticateWithLocalCredentials failure -- "+e.message),t(e)})})},p.getLocalStorageAuthInfo=function(r){return s(function(t,n){d.get(["token","appToken","login","server","support","id"]).then(function(e){l.info("[authService] get authentication token"),e.server&&"null"!==e.server&&"undefined"!==e.server?(config.xmpp.currentServer=e.server,config.webservices.currentServer=e.server):p.sdkHostForced?(config.xmpp.currentServer=p.sdkHostForced,config.webservices.currentServer=p.sdkHostForced):(config.xmpp.currentServer=config.xmpp.server,config.webservices.currentServer=config.webservices.server),config.restServerUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port,r?(p.token=e.token,p.appToken=e.appToken,p.login=e.login,p.userId=e.id,p.token&&p.login?t():n(new Error("No existing token"))):t()})})},p.startTokenSurvey=function(){return s(function(e,t){p.startAppTokenSurvey().then(function(){return p.startUserTokenSurvey()}).then(function(){l.debug("[authService] startTokenSurvey success"),e()}).catch(function(e){e&&e.message||(e=new Error("Unknown error")),l.error("[authService] startTokenSurvey failure -- "+e.message),t(e)})})},p.startUserTokenSurvey=function(e){var t=h.decodeToken(p.token),n=1e3*t.exp,r=(n-1e3*t.iat)/2,i=new Date(n),a=n-(new Date).valueOf();if(e&&l.info("[authService] on logon"),l.info("[authService] Extract auth token info (countRenewed: "+t.countRenewed+", maxTokenRenew: "+t.maxTokenRenew+", tokenExpirationDuration: "+a+")"),a<0)return l.info("[authService] auth token has already expired, display login page"),p.renewTokenInterval&&u.cancel(p.renewTokenInterval),p.token=null,f.$broadcast("ON_AUTH_TOKEN_EXPIRE"),s.reject(new Error("Token expired"));if(a<r)return l.info("[authService] auth token will expire in less "+r/1e3+" seconds, re-new it immediately"),p.renewAuthToken();var o=a-r;return l.info("[authService] start auth token survey (expirationDate: "+i+" tokenExpirationDuration: "+a+"ms usedExpirationDuration: "+o+"ms)"),p.renewTokenInterval&&u.cancel(p.renewTokenInterval),p.renewTokenInterval=u(function(){p.renewAuthToken()},o),s.resolve()},p.renewAuthToken=function(){return s(function(t,r){l.info("[authService] re-new authentication token"),o({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/renew",headers:p.getRequestHeader()}).then(function(e){l.info("[authService] renew authentication token success"),p.token=e.data.token,d.set({token:p.token}),f.$broadcast("ON_AUTH_TOKEN_RENEW"),p.startTokenSurvey(),t()},function(e){var t="renew authentication token failure -- "+(e.data&&e.data.errorDetails?e.data.errorDetails:"no details"),n=new Error(t);n.details="AUTH_TOKEN_EXPIRED",l.error("[authService] "+t),u.cancel(p.renewTokenInterval),f.$broadcast("ON_AUTH_TOKEN_EXPIRE"),r(n)})})},p.startAppTokenSurvey=function(){if(!p.appToken||"string"!=typeof p.appToken||!p.appToken.length)return l.info("[authService] No application token."),s.resolve();var e=h.decodeToken(p.appToken),t=1e3*e.exp,n=new Date(t),r=t-(new Date).valueOf();if(l.info("[authService] Extract application token info (countRenewed: "+e.countRenewed+", maxTokenRenew: "+e.maxTokenRenew+")"),r<0)return l.info("[authService] application token has already expired, re-new it immediately"),p.renewAppToken();if(r<3e4)return l.info("[authService] application token will expire in less 5 minutes, re-new it immediately"),p.renewAppToken();var i=r-24e3;return l.info("[authService] start application token survey (expirationDate: "+n+" tokenExpirationDuration: "+r+"ms usedExpirationDuration: "+i+"ms)"),p.renewAppTokenInterval&&u.cancel(p.renewAppTokenInterval),p.renewAppTokenInterval=u(function(){p.renewAppToken()},i),s.when()},p.renewAppToken=function(){return s(function(t,r){l.info("[authService] re-new application token"),o({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/applications/v1.0/authentication/renew",headers:p.getRequestHeader()}).then(function(e){l.info("[authService] renew application token success"),p.appToken=e.data.token,d.set({appToken:p.appToken}),f.$broadcast("ON_APP_TOKEN_RENEW"),p.startAppTokenSurvey(),t()},function(e){var t="renew application token failure -- "+(e.data&&e.data.errorDetails?e.data.errorDetails:"no details"),n=new Error(t);n.details="APP_TOKEN_EXPIRED",l.error("[authService] "+t),u.cancel(p.renewAppTokenInterval),f.$broadcast("ON_APP_TOKEN_EXPIRE"),r(n)})})},p.getUserData=function(){return s(function(t,n){o({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+p.userId,headers:p.getRequestHeader()}).then(function(e){p.userData=e.data.data,p.login=e.data.data.loginEmail,p.jidIm=e.data.data.jid_im,p.jidTel=e.data.data.jid_tel,p.jidPwd=e.data.data.jid_password,p.initialized=e.data.data.isInitialized,p.companyId=e.data.data.companyId,p.isGuest=e.data.data.guestMode,p.xmppDomain=p.jidIm.split("@")[1],p.handleUserLanguage(),t(p.userData)},function(e){p.removeCredentials(),n(new Error("Wrong token -- "+e.message))})})},p.getFingerPrint=function(){return s(function(t){if(p.browserFingerprint)t(p.browserFingerprint);else{imprint.test(["audio","canvas","cookies","cpuClass","doNotTrack","indexedDb","installedFonts","language","localStorage","platform","plugins","processorCores","sessionStorage","timezoneOffset","touchSupport","userAgent","webGl"]).then(function(e){p.browserFingerprint=e,t(e)})}})},p.handleUserLanguage=function(){var e=p.userData.language;e&&t.setAppliLangageCodeFromServer(e)},p.removeCredentials=function(){l.info("[authService] remove credentials");var e=["token","id"];p.isGuest&&e.push("login"),d.remove(e),p.isGuest=!1},p.onInit()}]);var REQUEST_TIMEOUT=1e4;angular.module("rainbow").service("xmppService",["$rootScope","$log","$q","$interval","authService","randomString","settingsService",function(h,p,r,i,a,n,o){"use strict";var v=this;v.disconnectionHandler=null,Strophe.log=function(e,t){switch(e){case Strophe.LogLevel.WARN:p.warn(t);break;case Strophe.LogLevel.ERROR:case Strophe.LogLevel.FATAL:p.error(t);break;default:p.debug(t)}},v.start=function(t){p.info(""),p.info("[xmppService] === STARTING ===");var n=performance.now();v.showBodyMessage="true"===o.getSetting("showBodyMessage"),v.started=!1,v.connected=!1,v.stropheStatus=null,v.presenceStatus="offline";var e=config.xmpp.pingInterval?config.xmpp.pingInterval:6e4;return this.pingTimeout=2*e,v.serverURL=config.xmpp.protocol+"://"+config.xmpp.currentServer+":"+config.xmpp.port+"/websocket",v.presenceWaitingList=[],v.jidsToRemove=[],v.fullJid=null,a.jidIm&&a.jidPwd?this.connect().then(function(){v.started=!0;var e=Math.round(performance.now()-n);t.push({service:"xmppService",startDuration:e}),p.info("[xmppService] === STARTED ("+e+" ms) ===")}).catch(function(e){return p.error("[xmppService] === STARTING FAILURE ("+e.message+") === "),r.reject(new Error("Starting failure : "+e.message))}):(p.info("Starting failure : No valid XMPP credentials"),r.reject(new Error("No valid XMPP credentials")))},v.stop=function(){try{return this.disconnect("Stop service").finally(function(){v.connection=null,v.started=!1,v.stropheStatus=null,v.presenceWaitingList=[],v.deferDisconnect=null,v.fullJid=null})}catch(e){return p.error("XMPP disconnect error : "+e),v.connection=null,v.started=!1,v.stropheStatus=null,v.presenceWaitingList=[],v.deferDisconnect=null,v.fullJid=null,r.when()}},v.connect=function(){p.info("[xmppService] -- ASK CONNECTION --");try{var n=r.defer();if(v.stropheStatus===Strophe.Status.CONNECTING||v.stropheStatus===Strophe.Status.CONNECTED||v.stropheStatus===Strophe.Status.AUTHENTICATING){p.info("[xmppService] already connecting");var e=new Error("XMPP service already-connected");return e.details="XMPP_ALLREADY_CONNECTED",r.reject(e)}return v.connection=new Strophe.Connection(v.serverURL+"?x-rainbow-client="+a.getInformationHeadersApp()+"&x-rainbow-client-version="+a.getInformationHeadersAppVersion()+"&x-rainbow-xmpp-dom="+a.xmppDomain),v.connection.rawInput=function(e){return v.handleRawXmppMessage(e,"Recv: ")},v.connection.rawOutput=function(e){return v.handleRawXmppMessage(e,"Sent: ")},v.connecting=!0,v.generateRandomFullJid(a.jidIm).then(function(e){v.fullJid&&(e=v.fullJid),v.connection.connect(e,a.jidPwd,function(e,t){switch(v.stropheStatus=e,t=angular.isUndefined(t)?"":t,e){case Strophe.Status.CONNECTING:p.info("[xmppService] -- Connecting --"),h.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","inProgress");break;case Strophe.Status.AUTHFAIL:p.error("[xmppService] -- Authentication failure -- "+t),n.reject(new Error("Authentication failure -- "+t));break;case Strophe.Status.CONNFAIL:v.connecting&&(p.error("[xmppService] -- Connection failure -- "+t),n.reject(new Error("Connection failure -- "+t)));break;case Strophe.Status.CONNECTED:p.info("[xmppService] -- Connected -- "+v.connection.jid),v.connecting=!1,v.connected=!0,v.jid=a.jidIm,v.fullJid=v.connection.jid,v.connection.addHandler(v.onRosterChanged,"jabber:iq:roster","iq","set"),v.connection.addHandler(v.onMamMessageReceived,Strophe.NS.MAM,"message",null),v.connection.addHandler(v.onMamMessageReceived,Strophe.NS.MAM,"iq",null),v.connection.addHandler(v.onSearchTextMessageReceived,"urn:xmpp:mam:tmp","message",null),v.addPresenceHandler(),v.presenceWaitingList=[],v.connection.ping.addPingHandler(function(e){var t=new Date;return p.info("[xmppService] -- Receive keepAlive Ping request ("+t+")"),v.connected&&v.connection.ping.pong(e),!0}),v.enableCarbon(),n.resolve();break;case Strophe.Status.DISCONNECTING:p.info("[xmppService] -- Disconnecting -- "+t);break;case Strophe.Status.DISCONNECTED:p.info("[xmppService] -- Disconnected -- "+v.fullJid),v.started?(h.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","disconnected"),-1===v.jidsToRemove.indexOf(v.fullJid)&&(v.jidsToRemove.push(v.fullJid),v.jidsToRemove.forEach(function(e){p.info("[xmppService] -- invalid jid to remove -- "+e)})),v.deferDisconnect?(p.info("[xmppService] -- disable ping connection watcher"),v.connectionWatcherPromise&&i.cancel(v.connectionWatcherPromise),v.connected=!1,v.deferDisconnect.resolve()):v.connected&&!v.connecting?(p.error("[xmppService] -- Unexpected disconnection"),v.connecting=!0,v.connected=!1,h.disconnected=!0,v.disconnectionHandler()):v.connected||v.connecting||!v.fullJid?v.connected||v.connecting||v.fullJid||(p.error("[xmppService] -- Unexpected disconnection without fullJid"),v.connecting=!0,v.disconnectionHandler()):(p.error("[xmppService] -- Unexpected disconnection with fullJid"),v.connecting=!0,v.disconnectionHandler())):(p.info("[xmppService] -- received disconnect event but service not started !!"),p.info("[xmppService] -- disable ping connection watcher"),v.connectionWatcherPromise&&i.cancel(v.connectionWatcherPromise),h.disconnected=!0);break;default:p.error("[xmppService] -- Connection to the xmpp server failure -- "+e+" -- "+t),v.connecting?n.reject(new Error("Connection failure -- "+t)):v.disconnectionHandler()}})}),n.promise}catch(e){return p.error("XMPP service connect error : "+e),r.reject("catch-connect-error")}},v.handleRawXmppMessage=function(e,t){if(v.connectionWatcherPromise&&i.cancel(v.connectionWatcherPromise),v.connectionWatcherPromise=i(v.connectionWatcher,v.pingTimeout),!(-1<e.indexOf("<PHOTO>"))){var n=t;if(-1<e.indexOf("<message")&&-1<e.indexOf("<body"))n+=v.messageBodyDiscretion(e);else{var r=$(e).find("data");r&&"http://jabber.org/protocol/ibb"===r.attr("xmlns")?(r.html("Encoded file in base 64"),n+=r.html()):n+=e}p.debug(n)}},v.messageBodyDiscretion=function(e){if(v.showBodyMessage)return e;var t=e.indexOf("<body");if(-1===t)return e;var n=e.indexOf(">",t);return n===e.indexOf("/>",t)+1?e:-1===n?e:e.substr(0,n+2)+"***"+e.substr(e.indexOf("</body>")-1)},this.connectionWatcher=function(){try{if(p.error("[xmppService] -- Connection watcher : so bad, no message since "+v.pingTimeout/1e3+" seconds (no ping)"),v.connection){var e=v.stropheStatus===Strophe.Status.CONNECTED?"Have lost connectivity":"Stuck in reconnecting state";p.info("[xmppService] -- Connection watcher -- "+e),v.stropheStatus=null,v.connection.disconnect("No ping")}}catch(e){p.error("connectionWatcher error "+e)}},v.disconnect=function(e){return v.deferDisconnect=r.defer(),p.info("[xmppService] -- ASK DISCONNECTION --"),this.connected?v.stropheStatus===Strophe.Status.CONNECTED&&v.connection.disconnect(e):(p.info("[xmppService] -- disconnect - service is not started"),v.deferDisconnect.resolve()),v.deferDisconnect.promise},v.generateRandomFullJid=function(e){return v.generateRandomFullJidForWeb(e)},v.generateRandomFullJidForWeb=function(e){return r.when(e+"/web_sdk_"+version+"_"+n(8))},v.removeOldConnection=function(){i(function(){var e=v.jidsToRemove.map(function(e){if(e!==v.fullJid)return v.disconnectObsoleteJid(e).then(function(){p.info("[xmppService] -- disconnect obsolete jid -- "+e+" done")});p.info("[xmppService] -- ignore disconnect obsolete jid for "+e)});v.jidsToRemove=[],r.all(e).catch(function(e){p.warn("[xmppService] -- somethings goes wrong during obsolete jid removal -- "+e.message)})},1e4,1)},v.disconnectObsoleteJid=function(e){var t=$iq({type:"set",id:n(8),from:v.fullJid}).c("disconnect",{xmlns:"jabber:iq:configuration"}).c("to").t(e);return v.sendIQ(t)},this.onRosterChanged=function(e){try{return angular.element(e).find("item").each(function(){var e=Strophe.getBareJidFromJid(angular.element(this).attr("jid")),t="favorites"===angular.element(this).find("group").first().text(),n=angular.element(this).attr("subscription"),r=angular.element(this).attr("ask");h.$apply(function(){h.$broadcast("ON_ROSTER_CHANGED_EVENT",{jid:e,subscription:n||"none",favorite:t,ask:r||"none"})})}),!0}catch(e){return!0}},this.addHistoryHandler=function(e){this.historyHandler=e},this.addSearchTextHandler=function(e){this.searchTextHandler=e},this.addHistoryCallLogsHandler=function(e){this.callLogHandler=e},this.onMamMessageReceived=function(e){p.info("[XmppService] onMamMessageReceived");try{var t=angular.element(e).find("result").attr("queryid");return t||(t=angular.element(e).find("fin").attr("queryid")),t&&0!==t.indexOf("tel_")&&v.historyHandler?v.historyHandler(e):v.callLogHandler&&v.callLogHandler(e),!0}catch(e){return!0}},this.onSearchTextMessageReceived=function(e){p.info("[XmppService] onSearchTextMessageReceived");try{var t=angular.element(e).find("result").attr("queryid");return t||(t=angular.element(e).find("fin").attr("queryid")),v.searchTextHandler&&v.searchTextHandler(t,e),!0}catch(e){return p.warn("[XmppService] onSearchTextMessageReceived error : "+e.message),!0}},this.addPresenceHandler=function(){return p.info("[xmppService] -- Add presence handler"),this.connection.addHandler(v.onPresence,null,"presence"),r.when()},this.sendPresence=function(e,t,n){if(this.connection||v.stropheStatus===Strophe.Status.CONNECTED)try{p.info("Send presence "+e+" - "+t+" ("+v.jid+")");var r=$pres();if(r.c("priority").t("5"),r.up(),e&&"online"!==e&&r.c("show").t(e),!t||e&&"online"!==e?t&&r.up().c("status").t(t):r.c("status").t(t),!this.connection||!this.connection.send)return void p.error('Try to send "presence IQ" but no xmpp connection');!0===n&&(r.c("application",{xmlns:"jabber:iq:application"}),r.c("appid").t(config.rainbowApiClientKey).up(),r.c("userid").t(a.userId)),this.connection.send(r)}catch(e){return void p.error("this.connection.send error : "+e)}else p.error('[xmppService] Try to send "presence IQ" but no xmpp connection')},this.resetPresence=function(e){p.info("Reset presence to "+v.presenceStatus+" ("+v.jid+")"),v.sendPresence(e.show,e.status)},this.onPresence=function(e){try{var t=angular.element(e).attr("from"),n=Strophe.getBareJidFromJid(t),r=angular.element(e).find("x").attr("xmlns"),i=angular.element(e).attr("type"),a=angular.element(e).find("show").text();if(r&&0===r.indexOf(Strophe.NS.MUC))return!0;if(0<angular.element(e).find("actor").length&&"jabber:iq:configuration"===angular.element(e).find("actor").attr("xmlns")&&(0<angular.element(e).find("avatar").length?h.$broadcast("ON_VCARD_UPDATE_EVENT",n,"avatar"):0<angular.element(e).find("data").length&&h.$broadcast("ON_VCARD_UPDATE_EVENT",n,"data"),angular.element(e).find("x").length&&"vcard-temp:x:update"===angular.element(e).find("x").attr("xmlns")))return h.$broadcast("ON_PROFILE_FEATURES_UPDATE_NEEDED"),!0;if("error"===i)p.error("Receive error presence message");else if("subscribe"===i)p.info("Receive subscribe from ("+n+")"),h.$broadcast("ON_ROSTER_SUBSCRIBE_EVENT",n);else{var o=$(e),s="offline",c="";"unavailable"!==i&&(a=o.find("show").text(),c=o.find("status").text(),s=""===a||"chat"===a?"online":"dnd"===a?"dnd":"xa"===a?"xa":"away");var l=o.find("delay").attr("stamp"),d=l?new Date(l):new Date,u=o.find("until").text(),f={jid:t,status:s,message:c,stamp:d,until:u=u?new Date(u):null};h.$$listeners&&h.$$listeners.ON_ROSTER_PRESENCE_CHANGED_EVENT?h.$broadcast("ON_ROSTER_PRESENCE_CHANGED_EVENT",f):(p.info("[XMPP Service] Receive presence message but contact service is not ready yet"),v.presenceWaitingList.push(f))}return!0}catch(e){return!0}},this.getPresenceWaitingList=function(){return v.presenceWaitingList},this.resetPresenceWaitingList=function(){v.presenceWaitingList=[]},this.enableCarbon=function(){var e=$iq({type:"set"});return e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),v.sendIQ(e)},this.send=function(e){if(!v.connection&&v.stropheStatus!==Strophe.Status.CONNECTED)return p.error('[xmppService] Try to send "stanza" but no xmpp connection'),r.reject(new Error("No XMPP connection"));try{this.connection.send(e)}catch(e){return p.error("[xmppService] this.connection.send error : "+e),r.when()}return r.when()},this.sendIQ=function(e){if(!this.connection&&v.stropheStatus!==Strophe.Status.CONNECTED)return p.error('[xmppService] Try to send "iq" but no xmpp connection'),r.reject(new Error("No XMPP connection"));var t=r.defer();try{this.connection.sendIQ(e,function(e){t.resolve(e)},function(e){null===e?t.reject(new Error("XMPP request timeout")):t.reject(new Error(e.innerHTML))},REQUEST_TIMEOUT)}catch(e){return p.error("[xmppService] this.connection.sendIQ error : "+e),r.reject(new Error("this.connection.sendIQ error"))}return t.promise},this.getBareJidFromJid=function(e){return Strophe.getBareJidFromJid(e)},this.getResourceFromJid=function(e){return Strophe.getResourceFromJid(e)},this.addHandler=function(e,t,n,r,i,a,o){return this.connection.addHandler(e,t,n,r,i,a,o)},this.deleteHandler=function(e){this.connection&&this.connection.deleteHandler(e)},this.addFileTransfertHandlers=function(e,t){this.connection.ibb.addIBBHandler(e),this.connection.si_filetransfer.addFileHandler(t)},this.addCallLogsHandler=function(e){this.rtcStartRef&&(this.connection.deleteHandler(this.rtcStartRef),this.rtcStartRef=null),this.rtcEndRef&&(this.connection.deleteHandler(this.rtcEndRef),this.rtcEndRef=null),this.rtcRingingRef&&(this.connection.deleteHandler(this.rtcRingingRef),this.rtcRingingRef=null),this.rtcStartRef=this.connection.addHandler(e,null,"message","webrtc-start"),this.rtcEndRef=this.connection.addHandler(e,null,"message","webrtc-end"),this.rtcRingingRef=this.connection.addHandler(e,null,"message","webrtc-ringing")},this.addTelephonyCallLogsHandler=function(e){this.telephonyMessageRef&&(this.connection.deleteHandler(this.telephonyMessageRef),this.telephonyMessageRef=null),this.telephonyIqRef&&(this.connection.deleteHandler(this.telephonyIqRef),this.telephonyIqRef=null),this.telephonyMessageRef=v.connection.addHandler(e,Strophe.NS.CALLLOG,"message",null),this.telephonyIqRef=v.connection.addHandler(e,Strophe.NS.CALLLOG,"iq",null)},this.addPubSubPublishHandler=function(e){v.connection.addHandler(e,"jabber:client","message","headline",null,"pubsub.demo-all-in-one-dev-1.opentouch.cloud")},this.getIpAddress=function(){return r(function(r,i){if(RTCPeerConnection){var a=new RTCPeerConnection({iceServers:[]}),o=function(){},s=[];a.createDataChannel(""),a.createOffer(a.setLocalDescription.bind(a),o),a.onicecandidate=function(e){if(e&&e.candidate&&e.candidate.candidate){var t=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(e.candidate.candidate);if(t&&2<=t.length){var n=t[1];s.push(n)}}else{if(a.onicecandidate=o,!s.length)return void i();r(s)}}}else i()})}}]),angular.module("rainbow").service("contactService",["$q","$rootScope","$translate","$log","$injector","$http","xmppService","authService","Contact","$interval","settingsService","PromiseQueue","companyService","errorHelperService",function(c,o,r,s,i,l,a,d,u,f,h,p,v,m){"use strict";var g=this;g.start=function(r){s.info(""),s.info("[contactService] === STARTING ===");var i=performance.now();return c(function(t,n){if(g.userContact=null,g.contacts=[],g.dbContacts=[],g.jtelContacts={},g.contactPromises=[],g.networkSize=0,g.started=!1,g.changePasswordInfo=null,g.subscriptionPromiseQueue=p.create(),g.presentationModeActive=!1,g.awayStateActive=!1,g.busyState={status:null,message:null},g.forcedState=!1,g.manualState=!1,g.currentLanguage=h.getSetting("lang"),g.langUpdateEventHandlerCleaner&&g.langUpdateEventHandlerCleaner(),g.langUpdateEventHandlerCleaner=o.$on("ON_LANGUAGE_UPDATED_EVENT",function(e,t){g.currentLanguage=t,g.updateContactsLastActivity()}),g.rosterUpdateEventHandlerCleaner&&g.rosterUpdateEventHandlerCleaner(),g.rosterUpdateEventHandlerCleaner=o.$on("ON_ROSTER_CHANGED_EVENT",g.rosterChangedHandler),g.presenceUpdateEventHandlerCleaner&&g.presenceUpdateEventHandlerCleaner(),g.presenceUpdateEventHandlerCleaner=o.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",g.contactPresenceChangedHandler),g.calendarPresenceEventHandlerCleaner&&g.calendarPresenceEventHandlerCleaner(),g.calendarPresenceEventHandlerCleaner=o.$on("ON_CONTACT_CALENDAR_STATUS_CHANGE",g.contactCalendarPresenceChangedHandler),s.info("[contactService] Create userContact ("+a.jid+")"),g.userContact=new u,g.userContact.ask=null,g.userContact.subscription=null,g.userContact.id=a.jid,g.userContact.jid=a.jid,g.userContact.fullJid=a.fullJid,g.userContact.language=g.currentLanguage,g.userContact.updateFromUserData(d.userData),g.userContact.getAvatar(),g.userContact.updateRichStatus(),g.retrieveOpenInviteId().catch(function(){g.resetOpenInviteId()}),g.dbContacts[g.userContact.dbId]=g.userContact,g.contacts[g.userContact.id]=g.userContact,g.jtelContacts[g.userContact.jidtel]=g.userContact,!d.userData.language){var e=h.getAppliLanguageCodeForServer();g.updateUserContact({language:e})}g.getUserSettings().then(function(e){return g.manageCalendarPresencePrompt(e),h.settings.activeAlarm=e.activeAlarm,h.settings.activeNotif=e.activeNotif,s.info("[contactService] Get alarm & notif data ("+h.settings.activeAlarm+" / "+h.settings.activeNotif+")"),s.info("[contactService] Subscribe to my telephony presence ("+g.userContact.jidtel+")"),g.sendSubscribeInvitation(g.userContact.jidtel)}).then(function(){return v.getCompanyById(g.userContact.company.id)}).then(function(e){return g.userContact.company=e,g.attachHandlers(),g.getMyNetwork()}).then(function(){return g.updateNetworkWithRosterInfo()}).then(function(){g.appActiveEventHandlerCleaner&&g.appActiveEventHandlerCleaner(),g.appActiveEventHandlerCleaner=o.$watch("appActive",function(e){return s.info("[contactService] AppActive changed : "+e),!e&&g.userContact&&"online"===g.userContact.status&&(g.awayStateActive=!0),e&&g.awayStateActive&&(g.awayStateActive=!1),angular.isDefined(e)&&g.updatePresence(!0),!0}),g.vcardUpdateEventHandlerCleaner&&g.vcardUpdateEventHandlerCleaner(),g.vcardUpdateEventHandlerCleaner=o.$on("ON_VCARD_UPDATE_EVENT",g.onVCardChangeEvent),g.getMissedPresenceMessages();var e=Math.round(performance.now()-i);r.push({service:"contactService",startDuration:e}),s.info("[contactService] === STARTED ("+e+" ms) ==="),g.started=!0,t()}).catch(function(e){s.error("[contactService] === STARTING FAILURE === "+e.message),n(e)}),g.connectionStateEventHandlerCleaner&&g.connectionStateEventHandlerCleaner(),g.connectionStateEventHandlerCleaner=o.$on("ON_CONNECTION_STATE_CHANGE_EVENT",g.onConnectionStateChangeEvent),g.contactLastActivityTimerInterval=f(g.updateContactsLastActivity,6e4)})},g.manageCalendarPresencePrompt=function(e){if(void 0!==e.promptForCalendarPresence)h.setSetting("disableCalendarPresence",e.promptForCalendarPresence?"false":"true"),s.info("[contactService] promptForCalendarPresence -- "+e.promptForCalendarPresence);else{var t="true"!==h.getSetting("disableCalendarPresence");s.info("[contactService] MIGRATION NECESSARY -- promptForCalendarPresence : "+t),g.setUserSettings({promptForCalendarPresence:t})}},g.getMyNetwork=function(){return c(function(n,t){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/networks?limit=2000";l({method:"GET",url:e,headers:d.getRequestHeader()}).then(function(e){var t=e.data.data;s.info("[contactService] GetMyNetwork success -- find "+t.length+" contact(s)"),t.forEach(function(e){var t=new u;t.updateFromUserData(e),g.contacts[t.id]=t,g.dbContacts[t.dbId]=t,(g.jtelContacts[t.jidtel]=t).updateRichStatus(),t.getAvatar(),g.sendUpdateEvent(t)}),g.networkSize=t.length,n()},function(){var e="GetMyNetwork failure";s.error("[contactService] "+e),t(new Error(e))})})},g.updateNetworkWithRosterInfo=function(){return c(function(t,n){a.sendIQ($iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"})).then(function(e){s.info("[contactService] Get rosters info successfully"),$(e).find("item").each(function(){var e=$(this),t=a.getBareJidFromJid(e.attr("jid"));if(t&&t.length&&!g.isTelJid(t)){var n=g.contacts[t];if(n){var r=e.attr("ask"),i=e.attr("subscription");n.ask=angular.isDefined(r)?r:"none",n.subscription=angular.isDefined(i)?i:"none",n.roster=!0,n.updateRichStatus(),s.info("[contactService] Update contact "+n.displayName+" from roster ("+n.ask+", "+n.subscription+") "+t)}}}),t()}).catch(function(e){s.error("[contactService] Get rosters failure : "+e.message),n(e)})})},g.getMissedPresenceMessages=function(){s.info("[contactService] GetMissedPresenceMessages");try{var e=a.getPresenceWaitingList();if(e.length){for(s.info("[contactService] GetMissedPresenceMessages length "+e.length);0<e.length;){var t=e.pop();g.contactPresenceChangedHandler(null,t)}a.resetPresenceWaitingList()}}catch(e){s.error("[contactService] GetMissedPresenceMessages error "+e)}},g.attachHandlers=function(){s.info("[contactService] AttachHandlers"),this.contactConfigRef&&(a.connection.deleteHandler(this.contactConfigRef),this.contactConfigRef=null),this.contactConfigRef=a.connection.addHandler(g.onUserManagementEvent,null,"message","management")},g.stop=function(){return s.info("[contactService] Stopping"),g.userContact=null,g.contacts=null,g.dbContacts=null,g.started=!1,g.presentationModeActive=!1,g.awayStateActive=!1,g.busyState={status:null,message:null},g.forcedState=!1,g.manualState=!1,s.info("[contactService] Stopped"),g.vcardUpdateEventHandlerCleaner&&(g.vcardUpdateEventHandlerCleaner(),g.vcardUpdateEventHandlerCleaner=null),g.connectionStateEventHandlerCleaner&&(g.connectionStateEventHandlerCleaner(),g.connectionStateEventHandlerCleaner=null),g.contactLastActivityTimerInterval&&(f.cancel(g.contactLastActivityTimerInterval),g.contactLastActivityTimerInterval=null),c.when()},g.onConnectionStateChangeEvent=function(e,t){if("disconnected"===t&&g.userContact){for(var n in g.userContact.resources={},g.contacts)g.contacts.hasOwnProperty(n)&&!g.contacts[n].isBot&&(g.contacts[n].resources={},"unknown"!==g.contacts[n].status&&"none"!==g.contacts[n].subscription&&(g.contacts[n].status="offline",g.contacts[n].imStatusStamp={}));g.presentationModeActive=!1,g.awayStateActive=!1,g.busyState={status:null,message:null},g.forcedState=!1,g.manualState=!1}},g.onVCardChangeEvent=function(e,t,n){s.info("[contactService] onVCardChangeEvent event: "+e+" || status: "+t+" || type: "+n),f(function(){var e=g.getContactByJid(t);e&&("avatar"===n||"data"===n?g.getVCardByDbId(e.dbId,!0).then(function(){return"avatar"===n?e.getAvatar(256,!0):c.when()}).then(function(){g.sendUpdateEvent(e)}):g.sendUpdateEvent(e))},2e3,1)},g.onUserManagementEvent=function(e){try{var t=$(e).find("usersettings");if(t.length&&"update"===t.attr("action"))return s.info("[contactService] onUserManagementEvent - should update the presence"),g.sendPresenceFromConfiguration(),!0;var n=$(e).find("userpassword");if(n.length&&"update"===n.attr("action"))return s.info("[contactService] onUserManagementEvent - userPassword updated"),g.changePasswordInfo||(g.changePasswordInfo={fromThirdParty:!0}),!0;var r=$(e).find("openinvite");return r.length&&"update"===r.attr("action")&&(s.info("[contactService] onUserManagementEvent - update about openinviteid"),g.retrieveOpenInviteId()),!0}catch(e){return!0}},g.updateUserContactFullJid=function(){g.userContact.fullJid=a.fullJid,g.attachHandlers()},this.getMinimumContactByDBId=function(t){return c(function(e){e(g.createEmptyContactContact(t))})},g.createEmptyContactContact=function(e){var t=g.createBasicContact(e);return t.initials="?",t.displayName="Unknown contact",t.lastname="Unknown contact",t.firstname="",t.temp=!0,t.avatar=new Image,t.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",t},g.getContact=function(e,t){var n=e||t;return this.isUserContactJid(n)?g.userContact:this.contacts[n]},g.getOrCreateContact=function(e,t){if(!e&&!t)return c.reject(new Error("No jid or no phoneNumber"));if(this.contacts||(this.contacts=[]),n=this.getContact(e,t))return c.when(n);var n=g.createBasicContact(e,t);return e?g.getVCardByJid(e):c.when(n)},this.createBasicContact=function(e,t){s.debug("[contactService] CreateContact "+e+" "+anonymizePhoneNumber(t));var n=new u;if(!e)return n.id=t,n.initials="?",n.displayName=t||"Unknown contact",n.lastname=t||"Unknown contact",n.firstname="",n.phoneProCan=t||"",n.temp=!0,n.avatar=new Image,n.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",n.setNameUpdatePrio(u.NameUpdatePrio.NO_UPDATE_PRIO),n;var r=e;return r||(r=t,n.phoneProCan=t),r||(r="anonymous"),n.jid=e,n.id=r,n.ask="none",n.subscription="none",n.updateRichStatus(),g.contacts[n.id]=n},this.getContactByJid=function(e){var t=null;return this.isUserContactJid(e)?t=g.userContact:this.contacts?t=this.contacts[e]:this.contacts=[],t},this.getContactByEmail=function(e){var t=null;for(var n in this.contacts)this.contacts.hasOwnProperty(n)&&this.contacts[n].containsEmail(e)&&(t=this.contacts[n]);return t},this.getContacts=function(){var e=[];for(var t in this.contacts)this.contacts.hasOwnProperty(t)&&e.push(this.contacts[t]);return e},this.searchContacts=function(t){return this.getContacts().filter(function(e){return(e.roster||e.isBot)&&!e.isTerminated&&g.contactMatcher(e,t)})},this.contactMatcher=function(e,t){var n=e.firstname+" "+e.lastname,r=t.toLowerCase().trim().split(/[ ]+/),i=n.toLowerCase().trim().split(/[ ]+/);return r.every(function(n){return i.some(function(e,t){return!(!e.length||0!==e.indexOf(n))&&!(i[t]="")})})},g.getContactById=function(e){return g.dbContacts[e]},g.getContactByDBId=function(r,e){var i=g.dbContacts[r];if(!e&&i)return c.when(i);var t=g.contactPromises[r];if(t)return s.debug("[contactService] getContactByDBId for "+r+" already lauched"),t.promise;var a=c.defer();g.contactPromises[r]=a;var n=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+r;return l({method:"GET",url:n,headers:d.getRequestHeader()}).then(function(e){var t=e.data.data;s.info("[contactService] GetContactByDBId ("+r+") -- "+t.jid_im+" -- success");var n=i||g.createBasicContact(t.jid_im);n.updateFromUserData(t),n.getAvatar(),g.dbContacts[n.dbId]=n,g.jtelContacts[n.jidtel]=n,a.resolve(n),delete g.contactPromises[r]},function(e){var t=m.handleError(e);a.reject(t),delete g.contactPromises[r],s.error("[contactService] "+m.getErrorFullMessage(e,"GetContactByDBId"))}),a.promise},g.completeContactPhoneNumbers=function(e){return c(function(t,n){e.phoneNumbersInitialized?t(e):g.getContactByDBId(e.dbId,!0).then(function(e){t(e)}).catch(function(e){n(e)})})},g.getOpenInviteIdLink=function(){var e=this.userContact.getOpenInviteId(),t=r.instant("notAvailable"),n=config.webUrl.replace("web","meet");return e&&(t=n+"/"+e),t},g.retrieveOpenInviteId=function(){return c(function(n,t){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+g.userContact.dbId+"/open-invites";l({method:"GET",url:e,headers:d.getRequestHeader()}).then(function(e){var t=e.data.data;t&&t.openInviteId&&g.userContact.setOpenInviteId(t.openInviteId),t&&g.userContact.setOpenRoomId(t.roomId),n()},function(){var e="retrieveOpenInviteId failure";s.error("[contactService] "+e),t(new Error(e))})})},g.resetOpenInviteId=function(){return c(function(n,t){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+g.userContact.dbId+"/open-invites/reset";l({method:"POST",url:e,headers:d.getRequestHeader()}).then(function(e){var t=e.data.data;t&&g.userContact.setOpenRoomId(t.roomId),t&&t.openInviteId?(g.userContact.setOpenInviteId(t.openInviteId),n(t.openInviteId)):n()},function(){var e="resetOpenInviteId failure";s.error("[contactService] "+e),t(new Error(e))})})},g.unbindOpenInvite=function(){return c(function(n,r){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+g.userContact.dbId+"/open-invites/unbind";l({method:"PUT",url:e,headers:d.getRequestHeader()}).then(function(e){var t=e.data.data;t&&t.openInviteId&&t.roomId?(s.error("[contactService] An error occured, room "+t.roomId+" is still bound with openInviteId "+t.openInviteId),r()):(g.userContact.setOpenInviteId(null),s.info("[roomService] openInvite successfully unbound"),n())},function(){var e="unbindOpenInvite failure";s.error("[contactService] "+e),r(new Error(e))})})},this.getContactsByJids=function(r){return c(function(t,n){s.info("[contactService] getContactsByJids with ["+r.join()+"]");var e=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port;l({method:"POST",headers:d.getPostHeader(),url:e+"/api/rainbow/enduser/v1.0/users/jids?limit=1000",data:{jid_im:r}}).then(function(e){e.data.data.forEach(function(e){var t=g.getContactByJid(e.jid_im);t||(t=new u),t.updateFromUserData(e),g.contacts[t.id]=t,g.dbContacts[t.dbId]=t,(g.jtelContacts[t.jidtel]=t).getAvatar(),t.temp=!1}),t()},function(e){var t=m.handleError(e);n(t),s.error("[contactService] "+m.getErrorFullMessage(e,"getContactsByJids"))})})},this.getContactsByEmails=function(r){return c(function(t,n){s.info("[contactService] getContactsByEmails with ["+r.join()+"]");var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails",i=r.map(function(e){return e.toLowerCase()});l({method:"POST",headers:d.getPostHeader(),url:e,data:{loginEmail:i}}).then(function(e){var n={},r=[];e.data.data.forEach(function(e){var t=g.dbContacts[e.id];t||(t=new u,g.contacts[t.id]=t,g.dbContacts[t.dbId]=t,g.jtelContacts[t.jidtel]=t),t.updateFromUserData(e),t.getAvatar(),n[t.loginEmail]=t,r.push(t),i.splice(i.indexOf(t.loginEmail.toLowerCase()),1)}),t({contacts:n,contactsArray:r,emails:i})},function(e){var t=m.handleError(e);n(t),s.error("[contactService] "+m.getErrorFullMessage(e,"getContactsByEmails"))})})},g.getUserSettings=function(){return c(function(a){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+g.userContact.dbId+"/settings";l({method:"GET",url:e,headers:d.getRequestHeader()}).then(function(e){s.info("[contactService] GetUserSettings success");var t=e.data.data.presence||"online",n=e.data.data.activeAlarm||"relax1",r=e.data.data.activeNotif||"notif1",i=e.data.data.promptForCalendarPresence;a({presence:t,activeAlarm:n,activeNotif:r,promptForCalendarPresence:i})},function(e){s.error("[contactService] "+m.getErrorFullMessage(e,"GetUserSettings")),a({presence:"online",activeAlarm:"relax1",activeNotif:"notif1",promptForCalendarPresence:!1})})})},g.setUserSettings=function(r){return c(function(e,n){var t=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+g.userContact.dbId+"/settings";l({method:"PUT",url:t,headers:d.getRequestHeader(),data:r}).then(function(){s.info("[contactService] SetUserSettings "+JSON.stringify(r)+" -- success"),e()},function(e){var t=m.handleError(e);s.error("[contactService] "+m.getErrorFullMessage(e,"SetUserSettings")),n(t)})})},g.getVCardByDbId=function(t,i){return c(function(r,n){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+t;l({method:"GET",url:e,headers:d.getRequestHeader()}).then(function(e){var t=e.data.data,n=g.contacts[t.jid_im];n.updateFromUserData(t),n.updateRichStatus(g.isUserContactJid(t.jid_im)),i||n.getAvatar(),g.sendUpdateEvent(n),r(n)},function(e){var t=m.handleError(e);n(t),s.error("[contactService] "+m.getErrorFullMessage(e,"getVCardByDbId"))})})},g.getVCardByJid=function(i){return c(function(r,n){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/jids/"+i;l({method:"GET",url:e,headers:d.getRequestHeader()}).then(function(e){var t=e.data.data,n=g.contacts[i];n.updateFromUserData(t),n.updateRichStatus(),n.getAvatar(),g.dbContacts[n.dbId]||(g.dbContacts[n.dbId]=n,g.jtelContacts[n.jidtel]=n),g.sendUpdateEvent(n),r(n)},function(e){var t=m.handleError(e);n(t),s.error("[contactService] "+m.getErrorFullMessage(e,"getVCardByJid"))})})},g.getVCardInfoByEmail=function(n){return c(function(t){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails?format=full";l({method:"POST",url:e,headers:d.getRequestHeader(),data:{loginEmail:[n]}}).then(function(e){t(e.data.users)},function(e){s.error("[contactService] "+m.getErrorFullMessage(e,"getVCardsByEmail")),reject()})})},this.pushAvatarImage=function(e){var n=c.defer(),r=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port;s.info("[contactService] Push avatar image ");var i=g.userContact.avatar;return g.resizeImage(e,512,512).then(function(e){g.userContact.avatar=e;var t=g.getBinaryData(e);l({method:"POST",url:r+"/api/rainbow/enduser/v1.0/users/"+g.userContact.dbId+"/avatar",headers:d.getPostHeader("image/"+t.type),data:t.data,transformRequest:[]}).then(function(){n.resolve()},function(e){g.userContact.avatar=i;var t=m.handleError(e);n.reject(t),s.error("[contactService] "+m.getErrorFullMessage(e,"pushAvatarImage"))})}),n.promise},this.resizeImage=function(e,i,a){var o=c.defer(),s=new Image;return s.src=e,s.onload=function(){var e=s.width,t=s.height;t<e?i<e&&(t*=i/e,e=i):a<t&&(e*=a/t,t=a);var n=document.createElement("canvas");n.width=e,n.height=t,s.width=e,s.height=t,n.getContext("2d").drawImage(this,0,0,e,t);var r=new Image;r.src=n.toDataURL("image/png"),o.resolve(r)},o.promise},this.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}},this.sendSubscription=function(e){return"to"===e.subscribe||"both"===e.subscribe||(g.sendSubscribeInvitation(e.jid),g.sendSubscribeInvitation(e.jidtel)),c.when(e)},g.sendSubscribeInvitation=function(e){return s.info("[contactService] Send subscribe invitation to "+e),a.send($pres({to:e,type:"subscribe"}))},g.rosterChangedHandler=function(e,t){g.subscriptionPromiseQueue.add(function(){return g.rosterChangedHandlerPromise(t)})},g.rosterChangedHandlerPromise=function(i){return g.isTelJid(i.jid)?(s.debug("[contactService] Contact changed ("+i.jid+") ignored"),c.when()):c(function(t){var n=i.subscription,r=i.ask,e=i.jid;g.getOrCreateContact(e).then(function(e){"remove"===n?(e.ask="none",e.subscription="none",e.roster=!1):(e.ask=r,e.subscription=n,e.roster=!0,"both"===n&&g.updatePresence(!0)),e.updateRichStatus(),g.sendUpdateEvent(e),o.$broadcast("ON_CONTACT_ROSTER_UPDATE_EVENT"),s.info("[contactService] rosterChangedHandler - contact "+i.jid+" changed ("+r+", "+n+") success"),t()}).catch(function(e){s.error("[contactService] rosterChangedHandler - contact "+i.jid+" failure - "+e.message),t()})})},this.updateUserContact=function(e){s.info("[contactService] updateUserContact");var n=c.defer(),t=config.restServerUrl+"/api/rainbow/enduser/v1.0/";return l({method:"PUT",url:t+"users/"+d.userId,headers:d.getPostHeader(),data:e}).then(function(e){s.info("[contactService] updateUserContact successfully"),g.userContact.updateFromUserData(e.data.data),n.resolve()},function(e){var t=m.handleError(e);n.reject(t),s.error("[contactService] "+m.getErrorFullMessage(e,"updateUserContact"))}),n.promise},g.updateUserPassword=function(e,t,n){var r=c.defer();return g.changePasswordInfo={defered:r,newPassword:t},l({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+d.userId+"/change-password",headers:d.getPostHeader(),data:{oldPassword:e,newPassword:t}}).then(function(){s.info("[contactService] updateUserPasswordRequest -- success"),n||r.resolve()}).catch(function(e){s.error("[contactService] "+m.getErrorFullMessage(e,"updateUserPasswordRequest")),g.changePasswordInfo=null,r.reject(m.handleError(e))}),r.promise},this.deleteUserAccount=function(){return c(function(e,t){s.info("[contactService] deleteUserAccount"),l({method:"DELETE",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+g.userContact.dbId,headers:d.getRequestHeader()}).then(function(){s.info("[contactService] deleteUserAccount -- success"),e()}).catch(function(e){s.error("[contactService] "+m.getErrorFullMessage(e,"deleteUserAccount")),t(m.handleError(e))})})},this.isTelJid=function(e){return 0===e.indexOf("tel_")},this.getImJid=function(e){var t=a.getBareJidFromJid(e);if(this.isTelJid(t)){var n=this.jtelContacts[t];return n?n.jid:(s.warn("[contactService] -- getIMJid("+e+") -- failure -- no associated contact"),null)}return t},this.getRessourceFromJid=function(e){var t="";if(e){var n=e.indexOf("/");-1!==n&&(t=e.substr(n+1))}return t},this.isUserContactJid=function(e){return!(!g.userContact||!e||0===e.length)&&e.startsWith(g.userContact.jid)},this.isUserContact=function(e){return!(!e||!e.jid||0===e.jid.length)&&(g.userContact?e.jid.startsWith(g.userContact.jid):e.jid.startsWith(a.jid))},g.updateContactsLastActivity=function(){g.contacts&&Object.keys(g.contacts).forEach(function(e){g.contacts[e].updateLastActivityMessage()})},g.updateLastActivity=function(e){"offline"===e.status||"away"===e.status?e.lastActivityDate=e.getLastAvailableDate():e.lastActivityDate=null},this.createBotContact=function(e,t,n){var r;return r=g.contacts[e]?u.updateContactToBot(g.contacts[e],t,n):u.createBotContact(e,t,n),g.contacts[r.id]=r},this.contactPresenceChangedHandler=function(e,t){if("calendar"!==g.getRessourceFromJid(t.jid)){var n=g.getImJid(t.jid);n&&(n.startsWith("room")||g.getOrCreateContact(n).then(function(e){g.isTelJid(t.jid)?(s.info("[contactService] Update telephony presence ("+n+") : "+t.message),e.updateTelephonyStatus(t.message,g.isUserContact(e))):(s.info("[contactService] Update im presence contact ("+n+") : "+t.status+" "+t.stamp),g.isUserContact(e)&&"mode=auto"===t.message&&"online"!==e.status&&e.resources.hasOwnProperty(t.jid)&&t.jid!==e.fullJid&&"EVT_SERVICE_INITIATED"!==e.telStatus&&"EVT_ESTABLISHED"!==e.telStatus&&(g.setUserContactStatus("online","mode=auto"),f(function(){g.updatePresence(!0)},500,1,!0)),e.updateIMStatus(t,g.isUserContact(e)),g.updateLastActivity(e)),g.sendUpdateEvent(e)}))}},this.contactCalendarPresenceChangedHandler=function(e,t){t.updateCalendarPresenceInfo()},this.setUserContactStatus=function(e,t,n){try{if(s.info("[contactService] Set userContact status : "+e+(t?"("+t+")":"")),a.started)"online"===e?(g.manualState=!1,a.sendPresence(null,t,n)):(g.manualState=!0,"away"===e?a.sendPresence("away",t):"dnd"===e?a.sendPresence("dnd",t):"xa"===e&&a.sendPresence("xa",t));else if("online"===e){i.get("serviceLauncher").startServices()}}catch(e){s.error("[contactService] Set userContact status error : "+e)}},this.sendPresenceFromConfiguration=function(i){s.info("(with auth info)");var a=c.defer();return g.getUserSettings().then(function(e){var t="",n=e.presence;if("invisible"===n?n="xa":"away"===n&&(n="xa",t="away"),s.info("[contactService] sendPresenceFromConfiguration -> getUserSettings are "+n+" || message : "+t),g.userContact&&g.userContact.resources&&g.userContact.resources[g.userContact.fullJid]){var r=g.userContact.resources[g.userContact.fullJid];r&&(r.show!==n||"xa"===r.show&&r.status!==t)?(s.info("[contactService] sendPresenceFromConfiguration should update my status from "+r.show+" to "+n+" ("+t+")"),g.setUserContactStatus(n,t,i)):o.$broadcast("ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT")}else s.info("[contactService] sendPresenceFromConfiguration set initial presence "),g.setUserContactStatus(n,t,i);a.resolve()}).catch(function(){s.info("[contactService] sendPresenceFromConfiguration failure, send online"),g.setUserContactStatus("online",null,i),a.resolve()}),a.promise},g.updateUserSettings=function(e,t){var n="online";"xa"===e&&"away"===t?n="away":"dnd"===e?n="dnd":"xa"===e&&(n="invisible"),g.setUserSettings({presence:n})};var n,S=null;this.onPresentationModeChangedEvent=function(e,t){"active"===t?g.presentationModeActive=!0:"disable"===t&&(g.presentationModeActive=!1),null===S&&(s.debug("[contactService] onPresentationModeChangedEvent status:"+t+" request presence update"),S=g.presentationModeActive,g.updatePresence()),function e(){s.debug("[contactService] startUpdatePresentationModeRefreshTimer"),null!==n&&(f.cancel(n),n=null),n=f(function(){s.debug("[contactService] startUpdatePresentationModeRefreshTimer interval reach"),S!==g.presentationModeActive?(s.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - request presence update"),S=g.presentationModeActive,g.updatePresence(),e()):(s.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - no presence update needed"),S=null)},1e3,1,!0)}()},this.changeMyPresence=function(e){if(s.info("[contactService] changeMyPresence "+e+" "+g.userContact.message),("dnd"!==e||"presentation"!==g.userContact.message)&&"busy"!==e){var t="";"online"===e&&(t="mode=auto"),"away"===e&&(e="xa",t="away"),g.setUserContactStatus(e,t),"online"===e&&f(function(){g.manualState=!1,g.updatePresence()},1e3,1,!0),g.updateUserSettings(e,t)}},this.computeStatusList=function(){var e=[];return g.userContact&&g.userContact.status&&(s.info("[contactService] computeStatusList "+g.userContact.status+" "+g.userContact.message),e="offline"===g.userContact.status?["online"]:"busy"===g.userContact.status?["busy"]:"dnd"===g.userContact.status&&"presentation"===g.userContact.message?["dnd"]:["online","away","xa","dnd"]),e},this.resetBusyState=function(){s.info("[contactService] resetBusyState"),g.setBusyState(null,null,!0),g.sendPresenceFromConfiguration()},this.setBusyState=function(e,t,n){s.info("[contactService] setBusyState -- "+e+" -- "+t),g.busyState={status:e,message:t},n||g.updatePresence()},o.$on("$destroy",o.$on("ON_PRESENTATION_MODE_CHANGED_EVENT",g.onPresentationModeChangedEvent)),this.updatePresence=function(e){s.info("[contactService] updatePresence"),g.manualState?(s.info("[contactService] updatePresence manualState"),"away"===g.userContact.status&&g.busyState&&"dnd"===g.busyState.status&&(g.setUserContactStatus("online","mode=auto"),f(function(){g.updatePresence()},1e3,1,!0))):!g.presentationModeActive||g.busyState&&g.busyState.status?g.busyState&&"dnd"===g.busyState.status?(s.info("[contactService] updatePresence dnd "+g.busyState.message),a.sendPresence("dnd",g.busyState.message)):g.awayStateActive?(s.info("[contactService] updatePresence away"),a.sendPresence("away","")):g.userContact&&"online"!==g.userContact.status?(s.info("[contactService] updatePresence online"),g.setUserContactStatus("online")):e&&g.userContact&&"online"===g.userContact.status&&(s.info("[contactService] updatePresence forced online"),g.setUserContactStatus("online")):(s.info("[contactService] updatePresence dnd presentation"),a.sendPresence("dnd","presentation"))},this.removeContact=function(n){return c(function(e,t){if(!n)return s.error("[contactService] removeContact : missing contact !"),void t();s.info("[contactService] removeContact : "+n.displayNameForLog()),g.removeContactFromRoster(n.dbId).then(function(){s.info("[contactService] removeContact : "+n.displayNameForLog()+" success"),e()}).catch(function(e){s.error("[contactService] removeContact: "+n.displayNameForLog()+" failure : "+e.message),t(e)})})},this.removeContactFromRoster=function(r){return c(function(e,n){if(!r)return s.error("[contactService] removeContactFromRoster : missing id !"),void n();s.info("[contactService] removeContactFromRoster for id "+r);var t=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/networks/"+r;l({method:"DELETE",url:t,headers:d.getRequestHeader()}).then(function(){s.info("[contactService] removeContactFromRoster success for id "+r),e()},function(e){var t="removeContactFromRoster failure: no server response";e&&(t="removeContactFromRoster failure: "+JSON.stringify(e)),s.error("[contactService] "+t),n(new Error(t))})})},this.sendUpdateEvent=function(e){var t=g.isUserContact(e)?"ON_USER_CONTACT_UPDATED_EVENT":"ON_CONTACT_UPDATED_EVENT";o.$broadcast(t,e)},this.myMobileAvailable=function(){return g.userContact?g.userContact.mobileResource:null}}]),function(){"use strict";angular.module("rainbow").service("botService",["$http","$q","$log","authService","contactService","conversationService",function(e,t,a,r,i,o){var s=this;s.init=function(){s.bots=[],s.emily=null,this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/"},s.start=function(r){a.info("[botService] === STARTING ===");var i=performance.now();return t(function(t,n){s.init(),s.getBots().then(function(){a.info(""),s.findEmily(),s.unlockWaitingConversations();var e=Math.round(performance.now()-i);r.push({service:"botService",startDuration:e}),a.info("[botService] === STARTED ("+e+" ms) ==="),a.info(""),t()}).catch(function(e){a.info("[botService] === STARTING FAILURE === "+e.message),n()})})},s.stop=function(){a.info("[botService] === STOPPED ===")},s.getBots=function(){return t(function(t,n){e({method:"GET",url:s.portalURL+"bots",headers:r.getRequestHeader()}).then(function(e){a.info("[botService] getBots success"),s.bots=e.data.data,t(s.bots)}).catch(function(e){var t="getBots failure "+e.data.errorDetails+" with status "+e.status;a.error("[botService] "+t),n(new Error(t))})})},s.findEmily=function(){s.bots.forEach(function(e){"Emily"===e.name&&(s.emily=e,a.info("[botService] Emily is found"),i.createBotContact(s.emily.jid,s.emily.name,s.emily.id))})},s.getEmily=function(){return s.emily},s.openConversationWithEmily=function(){return t(function(t,e){a.info("[botService] openConversationWithEmily");var n=i.getContactByJid(s.emily.jid);o.getOrCreateOneToOneConversation(n.jid).then(function(e){o.setActiveConversation(e),t(e)}).catch(function(){a.error("[botService] openConversationWithEmily failure"),e()})})},s.unlockWaitingConversations=function(){o.unlockWaitingBotConversations(!0)}}])}(),angular.module("rainbow").service("conversationService",["$q","$log","$rootScope","$http","$interval","xmppService","authService","contactService","Conversation","Call","fileTransfertService","videoService","telephonyService","roomService","settingsService","ConversationServiceEventHandler","ConversationServiceHistoryHandler","utilService","profileService","PromiseQueue","SearchTextConvResultsFactory","pstnConferenceService","webrtcGatewayService",function(m,g,S,i,t,s,a,C,E,b,e,R,y,T,o,n,r,c,l,d,u,f,h){"use strict";var I=this;this.started=!1;I.start=function(t){g.info(""),g.info("[conversationService] === STARTING ===");var n=m.defer(),r=performance.now();return this.pendingMessages={},this.activeConversation=null,this.conversations=[],this.inCallConversations=[],this.idleConversations=[],this.involvedContactIds=[],this.promiseQueue=d.create(),this.searchTextResults=u(),this.waitingBotConversations=[],this.botServiceReady=!1,this.isBasicCallAllowed=l.isFeatureEnabled(l.FeaturesEnum.TELEPHONY_BASIC_CALL),this.isSecondCallAllowed=l.isFeatureEnabled(l.FeaturesEnum.TELEPHONY_SECOND_CALL),this.attachHandlers(),I.getServerConversations().then(function(){I.started=!0,I.linkAllActiveCallsToConversations();var e=Math.round(performance.now()-r);t.push({service:"conversationService",startDuration:e}),g.info("[conversationService] === STARTED ("+e+" ms) ==="),n.resolve()}).catch(function(e){g.info("[conversationService] === STARTING FAILURE === "+e.message),n.reject(e)}),this.contactUpdateEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event ON_CONTACT_UPDATED_EVENT, rehandle it"),this.contactUpdateEventHandlerCleaner()),this.contactUpdateEventHandlerCleaner=S.$on("ON_CONTACT_UPDATED_EVENT",this.onContactChangedEvent),this.roomUpdateEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event "+T.ROOM_UPDATE_EVENT+", rehandle it"),this.roomUpdateEventHandlerCleaner()),this.roomUpdateEventHandlerCleaner=S.$on(T.ROOM_UPDATE_EVENT,this.onRoomChangedEvent),this.roomAddConferenceEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event "+T.ROOM_ADD_CONF_ENDPOINT_EVENT+", rehandle it"),this.roomAddConferenceEventHandlerCleaner()),this.roomAddConferenceEventHandlerCleaner=S.$on(T.ROOM_ADD_CONF_ENDPOINT_EVENT,this.onRoomAddConferenceEvent),this.roomHistoryUpdateEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event "+T.ROOM_HISTORY_UPDATE_EVENT+", rehandle it"),this.roomHistoryUpdateEventHandlerCleaner()),this.roomHistoryUpdateEventHandlerCleaner=S.$on(T.ROOM_HISTORY_UPDATE_EVENT,this.onRoomHistoryChangedEvent),this.roomAdminMessageEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event "+T.ROOM_ADMIN_MESSAGE_EVENT+", rehandle it"),this.roomAdminMessageEventHandlerCleaner()),this.roomAdminMessageEventHandlerCleaner=S.$on(T.ROOM_ADMIN_MESSAGE_EVENT,this.onRoomAdminMessageEvent),this.callUpdateEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event ON_CALL_UPDATED_EVENT, rehandle it"),this.callUpdateEventHandlerCleaner()),this.callUpdateEventHandlerCleaner=S.$on("ON_CALL_UPDATED_EVENT",this.onCallEvent),this.conversationUpdateEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event ON_CONVERSATIONS_UPDATED_EVENT, rehandle it"),this.conversationUpdateEventHandlerCleaner()),this.conversationUpdateEventHandlerCleaner=S.$on("ON_CONVERSATIONS_UPDATED_EVENT",this.onConversationEvent),this.capacityUpdateEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event ON_UPDATE_MYCONTACT_EVENT, rehandle it"),this.capacityUpdateEventHandlerCleaner()),this.capacityUpdateEventHandlerCleaner=S.$on("ON_UPDATE_MYCONTACT_EVENT",this.onMyContactChangedEvent),this.telephonyStateEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event ON_TELEPHONY_STATUS_CHANGED_EVENT, rehandle it"),this.telephonyStateEventHandlerCleaner()),this.telephonyStateEventHandlerCleaner=S.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",this.onTelephonyStateChangeEvent),this.conferenceStateEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event ON_CONFERENCE_STATE_EVENT, rehandle it"),this.conferenceStateEventHandlerCleaner()),this.conferenceStateEventHandlerCleaner=S.$on("ON_CONFERENCE_STATE_EVENT",this.onConferenceStateChangeEvent),this.conferenceParticipantsEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event ON_CONFERENCE_PARTICIPANT_EVENT, rehandle it"),this.conferenceParticipantsEventHandlerCleaner()),this.conferenceParticipantsEventHandlerCleaner=S.$on("ON_CONFERENCE_PARTICIPANT_EVENT",this.onConferenceParticipantChangeEvent),this.reloadCapabilitiesForMyContactEventHandlerCleaner&&(g.warn("[conversationService] already subscribed to event ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT, rehandle it"),this.reloadCapabilitiesForMyContactEventHandlerCleaner()),this.reloadCapabilitiesForMyContactEventHandlerCleaner=S.$on("ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT",this.onReloadCapabilitiesForMyContactEvent),n.promise},this.attachHandlers=function(){this.removeHandlers(),g.info("[conversationService] attachHandlers"),this.conversationHistoryHandler=r.create(this),this.conversationServiceEventHandler=n.create(this),s.addHistoryHandler(function(e){return I.conversationHistoryHandler.onHistoryMessageReceived(e)}),s.addSearchTextHandler(function(e,t){if(g.info("[conversationService] addSearchTextHandler"),I.searchTextResults.isCurrentQuery(e)){g.info("[conversationService] searchText: queryId are matching");var n=I.conversationHistoryHandler.onSearchTextMessageReceived(t);n&&(g.info("[conversationService] searchText: save item result"),I.searchTextResults.addNewItemResult(n.otherJid,n))}else g.info("[conversationService] searchText: queryId are NOT matching : "+e)}),e.addFileTransfertHandler(function(e){I.conversationServiceEventHandler.onFileTransfertReceived(e)}),this.messageHandlerRef||(this.messageHandlerRef=s.addHandler(function(e){return I.conversationServiceEventHandler.onChatMessageReceived(e),!0},null,"message","chat")),this.messageMucHandlerRef||(this.messageMucHandlerRef=s.addHandler(function(e){return I.conversationServiceEventHandler.onChatMessageReceived(e),!0},null,"message","groupchat")),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=s.addHandler(function(e){return I.conversationServiceEventHandler.onFileMessageReceived(e),!0},null,"message","file")),this.webrtcMessageHandlerRef||(this.webrtcMessageHandlerRef=s.addHandler(function(e){return I.conversationServiceEventHandler.onWebRTCMessageReceived(e),!0},null,"message","webrtc")),this.convMessageHandlerRef||(this.convMessageHandlerRef=s.addHandler(function(e){return I.conversationServiceEventHandler.onManagementMessageReceived(e),!0},null,"message","management")),this.receiptMessageHandlerRef||(this.receiptMessageHandlerRef=s.addHandler(function(e){return I.conversationServiceEventHandler.onReceiptMessageReceived(e),!0},null,"message"))},this.removeHandlers=function(){g.info("[conversationService] removeHandlers "),this.conversationHistoryHandler&&(this.conversationHistoryHandler=null),this.conversationServiceEventHandler&&(this.conversationServiceEventHandler=null),this.messageHandlerRef&&(s.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(s.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(s.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.convMessageHandlerRef&&(s.deleteHandler(this.convMessageHandlerRef),this.convMessageHandlerRef=null),this.receiptMessageHandlerRef&&(s.deleteHandler(this.receiptMessageHandlerRef),this.receiptMessageHandlerRef=null),this.messageMucHandlerRef&&(s.deleteHandler(this.messageMucHandlerRef),this.messageMucHandlerRef=null),this.recordingMessageHandlerRef&&(s.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null)},I.stop=function(){return g.info("[conversationService] === STOPPING ==="),this.conversations=null,this.messageHandlerRef&&(s.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(s.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(s.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.recordingMessageHandlerRef&&(s.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.contactUpdateEventHandlerCleaner&&(this.contactUpdateEventHandlerCleaner(),this.contactUpdateEventHandlerCleaner=null),this.roomUpdateEventHandlerCleaner&&(this.roomUpdateEventHandlerCleaner(),this.roomUpdateEventHandlerCleaner=null),this.roomAddConferenceEventHandlerCleaner&&(this.roomAddConferenceEventHandlerCleaner(),this.roomAddConferenceEventHandlerCleaner=null),this.roomAdminMessageEventHandlerCleaner&&(this.roomAdminMessageEventHandlerCleaner(),this.roomAdminMessageEventHandlerCleaner=null),this.callUpdateEventHandlerCleaner&&(this.callUpdateEventHandlerCleaner(),this.callUpdateEventHandlerCleaner=null),this.conversationUpdateEventHandlerCleaner&&(this.conversationUpdateEventHandlerCleaner(),this.conversationUpdateEventHandlerCleaner=null),this.capacityUpdateEventHandlerCleaner&&(this.capacityUpdateEventHandlerCleaner(),this.capacityUpdateEventHandlerCleaner=null),this.telephonyStateEventHandlerCleaner&&(this.telephonyStateEventHandlerCleaner(),this.telephonyStateEventHandlerCleaner=null),this.started=!1,g.info("[conversationService] === STOPPED ==="),m.when()},I.getServerConversations=function(){var n=m.defer();return i({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+C.userContact.dbId+"/conversations",headers:a.getRequestHeader()}).then(function(e){var i=[];e.data.data.forEach(function(e){var t=parseInt(e.unreadMessageNumber,10),n=null,r=!0===e.mute;n="user"===e.type?I.getOrCreateOneToOneConversation(e.jid_im,e.id,e.lastMessageDate,e.lastMessageText,t,r,e.creationDate):I.getRoomConversation(e.jid_im,e.id,e.lastMessageDate,e.lastMessageText,t,!0,r,e.creationDate,e.lastMessageSender,e.topic,e.type),i.push(n)}),m.all(i).then(function(){return I.removeOlderConversations()}).then(function(){I.orderConversations(),n.resolve()}).catch(function(e){var t="getServerConversations failure: "+e.message;g.error("[conversationService] "+t),n.reject(new Error(t))})},function(e){var t="getServerConversations failure: no server response";e&&(t="getServerConversations failure: "+JSON.stringify(e)),g.error("[conversationService] "+t),n.reject(new Error(t))}),n.promise},this.createServerConversation=function(t){var n=m.defer();if(t.dbId)return m.when(t);var e={};if(t.type===E.Type.ONE_TO_ONE){if(!t.contact.dbId)return m.when(t);e.peerId=t.contact.dbId,e.type="user"}else if(t.type===E.Type.BOT){if(t.type=E.Type.ONE_TO_ONE,!t.contact.dbId)return m.when(t);e.peerId=t.contact.dbId,e.type="bot"}else e.peerId=t.room.dbId,e.type="room";if(t.room&&t.room.avatar)var r=t.room.avatar;return i({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+C.userContact.dbId+"/conversations",headers:a.getRequestHeader(),data:e}).then(function(e){g.info("[conversationService] createServerConversation success: "+t.id),t.dbId=e.data.data.id,t.lastModification=e.data.data.lastMessageDate?new Date(e.data.data.lastMessageDate):void 0,t.creationDate=e.data.data.creationDate?new Date(e.data.data.creationDate):new Date,t.missedCounter=e.data.data.unreadMessageNumber&&parseInt(e.data.data.unreadMessageNumber)||0,r&&(t.room.avatar=r),I.orderConversations(),n.resolve(t)},function(e){var t="createServerConversation failure: "+e.data.errorDetails;g.warn("[conversationService] "+t),n.reject(new Error(t))}),n.promise},this.deleteServerConversation=function(n){var r=m.defer();return n?(i({method:"DELETE",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+C.userContact.dbId+"/conversations/"+n,headers:a.getRequestHeader()}).then(function(){g.info("[conversationService] deleteServerConversation success: "+n),I.orderConversations(),r.resolve()},function(e){if(404002===e.data.errorDetailsCode)g.info("[conversationService] deleteServerConversation success: "+n),r.resolve();else{var t="deleteServerConversation failure: "+e.data.errorDetails;g.warn("[conversationService] "+t),r.reject(new Error(t))}}),r.promise):m.when()},this.updateServerConversation=function(e,t){var n=m.defer();return e?(i({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+C.userContact.dbId+"/conversations/"+e,headers:a.getPostHeader(),data:{mute:t}}).then(function(){g.info("[conversationService] updateServerConversation success: "+e),n.resolve()},function(e){var t="updateServerConversation failure: "+e.data.errorDetails;g.warn("[conversationService] "+t),n.reject(new Error(t))}),n.promise):m.when()},this.ackAllMessages=function(r){return m(function(e,n){if(!r)return g.error("[conversationService] ackAllMessages for conversation error -- missing conversation id"),void n();var t=I.getConversationByDbId(r);if(!t)return g.error("[conversationService] ackAllMessages for conversation error -- can not find conversation"),void n();g.info("[conversationService] ackAllMessages for conversation "+r),t.ackReadAllMessages(),i({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+C.userContact.dbId+"/conversations/"+r+"/markallread",headers:a.getPostHeader()}).then(function(){g.info("[conversationService] ackAllMessages success: "+r),e()},function(e){var t="ackAllMessages failure: "+e.data.errorDetails;g.warn("[conversationService] "+t),n(new Error(t))})})},this.getOrCreateOneToOneConversation=function(n,r,i,a,o,s,c){g.info("[conversationService] getOrCreateOneToOneConversation "+n+" "+r+" "+o);var e=I.getConversationById(n);if(e)return e.preload=!0,m.when(e);var l=m.defer();return C.getOrCreateContact(n).then(function(e){var t=E.createOneToOneConversation(e);return t.lastModification=i?new Date(i):void 0,t.lastMessageText=a,t.muted=s,t.creationDate=c?new Date(c):new Date,t.preload=!1,I.computeCapabilitiesForContact(e),t.dbId=r,o&&(t.missedCounter=o),I.conversations[e.id]=t,I.createServerConversation(t)}).then(function(e){S.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e,E.EventType.NEW),l.resolve(e)}).catch(function(e){var t="getOrCreateOneToOneConversation "+n+" failure "+e.message;g.error("[conversationService] "+t),l.resolve(new Error(t))}),l.promise},this.getRoomConversation=function(i,a,o,s,c,l,d,u,f,h,p){g.info("[conversationService] getRoomConversation "+i);var v=I.getConversationById(i);return v?(v.preload=!0,m.when(v)):m(function(n,r){var t=T.getRoomByJid(i);if(t)(v=E.createRoomConversation(t)).dbId=a,v.lastModification=o?new Date(o):void 0,v.lastMessageText=s,v.muted=d,v.creationDate=u?new Date(u):new Date,v.preload=!1,v.lastMessageSender=f,v.room&&h&&(v.room.desc=h),c&&(v.missedCounter=c),I.conversations[v.id]=v,a?I.getRoomConferences(v).then(function(){S.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",v,E.EventType.NEW),n(v)}):I.createServerConversation(v).then(function(e){t&&"unsubscribed"!==t.status&&T.sendInitialRoomPresence(t),S.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e,E.EventType.NEW),n(e)}).catch(function(e){var t="getRoomConversation ("+i+") failure : "+e.message;g.error("[conversationService] "+t),I.deleteServerConversation(a),l?n():r(new Error(t))});else{"bot"!==p&&g.error("[conversationService] getRoomConversation ("+i+") failure : no such room");var e={jid:i,conversationDbId:a,lastModification:o,lastMessageText:s,missedIMCounter:c,muted:d,creationDate:u};I.waitingBotConversations.push(e),I.unlockWaitingBotConversations(),n()}})},I.getRoomConferences=function(n){return m(function(e){var t=n.room.confEndpoints;t&&t.forEach(function(e){if("pstnAudio"===e.mediaType){var t=f.getConferenceSessionById(e.confEndpointId);t&&(n.pstnConferenceSession=t)}}),e()})},I.updateRoomConferences=function(){I.getConversations().forEach(function(e){if(e.room&&e.room.confEndpoints){var t=f.getConferenceSessionById(e.room.getPstnConfEndpointId());e.pstnConferenceSession=t||null}else e.pstnConferenceSession=null})},this.closeConversation=function(n){return m(function(e,t){g.info("[conversationService] closeConversation "+n.id),I.deleteServerConversation(n.dbId).then(function(){I.removeConversation(n),e()}).catch(function(e){t(e)})})},this.removeConversation=function(e){if(g.info("[conversationService] remove conversation "+e.id),e.videoCall&&e.videoCall.status!==b.Status.UNKNOWN)g.info("[conversationService] Ignore conversation deletion message for conversation"+e.id);else{delete I.conversations[e.id],I.orderConversations();var t=I.getOrderedConversations();!I.activeConversation||0<=t.idle.indexOf(I.activeConversation)||(0<t.idle.length?I.setActiveConversation(t.idle.first()):0<t.inCall.length?I.setActiveConversation(t.inCall.first()):I.setActiveConversation(null)),e.contact&&(e.contact.conversation=null,e.contact=null),S.$broadcast("ON_CONVERSATION_REMOVE_EVENT",e)}},this.getConversationByDbId=function(e){if(I.conversations)for(var t in I.conversations)if(I.conversations.hasOwnProperty(t)&&I.conversations[t].dbId===e)return I.conversations[t];return null},this.getConversationByRoomDbId=function(e){if(I.conversations)for(var t in I.conversations)if(I.conversations.hasOwnProperty(t)&&I.conversations[t].room&&I.conversations[t].room.dbId===e)return I.conversations[t];return null},this.removeOlderConversations=function(){var e=parseInt(o.getSetting("nbMaxConversations")),t=I.getConversations().sort(I.sortFunction);if(t.length>e){g.info("[conversationService] remove older conversations");for(var n=[],r=e;r<t.length;r++)n.push(I.closeConversation(t[r]));return m.all(n)}return m.when()},this.searchConversations=function(e){var t=c.removeDiacritis(e.toLowerCase()).trim().split(/[ ]+/);return I.getOrderedConversations().idle.filter(function(e){var n=e.filterName.trim().split(/[ ]+/);return t.every(function(t){return n.some(function(e){return!(!e.length||0!==e.indexOf(t))})})})},this.sendFSMessage=function(t,e,n){var r=m.defer();return n&&0!==n.length||(n=e.name),t.sendFSMessage(e,n).then(function(e){I.pendingMessages[e.id]={conversation:t,message:e},r.resolve(e)},function(e){var t=e.translatedMessage?e.translatedMessage:"Unable to share file";S.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"fileTransfer",popupBodyTranslated:t,okLabel:"ok"}),r.reject(e)}),r.promise},this.sendEFSMessage=function(e,t,n){var r=e.sendEFSMessage(t,n);return this.pendingMessages[r.id]={conversation:e,message:r},S.$broadcast("ON_SEND_EFS_MESSAGE",t),r},this.sendChatMessage=function(e,t){var n=e.sendChatMessage(t);return this.pendingMessages[n.id]={conversation:e,message:n},n},this.sendIsTypingState=function(e,t){e.sendIsTypingState(t)},this.sendRecordingMessage=function(e,t){var n=e.sendRecordingMessage(t);return this.pendingMessages[n.id]={conversation:e,message:n},n},this.removeAllMessages=function(e){g.info("[conversationService] removeAllMessage "+e.id);var t=m.defer(),n={queryid:s.connection.getUniqueId(),with:e.id,onComplete:function(){t.resolve()}},r=s.connection.getUniqueId();return s.connection.mam.delete(r,n),t.promise},this.removeMessagesFromConversation=function(e,t,n){g.info("[conversationService] removeMessagesFromConversation "+e.id),g.info("[conversationService] removing "+n+" messages after "+t);var r=m.defer(),i={queryid:"remove_"+e.id,with:e.id,start:moment(t).format("YYYY-MM-DDTHH:mm:ss.SSSSSSZ"),max:n,onComplete:function(){g.info("[conversationService] MAM Message deleted !!!"),r.resolve()}};return s.connection.mam.delete(e.id,i),r.promise},this.sendConversationByEmail=function(e){var n=m.defer(),t=C.userContact,r=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+t.dbId+"/conversations/"+e.dbId+"/downloads";return i({method:"POST",url:r,headers:a.getRequestHeader(),data:{}}).then(function(){g.error("[conversationService] sendConversationByEmail - success"),n.resolve()},function(e){var t={message:"Impossible to download conversation"};e&&e.data&&409011===e.data.errorDetailsCode&&(t.message="No messages to export for the last 30 days.",t.messageKey="noMessagesToExport"),g.error("[adminUserService] sendConversationByEmail - "+t.message),n.reject(t)}),n.promise},this.getHistoryPage=function(e,t){return I.conversationHistoryHandler.getHistoryPage(e,t)},this.getHistoryPageAroundMsg=function(e,t){return I.conversationHistoryHandler.getHistoryPageAroundMsg(e,20,t+"000")},this.clearSearchText=function(){g.debug("[conversationService] - clearSearchText"),this.searchTextResults.clearAll()},this.clearAndGetAllMessagesResults=function(t,e){g.debug("[conversationService] - clearAndGetAllMessagesResults"),this.searchTextResults.clearAll(),this.searchTextResults.searchCount();var n=[];e.forEach(function(e){(!e.desc||e.desc&&!e.desc.startsWith("Rainbow_OutlookCreation_InternalUseOnly"))&&n.push(I.searchTextInRoom(C.userContact.jid,e,t,5,I.searchTextResults.searchCounter))}),m.all(n).finally(function(){g.debug("[conversationService] - ALL SearchText Promises finished"),I.searchTextInConversations(t,100)})},this.searchTextInConversations=function(n,e){g.debug("[conversationService] - searchTextInConversations: "+n);var r=m.defer(),t=s.connection.getUniqueId();return this.searchTextResults.queryIds.push(t),this.searchTextResults.searchedText=n,g.debug("[conversationService] - searchTextResults QueryId: "+t),I.conversationHistoryHandler.searchTextInConversations(t,n,e).then(function(e){I.searchTextResults.totalCount+=parseInt(e,10),I.searchTextResults.results.forEach(function(t){t.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1}),t.isRoom()||I.getConversationTextCount(n,t.otherJid).then(function(e){t.totalCount=parseInt(e,10)}),r.resolve(parseInt(e,10))})}).catch(function(e){g.warn("[conversationService] - searchTextInConversations: Error "+e.message),r.reject(e)}),r.promise},this.searchTextResultsInConversation=function(e,n){g.debug("[conversationService] - searchTextResultsInConversation: "+e);var r=m.defer(),t=s.connection.getUniqueId();return this.searchTextResults.clearAll(),this.searchTextResults.queryIds.push(t),n.room?I.searchTextInRoom(C.userContact.jid,n.room,e,5,this.searchTextResults.searchCounter).then(function(e){var t=I.searchTextResults.createNewResult(n.id);t.totalCount=parseInt(e,10),t.conversation=n,I.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),r.resolve(parseInt(e,10))}):I.conversationHistoryHandler.searchTextResultsInConversation(t,e,n.id,5).then(function(e){var t=I.searchTextResults.createNewResult(n.id);t.totalCount=parseInt(e,10),t.conversation=n,I.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),r.resolve(parseInt(e,10))}),r.promise},this.searchTextMoreResultsInConversation=function(e,t,n){g.debug("[conversationService] - searchTextMoreResultsInConversation: "+e);var r=m.defer(),i=s.connection.getUniqueId();return this.searchTextResults.queryIds.push(i),t.room?I.conversationHistoryHandler.searchTextMoreResultsInRoom(i,e,C.userContact.jid,t.room.jid,n+"000",5).then(function(e){I.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),r.resolve(parseInt(e,10))}):I.conversationHistoryHandler.searchTextMoreResultsInConversation(i,e,t.id,n+"000",5).then(function(e){I.searchTextResults.results.forEach(function(e){e.convRes.sort(function(e,t){return e.date?t.date?moment(e.date).diff(moment(t.date)):1:-1})}),r.resolve(parseInt(e,10))}),r.promise},this.getConversationTextCount=function(e,t){g.debug("[conversationService] - getConversationTextCount: "+e);var n=s.connection.getUniqueId();return this.searchTextResults.queryIds.push(n),I.conversationHistoryHandler.getConversationTextCount(n,e,t)},this.searchTextInRoom=function(e,t,n,r,i){return g.debug("[conversationService] - searchTextInRoom: "+n),I.searchTextInRoomConversation(e,t.jid,n,r,i)},this.searchTextInRoomConversation=function(e,n,t,r,i){if(g.debug("[conversationService] - searchTextInRoomConversation: "+t),this.searchTextResults.searchCounter===i){var a=m.defer(),o=s.connection.getUniqueId();return this.searchTextResults.queryIds.push(o),I.conversationHistoryHandler.searchTextInRoom(o,e,n,t,r).then(function(t){g.info("[conversationService] - searchTextInRoomConversation: Room response received : "+t),I.searchTextResults.totalCount+=parseInt(t,10),I.searchTextResults.results.forEach(function(e){e.otherJid===n&&(e.totalCount=parseInt(t,10))}),a.resolve(t)}).catch(function(e){g.warn("[conversationService] - searchTextInRoomConversation: Error "+e.message),a.reject(e)}),a.promise}g.debug("[conversationService] - counter has changed - skip promise")},this.setActiveConversation=function(e){return g.debug("[conversationService] - setActiveConversation: "+(e?e.id:"null")),this.activeConversation=e,this.activeConversation},this.setMostRecentConversationActive=function(){var e=I.getConversations().sort(I.sortFunction);return 0<e.length?this.setActiveConversation(e.first()):this.setActiveConversation(null)},this.getActiveConversation=function(){return this.activeConversation},this.getConversationById=function(e){return I.conversations?I.conversations[e]:null},this.getConversations=function(){var e=[];for(var t in I.conversations)I.conversations.hasOwnProperty(t)&&e.push(I.conversations[t]);return e},this.orderConversations=function(){I.inCallConversations=[],I.idleConversations=[],I.involvedContactIds=[],Object.keys(I.conversations).forEach(function(e){var t=I.conversations[e];if(t.isInCall())I.inCallConversations.push(t);else if(I.idleConversations.push(t),t.type===E.Type.ROOM&&t.room.owner&&t.room.isMeetingRoom()&&!t.room.conference.scheduled){var n=f.getConferenceSessionById(t.room.getPstnConfEndpointId());n&&n.isActive()&&I.idleConversations.pop()}t.type===E.Type.ONE_TO_ONE&&I.involvedContactIds.push(t.contact.id)}),I.idleConversations.sort(I.sortFunction)},this.getOrderedConversations=function(){return{inCall:I.inCallConversations,idle:I.idleConversations,contactIds:I.involvedContactIds}},this.sortFunction=function(e,t){var n=e.lastModification,r=e.creationDate,i=t.lastModification,a=t.creationDate;return(!i&&a?a:i)-(!n&&r?r:n)},this.formatDate=function(e){return moment(e).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z"},this.resetConversationMissedCounters=function(e){S.appVisible&&(e.missedCounter=0,e.missedCalls=0,this.updateMissedCounters())},this.decreaseMissedIMCounterForConversation=function(e){0<e.missedCounter&&(e.missedCounter-=1),this.updateMissedCounters()};var p=0,v=0;this.updateMissedCounters=function(){var n=0,r=[];Object.keys(I.conversations).forEach(function(e){var t=I.conversations[e];0!==t.missedCounter&&(n+=t.missedCounter,r.push(t))}),n===p&&0===v||(p=n,v=0,S.$broadcast("ON_MISSED_COUNTER_CHANGED_EVENT",{missedIMCounter:n,missedCallCounter:0,missedIMDetails:r}))},this.dropConversationCall=function(e){e.audioCall&&y.releaseCall(e.audioCall),e.videoCall&&(R.attachLocalMediaStream(!1),R.attachDistantMediaStream(!1),R.releaseCall(e.videoCall))},this.holdConversationCall=function(e){e.audioCall&&(y.holdCall(e.audioCall),e.videoCall&&(R.attachLocalMediaStream(!1),R.attachDistantMediaStream(!1),R.releaseCall(e.videoCall)))},this.retrieveConversationCall=function(e){e.audioCall&&y.retrieveCall(e.audioCall),e.videoCall&&g.error("Not implemented for the moment")},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.updateConversationCall=function(e,t){t.type===b.Type.WEBRTC?e.videoCall=t:t.type===b.Type.PHONE&&(e.audioCall=t),t.setConversationId(e.id),this.computeCapabilitiesForContact(e.contact),I.computeCapabilitiesForMyContact()},this.computeCapabilitiesForContact=function(e,t){var n=!1,r=!1,i=!1,a=!1,o=!1,s=e.status,c=e.fullJid,l=C.userContact;if(e.jid!==l.jid){var d=e.company&&C.userContact.company&&"Rainbow"!==e.company.name&&"Default"!==e.company.name&&e.company.name===C.userContact.company.name,u=this.getConversationById(e.id);if(R.started){var f=u?u.videoCall:null;f&&f.status!==b.Status.UNKNOWN||!("unknown"===s&&d||"online"===s||"online-mobile"===s||"away"===s||"busy"===s&&"audioPhone"===e.message)||(i=r=!0)}if(y.started){var h=e.phonePro||e.phonePbx&&e.pbxId||e.mobilePro||e.phonePerso||e.mobilePerso,p=y.getActiveCallsForContact(e);0===p.length&&h&&(n=!0),(0!==p.length||R.getMediaPillarAudioCall())&&c&&(o=!0)}"online"!==s&&"busy"!==s&&"away"!==s&&"dnd"!==s||(a=!0);var v={telephony:n,webRTC:r,sharedDesktop:i,fileTransfert:a,mediaAvailable:n||r,addMedia:o};(e.isBot||e.displayName&&-1!==e.displayName.indexOf("E-HELPER"))&&(v={telephony:!1,webRTC:!1,sharedDesktop:!1,fileTransfert:!1,mediaAvailable:!1,addMedia:!1}),e.capabilities=v,u&&(u.capabilities=v,t||S.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",u,E.EventType.CAPABILITIES)),g.info('[conversationService] update capabilities for contact "'+e.displayNameForLog()+'" capabilities (tel:'+n+", webRTC:"+r+", sharing: "+i+", addMedia: "+o+")")}else this.computeCapabilitiesForMyContact()},this.computeCapabilitiesForMyContact=function(){var e=!1,t=!1,n=!1,r=C.userContact;if(R.started){var i=R.isUserContactInCall();i||"busy"===r.status&&("busy"!==r.status||"audioPhone"!==r.message)||(t=!0,I.allowDesktopSharing()&&(n=!0)),i&&R.getMediaPillarAudioCall()&&!R.getCurrentSharingCall()&&I.allowDesktopSharing()&&(n=!0)}if(y.started){var a=y.getCalls();(0===a.length&&I.isBasicCallAllowed||1===a.length&&I.isSecondCallAllowed)&&(e=!0)}var o={telephony:e,webRTC:t,sharedDesktop:n,mediaAvailable:e||t};r.capabilities=o,g.info("[conversationService] update capabilities for my contact : capabilities (tel:"+e+", webRTC:"+t+", sharing: "+n+")")},this.onCallEvent=function(e,t){switch(t.type){case b.Type.WEBRTC:if(h.isMediaPillarJid(t.fullJid))return;I.getOrCreateOneToOneConversation(t.contact.id).then(function(e){I.updateConversationCall(e,t),I.orderConversations(),S.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:e,call:t})});break;case b.Type.PHONE:if(t.status===b.Status.UNKNOWN&&t.contact&&R.endAllCallsForContact(t.contact),h.isMediaPillarCallSituation(t)){if(!t.isSecondary)return;if(t.status===b.Status.RINGING_INCOMMING)return}if(t.status!==b.Status.UNKNOWN&&null!==t.connectionId)if(g.info("[ConversationService] onCallEvent -- "+t.connectionId+"  -- relevantEquipmentId : "+t.relevantEquipmentId),b.getDeviceIdFromConnectionId(t.connectionId)!==t.relevantEquipmentId&&t.status!==b.Status.ACTIVE)return;S.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:t})}},this.onReloadCapabilitiesForMyContactEvent=function(e){g.info("[conversationService] onReloadCapabilitiesForMyContactEvent"),I.computeCapabilitiesForMyContact()},this.onConversationEvent=function(){I.updateMissedCounters()},this.onContactChangedEvent=function(e,t){I.computeCapabilitiesForContact(t),I.computeCapabilitiesForMyContact()},this.onTelephonyStateChangeEvent=function(e){var t=I.getConversations();t&&t.forEach(function(e){e.type===E.Type.ONE_TO_ONE&&I.computeCapabilitiesForContact(e.contact)}),I.computeCapabilitiesForMyContact()},this.onConferenceStateChangeEvent=function(){I.updateRoomConferences(),I.orderConversations(),S.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onConferenceParticipantChangeEvent=function(){I.orderConversations(),S.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onRoomChangedEvent=function(e,t,n){if(t){var r=I.getConversationById(t.jid);r&&("remove"===n?I.closeConversation(r):r.room=t)}},this.onRoomHistoryChangedEvent=function(e,t){if(t){var n=I.getConversationById(t.jid);n&&n.chatRenderer&&(n.reset(),n.chatRenderer.loadMore())}},this.onRoomAdminMessageEvent=function(e,t,n,r,i){g.info("[conversationService] onRoomAdminMessageEvent");var a=I.getConversationById(t);a&&("welcome"===r||"conferenceAdd"===r||"conferenceRemove"===r)&&a.room&&a.room.ownerContact&&(n=a.room.ownerContact.jid);var o=C.getContactByJid(n);if(a&&o){if(!a.room.owner&&"invitation"===r)return;if(a.room&&a.room.isMeetingRoom())return;I.conversationServiceEventHandler.onRoomAdminMessageReceived(a,o,r,i)}},this.onRoomAddConferenceEvent=function(e){g.info("[conversationService] onRoomAddConferenceEvent"),I.orderConversations(),S.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onMyContactChangedEvent=function(){I.getOrderedConversations().idle.forEach(function(e){e.type===E.Type.ONE_TO_ONE&&I.computeCapabilitiesForContact(e.contact)}),I.computeCapabilitiesForMyContact()},this.reinit=function(){var e=m.defer();return g.info("[conversationService] Re-initialize conversation service"),I.activeConversation&&(I.activeConversation.reset(),I.activeConversation=null),delete I.conversations,I.conversations=[],I.botServiceReady=!0,I.getServerConversations().then(function(){I.linkAllActiveCallsToConversations(),e.resolve()}).catch(function(){t(function(){g.info("[conversationService] getServerConversations failure, try again"),I.getServerConversations().then(function(){I.linkAllActiveCallsToConversations()})},1e4,1,!0),e.resolve()}),e.promise},this.linkAllActiveCallsToConversations=function(){for(var e in y.calls)if(y.calls.hasOwnProperty(e)){var t=y.calls[e];S.$broadcast("ON_CALL_UPDATED_EVENT",t)}for(var e in R.calls)if(R.calls.hasOwnProperty(e)){t=R.calls[e];S.$broadcast("ON_CALL_UPDATED_EVENT",t)}},this.unlockWaitingBotConversations=function(e){e&&(I.botServiceReady=!0),I.botServiceReady&&(I.botServiceReady=!1,I.waitingBotConversations.forEach(function(e,t){var n=C.getContactByJid(e.jid);n&&(I.getOrCreateOneToOneConversation(n.jid,null,e.lastModification,e.lastMessageText,e.missedIMCounter,e.muted,e.creationDate),I.waitingBotConversations.splice(t,1))}),I.waitingBotConversations=[])}}]),angular.module("rainbow").factory("ConversationServiceEventHandler",["$q","$log","$rootScope","contactService","xmppService","roomService","Conversation","Message","fileStorageService","fileServerService","webrtcGatewayService",function(k,B,h,H,x,V,o,p,c,l,d){"use strict";function t(e){this.conversationService=e}return t.create=function(e){return new t(e)},t.prototype.onChatMessageReceived=function(t){B.info("[ConversationServiceEventHandler] onChatMessageReceived");try{var n=this,e=$(t);return 0<e.find("event").length||0<e.find("propose").length||0<e.find("received").length?B.info("[ConversationServiceEventHandler] onChatMessageReceived ignore the message"):0<e.find("recording").length?(B.info("[ConversationServiceEventHandler] onChatMessageReceived : recording msg case"),this.onRecordingMessageReceived(t)):this.extractStanzaData(t).then(function(e){e.body||e.oob||e.conference?n.handleChatMessage(e):e.outgoingMessage||H.isUserContact(e.participant)||!e.status||n.handleStatusMessage(e.conversation,e.participant,t)}),!0}catch(e){return B.error("[ConversationServiceEventHandler] onChatMessageReceived ERROR "+e),!0}},t.prototype.onFileTransfertReceived=function(i){var e=x.getBareJidFromJid(i.from),a=this;this.conversationService.getOrCreateOneToOneConversation(e).then(function(e){var t=e.contact,n=o.getUniqueMessageId(),r=e.addFTMessage(t,new Date,i,n);e.setStatusMessage(t,o.Status.ACTIVE),e===a.conversationService.activeConversation&&h.appVisible&&"conversations"===h.activeApplication||(e.missedCounter+=1),e.sendAckReceivedMessage(r),h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e,o.EventType.FILE)})},t.prototype.onRoomAdminMessageReceived=function(e,t,n,r){B.info("[ConversationServiceEventHandler] onRoomAdminMessageReceived");var i=e.addAdminBubbleMessage(t,new Date,n,r);e.setStatusMessage(t,o.Status.ACTIVE),e.sendAckReceivedMessage(i),e===this.conversationService.activeConversation&&h.appVisible&&"conversations"===h.activeApplication||(e.missedCounter+=1),h.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",i,e,!1),h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e,o.EventType.IM)},t.prototype.onFileMessageReceived=function(e){B.info("[ConversationServiceEventHandler] onFileMessageReceived");try{return this.extractStanzaData(e).then(function(e){if(e.body){var t=e.conversation;t.addFileMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,o.Status.ACTIVE),h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t,o.EventType.FILE)}}),!0}catch(e){return B.error("[ConversationServiceEventHandler] onFileMessageReceived ERROR "+e),!0}},t.prototype.onWebRTCMessageReceived=function(e){B.info("[ConversationServiceEventHandler] onWebRTCMessageReceived");try{return 0<angular.element(e).find("call_log").length?this.extractWebrtcStanzaData(e).then(function(e){if(e&&e.body){var t=e.conversation;t.addWebRTCMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,o.Status.ACTIVE),h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)}}):this.extractStanzaData(e).then(function(e){if(e&&e.body){var t=e.conversation;t.addWebRTCMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,o.Status.ACTIVE),h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)}}),!0}catch(e){return B.error("[ConversationServiceEventHandler] onWebRTCMessageReceived error "+e),!0}},t.prototype.onManagementMessageReceived=function(e){try{var t=angular.element(e).find("conversation");if(t)if(n=this.conversationService.getConversationByDbId(t.attr("id")))"delete"===t.attr("action")&&(B.info("[ConversationServiceEventHandler] onManagementMessageReceived (delete conversation)"),this.conversationService.removeConversation(n));if(angular.element(e).find("mute")||angular.element(e).find("unmute")){var n,r=!(0===angular.element(e).find("mute").length),i=angular.element(e).find("mute").attr("conversation")||angular.element(e).find("unmute").attr("conversation");(n=this.conversationService.getConversationByDbId(i))&&(B.info("[ConversationServiceEventHandler] onManagementMessageReceived : mute is changed to "+r),n.muted=r)}return!0}catch(e){return B.error("[ConversationServiceEventHandler] onManagementMessageReceived error "+e),!0}},t.prototype.onReceiptMessageReceived=function(t){B.info("[ConversationServiceEventHandler] onReceiptMessageReceived");try{var e=angular.element(t),n=x.getBareJidFromJid(e.attr("from")),r=e.find("message");H.isUserContactJid(n)&&0<r.length&&(e=angular.element(r));var i=e.find("received");if(i.length&&0<i.length){var a=angular.element(i).attr("id"),o=angular.element(i).attr("entity"),s=angular.element(i).attr("event");if("server"===o&&"received"===s){var c=this.conversationService.pendingMessages[a],l=c.message,d=c.conversation;B.info("[conversationService] Receive server ack ("+d.id+", "+l.id+")"),l.setReceiptStatus(p.ReceiptStatus.SENT),d.updateMessage(l),delete this.conversationService.pendingMessages[a],h.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",l,d,"server")}else if("client"===o){var u=this;this.extractStanzaData(t).then(function(e){u.handleReceiptReceiveMessage(e.conversation,t)})}}else if(e.find("mark_as_read").length){var f=e.find("mark_as_read").attr("with");if(d=this.conversationService.getConversationById(f))switch(e.find("mark_as_read").attr("id")){case"all-received":d.missedCounter=0;break;case"all-sent":d.ackReadAllMessages();break;default:B.error("[ConversationServiceEventHandler] onReceiptMessageReceived error - unknown read type")}}return!0}catch(e){return B.error("[ConversationServiceEventHandler] onReceiptMessageReceived error "+e),!0}},t.prototype.extractStanzaData=function(e){var t=x.getBareJidFromJid(angular.element(e).attr("from")),n={},r=null,i=null,a=null,o=k.defer(),s=angular.element(e).find("message");if(H.isUserContactJid(t)&&0<s.length){var c=x.getBareJidFromJid(angular.element(s).attr("from")),l=x.getResourceFromJid(angular.element(s).attr("from")),d=x.getBareJidFromJid(angular.element(s).attr("to")),u=x.getResourceFromJid(angular.element(s).attr("to"));if(n.outgoingMessage=H.isUserContactJid(c),n.body=angular.element(s).find("body").text(),n.participant=n.outgoingMessage?H.userContact:null,n.messageId=angular.element(s).attr("id"),n.carbon=!0,r=n.outgoingMessage?d:c,i=n.outgoingMessage?u:l,a=angular.element(s).find("delay"),(T=angular.element(s).find("x[xmlns='jabber:x:oob']"))&&T.length){var f=angular.element(T).find("url").text(),h=angular.element(T).find("mime").text(),p=angular.element(T).find("filename").text(),v=angular.element(T).find("size").text();n.oob={url:f,mime:h,filename:p,filesize:v}}if((I=$(e).find("x[xmlns='jabber:x:audioconference']"))&&I.length){var m=(O=$(I)).attr("subject"),g=O.attr("confendpointid"),S=I.attr("jid"),C=I.attr("type");n.conference={type:C,subject:m,confendpointid:g,roomjid:S,ownerjid:r}}n.status=null;var E=angular.element(e).find("composing"),b=angular.element(e).find("paused"),R=angular.element(e).find("active");E.length?n.status="composing":b.length?n.status="paused":R.length&&(n.status="active")}else{var y=$(e);n.outgoingMessage=!1,n.body=y.find("body").text(),n.messageId=y.attr("id"),n.carbon=!1,r=x.getBareJidFromJid(y.attr("from")),i=x.getResourceFromJid(y.attr("from")),a=y.find("delay");var T,I,N="push"===y.find("retransmission").attr("source");if((T=y.find("x[xmlns='jabber:x:oob']"))&&T.length){var A=$(T);f=A.find("url").text(),h=A.find("mime").text(),p=A.find("filename").text(),v=A.find("size").text();n.oob={url:f,mime:h,filename:p,filesize:v}}if((I=y.find("x[xmlns='jabber:x:audioconference']"))&&I.length){var O,D=(O=$(I)).attr("message");g=O.attr("confendpointid"),S=I.attr("jid"),C=I.attr("type");if(n.conference={type:C,message:D,confendpointid:g,roomjid:S,ownerjid:r},"reminder"!==C)return B.debug("[conversationServiceEventHandler] ignored message stanza for conference"),o.resolve(n),o.promise;r=S}var P=y.find("content[xmlns='urn:xmpp:content']");P&&"text/markdown"===P.attr("type")&&(n.markdown=!0,n.body=P.text()),(m=y.find("subject"))&&""!==m.text()&&(n.subject=m.text()),n.status=null;E=y.find("composing"),b=y.find("paused"),R=y.find("active");E.length?n.status="composing":b.length?n.status="paused":R.length&&(n.status="active")}if(n.date=new Date,n.offline=!1,"Offline Storage"===a.text()&&(n.date=new Date(a.attr("stamp")),n.offline=!0),N){var w=this.conversationService.getConversationById(r);if(w)o.reject();else{var M=this.conversationService;(r.startsWith("room_")?M.getRoomConversation(r):M.getOrCreateOneToOneConversation(r)).then(function(e){w=e,o.reject()})}return o.promise}if(n.body||this.conversationService.getConversationById(r)||n.oob||n.conference)if(0===r.indexOf("room_")){var _=V.getRoomByJid(r),U=(m=y.find("subject")).length&&""===m.text();_&&"accepted"!==_.status||U?B.info("[conversationServiceEvent] extractStanzaData -- ignore this stanza message"):this.conversationService.getRoomConversation(r).then(function(e){return n.conversation=e,n.conference&&n.conference.ownerjid?H.getOrCreateContact(n.conference.ownerjid):(i&&-1!==i.indexOf("/")&&(i=i.split("/")[0]),H.getOrCreateContact(i))}).then(function(e){n.participant=e,o.resolve(n)}).catch(function(e){B.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),o.reject()})}else this.conversationService.getOrCreateOneToOneConversation(r).then(function(e){n.conversation=e,n.participant||(n.participant=e.contact),o.resolve(n)}).catch(function(e){B.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),o.reject()});else if($(e).find("deleted")){var F=$(e).find("deleted")[0];if(F&&"all"===F.getAttribute("id")){var L=this.conversationService.getConversationById(F.getAttribute("with"));L&&(B.info("[conversationServiceEventHandler] Remove all messages for conversation "+L.id),L.reset())}}else B.debug("[conversationServiceEventHandler] ignored message stanza"),o.reject();return o.promise},t.prototype.extractWebrtcStanzaData=function(o){B.debug("[conversationServiceEventHandler] extractWebrtcStanzaData");var s=this;return k(function(t,n){var r={};r.messageId=$(o).attr("id"),r.callerJid=$(o).find("caller").text(),r.calleeJid=$(o).find("callee").text(),r.state=$(o).find("state").text();var e=null;if(H.isUserContactJid(r.callerJid)?(e=r.calleeJid,r.participant=H.userContact):e=r.callerJid,-1!==e.indexOf("janusgateway"))return B.debug("[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore Janus message"),n();if(d.isMediaPillarJid(r.callerJid))return B.debug("[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore MediaPillar message"),t();var i=0;$(o).find("duration")&&(i=parseInt($(o).find("duration").text(),10)),r.duration=0<i?"("+moment.duration(i,"ms").format("h[H] mm[m] ss[s]")+")":0;var a=$(o).find("date").text();a&&(a=new Date(a)),r.date=a,r.body="","missed"===r.state?r.body="missedCall||"+a:"answered"===r.state&&(r.body="activeCallMsg||"+a+"||"+r.duration),s.conversationService.getOrCreateOneToOneConversation(e).then(function(e){r.conversation=e,r.participant||(r.participant=e.contact),t(r)}).catch(function(e){B.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),n()})})},t.prototype.handleChatMessage=function(e){B.info("[ConversationServiceEventHandler] handleChatMessage");var n=this,r=e.conversation,i=null;if(e.oob){var t=e.oob.url,a=e.oob.filename,o=c.extractFileIdFromUrl(t);c.retrieveAndStoreOneFileDescriptor(o).then(function(t){i=r.addFileSharingMessage(e.participant,e.date,e.body,e.messageId,o,a),n.acknowledgeHandledChatMessage(e,r,i),l.getBlobThumbnailFromFileDescriptor(t).then(function(e){t.previewBlob=e,h.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:t.id})}),h.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:t.id})}).catch(function(e){B.info("[ConversationServiceEventHandler] handleChatMessage error "+e)})}else if(e.conference){var s={type:e.conference.type,message:e.conference.subject,confendpointid:e.conference.confendpointid,roomjid:e.conference.roomjid};if(r=this.conversationService.getConversationById(s.roomjid),h.$broadcast("ROOM_UPDATE_CONFID"),!r)return!0;i=r.addConferenceMessage(e.participant,e.date,e.messageId,s)}else i=r.addChatMessage(e.participant,e.date,e.body,e.messageId,null,e.markdown,e.subject);i&&n.acknowledgeHandledChatMessage(e,r,i)},t.prototype.acknowledgeHandledChatMessage=function(e,t,n){if(B.info("[ConversationServiceEventHandler] acknowledgeHandledChatMessage"),!n)return n=t.getMessageById(e.messageId),t.room&&n&&n.side===p.Side.RIGHT&&t.sendAckReceivedMessage(n),!0;n.side===p.Side.LEFT?t===this.conversationService.activeConversation&&"away"!==H.userContact.status&&h.appVisible&&"conversations"===h.activeApplication?t.sendAckReceivedMessage(n):(t.sendAckReceivedMessage(n),!e.offline&&t.preload&&(t.missedCounter+=1)):(e.carbon?n.setReceiptStatus(p.ReceiptStatus.SENT):n.setReceiptStatus(p.ReceiptStatus.IN_PROGRESS),t.updateMessage(n)),t.setStatusMessage(e.participant,o.Status.ACTIVE),h.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",n,t,e.carbon),h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)},t.prototype.handleReceiptReceiveMessage=function(e,t){B.info("[ConversationServiceEventHandler] handleReceiptReceiveMessage");var n=angular.element(t).find("received[xmlns='urn:xmpp:receipts']");if(n.length){var r=angular.element(n).attr("id"),i=e.getMessageById(r);if(i){(s=angular.element(t).attr("from").split("/")[1])||(s=angular.element(t).attr("from"));var a=angular.element(n).attr("event");(e.room&&H.isUserContactJid(s)||!e.room)&&("received"===a?i.setReceiptStatus(p.ReceiptStatus.UNREAD):"read"===a&&(i.setReceiptStatus(p.ReceiptStatus.READ),e.missedCounter=0)),H.isUserContactJid(s)&&"read"===a&&"L"===i.side&&(e.missedCounter=0),e.updateMessage(i),h.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",i,e,a),h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e)}else{var o=angular.element(t).attr("from"),s=(a=angular.element(n).attr("event"),"");o&&(s=o.split("/")[1]),s||(s=o),H.isUserContactJid(s)&&"read"===a&&(e.missedCounter=0,h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e))}}},t.prototype.handleStatusMessage=function(e,t,n){B.info("[conversationServiceEventHandler] handleStatusMessage ");var r="";r="thread"===angular.element(n).children().prop("tagName")?o.stringToStatus(angular.element(angular.element(n).children()[1]).prop("tagName")):o.stringToStatus(angular.element(n).children().prop("tagName")),e.setStatusMessage(t,r),h.$broadcast("ON_CONVERSATIONS_STATUS_MESSAGE_EVENT",e,t,r)},t.prototype.onRecordingMessageReceived=function(e){B.info("[ConversationServiceEventHandler] onRecordingMessageReceived");try{var n=e.textContent;return this.extractStanzaData(e).then(function(e){if("start"===n)(t=e.conversation).addRecordingMessage(e.participant,e.date,n,e.messageId),t.setStatusMessage(e.participant,o.Status.ACTIVE),h.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t),h.$broadcast("ON_RECORDING_START_MSG_RECEIVED");else if("stop"===n){var t;(t=e.conversation)&&t.addRecordingMessage(e.participant,e.date,n,e.messageId),h.$broadcast("ON_RECORDING_STOP_MSG_RECEIVED")}else"remoteStopVideo"===n?h.$broadcast("ON_RECORDING_REMOTESTOPVIDEO_MSG_RECEIVED"):"remoteChangeMediaVideo"===n?h.$broadcast("ON_RECORDING_REMOTECHANGEMEDIAVIDEO_MSG_RECEIVED"):"remoteStopSharing"===n?h.$broadcast("ON_RECORDING_REMOTESTOPSHARING_MSG_RECEIVED"):"remoteChangeMediaSharing"===n&&h.$broadcast("ON_RECORDING_REMOTECHANGEMEDIASHARING_MSG_RECEIVED")}),!0}catch(e){return B.error("[ConversationServiceEventHandler] onRecordingMessageReceived error "+e),!0}},t}]),angular.module("rainbow").factory("ConversationServiceHistoryHandler",["$log","$q","$filter","$rootScope","xmppService","contactService","fileStorageService","fileServerService","Message","SearchTextMsgResultFactory",function(N,l,A,O,D,P,w,M,_,u){"use strict";function i(e){this.conversationService=e}return i.create=function(e){return new i(e)},i.prototype.getHistoryPage=function(e,t){var n=this,r=e.room;return r&&r.initPresPromise?r.initPresPromise.promise.then(function(){return n.getHistoryPageInternal(e,t)}):this.getHistoryPageInternal(e,t)},i.prototype.getHistoryPageInternal=function(e,t){if(e.currentHistoryId&&e.currentHistoryId===e.historyIndex)return N.info("[ConversationServiceHistoryHandler] getHistoryPage("+e.id+", "+t+", "+e.historyIndex+") already asked"),l.when();e.currentHistoryId=e.historyIndex,N.info("[ConversationServiceHistoryHandler] getHistoryPage("+e.id+", "+t+", "+e.historyIndex+")");var n=e.historyDefered=l.defer();if(P.isUserContact(e.contact))return n.reject(),n.promise;if(e.historyComplete)return N.info("[ConversationServiceHistoryHandler] getHistoryPage("+e.id+") : already complete"),n.reject(),n.promise;var r={queryid:e.id,with:e.id,max:t,before:""};return-1!==e.historyIndex&&(r.before=e.historyIndex),e.room?(r={queryid:e.id,with:P.userContact.jid,max:t,before:""},-1!==e.historyIndex&&(r.before=e.historyIndex),D.connection.mam.querymuc(e.id,e.room.jid,r)):D.connection.mam.query(e.id,r),n.promise},i.prototype.getHistoryPageAroundMsg=function(e,t,n){e.historyDefered=l.defer();var r=l.defer();return P.isUserContact(e.contact)?r.reject():i.prototype.getCommonHistoryPageAroundMsg(e,t+1,n,"after",function(){N.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg BEFORE finished"),i.prototype.getCommonHistoryPageAroundMsg(e,t,n,"before",function(){N.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg AFTER finished"),r.resolve()})}),r.promise},i.prototype.getCommonHistoryPageAroundMsg=function(e,t,n,r,i){var a;(N.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg("+e.id+", "+t+", "+e.historyIndex+")"),e.room)?((a={queryid:e.id,with:P.userContact.jid,max:t,onComplete:i})[r]=n,D.connection.mam.querymuc(e.id,e.room.jid,a)):((a={queryid:e.id,with:e.id,max:t,onComplete:i})[r]=n,D.connection.mam.query(e.id,a))},i.prototype.searchTextInConversations=function(e,n,t){N.info("[ConversationServiceHistoryHandler] searchTextInConversations("+n+")");var r=l.defer(),i=D.connection.getUniqueId(),a=$iq({id:i,type:"get"}).c("query",{queryid:e,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(t).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(n).up().up();return D.sendIQ(a).then(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Success: "+n);var t=$(e).find("query").find("set").find("count").text();N.info("[ConversationServiceHistoryHandler] >searchTextInConversations: count= "+t),r.resolve(t)}).catch(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Failure: "+e.message),r.reject(e)}),r.promise},i.prototype.getConversationTextCount=function(e,n,t){N.info("[ConversationServiceHistoryHandler] getConversationTextCount("+n+")");var r=l.defer(),i=D.connection.getUniqueId(),a=$iq({id:i,type:"get"}).c("query",{queryid:e,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t("0").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(n).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(t).up().up();return D.sendIQ(a).then(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Success: "+n);var t=$(e).find("query").find("set").find("count").text();N.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+t),r.resolve(t)}).catch(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Failure: "+e.message),r.reject(e)}),r.promise},i.prototype.searchTextResultsInConversation=function(e,n,t,r){N.info("[ConversationServiceHistoryHandler] searchTextResultsInConversation("+n+")");var i=l.defer(),a=D.connection.getUniqueId(),o=$iq({id:a,type:"get"}).c("query",{queryid:e,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(r).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(n).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(t).up().up();return D.sendIQ(o).then(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Success: "+n);var t=$(e).find("query").find("set").find("count").text();N.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+t),i.resolve(t)}).catch(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Failure: "+e.message),i.reject(e)}),i.promise},i.prototype.searchTextMoreResultsInConversation=function(e,n,t,r,i){N.info("[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation("+n+")");var a=l.defer(),o=D.connection.getUniqueId(),s=$iq({id:o,type:"get"}).c("query",{queryid:e,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(i).up().c("before").t(r).up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(n).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(t).up().up();return D.sendIQ(s).then(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Success: "+n);var t=$(e).find("query").find("set").find("count").text();N.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+t),a.resolve(t)}).catch(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Failure: "+e.message),a.reject(e)}),a.promise},i.prototype.searchTextInRoom=function(e,t,n,r,i){N.info("[ConversationServiceHistoryHandler] searchTextInRoom("+r+")");var a=l.defer(),o=D.connection.getUniqueId(),s=$iq({to:n,id:o,type:"get"}).c("query",{queryid:e,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(i).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"with",type:"text-single"}).c("value").t(t).up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(r).up().up();return D.sendIQ(s).then(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Success: "+r);var t=$(e).find("query").find("set").find("count").text();N.info("[ConversationServiceHistoryHandler] >searchTextInRoom: count= "+t),a.resolve(t)}).catch(function(e){N.info("[ConversationServiceHistoryHandler] >searchTextInRoom: Failure: "+e.message),a.reject(e)}),a.promise},i.prototype.searchTextMoreResultsInRoom=function(e,n,t,r,i,a){N.info("[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation("+n+")");var o=l.defer(),s=D.connection.getUniqueId(),c=$iq({to:r,id:s,type:"get"}).c("query",{queryid:e,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(a).up().c("before").t(i).up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(n).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(t).up().up();return D.sendIQ(c).then(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Success: "+n);var t=$(e).find("query").find("set").find("count").text();N.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+t),o.resolve(t)}).catch(function(e){N.info("[ConversationServiceHistoryHandler] sendIq Failure: "+e.message),o.reject(e)}),o.promise},i.prototype.onHistoryMessageReceived=function(e){N.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived");try{var t=null,n=$(e),r=n.find("result").attr("queryid");if(r){if(t=this.conversationService.getConversationById(r)){if(n.find("call_log").length)return this.onWebrtcHistoryMessageReceived(e,t);var i,a=n.find("forwarded message").attr("from"),o=!1;if(!(i=a&&0===a.indexOf("room_")?a.split("/")[1]:D.getBareJidFromJid(n.find("forwarded message").attr("from")))&&n.find("event").length&&(o=n.find("event").attr("name"),i=n.find("event").attr("jid"),"welcome"===o&&t.room&&t.room.ownerContact&&(i=t.room.ownerContact.jid)),!i)return N.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information"),!0;var s=P.getContactByJid(i),c=n.find("forwarded message").attr("type"),l=n.find("forwarded message").attr("id"),d=new Date(n.find("forwarded delay").attr("stamp")),u=n.find("forwarded message body").text(),f=n.find("forwarded message ack"),h=n.find("forwarded message x[xmlns='jabber:x:oob']"),p=n.find("forwarded message x[xmlns='jabber:x:audioconference']"),v=n.find("content[xmlns='urn:xmpp:content']");if(s||(N.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : "+i+", ignore message"),s=P.createEmptyContactContact(i)),o){if(N.info("[ConversationServiceHistoryHandler] ("+t.id+") add Room admin event message "+o),c="admin",t.room&&t.room.isMeetingRoom()&&("welcome"===o||"conferenceAdd"===o||"conferenceRemove"===o||"invitation"===o))return!0;("conferenceAdd"===o||"conferenceRemove"===o)&&t.room&&t.room.ownerContact&&(s=t.room.ownerContact)}var m=t.getMessageById(l);if(m||(m=t.historyMessages.find(function(e){return e.id===l})),m)N.info("[ConversationServiceHistoryHandler] ("+t.id+") try to add an already stored message with id "+m.id);else{var g=P.isUserContact(s)?_.Side.RIGHT:_.Side.LEFT;switch(c){case"file":m=_.createFileMessage(l,d,s,g,u,!1);break;case"webrtc":m=_.createWebRTCMessage(l,d,s,g,u,!1);break;case"admin":m=_.createBubbleAdminMessage(l,d,s,o);break;case"recording":m=_.createRecordingAdminMessage(l,d,s,"Admin");break;default:if(h&&h.length){var S=$(h),C=S.find("url").text(),E=S.find("filename").text(),b=w.extractFileIdFromUrl(C);m=_.createFileSharingMessage(l,d,s,g,u,!1,b,E),w.retrieveAndStoreOneFileDescriptor(b).then(function(t){t&&"not_uploaded"===t.state&&(m.receiptStatus=1,m.fileErrorMsg=A("translate")("file_notuploaded")),M.getBlobThumbnailFromFileDescriptor(t).then(function(e){t.previewBlob=e,O.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:t.id})}),O.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:t.id})}).catch(function(e){N.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived error "+e)})}else if(p&&p.length){var R=$(p),y={subject:R.attr("subject"),confendpointid:R.attr("confendpointid"),roomjid:p.attr("jid")};m=_.createConferenceMessage(l,d,s,g,!1,y)}else{var T=v&&"text/markdown"===v.attr("type");u=T?v.text():u,m=_.create(l,d,s,g,u,!1,T)}}m.receiptStatus="true"===angular.element(f).attr("read")?5:"true"===angular.element(f).attr("recv")?4:3,N.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : pushing msg inside historyMessages"),t.historyMessages.push(m)}}}else if(r=angular.element(e).find("fin").attr("queryid"),t=this.conversationService.getConversationById(r)){t.historyComplete="true"===angular.element(e).find("fin").attr("complete");var I=angular.element(e).find("fin set first").text();-1===t.historyIndex?(t.messages.unshift.apply(t.messages,t.historyMessages),t.chatRenderer&&t.chatRenderer.prependMessages(t.messages,t.room)):(t.messages.unshift.apply(t.messages,t.historyMessages),t.chatRenderer&&t.chatRenderer.prependMessages(t.historyMessages,t.room)),t.historyIndex=I,t.historyMessages=[],angular.isDefined(t.messages)&&0<t.messages.length?t.lastMessageText=t.messages[t.messages.length-1].data:t.lastMessageText="",t.historyDefered&&t.historyDefered.resolve(t)}return!0}catch(e){return N.error("[ConversationServiceHistoryHandler] onHistoryMessageReceived error : "+e),!0}},i.prototype.onSearchTextMessageReceived=function(e){N.info("[ConversationServiceHistoryHandler] onSearchTextMessageReceived");try{var t,n=$(e),r=n.find("forwarded message").attr("from"),i=n.find("forwarded message").attr("to"),a=!1,o=!1;if(P.isUserContactJid(r)?(N.info("[ConversationServiceHistoryHandler] sent message"),a=!0,t=i):(N.info("[ConversationServiceHistoryHandler] received message"),a=!1,t=r),t&&0===t.indexOf("room_")?(t=t.split("/")[0],o=!0):t=D.getBareJidFromJid(t),!t)return void N.warn("[ConversationServiceHistoryHandler] onSearchTextMessageReceived - Receive message without valid otherJid information");var s=n.find("forwarded message").attr("id"),c=new Date(n.find("forwarded delay").attr("stamp")),l=n.find("forwarded message body").text(),d=u();return d.body=l,d.date=c,d.isRoom=o,d.isSent=a,d.messageId=s,d.otherJid=t,d}catch(e){return N.error("[ConversationServiceHistoryHandler] onSearchTextMessageReceived error : "+e),!0}},i.prototype.onWebrtcHistoryMessageReceived=function(e,t){console.log("onWebrtcHistoryMessageReceived");try{var n=$(e),r=n.find("forwarded message").attr("id"),i=n.find("caller").text(),a=n.find("state").text(),o=0;n.find("duration")&&(o=n.find("duration").text(),o=parseInt(o,10)),o=0<o?"("+moment.duration(o,"ms").format("h[H] mm[m] ss[s]")+")":0;var s=n.find("date").text();s=s?new Date(s):new Date(n.find("forwarded delay").attr("stamp"));var c="";"missed"===a?c="missedCall||"+s:"answered"===a&&(c="activeCallMsg||"+s+"||"+o);var l=t.getMessageById(r);if(l||(l=t.historyMessages.find(function(e){return e.id===r})),l)N.info("[ConversationServiceHistoryHandler] ("+t.id+") try to add an already stored message with id "+l.id);else{var d=P.getContactByJid(i);d||(N.warn("[ConversationServiceHistoryHandler] onWebrtcHistoryMessageReceived missing contact for jid : "+i+", ignore message"),d=P.createEmptyContactContact(i));var u=P.isUserContact(d)?_.Side.RIGHT:_.Side.LEFT;l=_.createWebRTCMessage(r,s,d,u,c,!1);var f=n.find("forwarded message ack");f&&(l.receiptStatus="true"===angular.element(f).attr("read")?5:"true"===angular.element(f).attr("received")?4:3),t.historyMessages.push(l)}return!0}catch(e){return console.error(e),!0}},i}]),angular.module("rainbow").service("telephonyService",["$q","$interval","$http","$rootScope","$log","xmppService","contactService","authService","Call","TelephonyServiceEventHandler","errorHelperService","VoiceMail","profileService",function(s,c,l,p,v,a,m,d,g,t,u,n,S){"use strict";var C=this,r=[],o="urn:xmpp:pbxagent:callservice:1";C.start=function(e){return v.info("[telephonyService] === STARTING ==="),C.startDate=performance.now(),C.stats=e,C.calls=[],C.started=!1,C.agentStatus={phoneApi:"disconnected",xmppAgent:"stopped",agentVersion:"unknown"},C.voicemailNumber=m.userContact.voicemailNumber,C.pbxId=m.userContact.pbxId,C.makingCall=!1,C.starting=!1,C.voiceMail=n.create(),C.forwardObject={},C.nomadicObject={},C.nomadicAnswerNotTakedIntoAccount=!1,C.isBasicCallAllowed=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_BASIC_CALL),C.isSecondCallAllowed=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_SECOND_CALL),C.isTransferAllowed=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_TRANSFER_CALL),C.isConferenceAllowed=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_CONFERENCE_CALL),C.isVMDeflectCallAllowed=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_DEFLECT_CALL),C.voiceMailFeatureEnabled=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_VOICE_MAIL),C.isForwardEnabled=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_CALL_FORWARD),C.isNomadicEnabled=S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_NOMADIC),C.userJidTel=d.jidTel,v.info("[telephonyService] wait for my telephony presence"),r.push(p.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",C.onTelPresenceChange)),C.telephonyEventHandler=t.create(C),C.portalURL=config.restServerUrl+"/api/rainbow/telephony/v1.0/",s.when()},C.onTelPresenceChange=function(e,t){if(m.isTelJid(t.jid)){if("phone"!==m.getRessourceFromJid(t.jid))return!0;var n=m.getImJid(t.jid);if(!n)return!0;var r=t.status;m.isUserContactJid(n)&&("unavailable"===r||"offline"===r?(v.info("[telephonyService] received my telephony presence -- "+r),C.started=!1,C.calls=[],p.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),v.info("[telephonyService] === STOPPED ===")):C.started||C.starting||(v.info("[telephonyService] received my telephony presence -- "+r),C.starting=!0,C.getAgentStatus().then(function(){return C.attachHandlers(),C.getTelephonyState(!1)}).then(function(){return C.isNomadicEnabled&&C.getNomadicStatus().then(function(){return C.nomadicObject.featureActivated&&C.nomadicObject.modeActivated&&!C.nomadicObject.makeCallInitiatorIsMain?C.getTelephonyState(!0):s.when()}),s.when()}).then(function(){return C.isForwardEnabled&&C.getForwardStatus(),s.when()}).then(function(){var e=Math.round(performance.now()-C.startDate);C.stats.push({service:"telephonyService",startDuration:e}),v.info("[telephonyService] === STARTED ("+e+" ms) ==="),C.started=!0,C.starting=!1,p.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","started")}).catch(function(e){C.starting=!1,v.error("[telephonyService] receive telephony presence but no agent response - "+e.message)})))}return!0},C.getTelephonyState=function(e){var t,i=s.defer();return t=e?$iq({type:"get",to:C.userJidTel+"/phone"}).c("callservice",{xmlns:o}).c("connections",{deviceType:"SECONDARY"}):$iq({type:"get",to:C.userJidTel+"/phone"}).c("callservice",{xmlns:o}).c("connections"),a.sendIQ(t).then(function(e){var t=C.getErrorMessage(e,"getTelephonyState");if(t)return v.info("[telephonyService] getTelephonyState -- failure -- "+t),i.reject(new Error(t)),i.promise;var n=angular.element(e).find("connection");if(0===n.length)return v.info("[telephonyService] getTelephonyState -- success -- no existing call"),i.resolve(),i.promise;var r=[];return n.each(function(){r.push(C.createCallFromConnectionElem(this))}),s.all(r).then(function(){v.info("[telephonyService] getTelephonyState -- success"),i.resolve()}).catch(function(e){v.error("[telephonyService] getTelephonyState -- failure -- "+e.message),i.reject(e)}),i.promise}).catch(function(e){v.error("[telephonyService] getTelephonyState -- failure -- "+e.message),i.reject(e)}),i.promise},C.getAgentStatus=function(){var i=s.defer(),e=$iq({type:"get",to:C.userJidTel+"/phone"}).c("pbxagentstatus",{xmlns:"urn:xmpp:pbxagent:monitoring:1"});return a.sendIQ(e).then(function(e){var t=angular.element(e).find("phoneapi").text(),n=angular.element(e).find("xmppagent").text(),r=angular.element(e).find("version").text();r&&(C.agentStatus={phoneApi:t,xmppAgent:n,agentVersion:r}),v.info("[telephonyService] getAgentStatus -- success -- version "+r),i.resolve()}).catch(function(e){var t="getAgentStatus -- failure : "+e.message;v.error("[telephonyService] "+t),i.reject(new Error(t))}),i.promise},C.getSnapshotCall=function(r){return v.info("[telephonyService] getSnapshotCall"),s(function(t,n){var e=$iq({type:"get",to:C.userJidTel+"/phone"}).c("callservice",{xmlns:o}).c("snapshotCall",{callId:r});a.sendIQ(e).then(function(e){console.error(e),t()}).catch(function(e){var t="getSnapshotCall failure : "+e.message;v.error("[telephonyService] "+t),n(new Error(t))})})},C.getVoiceMessageCounter=function(){return s(function(t,n){if(!C.voiceMailFeatureEnabled){var e=new Error("getVoiceMessageCounter failure - Not Allowed");e.status=e.errorDetailsCode="403",v.error("[telephonyService] "+e.message),n(e)}var r=$iq({type:"get",to:C.userJidTel+"/phone"}).c("callservice",{xmlns:o}).c("messaging");a.sendIQ(r).then(function(e){console.error(e),t()}).catch(function(e){var t="getVoiceMessageCounter failure : "+e.message;v.error("[telephonyService] "+t),n(new Error(t))})})},C.createCallFromConnectionElem=function(h){return s(function(r,t){var e=angular.element(h),n=e.attr("endpointIm"),i=e.attr("endpointTel"),a=e.attr("callId"),o=e.attr("endpointLci"),s=e.attr("lci"),c=e.find("participant"),l=e.find("identity").attr("firstName"),d=e.find("identity").attr("lastName"),u="",f="";n||i||(i="****"),S.isFeatureEnabled(S.FeaturesEnum.TELEPHONY_PHONE_BOOK)&&0===c.length&&d&&d.length&&(f=d,l&&l.length&&(u=l),v.info("[telephonyService] createCallFromConnectionElem - name resolution for: "+a+" for phoneNumber:"+anonymizePhoneNumber(i)+" with firstname : "+u.slice(0,1)+"***")),"LCI_INITIATED"===s&&r();(0===c.length?m.getOrCreateContact(n,i):C.getParticipantsFromParticipantsElem(c)).then(function(e){var t=g.Status.ACTIVE;"LCI_HELD"===s&&"LCI_CONNECTED"===o&&(t=g.Status.HOLD),"LCI_CONNECTED"===s&&"LCI_HELD"===o&&(t=g.Status.PUT_ON_HOLD),"LCI_CONNECTED"===s&&"LCI_QUEUED"===o&&(t=g.Status.QUEUED_OUTGOING),"LCI_QUEUED"===s&&"LCI_CONNECTED"===o&&(t=g.Status.QUEUED_INCOMMING);var n=null;0===c.length?(e&&e.temp&&""!==f&&e.updateName(u,f),n=C.getOrCreateCall(t,a,e),v.info("[telephonyService] createCallFromConnectionElem - create call for user: "+e.id+" with callId: "+a+" "+s)):((n=C.getOrCreateCall(t,a)).setParticipants(e),n.isConference=!0,v.info("[telephonyService] createCallFromConnectionElem - create conference call with callId: "+a+" "+s));n.relevantEquipmentId=g.getDeviceIdFromConnectionId(a),p.$broadcast("ON_CALL_UPDATED_EVENT",n),r(n)}).catch(function(e){v.error("[TelephonyService] createCallFromConnectionElem - failure - "+e.message),t(e)})})},C.getParticipantsFromParticipantsElem=function(r){return s(function(e,t){var a=[],n=[];r.each(function(){var e=angular.element(this),r=e.find("endpointTel").text(),i=e.find("endpointIm").text();i&&m.isUserContactJid(i)||n.push(s(function(t,n){i||r||(r="****"),m.getOrCreateContact(i,r).then(function(e){a.push(e),t()}).catch(function(e){n(e)})}))}),s.all(n).then(function(){e(a)},function(e){t(e)})})},C.getOrCreateCall=function(e,t,n){var r=g.getIdFromConnectionId(t),i=C.calls[r];return i?(i.setConnectionId(t),i.startDate=new Date):((i=g.create(e,null,g.Type.PHONE,n)).setConnectionId(t),C.calls[r]=i),i},C.attachHandlers=function(){v.info("[telephonyService] attachHandlers"),C.started=!1,C.calls=[],C.messageHandlerRef&&(a.deleteHandler(C.messageHandlerRef),C.messageHandlerRef=null),C.messageHandlerRef=a.addHandler(function(e){return C.telephonyEventHandler.onCallserviceMessageReceived(e),!0},o,"message",null)},C.stop=function(){var e;for(v.info(""),v.info("[telephonyService] === STOPPING ==="),C.started=!1,C.userJidTel=null,C.calls=null,C.messageHandlerRef&&(a.deleteHandler(C.messageHandlerRef),C.messageHandlerRef=null);e=r.pop();)e();return v.info("[telephonyService] === STOPPED ==="),p.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),s.when()},C.getCallToHangOut=function(){var e=C.getCalls();if(!e||0===e.length)return null;var t=e[0].status;return 1===e.length||t===g.Status.DIALING||t===g.Status.ACTIVE||t===g.Status.PUT_ON_HOLD?e[0]:e[1]},C.getActiveCall=function(){var n=null;return Object.keys(C.calls||[]).forEach(function(e){var t=C.calls[e];t.status===g.Status.ACTIVE&&(n=t)}),n},C.getCalls=function(){var n=[];return Object.keys(C.calls||[]).forEach(function(e){var t=C.calls[e].status;t!==g.Status.DIALING&&t!==g.Status.RINGING_OUTGOING&&t!==g.Status.QUEUED_OUTGOING&&t!==g.Status.ACTIVE&&t!==g.Status.HOLD&&t!==g.Status.PUT_ON_HOLD&&t!==g.Status.ERROR||n.push(C.calls[e])}),n},C.getActiveCallsForContact=function(t){var n=[];return t&&t.jid&&Object.keys(C.calls||[]).forEach(function(e){!C.calls[e].contact||C.calls[e].contact.jid!==t.jid||C.calls[e].status!==g.Status.DIALING&&C.calls[e].status!==g.Status.RINGING_OUTGOING&&C.calls[e].status!==g.Status.ACTIVE&&C.calls[e].status!==g.Status.HOLD&&C.calls[e].status!==g.Status.PUT_ON_HOLD||n.push(C.calls[e])}),n},C.makeCall=function(e,t,n){var r=C.getActiveCall();return C.makingCall?(v.warn("[telephonyService] makeCall failure - makeCall already making a call"),s.reject()):(C.makingCall=!0,r?C.makeConsultationCall(e,t,r.connectionId):C.makeSimpleCall(e,t,n))},C.makeSimpleCall=function(i,a,o){return s(function(n,r){if(v.info("[telephonyService] makeSimpleCall to "+(i?i.displayName:a)),!C.isBasicCallAllowed){var e=new Error("makeSimpleCall failure - Not Allowed");e.status=e.errorDetailsCode="403",v.error("[telephonyService] "+e.message),C.makingCall=!1,r(e)}var t=C.getPhoneInfo(i,a);l({method:"POST",url:C.portalURL+"calls",headers:d.getRequestHeader(),data:{calleeExtNumber:t.longNumber,calleeIntNumber:t.internalNumber,calleeShortNumber:t.shortNumber,calleePbxId:t.pbxId,calleeDisplayName:i.displayName,callSubject:o,secondaryDeviceMakeCall:angular.isDefined(C.nomadicObject.makeCallInitiatorIsMain)&&!0===C.nomadicObject.featureActivated&&C.isNomadicEnabled?C.nomadicObject.makeCallInitiatorIsMain?"false":"true":void 0}}).then(function(e){v.info("[telephonyService] makeSimpleCall success : "+anonymizePhoneNumber(a)+" Call ("+t+")");var t=g.create(g.Status.DIALING,null,g.Type.PHONE,i);t.setConnectionId(e.data.data.callId),t.setRelevantEquipmentId(g.getDeviceIdFromConnectionId(t.connectionId)),C.calls[t.id]=t,C.makingCall=!1,t.setIsVm(a===C.voicemailNumber),p.$broadcast("ON_CALL_UPDATED_EVENT",t),n(t.id)},function(e){var t=g.create(g.Status.ERROR,null,g.Type.PHONE,i);t.errorMessage="403"===e.errorDetailsCode?"notAllowed":"invalidPhoneNumber",(C.calls[t.contact.id]=t).autoClear=c(function(){C.clearCall(t)},5e3,1),C.makingCall=!1,p.$broadcast("ON_CALL_UPDATED_EVENT",t);var n=u.handleError(e);r(n),v.error("[telephonyService] "+u.getErrorFullMessage(e,"makeCall"))})})},C.makeConsultationCall=function(i,a,o){return s(function(n,r){if(!C.isSecondCallAllowed){var e=new Error("makeConsultationCall failure - Not Allowed");e.status=e.errorDetailsCode="403",v.error("[telephonyService] "+e.message),C.makingCall=!1,r(e)}var t=C.getPhoneInfo(i,a);l({method:"POST",url:C.portalURL+"calls/"+encodeURIComponent(o)+"/consultation",headers:d.getRequestHeader(),data:{calleeExtNumber:t.longNumber,calleeIntNumber:t.internalNumber,calleeShortNumber:t.shortNumber,calleePbxId:t.pbxId,calleeDisplayName:i.displayName}}).then(function(e){v.info("[telephonyService] makeConsultationCall success : "+anonymizePhoneNumber(a)+" Call ("+t+")");var t=g.create(g.Status.DIALING,null,g.Type.PHONE,i);t.setConnectionId(e.data.data.callId),t.setRelevantEquipmentId(g.getDeviceIdFromConnectionId(t.connectionId)),C.calls[t.id]=t,C.makingCall=!1,t.setIsVm(a===C.voicemailNumber),p.$broadcast("ON_CALL_UPDATED_EVENT",t),n(t.id)},function(e){var t=g.create(g.Status.ERROR,null,g.Type.PHONE,i);t.errorMessage="403"===e.errorDetailsCode?"notAllowed":"invalidPhoneNumber",(C.calls[t.contact.id]=t).autoClear=c(function(){C.clearCall(t)},5e3,1),C.makingCall=!1;var n=u.handleError(e);C.deleteCallIfInvalid(n,C.calls[g.getIdFromConnectionId(o)]),p.$broadcast("ON_CALL_UPDATED_EVENT",t),r(n),v.error("[telephonyService] "+u.getErrorFullMessage(e,"makeConsultationCall"))})})},C.makeCallByPhoneNumber=function(n){return s(function(e,r){if(v.info("[telephonyService] makeCallByPhoneNumber : "+anonymizePhoneNumber(n)),m.userContact.phonePro===n||m.userContact.phoneProCan===n||m.userContact.phonePbx===n){var t="makeCallByPhoneNumber failure: impossible to call its own phone number";v.error("[telephonyService] "+t),r(new Error(t))}var i=null;m.getOrCreateContact(null,n).then(function(e){return i=e,C.makeCall(e,n)}).then(function(){e()}).catch(function(e){var t="makeCallByPhoneNumber failure "+(e?e.message:"");v.error("[telephonyService] - callService - "+t);var n=g.create(g.Status.ERROR,null,g.Type.PHONE,i);n.errorMessage=e?"403"===e.errorDetailsCode?"notAllowed":"invalidPhoneNumber":"",(C.calls[n.contact.id]=n).autoClear=c(function(){C.clearCall(n)},5e3,1),p.$broadcast("ON_CALL_UPDATED_EVENT",n),r(new Error(t))})})},C.getPhoneInfo=function(e,t){var n=t,r="",i="",a="";return e&&(t===e.phonePro||t===e.phoneProCan?(n=e.phoneProCan?e.phoneProCan:"",r=e.phonePbx,a=e.pbxId,i=e.phoneInternalNumber):t===e.phonePbx&&(n="",r=e.phonePbx,a=e.pbxId,i=e.phoneInternalNumber)),{longNumber:n,shortNumber:r,pbxId:a,internalNumber:i}},C.getErrorMessage=function(e,t){var n=t+" failure : ";if("error"===angular.element(e).attr("type")){var r=angular.element(e).find("error");if(r){var i=r.attr("type"),a=r.attr("code");i&&(n+=i+" : ","modify"===i&&(n+=r.find("text").text())),a&&"503"===a&&(n+="Agent error : service unavailable"),v.error("[telephonyService] "+n)}else n+="Unknown error";return n}return null},C.releaseCall=function(r){return s(function(e,n){if(v.info("[telephonyService] releaseCall "+r.id),!C.isBasicCallAllowed){var t=new Error("releaseCall failure - Not Allowed");t.status=t.errorDetailsCode="403",v.error("[telephonyService] "+t.message),n(t)}l({method:"DELETE",url:C.portalURL+"calls/"+encodeURIComponent(r.connectionId),headers:d.getRequestHeader()}).then(function(){r.setStatus(g.Status.UNKNOWN),r.startDate=null,r.vm=!1,v.info("[telephonyService] releaseCall "+r.id+" - success : "),p.$broadcast("ON_CALL_UPDATED_EVENT",r),delete C.calls[r.id],e(r)},function(e){var t=u.handleError(e);C.deleteCallIfInvalid(t,r),n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"releaseCall"))})})},C.deleteCallIfInvalid=function(e,t){e&&"telephony"===e.portal&&404100===e.errorDetailsCode&&"Invalid connection identifier."===e.message&&t&&(v.warn("[telephonyService] deleteCallIfInvalid: delete client call non existing on server: "+t.id),t.setStatus(g.Status.UNKNOWN),p.$broadcast("ON_CALL_UPDATED_EVENT",t),C.calls[t.id]&&delete C.calls[t.id])},C.answerCall=function(i){return s(function(t,n){v.info("[telephonyService] answerCall : "+i.id);var e=C.getActiveCall();if(!C.isBasicCallAllowed){var r=new Error("answerCall failure - Not Allowed");r.status=r.errorDetailsCode="403",v.error("[telephonyService] "+r.message),n(r)}i.status===g.Status.QUEUED_INCOMMING&&e?C.holdCall(e).then(function(){return C.answerCall(i)}).then(function(e){t(e)}).catch(function(e){var t="answerCall failure : "+e.message;v.error("[telephonyService] - callService -  "+t),n(new Error(t))}):l({method:"PUT",url:C.portalURL+"calls/"+encodeURIComponent(i.connectionId)+"/answer",headers:d.getRequestHeader()}).then(function(e){i.setConnectionId(e.data.data.callId),i.setStatus(g.Status.ACTIVE),v.info("[telephonyService] answerCall success : "+anonymizePhoneNumber(i.contact.phone)+" Call ("+i+")"),p.$broadcast("ON_CALL_UPDATED_EVENT",i),t(i)},function(e){e.data&&"Device is not able to answer a call"===e.data.errorDetails&&p.$broadcast("ON_OPEN_GLOBAL_POPUP",{autoClose:!1,okLabel:"close",popupTitle:"warning",popupBody:"deviceDoesntAllowAnswer"}),i.setStatus(g.Status.UNKNOWN);var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"answerCall"))})})},C.holdCall=function(r){return s(function(t,n){if(r&&r.status!==g.Status.HOLD||t(r),!C.isSecondCallAllowed){var e=new Error("holdCall failure - Not Allowed");e.status=e.errorDetailsCode="403",v.error("[telephonyService] "+e.message),n(e)}l({method:"PUT",url:C.portalURL+"calls/"+encodeURIComponent(r.connectionId)+"/hold",headers:d.getRequestHeader()}).then(function(e){v.info("[telephonyService] holdCall success : "+anonymizePhoneNumber(r.contact.phone)+" Call ("+r+")"),r.setConnectionId(e.data.data.callId),r.setStatus(g.Status.HOLD),p.$broadcast("ON_CALL_UPDATED_EVENT",r),t(r)},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"holdCall"))})})},C.retrieveCall=function(i){return s(function(t,n){if(v.info("[telephonyService] retrieveCall : "+i.contact.displayNameForLog()),!C.isSecondCallAllowed){var e=new Error("retrieveCall failure - Not Allowed");e.status=e.errorDetailsCode="403",v.error("[telephonyService] "+e.message),n(e)}var r=C.getActiveCall();r?C.holdCall(r).then(function(){return C.retrieveCall(i)}).then(function(e){t(e)}).catch(function(e){var t="retrieveCall failure : "+e.message;v.error("[telephonyService] - callService -  "+t),n(new Error(t))}):l({method:"PUT",url:C.portalURL+"calls/"+encodeURIComponent(i.connectionId)+"/retrieve",headers:d.getRequestHeader()}).then(function(e){v.info("[telephonyService] retrieveCall success : "+anonymizePhoneNumber(i.contact.phone)+" Call ("+i+")"),i.setConnectionId(e.data.data.callId),i.setStatus(g.Status.ACTIVE),p.$broadcast("ON_CALL_UPDATED_EVENT",i),t()},function(e){var t=u.handleError(e);C.deleteCallIfInvalid(t,i),n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"retrieveCall"))})})},C.deflectCallToVM=function(r){return s(function(e,n){if(r||e(r),!C.isVMDeflectCallAllowed){var t=new Error("deflectCall failure - Not Allowed");t.status=t.errorDetailsCode="403",v.error("[telephonyService] "+t.message),n(t)}v.info("[telephonyService] deflectCallToVM "+r.contact.displayNameForLog()),l({method:"PUT",url:C.portalURL+"calls/"+encodeURIComponent(r.connectionId)+"/deflect",headers:d.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:C.voicemailNumber,calleeShortNumber:C.voicemailNumber,calleePbxId:C.pbxId}}).then(function(){v.info("[telephonyService] deflectCall success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"deflectCallToVM"))})})},C.transfertCall=function(r,i){return s(function(e,n){if(r&&i||e(),!C.isTransferAllowed){var t=new Error("transferCall failure - Not Allowed");t.status=t.errorDetailsCode="403",v.error("[telephonyService] "+t.message),n(t)}v.info("[telephonyService] transfertCall held("+i.contact.displayName+") to active("+r.contact.displayName+")"),l({method:"PUT",url:C.portalURL+"calls/"+encodeURIComponent(r.connectionId)+"/transfer/"+encodeURIComponent(i.connectionId),headers:d.getRequestHeader()}).then(function(){v.info("[telephonyService] transferCall success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"transfertCall"))})})},C.conferenceCall=function(r,i){return s(function(e,n){if(r&&i||e(),!C.isConferenceAllowed){var t=new Error("conferenceCall failure - Not Allowed");t.status=t.errorDetailsCode="403",v.error("[telephonyService] "+t.message),n(t)}v.info("[telephonyService] conferenceCall "+r.contact.displayName+" and "+i.contact.displayName),l({method:"PUT",url:C.portalURL+"calls/"+encodeURIComponent(r.connectionId)+"/conference/"+encodeURIComponent(i.connectionId),headers:d.getRequestHeader()}).then(function(){v.info("[telephonyService] conferenceCall success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"conferenceCall"))})})},C.forwardToDevice=function(i){return s(function(n,r){if(v.info("[telephonyService] forwardToDevice : "+i),!C.isForwardEnabled){var e=new Error("forwardToDevice failure - Not Allowed");e.status=e.errorDetailsCode="403",v.error("[telephonyService] "+e.message),r(e)}if(m.userContact.phonePro===i||m.userContact.phoneProCan===i||m.userContact.phonePbx===i){var t="forwardToDevice failure: impossible to forward its own phone number";v.error("[telephonyService] "+t),r(new Error(t))}m.getOrCreateContact(null,i).then(function(e){var t=C.getPhoneInfo(e,i);l({method:"PUT",url:C.portalURL+"forward",headers:d.getRequestHeader(),data:{calleeExtNumber:t.longNumber,calleeIntNumber:t.internalNumber,calleeShortNumber:t.shortNumber,calleePbxId:t.pbxId,calleeDisplayName:e.displayName}}).then(function(){n()},function(e){var t=u.handleError(e);r(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"forwardToDevice"))})})})},C.forwardToVoicemail=function(){return s(function(e,n){if(v.info("[telephonyService] forwardToVoicemail"),!C.voiceMailFeatureEnabled||!C.isForwardEnabled){var t=new Error("forwardToVoicemail failure - voicemail/forward feature not enabled");t.status=t.errorDetailsCode="404",v.error("[telephonyService] "+t.message),n(t)}l({method:"PUT",url:C.portalURL+"forward",headers:d.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:C.voicemailNumber,calleePbxId:C.pbxId}}).then(function(){v.info("[telephonyService] forwardToVoicemail success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"forwardToVoicemail"))})})},C.cancelForward=function(){return s(function(e,n){if(v.info("[telephonyService] cancelForward"),!C.isForwardEnabled){var t=new Error("cancelForward failure - Not Allowed");t.status=t.errorDetailsCode="403",v.error("[telephonyService] "+t.message),n(t)}m.userContact.phonePbx?l({method:"PUT",url:C.portalURL+"forward",headers:d.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:"CANCELFORWARD",calleePbxId:C.pbxId}}).then(function(){v.info("[telephonyService] cancelForward success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"cancelForward"))}):n()})},C.getForwardStatus=function(){return s(function(e,n){if(!C.isForwardEnabled){var t=new Error("getForwardStatus failure - Not Allowed");t.status=t.errorDetailsCode="403",v.error("[telephonyService] "+t.message),n(t)}m.userContact&&m.userContact.phonePbx?l({method:"GET",url:C.portalURL+"forward",headers:d.getRequestHeader()}).then(function(){v.info("[telephonyService] getForwardStatus success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"getForwardStatus"))}):n()})},C.getForwardObject=function(){return C.forwardObject},C.nomadicLogin=function(i,a){return s(function(n,r){if(!C.isNomadicEnabled||!C.nomadicObject.featureActivated){var e=new Error("nomadicLogin failure - Not Allowed");e.status=e.errorDetailsCode="403",v.error("[telephonyService] "+e.message),r(e)}if(m.userContact.phonePro===i||m.userContact.phoneProCan===i||m.userContact.phonePbx===i){var t="nomadicLogin failure: impossible to use its own phone number like nomadic phone";v.error("[telephonyService] "+t),r(new Error(t))}v.info("[telephonyService] nomadicLogin : "+i),a=a||!1,C.nomadicAnswerNotTakedIntoAccount=a,m.getOrCreateContact(null,i).then(function(e){var t=C.getPhoneInfo(e,i);l({method:"PUT",url:C.portalURL+"nomadic/login",headers:d.getRequestHeader(),data:{destinationExtNumber:t.longNumber,destinationIntNumber:t.internalNumber,destinationShortNumber:t.shortNumber,destinationPbxId:t.pbxId,destinationDisplayName:e.displayName,destinationCountry:e.country}}).then(function(){v.info("[telephonyService] nomadicLogin success"),n()},function(e){var t=u.handleError(e);r(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"nomadicDevice"))})})})},C.nomadicLoginOnOfficePhone=function(){return s(function(e,n){if(!C.isNomadicEnabled||!C.nomadicObject.featureActivated){var t=new Error("nomadicLoginOnOfficePhone failure - Not Allowed");t.status=t.errorDetailsCode="403",v.error("[telephonyService] "+t.message),n(t)}v.info("[telephonyService] nomadicLoginOnOfficePhone"),l({method:"PUT",url:C.portalURL+"nomadic/login",headers:d.getRequestHeader()}).then(function(){v.info("[telephonyService] nomadicLoginOnOfficePhone success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"nomadicDevice"))})})},C.nomadicLogout=function(){return s(function(e,n){if(!C.isNomadicEnabled||!C.nomadicObject.featureActivated){var t=new Error("nomadicLogout failure - Not Allowed");t.status=t.errorDetailsCode="403",v.error("[telephonyService] "+t.message),n(t)}v.info("[telephonyService] nomadicLogout"),l({method:"PUT",url:C.portalURL+"nomadic/logout",headers:d.getRequestHeader()}).then(function(){v.info("[telephonyService] nomadicLogout success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"nomadicDevice"))})})},C.getNomadicStatus=function(){return s(function(t,n){if(!C.isNomadicEnabled){var e=new Error("getNomadicStatus failure - Not Allowed");e.status=e.errorDetailsCode="403",v.error("[telephonyService] "+e.message),n(e)}m.userContact&&m.userContact.phonePbx?l({method:"GET",url:C.portalURL+"nomadic",headers:d.getRequestHeader()}).then(function(e){v.info("[telephonyService] nomadicStatus success"),C.updateNomadicData(e.data.data),t()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"getNomadicStatus"))}):n()})},C.setNomadicState=function(){return s(function(e,n){v.info("[telephonyService] setNomadicState"),l({method:"PUT",url:C.portalURL+"nomadic/state",headers:d.getRequestHeader(),data:{makeCallInitiatorIsMain:"true"}}).then(function(){v.info("[telephonyService] setNomadicState success"),e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"setNomadicState"))})})},C.updateNomadicData=function(e){if(v.info("[telephonyService] updateNomadicData destination:"+e.destination+" featureActivated:"+e.featureActivated+" makeCallInitiatorIsMain:"+e.makeCallInitiatorIsMain+" modeActivated:"+e.modeActivated),C.nomadicObject.featureActivated="true"===e.featureActivated,C.nomadicObject.modeActivated="true"===e.modeActivated,C.nomadicObject.destination=e.destination,C.nomadicObject.makeCallInitiatorIsMain="true"===e.makeCallInitiatorIsMain,C.nomadicAnswerNotTakedIntoAccount||p.$broadcast("ON_CALL_NOMADIC_EVENT",C.nomadicObject),C.nomadicAnswerNotTakedIntoAccount=!1,m.userContact.isVirtualTerm&&C.nomadicObject.featureActivated&&(""===C.nomadicObject.destination||void 0===C.nomadicObject.destination)&&(m.userContact.mobileProCan||m.userContact.mobilePerso)){var t=m.userContact.mobileProCan?m.userContact.mobileProCan:m.userContact.mobilePerso;C.nomadicLogin(t)}},C.getNomadicObject=function(){return C.nomadicObject},C.getNomadicDestination=function(){return C.nomadicObject.destination},C.sendDtmf=function(t,r){return s(function(e,n){t&&r?l({method:"PUT",url:C.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/dtmf",headers:d.getRequestHeader(),data:{dtmf:r}}).then(function(){e()},function(e){var t=u.handleError(e);n(t),v.error("[telephonyService] "+u.getErrorFullMessage(e,"sendDtmf"))}):n()})},C.clearCall=function(e,t){e.setStatus(g.Status.UNKNOWN),t||p.$broadcast("ON_CALL_UPDATED_EVENT",e),e.contact&&delete C.calls[e.contact.id],e.getCurrentCalled()&&e.setCurrentCalled(null)},C.startAsPhoneNumber=function(e){var t=e.trim().split(".").join(""),n=t.match(/^(\+|\d|#|\*|\(|\)|\.|-|\s|\/)*$/);return!!n&&n[0]===t},C.updateContactFromOutlookInfos=function(e,t,n,r){return v.info("[telephonyService] default updateContactFromOutlookInfos"),s.reject()}}]),angular.module("rainbow").factory("TelephonyServiceEventHandler",["$log","$q","$rootScope","$interval","$injector","contactService","Call","profileService","Contact","PromiseQueue",function(f,h,r,u,i,p,v,m,g,t){"use strict";function a(e){this.telephonyService=e,this.promiseQueue=t.create()}return a.create=function(e){return new a(e)},a.CallFailureLabels={DESTNOTOBTAINABLE:"outOfService",DONOTDISTURB:"dnd",TRUNKSBUSY:"trunksbusy",BUSY:"busy"},a.prototype.onCallserviceMessageReceived=function(e){try{var t=$(e),n=this;if("Offline Storage"===t.find("delay").text())return!0;var r=t.find("callservice").children(),i=r.prop("tagName").split(":"),a=i[i.length-1].toLowerCase(),o=r.attr("callId");o=o?" -- "+o:"";var s=r.attr("deviceType");s=s?" -- "+s:"";var c=r.attr("oldCallId");switch(c=c?" -- "+c:"",f.info("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- "+a.toUpperCase()+o+c+s),a){case"initiated":this.promiseQueue.add(function(){return n.onInitiatedEvent(r)});break;case"originated":this.promiseQueue.add(function(){return n.onOriginatedEvent(r)});break;case"delivered":this.promiseQueue.add(function(){return n.onDeliveredEvent(r)});break;case"established":this.promiseQueue.add(function(){return n.onEstablishedEvent(r)});break;case"retrievecall":this.promiseQueue.add(function(){return n.onRetrieveCallEvent(r)});break;case"queued":this.promiseQueue.add(function(){return n.onQueuedEvent(r)});break;case"holdcall":case"held":this.promiseQueue.add(function(){return n.onHeldEvent(r)});break;case"diverted":this.promiseQueue.add(function(){return n.onDivertedEvent(r)});break;case"transfercall":case"transferred":this.promiseQueue.add(function(){return n.onTransferEvent(r)});break;case"conferenced":this.promiseQueue.add(function(){return n.onConferenceEvent(r)});break;case"connectioncleared":this.promiseQueue.add(function(){return n.onClearCallEvent(r)});break;case"failed":this.promiseQueue.add(function(){return n.onFailCallEvent(r)});break;case"messaging":this.promiseQueue.add(function(){return n.onVoiceMessageEvent(r)});break;case"updatecall":this.promiseQueue.add(function(){return n.onUpDateCallEvent(r)});break;case"forwarded":this.promiseQueue.add(function(){return n.onCallForwardedEvent(r)});break;case"callsubject":this.promiseQueue.add(function(){return n.onCallSubjectEvent(r)});break;case"nomadicstatus":this.promiseQueue.add(function(){return n.onCallNomadicEvent(r)});break;case"openDesktop":f.info("[TelephonyServiceEventHandler] openDesktop detected ")}return!0}catch(e){return f.error("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- failure -- "+e.message),!0}},a.prototype.onInitiatedEvent=function(o){f.info("[TelephonyServiceEventHandler] onInitiatedEvent");var s=this;return this.getCall(o).then(function(t){try{var e=o.attr("endpointIm"),n=o.attr("endpointTel"),r=o.attr("deviceState"),i=o.attr("newCallId");return void 0!==i&&s.getOrCreateCall(i,e,n).then(function(e){"LCI_CONNECTED"===r&&e.setStatus(v.Status.ACTIVE),s.telephonyService.clearCall(t),s.sendCallUpdateEvent(t),s.sendCallUpdateEvent(e),delete s.telephonyService.calls[t.id]}),h.when()}catch(e){var a="onInitiatedEvent -- "+e.message;return f.error("[TelephonyServiceEventHandler] "+a),h.reject(new Error(a))}})},a.prototype.onOriginatedEvent=function(a){return f.info("[TelephonyServiceEventHandler] onOriginatedEvent"),this.getCall(a).then(function(e){try{var t=a.attr("endpointIm"),n=a.attr("endpointTel"),r={contactPhoneNumber:"",contact:e.contact,participantsPhoneNumbers:null,participants:null};return t||n?r.contactPhoneNumber=n||"":e.contact&&e.contact.temp&&(r.contactPhoneNumber=e.contact.id),e.setCurrentCalled(r),h.when()}catch(e){var i="onOriginatedEvent -- "+e.message;return f.error("[TelephonyServiceEventHandler] "+i),h.reject(new Error(i))}})},a.prototype.onDeliveredEvent=function(a){f.info("[TelephonyServiceEventHandler] onDeliveredEvent");var o=this;return this.getCall(a).then(function(e){try{if(o.computeCallRelevancy(a,e),e.status===v.Status.QUEUED_INCOMMING)return h.resolve();var t=a.attr("type"),n=a.attr("endpointIm"),r=a.attr("endpointTel");return e.setStatus("outgoing"===t?v.Status.RINGING_OUTGOING:v.Status.RINGING_INCOMMING),e.startDate=null,e.vm=!1,o.updateCallContact(n,r,a,e)}catch(e){var i="onDeliveredEvent -- "+e.message;return f.error("[TelephonyServiceEventHandler] "+i),h.reject(new Error(i))}})},a.prototype.onEstablishedEvent=function(c){f.info("[TelephonyServiceEventHandler] onEstablishedEvent");var l=this;return this.getCall(c).then(function(t){try{l.computeCallRelevancy(c,t);var e=c.attr("endpointIm"),n=c.attr("endpointTel"),r=c.attr("callId");if(t.contact&&t.contact.id)return t.setStatus(v.Status.ACTIVE),t.setConnectionId(r),l.sendCallUpdateEvent(t,c),l.updateCallContact(e,n,c,t);if(t.participants&&0<t.participants.length){for(var i=null,a=0;a<t.participants.length&&!i;a++)t.participants[a].id===e?i=t.participants[a]:t.currentCalled.participantsPhoneNumbers&&0<t.currentCalled.participantsPhoneNumbers.length&&t.currentCalled.participantsPhoneNumbers[a]===n&&(i=t.participants[a]);t.participants=[],t.isConference=!1;var o=t.getCurrentCalled();if(!i)return e||n||(n="****"),p.getOrCreateContact(e,n).then(function(e){return t.setContact(e),t.setStatus(v.Status.ACTIVE),o={contactPhoneNumber:n,contact:e},t.setCurrentCalled(o),l.sendCallUpdateEvent(t,c),h.when()});t.setContact(i),t.setStatus(v.Status.ACTIVE),o={contactPhoneNumber:n,contact:i},t.setCurrentCalled(o),l.sendCallUpdateEvent(t,c)}return h.when()}catch(e){var s="onEstablishedEvent -- "+e.message;return f.error("[TelephonyServiceEventHandler] "+s),h.reject(new Error(s))}})},a.prototype.onRetrieveCallEvent=function(t){f.info("[TelephonyServiceEventHandler] onRetrieveCallEvent");var n=this;return this.getCall(t).then(function(e){e.setStatus(v.Status.ACTIVE),n.computeCallRelevancy(t,e),n.sendCallUpdateEvent(e,t)})},a.prototype.onClearCallEvent=function(t){var n=this,e=t.attr("callId"),r=v.getIdFromConnectionId(e);return f.info("[TelephonyServiceEventHandler] onClearCallEvent, connectionId: "+e),this.telephonyService.calls[r]?this.getCall(t).then(function(e){n.computeCallRelevancy(t,e),e.status!==v.Status.ERROR&&(n.telephonyService.clearCall(e,!0),n.sendCallUpdateEvent(e,t))}):h.resolve()},a.prototype.onHeldEvent=function(r){f.info("[TelephonyServiceEventHandler] onHeldEvent");var i=this;return this.getCall(r).then(function(e){try{var t=r.attr("callId");return t||(t=r.attr("heldCallId")),v.getDeviceIdFromConnectionId(e.connectionId)===v.getDeviceIdFromConnectionId(t)?e.setStatus(v.Status.HOLD):e.setStatus(v.Status.PUT_ON_HOLD),i.sendCallUpdateEvent(e,r),h.when()}catch(e){var n="onHeldEvent -- "+e.message;return f.error("[TelephonyServiceEventHandler] "+n),h.reject(new Error(n))}})},a.prototype.onQueuedEvent=function(o){f.info("[TelephonyServiceEventHandler] onQueuedEvent");var s=this,e=o.attr("cause");return"PARK"===e?(f.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore PARK cause"),h.when()):"NEWCALL"===e?(f.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore NEWCALL cause"),h.when()):this.getCall(o).then(function(e){try{s.computeCallRelevancy(o,e);var t=o.attr("type"),n=o.attr("endpointIm"),r=o.attr("endpointTel"),i="outgoing"===t?v.Status.QUEUED_OUTGOING:v.Status.QUEUED_INCOMMING;return e.setStatus(i),e.startDate=null,e.vm=!1,e.relevantEquipmentId=v.getDeviceIdFromConnectionId(e.connectionId),s.updateCallContact(n,r,o,e)}catch(e){var a="onQueuedEvent -- "+e.message;return f.error("[TelephonyServiceEventHandler] "+a),h.reject(new Error(a))}})},a.prototype.onDivertedEvent=function(e){f.info("[TelephonyServiceEventHandler] onDivertedEvent");var t=e.attr("oldCallId"),n=v.getIdFromConnectionId(t),r=this.telephonyService.calls[n];return r?(this.computeCallRelevancy(e,r),i.get("webrtcGatewayService").isMediaPillarCallCase()?r.isSecondary?this.telephonyService.clearCall(r):this.telephonyService.clearCall(r,!0):this.telephonyService.clearCall(r),this.sendCallUpdateEvent(r,e)):f.warn("[TelephonyServiceEventHandler] onDivertedEvent - receive divertedEvent on unknown call --- ignored"),h.when()},a.prototype.onTransferEvent=function(t){f.info("[TelephonyServiceEventHandler] onTransferEvent");var n=this,e=t.attr("activeCallId"),r=t.attr("heldCallId"),i=t.attr("newCallId"),a=v.getIdFromConnectionId(e),o=this.telephonyService.calls[a];if(r){var s=v.getIdFromConnectionId(r),c=this.telephonyService.calls[s];c.setStatus(v.Status.UNKNOWN),o.setStatus(v.Status.UNKNOWN),n.sendCallUpdateEvent(c),n.sendCallUpdateEvent(o)}if(i){var l=t.attr("newEndpointIm"),d=t.attr("newEndpointTel"),u=t.attr("deviceState");return u||(u=t.attr("deviceStatus")),o.setStatus(v.Status.UNKNOWN),n.sendCallUpdateEvent(o),l||d||(d="****"),this.getOrCreateCall(i,l,d).then(function(e){return u&&"LCI_ALERTING"===u?e.setStatus(v.Status.RINGING_INCOMMING):e.setStatus(v.Status.ACTIVE),e.relevantEquipmentId=v.getDeviceIdFromConnectionId(i),n.updateCallContact(l,d,t,e)})}return h.resolve()},a.prototype.onConferenceEvent=function(e){f.info("[TelephonyServiceEventHandler] onConferenceEvent");var i=this,t=e.find("primaryOldCallId").text(),n=e.find("secondaryOldCallId").text(),r=e.find("newCallId").text(),a=v.getIdFromConnectionId(t),o=v.getIdFromConnectionId(n),s=this.telephonyService.calls[a],c=this.telephonyService.calls[o],l=[],d=[],u=[];return e.find("participant").each(function(){var e=angular.element(this),r=e.find("endpointTel").text(),t=e.find("endpointIm").text();t&&p.isUserContactJid(t)||d.push(h(function(n,e){t||r||(r="****"),!t&&s&&s.contact&&s.currentCalled.contactPhoneNumber===r?(l.push(s.contact),u.push(r),n()):!t&&c&&c.contact&&c.currentCalled.contactPhoneNumber===r?(l.push(c.contact),u.push(r),n()):p.getOrCreateContact(t,r).then(function(t){l.push(t),u.push(r),i.telephonyService.updateContactFromOutlookInfos(t,r).then(function(e){e?f.debug("[TelephonyServiceEventHandler] on conferenced, update from outlook for contact :"+t.displayNameMD5):f.debug("[TelephonyServiceEventHandler] on conferenced, no update from outlook for contact :"+t.displayNameMD5)},function(){f.debug("[TelephonyServiceEventHandler] on conferenced, no Outlook search available")}).finally(function(){n()})}).catch(function(e){f.error("[TelephonyServiceEventHandler] onConferenceEvent - Impossible to get contact - "+e.message),n()})}))}),h.all(d).finally(function(){var e=!1;s&&(e=e||s.isSecondary,s.setStatus(v.Status.UNKNOWN),f.debug("[TelephonyServiceEventHandler] on conferenced, updated primaryOldCall: "+s),i.sendCallUpdateEvent(s)),c&&(e=e||c.isSecondary,c.setStatus(v.Status.UNKNOWN),f.debug("[TelephonyServiceEventHandler] on conferenced, updated secondaryOldCall: "+s),i.sendCallUpdateEvent(c));var t=i.createConferenceCall(r,l),n=t.getCurrentCalled();n.participants=l,n.participantsPhoneNumbers=u,t.setCurrentCalled(n),t.setStatus(v.Status.ACTIVE),t.relevantEquipmentId=v.getDeviceIdFromConnectionId(r),t.isSecondary=e,f.debug("[TelephonyServiceEventHandler] on conferenced, create new call: "+t),i.sendCallUpdateEvent(t)})},a.prototype.onVoiceMessageEvent=function(e){if(f.info("[TelephonyServiceEventHandler] onVoiceMessageEvent"),!m.isFeatureEnabled(m.FeaturesEnum.TELEPHONY_VOICE_MAIL))return f.info("[TelephonyServiceEventHandler] onVoiceMessageEvent feature not enabled => IGNORED event"),h.when();var t=e.find("voiceMessageCounter").text();if(t){var n=Number(t);Number.isInteger(n)&&0<=n&&(this.telephonyService.voiceMail.setVMCounter(n),this.telephonyService.voiceMail.setVMFlag(0<n),this.telephonyService.voiceMail.setInfoMsg(""),r.$broadcast("ON_VOICE_MESSAGE_UPDATE_EVENT",n))}return"changed"===e.find("voiceMessageWaiting").text()&&this.telephonyService.getVoiceMessageCounter(),h.when()},a.prototype.onUpDateCallEvent=function(l){f.info("[TelephonyServiceEventHandler] onUpDateCallEvent");var d=this;return this.getCall(l).then(function(r){var i=l.attr("endpointIm"),a=l.attr("endpointTel"),o="",s="",e=l.find("identity").attr("firstName"),t=l.find("identity").attr("lastName"),n=l.find("identity").attr("displayName"),c=!1;if(!config.permitSearchFromPhoneBook&&!m.isFeatureEnabled(m.FeaturesEnum.TELEPHONY_PHONE_BOOK))return f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not allowed for the user profile => IGNORED event"),h.when();if(t&&t.length)s=t,e&&e.length&&(o=e),f.info("[TelephonyServiceEventHandler] onUpDateCallEvent received for call "+r.id+" for phoneNumber:"+anonymizePhoneNumber(a)+" with name : "+o.slice(0,1)+"***");else{if(!n||!n.length||n===a)return f.info("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not available => IGNORED event"),h.when();s=n,f.info("[TelephonyServiceEventHandler] onUpDateCallEvent only displayName available")}return p.getOrCreateContact(i,a).then(function(e){if(e.temp){if(e.updateName(o,s),r.contact&&r.contact.id){var t={contactPhoneNumber:a,contact:e};r.contact.id===e.id&&r.contact.displayName!==a&&r.contact.getNameUpdatePrio()!==g.NameUpdatePrio.OUTLOOK_UPDATE_PRIO||(e.setNameUpdatePrio(g.NameUpdatePrio.SERVER_UPDATE_PRIO),r.setContact(e),r.setCurrentCalled(t),c=!0,f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames updated for "+a+"with contact : "+e.displayNameMD5))}else if(r.participants&&0<r.participants.length){t=r.getCurrentCalled();for(var n=0;n<r.participants.length;n++)r.participants[n].temp?r.participants[n].phoneProCan&&r.participants[n].phoneProCan===a&&(f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+r.participants[n].displayNameMD5+" updated with : "+e.displayNameMD5),r.participants[n]=e,r.participants[n].setNameUpdatePrio(g.NameUpdatePrio.SERVER_UPDATE_PRIO),t.participantsPhoneNumbers[n]=a,t.participants[n]=e,c=!0):f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent STRANGE former participant was a rainbow: "+r.participants[n].displayNameMD5);r.setCurrentCalled(t)}}else if(r.contact&&r.contact.id){t={contactPhoneNumber:a,contact:e};r.contact.id!==e.id&&(r.contact.temp&&(r.contact.updateName(o,s),r.contact.setNameUpdatePrio(g.NameUpdatePrio.SERVER_UPDATE_PRIO)),r.setContact(e),r.setCurrentCalled(t),c=!0,f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent call update with rainbow contact : "+e.displayNameMD5))}else if(r.participants&&0<r.participants.length){for(t=r.getCurrentCalled(),n=0;n<r.participants.length;n++)r.participants[n].temp?r.participants[n].phoneProCan&&r.participants[n].phoneProCan===a&&(f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+r.participants[n].displayNameMD5+" updated with : "+e.displayNameMD5),r.participants[n]=e,r.setParticipants(r.participants),t.participantsPhoneNumbers[n]=a,t.participants[n]=e,c=!0):r.participants[n].jid===i?(t.participantsPhoneNumbers[n]=a,t.participants[n]=r.participants[n],c=!0,f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent rainbow participant "+r.participants[n].displayNameMD5+" updated with the same : "+e.displayNameMD5)):f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent other participant not updated : "+r.participants[n].displayNameMD5+" vs "+e.displayNameMD5);r.setCurrentCalled(t)}c?u(function(){d.sendCallUpdateEvent(r)},300,1):f.debug("[TelephonyServiceEventHandler] onUpDateCallEvent, no update needed for call : "+r.id)})})},a.prototype.onFailCallEvent=function(t){f.info("[TelephonyServiceEventHandler] onFailCallEvent");var n=t.attr("cause"),r=this;return this.getCall(t).then(function(e){e.setStatus(v.Status.ERROR),e.errorMessage=a.CallFailureLabels[n],e.autoClear=u(function(){r.telephonyService.clearCall(e)},5e3,1),e.errorMessage||(e.errorMessage=n),r.sendCallUpdateEvent(e,t)})},a.prototype.onCallNomadicEvent=function(e){f.info("[TelephonyServiceEventHandler] onCallNomadicEvent");var t={destination:e.attr("destination"),featureActivated:e.attr("featureActivated"),makeCallInitiatorIsMain:e.attr("makeCallInitiatorIsMain"),modeActivated:e.attr("modeActivated")};return this.telephonyService.updateNomadicData(t),h.when()},a.prototype.onCallForwardedEvent=function(e){return f.info("[TelephonyServiceEventHandler] onCallForwardedEvent"),r.$broadcast("ON_CALL_FORWARDED_EVENT",{forwardType:e.attr("forwardType"),forwardTo:e.attr("forwardTo")}),this.telephonyService.forwardObject.forwardType=e.attr("forwardType"),this.telephonyService.forwardObject.forwardTo=e.attr("forwardTo"),h.when()},a.prototype.onCallSubjectEvent=function(n){f.info("[TelephonyServiceEventHandler] onCallSubjectEvent");var r=this;return this.getCall(n).then(function(e){try{e.subject=n.find("subject").text(),e.subject&&r.sendCallUpdateEvent(e)}catch(e){var t="onCallSubjectEvent -- "+e.message;f.error("[TelephonyServiceEventHandler] "+t),h.reject(new Error(t))}})},a.prototype.computeCallRelevancy=function(e,t){var n=e.attr("callId"),r=e.attr("deviceType"),i=v.getDeviceIdFromConnectionId(n),a=this.telephonyService.getNomadicObject(),o=a.makeCallInitiatorIsMain;r||(r="MAIN"),a.modeActivated||(o=!0),"MAIN"===r&&o&&(t.relevantEquipmentId=i,t.connectionId=n),"SECONDARY"!==r||o||(t.relevantEquipmentId=i,t.connectionId=n),t.isSecondary=r&&"SECONDARY"===r&&!o,f.info("[TelephonyServiceEventHandler] computeCallRelevancy -- relevantEquipmentId : "+t.relevantEquipmentId)},a.prototype.getCall=function(i){var a=this;return h(function(t){var e=i.attr("endpointIm"),n=i.attr("endpointTel"),r=i.attr("callId");a.getOrCreateCall(r,e,n).then(function(e){t(e)})})},a.prototype.getOrCreateCall=function(n,e,r){f.debug("[TelephonyServiceEventHandler] getCall - "+n+" - "+anonymizePhoneNumber(r)+" - "+e);var i=this,t=v.getIdFromConnectionId(n),a=this.telephonyService.calls[t];return a?h.when(a):h(function(t){e||r?p.getOrCreateContact(e,r).then(function(e){t(i.telephonyService.getOrCreateCall(v.Status.UNKNOWN,n,e))}):t(i.telephonyService.getOrCreateCall(v.Status.UNKNOWN,n))})},a.prototype.createConferenceCall=function(e,t){var n=v.create(v.Status.UNKNOWN,null,v.Type.PHONE);return n.setConnectionId(e),n.isConference=!0,n.setParticipants(t),this.telephonyService.calls[n.id]=n},a.prototype.sendCallUpdateEvent=function(e,t){var n=this.extractInfoEvent(t);r.$broadcast("ON_CALL_UPDATED_EVENT",e,n)},a.prototype.extractInfoEvent=function(e){var t={actionElemName:"",cause:""};if(e&&null!==e){var n=e.prop("tagName").split(":");t.actionElemName=n[n.length-1].toLowerCase(),t.cause=e.attr("cause"),t.cause=t.cause?t.cause:""}else t=null;return t},a.prototype.analyzeContactChange=function(e,t,n){var r=!1,i=!1;return e||t?n.isConference?void 0:n.contact?(""!==e?n.contact.id!==e&&(i=!(r=!0)):n.contact.temp?n.contact.id!==t?i=r=!0:n.contact.displayName===t&&(i=!(r=!1)):""!==n.getCurrentCalled().contactPhoneNumber&&""!==t&&n.getCurrentCalled().contactPhoneNumber!==t&&(i=r=!0),r||i?{updateContactToBeDone:r,searchOutlookToBeDone:i}:null):{updateContactToBeDone:!0,searchOutlookToBeDone:!0}:null},a.prototype.updateCallContact=function(e,n,r,i){var a=this,t=r.prop("tagName").split(":"),o=t[t.length-1].toLowerCase();try{var s=a.analyzeContactChange(e,n,i);return i.isConference||""===n||i.setCurrentCalledContactNumber(n),s?p.getOrCreateContact(e,n).then(function(t){return s.searchOutlookToBeDone?a.telephonyService.updateContactFromOutlookInfos(t,n).then(function(e){e?(f.debug("[TelephonyServiceEventHandler] on "+o+", update from outlook for contact :"+t.displayNameMD5),a.makeUpdateContact(i,t,n,o)):(f.debug("[TelephonyServiceEventHandler] on "+o+", no update from outlook for contact :"+t.displayNameMD5),s.updateContactToBeDone?(f.debug("[TelephonyServiceEventHandler] on "+o+", update contact :"+t.displayNameMD5),a.makeUpdateContact(i,t,n,o)):a.sendCallUpdateEvent(i,r))},function(){f.debug("[TelephonyServiceEventHandler] on "+o+", no Outlook search available"),s.updateContactToBeDone?(f.debug("[TelephonyServiceEventHandler] on "+o+", update contact :"+t.displayNameMD5),a.makeUpdateContact(i,t,n,o)):a.sendCallUpdateEvent(i,r)}):(f.debug("[TelephonyServiceEventHandler] on "+o+", update contact :"+t.displayNameMD5),a.makeUpdateContact(i,t,n,o),h.when())}):(a.sendCallUpdateEvent(i,r),h.when())}catch(e){var c="updateCallContact -- "+e.message;return f.error("[TelephonyServiceEventHandler] "+c),h.reject(new Error(c))}},a.prototype.makeUpdateContact=function(e,t,n,r){var i=this;e.setContact(t);var a={contactPhoneNumber:n,contact:t};e.setCurrentCalled(a),"delivered"===r&&e.status===v.Status.RINGING_INCOMMING?u(function(){i.sendCallUpdateEvent(e)},300,1):i.sendCallUpdateEvent(e)},a}]),angular.module("rainbow").service("directoryService",["$q","$rootScope","$log","$http","contactService","authService","orderByFilter","conversationService",function(t,s,c,l,d,u,f,h){"use strict";this.search=function(a,o,n){return c.info("[directoryService] searchContact with text "+a),t(function(i,t){n||(n=20);var e=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit="+n+"&displayName="+encodeURIComponent(a);l({method:"GET",url:e,headers:u.getRequestHeader()}).then(function(e){var t=e.data.data;c.info("[directoryService] search find "+t.length+" contact(s)");var n=[];if(t.forEach(function(e){if(!d.isUserContactJid(e.jid_im)){var t;if(!(t=d.getContactByJid(e.jid_im)))(t=d.createBasicContact(e.jid_im)).updateFromUserData(e),t.getAvatar(),d.dbContacts[e.id]=t,d.jtelContacts[t.jidtel]=t;t.dbId=e.id,t.updateRichStatus(),h.computeCapabilitiesForContact(t,!1),n.push(t)}}),o){var r=d.searchContacts(a);n=n.concat(r.filter(function(e){return e.roster&&n.indexOf(e)<0}))}n=f(n,"_displayName",!1),i(n)},function(e){401===e.data.errorCode&&s.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),c.warn("[directoryService] searchContact failure "+e.data.errorMsg),t(new Error("Directory service failure"))})})},this.searchUserByLogin=function(n){c.info('[directoryService] searchUserByLogin with "'+n+'"');var r=t.defer(),e=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/";return l({method:"POST",url:e+"users/loginEmails",headers:u.getPostHeader(),data:{loginEmail:[n]}}).then(function(e){var t=e.data.data;1===t.length?d.getOrCreateContact(t[0].jid_im).then(function(e){e.loginEmail=n,r.resolve(e)}).catch(function(){r.resolve(null)}):r.resolve(null)},function(e){401===e.data.errorCode&&s.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),c.warn('[directoryService] searchUserByLogin with "'+n+'" failure'),r.reject(new Error('Directory searchUserByLogin with "'+n+'" failure'))}),r.promise},this.searchUserByJid=function(n){c.info('[directoryService] searchUserByJid with "'+n+'"');var r=t.defer(),e=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/users/jids/";return l({method:"GET",url:e+encodeURIComponent(n),headers:u.getRequestHeader()}).then(function(e){var t=e.data;t?d.getOrCreateContact(n).then(function(e){e.updateFromUserData(t.data),r.resolve(e)}).catch(function(){r.resolve(null)}):r.resolve(null)},function(e){401===e.data.errorCode&&s.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),c.warn('[directoryService] searchUserByJid with "'+n+'" failure'),r.reject(new Error('Directory searchUserByJid with "'+n+'" failure'))}),r.promise}}]),angular.module("rainbow").service("invitationService",["$q","$log","$http","$rootScope","authService","Invitation","contactService","xmppService","errorHelperService","settingsService","PromiseQueue",function(a,o,s,r,c,i,l,e,d,u,f){"use strict";var h=this;h.start=function(e){o.info(""),o.info("[invitationService] === STARTING ===");var t=performance.now();h.receivedInvitations={},h.sentInvitations={},h.acceptedInvitationsArray=[],h.sentInvitationsArray=[],h.receivedInvitationsArray=[],h.listeners=[],this.promiseQueue=f.create(),h.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/",h.attachHandlers(),h.getAllSentInvitations(),h.getAllReceivedInvitations();var n=Math.round(performance.now()-t);return e.push({service:"invitationService",startDuration:n}),o.info("[invitationService] === STARTED ("+n+" ms) ==="),h.listeners.push(r.$on("ON_ROSTER_CHANGED_EVENT",h.getAllSentInvitations)),a.when()},h.stop=function(){var e;if(o.info(""),o.info("[invitationService] === STOPPING ==="),h.listeners)for(;e=h.listeners.pop();)e();return o.info("[invitationService] === STOPPED ==="),a.when()},h.attachHandlers=function(){o.info("[invitationService] attachHandlers"),h.contactConfigRef&&(e.connection.deleteHandler(h.contactConfigRef),h.contactConfigRef=null),h.contactConfigRef=e.connection.addHandler(h.onInvitationsUpdate,null,"message","management")},h.onInvitationsUpdate=function(e){var t=$(e).find("userinvite");if(t.length){var n=t.attr("id"),r=t.attr("type"),i=t.attr("action");switch(r){case"received":h.handleReceivedInvitation(n,i);break;case"sent":h.handleSentInvitation(n,i);break;default:o.warn("[invitationService] onInvitationsUpdate - received unexpected type - "+r)}}return!0},h.handleReceivedInvitation=function(e,t){o.info("[invitationService] handleReceivedInvitation"),"delete"===t?(delete h.receivedInvitations[e],h.updateReceivedInvitationsArray()):h.getServerInvitation(e).then(function(e){var t=null,n="none";switch(e.status){case"pending":t=h.receivedInvitations[e.id]=e,n="ask";break;case"accepted":case"auto-accepted":h.receivedInvitations[e.id]=e,r.$broadcast("ON_INVITATION_ACCEPTED",e.invitingUserId);break;default:delete h.receivedInvitations[e.id],n="unknown"}e.invitingUserId?h.updateContactInvitationStatus(e.invitingUserId,n,t).then(function(){h.updateReceivedInvitationsArray()}):h.updateReceivedInvitationsArray(),r.$broadcast("ON_INVITATION_CHANGED",e)})},h.handleSentInvitation=function(e,t){return a(function(n){o.info("[invitationService] handleSentInvitation"),"delete"===t?(delete h.sentInvitations[e],h.updateReceivedInvitationsArray(),n()):(h.getServerInvitation(e).then(function(e){var t=null;switch(e.status){case"pending":h.sentInvitations[e.id]=e,t="wait";break;case"accepted":case"auto-accepted":r.$broadcast("ON_INVITATION_ACCEPTED",e.invitedUserId);break;default:delete h.sentInvitations[e.id],t="unknown"}e.invitedUserId?h.updateContactInvitationStatus(e.invitedUserId,t,e).then(function(){h.updateSentInvitationsArray(),n()}):(h.updateSentInvitationsArray(),n())}),"resend"===t&&r.$broadcast("ON_INVITATIONS_RE_SEND",e))})},h.updateReceivedInvitationsArray=function(){for(var e in h.receivedInvitationsArray=[],h.acceptedInvitationsArray=[],h.receivedInvitations)if(h.receivedInvitations.hasOwnProperty(e)){var t=h.receivedInvitations[e];switch(t.status){case"pending":h.receivedInvitationsArray.push(t);break;case"accepted":case"auto-accepted":h.acceptedInvitationsArray.push(t)}}h.receivedInvitationsArray.sort(h.sortInvitationArray),h.acceptedInvitationsArray=h.acceptedInvitationsArray.filter(function(e){var t=moment(e.lastNotificationDate);return moment.duration(moment().diff(t)).asHours()<168}),h.acceptedInvitationsArray.sort(h.sortInvitationArray),r.$broadcast("ON_INVITATIONS_NUMBER_UPDATED")},h.updateSentInvitationsArray=function(){for(var e in h.sentInvitationsArray=[],h.sentInvitations)h.sentInvitations.hasOwnProperty(e)&&h.sentInvitationsArray.push(h.sentInvitations[e]);h.sentInvitationsArray.sort(h.sortInvitationArray),r.$broadcast("ON_INVITATIONS_NUMBER_UPDATED")},h.getServerInvitation=function(e){return a(function(n,r){s({method:"GET",url:h.portalURL+l.userContact.dbId+"/invitations/"+e,headers:c.getRequestHeader()}).then(function(e){o.info("[invitationService] getServerInvitation success");var t=i.createFromData(e.data.data);n(t)},function(e){var t=d.handleError(e);r(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"getServerInvitation"))})})},h.getReceivedInvitations=function(){return h.receivedInvitationsArray},h.getAcceptedInvitations=function(){return h.acceptedInvitationsArray},h.getSentInvitations=function(){return h.sentInvitationsArray},h.getInvitationsNumberForCounter=function(){return h.receivedInvitationsArray.length},h.getAllInvitationsNumber=function(){return h.receivedInvitationsArray.length+h.sentInvitationsArray.length+h.acceptedInvitationsArray.length},h.getInvitation=function(e){var t=h.receivedInvitations[e];return t||(t=h.acceptedInvitationsArray[e]),t||(t=h.sentInvitations[e]),t},h.joinContactInvitation=function(t){return a(function(e,n){o.info("[invitationService] joinContactInvitation contact ("+t.jid+")"),s({method:"POST",url:h.portalURL+l.userContact.dbId+"/invitations",headers:c.getRequestHeader(),data:{invitedUserId:t.dbId}}).then(function(){o.info("[invitationService] joinContactInvitation - success ("+t.jid+")"),"unknown"===t.status&&h.updateContactInvitationStatus(t.dbId,"wait"),e()},function(e){var t=d.handleError(e);n(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"joinContactInvitation"))})})},h.sendInvitationByEmail=function(r,i){return a(function(e,n){var t=u.getAppliLanguageCodeForServer();o.info("[invitationService] sendInvitationByEmail"),s({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/notifications/emails/invite-by-end-user",headers:c.getRequestHeader(),data:{email:r,lang:t,customMessage:i}}).then(function(){o.info("[invitationService] sendInvitationByEmail - success"),e()},function(e){var t=d.handleError(e);n(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"sendInvitationByEmail"))})})},h.cancelOneSendInvitation=function(t){return a(function(e,n){s({method:"POST",url:h.portalURL+t.invitingUserId+"/invitations/"+t.id+"/cancel",headers:c.getRequestHeader()}).then(function(){o.info("[invitationService] cancelOneSendInvitation success"),e()},function(e){var t=d.handleError(e);n(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"cancelOneSendInvitation"))})})},h.reSendInvitation=function(t){return a(function(e,n){s({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+l.userContact.dbId+"/invitations/"+t+"/re-send",headers:c.getRequestHeader()}).then(function(){o.info("[invitationService] reSendInvitation "+t+" - success"),e()},function(e){var t=d.handleError(e);n(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"reSendInvitation"))})})},h.sendInvitationsParBulk=function(t){return!t.length||100<t.length?(o.error("[invitationService] sendInvitationsParBulk mail list length not correct"),a.reject()):a(function(e,n){s({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+l.userContact.dbId+"/invitations/bulk",headers:c.getRequestHeader(),data:{emails:t}}).then(function(){o.info("[invitationService] sendInvitationsParBulk - success"),e()},function(e){var t=d.handleError(e);n(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"sendInvitationsParBulk"))})})},h.acceptInvitation=function(t){return a(function(e,n){s({method:"POST",url:h.portalURL+t.invitedUserId+"/invitations/"+t.id+"/accept",headers:c.getRequestHeader()}).then(function(){o.info("[invitationService] acceptInvitation success"),e()},function(e){var t=d.handleError(e);n(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"acceptInvitation"))})})},h.declineInvitation=function(t){return a(function(e,n){s({method:"POST",url:h.portalURL+t.invitedUserId+"/invitations/"+t.id+"/decline",headers:c.getRequestHeader()}).then(function(){o.info("[invitationService] declineInvitation success"),e()},function(e){var t=d.handleError(e);n(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"declineInvitation"))})})},h.updateContactInvitationStatus=function(e,n,r){return a(function(t){l.getContactByDBId(e).then(function(e){switch(n){case"ask":e.status="unknown",e.ask="ask",e.invitation=r;break;case"wait":e.status="wait",e.ask="subscribe",e.invitation=r;break;default:e.ask="none",e.invitation=null}e.updateRichStatus(),t()})})},h.sortInvitationArray=function(e,t){return new Date(t.lastNotificationDate)-new Date(e.lastNotificationDate)},h.getAllReceivedInvitations=function(){return a(function(n,r){s({method:"GET",url:h.portalURL+l.userContact.dbId+"/invitations/received?format=full&status=pending&status=accepted&status=auto-accepted&limit=500",headers:c.getRequestHeader()}).then(function(e){var t=e.data.data;o.info("[invitationService] getAllReceivedInvitations success (find "+t.length+" invitations)"),h.receivedInvitations={},h.acceptedInvitations={},t.forEach(function(e){if("pending"===e.status&&"registration"!==e.type){var t=i.createFromData(e);h.receivedInvitations[e.id]=t,e.invitingUserId&&h.updateContactInvitationStatus(e.invitingUserId,"ask",t)}else"accepted"!==e.status&&"auto-accepted"!==e.status||(h.receivedInvitations[e.id]=i.createFromData(e))}),h.updateReceivedInvitationsArray(),n(h.receivedInvitations)},function(e){var t=d.handleError(e);r(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"getAllReceivedInvitations"))})})},h.getAllSentInvitations=function(){return a(function(n,r){s({method:"GET",url:h.portalURL+l.userContact.dbId+"/invitations/sent?format=full&status=pending&limit=500",headers:c.getRequestHeader()}).then(function(e){var t=e.data.data;o.info("[invitationService] getAllSentInvitations success (find "+t.length+" invitations)"),h.sentInvitations={},t.forEach(function(e){if("pending"===e.status&&!e.inviteToJoinMeeting){var t=i.createFromData(e);void 0!==(h.sentInvitations[e.id]=t).invitedUserId&&h.updateContactInvitationStatus(t.invitedUserId,"wait",t)}}),h.updateSentInvitationsArray(),n(h.sentInvitations)},function(e){var t=d.handleError(e);r(t),o.error("[invitationService] "+d.getErrorFullMessage(e,"getAllSentInvitations"))})})}}]),angular.module("rainbow").service("roomService",["$q","$log","$rootScope","$http","$filter","$interval","authService","contactService","fileStorageService","xmppService","Room","utilService","profileService","errorHelperService","randomString","orderByFilter","$translate",function(f,b,R,h,p,d,v,y,r,u,T,I,i,o,a,t,s){"use strict";var N=this;N.ROOM_UPDATE_EVENT="ROOM_UPDATE_EVENT",N.ROOM_AVATAR_UPDATE_EVENT="ROOM_AVATAR_UPDATE_EVENT",N.ROOM_HISTORY_UPDATE_EVENT="ROOM_HISTORY_UPDATE_EVENT",N.ROOM_ADMIN_MESSAGE_EVENT="ROOM_ADMIN_MESSAGE_EVENT",N.ROOM_INVITATION="ROOM_INVITATION",N.ROOM_ADD_CONF_ENDPOINT_EVENT="ROOM_ADD_CONF_ENDPOINT_EVENT",N.ROOM_REMOVE_CONF_ENDPOINT_EVENT="ROOM_REMOVE_CONF_ENDPOINT_EVENT",N.ROOM_ADD_USERS_EVENT="ROOM_ADD_USERS_EVENT",N.ROOM_DELETE_USERS_EVENT="ROOM_DELETE_USERS_EVENT",N.ROOM_ADD_CONF_GUESTS_EVENT="ROOM_ADD_CONF_GUESTS_EVENT",N.ROOM_DELETE_CONF_GUESTS_EVENT="ROOM_DELETE_CONF_GUESTS_EVENT",N.RoomUserStatus={INVITED:"invited",ACCEPTED:"accepted",UNSUBSCRIBED:"unsubscribed",REJECTED:"rejected",DELETED:"deleted"},N.listeners=[],N.start=function(r){return f(function(t){var n=performance.now();b.info(""),b.info("[roomService] === STARTING ==="),N.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",N.invitationCounter=0,N.meetingInvitationCounter=0,N.rooms={},N.roomsByJids={},N.roomsInProgress={},N.contactsInProgress={},N.updateLater={},N.maxRoomsUsers=i.getFeatureLimitMax(i.FeaturesEnum.BUBBLE_PARTICIPANT_COUNT),N.openInviteRoomId="",N.attachHandlers(),N.getServerRooms().then(function(){N.computeInvitationCounter(),N.retrieveOpenInviteRoom();var e=Math.round(performance.now()-n);r.push({service:"roomService",startDuration:e}),b.info("[roomService] === STARTED ("+e+" ms) ==="),t()}).catch(function(e){b.error("[roomService] === STARTING FAILURE === "+e.message),N.computeInvitationCounter(),N.reconnect(),t()})})},N.stop=function(){return b.info(""),b.info("[roomService] === STOPPING ==="),N.listeners.forEach(function(e){e()}),N.rooms=null,N.roomsByJids=null,b.info("[roomService] === STOPPED ==="),f.when()},N.attachHandlers=function(){b.info("[roomService] attachHandlers"),this.roomPresenceRef&&(u.connection.deleteHandler(this.roomPresenceRef),this.roomPresenceRef=null),this.roomPresenceRef=u.connection.addHandler(N.onRoomPresence,"http://jabber.org/protocol/muc#user","presence"),this.roomMessageRef&&(u.connection.deleteHandler(this.roomMessageRef),this.roomMessageRef=null),this.roomMessageRef=u.connection.addHandler(N.onRoomMessage,"jabber:x:conference","message"),this.roomInfoMessageRef&&(u.connection.deleteHandler(this.roomInfoMessageRef),this.roomInfoMessageRef=null),this.roomInfoMessageRef=u.connection.addHandler(N.onRoomInfoMessage,null,"message","groupchat"),this.roomMessageConfigRef&&(u.connection.deleteHandler(this.roomMessageConfigRef),this.roomMessageConfigRef=null),this.roomMessageConfigRef=u.connection.addHandler(N.onRoomMessageConfig,null,"message","management"),this.roomHistoryInfoRef&&(u.connection.deleteHandler(this.roomHistoryInfoRef),this.roomHistoryInfoRef=null),this.roomHistoryInfoRef=u.connection.addHandler(N.onRoomHistoryInfoMessage,"jabber:iq:notification","message"),N.listeners.push(R.$on("ON_CONNECTION_STATE_CHANGE_EVENT",N.onConnectionStateChange))},N.reconnect=function(){b.info("[roomService] reconnect"),N.attachHandlers(),N.getServerRooms().then(function(){N.computeInvitationCounter(),b.info("[roomService] reconnect success")}).catch(function(e){b.error("[roomService] reconnect failure -- "+e.message)})},N.onConnectionStateChange=function(e,t){b.info("[roomService] onConnectionStateChange status:"+t),"disconnected"===t&&N.rooms&&Object.keys(N.rooms).forEach(function(e){var t=N.rooms[e];t&&(t.initPresInterval&&(b.info("[roomService] onConnectionStateChange cancel initPresence retryer for room: "+t.jid+" "+t.name),d.cancel(t.initPresInterval),t.initPresInterval=null),t.initPresPromise&&(b.info("[roomService] onConnectionStateChange remove initPresPromise for room: "+t.jid+" "+t.name),t.initPresPromise=null))})},N.getRooms=function(){var t=[];return Object.keys(N.rooms).forEach(function(e){t.push(N.rooms[e])}),t},N.searchRooms=function(e){var t=e.toLowerCase().trim().split(/[ ]+/);return N.getRooms().filter(function(r){if("accepted"!==r.status)return!1;var i=r.name.toLowerCase().trim().split(/[ ]+/);return t.every(function(n){return i.some(function(e,t){return!(!e.length||0!==I.removeDiacritis(e).indexOf(I.removeDiacritis(n)))&&(i[t]="",r.filterName=I.removeDiacritis(r.name),!0)})})})},N.getMyRooms=function(){return N.getRooms().filter(function(e){return e.owner})},N.getRoomById=function(e){return N.rooms[e]},N.getRoomByJid=function(e){return N.roomsByJids[e]},N.computeInvitationCounter=function(){N.invitationCounter=0,N.meetingInvitationCounter=0,Object.keys(N.rooms).forEach(function(e){var t=N.rooms[e];"invited"===t.status&&(t.isMeetingRoom()&&i.isFeatureEnabled("CONFERENCE_PARTICIPANT_ALLOWED")?N.meetingInvitationCounter+=1:N.invitationCounter+=1)})},N.getOrderedRooms=function(e){return"creationDate"===e?t(N.getRooms(),N.getCreationDate,!0,N.sortByDate):t(N.getRooms(),N.getName,!1,N.sortByName)},N.getMyOrderedRooms=function(e){return"creationDate"===e?t(N.getMyRooms(),N.getCreationDate,!0,N.sortByDate):t(N.getMyRooms(),N.getName,!1,N.sortByName)},N.getServerRoom=function(i){return f(function(n,r){b.info("[roomService] getServerRoom("+i+")"),h({method:"GET",url:N.portalURL+"rooms/"+i+"?format=full",headers:v.getRequestHeader()}).then(function(e){var t=e.data.data;return b.info("[roomService] getServerRoom("+i+") successfully"),N.getAllRoomsParticipants([t])}).then(function(e){var t=N.createRoomFromData(e[0]);n(t)},function(e){var t=e.data?e.data.errorDetails:e.data,n="getServerRoom("+i+") failure: "+t;b.error("[roomService] "+n),r(new Error(n))})})},N.getServerRooms=function(){var c=function(a,o,s){return f(function(t,n){var e,r,i;(e=a,r=o,i=s,f(function(t,n){h({method:"GET",headers:v.getRequestHeader(),url:N.portalURL+"rooms?format=full&userId="+y.userContact.dbId+"&status=invited&status=accepted&status=unsubscribed&offset="+e+"&limit="+r}).then(function(e){i=i.concat(e.data.data),b.info("[roomService] getServerRooms retrieved "+e.data.data.length+" rooms, total "+i.length+", existing "+e.data.total),t({rooms:i,finished:i.length===e.data.total})}).catch(function(e){n(e)})})).then(function(e){e.finished?(b.info("[roomService] getServerRooms no need to loop again. All rooms retrieved..."),t(e.rooms)):(a+=o,b.info("[roomService] getServerRooms need another loop to get more rooms... ["+e.rooms.length+"]"),c(a,o,e.rooms).then(function(e){t(e)}).catch(function(e){n(e)}))}).catch(function(e){n(e)})})};return f(function(t,n){c(0,1e3,[]).then(function(e){var t=e;return b.info("[roomService] getServerRooms successfully: find "+t.length+" room(s)"),N.getAllRoomsParticipants(t)}).then(function(e){e.forEach(function(e){N.createRoomFromData(e)}),t()}).catch(function(e){var t="getServerRooms failure: "+(e.data?e.data.errorDetails:e.message);b.error("[roomService] "+t),n(new Error(t))})})},N.getAllRoomsParticipants=function(n){var d=f.defer(),u=function(o,s,c,l){return f(function(t,n){var e,r,i,a;(e=o,r=s,i=c,a=l,f(function(t,n){h({method:"GET",headers:v.getRequestHeader(),url:N.portalURL+"rooms/"+e.id+"/users?format=full&offset="+r+"&limit="+i}).then(function(e){a=a.concat(e.data.data),b.info("[roomService] getAllRoomsParticipants retrieved "+e.data.data.length+" users, total "+a.length+", existing "+e.data.total),t({users:a,finished:a.length===e.data.total})}).catch(function(e){n(e)})})).then(function(e){e.finished?(b.info("[roomService] getAllRoomsParticipants no need to loop again. All users retrieved..."),t(e.users)):(s+=c,b.info("[roomService] getAllRoomsParticipants need another loop to get more users... ["+e.users.length+"]"),u(o,s,c,e.users).then(function(e){t(e)}).catch(function(e){n(e)}))}).catch(function(e){d.reject(e)})})},r=performance.now(),i={},e=[];return n.forEach(function(t){var n=f.defer();if(e.push(n),t.activeUsersCounter&&t.users.length<t.activeUsersCounter){u(t,0,100,[]).then(function(e){t.users=e,n.resolve(t)}).catch(function(e){reject(e)})}else n.resolve(t);return n.promise.then(function(e){e.users.forEach(function(e){var t=y.getContactByJid(e.jid_im);i[e.jid_im]||t&&!t.temp||(i[e.jid_im]=e.jid_im)})})}),f.all(e).then(function(){var t=Object.keys(i);return t.length?y.getContactsByJids(t).then(function(){var e=performance.now();b.info("[roomService] getAllRoomsParticipants - get "+t.length+" participants in "+Math.round(e-r)+" milliseconds."),d.resolve(n)}):(b.info("[roomService] getAllRoomsParticipants - nothing to get, all known."),void d.resolve(n))}),d.promise},N.createRoomFromData=function(e){var n=T.create(e.id,e.jid,e.name,e.topic,e.creationDate,e.confEndpoints,e.history,e.customData,e.conference),t=y.dbContacts[e.creator];if(t){n.ownerContact=t,n.owner=t.jid===y.userContact.jid,e.users.forEach(function(e){var t=y.getContactById(e.userId);t&&(n.users.push({contact:t,status:e.status,date:new Date(e.additionDate),privilege:e.privilege}),y.isUserContact(t)&&(n.status=e.status))}),n.guestEmails=e.guestEmails,N.refreshMemberAndOrganizerLists(n);var r=n.getUserByJid(y.userContact.jid);return n.isModerator=r&&r.status!==N.RoomUserStatus.UNSUBSCRIBED&&n.isUserModerator(y.userContact),N.rooms[n.dbId]&&N.rooms[n.dbId].initPresPromise&&(n.initPresPromise=N.rooms[n.dbId].initPresPromise),n.updateAvatarInfo(),e.lastAvatarUpdateDate&&(n.avatar=config.restServerUrl+"/api/room-avatar/"+e.id+"?size=512&update="+MD5.hexdigest(e.lastAvatarUpdateDate)),N.rooms[n.dbId]=n,N.roomsByJids[n.jid]=n,R.$broadcast(N.ROOM_UPDATE_EVENT,n),"accepted"===n.status&&N.sendInitialRoomPresenceSync(n),n}b.error("[roomService] createRoomFromData -- failure -- Impossible to find owner of room "+e.name+" --- ignored")},N.refreshMemberAndOrganizerLists=function(t){t.organizers=[],t.members=[],t.users.forEach(function(e){e.status!==N.RoomUserStatus.ACCEPTED&&e.status!==N.RoomUserStatus.INVITED||(e.privilege===T.Privilege.MODERATOR?t.organizers.push(e):t.members.push(e))})},N.equalContactsArrayByDbId=function(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;++n)if(e[n].dbId!==t[n].dbId)return!1;return!0},N.getOrCreateRoomWithContacts=function(d,u){return f(function(t){var n=null,r=[].concat([y.userContact],d).sort(sortObjectByProperty("dbId"));if(N.getMyRooms().some(function(e){return!(!e||e.status!==N.RoomUserStatus.ACCEPTED||!N.equalContactsArrayByDbId(e.users.map(function(e){return e.contact}).sort(sortObjectByProperty("dbId")),r))&&(n=e,b.debug("[roomService] getOrCreateRoomWithContacts - Found Room "+e.name),!0)}),n)u.length?N.addRoomUsers(n,null,u).then(function(){t(n)}):t(n);else{for(var i=y.userContact.initials+" "+p("translate")("bubble")+" ",e=N.getMyRooms().filter(function(e){return e&&0===e.name.indexOf(i)}),a=function(e){return e&&e.name===c},o=null,s=1;!o;){var c=i+s.toString();e.sort(sortObjectByProperty("name")).some(a)||(o=c),s++}var l=r.map(function(e){return e.displayName}).join(", ");N.createRoomWithContacts(o,l,d,u).then(function(e){t(e)})}})},N.createRoomWithContacts=function(e,r,i,a){return f(function(t,n){N.createRoom(e,r,!0).then(function(e){return N.addRoomUsers(e,i,a)}).then(function(e){t(e)}).catch(function(e){var t="createRoomWithContacts failure: "+e.message;b.error("[roomService] "+t),n(new Error(t))})})},N.setAvatarRoom=function(n,e){var r=f.defer();return e?N.resizeImage(e,512,512).then(function(e){var t=N.getBinaryData(e);h({method:"POST",url:N.portalURL+"rooms/"+n.id+"/avatar",headers:v.getPostHeader("image/"+t.type),data:t.data,transformRequest:[]}).then(function(e){b.info("[roomService] setAvatarRoom success: "+e.data.status),n.avatar=config.restServerUrl+"/api/room-avatar/"+n.id+"?size=512&rand="+a(),r.resolve(n)},function(e){var t=o.handleError(e);b.error("[roomService] "+o.getErrorFullMessage(e,"setAvatarRoom")),r.reject(t)})}):r.resolve(n),r.promise},N.deleteAvatarRoom=function(n){return f(function(e,t){h({method:"DELETE",url:N.portalURL+"rooms/"+n+"/avatar",headers:v.getRequestHeader()}).then(function(){b.info("[roomService] avatar room sucessfully deleted"),e()}).catch(function(e){t(e)})})},N.resizeImage=function(e,i,a){var o=f.defer(),s=new Image;return s.src=e,s.onload=function(){var e=s.width,t=s.height;t<e?i<e&&(t*=i/e,e=i):a<t&&(e*=a/t,t=a);var n=document.createElement("canvas");n.width=e,n.height=t,s.width=e,s.height=t,n.getContext("2d").drawImage(this,0,0,e,t);var r=new Image;r.src=n.toDataURL("image/png"),o.resolve(r)},o.promise},N.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}},N.pushContactInRoom=function(n,r){return f(function(t){y.getContactByDBId(n.userId).then(function(e){r.users.push({contact:e,status:n.status,date:new Date(n.additionDate),privilege:n.privilege}),y.isUserContact(e)&&(r.status=n.status),b.info("[roomService] pushContactInRoom success"),t()}).catch(function(e){b.info("[roomService] pushContactInRoom failure : "+e.message),t()})})},N.addRoomUser=function(o,s,c,l,d){return f(function(r,n){if(o.users.some(function(e){return(e.status===N.RoomUserStatus.INVITED||e.status===N.RoomUserStatus.ACCEPTED||e.status===N.RoomUserStatus.REJECTED)&&e.contact.dbId===s.dbId}))return b.debug("[roomService] user: "+s.dbId+" already invited or accepted, will not be added"),void r(o);if(o.users.filter(function(e){return e.status!==N.RoomUserStatus.DELETED}).length>=N.maxRoomsUsers){var e=new Error("addRoomUser failure - Not Allowed : Participants max limit has been reached: "+N.maxRoomsUsers);return e.status=e.errorDetailsCode="403",b.error("[roomService] "+e.message),void n(e)}var i=N.RoomUserStatus.INVITED;"boolean"==typeof d&&d&&(i=N.RoomUserStatus.ACCEPTED);var t=c||"JustForFun",a=l||T.Privilege.USER;h({method:"POST",url:N.portalURL+"rooms/"+o.dbId+"/users",headers:v.getPostHeader(),data:{userId:s.dbId,privilege:a,reason:t,status:i}}).then(function(e){b.info("[roomService] addRoomUser "+s.displayNameForLog()+" to room "+o.dbId+"("+o.name+") success");var t=e.data.data,n=o.getUserByJid(t.jid_im);n?(n.status=t.status,n.date=new Date,n.privilege=t.privilege):o.users.push({contact:s,status:i,date:new Date,privilege:a}),N.refreshMemberAndOrganizerLists(o),R.$broadcast(N.ROOM_UPDATE_EVENT,o),r(o)},function(e){var t="addRoomUser "+s.displayNameForLog()+" to room "+o.dbId+"("+o.name+") failure: "+e.data.errorDetails;b.error("[roomService] "+t),n(new Error(t))})})},N.addRoomUsers=function(i,t,a){return f(function(e,n){var r=[];t.forEach(function(t){i.users.some(function(e){if(e.contact.dbId===t.dbId){switch(e.status){case N.RoomUserStatus.UNSUBSCRIBED:r.push(N.ownerReinviteRejectedUser(i,t));break;case N.RoomUserStatus.DELETED:r.push(N.ownerReinviteDeletedUser(i,t));break;case N.RoomUserStatus.REJECTED:r.push(N.ownerReinviteRejectedUser(i,t))}return!0}return!1})||r.push(N.addRoomUser(i,t))}),f.all(r).then(function(){b.info("[roomService] addRoomUsers success"),R.$broadcast(N.ROOM_ADD_USERS_EVENT,i),e(i)}).then(function(){N.inviteGuestEmailToJoinRoom(i,a)}).catch(function(e){var t="addRoomUsers failure: "+e.message;b.error("[roomService] "+t),n(new Error(t))})})},N.deleteRoomUsers=function(i,t){return f(function(e,n){var r=[];t.forEach(function(t){i.users.some(function(e){return e.contact.dbId===t.dbId})&&r.push(N.ownerDeletesUserFromRoom(i,t))}),f.all(r).then(function(){b.info("[roomService] deleteRoomUsers success"),R.$broadcast(N.ROOM_DELETE_USERS_EVENT,i),e(i)}).catch(function(e){var t="deleteRoomUsers failure: "+e.message;b.error("[roomService] "+t),n(new Error(t))})})},N.sendInitialRoomPresence=function(e,t){var n=t?" -- attempt "+t:"";b.info("[roomService] sendInitialRoomPresence "+n+" -- "+e.name+" -- "+e.dbId);var r=$pres({to:e.jid+"/"+u.fullJid});r.c("x",{xmlns:"http://jabber.org/protocol/muc"}).c("history",{maxchars:"0"}),u.send(r)},N.sendInitialRoomPresenceSync=function(e){if(e.initPresPromise)return e.initPresPromise.promise;var t=e.initPresPromise=f.defer();N.sendInitialRoomPresence(e,"0");var n=0;return e.initPresInterval=d(function(){n<5?N.sendInitialRoomPresence(e,++n):(b.error("[roomService] sendInitialRoomPresenceSync : no response after "+n+" retries => clean presence promise and interval for "+e.name+" -- "+e.jid),e.initPresPromise=null)},5e3,6),t.promise},N.sendPresenceWithResponseWait=function(e){if(e.initPresPromiseReceived)return N.sendInitialRoomPresence(e),f.when(e);var t=e.initPresPromise=f.defer();return N.sendInitialRoomPresence(e),t.promise},N.sendUnavailableRoomPresence=function(e){var t=$pres({to:e.jid+"/"+y.userContact.jid,type:"unavailable"});t.c("x",{xmlns:"http://jabber.org/protocol/muc"}),u.send(t)},N.createRoom=function(i,t,a,o,s,c){return b.info('[roomService] createRoom "'+i+'"'),f(function(n,r){(void 0===s||s&&"boolean"!=typeof s)&&(s=!0);var e={name:i,topic:t,history:a?"all":"none",disableNotifications:s};c&&(e.mediaType=c),h({method:"POST",url:N.portalURL+"rooms/",headers:v.getPostHeader(),data:e}).then(function(e){var t=e.data.data;return N.setAvatarRoom(t,o)}).then(function(e){N.rooms[e.id]&&(b.info('[roomService] createRoom -- room "'+i+'" already exists'),n(N.rooms[e.id]));var t=T.create(e.id,e.jid,e.name,e.topic,e.creationDate,e.confEndpoints,e.history,e.customData,e.conference,e.avatar);t.ownerContact=y.userContact,t.owner=!0,t.isModerator=!0,t.status="accepted",N.rooms[t.dbId]=t,N.roomsByJids[t.jid]=t,b.info('[roomService] createRoom "'+i+'" -- success'),n(N.sendInitialRoomPresenceSync(t))}).catch(function(e){var t=e;e&&e.data&&(t=e.data.errorDetailsCode+" "+e.data.errorDetails),b.error('[roomService] createRoom "'+i+'" -- failure : '+t),r(e)})})},N.updateRoomUser=function(i,a,e,t){var o={};return e&&(o.status=e),t&&(o.privilege=t),f(function(n,r){h({method:"PUT",url:N.portalURL+"rooms/"+i.dbId+"/users/"+a.dbId,headers:v.getPostHeader(),data:o}).then(function(e){b.info("[roomService] updateRoomUser "+a.displayNameForLog()+" to room "+i.dbId+"("+i.name+") success");var t=e.data.data;i.users.forEach(function(e){e.contact.jid===t.jid_im&&(e.privilege=t.privilege,e.status=t.status)}),N.refreshMemberAndOrganizerLists(i),R.$broadcast(N.ROOM_UPDATE_EVENT,i),n(i)},function(e){var t="updateRoomUser "+a.displayNameForLog()+" to room "+i.dbId+"("+i.name+") failure: "+e.data.errorDetails;b.error("[roomService] "+t),r(new Error(t))})})},N.ownerArchiveRoom=function(r){return b.info("[roomService] ownerArchiveRoom"),f(function(e,n){var t=[];r.users.forEach(function(e){y.isUserContact(e.contact)||e.status===N.RoomUserStatus.DELETED||e.status===N.RoomUserStatus.REJECTED||t.push(N.unsubscribeUserFromRoom(r,e.contact))}),f.all(t).then(function(){b.info("[roomService] unsubscribe all other users successfully"),N.unsubscribeMeFromRoom(r).then(function(){b.info("[roomService] ownerArchiveRoom successfully"),e(r)})}).catch(function(e){var t="ownerArchiveRoom failure: "+e.message;b.error("[roomService] "+t),n(new Error(t))})})},N.unsubscribeUserFromRoom=function(e,t){return N.updateRoomUser(e,t,N.RoomUserStatus.UNSUBSCRIBED)},N.ownerDeletesUserFromRoom=function(i,t){return b.info("[roomService] ownerDeletesUserFromRoom"),f(function(e,n){var r=t.dbId;h({method:"DELETE",url:N.portalURL+"rooms/"+i.dbId+"/users/"+r,headers:v.getRequestHeader()}).then(function(){b.info("[roomService] ownerDeletesUserFromRoom "+r+" from room "+i.dbId+"("+i.name+") success"),R.$broadcast(N.ROOM_UPDATE_EVENT,i),e(i)},function(e){var t="ownerDeletesUserFromRoom "+r+" from room "+i.dbId+"("+i.name+") failure: "+e.data.errorDetails;b.error("[roomService] "+t),n(new Error(t))})})},N.ownerReinviteRejectedUser=function(t,r,i,a,o){return f(function(e,n){N.ownerDeletesUserFromRoom(t,r).then(function(){N.addRoomUser(t,r,i,a,o).then(function(){b.info("[roomService] ownerReinviteRejectedUser "+r.dbId+" from room "+t.dbId+"("+t.name+") success"),e(t)})}).catch(function(e){var t="ownerReinviteRejectedUser failure: "+e.message;b.error("[roomService] "+t),n(new Error(t))})})},N.ownerReinviteDeletedUser=function(t,r,i,a,o){return f(function(e,n){N.addRoomUser(t,r,i,a,o).then(function(){b.info("[roomService] ownerReinviteDeletedUser "+r.dbId+" from room "+t.dbId+"("+t.name+") success"),e(t)}).catch(function(e){var t="ownerReinviteDeletedUser failure: "+e.message;b.error("[roomService] "+t),n(new Error(t))})})},N.ownerDeleteRoom=function(i){return f(function(e,n){var r=i.dbId;r?h({method:"DELETE",url:N.portalURL+"rooms/"+r,headers:v.getRequestHeader()}).then(function(){b.info("[roomService] ownerDeleteRoom "+i.dbId+"("+i.name+") success"),delete N.rooms[i.dbId],R.$broadcast(N.ROOM_UPDATE_EVENT,i),e(i)},function(e){var t="ownerDeleteRoom ("+r+") failure: unknown error occurred";e&&e.data&&(t="ownerDeleteRoom ("+r+") failure: "+e.data.errorDetails),e&&404===e.status&&(b.info("[roomService] ownerDeleteRoom "+i.dbId+"("+i.name+") not found, deleting it from local storage"),delete N.rooms[i.dbId],R.$broadcast(N.ROOM_UPDATE_EVENT,i)),b.error("[roomService] "+t),n(new Error(t))}):b.error("[roomService] ownerDeleteRoom failure because the roomId is empty ...")})},N.ownerUpdateRoom=function(t){return b.info("[roomService] ownerUpdateRoom"),f(function(n,r){var e={name:t.name,topic:t.desc,visibility:t.type?"public":"private"};h({method:"PUT",url:N.portalURL+"rooms/"+t.dbId,headers:v.getPostHeader(),data:e}).then(function(e){var t=e.data.data;N.rooms[t.id].desc=t.topic,N.rooms[t.id].type="private"===t.visibility?T.Type.PRIVATE:T.Type.PUBLIC,b.info("[roomService] ownerUpdateRoom successfully ("+t.id+", "+t.jid+")"),n(N.rooms[t.id])},function(e){var t="ownerUpdateRoom failure: "+e.data.errorDetails;b.error("[roomService] "+t),r(new Error(t))})})},N.changeRoomOwner=function(a,o){return b.info("[roomService] changeRoomOwner"),f(function(e,n){if(!a||!o){var t="changeRoomOwner error: - missing room or new owner";return b.error("[roomService] "+t),void n(new Error(t))}var r={owner:o.dbId},i=a.confEndpoints&&a.confEndpoints.length?a.confEndpoints[0].confEndpointId:"";N.deleteRoomConferenceEndPoint(a,i).then(function(){h({method:"PUT",url:N.portalURL+"rooms/"+a.dbId,headers:v.getPostHeader(),data:r}).then(function(){a.ownerContact=o,a.owner=o.jid===y.userContact.jid,b.info("[roomService] changeRoomOwner successfully ("+a.dbId+")"),e(N.rooms[a.dbId])},function(e){var t="changeRoomOwner failure: "+e.data.errorDetails;b.error("[roomService] "+t),n(new Error(t))})}).catch(function(e){b.error("[roomService] changeRoomOwner error"),n(e)})})},N.ownerUpdateRoomCustomData=function(t){return b.info("[roomService] ownerUpdateRoomCustomData"),f(function(n,r){var e={customData:t.customData};h({method:"PUT",url:N.portalURL+"rooms/"+t.dbId+"/custom-data",headers:v.getPostHeader(),data:e}).then(function(e){var t=e.data.data;b.info("[roomService] ownerUpdateRoomCustomData successfully got ("+JSON.stringify(t,null,4)+")"),n(t.customData||{})},function(e){var t="ownerUpdateRoomCustomData failure: "+e.data.errorDetails;b.error("[roomService] "+t),r(new Error(t))})})},N.ownerUpdateRoomNameAndDescription=function(t){return b.info("[roomService] ownerUpdateRoomNameAndDescription"),f(function(n,r){var e={name:t.name,topic:t.desc,visibility:t.type?"public":"private"};h({method:"PUT",url:N.portalURL+"rooms/"+t.dbId,headers:v.getPostHeader(),data:e}).then(function(e){var t=e.data.data;N.rooms[t.id].desc=t.topic,N.rooms[t.id].type="private"===t.visibility?T.Type.PRIVATE:T.Type.PUBLIC,(t.conference||t.confEndpoints)&&(N.rooms[t.id].conference=t.conference?t.conference:null,N.rooms[t.id].confEndpoints=t.confEndpoints?t.confEndpoints:[]),b.info("[roomService] ownerUpdateRoomNameAndDescription successfully ("+t.id+", "+t.jid+")"),n(N.rooms[t.id])},function(e){var t="ownerUpdateRoomNameAndDescription failure: "+e.data.errorDetails;b.error("[roomService] "+t),r(new Error(t))})})},N.updateMyRoomUser=function(r,t){return f(function(e,n){h({method:"PUT",url:N.portalURL+"rooms/"+r.dbId+"/users/"+y.userContact.dbId,headers:v.getPostHeader(),data:{status:t}}).then(function(){b.info("[roomService] updateMyRoomUser "+y.userContact.displayNameForLog()+" to room "+r.dbId+"("+r.name+") success"),e(r)},function(e){var t="updateMyRoomUser "+y.userContact.displayNameForLog()+" to room "+r.dbId+"("+r.name+") failure: "+e.data.errorDetails;b.error("[roomService] "+t),n(new Error(t))})})},N.unsubscribeMeFromRoom=function(e){return N.updateMyRoomUser(e,N.RoomUserStatus.UNSUBSCRIBED)},N.participantCloseRoom=function(i){return b.info("[roomService] participantCloseRoom"),f(function(e,n){var r=y.userContact.dbId;h({method:"DELETE",url:N.portalURL+"rooms/"+i.dbId+"/users/"+r,headers:v.getRequestHeader()}).then(function(){b.info("[roomService] participantCloseRoom "+r+" from room "+i.dbId+"("+i.name+") success"),delete N.rooms[i.dbId],R.$broadcast(N.ROOM_UPDATE_EVENT,i),e(i)},function(e){var t="participantCloseRoom "+r+" from room "+i.dbId+"("+i.name+") failure: "+e.data.errorDetails;b.error("[roomService] "+t),n(new Error(t))})})},N.acceptRoomInvitation=function(e){return N.updateMyRoomUser(e,N.RoomUserStatus.ACCEPTED).then(function(){return r.retrieveReceivedFilesForRoom(e.dbId)}).then(function(){return N.sendInitialRoomPresenceSync(e)})},N.declineRoomInvitation=function(e){return N.updateMyRoomUser(e,N.RoomUserStatus.REJECTED)},N.getRoomConferenceEndPoint=function(i,a){return b.info("[roomService] getRoomConferenceEndPoint"),f(function(n,r){h({method:"GET",url:N.portalURL+"rooms/"+i.dbId+"/conference/"+a,headers:v.getRequestHeader()}).then(function(e){var t=e.data.data;b.info("[roomService] getRoomConferenceEndPoint "+a+" from room "+i.dbId+"success"),n(t)},function(e){var t="getRoomConferenceEndPoint "+a+" from room "+i.dbId+"failure: "+e.data.errorDetails;b.error("[roomService] "+t),r(new Error(t))})})},N.addRoomConferenceEndPoint=function(i,a,e){if(b.info("[roomService] addRoomConferenceEndPoint"),null===a||angular.isUndefined(a)){var t=new Error("No ConferenceEndPoint to associate with Room");return f.reject(t)}return f(function(n,r){var t=!1;if(i.confEndpoints.forEach(function(e){e.confEndpointId===a.id&&(t=!0)}),t)return b.info("[roomService] addRoomConferenceEndPoint : already attached to room !"),void n(i);e&&"pstnAudio"===e&&Object.keys(N.rooms).forEach(function(e){N.rooms[e].conference&&!N.rooms[e].conference.scheduled&&N.rooms[e].getPstnConfEndpointId()===a.id&&N.deleteRoomConferenceEndPoint(N.rooms[e],a.id)}),h({method:"POST",url:N.portalURL+"rooms/"+i.dbId+"/conferences",headers:v.getPostHeader(),data:{confId:a.id}}).then(function(e){var t=e.data.data;b.debug("[roomService] addRoomConferenceEndPoint response data:"+JSON.stringify(t)),i.confEndpoints.push(t),b.info("[roomService] addRoomConferenceEndPoint "+a.id+" to room "+i.dbId+"success"),R.$broadcast(N.ROOM_ADD_CONF_ENDPOINT_EVENT,i),n(i)},function(e){var t=o.handleError(e);b.error("[roomService] addRoomConferenceEndPoint "+t.message),r(t)})})},N.deleteRoomConferenceEndPoint=function(i,a){return b.info("[roomService] deleteRoomConferenceEndPoint"),f(function(n,r){if(!i||!a)return b.info("[roomService] deleteRoomConferenceEndPoint : missing parameters "),void n();var e=!1;if(i.confEndpoints&&i.confEndpoints.length)for(var t=0;t<i.confEndpoints.length;t++)if(i.confEndpoints[t].confEndpointId===a){e=!0;break}if(!e)return b.info("[roomService] deleteRoomConferenceEndPoint : room has no such conference attached"),void n();h({method:"DELETE",url:N.portalURL+"rooms/"+i.dbId+"/conferences/"+a,headers:v.getRequestHeader()}).then(function(e){var t=e.data.data;b.info("[roomService] deleteRoomConferenceEndPoint "+a+" from room "+i.dbId+"success"),i.confEndpoints=t,R.$broadcast(N.ROOM_REMOVE_CONF_ENDPOINT_EVENT,i),n()},function(e){var t="deleteRoomConferenceEndPoint "+a+" from room "+i.dbId+"failure: "+e.data.errorDetails;b.error("[roomService] "+t),404===e.status?(i.confEndpoints=[],R.$broadcast(N.ROOM_REMOVE_CONF_ENDPOINT_EVENT,i),n()):r(new Error(t))})})},N.inviteGuestEmailToJoinRoom=function(n,e){return b.info("[roomService] inviteGuestEmailToJoinRoom"),e&&e.length?f(function(t){h({method:"POST",url:N.portalURL+"rooms/"+n.dbId+"/invitations",headers:v.getRequestHeader(),data:{scenario:"chat",emails:e,lang:v.userData.language}}).then(function(e){n.guestEmails=e.data.data.guestEmails,R.$broadcast("ROOM_ADD_CONF_GUESTS_EVENT",n),t(n)}).catch(function(e){var t=o.handleError(e);b.error("[roomService] inviteGuestEmailToJoinRoom "+t.message),reject(t)})}):f.resolve(n)},N.ownerCancelGuestFromRoom=function(r,e){return b.info("[roomService] ownerCancelGuestFromRoom"),e&&e.length?f(function(t,n){h({method:"POST",url:N.portalURL+"rooms/"+r.dbId+"/invitations/cancel",headers:v.getRequestHeader(),data:{scenario:"chat",emails:e,lang:v.userData.language}}).then(function(e){r.guestEmails=e.data.guestEmails,R.$broadcast("ROOM_REMOVE_CONF_GUESTS_EVENT",r),t(r)}).catch(function(e){var t=o.handleError(e);b.error("[roomService] ownerCancelGuestFromRoom "+t.message),n(t)})}):f.resolve(r)},N.notifyRoomUsersJoinConference=function(i,a,o,s,c){return b.info("[roomService] notifyRoomUsersJoinConference"),s=angular.isDefined(s)?s:"false",c=angular.isDefined(c)?c:"false",f(function(e,n){var r=i.getPstnConfEndpointId();if(r){var t=i.desc;h({method:"POST",url:N.portalURL+"rooms/"+i.dbId+"/invitations",headers:v.getPostHeader(),data:{scenario:"pstn-conference",confId:r,noMail:s.toString(),update:c.toString(),users:a?a.map(function(e){return e.dbId}):void 0,emails:o,instantMessage:t,lang:v.userData.language}}).then(function(){b.info("[roomService] notifyRoomUsersJoinConference "+r+" from room "+i.dbId+"success"),N.rooms[i.dbId].guestEmails=o,R.$broadcast("ROOM_ADD_CONF_GUESTS_EVENT",N.rooms[i.dbId]),e(N.rooms[i.dbId])},function(e){var t="notifyRoomUsersJoinConference "+r+" from room "+i.dbId+"failure: "+e.data.errorDetails;b.error("[roomService] "+t),n(new Error(t))})}else e(i)})},N.notifyUsersCancelConference=function(i,t,a,o){return b.debug("[roomService] notifyUsersCancelConference"),o=angular.isDefined(o)?o:"false",f(function(e,n){var r=i.getPstnConfEndpointId();r?h({method:"DELETE",url:N.portalURL+"rooms/"+i.dbId+"/invitations",headers:v.getPostHeader(),data:{scenario:"pstn-conference",confId:r,noMail:o.toString(),users:t?t.map(function(e){return e.dbId}):void 0,emails:a,lang:v.userData.language}}).then(function(){b.info("[roomService] notifyUsersCancelConference "+r+" from room "+i.dbId+"success"),N.rooms[i.dbId].guestEmails=N.rooms[i.dbId].guestEmails.filter(function(e){return-1===a.indexOf(e)}),R.$broadcast("ROOM_DELETE_CONF_GUESTS_EVENT",N.rooms[i.dbId]),e(N.rooms[i.dbId])},function(e){var t="notifyUsersCancelConference "+r+" from room "+i.dbId+"failure: "+e.data.errorDetails;b.error("[roomService] "+t),n(new Error(t))}):e(i)})},N.getRoomByConferenceEndpointId=function(i){return b.info("[roomService] getRoomFromConferenceEndpointId"),f(function(n,r){h({method:"GET",url:N.portalURL+"rooms?userId="+y.userContact.dbId+"&confId="+i+"&format=full",headers:v.getRequestHeader()}).then(function(e){b.info("[roomService] getRoomFromConferenceEndpointId -- "+i+" -- success");var t=e.data.data;t.length?(N.createRoomFromData(t[0]),n(N.getRoomById(t[0].id))):(b.info("[roomService] getRoomFromConferenceEndpointId -- no room with confId "+i),r())},function(e){var t="getRoomFromConferenceEndpointId -- "+i+" -- failure: "+e.data.errorDetails;b.error("[roomService] "+t),r(new Error(t))})})},N.onRoomMessage=function(e){b.info("[roomService] onRoomMessage");try{if(0<angular.element(e).find("event").length&&("conferenceAdd"===angular.element(e).find("event").attr("name")||"conferenceRemove"===angular.element(e).find("event").attr("name")))return!0;var t=angular.element(e).find("x").attr("thread");return N.getServerRoom(t).then(function(e){e.isMeetingRoom()&&R.$broadcast("MEETING_CREATED_EVENT",e),N.computeInvitationCounter(),R.$broadcast(N.ROOM_INVITATION,e),R.$broadcast(N.ROOM_UPDATE_EVENT,e)}).catch(function(e){b.error("[roomService] onRoomMessage failure :  impossible to get associated room : "+e.message)}),!0}catch(e){return b.error("[roomService] onRoomMessage error "+e),!0}},N.onRoomInfoMessage=function(e){b.info("[roomService] onRoomInfoMessage");try{if(0<angular.element(e).find("event").length){b.info("[roomService] onRoomInfoMessage : room event message");var t=angular.element(e).attr("from"),n=u.getBareJidFromJid(t),r=angular.element(e).find("event").attr("jid"),i=angular.element(e).find("event").attr("name"),a=angular.element(e).attr("id");if(b.info("[roomService] onRoomInfoMessage : room event message with parameters "+n+" || "+r+" || "+i+" || "+a),n&&r&&i&&a){var o=(c=N.getRoomByJid(n)).getUserByJid(r);switch(o&&"deleted"!==o.status&&R.$broadcast(N.ROOM_ADMIN_MESSAGE_EVENT,n,r,i,a),i){case"conferenceAdd":d(function(){N.getServerRoom(c.dbId).then(function(e){b.info("[roomService] onRoomInfoMessage : conferenceAdd event"),R.$broadcast("ROOM_UPDATE_CONFID",e),R.$broadcast("ROOM_ADD_CONF_ENDPOINT_EVENT",e),R.$broadcast("ON_CONFERENCE_STARTED_INVITATION",e)})},2e3,1);break;case"conferenceRemove":d(function(){N.getServerRoom(c.dbId).then(function(e){b.info("[roomService] onRoomInfoMessage : conferenceRemove event"),R.$broadcast("ROOM_REMOVE_CONF_ENDPOINT_EVENT",e),R.$broadcast("ON_CONFERENCE_ENDED_INVITATION",e)})},2e3,1);break;case"invitation":!c.isUserModerator(y.userContact)||o&&o.status!==N.RoomUserStatus.DELETED||N.getServerRoom(c.dbId).then(function(e){R.$broadcast(N.ROOM_UPDATE_EVENT,e)})}}}else if(0<angular.element(e).find("subject").length){t=angular.element(e).attr("from");var s=u.getBareJidFromJid(t),c=N.getRoomByJid(s),l=angular.element(e).find("subject").text();c&&l&&(b.info("[roomService] onRoomInfoMessage : update subject of room"),c.desc=l,R.$broadcast(N.ROOM_UPDATE_EVENT,c))}return!0}catch(e){return b.error("[roomService] onRoomInfoMessage error "+e),!0}},N.onRoomHistoryInfoMessage=function(e){var t=$(e).find("changed");if(0<t.length){var n=t.attr("with"),r=N.getRoomByJid(n);b.debug("[roomService] onRoomHistoryInfoMessage with "+n),R.$broadcast(N.ROOM_HISTORY_UPDATE_EVENT,r)}return!0},N.onRoomMessageConfig=function(e){try{var t=$(e),n=t.find("room");if("management"===t.attr("type")&&0<n.length){var r=n.attr("roomid"),i=n.attr("userjid"),a=n.attr("status"),o=n.attr("topic"),s=n.attr("name"),c=n.attr("scheduledStartDate"),l=n.attr("scheduledEndDate"),d=n.attr("scheduledTimezone"),u=n.attr("lastAvatarUpdateDate"),f=t.find("avatar"),h=null;0<f.length&&(h="delete"===f.attr("action")?"delete":"update");var p=n.attr("privilege"),v=n.attr("customData"),m=N.getRoomById(r);b.info("[roomService] onRoomMessageConfig -- management -- "+r);var g=n.find("guests");if(0<g.length&&(b.info("[roomService] onRoomMessageConfig -- "+r+" -- update guests list"),"update"===g.attr("action")&&(m.guestEmails=[],$(g).find("email").each(function(e,t){m.guestEmails.push(t.textContent)}))),m&&a)(C=m.getUserByJid(i))?C&&(b.info("[roomService] onRoomMessageConfig update user status"),N.updateUserStatus(m,C,a)):(b.info("[roomService] onRoomMessageConfig room exists, but user not. Update the room"),N.getServerRoom(r).then(function(){m.updateAvatarInfo()}));else if(m&&s)b.info("[roomService] onRoomMessageConfig update Room name or topic"),m.name=s,m.desc=o||"",N.roomsByJids[m.jid].name=s,N.rooms[m.dbId].name=s,N.roomsByJids[m.jid].desc=o||"",N.rooms[m.dbId].desc=o||"",m.isMeetingRoom()&&N.getServerRoom(m.dbId).then(function(){R.$broadcast("MEETING_UPDATE_EVENT",m)}),R.$broadcast(N.ROOM_UPDATE_EVENT,m);else if(m&&v){b.info("[roomService] onRoomMessageConfig update Room customData");var S=I.extractHtmlContent(v);try{v=JSON.parse(S)}catch(e){b.error("[roomService] onRoomMessageConfig update Room Parsing error:",e),v={}}m.customData=v,N.roomsByJids[m.jid].customData=v,N.rooms[m.dbId].customData=v,R.$broadcast(N.ROOM_UPDATE_EVENT,m)}else if(m&&m.conference&&c&&l&&d)b.info("[roomService] onRoomMessageConfig update Room conference data"),m.conference.scheduledStartDate=moment(c).toISOString(),m.conference.scheduledEndDate=moment(l).toISOString(),m.conference.scheduledTimezone=d,m.conference.scheduledDuration=moment.duration(moment(l).diff(moment(c))).asMinutes(),R.$broadcast(N.ROOM_UPDATE_EVENT,m);else if(m&&(u||h))b.info("[roomService] onRoomMessageConfig "+h+" avatar"),N.getServerRoom(m.dbId).then(function(e){e.updateAvatarInfo(),R.$broadcast(N.ROOM_AVATAR_UPDATE_EVENT,m)});else if(m&&p){var C;b.info("[roomService] onRoomMessageConfig update user's privilege "+p),(C=i?m.getUserByJid(i):null)&&C.contact&&C.contact.jid!==y.userContact.jid&&"owner"!==p?("moderator"===p?C.privilege=T.Privilege.MODERATOR:"user"===p&&(C.privilege=T.Privilege.USER),y.getVCardByDbId(C.contact.dbId).then(function(){N.refreshMemberAndOrganizerLists(m),R.$broadcast(N.ROOM_UPDATE_EVENT,m)})):N.getServerRoom(m.dbId).then(function(e){N.refreshMemberAndOrganizerLists(e),R.$broadcast(N.ROOM_UPDATE_EVENT,e)})}else void 0===m&&r&&!N.roomsInProgress[r]&&"deleted"!==a&&"rejected"!==a?(N.roomsInProgress[r]=!0,b.info("[roomService] onRoomMessageConfig -- room does not exist, create new one"),N.getServerRoom(r).then(function(e){delete N.roomsInProgress[r],b.info("[roomService] onRoomMessageConfig -- sendInitialRoomPresence to the new room"),N.sendInitialRoomPresence(e),N.updateLater[r]&&(delete N.updateLater[r],b.info("[roomService] onRoomMessageConfig -- later update of the new room"),N.getServerRoom(r).then(function(e){e.updateAvatarInfo()}))})):N.roomsInProgress[r]&&(N.updateLater[r]=r)}var E=angular.element(e).find("openinvite");if(E&&"update"===E.attr("action"))(r=E.find("roomid").text())?N.openInviteRoomId&&N.openInviteRoomId!==r&&(b.debug("[roomService] room bound to openinviteId changed"),N.openInviteRoomId="",N.retrieveOpenInviteRoom().then(function(e){R.$broadcast(N.ROOM_UPDATE_EVENT,e)})):b.warn("[roomService] openInviteId unbound");return!0}catch(e){return b.info("[roomService] onRoomMessageConfig  -- failure -- "+e.message),!0}},N.onRoomPresence=function(e){try{var t=angular.element(e),n=t.attr("from"),r=u.getBareJidFromJid(n),i=u.getResourceFromJid(n),a=N.getRoomByJid(r);if(a)if(b.info("[roomService] onRoomPresence -- "+a.dbId),-1!==i.indexOf("/")&&(i=u.getBareJidFromJid(i)),y.isUserContactJid(i)){var o=t.find("status"),s=null;o.each(function(e,t){"332"===$(t).attr("code")&&(s="332")}),"332"===s?(b.error("[roomService] disconnected from room "+a.name+" because of a system shutdown"),N.sendInitialRoomPresenceSync(a)):a.initPresPromise&&(b.info("[roomService] onRoomPresence - initPresPromise resolved"),a.initPresPromise.resolve(a),a.initPresInterval&&d.cancel(a.initPresInterval),a.initPresPromise=null,R.$broadcast(N.ROOM_UPDATE_EVENT,a),a.initPresPromiseReceived=!0)}else a.dbId&&!N.rooms[a.dbId]&&N.getServerRoom(a.dbId);return!0}catch(e){return b.error("[roomService] onRoomPresence error "+e),!0}},N.updateUserStatus=function(e,t,n){if(b.info("[roomService] "+t.status+" || "+n),y.isUserContactJid(t.contact.jid)&&t.status!==n)switch(b.info("[roomService] my new status "+n),n){case"deleted":delete N.roomsByJids[e.jid],delete N.rooms[e.dbId],b.info("[roomService] deleteRoom successfully ("+e.dbId+")"),N.sendUnavailableRoomPresence(e),N.computeInvitationCounter(),e.isMeetingRoom()&&R.$broadcast("MEETING_DELETE_EVENT",e),R.$broadcast(N.ROOM_UPDATE_EVENT,e,"remove");break;case"unsubscribed":b.info("[roomService] unsubscribed successfully ("+e.dbId+")"),N.sendUnavailableRoomPresence(e),e.status=N.RoomUserStatus.UNSUBSCRIBED,t.status=n,e.updateAvatarInfo(),e.isModerator=!1,N.computeInvitationCounter(),R.$broadcast(N.ROOM_UPDATE_EVENT,e);break;case"accepted":r.retrieveReceivedFilesForRoom(e.dbId).then(function(){N.sendInitialRoomPresence(e),e.status=N.RoomUserStatus.ACCEPTED,t.status=n,e.updateAvatarInfo(),N.computeInvitationCounter(),R.$broadcast(N.ROOM_UPDATE_EVENT,e)});break;case"rejected":delete N.roomsByJids[e.jid],delete N.rooms[e.dbId],e.status=N.RoomUserStatus.REJECTED,t.status=n,N.computeInvitationCounter(),R.$broadcast(N.ROOM_UPDATE_EVENT,e)}else t&&!y.isUserContactJid(t.contact.jid)&&(b.info("[roomService] Update user with status "+n),t.status===N.RoomUserStatus.DELETED&&n===N.RoomUserStatus.ACCEPTED&&(t.date=new Date,t.privilege===T.Privilege.MODERATOR&&(t.privilege=T.Privilege.USER)),t.status=n,e.updateAvatarInfo(),N.refreshMemberAndOrganizerLists(e),R.$broadcast(N.ROOM_UPDATE_EVENT,e))},N.findRoomsWithConfId=function(t){return N.getRooms().filter(function(e){return!(!e.confEndpoints||!e.confEndpoints.length)&&e.confEndpoints.some(function(e){return e.confEndpointId===t})})},N.removeConfIdInAllRooms=function(e){var t=[];return e.forEach(function(e){e.confEndpoints&&0<e.confEndpoints.length&&t.push(N.deleteRoomConferenceEndPoint(e,e.confEndpoints[0].confEndpointId))}),f.all(t)},N.getCreationDate=function(e){return e.creationDate?moment(e.creationDate):moment()},N.sortByDate=function(e,t){var n=1;return e&&t&&(n=e.value-t.value),n},N.bindOpenInviteToRoom=function(n,r){return f(function(e,t){h({method:"PUT",url:N.portalURL+"users/"+y.userContact.dbId+"/open-invites/bind",headers:v.getRequestHeader(),data:{roomId:n}}).then(function(){y.userContact.setOpenRoomId(n),b.info("[roomService] openInvite "+r+" successfully bound to room "+n),e()}).catch(function(e){b.error("[roomService] Error binding openInviteId to Room"),t(e)})})},N.joinRoomUsingOpenInviteId=function(e){return f(function(n,r){h({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/rooms/open-invites",headers:v.getRequestHeader(),data:{openInviteId:e}}).then(function(e){var t=e.data.data;t&&t.roomId?n(t.roomId):r()}).catch(function(e){b.error("[roomService] Error retrieveRoomFromOpenInvite"),r(e)})})},N.retrieveRoomIdFromOpenInviteId=function(){return f(function(n,r){h({method:"GET",url:N.portalURL+"users/"+y.userContact.dbId+"/open-invites",headers:v.getRequestHeader()}).then(function(e){var t=e.data.data;t&&t.roomId?n(t.roomId):(b.error("[roomService] Error - no roomId associated to openInviteId"),r())}).catch(function(e){b.error("[roomService] Error retrieveRoomFromOpenInvite"),r(e)})})},N.retrieveOpenInviteRoom=function(){return b.debug("[roomService] retrieveOpenInviteRoom"),f(function(n,e){N.openInviteRoomId?N.rooms[N.openInviteRoomId]?n(N.rooms[N.openInviteRoomId]):(b.warn("[roomService] retrieveOpenInviteRoom - unknown room"),e()):N.retrieveRoomIdFromOpenInviteId().then(function(e){if(e){N.openInviteRoomId=e;var t=N.getRoomById(e);if(t)return void n(t);b.warn("[roomService] retrieveOpenInviteRoom - room with openInvite not found locally, retrieving it from server."),N.getServerRoom(e).then(function(e){n(e)}).catch(function(){i.isFeatureEnabled(i.FeaturesEnum.CONFERENCE_ALLOWED)?(b.warn("[roomService] retrieveOpenInviteRoom - Creating room and attaching open-invite-id"),N.createRoom(s.instant("namePersonalConference",{name:y.userContact.displayName}),"","none",null,!0,"pstnAudio").then(function(e){N.bindOpenInviteToRoom(e.dbId,y.userContact.getOpenInviteId()).then(function(){n(e)})})):b.warn("[roomService] retrieveOpenInviteRoom - no room attached")})}else b.warn("[roomService] retrieveOpenInviteRoom - Creating room and attaching open-invite-id"),N.createRoom(s.instant("namePersonalConference",{name:y.userContact.displayName}),"","none",null,!0,"pstnAudio").then(function(e){N.bindOpenInviteToRoom(e.dbId,y.userContact.getOpenInviteId()).then(function(){n(e)})})}).catch(function(){i.isFeatureEnabled(i.FeaturesEnum.CONFERENCE_ALLOWED)?(b.warn("[roomService] retrieveOpenInviteRoom - error retrieving retrieveRoomIdFromOpenInviteId - - Creating room and attaching open-invite-id"),N.createRoom(s.instant("namePersonalConference",{name:y.userContact.displayName}),"","none",null,!0,"pstnAudio").then(function(e){N.bindOpenInviteToRoom(e.dbId,y.userContact.getOpenInviteId()).then(function(){n(e)})})):b.warn("[roomService] retrieveOpenInviteRoom - no room attached"),e()})})},N.getName=function(e){return e.name},N.sortByName=function(e,t){return e&&t&&"string"===e.type&&"string"===t.type&&e.value&&t.value?e.value.localeCompare(t.value):-1}}]),function(){"use strict";angular.module("rainbow").service("groupService",["$q","$rootScope","$log","$http","authService","contactService","xmppService","Group","usersService","utilService",function(a,d,o,s,c,u,e,l,t,f){var h=this;this.started=!1,h.ON_REMOVE_GROUP_USER_EVENT="ON_REMOVE_GROUP_USER_EVENT",h.ON_ADD_GROUP_USER_EVENT="ON_ADD_GROUP_USER_EVENT",h.ON_GROUP_USERS_UPDATE_EVENT="ON_GROUP_USERS_UPDATE_EVENT",h.ON_CREATED_GROUP_EVENT="ON_CREATED_GROUP_EVENT",h.ON_UPDATE_GROUP_EVENT="ON_UPDATE_GROUP_EVENT",h.ON_REMOVED_GROUP_EVENT="ON_REMOVED_GROUP_EVENT",this.start=function(){o.info(""),o.info("[groupService] === STARTING ==="),h.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+c.userId+"/";var e=a.defer();return h.$q=a,h.groups=null,u.userContact.isCPaaSGuest()?e.resolve():(this.attachHandlers(),this.getGroups(),h.started=!0,o.info("[groupService] === STARTED ==="),e.resolve(),e.promise)},this.stop=function(){return o.info("[groupService] === STOPPING ==="),h.conversations=null,h.groups=null,this.groupMessageHandlerRef&&(e.deleteHandler(this.groupMessageHandlerRef),this.groupMessageHandlerRef=null),this.started=!1,o.info("[groupService] === STOPPED ==="),a.when()},this.getGroups=function(){return h.groups?a.when(h.groups):h.getRemoteGroups()},h.getGroupsAsArray=function(){var e=[];for(var t in h.groups)h.groups.hasOwnProperty(t)&&e.push(h.groups[t]);return e},this.searchGroups=function(e){var t=e.toLowerCase().trim().split(/[ ]+/);return h.groups.filter(function(r){var i=r.name.toLowerCase().trim().split(/[ ]+/);return t.every(function(n){return i.some(function(e,t){return!(!e.length||0!==f.removeDiacritis(e).indexOf(f.removeDiacritis(n)))&&(i[t]="",r._displayName=f.removeDiacritis(r.name),!0)})})})},this.getRemoteGroups=function(){o.info("[groupService] getGroups");var n=a.defer();return s({method:"GET",url:h.portalURL+"groups?format=full",headers:c.getRequestHeader()}).then(function(e){var t=e.data.data;o.info("[groupService] getGroups success (find "+e.data.total+" group(s))"),h.groups=[];var n=[];return t.forEach(function(e){var t=l.createFromData(e);h.groups.push(t),angular.forEach(e.users,function(e){n=u.getContactByDBId(e).then(function(e){e&&t.users.push(e)})}),h.logGroupUsers(t),h.sortUsersInGroup(t)}),a.all(n)},function(e){var t="getGroups"+h.handleErrorMessage(e);n.reject(new Error(t)),o.error("[groupService] "+t)}).then(function(){n.resolve(h.groups)}),n.promise};this.getGroup=function(e){o.info("[groupService] getGroup  for "+e);var n=a.defer(),r=null;return s({method:"GET",url:h.portalURL+"groups/"+e,headers:c.getRequestHeader()}).then(function(e){var n=e.data.data,t=[];return r=l.createFromData(n),o.info("[groupService] getGroup success for "+r.name+" : "+r.id),h.groups.some(function(e,t){return e.id===n.id&&(h.groups[t]=n,!0)})||(h.groups.push(r),angular.forEach(n.users,function(e){t=u.getContactByDBId(e.id).then(function(e){if(e){r.users.push(e),h.sortUsersInGroup(r);var t=[r];e.getGroups()?e.getGroups().push(r):e.setGroups(t)}})})),a.all(t)},function(e){var t="getGroup"+h.handleErrorMessage(e);n.reject(new Error(t)),o.error("[groupService] "+t)}).then(function(){n.resolve(r)}),n.promise},this.addGroup=function(r){o.info("[groupService] addGroup : "+r.name);var i=a.defer();return s({method:"POST",url:h.portalURL+"groups",headers:c.getPostHeader(),data:{name:r.name,comment:r.comment,isFavorite:r.isFavorite}}).then(function(e){o.info("[groupService] addGroup success for : "+r.name);var t=e.data.data,n=l.createFromData(t);i.resolve(n)},function(e){var t="addGroup"+h.handleErrorMessage(e);i.reject(new Error(t)),o.error("[groupService] "+t)}),i.promise};var p=function(n){angular.forEach(h.groups,function(e,t){e.id===n&&h.groups.splice(t,1)})};this.removeGroup=function(e){o.info("[groupService] removeGroup : "+e);var n=a.defer();return s({method:"DELETE",url:h.portalURL+"groups/"+e,headers:c.getRequestHeader()}).then(function(){o.info("[groupService] removeGroup success for : "+e),p(e),n.resolve()},function(e){var t="removeGroup"+h.handleErrorMessage(e);n.reject(new Error(t)),o.error("[groupService] "+t)}),n.promise},this.updateGroup=function(e){o.info("[groupService] updateGroup for : "+e.name);var n=a.defer();return s({method:"PUT",url:h.portalURL+"groups/"+e.id,headers:c.getRequestHeader(),data:{name:e.name,comment:e.comment,isFavorite:e.isFavorite}}).then(function(){o.info("[groupService] updateGroup success for : "+e.name),n.resolve()},function(e){var t=h.handleErrorMessage(e,"updateGroup");n.reject(t),o.error("[groupService] "+t.message)}),n.promise},this.getGroupUsers=function(n){o.info("[groupService] getGroupUsers : "+n);var r=a.defer();return s({method:"GET",url:h.portalURL+"groups/"+n+"/users",headers:c.getRequestHeader()}).then(function(e){var t=e.data.data;o.info("[groupService] getGroupUsers success for "+n+" (find "+e.data.total+" users(s))"),r.resolve(t.users)},function(e){var t="getGroupUsers"+h.handleErrorMessage(e);r.reject(new Error(t)),o.error("[groupService] "+t)}),r.promise},this.addGroupUser=function(r,i){o.info("[groupService] addGroupUser");var a=h.$q.defer();return r.users.some(function(e){return i.dbId===e.dbId})?(o.info("[groupService] addGroupUser - user: "+i.id+" already exist in group: "+r.name+" - no remote action"),void a.resolve()):(s({method:"POST",url:h.portalURL+"groups/"+r.id+"/users/"+i.dbId,headers:c.getPostHeader()}).then(function(e){o.info("[groupService] addGroupUser success: "+i.id+"/"+r.name);var t=e.data.data,n=l.createFromData(t);d.$broadcast(h.ON_GROUP_USERS_UPDATE_EVENT),a.resolve(n)},function(e){var t="addGroupUser"+h.handleErrorMessage(e);a.reject(new Error(t)),o.error("[groupService] "+t)}),a.promise)};var v=function(r,i){angular.forEach(h.groups,function(t){t.id===r&&(angular.forEach(t.users,function(n,e){n.dbId===i&&(t.users.splice(e,1),n.getGroups()&&angular.forEach(n.getGroups(),function(e,t){e.id===r&&n.getGroups().splice(t,1)}))}),h.sortUsersInGroup(t))})};this.removeGroupUser=function(e,t){o.info("[groupService] removeGroupUser : "+e+"/"+t.id);var n=a.defer();return s({method:"DELETE",url:h.portalURL+"groups/"+e+"/users/"+t.dbId,headers:c.getRequestHeader()}).then(function(){o.info("[groupService] removeGroupUser success : "+e+"/"+t.id),v(e,t.dbId),d.$broadcast(h.ON_GROUP_USERS_UPDATE_EVENT),n.resolve(e)},function(e){var t="removeGroupUser"+h.handleErrorMessage(e);n.reject(new Error(t)),o.error("[groupService] "+t)}),n.promise},this.getUserGroups=function(r){if(!r)return o.info("[groupService] getUserGroups for unknown user !"),a.when();o.info("[groupService] getUserGroups for user : "+r.id);var i=a.defer(),e=r.getGroups();return e?a.when(e):(s({method:"GET",url:h.portalURL+"groups?userId="+r.dbId,headers:c.getRequestHeader()}).then(function(e){var t=e.data.data;o.info("[groupService] getUserGroups success (find "+e.data.total+" group(s))");var n=[];t.forEach(function(e){var t=l.createFromData(e);n.push(t)}),r.setGroups(n),h.logUserGroups(r.displayNameForLog(),n),i.resolve(n)},function(e){var t="getUserGroups"+h.handleErrorMessage(e);i.reject(new Error(t)),o.error("[groupService] "+t)}),i.promise)},this.getGroupFromName=function(n){o.info("[groupService] getGroupFromName : "+n);var r=a.defer();return this.getGroups().then(function(e){var t=null;e.forEach(function(e){e.name===n&&(t=e)}),r.resolve(t)}),r.promise},this.sortUsersInGroup=function(e){e&&(e.sortedUserList=t.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity(e.users,d.orderType,d.filterType,!0))},this.searchLocalGroup=function(t){var n=[];return o.info("[groupService] searchLocalGroup with text "+t),t&&h.groups.forEach(function(e){0<=e.name.toLowerCase().indexOf(t.toLowerCase().toString())&&n.push(e)}),n},this.extractStanzaData=function(e){var t=a.defer(),n={outgoingMessage:!1};return n.body=angular.element(e)[0].firstChild,n.messageId=angular.element(e).attr("id"),t.resolve(n),t.promise},this.onGroupMessageReceived=function(e){try{return this.extractStanzaData(e).then(function(e){if(e.body&&"group"===e.body.tagName){var t=e.body.getAttribute("action"),n=e.body.getAttribute("scope"),r=e.body.getAttribute("id");switch(n){case"group":switch(t){case"create":h.getGroup(r),d.$broadcast(h.ON_CREATED_GROUP_EVENT,r);break;case"update":var i=e.body.getAttribute("name"),a=e.body.getAttribute("comment"),o="true"===e.body.getAttribute("isFavorite");d.$broadcast(h.ON_UPDATE_GROUP_EVENT,r,i,a,o);break;case"delete":p(r),d.$broadcast(h.ON_REMOVED_GROUP_EVENT,r)}break;case"user":var s=e.body.getAttribute("userId");switch(t){case"create":c=r,l=s,h.groups.some(function(n){return n.id===c&&!n.users.some(function(e){return l===e.dbId})&&(u.getContactByDBId(l).then(function(e){n.users.push(e),h.sortUsersInGroup(n);var t=[n];e.getGroups()?e.getGroups().push(n):e.setGroups(t),d.$broadcast(h.ON_ADD_GROUP_USER_EVENT,c,l)}),!0)})||d.$broadcast(h.ON_ADD_GROUP_USER_EVENT,c,l);break;case"delete":v(r,s),d.$broadcast(h.ON_REMOVE_GROUP_USER_EVENT,r,s)}}}var c,l}),!0}catch(e){return!0}},this.attachHandlers=function(){h.removeHandlers(),h.groupMessageHandlerRef||(h.groupMessageHandlerRef=e.addHandler(function(e){return h.onGroupMessageReceived(e)},null,"message","management"))},this.removeHandlers=function(){h.groupMessageHandlerRef&&(e.deleteHandler(h.groupMessageHandlerRef),h.groupMessageHandlerRef=null)},this.handleBadRequest=function(e,t){if(400===t.status&&t.data.errorDetails&&0<t.data.errorDetails.length){var n={};t.data.errorDetails.forEach(function(e){n[e.param]=e.msg});var r=new Error(e+" failure: BadRequest");return r.fieldErrors=n,r}return null},this.handleErrorMessage=function(e){var t=" failure: ";return 500===e.status&&(t+="Internal server error"),403===e.status?t+="Access is forbidden for the current user":404===e.status?t+=e.data.errorMsg:e.data&&e.data.errorDetails&&(t+=e.data.errorDetails),t},this.logUserGroups=function(e,t){var n="";t&&0!==t.length&&(t.forEach(function(e){e.name&&(n+=" "+e.name)}),o.info("[groupService] logUserGroups for "+e+":"+n))},this.logGroupUsers=function(e){var t;e&&e.users&&0!==e.users.length&&(t=e.users.map(function(e){return e.displayNameForLog()}).join(" / "),o.info("[groupService] logGroupUsers for "+e.name+": "+t))}}])}();var MPCallState,TO_PILLAR_POLLING_MIN=3e5,TO_PILLAR_POLLING_MAX=9e5,TO_PILLAR_POLLING_STEP=TO_PILLAR_POLLING_MAX/500;!function(e){e[e.Unknow=0]="Unknow",e[e.Free=1]="Free",e[e.WaitWebrtc=2]="WaitWebrtc",e[e.WaitTelephony=3]="WaitTelephony",e[e.CallOffer=4]="CallOffer",e[e.CallOnGoing=5]="CallOnGoing",e[e.CallActive=6]="CallActive",e[e.CallActiveNoWebMedia=7]="CallActiveNoWebMedia",e[e.TelCallReleasing=8]="TelCallReleasing",e[e.WebCallReleasing=9]="WebCallReleasing",e[e.RemoteControled=10]="RemoteControled",e[e.AnomalyCCS=11]="AnomalyCCS"}(MPCallState||(MPCallState={}));var WebrtcGatewayService=function(){function e(e,t,n,r,i,a,o,s,c,l,d,u,f,h,p){this.$q=e,this.$rootScope=t,this.$log=n,this.$http=r,this.authService=i,this.$interval=a,this.xmppService=o,this.videoService=s,this.errorHelperService=c,this.contactService=l,this.profileService=d,this.Call=u,this.uuid4=f,this.telephonyService=h,this.settingsService=p,this.started=!1,this.myContact=null,this.mediaPillarContact=null,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarJid="",this.evtQueue=[],this.SEM=0,this.fakeMediaPillarJid="00a241586a984a869c73719007b27921@demo-all-in-one-dev-1.opentouch.cloud",this.TO_transition=15e3,this.TO_transition_long=3e4,this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN}return e.prototype.start=function(i){var a=this;return this.$q(function(n){var r=performance.now();a.mediaPillarConfigured=!1,a.mediaPillarAlive=!1,a.portalURL=config.restServerUrl+"/api/rainbow/mediapillar/v1.0/mediapillars",a.myContact=a.contactService.userContact,a.mediaPillarContact=null,a.mediaPillarCallContext={callState:MPCallState.Free,keepAlive_TO:null,callState_TO:null,isOutgoingCall3PCC:!1,telephonyCallRefs:[],webrtcCallRef:null,mediaPillarJid:"",rainbowPhoneNumber:"",remoteExtension:"",previousCallConnectionId:null,previousCallStatus:null},a.profileService.isFeatureEnabled(a.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)?(a.$log.info("[WebrtcGatewayService] === STARTING ==="),a.started=!0,a.SEM=0,a.resetEvtAutomaton(),a.getMediaPillarData().then(function(e){a.mediaPillarContact=a.createMediaPillarContact(e),a.mediaPillarCallContext.mediaPillarJid=e,a.$log.info("[WebrtcGatewayService] Pillar remoteExtension used : "+a.mediaPillarCallContext.remoteExtension),""!==a.mediaPillarCallContext.remoteExtension?a.mediaPillarConfigured=!0:(a.$log.warn("[WebrtcGatewayService] no remoteExtention available "),a.mediaPillarConfigured=!1),a.mediaPillarConfigured&&a.dummyRegisterMediaPillarCall().then(function(){a.mediaPillarAlive=!0,a.$log.info("[WebrtcGatewayService] Pseudo media pillar register OK with extension "+a.mediaPillarCallContext.remoteExtension),a.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",a.mediaPillarAlive)}).catch(function(e){a.mediaPillarAlive=!1,a.$log.info("[WebrtcGatewayService] Pseudo media pillar register KO"),a.$log.info("[WebrtcGatewayService] Initial polling activated on starting issue"),a.mediaPillarKeepAlivePolling("START",TO_PILLAR_POLLING_MIN),a.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",a.mediaPillarAlive)}),a.$rootScope.$on("$destroy",a.$rootScope.$on("ON_CALL_UPDATED_EVENT",function(e,t,n){a.onCallEvent(e,t,n)})),a.$rootScope.$on("$destroy",a.$rootScope.$on("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",function(e,t){a.onRemoteCtrlCall(e,t)}));var t=Math.round(performance.now()-r);i.push({service:"WebrtcGatewayService",startDuration:t}),a.$log.info("[WebrtcGatewayService] === STARTED ("+t+" ms) ==="),n()}).catch(function(e){a.mediaPillarCallContext.mediaPillarJid="",a.mediaPillarCallContext.rainbowPhoneNumber="",a.mediaPillarCallContext.remoteExtension="",a.mediaPillarConfigured=!1,a.mediaPillarAlive=!1,a.$log.info("[WebrtcGatewayService] === STARTING FAILURE === "+e.message),n()})):(a.$log.info("[WebrtcGatewayService] === NO WEBRTCGATEWAY ENVOLVED === "),n())})},e.prototype.stop=function(){return this.$log.info("[WebrtcGatewayService] === STOPPING ==="),this.started=!1,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarKeepAlivePolling("STOP",0),this.mediaPillarCallContext&&(this.releaseMediaPillarCallContext(),this.mediaPillarCallContext.callState=MPCallState.Unknow,this.mediaPillarCallContext.mediaPillarJid="",this.mediaPillarCallContext.rainbowPhoneNumber="",this.mediaPillarCallContext.remoteExtension=""),this.$log.info("[WebrtcGatewayService] === STOPPED ==="),this.$q.resolve()},e.prototype.onCallEvent=function(e,t,n){if(this.isMediaPillarCallCase()){if(this.SEM++,this.$log.info("[WebrtcGatewayService] onCallEvent IN("+this.SEM+") state = "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onCallEvent "+this.mediaPillarCallContext.callState+" --- "+t.type.value+"("+t.id+","+t.status.value+")"),t.connectionId===this.mediaPillarCallContext.previousCallConnectionId&&t.status===this.mediaPillarCallContext.previousCallStatus)return this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.$log.info("[WebrtcGatewayService] onCallEvent | DEBOUNCE EVT"),this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+")");if(t.type.value===this.Call.Type.PHONE.value&&null===t.id)return this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.$log.info("[WebrtcGatewayService] onCallEvent | FILTER EVT null/error"),this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+")");if(n&&null!==n&&this.$log.info("[WebrtcGatewayService] onCallEvent tel infoEvt : Evt = "+n.actionElemName+" / cause = "+n.cause),this.mediaPillarCallContext.previousCallConnectionId=t.connectionId,this.mediaPillarCallContext.previousCallStatus=t.status,this.evtQueue.push(t),1<this.evtQueue.length)return this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+") evt pushed = "+t.status.value);for(;this.evtQueue.length;){try{this.processEvt(this.evtQueue[0])}catch(e){this.$log.error("[WebrtcGatewayService] onCallEvent queue processing | call : "+this.evtQueue[0].status.value+" Error : "+e)}this.evtQueue.splice(0,1)}this.SEM--,this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+") state = "+this.mediaPillarCallContext.callState),0!==this.SEM&&(this.$log.error("[WebrtcGatewayService] onCallEvent OUT | Unmanaged Eventing Reentrancy Situation"),this.resetEvtAutomaton(),this.SEM=0)}},e.prototype.processEvt=function(e){var t,n=this;if(this.$log.info("[WebrtcGatewayService] processEvt | process "+e.type.value+"("+e.id+","+e.status.value+") in MPcontextCallstate = "+this.mediaPillarCallContext.callState),e.type.value===this.Call.Type.PHONE.value){var r=this.telephonyService.getCalls().length;if(t=!1,e.status===n.Call.Status.DIALING&&(e.isSecondary=!0),e.isSecondary?e.status===n.Call.Status.UNKNOWN||e.status===n.Call.Status.RINGING_INCOMMING||e.status===n.Call.Status.QUEUED_INCOMMING||e.status===n.Call.Status.ACTIVE?(n.addTelCallRefs(e),t=!1):n.mediaPillarCallContext.callState===MPCallState.RemoteControled?(n.$log.info("[WebrtcGatewayService] processEvt |  RemoteControled state for call : "+e.id+" then ignore"),t=!0):(n.addTelCallRefs(e),1<n.mediaPillarCallContext.telephonyCallRefs.length?(n.$log.info("[WebrtcGatewayService] processEvt |  nthCall : "+n.mediaPillarCallContext.telephonyCallRefs.length+" then ignore"),t=!0):t):(n.$log.info("[WebrtcGatewayService] processEvt | NOT SECONDARY then ignore"),t=!0))this.$log.info("[WebrtcGatewayService] processEvt |  call("+e.id+" / SEC "+e.isSecondary+", "+e.status.value+") -> EVT IGNORED"),this.$log.info("[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = "+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info("[WebrtcGatewayService] processEvt |  calls.length = "+r);else switch(this.$log.info("[WebrtcGatewayService] processEvt |  call("+e.id+" / SEC "+e.isSecondary+", "+e.status.value+") -> EVT PROCESSED"),this.$log.info("[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = "+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info("[WebrtcGatewayService] processEvt |  calls.length = "+r),e.status){case this.Call.Status.RINGING_INCOMMING:this.onTelCallIncomming(e);break;case this.Call.Status.DIALING:this.onTelCallDialling(e);break;case this.Call.Status.RINGING_OUTGOING:this.onTelCallOutgoing(e);break;case this.Call.Status.ACTIVE:this.onTelCallActive(e);break;case this.Call.Status.UNKNOWN:this.onTelCallReleasing(e)}}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(e.fullJid)))switch(e.status){case this.Call.Status.RINGING_INCOMMING:this.onWebrtcCallIncomming(e);break;case this.Call.Status.CONNECTING:this.onWebrtcCallConnecting(e);break;case this.Call.Status.ACTIVE:this.onWebrtcCallActive(e);break;case this.Call.Status.ANSWERING:this.onWebrtcCallAnswering(e);break;case this.Call.Status.UNKNOWN:this.onWebrtcCallReleasing(e)}else this.$log.info("[WebrtcGatewayService] processEvt | process call("+e.id+","+e.status.value+") -> Not a webrtcgateway case")},e.prototype.releaseMediaPillarCallContext=function(){this.mediaPillarCallContext.callState=MPCallState.Free,this.stopCallStateTimeOut(),this.mediaPillarCallContext.isOutgoingCall3PCC=!1,0<this.mediaPillarCallContext.telephonyCallRefs.length&&this.$log.warn("[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but telephonyCallRefs not empty !"),null!==this.mediaPillarCallContext.webrtcCallRef&&this.$log.warn("[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but webrtcCallRef not null !"),this.mediaPillarCallContext.telephonyCallRefs=[],this.mediaPillarCallContext.webrtcCallRef=null,this.mediaPillarCallContext.previousCallConnectionId=null,this.mediaPillarCallContext.previousCallStatus="",this.$log.log("[WebrtcGatewayService] releaseMediaPillarCallContext | =====  mediaPillarCallContext RELEASED  ===== ")},e.prototype.resetEvtAutomaton=function(){this.evtQueue=[]},e.prototype.stopCallStateTimeOut=function(){this.mediaPillarCallContext.callState_TO&&this.$interval.cancel(this.mediaPillarCallContext.callState_TO),this.mediaPillarCallContext.callState_TO=null},e.prototype.onRemoteCtrlCall=function(e,t){this.$log.info("[WebrtcGatewayService] onRemoteCtrlCall for call "+t.id+" in previous state: "+this.mediaPillarCallContext.callState+": => Becomes REMOTECONTROLED"),this.mediaPillarCallContext.callState=MPCallState.RemoteControled,this.stopCallStateTimeOut()},e.prototype.addTelCallRefs=function(e){if(null!=e){for(var t=!1,n=0;n<this.mediaPillarCallContext.telephonyCallRefs.length;n++)this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[n].id===e.id&&(t=!0);t||this.mediaPillarCallContext.telephonyCallRefs.push(e)}else this.$log.warn("[WebrtcGatewayService] addTelCallRefs | ANOMALY callRef not valid")},e.prototype.removeTelCallRefs=function(e){if(null!=e)for(var t=0;t<this.mediaPillarCallContext.telephonyCallRefs.length;)this.mediaPillarCallContext.telephonyCallRefs[t].id===e.id?(this.mediaPillarCallContext.telephonyCallRefs.splice(t,1),0===t&&this.mediaPillarCallContext.telephonyCallRefs.length&&(this.mediaPillarCallContext.telephonyCallRefs[0].setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.log("[WebrtcGatewayService] removeTelCallRefs | master MP call becomes : "+this.mediaPillarCallContext.telephonyCallRefs[0].id))):t++;else this.$log.warn("[WebrtcGatewayService] removeTelCallRefs | ANOMALY callRef not valid")},e.prototype.putAsMasterTelCallRefs=function(e){if(null!=e){for(var t=-1,n=0;n<this.mediaPillarCallContext.telephonyCallRefs.length;n++)this.mediaPillarCallContext.telephonyCallRefs[n].id===e.id&&(t=n);if(this.$log.log("[WebrtcGatewayService] putAsMasterTelCallRefs | master MP call is : "+e.id),0!==t)if(-1!==t){var r=this.mediaPillarCallContext.telephonyCallRefs[0];this.mediaPillarCallContext.telephonyCallRefs[0]=e,this.mediaPillarCallContext.telephonyCallRefs[t]=r,e.setMediaPillarCall(this.getMediaPillarCallContext())}else this.$log.warn("[WebrtcGatewayService] putAsMasterTelCallRefs | Anomaly call not in telephonyCallRefs")}else this.$log.warn("[WebrtcGatewayService] putAsMasterTelCallRefs | ANOMALY callRef not valid")},e.prototype.isMasterTelCallRefs=function(e){return null==e?(this.$log.warn("[WebrtcGatewayService] isMasterTelCallRefs | ANOMALY callRef not valid"),!1):0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[0].id===e.id},e.prototype.isInTelCallRefs=function(e){if(null!=e){for(var t=-1,n=0;n<this.mediaPillarCallContext.telephonyCallRefs.length;n++)this.mediaPillarCallContext.telephonyCallRefs[n].id===e.id&&(t=n);return-1!==t}this.$log.warn("[WebrtcGatewayService] isInTelCallRefs | ANOMALY callRef not valid")},e.prototype.automatonDefenseTimout=function(e){var t=this,n=0;if(null!=e)if(e.type.value===this.Call.Type.PHONE.value)switch(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | transition telcall call="+e.id+" evt="+e.status.value+" then timout"),e.status){case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.RINGING_INCOMMING:break;default:this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(n=2)}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(e.fullJid)))switch(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | transition webrtc "+e.status.value+" then timout"),e.status){case this.Call.Status.ACTIVE:break;default:this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(n=2)}else this.$log.warn("[WebrtcGatewayService] automatonDefenseTimout | anomaly transition webrtc call but Not a webrtcgateway case"),n=2;else this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.RemoteControled&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | anomaly timout in unexpected state"),n=2);switch(0!==n&&this.$log.warn("[WebrtcGatewayService] automatonDefenseTimout | actionlevel "+n),n){case 0:break;case 1:this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING);break;case 2:this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.releaseMediaPillarCallContext();break;default:this.MediaPillarCallTerminator()}this.mediaPillarCallContext.callState!==MPCallState.Free&&(this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(null)},this.TO_transition,1))},e.prototype.onTelCallIncomming=function(e){var t=this;if(1<this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.callState!==MPCallState.Free&&this.mediaPillarCallContext.callState!==MPCallState.WaitTelephony&&this.mediaPillarCallContext.callState!==MPCallState.WaitWebrtc)return this.$log.info("[WebrtcGatewayService] onTelCallIncomming | nth calls BUT trig the GUI & link the call"),e.setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+e.id),void this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:e});switch(this.$log.info("[WebrtcGatewayService] onTelCallIncomming | mediapilaryse as necessary for call "+e.id),this.mediaPillaryseTheCall(e,null)){case"Ok":if(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(e)},this.TO_transition,1),!this.isMediaPillarOutgoingCall()&&this.mediaPillarCallContext.callState===MPCallState.CallOffer&&this.mediaPillarCallContext.webrtcCallRef)for(var n=0;n<this.mediaPillarCallContext.telephonyCallRefs.length;n++)this.mediaPillarCallContext.telephonyCallRefs[n].status!==this.Call.Status.RINGING_INCOMMING&&this.mediaPillarCallContext.telephonyCallRefs[n].status!==this.Call.Status.QUEUED_INCOMMING||(this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+e.id),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[n]}));break;case"Ignore":this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ignore evt");break;default:this.$log.error("[WebrtcGatewayService] onTelCallIncomming | media Pillar call anomaly "+status),this.MediaPillarCallTerminator()}},e.prototype.onTelCallDialling=function(e){var t=this;if(this.mediaPillarCallContext.callState===MPCallState.Free||this.mediaPillarCallContext.callState===MPCallState.WaitTelephony||this.mediaPillarCallContext.callState===MPCallState.CallOffer)switch(this.mediaPillarCallContext.callState===MPCallState.CallOffer&&this.$log.warn("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, MPCallState.CallOffer"),this.mediaPillarCallContext.isOutgoingCall3PCC=!0,this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(e)},this.TO_transition,1),this.mediaPillaryseTheCall(e,null)){case"Ok":this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState===MPCallState.CallOffer&&(this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] onTelCallDialling | outgoing3PCC then send webrtc proceed")),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(e)},this.TO_transition,1);break;case"Ignore":this.$log.info("[WebrtcGatewayService] onTelCallDialling | ignore evt");break;default:this.$log.error("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly "+status),this.MediaPillarCallTerminator()}else this.$log.warn("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, MP context not compatible"),this.MediaPillarCallTerminator()},e.prototype.onTelCallOutgoing=function(e){var t=this;this.isMediaPillarOutgoingCall()?(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(e)},this.TO_transition_long,1)):(this.$log.warn("[WebrtcGatewayService] onTelCallOutgoing | media Pillar, not a 1st 3PCC outgoing call then ignore & release MP CallContext"),this.releaseMediaPillarCallContext())},e.prototype.onTelCallActive=function(e){switch(this.mediaPillarCallContext.callState){case MPCallState.CallOnGoing:this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState=MPCallState.CallActive;break;case MPCallState.TelCallReleasing:this.$log.warn("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar , RE-ACTIVATION"),this.stopCallStateTimeOut(),e.setMediaPillarCall(this.getMediaPillarCallContext()),this.mediaPillarCallContext.callState=MPCallState.CallActive;break;case MPCallState.CallActive:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar , ignore tel active on state CallActive ");break;case MPCallState.WebCallReleasing:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state WebCallReleasing then releaseMediaPillarCallContext"),this.releaseMediaPillarCallContext();break;case MPCallState.Free:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = 1 ; probably call taken on deskphone ; ignore active & release call context "),this.releaseMediaPillarCallContext();break;default:this.$log.info("[WebrtcGatewayService] onTelCallActive | Anomaly media Pillar recv tel active on state = "+this.mediaPillarCallContext.callState)}},e.prototype.onTelCallReleasing=function(e){var t=this;if(0<this.telephonyService.getCalls().length||1<this.mediaPillarCallContext.telephonyCallRefs.length)return e.setMediaPillarCall(null),this.removeTelCallRefs(e),void this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+e.id+" -- postpone mediaPillarCallContext release ;  remaining calls = "+this.mediaPillarCallContext.telephonyCallRefs.length);this.isMediaPillarReleasableCall()?(e.setMediaPillarCall(null),this.removeTelCallRefs(e),this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState!==MPCallState.WebCallReleasing&&this.mediaPillarCallContext.callState!==MPCallState.RemoteControled?this.mediaPillarCallContext.callState!==MPCallState.TelCallReleasing?(this.mediaPillarCallContext.callState=MPCallState.TelCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(e)},this.TO_transition,1),this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+e.id+" -- wait web release: state = "+this.mediaPillarCallContext.callState)):this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+e.id+" -- ignore telrelease on state = "+this.mediaPillarCallContext.callState):this.mediaPillarCallContext.callState!==MPCallState.Free&&(this.releaseMediaPillarCallContext(),this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+e.id+" -- release MP context"))):(this.$log.warn("[WebrtcGatewayService] onTelCallReleasing | media Pillar call release anomaly on state = "+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator())},e.prototype.onWebrtcCallIncomming=function(e){var t=this;if(this.mediaPillarCallContext.webrtcCallRef)this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming -- "+e.id+" --- ignored other incomming");else switch(this.mediaPillaryseTheCall(null,e)){case"Ok":if(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(e)},this.TO_transition,1),this.isMediaPillarOutgoingCall())this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | outgoing3PCC then send webrtc proceed");else if(this.mediaPillarCallContext.callState===MPCallState.CallOffer)for(var n=0;n<this.mediaPillarCallContext.telephonyCallRefs.length;n++)this.mediaPillarCallContext.telephonyCallRefs[n].status!==this.Call.Status.RINGING_INCOMMING&&this.mediaPillarCallContext.telephonyCallRefs[n].status!==this.Call.Status.QUEUED_INCOMMING||(this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+this.mediaPillarCallContext.telephonyCallRefs[n].id),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[n]}));break;case"Ignore":break;default:this.$log.error("[WebrtcGatewayService] onWebrtcCallIncomming | media Pillar call anomaly "+status)}},e.prototype.onWebrtcCallConnecting=function(e){this.mediaPillarCallContext.callState===MPCallState.CallActive&&(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnecting"),this.mediaPillarCallContext.callState=MPCallState.CallActiveNoWebMedia)},e.prototype.onWebrtcCallActive=function(e){this.mediaPillarCallContext.callState===MPCallState.CallActiveNoWebMedia&&(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnected"),this.mediaPillarCallContext.callState=MPCallState.CallActive)},e.prototype.onWebrtcCallAnswering=function(e){var t=this;this.mediaPillarCallContext.callState=MPCallState.CallOnGoing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(e)},this.TO_transition,1)},e.prototype.onWebrtcCallReleasing=function(e){var t=this;this.isMediaPillarReleasableCall()?(e.setMediaPillarCall(null),this.mediaPillarCallContext.webrtcCallRef=null,0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.callState!==MPCallState.TelCallReleasing?this.mediaPillarCallContext.callState!==MPCallState.WebCallReleasing?(this.mediaPillarCallContext.callState=MPCallState.WebCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(function(){t.automatonDefenseTimout(e)},this.TO_transition,1),this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+e.id+" -- wait tel release: state = "+this.mediaPillarCallContext.callState)):this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+e.id+" -- ignore webrelease on state = "+this.mediaPillarCallContext.callState):(this.releaseMediaPillarCallContext(),this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+e.id+" -- release MP context"))):(this.$log.warn("[WebrtcGatewayService] onWebrtcCallReleasing | media Pillar call release anomaly on state = "+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator())},e.prototype.mediaPillarMakeCall=function(e,t){this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall");var n=this.getMyMediaPillarJid();if(6<e.length&&t&&(e=t.phonePbx),this.videoService.makingCall=!0,""!==n){var r,i="web_"+this.uuid4.generate();if(t&&null!==t)(r=this.Call.create(this.Call.Status.DIALING,i,this.Call.Type.WEBRTC,t)).fullJid=n,this.mediaPillarStartCall(r,e,n);else(r=this.Call.create(this.Call.Status.DIALING,i,this.Call.Type.WEBRTC,this.mediaPillarContact)).fullJid=n,this.mediaPillarStartCall(r,e,n)}else this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY no mediaPillarJid")},e.prototype.mediaPillarStartCall=function(t,e,n){var r=this;this.$log.info("[WebrtcGatewayService] mediaPillarStartCall for phone number "+e),this.initiateMediaPillarCall(t).then(function(){r.dummyRegisterMediaPillarCall().then(function(){r.$log.info("[WebrtcGatewayService] mediaPillarMakeCall for number "+e),r.videoService.makeJingleCall(t,n,e)}).catch(function(e){r.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY dummyRegisterMediaPillarCall then abort call"),r.abortCall(t)})}).catch(function(e){r.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY initiateMediaPillarCall then abort call"),r.abortCall(t)})},e.prototype.abortCall=function(e){this.videoService.makingCall=!1,e&&this.videoService.removeCallObject(e),this.videoService.resetToSafeState()},e.prototype.initiateMediaPillarCall=function(i){var a=this;return this.$q(function(t,n){a.$log.info("[WebrtcGatewayService] initiateMediaPillarCall");var r=["audio"];a.videoService.getBrowserMedia(r).then(function(e){i.isInitiator=!0,a.videoService.localStreams.push(e),(a.videoService.calls[i.id]=i).localMedia=i.localMedia|a.Call.Media.AUDIO,a.contactService.setBusyState("dnd",a.videoService.calculatePresenceMessage(i)),a.$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",i),t()}).catch(function(e){a.$log.info("[WebrtcGatewayService]   | initate call failure : "+JSON.stringify({error:e.message})),0<=r.indexOf("sharing")||-1===e.toString().indexOf("getUserMedia")||a.videoService.openErrorPopup(),n(e)})})},e.prototype.dummyRegisterMediaPillarCall=function(){var r=this;return this.$q(function(t,n){var e=$iq({from:r.myContact.fullJid,to:r.mediaPillarCallContext.mediaPillarJid,type:"set"}).c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("register").c("jidIm").t(r.contactService.userContact.jid).up().c("jidTel").t(r.contactService.userContact.jidtel).up().c("number").t(r.mediaPillarCallContext.rainbowPhoneNumber).up().c("displayName").t(r.myContact.displayName).up().c("secret").t(r.mediaPillarCallContext.rainbowPhoneNumber).up();r.xmppService.sendIQ(e).then(function(e){t()}).catch(function(e){r.IsMediaPillarUserSelected()&&r.$log.warn("[WebrtcGatewayService] dummyRegisterMediaPillarCall -- register failure -- "+e.message),n(e)})})},e.prototype.getMediaPillarData=function(){var o=this;return this.$q(function(i,a){o.$http({method:"GET",url:o.portalURL+"/data",headers:o.authService.getRequestHeader()}).then(function(e){if(o.$log.log("[WebrtcGatewayService] getMediaPillarData success"),e.data&&e.data.data){var t=e.data.data.prefix,n=e.data.data.rainbowPhoneNumber;t&&n&&(o.mediaPillarCallContext.rainbowPhoneNumber=n,o.mediaPillarCallContext.remoteExtension=t+n);var r=e.data.data.jid_im;r&&-1===r.indexOf("/")&&(r+="/mediapillar"),i(r)}else o.$log.error("[WebrtcGatewayService] getMediaPillarData success -- missing data"),a(new Error("[WebrtcGatewayService] getMediaPillarData -- missing data in response"))}).catch(function(e){var t=o.errorHelperService.handleError(e);o.$log.info("[WebrtcGatewayService] getMediaPillarData error -- "+t.message),a(t)})})},e.prototype.mediaPillarKeepAlivePolling=function(e,t){var n=this;if(this.started)switch(e){case"START":this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&(this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null),this.mediaPillarCallContext.keepAlive_TO=this.$interval(function(){n.mediaPillarKeepAlive()},t,1);break;case"STOP":this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null;break;default:this.$log.error("[WebrtcGatewayService] mediaPillarKeepAlivePolling cmd error : "+e)}},e.prototype.mediaPillarUserSelectAndPolling=function(e){this.started&&(this.$log.log("[WebrtcGatewayService] mediaPillarUserSelectAndPolling : "+e),e?(this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.mediaPillarKeepAlive()):this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling("STOP",0))},e.prototype.mediaPillarKeepAlive=function(){var t=this;this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive");var n=!1;this.dummyRegisterMediaPillarCall().then(function(){n=!0,t.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is UP")}).catch(function(e){n=!1,t.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is DOWN")}).finally(function(){t.mediaPillarAlive!==n&&(t.mediaPillarAlive=n,t.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",t.mediaPillarAlive),t.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive ON_WEBRTCGATEWAY_STATE_CHG")),t.mediaPillarAlive?t.TO_PILLAR_POLLING<TO_PILLAR_POLLING_MAX?t.TO_PILLAR_POLLING+=TO_PILLAR_POLLING_STEP:t.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MAX:(t.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,t.mediaPillarKeepAlivePolling("START",t.TO_PILLAR_POLLING)),t.IsMediaPillarUserSelected()&&t.mediaPillarAlive&&t.mediaPillarKeepAlivePolling("START",t.TO_PILLAR_POLLING)})},e.prototype.forceMPpooling=function(){this.started&&(this.$log.log("[WebrtcGatewayService] forceMPpooling "),this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive))},e.prototype.getMyMediaPillarJid=function(){return this.$log.info("[WebrtcGatewayService] getMyMediaPillarJid : "+this.mediaPillarCallContext.mediaPillarJid),this.mediaPillarCallContext.mediaPillarJid},e.prototype.getMyMediaPillarRemoteExtension=function(){return this.mediaPillarCallContext.remoteExtension},e.prototype.shouldUseMediaPillar=function(){this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected();return void 0!==config.devMediaPillarEnabled&&config.devMediaPillarEnabled||!1,!1},e.prototype.isMediaPillarConfigured=function(){return this.mediaPillarConfigured&&this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)},e.prototype.isMediaPillarAvailable=function(){var e=this.isMediaPillarConfigured();return e=e&&this.mediaPillarAlive},e.prototype.IsMediaPillarUserSelected=function(){return!this.telephonyService.nomadicObject.makeCallInitiatorIsMain&&this.telephonyService.getNomadicDestination()===this.getMyMediaPillarRemoteExtension()},e.prototype.isMediaPillarJid=function(e){return!!e&&0===e.search("mp_")},e.prototype.isMediaPillarCallCase=function(){return this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected()},e.prototype.isMediaPillarCallSituation=function(e){var t=this.isMediaPillarCallCase();if(e)if(e.type===this.Call.Type.WEBRTC)t=t&&this.isMediaPillarJid(e.fullJid);else if(this.telephonyService.getCalls().length<=1&&this.mediaPillarCallContext.telephonyCallRefs.length<=1)switch(e.status){case this.Call.Status.RINGING_INCOMMING:case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.QUEUED_INCOMMING:case this.Call.Status.DIALING:case this.Call.Status.RELEASING:break;default:t=!!e.mediaPillarCall&&(t&&this.isInTelCallRefs(e))}else switch(e.status){case this.Call.Status.RINGING_INCOMMING:case this.Call.Status.RINGING_OUTGOING:case this.Call.Status.QUEUED_INCOMMING:case this.Call.Status.DIALING:case this.Call.Status.RELEASING:break;default:t=!!e.mediaPillarCall&&((t=t&&1<=e.mediaPillarCall.telephonyCallRefs.length)&&this.isInTelCallRefs(e))}return t},e.prototype.mediaPillaryseTheCall=function(e,t){if(this.mediaPillarCallContext.callState!==MPCallState.Free){if(e&&this.mediaPillarCallContext.callState!==MPCallState.WaitTelephony&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing)return"Ignore";if(t&&this.mediaPillarCallContext.callState!==MPCallState.WaitWebrtc)return"Ignore"}var n="";if(!e&&!t)return"NoCallRef";if(e&&t)return"toManyCallRef";if(e){switch(this.mediaPillarCallContext.callState){case MPCallState.Free:this.mediaPillarCallContext.callState=MPCallState.WaitWebrtc,n="Ok";break;case MPCallState.WaitTelephony:this.mediaPillarCallContext.callState=MPCallState.CallOffer,n="Ok";break;default:this.mediaPillarCallContext.callState=MPCallState.AnomalyCCS,n="Ano_inTel_contextCallState_"+this.mediaPillarCallContext.callState}"Ok"===n&&(this.putAsMasterTelCallRefs(e),e.setMediaPillarCall(this.getMediaPillarCallContext()))}else if(t){switch(this.mediaPillarCallContext.webrtcCallRef=t,this.mediaPillarCallContext.callState){case MPCallState.Free:this.mediaPillarCallContext.callState=MPCallState.WaitTelephony,n="Ok";break;case MPCallState.WaitWebrtc:this.mediaPillarCallContext.callState=MPCallState.CallOffer,n="Ok";break;default:this.mediaPillarCallContext.callState=MPCallState.AnomalyCCS,n="Ano_inWrtc_contextCallState_"+this.mediaPillarCallContext.callState}"Ok"===n&&t.setMediaPillarCall(this.getMediaPillarCallContext())}return n},e.prototype.getMediaPillarCallContext=function(){return this.mediaPillarCallContext},e.prototype.isMediaPillarOutgoingCall=function(){var e;switch(this.mediaPillarCallContext.callState){case MPCallState.WaitWebrtc:case MPCallState.WaitTelephony:case MPCallState.CallOffer:case MPCallState.CallOnGoing:case MPCallState.CallActive:case MPCallState.CallActiveNoWebMedia:case MPCallState.TelCallReleasing:case MPCallState.WebCallReleasing:e=!0;break;default:e=!1}return e&&this.mediaPillarCallContext.isOutgoingCall3PCC},e.prototype.isMediaPillarReleasableCall=function(){var e;switch(this.mediaPillarCallContext.callState){case MPCallState.AnomalyCCS:case MPCallState.Unknow:e=!1;break;default:e=!0}return e},e.prototype.MediaPillarCallTerminator=function(){var t=this;0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs.forEach(function(e){null!==e&&e.type.value===t.Call.Type.PHONE.value&&(e.mediaPillarCall=null,t.telephonyService.releaseCall(e),t.$log.info("[WebrtcGatewayService] MediaPillarCallTerminator | release call"+e))}),this.mediaPillarCallContext.webrtcCallRef&&(this.mediaPillarCallContext.webrtcCallRef.mediaPillarCall=null,this.videoService.releaseCall(this.mediaPillarCallContext.webrtcCallRef)),this.releaseMediaPillarCallContext(),this.resetEvtAutomaton(),this.TO_PILLAR_POLLING+=TO_PILLAR_POLLING_MIN,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.$log.warn("[WebrtcGatewayService] MediaPillarCallTerminator | Full cleaning")},e.prototype.createMediaPillarContact=function(e){this.$log.info("[webrtcGatewayService] createMediaPillarContact -- "+e);var t=this.contactService.createBasicContact(e);return t.displayName="mediaPillar",t.avatar=new Image,t.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",t},e.prototype.muteAudio=function(e,t){if(e){if(this.isMediaPillarCallSituation(e)){var n=this.mediaPillarCallContext.webrtcCallRef;if(n){var r=this.xmppService.connection.jingle.sessions[n.id];r?(r.muteAudio(t),e.isMuted=t,this.$log.info("[webrtcGatewayService] muteAudio "+e.id+"-- "+(t?"mute":"unumute")),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{call:e})):this.$log.error("[webrtcGatewayService] muteAudio "+e.id+" -- failure: no session")}}}else this.$log.error("[webrtcGatewayService] muteAudio - trying to mute a non existing call !")},e.prototype.getActivePbxCall=function(){var t=this;return this.isMediaPillarCallCase()&&this.mediaPillarCallContext?this.mediaPillarCallContext.telephonyCallRefs.find(function(e){return e.status===t.Call.Status.ACTIVE}):null},e.$inject=["$q","$rootScope","$log","$http","authService","$interval","xmppService","videoService","errorHelperService","contactService","profileService","Call","uuid4","telephonyService","settingsService"],e}();angular.module("rainbow").service("webrtcGatewayService",WebrtcGatewayService),angular.module("rainbow").service("callLogService",["$q","$log","$rootScope","$interval","contactService","xmppService","CallLog","orderByFilter","profileService","$injector","telephonyService","webrtcGatewayService",function(a,R,i,e,o,r,y,t,T,I,N,A){"use strict";var O=this;this.started=!1,this.callLogs=[],this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.callLogsPromises=[],this.callLogNamespace="jabber:iq:telephony:call_log",this.callLogAckNamespace="urn:xmpp:telephony:call_log:receipts",this.callLogNotificationsNamespace="jabber:iq:notification:telephony:call_log",this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.callLogNotificationRef=null,this.numberMissedCalls=0,this.lastTimestamp=null,this.callLogsHistory=[],this.telephonyCallLog={},this.telephonyCallLogHistory={},this.deferedObject=null,this.callLogComplete=!1,this.callLogIndex=-1,this.start=function(n){return R.info(""),R.info("[callLogService] === STARTING ==="),this.attachHandlers(),e(function(){var t=performance.now();O.getCallLogHistoryPage().then(function(){var e=Math.round(performance.now()-t);n.push({service:"callLogService",startDuration:e}),R.info("[callLogService] === STARTED ("+e+" ms) ==="),O.started=!0}).catch(function(){R.error("[callLogService] === STARTING FAILURE ===")})},3e3,1,!0),a.when()},this.stop=function(){return R.info("[callLogService] Stopping"),this.started=!1,this.callLogs=[],this.callLogsPromises=[],this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.numberMissedCalls=0,this.lastTimestamp=null,this.telephonyCallLog={},this.telephonyCallLogHistory={},this.callLogComplete=!1,this.callLogIndex=-1,this.callLogsHistory=[],R.info("[callLogService] Stopped"),a.when()},this.attachHandlers=function(){R.info("[callLogService] attachHandlers"),O.callLogHandlerRef&&(r.connection.deleteHandler(O.callLogHandlerRef),O.callLogHandlerRef=null),O.callLogMessageAckRef&&(r.connection.deleteHandler(O.callLogMessageAckRef),O.callLogMessageAckRef=null),O.callLogNotificationRef&&(r.connection.deleteHandler(O.callLogNotificationRef),O.callLogNotificationRef=null),O.callLogHandlerRef=r.connection.addHandler(O.onCallLogMessageReceived,O.callLogNamespace,null,null),O.callLogMessageAckRef=r.connection.addHandler(O.onCallLogAckReceived,O.callLogAckNamespace,null,null),O.callLogNotificationRef=r.connection.addHandler(O.callLogNotificationReceived,O.callLogNotificationsNamespace,null,null),O.started&&O.lastTimestamp&&e(function(){O.getCallLogHistoryPage(O.lastTimestamp)},1e3,1,!0)},this.getCallLogHistoryPage=function(e){R.info("[callLogService] getCallLogHistoryPage");var t=o.userContact,n=$iq({from:t.jid,type:"set"}).c("query",{xmlns:this.callLogNamespace});return n.c("set",{xmlns:"http://jabber.org/protocol/rsm"}),n.c("max").t(75).up(),e?n.c("after").t(e).up():n.c("before").t("").up(),n.up(),n.up(),r.sendIQ(n),a.when()},this.deleteOneCallLog=function(e){R.info("[callLogService] deleteOneCallLog "+e);var t=o.userContact,n=$iq({from:t.jid,to:t.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace,call_id:e});r.sendIQ(n)},this.deleteCallLogsForContact=function(e){R.info("[callLogService] deleteCallLogsForContact "+e);var t=o.userContact,n=$iq({from:t.jid,to:t.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace,peer:e});r.sendIQ(n)},this.deleteAllCallLogs=function(){R.info("[callLogService] deleteAllCallLogs");var e=o.userContact,t=$iq({from:e.jid,to:e.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace});r.sendIQ(t)},this.markCallLogAsRead=function(e){R.info("[callLogService] markCallLogAsRead "+e);var t=o.userContact,n=$msg({from:t.jid,to:t.jid}).c("read",{xmlns:this.callLogAckNamespace,call_id:e});r.sendIQ(n)},this.markAllCallsLogsAsRead=function(){R.info("[callLogService] markAllCallsLogsAsRead ");for(var e=o.userContact,t=0;t<O.callLogs.length;t++)if(!O.callLogs[t].read){var n=$msg({from:e.jid,to:e.jid}).c("read",{xmlns:this.callLogAckNamespace,call_id:O.callLogs[t].id});r.sendIQ(n)}},this.onCallLogMessageReceived=function(e){try{0<$(e).find("call_log").length?O.callLogsPromises.push(O.createCallLogFromMessage(e)):0<$(e).find("count").length&&0<$(e).find("query").length?(O.lastTimestamp=$(e).find("last").text(),a.all(O.callLogsPromises).finally(function(){R.info("[callLogService] onCallLogMessageReceived : all call logs are ready"),O.callLogsPromises=[],O.orderCallLogsFunction(),i.$broadcast("ON_CALL_LOG_UPDATED");var e=O.getMissedCallLogCounter();e!==O.numberMissedCalls&&(O.numberMissedCalls=e,i.$broadcast("ON_CALL_LOG_ACK_UPDATED"))})):R.info("[callLogService] onCallLogMessageReceived : ignored !")}catch(e){return R.error("[callLogService] onCallLogMessageReceived "+e),!0}return!0},this.onCallLogAckReceived=function(e){try{if(R.info("[callLogService] onCallLogAckReceived"),0<$(e).find("read").length){var t=$(e).find("read").attr("call_id");O.callLogAckUpdate(t);var n=O.getMissedCallLogCounter();n!==O.numberMissedCalls&&(O.numberMissedCalls=n,i.$broadcast("ON_CALL_LOG_ACK_UPDATED"))}}catch(e){return R.error("[callLogService] onCallLogAckReceived "+e),!0}return!0},this.callLogNotificationReceived=function(e){R.info("[callLogService] callLogNotificationReceived");try{if(0<$(e).find("deleted_call_log").length){R.info("[callLogService] callLogNotificationReceived : deleted IQ");var t=$(e).find("deleted_call_log").attr("peer");t?O.removeCallLogsForUser(t):O.resetCallLogs()}else 0<$(e).find("updated_call_log").length&&(R.info("[callLogService] callLogNotificationReceived : Update call-logs"),O.callLogsPromises.push(O.createCallLogFromMessage(e)),a.all(O.callLogsPromises).finally(function(){R.info("[callLogService] callLogNotificationReceived : update is done"),O.callLogsPromises=[],O.orderCallLogsFunction(),i.$broadcast("ON_CALL_LOG_UPDATED");var e=O.getMissedCallLogCounter();e!==O.numberMissedCalls&&(O.numberMissedCalls=e,i.$broadcast("ON_CALL_LOG_ACK_UPDATED"))}))}catch(e){return R.error("[callLogService] callLogNotificationReceived ERROR "+e),!0}return!0},this.removeCallLogsForUser=function(e){e.endsWith("@_")&&(e=e.substring(0,e.length-2)),R.info("[callLogService] removeCallLogsForUser with jid: "+e);for(var t=[],n=0;n<O.callLogs.length;n++)(!O.callLogs[n].contact||O.callLogs[n].contact.jid!==e&&O.callLogs[n].contact.id!==e)&&t.push(O.callLogs[n]);O.callLogs=t,O.orderCallLogsFunction(),i.$broadcast("ON_CALL_LOG_UPDATED");var r=O.getMissedCallLogCounter();r!==O.numberMissedCalls&&(O.numberMissedCalls=r,i.$broadcast("ON_CALL_LOG_ACK_UPDATED"))},this.createCallLogFromMessage=function(e){var s=a.defer(),t=$(e),c=null,l=null,d="",u=t.find("call_id").text(),n=t.find("caller").text(),r=t.find("callee").text(),f=t.find("state").text(),h=parseInt(t.find("duration").text(),10),p=t.find("subject").text(),v="",m="",g="",S="webrtc";if(n&&-1!==n.indexOf("janusgateway")||r&&-1!==r.indexOf("janusgateway"))return R.info("[callLogService] createCallLogFromMessage ignore janusgateway call-logs"),void a.when();if(n&&A.isMediaPillarJid(n)||r&&A.isMediaPillarJid(r))return R.info("[callLogService] createCallLogFromMessage ignore janusgateway call-logs"),void a.when();var i=t.find("call_log").attr("type");i||(i=t.find("type").text());var C="true"===t.find("ack").attr("read"),E=t.find("delay").attr("stamp"),b="conference"===t.find("call_log").attr("service");return(T.isFeatureEnabled(T.FeaturesEnum.TELEPHONY_PHONE_BOOK)||config.permitSearchFromPhoneBook)&&(v=t.find("identity")),h=0<h?moment.duration(h,"ms").format("h[H] mm[m] ss[s]"):0,E&&(E=new Date(E)),b?(c=n,S="conference",d=o.isUserContactJid(n)?"outgoing":"incoming",-1===c.indexOf("@")&&(l=c,c=null)):("phone"===i&&(S="telephone"),o.isUserContactJid(n)?(c=r,d="outgoing"):(c=n,d="incoming"),-1===c.indexOf("@")&&(l=c,c=null,S="telephone")),c||l?o.getOrCreateContact(c,l).then(function(t){if(R.info("[callLogService] createCallLogFromMessage success"),!b&&!c&&t.temp){if(v&&v.length){var e=v.attr("firstName"),n=v.attr("lastName"),r=v.attr("displayName");m=e||"",""===(g=n||"")&&""===m&&r&&0!==r.length&&r!==l&&(g=r),(m.length||g.length)&&(R.debug("[callLogService] createCallLogFromMessage  xNames updated from directories for contact "+t.id),t.updateName(m,g))}else try{var i=I.get("centralizedService");i.outlook.updateContactFromOutlookInfos(t,l,!0).then(function(e){e?R.debug("[callLogService] createCallLogFromMessage  xNames updated from outlook for contact "+t.id):R.debug("[callLogService] createCallLogFromMessage no update from outlook for contact :"+t.id)},function(){R.debug("[callLogService] createCallLogFromMessage  no Outlook search available")})}catch(e){}var a=!1;if(N.started)a=t.displayName.match(/^[0-9A-D #\-\+\*\(\)\./]{1,32}$/)&&N.startAsPhoneNumber(t.displayName);a&&t.phoneProCan&&""!==t.phoneProCan&&(t.displayName=t.phoneProCan)}var o=y.create(u,t,f,h,S,C,E,d,p);O.logAlreadyExists(o)||"failed"===f||"ongoing"===f?R.info("[callLogService] createCallLogFromMessage ignore call log with id: "+u+", state: "+f):O.callLogs.push(o),s.resolve(o)}).catch(function(e){R.error("[callLogService] createCallLogFromMessage error "+e),s.resolve()}):(R.info("[callLogService] createCallLogFromMessage  No jid or no phoneNumber "),s.resolve()),s.promise},this.getOrderByNameCallLogs=function(){return O.orderByNameCallLogs},this.getOrderByDateCallLogs=function(){return 0!==O.orderByDateCallLogs.length&&(O.orderByDateCallLogs[0].isLatestCall=!0,O.orderByDateCallLogs[1]&&(O.orderByDateCallLogs[1].isLatestCall=!1)),O.orderByDateCallLogs},this.getOrderByDateCallLogsBruts=function(){return O.orderByDateCallLogsBruts},this.getSimplifiedCallLogs=function(){return O.simplifiedCallLogs},this.orderCallLogsFunction=function(){R.info("[callLogService] orderByFunction"),O.orderByNameCallLogs=t(O.callLogs,y.getNames,!1,y.sortByContact),O.orderByDateCallLogsBruts=t(O.callLogs,y.getDate,!1,y.sortByDate),O.simplifiedCallLogs=O.simplifyCallLogs(O.orderByDateCallLogsBruts),O.orderByNameCallLogs=O.fusionInformation(O.orderByNameCallLogs),O.orderByDateCallLogs=O.fusionInformation(O.orderByDateCallLogsBruts)},this.simplifyCallLogs=function(e){for(var t=[],n=0;n<e.length;n++)t[n]={},t[n].contact=e[n].contact.id,t[n].contactDisplayName=e[n].contact.displayName,t[n].contactInitials=e[n].contact.initials,t[n].id=e[n].id,t[n].state=e[n].state,t[n].duration=e[n].duration,t[n].direction=e[n].direction,t[n].type=e[n].type,t[n].read=e[n].read,t[n].date=e[n].date;return t},this.fusionInformation=function(e){for(var t={},n=0,r=[],i=0;i<e.length;i++){var a=e[i],o=a.contact.jid;if(a.contact.jid||(o=a.contact.id),"conference"!==a.type)if(0!==i)if(t[o]){var s=r[t[o]-1];s.editable&&(s.isMissed&&"missed"===a.state&&"incoming"===a.direction?s.count++:s.isNotAnswered&&"missed"===a.state&&"outgoing"===a.direction?s.count++:s.editable=!1)}else n++,t[o]=n+1,r[n]=a,r[n].count=1,r[n].editable=!0,"missed"===a.state&&"incoming"===a.direction?r[n].isMissed=!0:"missed"===a.state&&"outgoing"===a.direction&&(r[n].isNotAnswered=!0);else t[o]=1,r[n]=a,r[n].count=1,r[n].editable=!0,"missed"===a.state&&"incoming"===a.direction?r[n].isMissed=!0:"missed"===a.state&&"outgoing"===a.direction&&(r[n].isNotAnswered=!0);else 0!==i&&n++,r[n]=a,r[n].count=1,r[n].editable=!1}return r},this.callLogAckUpdate=function(t){O.callLogs.forEach(function(e){e.id!==t||(e.read=!0)})},this.getMissedCallLogCounter=function(){var t=0;return O.callLogs.forEach(function(e){e.read||"missed"!==e.state||"incoming"!==e.direction||t++}),t},this.getNumberMissedCalls=function(){return O.numberMissedCalls},this.resetCallLogs=function(){R.info("[callLogService] resetCallLogs"),O.callLogs=[],O.getCallLogHistoryPage()},this.logAlreadyExists=function(e){var t;for(t=0;t<O.callLogs.length;t++)if(O.callLogs[t].id===e.id)return!0;return!1}}]),angular.module("rainbow").service("videoService",["$q","$rootScope","$window","$log","$http","$interval","xmppService","contactService","Call","browserService","gRTCStatsService","fRTCStatsService","platformService","gaService","settingsService","authService","VideoServiceEventHandler","extensionSharingService",function(g,S,n,C,s,a,o,c,l,r,i,d,E,b,u,f,e,R){"use strict";var y=this;this.started=!1,this.connected=!1,this.RTC=null,this.videoEventHandler=null,this.config=null,this.calls={},this.localStream=null,this.autoreleaseTimeout=null,this.callsStats={},this.localStreams=[],this.makingCall=!1,this.reconnectCall=!1,this.statsInterval=null,this.audioProfileChanging=!1,this.reverseAudioCallInitiated=!1,this.alreadyAttaching=!1,this.portalURL="";var h=[];this.callsStatsSimplified={},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.getDesktopSharingSource=function(){return null},this.askToAddSharing=function(e){return!1},this.askToStartSharing=function(e,t){return!1},this.start=function(e){C.webrtc("[videoService] SERVICE | === STARTING ===");var t=performance.now();if(this.RTC=y.getBrowserMethodHandler(),this.RTC){y.started=!0,y.connected=!0,y.setWebrtcConfiguration();var n=Math.round(performance.now()-t);e.push({service:"videoService",startDuration:n}),C.info("[videoService] SERVICE | === STARTED ("+n+" ms) ===")}else C.error("[videoService] SERVICE | === STARTING FAILURE ===  webRTC capable browser is really required !");return h.push(S.$on("ON_CONNECTION_STATE_CHANGE_EVENT",y.onConnectionStateChangeEvent)),h.push(S.$on("ON_INPUT_DEVICE_CHANGED_EVENT",y.onAudioProfileChangeEvent)),h.push(S.$on("ON_VIDEO_INPUT_DEVICE_CHANGED_EVENT",y.onVideoInputChangeEvent)),this.attachHandlers(),g.when()},this.stop=function(){try{if(this.started){var e;for(C.webrtc("[videoService] SERVICE | === STOPPING ==="),this.started=!1;e=h.pop();)e();for(var t in y.removeHandlers(),y.config=null,y.calls)if(y.calls.hasOwnProperty(t)){var n=y.calls[t];y.removeCallObject(n)}o.connection.jingle.terminate(),y.connected=!1,y.reconnectCall=!1,y.makingCall=!1,y.statsInterval&&a.cancel(y.statsInterval),C.webrtc("SERVICE | === STOPPED ===")}return g.when()}catch(e){return C.webrtc("[videoService] SERVICE | === STOPPING ERROR : "+e),g.when()}},this.attachHandlers=function(){this.removeHandlers(),C.info("[videoService] attachHandlers"),this.videoEventHandler=e.create(this)},this.removeHandlers=function(){C.info("[videoService] removeHandlers"),this.videoEventHandler&&(this.videoEventHandler=null)},this.setWebrtcConfiguration=function(){return C.webrtc("[videoService] setWebrtcConfiguration"),g(function(t,n){y.config?(C.webrtc("[videoService] setWebrtcConfiguration from stored variable"),o.connection.jingle.ice_config=y.config,t()):(C.webrtc("[videoService] setWebrtcConfiguration from server"),y.getIceConfig().then(function(e){y.config=e,C.info("Max-bundle enabled"),o.connection.jingle.ice_config=y.config,u.setIceConfig(y.config),C.webrtc("[videoService] setWebrtcConfiguration from server success !"),t()}).catch(function(e){C.error("[videoService] setWebrtcConfiguration from server ERROR : "+e),y.openErrorPopup("IceConfigurationFailed"),n()}))})},this.onConnectionStateChangeEvent=function(e,t){try{if("disconnected"===t){for(var n in C.info("MEDIA   | onConnectionStateChangeEvent : disconnected"),y.connected=!1,y.config=null,y.calls)if(y.calls.hasOwnProperty(n)){var r=y.calls[n];y.reconnectCall=!0,r&&r.status!==l.Status.UNKNOWN&&(C.webrtc("INFO    | onConnectionStateChangeEvent : disconnected -> call goes to connecting state"),r.setStatus(l.Status.CONNECTING),S.$broadcast("ON_CALL_UPDATED_EVENT",r)),y.statsInterval&&a.cancel(y.statsInterval)}}else if("connected"===t){for(var n in C.info("MEDIA   | onConnectionStateChangeEvent : connected"),y.attachHandlers(),y.setWebrtcConfiguration(),y.connected=!0,y.statsInterval&&(a.cancel(y.statsInterval),y.statsinterval=null),y.calls)if(y.calls.hasOwnProperty(n)){r=y.calls[n];var i=o.connection.jingle.sessions[r.id];y.reconnectCall&&i&&i.peerconnection&&(C.info("MEDIA   | onConnectionStateChangeEvent : connected - start reconnection on session "+r.id),i.me=c.userContact.fullJid,i.isInitiator&&(i.initiator=i.me),i.connection=o.connection,c.setBusyState("dnd",y.calculatePresenceMessage(r)),i.sendTransportReplace())}y.reconnectCall=!1}}catch(e){C.info("MEDIA   | onConnectionStateChangeEvent : disconnected error : "+e)}},y.isUserContactInCall=function(){for(var e in y.calls){if(y.calls.hasOwnProperty(e))if(y.calls[e].status!==l.Status.UNKNOWN)return!0}return!1},this.getCurrentActiveSession=function(){for(var e in y.calls)if(y.calls.hasOwnProperty(e)){var t=y.calls[e];if(t.status!==l.Status.UNKNOWN)return o.connection.jingle.sessions[t.id]}return null},y.getMediaPillarAudioCall=function(){for(var e in y.calls)if(y.calls.hasOwnProperty(e)){var t=y.calls[e];if(t.status!==l.Status.UNKNOWN&&t.localMedia&l.Media.AUDIO&&t.isMediaPillarCall())return t}return null},y.getMediaPillarSession=function(){var e=y.getMediaPillarAudioCall();return e?o.connection.jingle.sessions[e.id]:null},y.getCurrentSharingCall=function(){for(var e in y.calls)if(y.calls.hasOwnProperty(e)){var t=y.calls[e];if(t.status!==l.Status.UNKNOWN&&(t.localMedia===l.Media.SHARING||t.remoteMedia===l.Media.SHARING))return t}return null},y.endAllCallsForContact=function(e){if(e)for(var t in C.webrtc("[videoService] endAllCallsForContact "+e.jid),y.calls)if(y.calls.hasOwnProperty(t)){var n=y.calls[t];n.status!==l.Status.UNKNOWN&&n.contact&&n.contact.jid===e.jid&&y.releaseCall(n)}},y.onVideoInputChangeEvent=function(){for(var e in C.webrtc("MEDIA   | onVideoInputChangeEvent"),y.calls)if(y.calls.hasOwnProperty(e)){var t=y.calls[e];o.connection.jingle.sessions[t.id]&&t.localMedia&&t.localMedia===l.Media.AUDIO+l.Media.VIDEO&&(C.webrtc("MEDIA   | audio + video call, renegotiate the profile"),y.escalateToVideoCall(t,!0))}},y.onAudioProfileChangeEvent=function(){if(C.webrtc("MEDIA   | onAudioProfileChangeEvent"),y.audioProfileChanging)C.webrtc("MEDIA   | onAudioProfileChangeEvent -- already changing");else for(var e in y.calls)if(y.calls.hasOwnProperty(e)){var t=y.calls[e];o.connection.jingle.sessions[t.id]&&t.localMedia&&(y.audioProfileChanging=!0,a(function(e){y.audioProfileChanging=!1,y.renegotiateCurrentCall(e)},500,1,!0,t))}},this.renegotiateCurrentCall=function(e){e.localMedia===l.Media.AUDIO||e.localMedia===l.Media.AUDIO+l.Media.SHARING?(C.webrtc("MEDIA   | renegotiate the audio profile"),y.addAudioToCall(e,!0)):e.localMedia!==l.Media.AUDIO+l.Media.VIDEO&&e.localMedia!==l.Media.AUDIO+l.Media.SHARING+l.Media.VIDEO||(C.webrtc("MEDIA   | audio + video call, renegotiate the profile"),y.addVideoToCall(e,!0))},this.getCallByJid=function(e){var t=null;if(!e)return t;for(var n in C.webrtc("[videoService] getCallByJid "+e),y.calls)if(y.calls.hasOwnProperty(n)){var r=y.calls[n];if(r.contact&&r.contact.jid===e){t=r;break}}return t},this.resetAudioOutputElement=function(){E.allowDevicesManagement()&&!this.audioProfileChanging&&($("#globalAudioTag").length?(C.webrtc("[videoService] resetAudioOutputElement"),this.audioProfileChanging=!0,E.getCurrentSpeaker().then(function(e){var t="default";e&&e.id&&(t=e.id);var n="default";"default"!==t&&DetectRTC.audioOutputDevices.forEach(function(e){"default"!==e.deviceId&&"communications"!==e.deviceId&&e.deviceId!==t&&(n=e.deviceId)}),$("#globalAudioTag")[0].setSinkId(n).then(function(){C.webrtc("[videoService] resetAudioOutputElement sinkId is "+$("#globalAudioTag")[0].sinkId),"default"!==t?$("#globalAudioTag")[0].setSinkId(t).then(function(){C.webrtc("[videoService] resetAudioOutputElement sinkId is "+$("#globalAudioTag")[0].sinkId),y.audioProfileChanging=!1,$("#globalAudioTag")[0].load&&$("#globalAudioTag")[0].load()}).catch(function(){y.audioProfileChanging=!1}):y.audioProfileChanging=!1}).catch(function(e){C.warn("[videoService] resetAudioOutputElement globalAudioTag error "+e),y.audioProfileChanging=!1}),a(function(){$("#largevideo")[0]&&$("#largevideo")[0].setSinkId(n).then(function(){C.webrtc("[videoService] resetAudioOutputElement largevideo "+$("#largevideo")[0].sinkId),"default"!==t&&$("#largevideo")[0].setSinkId(t).then(function(){C.webrtc("[videoService] resetAudioOutputElement largevideo "+$("#largevideo")[0].sinkId)}).catch(function(e){C.warn("[videoService] resetAudioOutputElement largevideo error "+e)})}).catch(function(e){C.warn("[videoService] resetAudioOutputElement largevideo error "+e)}),$("#p2pSecondVideo")[0]&&$("#p2pSecondVideo")[0].setSinkId(n).then(function(){"default"!==t&&$("#p2pSecondVideo")[0].setSinkId(t).then(function(){C.webrtc("[videoService] resetAudioOutputElement p2pSecondVideo "+$("#p2pSecondVideo")[0].sinkId)}).catch(function(e){C.warn("[videoService] resetAudioOutputElement p2pSecondVideo error "+e)})}).catch(function(e){C.warn("[videoService] resetAudioOutputElement p2pSecondVideo error "+e)})},3e3,1)}).catch(function(){C.webrtc("[videoService] resetAudioOutputElement getCurrentSpeaker error"),y.audioProfileChanging=!1})):C.warn("[videoService] resetAudioOutputElement -- missing global audio tag !"))},this.disableAudioVideoMedia=function(t,n){if(t?C.webrtc("MEDIA   | disableAudioVideoMedia for session "+JSON.stringify({sid:t.sid})):n?C.webrtc("MEDIA   | disableAudioVideoMedia no session, sessionId: "+n):C.webrtc("MEDIA   | disableAudioVideoMedia no session, no session Id"),!t&&!n){var e=y.localStreams.length;if(0<y.localStreams.length)for(y.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null});0<y.localStreams.length;){y.localStreams.pop();null}C.webrtc("MEDIA   | disableAudioVideoMedia : All local streams stopped and removed: "+e)}if(t){if(0<t.localStreams.length){var r=t.localStreams.length;for(t.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null}),y.localStreams=y.localStreams.filter(function(e){return!t.localStreams.includes(e)});0<t.localStreams.length;){t.localStreams.pop();null}C.webrtc("MEDIA   | disableAudioVideoMedia : Session streams stopped and removed: "+r+". Remaining local streams: "+y.localStreams.length)}}else if(n){var i=y.localStreams.filter(function(e){return e.callId===n});if(i){r=i.length;i.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),y.localStreams.splice(y.localStreams.indexOf(e),1),e=null}),C.webrtc("MEDIA   | disableAudioVideoMedia : Locals streams for sessionId "+n+" stopped and removed: "+r+". Remaining local streams: "+y.localStreams.length)}}y.statsInterval&&(a.cancel(y.statsInterval),y.statsinterval=null)},this.attachDistantMediaStreams=function(e,t){if(e){if(y.alreadyAttaching)return;y.alreadyAttaching=!0;var n=o.connection.jingle.sessions[t.id];if(n.remoteStreams){var r,i;if(1<n.remoteStreams.length)n.remoteStreams[0].getAudioTracks().length?(i=n.remoteStreams[0],r=n.remoteStreams[1]):(r=n.remoteStreams[0],i=n.remoteStreams[1]),0<r.getVideoTracks().length&&(C.webrtc("attachDistantMediaStreams video track for element largevideo "+r.id),y.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),r,r.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),0<r.getAudioTracks().length&&(C.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+r.id),y.RTC.attachMediaStream(angular.element("#globalAudioTag"),r)),0<i.getVideoTracks().length&&(C.webrtc("attachDistantMediaStreams video track for element p2pSecondVideo "+i.id),y.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),i,i.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),0<i.getAudioTracks().length&&(C.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+i.id),y.RTC.attachMediaStream(angular.element("#globalAudioTag"),i));else n.remoteStreams.forEach(function(e){0<e.getVideoTracks().length&&(C.webrtc("attachDistantMediaStreams video track"),y.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,e.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0),y.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),e,e.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),0<e.getAudioTracks().length&&(C.webrtc("attachDistantMediaStreams audio track"),y.RTC.attachMediaStream(angular.element("#globalAudioTag"),e))});y.alreadyAttaching=!1}}else y.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.clearMediaStream(angular.element("#globalAudioTag"),null))},this.attachLocalMediaStreams=function(e){if(C.webrtc("attachLocalMediaStreams "+e),e){if(this.localStreams&&this.localStreams.length){var t=!1;this.localStreams.forEach(function(e){e.getVideoTracks().length&&e.getAudioTracks().length?(t?y.RTC.attachMediaStreamIfNeeded($("#minivideo2"),e,e.id):(t=!0,y.RTC.attachMediaStreamIfNeeded($("#minivideo"),e,e.id)),y.RTC.attachMediaStreamIfNeeded($("#callVideoPip"),e,e.id)):e.getVideoTracks().length&&(t?y.RTC.attachMediaStreamIfNeeded($("#minivideo2"),e,e.id):(t=!0,y.RTC.attachMediaStreamIfNeeded($("#minivideo"),e,e.id)),y.RTC.attachMediaStreamIfNeeded($("#callSharingPip"),e,e.id))})}$("#callVideoPip")[0]&&($("#callVideoPip")[0].volume=0),$("#minivideo")[0]&&($("#minivideo")[0].volume=0),$("#minivideo2")[0]&&($("#minivideo2")[0].volume=0),$("#callSharingPip")[0]&&($("#callSharingPip")[0].volume=0)}else this.RTC.clearMediaStream($("#minivideo"),null),this.RTC.clearMediaStream($("#minivideo2"),null),this.RTC.clearMediaStream($("#callVideoPip"),null),this.RTC.clearMediaStream($("#callSharingPip"),null)},this.pushInLocalStreams=function(e,t){e.callId=t,y.localStreams.push(e)},this.openErrorPopup=function(e){e||(e="cameraNotAvailable"),S.$broadcast("ON_WEBRTC_CALL_ERROR_EVENT",e)},this.makeVideoCall=function(e){y.makeCall(e,"videoOnly")},this.makeCall=function(e,t,n){C.webrtc("MEDIA   | makeCall to "+JSON.stringify({displayName:e.displayNameForLog(),resources:e.resources})),y.makingCall?C.info("MEDIA   | makeCall already making a call !"):(y.makingCall=!0,this.videoEventHandler.sendProposition(e,t,n))},this.makeJingleCall=function(t,n,r){C.webrtc("MEDIA   | makeJingleCall"),y.setWebrtcConfiguration().then(function(){var e="";t.localMedia&l.Media.AUDIO&&(e="audio"),t.localMedia&l.Media.VIDEO&&(e=e?"audio+video":"video"),n&&""!==n&&C.webrtc("MEDIA   | makeJingleCall in mediaPillar case for number : "+r),n&&""!==n&&r&&""!==r?(e="sip",o.connection.jingle.initiate(n,o.connection.jid,e,y.localStreams,t.id,null,r)):o.connection.jingle.initiate(t.fullJid,o.connection.jid,e,y.localStreams,t.id),t.status=l.Status.CONNECTING,S.$broadcast("ON_CALL_UPDATED_EVENT",t)}).catch(function(e){C.webrtc("MEDIA   | makeCall failure : "+JSON.stringify({error:e.message})),y.makingCall=!1,t&&y.removeCallObject(t),y.resetToSafeState()})},this.makeJingleSharingCall=function(n){C.webrtc("MEDIA   | makeJingleSharingCall - make desktop sharing call");var r="sharing";n.localMedia===l.Media.SHARING&&(r="sharing-only"),y.setWebrtcConfiguration().then(function(){C.webrtc("SHARING | getUserMedia success");var t=y.getMediaPillarSession(),e=t?y.localStreams.filter(function(e){return!(t.localStreams&&t.localStreams.includes(e))}):y.localStreams;o.connection.jingle.initiate(n.fullJid,o.connection.jid,r,e,n.id),n.status=l.Status.CONNECTING,S.$broadcast("ON_CALL_UPDATED_EVENT",n)}).catch(function(e){y.makingCall=!1,n&&y.removeCallObject(n),y.resetToSafeState(),C.webrtc("MEDIA   | makeJingleSharingCall failure : "+JSON.stringify({error:e.message}))})},this.startDesktopSharing=function(e,t){y.makingCall?C.info("MEDIA   | startDesktopSharing already making a call !"):(y.makingCall=!0,!y.askToStartSharing(e.jid,t)&&y.makeDesktopSharingCall(e,t))},this.startSharingCancelled=function(){y.makingCall=!1},this.makeDesktopSharingCall=function(e,t){t||(t="sharing"),C.webrtc("MEDIA   | makeDesktopSharingCall - trying to start a desktop sharing call with media "+t),this.videoEventHandler.sendProposition(e,t)},this.answerJingleCall=function(n){C.webrtc("MEDIA   | answerJingleCall "+n.id);var e=[],r="audio";n.localMedia&l.Media.AUDIO&&e.push("audio"),n.localMedia&l.Media.VIDEO&&(e.push("video"),r="audio+video"),n.localMedia===l.Media.VIDEO&&(r="video");var t={};n.isInConversationWithMobile()&&(t=y.getMobileMediaConstraints("video")),y.setWebrtcConfiguration().then(function(){y.getBrowserMedia(e,t.fixedVideoWidth,t.fixedVideoHeight,t.fixedFrameRate).then(function(e){var t=o.connection.jingle.sessions[n.id];e?(y.pushInLocalStreams(e,n.id),t.addStream(y.localStreams[0]),t.localStreams.push(y.localStreams[0])):r=null,t.localType=r,t.sendAnswer(),t.accept(),S.$broadcast("ON_CALL_UPDATED_EVENT",n)}).catch(function(e){C.webrtc("MEDIA   | answerJingleCall failure for : "+n+" failure : "+e.message),-1!==e.toString().indexOf("getUserMedia")&&(y.releaseCall(n),y.openErrorPopup()),y.resetToSafeState()})})},this.answerCall=function(e,t){this.videoEventHandler.acceptProposition(e,t)},this.rejectCall=function(e,t){e?(y.makingCall=!1,y.autoreleaseTimeout&&a.cancel(y.autoreleaseTimeout),o.connection.jingle.sessions[e.id]?y.releaseCall(e):e.isInitiator?this.videoEventHandler.retractProposition(e):this.videoEventHandler.rejectProposition(e)):C.webrtc("MEDIA   | rejectCall - trying to rejectCall a non existing call !")},this.releaseCall=function(t,n,r){t?(y.makingCall=!1,this.execute("releaseCall",function(){C.webrtc("MEDIA   | releaseCall : "+t);try{var e=o.connection.jingle.sessions[t.id];y.disableAudioVideoMedia(e),c.resetBusyState(),y.autoreleaseTimeout&&a.cancel(y.autoreleaseTimeout),y.createOrUpdateStatisticsForCall(t.id),y.callsStats[t.id]&&delete y.callsStats[t.id],y.callsStatsSimplified[t.id]&&delete y.callsStatsSimplified[t.id],y.removeCallObject(t,n,r),y.displayWebRTCStats(t.id)}catch(e){C.webrtc("MEDIA   | releaseCall ERROR"),C.error(e),y.createOrUpdateStatisticsForCall(t.id),y.callsStats[t.id]&&delete y.callsStats[t.id],y.callsStatsSimplified[t.id]&&delete y.callsStatsSimplified[t.id],y.resetToSafeState(),y.displayWebRTCStats(t.id),y.removeCallObject(t)}})):C.webrtc("MEDIA   | releaseCall - trying to release a non existing call !")},this.askToAddDesktopSharing=function(e){C.webrtc("MEDIA   | askToAddDesktopSharing - Desktop sharing escalation"),!y.askToAddSharing(e.id)&&y.addSharingToCall(e.videoCall)},this.addAudioToCall=function(r,i){C.webrtc("MEDIA   | addAudioToCall");var a=o.connection.jingle.sessions[r.id];a.isRenegotiating=!0;this.getBrowserMedia(["audio"]).then(function(e){y.stopActiveAudioVideoStreams(a),y.pushInLocalStreams(e,r.id);for(var t=0;t<y.localStreams.length;t++)a.removeStream(y.localStreams[t]);var n=i?"contentModify":"contentAdd";y.updateCurrentCall(r,a,"audio",n)}).catch(function(e){C.webrtc("MEDIA   | addAudioToCall failure : "+e),y.releaseCall(r),y.resetToSafeState()})},this.addSharingToCall=function(n){C.webrtc("MEDIA   | addSharingToCall - Desktop sharing escalation");var r=o.connection.jingle.sessions[n.id];r.isRenegotiating=!0;var e={};n.isInConversationWithMobile()&&(e=y.getMobileMediaConstraints("sharing")),this.getBrowserMedia(["sharing"],null,null,e.fixedFrameRate).then(function(e){for(var t=0;t<y.localStreams.length;t++)r.removeStream(y.localStreams[t]),r.localStreams[t]=null;r.localStreams=[],y.pushInLocalStreams(e,n.id);for(t=0;t<y.localStreams.length;t++)r.removeStream(y.localStreams[t]);y.updateCurrentCall(n,r,"sharing","contentAdd")}).catch(function(e){C.webrtc("MEDIA   | addSharingToCall failure : "+e),r.isRenegotiating=!1,-1!==e.toString().indexOf("getUserMedia")&&y.openErrorPopup()})},this.addVideoToCall=function(r,i){C.webrtc("MEDIA   | addVideoToCall");var a=o.connection.jingle.sessions[r.id];a.isRenegotiating=!0;var e={};r.isInConversationWithMobile()&&(e=y.getMobileMediaConstraints("video")),y.getBrowserMedia(["audio","video"],e.fixedVideoWidth,e.fixedVideoHeight,e.fixedFrameRate).then(function(e){y.stopActiveAudioVideoStreams(a),y.pushInLocalStreams(e,r.id);for(var t=0;t<y.localStreams.length;t++)a.removeStream(y.localStreams[t]);var n=i?"contentModify":"contentAdd";y.updateCurrentCall(r,a,"video",n)}).catch(function(e){C.webrtc("MEDIA   | addVideoToCall failure for : "+r+" failure : "+e.message),-1!==e.toString().indexOf("getUserMedia")?(C.info("addVideoToCall impossible, no webcam plugged"),y.openErrorPopup()):(y.releaseCall(r),y.resetToSafeState())})},this.removeSharingFromCall=function(t){C.webrtc("MEDIA   | removeSharingFromCall");var n=o.connection.jingle.sessions[t.id];this.stopAllActiveStreams(n);var e=["audio"];t.localMedia&l.Media.VIDEO&&e.push("video"),n.isRenegotiating=!0,y.getBrowserMedia(e).then(function(e){y.pushInLocalStreams(e,t.id),y.updateCurrentCall(t,n,"sharing","contentRemove")}).catch(function(e){C.webrtc("MEDIA   | removeSharingFromCall failure for : "+t+" failure : "+e.message),-1!==e.toString().indexOf("getUserMedia")&&y.openErrorPopup(),y.releaseCall(t),y.resetToSafeState()})},this.removeVideoFromCall=function(t){C.webrtc("MEDIA   | removeVideoFromCall"),this.reverseAudioCallInitiated=!0;var n=o.connection.jingle.sessions[t.id];this.stopActiveAudioVideoStreams(n),this.localStreams.forEach(function(e){n.removeStream(e)});n.isRenegotiating=!0,y.getBrowserMedia(["audio"]).then(function(e){y.pushInLocalStreams(e,t.id),y.updateCurrentCall(t,n,"video","contentRemove")}).catch(function(e){C.webrtc("MEDIA   | removeVideoFromCall failure for : "+t+" failure : "+e),-1!==e.toString().indexOf("getUserMedia")&&y.openErrorPopup(),y.releaseCall(t),y.resetToSafeState()})},this.calculatePresenceMessage=function(e){var t="audio";return e&&e.localMedia&l.Media.VIDEO&&(t="video"),e&&e.remoteMedia&l.Media.VIDEO&&(t="video"),e&&e.localMedia&l.Media.SHARING&&(t="sharing"),e&&e.remoteMedia&l.Media.SHARING&&(t="sharing"),t},this.calculateAudioState=function(e){var t=0;return e.availableIncomingAudioBandwidth&&(t=e.availableIncomingAudioBandwidth<15&&0<e.availableIncomingAudioBandwidth?1:15<=e.availableIncomingAudioBandwidth&&e.availableIncomingAudioBandwidth<30?2:3),t},this.calculateVideoState=function(e){var t=0;return e.availableIncomingVideoBandwidth&&(t=e.availableIncomingVideoBandwidth<300?1:300<=e.availableIncomingVideoBandwidth&&e.availableIncomingVideoBandwidth<500?2:3),t},this.execute=function(e,t,n){this.started||"releaseCall"===e?t(n):C.webrtc("MEDIA   | "+e+" failure : videoService is not started")},this.getOrCreateCallByCallId=function(e){var t=y.calls[e];if(!t){var n=o.connection.jingle.sessions[e],r=o.getBareJidFromJid(n.peerjid),i=c.getContactByJid(r);t=l.create(l.Status.UNKNOWN,e,l.Type.WEBRTC,i),y.calls[t.id]=t}return t},this.getCallByContact=function(e){for(var t in this.calls)if(this.calls.hasOwnProperty(t)){var n=y.calls[t];if(n.contact&&e.jid===n.contact.jid)return n}return null},this.removeCallObject=function(e,t,n){try{if(e){C.debug("removeCallObject Call id: "+e.id),e.status=l.Status.UNKNOWN;var r=o.connection.jingle.sessions?o.connection.jingle.sessions[e.id]:null;y.disableAudioVideoMedia(r,e.id),delete y.calls[e.id],S.$broadcast("ON_CALL_UPDATED_EVENT",e),r&&o.connection.jingle.terminate(e.id,t,n)}}catch(e){C.error("removeCallObject error "+e)}},this.updateRemoteTypeMedia=function(e,t){switch(e){case"audio":t.remoteMedia=l.Media.AUDIO;break;case"video":t.remoteMedia=l.Media.VIDEO;break;case"audio+video":t.remoteMedia=l.Media.AUDIO|l.Media.VIDEO;break;case"sharing":t.remoteMedia=l.Media.SHARING|l.Media.AUDIO;break;case"sharing-only":t.remoteMedia=l.Media.SHARING;break;default:t.remoteMedia=null}C.debug("REMOTE TYPE || REMOTE MEDIA  "+t.remoteMedia)},this.checkStreamAndStatus=function(e,t){return e&&(0===e.getAudioTracks().length&&0===e.getVideoTracks().length||!1===e.active)?(y.openErrorPopup(),!1):!(t.capabilities&&!t.capabilities.webRTC)||(C.webrtc("MEDIA   | initSharedDesktop failure : remote contact is no more available"),e.stop&&e.stop(),y.openErrorPopup("remoteUserNoMoreAvailable"),!1)},this.displayWebRTCStats=function(e){try{var t=null,n=0;if(i.hasStatsForCall(e)){if(C.webrtc("STATS   | Bundle policy used: "+i.getBundlePolicyForCall(e)),0===(t=i.getStreamsDetailsFromCall(e)).length)C.webrtc("STATS   | No channel information available for call "+e);else for(n=0;n<t.length;n++)C.webrtc("STATS   | "+t[n].id+": "+JSON.stringify(t[n].streams));var r=i.getCodecDetailsFromCall(e);C.webrtc("STATS   | codecs used: "+JSON.stringify(r)),b.trackCodecsUsed(r.codec.audio,r.codec.video)}else if(d.hasStatsForCall(e))if(C.webrtc("STATS   | Bundle policy used: "+d.getBundlePolicyForCall(e)),0===(t=d.getStreamsDetailsFromCall(e)).length)C.webrtc("STATS   | No channel information available for call "+e);else for(n=0;n<t.length;n++)C.webrtc("STATS   | "+t[n].id+": "+JSON.stringify(t[n].streams))}catch(e){C.error("[videoService] displayWebRTCStats error : "+e)}},this.muteAudio=function(e,t){var n=e.videoCall;if(n){C.webrtc("MEDIA   | mute audio: "+n+" | state: "+t),e.isMutedAudio=t,n.isMuted=t;var r=o.connection.jingle.sessions[n.id];r?(r.muteAudio(t),S.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e,call:n})):C.webrtc("MEDIA   | muteAudio - trying to mute a non existing session !")}else C.webrtc("MEDIA   | muteAudio - trying to mute a non existing call !")},this.muteVideo=function(e,t){var n=e.videoCall;if(n){C.webrtc("MEDIA   | muteVideo: "+n);var r=o.connection.jingle.sessions[n.id];r&&(r.muteVideo(t),r.sendMute(t)),S.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e,call:n})}else C.webrtc("MEDIA   | muteVideo - trying to mute a non existing call !")},this.stopAllActiveStreams=function(e){this.stopActiveAudioVideoStreams(e,!0)},this.stopActiveAudioVideoStreams=function(t,n){if(0<y.localStreams.length)if(y.localStreams.forEach(function(e){(e.getAudioTracks().length||n)&&(e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null)}),n)for(;y.localStreams.length;){y.localStreams.pop();null}else for(var e=0;e<y.localStreams.length;e++)if(y.localStreams[e]&&y.localStreams[e].getAudioTracks().length){y.localStreams.splice(e,1);null}if(t&&t.localStreams){if(t.localStreams.forEach(function(e){(e.getAudioTracks().length||n)&&(e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),t.removeStream(e))}),n)for(;t.localStreams.length;){t.localStreams.pop();null}t.localStreams=[]}t&&o.connection.jingle.localStream&&t.removeStream(o.connection.jingle.localStream)},this.resetToSafeState=function(){C.webrtc("MEDIA   | resetToSafeState"),y.autoreleaseTimeout&&a.cancel(y.autoreleaseTimeout),(y.localStream||y.localStreams.length)&&y.disableAudioVideoMedia(),c.resetBusyState()},this.vidRes={1080:[1920,1080],720:[1280,720],360:[640,360],180:[320,180],960:[960,720],640:[640,480],320:[320,240]},this.getMobileMediaConstraints=function(e){var t={};return"sharing"===e?t.fixedFrameRate=3:"video"===e&&(t.fixedFrameRate=20,t.fixedVideoWidth=640,t.fixedVideoHeight=480),t},this.minFirefoxWebRTCVersion=45,this.minChromeWebRTCVersion=42,this.minEdgeWebRTCVersion=25,this.firefoxPreferedSharing="screen",this.getBrowserMedia=function(h,p,v,m){return h&&0!==h.length?new Promise(function(t,n){var e=g.defer(),r={audio:!1,video:!1},i=p||1280,a=v||720,o=[];if(E.allowDevicesManagement()){if(0<=h.indexOf("audio")){var s=g.defer();E.getCurrentMicrophone().then(function(e){r.audio=!e||{optional:[{sourceId:e.id}]},s.resolve(r);var t="default";e&&(t="id - "+e.id+" and label "+e.label),C.info("[VideoService] GetUserMedia for microphone "+t)}),o.push(s.promise)}if(0<=h.indexOf("video")){var c=m||30,l=g.defer();E.getCurrentCamera().then(function(e){e&&"default"!==e.id?r.video={width:i,height:a,frameRate:c,deviceId:{exact:e.id}}:r.video={width:i,height:a,frameRate:c},l.resolve(r);var t="default";e&&(t="id - "+e.id+" and label "+e.label),C.info("[VideoService] GetUserMedia for camera "+t)}),o.push(l.promise)}}else 0<=h.indexOf("audio")&&(r.audio=!0),0<=h.indexOf("video")&&(r.video={width:i,height:a});if(0<=h.indexOf("sharing")){c=m||5;if(R.extensionFound)r.video={mandatory:{chromeMediaSource:"desktop",maxWidth:1920,maxHeight:1080,maxFrameRate:c}},o.push(R.getStreamToShareFromExtension(r));else if("firefox"===adapter.browserDetails.browser)r.video={mediaSource:y.firefoxPreferedSharing};else{var d=y.getDesktopSharingSource(),u=d&&d.chromeMediaSource?d.chromeMediaSource:"desktop",f=d&&d.chromeMediaSourceId?d.chromeMediaSourceId:null;r.video={mandatory:{chromeMediaSource:u,maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,maxFrameRate:c}},f&&(r.video.mandatory.chromeMediaSourceId=f)}}g.all(o).then(function(){e.resolve(r)}).catch(function(){e.resolve()}),e.promise.then(function(e){if(C.info("[VideoService] GetUserMedia with constraint "+JSON.stringify(e)),e)try{navigator.mediaDevices.getUserMedia(e).then(function(e){C.webrtc("MEDIA   | getUserMedia success"),e.getAudioTracks().length&&C.info("[videoService] getUserMedia audio stream kind "+e.getAudioTracks()[0].kind+", id "+e.getAudioTracks()[0].id+", label "+e.getAudioTracks()[0].label+", readyState "+e.getAudioTracks()[0].readyState+", enabled "+e.getAudioTracks()[0].enabled),e.getVideoTracks().length&&C.info("[videoService] getUserMedia video stream kind "+e.getVideoTracks()[0].kind+", id "+e.getVideoTracks()[0].id+", label "+e.getVideoTracks()[0].label+", readyState "+e.getVideoTracks()[0].readyState+", enabled "+e.getVideoTracks()[0].enabled),e&&(0===e.getAudioTracks().length&&0===e.getVideoTracks().length||!1===e.active)&&(C.webrtc("Stream has no active audio or video tracks"),b.trackGetUserMediaErrorNoTrack(),n(new Error("getUserMedia failure : Stream has no active audio or video tracks"))),R.extensionFound&&0<=h.indexOf("sharing")&&(e.getVideoTracks()[0].onended=function(){C.info("Stop screensharing in chrome has been triggered"),S.$broadcast("ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED")}),e&&e.getAudioTracks().length&&(e.getAudioTracks()[0].onended=function(e){C.error("audio stream track ended"),console.log(this),console.log(e)}),t(e),b.trackGetUserMediaSuccess()}).catch(function(e){C.webrtc("MEDIA   | getUserMedia failure: "+e),b.trackGetUserMediaError(),S.$broadcast("ON_WEBRTC_GETUSERMEDIA_ERROR",e),n(new Error("getUserMedia failure "+e))})}catch(e){C.webrtc("MEDIA   | getUserMedia failure: "+e),b.trackGetUserMediaError(),n(new Error("getUserMedia failure "+e))}else n({message:"getUserMedia cancelled"})})}):g.when()},this.getBrowserMethodHandler=function(){var e="",t=null;if(navigator.mozGetUserMedia&&n.mozRTCPeerConnection){if(e=r.extractBrowserVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),C.webrtc("BROWSER | Detect Firefox navigator (version "+e+")"),e<this.minFirefoxWebRTCVersion)return C.webrtc("BROWSER | Firefox navigator is not WebRTC capable before version "+this.minFirefoxWebRTCVersion),t;t={browser:"firefox",attachMediaStream:function(e,t){e&&e[0]&&(e[0].mozSrcObject=t,e[0].srcObject=t,e[0].play())},pc_constraints:{},clearMediaStream:function(e){try{angular.isDefined(e[0])&&(e[0].pause(),e[0].mozSrcObject=null,e[0].srcObject=null,e[0].uniqueId=null)}catch(e){C.webrtc("BROWSER | clearMediaStream failure "+e)}},attachMediaStreamIfNeeded:function(e,t,n){C.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+n),e&&e[0]&&(e[0].uniqueId!==n||!e[0].mozSrcObject&&!e[0].srcObject)&&(e[0].uniqueId=n,y.RTC.attachMediaStream(e,t))}}}else if(navigator.webkitGetUserMedia&&n.webkitRTCPeerConnection){if(e=r.extractBrowserVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),C.webrtc("BROWSER | Detect Chrome navigator (version "+e+")"),e<this.minChromeWebRTCVersion)return C.webrtc("BROWSER | Chrome navigator is not WebRTC capable before version "+this.minChromeWebRTCVersion),t;t={browser:"chrome",attachMediaStream:function(e,t){C.webrtc("BROWSER | attachMediaStream to element"),e&&e[0]&&(e[0].srcObject=t),a(function(){e&&e[0]&&e[0].load&&e[0].load()},1e3,1)},pc_constraints:{},clearMediaStream:function(e){angular.isDefined(e[0])&&(e[0].pause(),e[0].srcObject=null,e[0].uniqueId=null)},attachMediaStreamIfNeeded:function(e,t,n){C.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+n),!e||!e[0]||e[0].uniqueId===n&&e[0].srcObject||(e[0].uniqueId=n,y.RTC.attachMediaStream(e,t))}}}return t},this.getIceConfig=function(){var r=g.defer();return this.portalURL=config.restServerUrl+"/api/rainbow/geolocation/v1.0/",s({method:"GET",url:y.portalURL+"settings/iceservers?nbServers=2",headers:f.getRequestHeader()}).success(function(e){C.info("[videoService] getIceConfig success");var t=e.data;t.forEach(function(e){delete e.id},this);var n={iceServers:t};r.resolve(n)}).error(function(e,t){C.error("[videoService] getIceConfig failure "+JSON.stringify(e)+" with status "+t),r.reject()}),r.promise},this.calculateNewCallType=function(e,t,n,r){var i=t.localType;return"contentAdd"===r&&("video"===n?(i=e.localMedia&l.Media.SHARING?"sharing+video":"video",e.localMedia=e.localMedia|l.Media.VIDEO):"sharing"===n?(i=e.localMedia&l.Media.VIDEO?"sharing+video":"sharing",e.localMedia=e.localMedia|l.Media.SHARING):"audio"===n&&(e.localMedia&l.Media.SHARING?(i="sharing",e.localMedia=e.localMedia|l.Media.AUDIO):(i="audio",e.localMedia=l.Media.AUDIO))),"contentRemove"===r&&("video"===n?e.localMedia&l.Media.SHARING?(i="sharing",e.localMedia=l.Media.AUDIO|l.Media.SHARING):(i="audio",e.localMedia=l.Media.AUDIO):"sharing"===n&&(e.localMedia&l.Media.VIDEO?(i="video",e.localMedia=l.Media.AUDIO|l.Media.VIDEO):(i="audio",e.localMedia=l.Media.AUDIO))),"contentModify"===r&&e.localMedia&l.Media.VIDEO&&!(e.localMedia&l.Media.SHARING)&&(i="video"),C.info("[videoService] calculateNewCallType for type "+n+" and action "+r+" with result "+i),i},this.updateCurrentCall=function(e,t,n,r){C.info("[videoService] updateCurrentCall for type "+n+" and action "+r);for(var i=this.calculateNewCallType(e,t,n,r),a=0;a<y.localStreams.length;a++)"chrome"===adapter.browserDetails.browser?t.addStream(y.localStreams[a]):t.replaceStream(y.localStreams[a]),t.localStreams.push(y.localStreams[a]);switch(r){case"contentAdd":t.contentAdd(i);break;case"contentRemove":t.contentRemove(i);break;case"contentModify":t.contentModify(i)}c.setBusyState("dnd",y.calculatePresenceMessage(e)),S.$broadcast("ON_CALL_UPDATED_EVENT",e),S.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},this.createOrUpdateStatisticsForCall=function(t){var e=this.calls[t];if(e){var n=[];if(this.callsStats[t])return n.push({connectionId:t,stats:this.callsStats[t]}),void this.updateStatisticsForCall(this.callsStats[t].id,t,e.contact.dbId,"ended",n);C.info("[videoService] createOrUpdateStatisticsForCall "+t),this.callsStats[t]={},n.push({connectionId:t,stats:this.callsStats[t]}),this.createStatisticsForSession(t,e.contact.dbId,"pending",n).then(function(e){y.callsStats[t].id=e,C.info("[videoService] createOrUpdateStatisticsForCall success for session "+t+" with id "+e)})}else C.warn("[videoService] createOrUpdateStatisticsForCall -- missing call "+t)},this.createStatisticsForSession=function(r,i,a,o){return g(function(t,n){C.info("[videoService] createStatisticsForSession "+r);var e=config.restServerUrl+"/api/rainbow/metrics/v1.0/";s({method:"POST",url:e+"webrtcmetrics",headers:f.getRequestHeader(),data:{callId:r,peerId:i,callState:a,metrics:o}}).then(function(e){C.info("[videoService] createStatisticsForSession success"),e&&e.data&&e.data.data&&e.data.data.id&&y.callsStats[r]&&t(e.data.data.id)},function(e){C.error("[videoService] createStatisticsForSession failure "+e.errorMsg),n(new Error(e.errorMsg))})})},this.updateStatisticsForCall=function(e,t,n,r,i){if(C.info("[videoService] updateStatisticsForCall "+t),e){var a=config.restServerUrl+"/api/rainbow/metrics/v1.0/";s({method:"POST",url:a+"webrtcmetrics/"+e+"/metrics",headers:f.getRequestHeader(),data:{metrics:i}}).then(function(){C.info("[videoService] updateStatisticsForCall success")},function(e){C.error("[videoService] updateStatisticsForCall failure "+e.errorMsg)})}else C.warn("[videoService] updateStatisticsForCall -- missing id for callId "+t)},angular.element(document).bind("transportreplace.jingle",function(e,t){C.webrtc("JINGLE  | transportreplace.jingle "+t);var n=o.connection.jingle.sessions[t];n?n.sendAnswer(void 0,"transport-accept"):C.warn("JINGLE  | transportreplace.jingle no such session !")}),angular.element(document).bind("callactive.jingle",function(e,t){C.webrtc("JINGLE  | callactive "+t)}),angular.element(document).bind("remotestreamadded.jingle",function(e,t,n){C.webrtc("JINGLE  | remoteStreamadded "+t);var r=o.connection.jingle.sessions[t];if(r&&r.remoteStreams&&!r.confId){var i=y.calls[t];i&&y.attachDistantMediaStreams(!0,i),S.$broadcast("ON_WEBRTC_REMOTE_STREAM_ADDED",r.remoteStreams)}n&&y.resetAudioOutputElement()}),angular.element(document).bind("remotestreamremoved.jingle",function(e,t){C.webrtc("JINGLE  | remotestreamremoved "+t)}),angular.element(document).bind("callaccepted.jingle",function(e,t){C.webrtc("JINGLE  | callaccepted "+t);var n=y.calls[t],r=o.connection.jingle.sessions[t];n&&r&&(y.statsInterval&&(C.webrtc("JINGLE  | remove getStats interval"),a.cancel(y.statsInterval),y.statsinterval=null),y.createOrUpdateStatisticsForCall(n.id),C.webrtc("JINGLE  | start getStats interval"),y.statsInterval=r.getStats(5e3)),n&&n.status.key!==l.Status.ACTIVE.key&&(C.webrtc("INFO    | call has been accepted. Set current call to ACTIVE state"),angular.element(document).trigger("callactive.jingle",[t]))}),angular.element(document).bind("nostuncandidates.jingle",function(e,t){C.webrtc("JINGLE  | nostuncandidates "+t),b.trackICENoSTUNCandidate()}),angular.element(document).bind("ringing.jingle",function(e,t){C.webrtc("JINGLE  | callremoteringing "+t)}),angular.element(document).bind("mediafailure.jingle",function(){C.webrtc("JINGLE  | callmediafailure")}),angular.element(document).bind("mute.jingle",function(e,t){C.webrtc("JINGLE  | mute "+t);var n=y.calls[t];n.isRemoteVideoMuted=!0,S.$broadcast("ON_CALL_UPDATED_EVENT",n)}),angular.element(document).bind("unmute.jingle",function(e,t){C.webrtc("JINGLE  | unmute "+t);var n=y.calls[t];n.isRemoteVideoMuted=!1,S.$broadcast("ON_CALL_UPDATED_EVENT",n)}),angular.element(document).bind("hold.jingle",function(e,t){C.webrtc("JINGLE  | hold "+t);var n=o.connection.jingle.sessions[t];n?(n.muteAudio(!0),S.$broadcast("ON_HOLD_TONE_EVENT","hold")):C.webrtc("MEDIA   | hold - received on a non existing session !")}),angular.element(document).bind("unhold.jingle",function(e,t){C.webrtc("JINGLE  | unhold "+t);var n=o.connection.jingle.sessions[t];n?(n.muteAudio(!1),S.$broadcast("ON_HOLD_TONE_EVENT","unhold")):C.webrtc("MEDIA   | unhold - received on a non existing session !")}),angular.element(document).bind("remoteIceFailed.jingle",function(e){C.webrtc("JINGLE  | remoteIceFailed "+e),y.openErrorPopup("IceConnectionFailed")}),angular.element(document).bind("mediamodified.jingle",function(e,t,n){C.webrtc("JINGLE  | mediamodified "+t),y.videoEventHandler.mediaModified(t,n)}),angular.element(document).bind("statsChrome.jingle",function(e,t,n){for(var r=0;r<n.length;++r)switch(n[r].type){case"googComponent":i.addStreamToCall(t,n[r]);break;case"ssrc":i.addSSRCToStream(t,n[r])}}),angular.element(document).bind("statsFirefox.jingle",function(e,t,n){for(var r=0;r<n.length;++r)switch(n[r].type){case"inboundrtp":case"outboundrtp":d.addStreamToCall(t,n[r]);break;case"candidatepair":d.addCandidatePairToCall(t,n[r])}}),angular.element(document).bind("webrtcFirefoxStats.jingle",function(e,t,n){y.callsStats.sid||(y.callsStats.sid={}),y.callsStats[t]||(y.callsStats[t]={});var r=y.calls[t];if(r){var i=y.calculateAudioState(n),a=0;r.remoteMedia&l.Media.VIDEO&&(a=y.calculateVideoState(n));var o=y.callsStats[t];o&&(n.videoReceived?o.video=n:o.audio=n,y.callsStats[t]=o),S.$broadcast("ON_WEBRTC_CALL_STATS",i,a)}}),angular.element(document).bind("webrtcConnectionType.jingle",function(e,t,n){var r=y.calls[t];n&&(C.webrtc("STATS   | Local candidate ("+n.local.ipAddress+") type is "+n.local.candidateType),C.webrtc("STATS   | Remote candidate  ("+n.remote.ipAddress+") type is "+n.remote.candidateType),r&&r.isInitiator&&b.trackICEUsed(n.local.candidateType,n.remote.candidateType),n.local.networkType&&(C.webrtc("STATS   | Network type is "+n.local.networkType),r&&r.isInitiator&&b.trackICETopology(n.local.networkType)))}),angular.element(document).bind("webrtcSessionStats.jingle",function(e,t,n){y.callsStats.sid||(y.callsStats.sid={}),y.callsStats[t]||(y.callsStats[t]={});var r=y.callsStats[t].id;y.callsStats[t]=n,y.callsStats[t].id=r}),this.escalateToSharingCall=function(t,n){C.webrtc("MEDIA   | escalateToSharingCall - Desktop sharing escalation");var r=o.connection.jingle.sessions[t.id];r.isRenegotiating=!0;this.getBrowserMedia(["sharing"]).then(function(e){r.removeStream(y.localStreams[0]),r.localStreams[0]=null,r.localStreams=[],y.pushInLocalStreams(e,t.id),y.updateCurrentSharingCall(t,r,n)}).catch(function(e){C.webrtc("MEDIA   | escalateToSharingCall failure : "+e),r.isRenegotiating=!1,-1!==e.toString().indexOf("getUserMedia")&&y.openErrorPopup()})},this.escalateToVideoCall=function(n,r){C.webrtc("MEDIA   | Escalate to video call");var i=o.connection.jingle.sessions[n.id];i.isRenegotiating=!0,y.getBrowserMedia(["audio","video"]).then(function(e){y.stopActiveAudioVideoStreams(i),y.pushInLocalStreams(e,n.id);for(var t=0;t<y.localStreams.length;t++)i.localStreams.push(y.localStreams[t]);y.updateCurrentAudioOrVideoCall(n,i,"video",r)}).catch(function(e){C.webrtc("MEDIA   | escalateToVideoCall failure for : "+n+" failure : "+e.message),-1!==e.toString().indexOf("getUserMedia")?(C.info("Escalation to video impossible, no webcam plugged"),y.openErrorPopup()):(y.releaseCall(n),y.resetToSafeState())})},this.addAudioToSharingCall=function(t){C.webrtc("MEDIA   | addAudioToSharingCall");var n=o.connection.jingle.sessions[t.id];n.isRenegotiating=!0,y.localStreams.length&&n.removeStream(y.localStreams[0]),n.localStreams[0]=null,n.localStreams=[];this.getBrowserMedia(["audio"]).then(function(e){y.pushInLocalStreams(e,t.id),y.updateCurrentSharingCall(t,n)}).catch(function(e){C.webrtc("MEDIA   | addAudioToSharingCall failure : "+e),y.releaseCall(t),y.resetToSafeState()})},this.reverseToAudioCall=function(n,r){C.webrtc("MEDIA   | reverseToAudioCall"),this.reverseAudioCallInitiated=!0;var i=o.connection.jingle.sessions[n.id];this.stopActiveAudioVideoStreams(i);i.isRenegotiating=!0,y.getBrowserMedia(["audio"]).then(function(e){y.pushInLocalStreams(e,n.id);for(var t=0;t<y.localStreams.length;t++)i.localStreams.push(y.localStreams[t]);y.updateCurrentAudioOrVideoCall(n,i,"audio",r)}).catch(function(e){C.webrtc("MEDIA   | reverseToAudioCall failure for : "+n+" failure : "+e.message),-1!==e.toString().indexOf("getUserMedia")&&y.openErrorPopup(),y.releaseCall(n),y.resetToSafeState()})},y.updateCurrentSharingCall=function(e,t,n){if(C.webrtc("MEDIA   | updateCurrentSharingCall | Add new streams to the current session"),!t||!o.connection.jingle.sessions[e.id])return y.disableAudioVideoMedia(),y.resetToSafeState(),void y.removeCallObject(e);var r="audio";"chrome"===adapter.browserDetails.browser?(t.localStreams.push(y.localStreams[0]),t.addStream(y.localStreams[0]),y.localStreams[1]&&(r=e.localMedia===l.Media.AUDIO||e.localMedia===l.Media.SHARING?"sharing":"sharing+video",e.localMedia=e.localMedia|l.Media.SHARING|l.Media.AUDIO,t.localStreams.push(y.localStreams[1]),t.addStream(y.localStreams[1]),t.localStreams.push(y.localStreams[1]),t.addStream(y.localStreams[1]))):(e.localMedia=l.Media.AUDIO,t.replaceStream(y.localStreams[0])),n?t.contentModify(r):t.contentAdd(r),c.setBusyState("dnd",y.calculatePresenceMessage(e)),S.$broadcast("ON_CALL_UPDATED_EVENT",e),S.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},this.updateCurrentAudioOrVideoCall=function(e,t,n,r){C.webrtc("MEDIA   | updateCurrentAudioOrVideoCall | Add new stream to the current session");for(var i=0;i<y.localStreams.length;i++)"chrome"===adapter.browserDetails.browser?t.addStream(y.localStreams[i]):t.replaceStream(y.localStreams[i]);r?t.contentModify(t.localType):"audio"===n?e.localMedia&l.Media.SHARING?(t.contentRemove("sharing"),t.localType="sharing",e.localMedia=l.Media.AUDIO|l.Media.SHARING):(t.contentRemove("audio"),t.localType="audio",e.localMedia=l.Media.AUDIO):"video"===n&&(e.localMedia&l.Media.SHARING?(t.contentAdd("sharing+video"),t.localType="sharing+video"):(t.contentAdd("video"),t.localType="audio+video"),e.localMedia=e.localMedia|l.Media.VIDEO),c.setBusyState("dnd",y.calculatePresenceMessage(e)),S.$broadcast("ON_CALL_UPDATED_EVENT",e),S.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},this.attachLocalMediaStream=function(e){e?(this.localStreams&&this.localStreams.length&&this.localStreams[0].getVideoTracks().length&&this.RTC.attachMediaStream($("#minivideo"),this.localStreams[0]),$("#minivideo")[0]&&($("#minivideo")[0].volume=0)):this.RTC.clearMediaStream($("#minivideo"),null)},this.attachDistantMediaStream=function(e,t){if(e){var n=o.connection.jingle.sessions[t.id];n.remoteStreams?n.remoteStreams.forEach(function(e){0<e.getVideoTracks().length&&(C.webrtc("attachDistantMediaStream video track"),y.RTC.attachMediaStream(angular.element("#largevideo"),e),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),0<e.getAudioTracks().length&&(C.webrtc("attachDistantMediaStream audio track"),y.RTC.attachMediaStream(angular.element("#globalAudioTag"),e))}):n.remoteStream&&(0<n.remoteStream.getVideoTracks().length&&(C.error("attachDistantMediaStream NOT GOOD !!! video track"),y.RTC.attachMediaStream(angular.element("#largevideo"),n.remoteStream),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),0<n.remoteStream.getAudioTracks().length&&(C.error("attachDistantMediaStream NOT GOOD !!! audio track"),y.RTC.attachMediaStream(angular.element("#globalAudioTag"),n.remoteStream)))}else y.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.attachMediaStream(angular.element("#globalAudioTag"),null))},this.sendDTMF=function(e,t){var n=o.connection.jingle.sessions[t.id];if(n&&n.peerconnection){var r=n.peerconnection.getSenders().find(function(e){return e.dtmf&&e.track&&e.track.enabled&&"audio"===e.track.kind}),i=r?r.dtmf:null;i?(C.debug("sendDTMF: dtmf sender found on webrtc session for call id "+t.id+" dialstring: "+e),i.ontonechange=this.handleToneChangeEvent,i.insertDTMF(e)):C.error("sendDTMF: no dtmf sender found on webrtc session for call id "+t.id)}else C.error("sendDTMF: no webrtc session found for call id "+t.id)},this.handleToneChangeEvent=function(e){""!==e.tone&&(C.debug("Tone played: "+e.tone),S.$broadcast("ON_DTMF_SENT",e.tone))}}]),angular.module("rainbow").factory("VideoServiceEventHandler",["$log","$rootScope","$interval","contactService","xmppService","Call","gaService","uuid4",function(u,f,h,p,v,m,o,t){"use strict";function n(e){this.videoService=e,this.nameSpace="urn:xmpp:jingle-message:0"}return n.create=function(e){return new n(e)},n.prototype.setRemoteTypeMedia=function(e,t){for(var n=t.remoteMedia=0;n<e.length;n++)switch(e[n]){case"audio":t.remoteMedia=t.remoteMedia|m.Media.AUDIO;break;case"video":t.remoteMedia=t.remoteMedia|m.Media.VIDEO;break;case"sharing":t.remoteMedia=t.remoteMedia|m.Media.SHARING;break;default:t.remoteMedia=null}u.debug("REMOTE TYPE || REMOTE MEDIA  "+t.remoteMedia)},n.prototype.setLocalTypeMedia=function(e,t){for(var n=t.localMedia=0;n<e.length;n++)switch(e[n]){case"audio":t.localMedia=t.localMedia|m.Media.AUDIO;break;case"video":t.localMedia=t.localMedia|m.Media.VIDEO;break;case"sharing":t.localMedia=t.localMedia|m.Media.SHARING;break;default:t.localMedia=null}u.debug("LOCAL TYPE || LOCAL MEDIA  "+t.localMedia)},n.prototype.sendProposition=function(r,e,i){u.info("[VideoServiceEventHandler]   | sendProposition to "+JSON.stringify({displayName:r.displayNameForLog(),resources:r.resources}));var a=this,o=["audio"],s=[];"video"===e?o.push("video"):"videoOnly"===e?o=["video"]:"sharing"===e?(o=["sharing"],s=["audio"]):"sharingOnly"===e&&(o=["sharing"]);var c="web_"+t.generate(),l=m.create(m.Status.DIALING,c,m.Type.WEBRTC,r);this.videoService.getBrowserMedia(o).then(function(n){a.videoService.getBrowserMedia(s).then(function(e){if(a.videoService.makingCall&&a.videoService.started){l.isInitiator=!0,n.callId=c,a.videoService.localStreams.push(n),e&&(e.callId=c,a.videoService.localStreams.push(e),o.push(s.pop())),a.videoService.calls[l.id]=l,a.setLocalTypeMedia(o,l);var t=$msg({from:p.userContact.fullJid,to:r.jid});t.c("propose",{xmlns:a.nameSpace,id:c}),i&&t.c("subject",{xmlns:"urn:xmpp:jingle-subject:0"}).t(i).up(),t.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:o[0]}).up(),o[1]&&(t=t.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:o[1]}).up()),v.send(t),a.videoService.makingCall=!1,p.setBusyState("dnd",a.videoService.calculatePresenceMessage(l)),f.$broadcast("ON_CALL_UPDATED_EVENT",l),a.videoService.autoreleaseTimeout&&h.cancel(a.videoService.autoreleaseTimeout),a.videoService.autoreleaseTimeout=h(function(e){u.webrtc("MEDIA   | send proposition : no response after 30 seconds : release the call"),l&&a.videoService.rejectCall(e)},3e4,1,!0,l)}else u.warn("[VideoServiceEventHandler]   | sendProposition -- call should no longer be made !"),a.videoService.makingCall=!1,n.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),n.stop&&n.stop(),n=null,e&&(e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null)}).catch(function(e){u.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:e.message})),a.videoService.makingCall=!1,-1!==e.toString().indexOf("getUserMedia")&&a.videoService.openErrorPopup(),a.videoService.removeCallObject(l),a.videoService.resetToSafeState(),a.videoService.autoreleaseTimeout&&h.cancel(a.videoService.autoreleaseTimeout)})}).catch(function(e){u.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:e.message})),a.videoService.makingCall=!1,0<=o.indexOf("sharing")||-1===e.toString().indexOf("getUserMedia")||a.videoService.openErrorPopup(),a.videoService.removeCallObject(l),a.videoService.resetToSafeState()})},n.prototype.retractProposition=function(e){u.info("[VideoServiceEventHandler]   | retractProposition for call "+e.id);var t=$msg({from:p.userContact.fullJid,to:e.contact.jid}).c("retract",{xmlns:this.nameSpace,id:e.id});v.send(t),p.resetBusyState(),this.videoService.removeCallObject(e)},n.prototype.acceptProposition=function(t,e){u.info("[VideoServiceEventHandler]   | acceptProposition for call "+t.id);var n=$msg({from:p.userContact.fullJid,to:p.userContact.jid}).c("accept",{xmlns:this.nameSpace,id:t.id});v.send(n),n=$msg({from:p.userContact.fullJid,to:t.fullJid}).c("proceed",{xmlns:this.nameSpace,id:t.id}),v.send(n);var r=["audio"];e&&"video"===e&&r.push("video"),t.remoteMedia===m.Media.VIDEO&&(r=["video"]),t.remoteMedia===m.Media.SHARING&&(r=[]),this.setLocalTypeMedia(r,t),p.setBusyState("dnd",this.videoService.calculatePresenceMessage(t)),t.status=m.Status.ANSWERING,f.$broadcast("ON_CALL_UPDATED_EVENT",t);var i=this;i.videoService.autoreleaseTimeout&&h.cancel(i.videoService.autoreleaseTimeout),i.videoService.autoreleaseTimeout=h(function(e){e&&(null!==t.getMediaPillarCall()?u.warn("[webrtcgateway/VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call :"+e.id):u.webrtc("[VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call "+e.id),i.videoService.removeCallObject(e),p.resetBusyState())},45e3,1,!0,t)},n.prototype.rejectProposition=function(e){u.info("[VideoServiceEventHandler]   | rejectProposition for call "+e.id);var t=$msg({from:p.userContact.fullJid,to:p.userContact.jid}).c("reject",{xmlns:this.nameSpace,id:e.id});v.send(t);var n=e.getMediaPillarCall(),r=n&&n.mediaPillarJid?n.mediaPillarJid:e.contact.jid;t=$msg({from:p.userContact.fullJid,to:r}).c("reject",{xmlns:this.nameSpace,id:e.id}),v.send(t),e&&(e.status=m.Status.UNKNOWN,delete this.videoService.calls[e.id],p.resetBusyState(),f.$broadcast("ON_CALL_UPDATED_EVENT",e)),this.videoService.setWebrtcConfiguration(),this.videoService.autoreleaseTimeout&&h.cancel(this.videoService.autoreleaseTimeout)},n.prototype.onMessageReceived=function(t){var n=this;try{f.$apply(function(){u.info("[VideoServiceEventHandler]   | onMessageReceived"),console.log(t);var e=$(t);0<e.find("error").length||0<e.find("delay").length||0<$(t).find("service-unavailable").length?n.onMessageReceivedError():0<e.find("propose").length?n.onPropositionReceived(t):0<e.find("retract").length?n.onRetractReceived(t):0<e.find("reject").length?n.onRejectReceived(t):0<e.find("accept").length?n.onAcceptReceived(t):0<e.find("proceed").length&&n.onProceedReceived(t)})}catch(e){return u.error("[VideoServiceEventHandler]   | onMessageReceived error "+e),!0}return!0},n.prototype.onMessageReceivedError=function(e){u.info("[VideoServiceEventHandler]   | onMessageReceivedError");var t=$(e).find("propose").attr("id"),n=this.videoService.calls[t];n&&u.error("[VideoServiceEventHandler]   | onMessageReceivedError call is in "+n.status.value+" state")},n.prototype.onPropositionReceived=function(a){u.info("[VideoServiceEventHandler]   | onPropositionReceived");var o=$(a).find("propose").attr("id"),s=this.videoService.calls[o],c=this;if(s){if(0<$(a).find("subject").length){var e=$(a).find("subject")[0];u.debug("[VideoServiceEventHandler]   | onPropositionReceived subject Detected: "+e.textContent),s.setSubject(e.textContent)}s.setStatus(m.Status.RINGING_INCOMMING),this.setRemoteTypeMedia(d,s),f.$broadcast("ON_CALL_UPDATED_EVENT",s),c.videoService.autoreleaseTimeout&&h.cancel(c.videoService.autoreleaseTimeout),c.videoService.autoreleaseTimeout=h(function(e){e&&(u.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+e.id),c.videoService.removeCallObject(e))},12e4,1,!0,s)}else{var l=$(a).attr("from"),d=[],t=v.getBareJidFromJid(l);p.getOrCreateContact(t).then(function(e){for(var t=$(a).find("description").length,n=0;n<t;n++){var r=$(a).find("description")[n];d.push($(r).attr("media"))}if((s=m.create(m.Status.UNKNOWN,o,m.Type.WEBRTC,e)).fullJid=l,c.videoService.calls[s.id]=s,0<$(a).find("subject").length){var i=$(a).find("subject")[0];u.debug("[VideoServiceEventHandler]   | onPropositionReceived subject Detected: "+i.textContent),s.setSubject(i.textContent)}s.setStatus(m.Status.RINGING_INCOMMING),c.setRemoteTypeMedia(d,s),f.$broadcast("ON_CALL_UPDATED_EVENT",s),c.videoService.autoreleaseTimeout&&h.cancel(c.videoService.autoreleaseTimeout),c.videoService.autoreleaseTimeout=h(function(e){e&&(u.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+e.id),c.videoService.removeCallObject(e))},12e4,1,!0,s)}).catch(function(e){u.error("[VideoServiceEventHandler]   | onPropositionReceived error "+e),c.videoService.removeCallObject(s)})}},n.prototype.onRetractReceived=function(e){u.info("[VideoServiceEventHandler]   | onRetractReceveid");var t=$(e).find("retract").attr("id"),n=this.videoService.calls[t];n&&(n.status===m.Status.ANSWERING&&p.resetBusyState(),this.videoService.removeCallObject(n)),this.videoService.autoreleaseTimeout&&h.cancel(this.videoService.autoreleaseTimeout)},n.prototype.onRejectReceived=function(e){u.info("[VideoServiceEventHandler]   | onRejectReceived");var t=$(e).find("reject").attr("id"),n=this.videoService.calls[t],r=$(e).attr("from");this.videoService.autoreleaseTimeout&&h.cancel(this.videoService.autoreleaseTimeout),n&&(n.status===m.Status.RINGING_INCOMMING&&(null!==n.getMediaPillarCall()&&f.$broadcast("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",n),this.videoService.removeCallObject(n)),n.status===m.Status.DIALING&&(p.resetBusyState(),this.videoService.removeCallObject(n)),n.status!==m.Status.ACTIVE&&n.status!==m.Status.CONNECTING||n.fullJid&&n.fullJid===r&&(p.resetBusyState(),this.videoService.removeCallObject(n)))},n.prototype.onAcceptReceived=function(e){u.info("[VideoServiceEventHandler]   | onAcceptReceived");var t=$(e).find("accept").attr("id"),n=this.videoService.calls[t],r=$(e).attr("from");n&&r!==p.userContact.fullJid&&(null!==n.getMediaPillarCall()&&f.$broadcast("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",n),this.videoService.removeCallObject(n)),r!==p.userContact.fullJid&&this.videoService.autoreleaseTimeout&&h.cancel(this.videoService.autoreleaseTimeout)},n.prototype.onProceedReceived=function(e){u.info("[VideoServiceEventHandler]   | onProceedReceived"),this.videoService.autoreleaseTimeout&&h.cancel(this.videoService.autoreleaseTimeout);var t=$(e).find("proceed").attr("id"),n=this.videoService.calls[t],r=$(e).attr("from");if(n.fullJid=r,n.isInConversationWithMobile()&&n.localMedia&m.Media.VIDEO){var i=this,a=[],o=i.videoService.getMobileMediaConstraints("video");a=["audio","video"],n.localMedia&m.Media.AUDIO||(a=["video"]),i.videoService.getBrowserMedia(a,o.fixedVideoWidth,o.fixedVideoHeight,o.fixedFrameRate).then(function(e){u.info("[VideoServiceEventHandler]   | onProceedReceived --\x3e renegociate video quality"),n.localMedia&m.Media.VIDEO&&i.videoService.stopActiveAudioVideoStreams(),i.videoService.localStreams.push(e),i.videoService.makeJingleCall(n)}).catch(function(e){u.info("[VideoServiceEventHandler]   | onProceedReceived "+n+" failure : "+e.message),-1!==e.toString().indexOf("getUserMedia")?(u.info("onProceedReceived impossible, no webcam plugged"),i.videoService.openErrorPopup()):(i.videoService.releaseCall(n),i.videoService.resetToSafeState())})}else n.localMedia&m.Media.SHARING?this.videoService.makeJingleSharingCall(n):this.videoService.makeJingleCall(n)},n.prototype.incomingCall=function(e){u.info("[VideoServiceEventHandler] incomingCall "+e);var t=this,n=null,r=v.connection.jingle.sessions[e];if(r&&r.peerjid){var i=v.getBareJidFromJid(r.peerjid),a=p.getContactByJid(i);n=this.videoService.getCallByJid(a.jid)}n?(r.sendRinging(),h(function(e){t.videoService.answerJingleCall(e)},350,1,!0,n),f.$broadcast("ON_CALL_UPDATED_EVENT",n),this.videoService.autoreleaseTimeout&&h.cancel(this.videoService.autoreleaseTimeout),this.videoService.statsInterval&&(u.info("[VideoServiceEventHandler] remove getStats interval"),h.cancel(this.videoService.statsInterval),this.videoService.statsinterval=null),t.videoService.createOrUpdateStatisticsForCall(n.id),u.info("[VideoServiceEventHandler] start getStats interval"),this.videoService.statsInterval=r.getStats(5e3)):(u.warn("[VideoServiceEventHandler] incomingCall no such call ! Terminate the session "),p.resetBusyState(),r&&r.terminate())},n.prototype.activeCall=function(e){u.info("[VideoServiceEventHandler] activeCall "+e);var t=v.connection.jingle.sessions[e];this.videoService.autoreleaseTimeout&&h.cancel(this.videoService.autoreleaseTimeout);var n=this.videoService.calls[e];this.videoService.updateRemoteTypeMedia(t.remoteType,n),n&&n.status.key!==m.Status.RELEASING.key&&n.status.key!==m.Status.UNKNOWN.key&&(n.setStatus(m.Status.ACTIVE),f.$broadcast("ON_CALL_UPDATED_EVENT",n)),n.isInitiator&&o.trackCallSuccessNumber(t.localType)},n.prototype.terminatedCall=function(e,t){0===Object.keys(v.connection.jingle.sessions).length&&u.webrtc("INFO    | all calls terminated");var n=this.videoService.calls[e];n||0===this.videoService.calls.length?("busy"===t&&this.videoService.openErrorPopup("remoteUserNoMoreAvailable"),this.videoService.autoreleaseTimeout&&h.cancel(this.videoService.autoreleaseTimeout),this.videoService.disableAudioVideoMedia(null,e),this.videoService.createOrUpdateStatisticsForCall(e),this.videoService.callsStats[e]&&delete this.videoService.callsStats[e],n&&("cancel"!==t&&o.trackCallDuration((new Date).getTime()-n.startDate.getTime()),this.videoService.removeCallObject(n)),h(function(){p.resetBusyState()},1e3,1,!0),this.videoService.statsInterval&&(h.cancel(this.videoService.statsInterval),this.videoService.statsinterval=null),this.videoService.displayWebRTCStats(e)):u.webrtc("INFO    | terminatedCall : no call with "+e+" exists.")},n.prototype.onJingleError=function(e){e&&this.videoService.calls[e]&&this.videoService.calls[e].status!==m.Status.ACTIVE&&(this.videoService.removeCallObject(this.calls[e]),this.videoService.resetToSafeState(),this.videoService.openErrorPopup("IceConnectionFailed"))},n.prototype.iceConnectionStateChange=function(e,t){u.info("[VideoServiceEventHandler] iceConnectionStateChange for "+e);var n=this,r=null,i=n.videoService.calls[t.sid];try{if(t.peerconnection&&"stable"===t.peerconnection.signalingState&&"connected"===t.peerconnection.iceConnectionState){u.webrtc("INFO    | ICE Connection established successfully"),angular.element("#globalAudioTag")[0]&&u.info("[VideoServiceEventHandler] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),n.videoService.reconnectCall=!1,(r=n.videoService.calls[e])&&r.status!==m.Status.ACTIVE&&(u.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(e)),t.isRenegotiating&&(u.webrtc("INFO    | Renegotiating done"),t.isRenegotiating=!1,f.$broadcast("ON_WEBRTC_CALL_ESCALATION",r),f.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",r)),o.endNegotiationTime();var a=o.negotiationTime();a&&(u.webrtc("INFO    | negotiation time: "+a+"ms"),o.trackNegotiationTime()),r&&r.isInitiator&&o.trackICESuccess(e)}t.peerconnection&&"stable"===t.peerconnection.signalingState&&"completed"===t.peerconnection.iceConnectionState&&(u.webrtc("INFO    | ICE Connection completed successfully"),n.videoService.reconnectCall=!1,(r=n.videoService.calls[e])&&r.status!==m.Status.ACTIVE&&(u.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(e)),t.isRenegotiating&&(u.webrtc("INFO    | Renegotiating done"),t.isRenegotiating=!1,f.$broadcast("ON_WEBRTC_CALL_ESCALATION",r),f.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",r))),t.peerconnection&&"stable"===t.peerconnection.signalingState&&"disconnected"===t.peerconnection.iceConnectionState&&(u.webrtc("INFO    | signalingState disconnected"),i&&i.status!==m.Status.UNKNOWN&&(u.webrtc("INFO    | iceConnectionStateChange go to connecting state"),i.setStatus(m.Status.CONNECTING),f.$broadcast("ON_CALL_UPDATED_EVENT",i)),n.videoService.connected||(n.videoService.reconnectCall=!0)),t.peerconnection&&"stable"===t.peerconnection.signalingState&&"failed"===t.peerconnection.iceConnectionState&&(u.webrtc("INFO    | signalingState FAILED"),i&&i.status!==m.Status.UNKNOWN&&(u.webrtc("INFO    | iceConnectionStateChange go to connecting state"),i.setStatus(m.Status.CONNECTING),f.$broadcast("ON_CALL_UPDATED_EVENT",i),f.$broadcast("ON_RECORDING_CNXLOST_EVENT")),n.videoService.connected||(n.videoService.reconnectCall=!0))}catch(e){try{u.error("JINGLE  | iceconnectionstatechange error "+e),i?n.videoService.removeCallObject(i,"unsupported-applications"):v.connection.jingle.terminate(null,"unsupported-applications"),p.resetBusyState()}catch(e){u.error("JINGLE  | iceconnectionstatechange error "+e),p.resetBusyState()}}},n.prototype.mediaModified=function(e,t){u.info("[VideoServiceEventHandler] mediaModified "+e);var n=this.videoService.calls[e];v.connection.jingle.sessions[e].isRenegotiating=!0,n.remoteMedia="sharing"===t?m.Media.AUDIO|m.Media.SHARING:"video"===t?m.Media.AUDIO|m.Media.VIDEO:"sharing+video"===t?m.Media.AUDIO|m.Media.VIDEO|m.Media.SHARING:m.Media.AUDIO,p.setBusyState("dnd",this.videoService.calculatePresenceMessage(n)),f.$broadcast("ON_WEBRTC_CALL_ESCALATION",n)},n}]),angular.module("rainbow").service("webrtcServiceEventHandler",["$log","$q","$rootScope","videoService","webConferenceService","xmppService","contactService","Call",function(o,e,a,s,c,l,d,u){"use strict";var r=this;this.nameSpace="urn:xmpp:jingle-message:0",this.messageHandlerRef=null,this.started=!1,this.start=function(){return this.started=!0,this.attachHandlers(),e.when()},this.stop=function(){return this.started=!1,r.removeHandlers(),e.when()},this.attachHandlers=function(){this.removeHandlers(),o.info("[webrtcServiceEventHandler] attachHandlers"),this.messageHandlerRef||(this.messageHandlerRef=l.addHandler(function(e){try{return r.onMessageReceived(e),!0}catch(e){return o.error("[webrtcServiceEventHandler] caught error "+e),!0}},r.nameSpace,"message"))},this.removeHandlers=function(){o.info("[webrtcServiceEventHandler] removeHandlers"),this.messageHandlerRef&&(l.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null)},this.onMessageReceived=function(t){var e=$(t).attr("from"),n=l.getBareJidFromJid(e),r=$(t).find("propose").find("conference").attr("id");if(c.getConferenceSessionById(r))try{if(o.info("[webrtcServiceEventHandler]   | onMessageReceived"),0<$(t).find("propose").length){var i=$(t).find("propose").attr("id"),a=$msg({from:d.userContact.fullJid,to:d.userContact.jid}).c("accept",{xmlns:this.nameSpace,id:i});l.send(a);a=$msg({from:d.userContact.fullJid,to:n}).c("proceed",{xmlns:this.nameSpace,id:i});return l.send(a),!0}}catch(e){return s.videoEventHandler.onMessageReceived(t)}return s.videoEventHandler.onMessageReceived(t)},this.checkSessionAudioSentHealthStatus=function(e){o.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- 0 audio packets sent !");var t=s.calls[e];if(t&&!t.isInCallWithMediaPillar()){if(t.status.key===u.Status.ACTIVE.key&&t.localMedia&u.Media.AUDIO&&!t.isMuted){if(s.callsStatsSimplified[e].numberOfErrorAudioSent+=1,s.callsStatsSimplified[e].numberOfErrorAudioSent%2)return void o.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore");var n=l.connection.jingle.sessions[t.id];n&&!n.isRenegotiating&&(o.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego P2P call"),s.renegotiateCurrentCall(t)),a.$broadcast("ON_WEBRTC_CALL_AUDIO_ISSUE",!0)}}else{var r=c.getActiveConferenceSession();if(r&&r.id&&r.active&&"connected"===r.status){var i=c.getRemoteAudioSession(r.id);if(i&&i.sid===e){if(s.callsStatsSimplified[e].numberOfErrorAudioSent+=1,s.callsStatsSimplified[e].numberOfErrorAudioSent%2)return void o.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore");o.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego SFU conference"),c.onAudioProfileChangeEvent()}}}},this.checkSessionAudioReceivedHealthStatus=function(e){o.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- user hears nothing !");var t=s.calls[e];if(t&&!t.isInCallWithMediaPillar())t.status.key===u.Status.ACTIVE.key&&t.remoteMedia&u.Media.AUDIO&&(s.callsStatsSimplified[e].errorAudioReceived=1,o.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- reset output device"),s.resetAudioOutputElement());else{var n=c.getActiveConferenceSession();if(n&&n.id&&n.active&&"connected"===n.status){var r=c.getRemoteAudioSession(n.id);r&&r.sid===e&&(s.callsStatsSimplified[e].errorAudioReceived=1,o.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- renego SFU conference"),s.resetAudioOutputElement())}}},angular.element(document).bind("callincoming.jingle",function(e,t){o.webrtc("webrtcServiceEventHandler  | callincoming.jingle "+t);var n=l.connection.jingle.sessions[t];n&&n.confId?c.onIncomingCall(t):s.videoEventHandler.incomingCall(t)}),angular.element(document).bind("callterminated.jingle",function(e,t,n){a.$apply(function(){var e=n||"";(o.webrtc("webrtcServiceEventHandler  | callterminated "+t+" reason: "+e),"multi-device"===n)?c.onConferenceCallSwitched(t):s.calls[t]?s.videoEventHandler.terminatedCall(t,e):c.onTerminatedCall(t)})}),angular.element(document).bind("iceconnectionstatechange.jingle",function(e,t,n){n.peerconnection?(o.webrtc("JINGLE  | iceconnectionstatechange "+t+" "+n.peerconnection.iceConnectionState+"|"+n.peerconnection.signalingState),s.calls[t]?s.videoEventHandler.iceConnectionStateChange(t,n):c.onIceConnectionStateChange(t,n)):o.webrtc("JINGLE  | iceconnectionstatechange - peerConnection does not exist anymore !!!")}),angular.element(document).bind("error.jingle",function(e,t){o.error("JINGLE  | callerror"),t&&t.error&&o.error(JSON.stringify(t.error));var n=t.sid;n&&(s.calls[n]?s.videoEventHandler.onJingleError(n):c.onJingleError(n))}),angular.element(document).bind("webrtcSessionStatsSimplyfied.jingle",function(e,t,n){s.callsStatsSimplified[t]||(s.callsStatsSimplified[t]={},s.callsStatsSimplified[t].numberOfErrorAudioSent=0,s.callsStatsSimplified[t].errorAudioReceived=0),n.numberOfErrorAudioSent=s.callsStatsSimplified[t].numberOfErrorAudioSent,n.errorAudioReceived=s.callsStatsSimplified[t].errorAudioReceived,s.callsStatsSimplified[t]=n,o.info("[videoService] on webrtcSessionStatsSimplyfied for session "+t+" : "+JSON.stringify(n)),0===n.packetsAudioSent||0===n.audioInputLevel?r.checkSessionAudioSentHealthStatus(t):(s.callsStatsSimplified[t].numberOfErrorAudioSent&&a.$broadcast("ON_WEBRTC_CALL_AUDIO_ISSUE",!1),s.callsStatsSimplified[t].numberOfErrorAudioSent=0),n.packetsAudioReceived&&0===n.audioOutputLevel&&0===n.errorAudioReceived&&r.checkSessionAudioReceivedHealthStatus(t)})}]),angular.module("rainbow").service("settingsService",["$rootScope","$translate","$localStorage",function(r,i,a){"use strict";var o=this;o.initialize=function(){o.defaultLanguage={label:"English",settingCode:"en",code:"en",isoCode:"en",codeMoment:"en",unicode:"1f1ec-1f1e7",beta:!1},o.languages=[o.defaultLanguage,{label:"Français",settingCode:"fr",code:"fr",isoCode:"fr",codeMoment:"fr",unicode:"1f1eb-1f1f7",beta:!1},{label:"Deutsch",settingCode:"de",code:"de",isoCode:"de",codeMoment:"de",unicode:"1f1e9-1f1ea",beta:!1},{label:"Español",settingCode:"es-es",code:"es-es",isoCode:"es-ES",codeMoment:"es",unicode:"1f1ea-1f1f8",beta:!1},{label:"Suomi",settingCode:"fi",code:"fi",isoCode:"fi",codeMoment:"fi",unicode:"1f1eb-1f1ee",beta:!0},{label:"Italiano",settingCode:"it",code:"it",isoCode:"it",codeMoment:"it",unicode:"1f1ee-1f1f9",beta:!1},{label:"עברית",settingCode:"he",code:"he",isoCode:"he",codeMoment:"he",unicode:"1f1ee-1f1f1",beta:!1},{label:"日本語",settingCode:"ja",code:"ja",isoCode:"ja",codeMoment:"ja",unicode:"1f1ef-1f1f5",beta:!1},{label:"한국어",settingCode:"ko",code:"ko",isoCode:"ko",codeMoment:"ko",unicode:"1f1f0-1f1f7",beta:!1},{label:"Nederlands",settingCode:"nl",code:"nl",isoCode:"nl",codeMoment:"nl",unicode:"1F1F3-1F1F1",beta:!1},{label:"Nynorsk",settingCode:"no",code:"no",isoCode:"no",codeMoment:"nn",unicode:"1F1F3-1F1F4",beta:!0},{label:"Português do Brasil",settingCode:"pt-br",code:"pt-BR",isoCode:"pt-BR",codeMoment:"pt-br",unicode:"1F1E7-1F1F7",beta:!1},{label:"Português",settingCode:"pt-pt",code:"pt-PT",isoCode:"pt-PT",codeMoment:"pt-pt",unicode:"1F1F5-1F1F9",beta:!1},{label:"Polski",settingCode:"pl",code:"pl",isoCode:"pl",codeMoment:"pl",unicode:"1F1F5-1F1F1",beta:!0},{label:"Svenskt",settingCode:"sv-se",code:"sv-SE",isoCode:"sv-SE",codeMoment:"sv",unicode:"1F1F8-1F1EA",beta:!0},{label:"Türkçe",settingCode:"tr",code:"tr",isoCode:"tr",codeMoment:"tr",unicode:"1f1f9-1f1f7",beta:!1},{label:"中文",settingCode:"zh-cn",code:"zh-cn",isoCode:"zh-CN",codeMoment:"zh-cn",unicode:"1f1e8-1f1f3",beta:!1},{label:"繁體中文",settingCode:"zh-tw",code:"zh-TW",isoCode:"zh-TW",codeMoment:"zh-tw",unicode:"1F1F9-1F1FC",beta:!1}],o.languageCodes=o.getAvailableLanguages().map(function(e){return e.settingCode}),o.settings={init:!0,lang:"en",imSound:"true",imNotif:"true",imStartSound:"false",notifReminder:"gentle",displayOrder:"firstLast",nbMaxConversations:"15",skin:"rainbow",microphone:"default",headsetMicrophone:null,speakerphoneMicrophone:null,customMicrophone:null,headsetDeviceName:null,speakerphoneDeviceName:null,speaker:"default",headsetSpeaker:null,speakerphoneSpeaker:null,customSpeaker:null,ringingSpeaker:"default",camera:"default",audioProfile:"handfree",currentDevice:null,iceConfig:null,sdk:!1,userWiewOrderType:"lastname",userWiewFilterType:"all",one2oneColors:"true",accessibleColors:"false",autoStartAnimatedGif:"false",translationMsg:"false",server:null,activeAlarm:"relax1",activeNotif:"stairs",devMode:"false",hasSecondRinger:"false",validationMode:"false",disableCalendarPresence:"false",giphy:"false",deviceList:"[]",displayFilesType:"document-cell--as-grid",handFreeInputDeviceName:null,handFreeOutputDeviceName:null,customSpeakerName:null,customMicrophoneName:null,showBodyMessage:"false",bubblesOrderType:"creationDate",bubblesFilterType:"all",channelVideo:"false"},a.get(Object.keys(o.settings)).then(function(t){if(t.nbMaxConversations||(t.nbMaxConversations=o.settings.nbMaxConversations),t.skin||(t.skin=o.settings.skin),r.default_language&&(t.lang=s(r.default_language),o.setSetting("lang",t.lang)),"default"===t.headsetMicrophone&&(t.headsetMicrophone=null),"default"===t.headsetSpeaker&&(t.headsetSpeaker=null),"default"===t.speakerphoneMicrophone&&(t.speakerphoneMicrophone=null),"default"===t.speakerphoneSpeaker&&(t.speakerphoneSpeaker=null),"default"===t.customMicrophone&&(t.customMicrophone=null),"default"===t.customSpeaker&&(t.customSpeaker=null),null===t.init){var e=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;o.settings.lang=t.lang?t.lang:s(e),a.set(o.settings)}else Object.keys(t).forEach(function(e){null!==t[e]&&(o.settings[e]=t[e])});var n=o.getAppliLanguage();i.use(n.code),moment.locale(n.codeMoment)})},o.getSetting=function(e){return o.settings[e]},o.setSetting=function(e,t){o.settings[e]=t,a.set(o.settings)},o.getAvailableLanguages=function(){return o.languages.filter(function(e){return!1===e.beta||config.betaLanguages})},o.getAppliLanguage=function(){var e=o.getAvailableLanguages().filter(function(e){return e.settingCode===o.settings.lang})[0];return e||o.defaultLanguage},o.setAppliLanguageCode=function(e,t){t?o.setSetting("lang",e):o.settings.lang=e;var n=o.getAppliLanguage();moment.locale(n.codeMoment),i.use(n.code).then(function(){r.$broadcast("ON_LANGUAGE_UPDATED_EVENT",e)})},o.getAppliLanguageCodeForServer=function(){var e=o.settings.lang.split("-");return 1===e.length?o.settings.lang:e[0]+"-"+e[1].toUpperCase()},o.setAppliLangageCodeFromServer=function(e){var t=e.split("-"),n=t[0];n&&(n=n.toLowerCase()),2===t.length&&(n+="-"+t[1].toLowerCase()),n=s(n),n=0<=o.languageCodes.indexOf(n)?n:"en",o.setAppliLanguageCode(n)},o.getLanguageByIsoCode=function(t){return o.languages.find(function(e){return e.isoCode===t})},o.getBestLanguageForIsoCode=function(e){var t=o.getLanguageByIsoCode(e);if(!t){if(-1!==e.indexOf("-")){var n=e.split("-")[0];t=o.getLanguageByIsoCode(n)}t||(t=o.getLanguageByIsoCode("en"))}return t},o.setIceConfig=function(e){o.settings.iceConfig=e},o.forceTurn=function(e){var t=(config.turnOn=e)?"Debug mode : Only use turn servers":"Normal mode : use stun and turn servers";r.$broadcast("ON_SETTING_FORCE_TURN_EVENT",t)},o.enableRemoteConsole=function(e){var t=document.createElement("script");t.src="//console.re/connector.js",t.id="consolerescript",t.setAttribute("data-channel",e),t.onreadystatechange=t.onload=function(){app.remoteConsole.info=!0,app.remoteConsole.debug=!0,app.remoteConsole.log=!0,console.re.info("Connected")},document.getElementsByTagName("head")[0].appendChild(t)};var s=function(e){var t="en";if(e)switch(e.split("-")[0]){case"en":t="en";break;case"fr":t="fr";break;case"de":t="de";break;case"es":t="es-es";break;case"fi":t="fi";break;case"it":t="it";break;case"he":t="he";break;case"ja":t="ja";break;case"ko":t="ko";break;case"nl":t="nl";break;case"no":t="no";break;case"pt":t="pt-br"===e.toLowerCase()?"pt-br":"pt-pt";break;case"pl":t="pl";break;case"sv":t="sv-SE";break;case"tr":t="tr";break;case"zh":t=0<=["zh-cn","zh-tw"].indexOf(e.toLowerCase())?e.toLowerCase():"zh-cn";break;default:t="en"}return t};o.initialize()}]);var FeedChannel=function(){this.messages=[],this.complete=!1,this.pageIndex=0,this.isLoading=!1,this.type="AGGREGATE"},ChannelService=function(){function l(e,t,n,r,i,a,o,s,c,l,d,u){this.$q=e,this.$http=t,this.$log=n,this.$rootScope=r,this.authService=i,this.xmppService=a,this.contactService=o,this.errorHelperService=s,this.Channel=c,this.roomService=l,this.Contact=d,this.profileService=u,this.listeners=[],this.channels={},this.channelsList=[],this.LIST_EVENT_TYPE={ADD:0,UPDATE:1,REMOVE:2,DELETE:3,SUBSCRIBE:4,UNSUBSCRIBE:5,CREATE:6},this.USER_ROLE={NONE:"none",OWNER:"owner",PUBLISHER:"publisher",MEMBER:"member"},this.NOTIFICATION_TYPE={INVITED:0,REMOVED:1,DELETED:2,ADDED:3,CREATED:4},this.MESSAGE_ACTION={ADD:0,RETRACT:1},this.xmpp_message_handler=null,this.xmpp_management_handler=null,this.notificationCounter=0,this.messageCounter=0,this.invitationCounter=0,this.CHANNEL_UPDATE_EVENT="CHANNEL_UPDATE_EVENT",this.CHANNEL_MESSAGE_RECEIVED="CHANNEL_MESSAGE_RECEIVED",this.CHANNEL_USERS_UPDATE_EVENT="CHANNEL_USERS_UPDATE_EVENT",this.CHANNEL_NOTIFICATION_NUMBER_UPDATED="CHANNEL_NOTIFICATION_NUMBER_UPDATED",this.CHANNEL_USER_SUBSCRIPTION_EVENT="CHANNEL_USER_SUBSCRIPTION_EVENT"}return l.prototype.start=function(i){var a=this;return this.$q(function(n){if(!a.profileService.isFeatureEnabled(a.profileService.FeaturesEnum.CHANNEL_ACTIVATED))return n();if(a.contactService.userContact.isCPaaSGuest())return n();a.$log.info("[channelService] === STARTING ===");var r=performance.now();a.init(),a.attachListeners(),a.getMyChannels().then(function(e){var t=Math.round(performance.now()-r);a.$log.info("[channelService] === STARTED ("+t+" ms) ==="),i.push({service:"channelService",startDuration:t}),n()}).catch(function(e){a.$log.info("[channelService] === STARTING FAILURE === "+a.errorHelperService.message),n()})})},l.prototype.init=function(){this.feedChannel=new FeedChannel,this.portalURL=config.restServerUrl+"/api/rainbow/channels/v1.0/channels",this.attachHandlers()},l.prototype.attachHandlers=function(){var t=this;this.$log.info("[callLogService] attachHandlers"),this.xmpp_message_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_message_handler),this.xmpp_message_handler=null),this.xmpp_management_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_management_handler),this.xmpp_management_handler=null),this.xmpp_message_handler=this.xmppService.connection.addHandler(function(e){return t.onChannelMessageReceived(e)},null,"message","headline"),this.xmpp_management_handler=this.xmppService.connection.addHandler(function(e){return t.onChannelManagementReceived(e)},null,"message","management")},l.prototype.attachListeners=function(){var r=this;this.listeners.push(this.$rootScope.$on(this.CHANNEL_USERS_UPDATE_EVENT,function(e,t,n){return r.usersUpdateHandler(e,t,n)}))},l.prototype.stop=function(){var t=this;return this.$q(function(e){t.$log.info("[channelService] === STOPPING ==="),t.listeners.forEach(function(e){e()}),t.channels={},t.channelsList=[],t.feedChannel=null,t.notificationCounter=0,t.$log.info("[channelService] === STOPPED ==="),e()})},l.prototype.removeChannelFromCache=function(i){var a=this;return this.$q(function(e,t){var n=a.getChannelFromCache(i);if(n){var r=n.name;n.invited&&a.decrementInvitationCounter(),delete a.channels[i],a.updateChannelsList(),a.feedChannel.messages=[],a.retrieveLatests().then(function(){e(r)}).catch(function(e){t(e)})}})},l.prototype.onChannelMessageReceived=function(o){var s=this;try{return this.$rootScope.$apply(function(){var e=angular.element(o).find("event");if(e&&"http://jabber.org/protocol/pubsub#event"===e.attr("xmlns")){s.$log.info("[channelService] onChannelMessageReceived ");var t=e.find("items"),n=t.find("item"),r=t.find("retract");if(1===n.length)s.onNewMessage(n);else if(1===r.length){var i=r.attr("id"),a=t.attr("node").split(":")[0];s.onRetractMessage(a,i)}}}),!0}catch(e){return this.$log.error("[channelService] onChannelMessageReceived -- failure -- "+e.message),!0}},l.prototype.onNewMessage=function(e){var t=this,n=e.find("entry"),r=e.attr("id"),i=n.attr("channelId");this.$log.info("[channelService] onChannelMessageReceived -- new message "+r+" on channel "+i);var a={id:r,channelId:i,from:n.attr("from"),fromDetails:null,new:!1,entry:{message:n.find("message").length?n.find("message")[0].textContent:"",title:n.find("title").length?n.find("title")[0].textContent:"",url:n.find("url").length?n.find("url")[0].textContent:"",images:[],video:null},timestamp:new Date(n.attr("timestamp"))};a.entry.message=a.entry.message.replace(/<a/gi,"<a target='_blank' rel='noopener noreferrer' ");var o=e.find("images");0!==o.length&&o.find("id").each(function(e,t){a.entry.images.push({id:t.textContent})});var s=e.find("video");0!==s.length&&(a.entry.video={provider:s.find("provider")[0].textContent,id:s.find("id")[0].textContent});var c=this.getChannelFromCache(a.channelId);this.contactService.getOrCreateContact(a.from).then(function(e){a.fromDetails=e,c.messages.unshift(a),t.feedChannel.messages.unshift(a),t.contactService.userContact.jid!==a.from&&(a.new=!0,t.incrementMessagesCounter()),t.$rootScope.$broadcast(t.CHANNEL_MESSAGE_RECEIVED,t.MESSAGE_ACTION.ADD,a)})},l.prototype.onRetractMessage=function(e,t){this.$log.info("[channelService] onChannelMessageReceived -- retract message "+t+" on channel "+e);var n=this.getChannelFromCache(e),r=n.messages.findIndex(function(e){return e.id===t});-1!==r&&(n.messages[r].new&&this.decrementMessagesCounter(),n.messages.splice(r,1));var i=this.feedChannel.messages.findIndex(function(e){return e.id===t});-1!==i&&this.feedChannel.messages.splice(i,1),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.RETRACT,t)},l.prototype.onChannelManagementReceived=function(o){var s=this;try{return this.$rootScope.$apply(function(){var e=angular.element(o).find("channel");if(e&&0<e.length){var t=e.attr("channelid"),n=e.find("avatar");if(n&&0<n.length)return s.onAvatarChange(t,n),!0;var r=e.attr("action");switch(s.$log.info("[channelService] onChannelManagementReceived -- "+r+" event received on channel "+t),r){case"add":s.onAddToChannel(t);break;case"remove":s.onRemovedFromChannel(t);break;case"subscribe":s.onSubscribeToChannel(t);break;case"unsubscribe":s.onUnsubscribeToChannel(t);break;case"delete":s.onDeleteChannel(t)}}var i=angular.element(o).find("channel-subscription");if(i&&0<i.length){t=i.attr("channelid"),r=i.attr("action");var a=i.attr("id");switch(s.$log.info("[channelService] onChannelManagementReceived -- subscription-"+r+" event received on channel "+t),r){case"subscribe":s.onUserSubscribeEvent(t,a);break;case"unsubscribe":s.onUserUnsubscribeEvent(t,a)}}}),!0}catch(e){return this.$log.error("[channels] onChannelManagementReceived -- failure -- "+e.message),!0}},l.prototype.onAvatarChange=function(e,t){var n=t.attr("action"),r=t.attr("lastAvatarUpdateDate")?new Date:null;if(this.$log.info("[channelService] onChannelManagementReceived -- "+n+" avatar for "+e+". Update date : "+r.toString()),"delete"===n||"update"===n){var i=this.getChannelFromCache(e);null!==(i.lastAvatarUpdateDate=r)&&(i.avatar=config.restServerUrl+"/api/channel-avatar/"+e+"?size=256&ts="+(new Date).getTime())}},l.prototype.onAddToChannel=function(t){var n=this,r=this.getChannelFromCache(t);this.getChannel(t).then(function(e){r||e.invited?!r&&e.invited?(n.addChannelToCache(e),n.incrementInvitationCounter(),n.$rootScope.$broadcast(n.CHANNEL_UPDATE_EVENT,n.LIST_EVENT_TYPE.SUBSCRIBE,e.id)):r&&e.userRole!==n.USER_ROLE.NONE&&(r.userRole=e.userRole,n.feedChannel.messages=[],n.retrieveLatests().then(function(){n.$rootScope.$broadcast(n.CHANNEL_UPDATE_EVENT,n.LIST_EVENT_TYPE.SUBSCRIBE,t)})):(n.addChannelToCache(e),"private"===e.visibility&&n.$rootScope.$broadcast(n.CHANNEL_UPDATE_EVENT,n.LIST_EVENT_TYPE.ADD,e.id))})},l.prototype.onRemovedFromChannel=function(t){var n=this;this.removeChannelFromCache(t).then(function(e){n.$rootScope.$broadcast(n.CHANNEL_UPDATE_EVENT,n.LIST_EVENT_TYPE.DELETE,t)})},l.prototype.onSubscribeToChannel=function(e){var t=this,n=this.getChannelFromCache(e);n?(n.invited=!1,n.subscribed=!0,this.feedChannel.messages=[],this.retrieveLatests().then(function(){t.$rootScope.$broadcast(t.CHANNEL_UPDATE_EVENT,t.LIST_EVENT_TYPE.SUBSCRIBE,e)})):this.getChannel(e).then(function(e){return t.addChannelToCache(e),t.feedChannel.messages=[],t.retrieveLatests()}).then(function(){t.$rootScope.$broadcast(t.CHANNEL_UPDATE_EVENT,t.LIST_EVENT_TYPE.SUBSCRIBE,e)})},l.prototype.onUnsubscribeToChannel=function(e){var t=this;this.removeChannelFromCache(e).then(function(){t.$rootScope.$broadcast(t.CHANNEL_UPDATE_EVENT,t.LIST_EVENT_TYPE.UNSUBSCRIBE,e)})},l.prototype.onDeleteChannel=function(e){var t=this;this.removeChannelFromCache(e).then(function(){t.$rootScope.$broadcast(t.CHANNEL_UPDATE_EVENT,t.LIST_EVENT_TYPE.DELETE,e)})},l.prototype.onUserSubscribeEvent=function(e,t){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,e,t)},l.prototype.onUserUnsubscribeEvent=function(e,t){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,e,t)},l.prototype.getChannelNextPage=function(o,s){var c=this;return void 0===s&&(s=!1),this.$q(function(t,n){var r="AGGREGATE"===o.type?"feedChannel":o.id;if(o.isLoading)return c.$log.info("[channelService] getFeedMessagesPage("+r+", "+o.pageIndex+") -- ignored (isLoading)"),t();o.isLoading=!0,s&&(o.pageIndex=0);o.messages.length;var e=(o.pageIndex+1)*l.PAGE_SIZE;if(e<=o.messages.length)c.$log.info("[channelService] getFeedMessagesPage("+r+", "+o.pageIndex+") -- success from cache"),o.pageIndex+=1,o.isLoading=!1,t(o.messages.slice(0,e));else if(o.complete)c.$log.info("[channelService] getFeedMessagesPage("+r+", "+o.pageIndex+") -- success from cache (complete)"),o.isLoading=!1,t(o.messages);else{var i=o.messages,a=i.length?i[i.length-1].timestamp:null;c.getChannelMessages(o,a).then(function(e){e<l.PAGE_SIZE&&(o.complete=!0),c.$log.info("[channelService] getFeedMessagesPage("+r+", "+o.pageIndex+") -- success from server "+(o.complete?"(complete)":"")+" -- retreive "+e+" message(s)"),o.pageIndex+=1,o.isLoading=!1,t(o.messages)}).catch(function(e){c.$log.error("[channelService] getFeedMessagesPage("+r+", "+o.pageIndex+") -- failure -- "+e.message),o.isLoading=!1,n(e)})}})},l.prototype.getChannelPublishers=function(r){var i=this;return this.$q(function(t,n){if(r.publishersRetreived)return t();i.getChannelUsers(r.id,{format:"full",types:"owner publisher"}).then(function(e){e.data.forEach(function(e){var t=i.contactService.getContactByJid(e.jid_im);t||((t=new i.Contact).updateFromUserData(e),t.updateRichStatus(),i.contactService.contacts[t.id]=t,i.contactService.dbContacts[t.dbId]=t,i.contactService.jtelContacts[t.jidtel]=t),r.users.push(t)}),r.publishersRetreived=!0,i.$log.info("[channelService] getChannelPublishers ("+r.id+"}) -- success -- find "+e.length+" publisher(s)"),t()}).catch(function(e){i.$log.error("[channelService] getChannelPublishers ("+r.id+"}) -- failure -- "+e.message),n(e)})})},l.prototype.getChannelMessages=function(n,r){var i=this;return this.$q(function(t,e){("AGGREGATE"===n.type?i.getLatestMessages(10,r):i.getChannelItems(n.id,l.PAGE_SIZE,r)).then(function(e){e.forEach(function(t){t.entry.message&&(t.entry.message=t.entry.message.replace(/<a/gi,"<a target='_blank' rel='noopener noreferrer' "));t.entry.message&&t.entry.message;i.contactService.getOrCreateContact(t.from).then(function(e){t.fromDetails=e})}),n.messages.push.apply(n.messages,e),t(e.length)})})},l.prototype.getMyChannels=function(){var r=this;return this.$q(function(t,n){r.$http({method:"GET",url:r.portalURL+"?format=full",headers:r.authService.getRequestHeader()}).then(function(e){r.$log.info("[channelService] getMyChannels -- success"),e.data.data.forEach(function(e){var t=r.Channel(e);t.invited&&r.incrementInvitationCounter(),r.channels[t.id]=t}),r.updateChannelsList(),t(r.channelsList)}).catch(function(e){r.$log.error("[channelService] getMyChannels -- failure"),n(e)})})},l.prototype.createChannel=function(r,i,a,o,s,c){var l=this;return void 0===c&&(c=!1),this.$q(function(n,t){var e={name:r};i&&"string"==typeof i&&i.length&&(e.topic=i),a&&"string"==typeof a&&a.length&&(e.visibility=a),o&&"number"==typeof o&&0<o&&(e.max_items=o),s&&"number"==typeof s&&0<s&&(e.max_payload_size=s),l.$http({method:"POST",url:l.portalURL,headers:l.authService.getPostHeader(),data:e,params:{auto_provisioning:c}}).then(function(e){l.$log.info("[channelService] createChannel -- "+r+" -- success");var t=l.Channel(e.data.data);n(t)}).catch(function(e){l.$log.error("[channelService] createChannel -- "+r+" -- failure -- "+e.message),t(e)})})},l.prototype.deleteChannel=function(r){var i=this;return this.$q(function(t,n){i.$http({method:"DELETE",url:i.portalURL+"/"+r,headers:i.authService.getPostHeader()}).then(function(e){i.$log.info("[channelService] deleteChannel -- "+r+" -- success"),t(e)}).catch(function(e){i.$log.error("[channelService] deleteChannel -- "+r+" -- failure"),n(e)})})},l.prototype.findChannels=function(e){var i=this;return this.$q(function(n,t){var r="?";e.sortOrder&&-1===e.sortOrder?r+="sortOrder=-1":r+="sortOrder=1",void 0!==e.subscribed&&(r+="&subscribed="+e.subscribed),e.name&&(r+="&name="+e.name),e.topic&&(r+="&topic="+e.topic),e.limit&&(r+="&limit="+e.limit),e.offset&&(r+="&offset="+e.offset),e.sortField&&(r+="&sortField="+e.sortField),i.$http({method:"GET",url:i.portalURL+"/search"+r,headers:i.authService.getRequestHeader()}).then(function(e){var t=[];e.data.data.forEach(function(e){t.push(i.Channel(e))}),n(t)}).catch(function(e){i.$log.error("[channelService] findChannels ("+r+") -- failure -- "+e.message),t(e)})})},l.prototype.getChannel=function(r){var i=this;return this.$q(function(n,t){i.$http({method:"GET",url:i.portalURL+"/"+r,headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[channelService] getChannel -- "+r+" -- success");var t=i.Channel(e.data.data);n(t)}).catch(function(e){i.$log.warn("[channelService] getChannel -- "+r+" -- failure -- "+e.message),t(e)})})},l.prototype.getChannelFromCache=function(e){var t=this.channels[e];return void 0!==t?t:null},l.prototype.publishToChannel=function(r,i,a,e,o,s){var c=this;return this.$q(function(t,n){var e={title:a||"",message:i,images:o||[]};s&&(e.video=s),c.$http({method:"POST",url:c.portalURL+"/"+r+"/publish",headers:c.authService.getRequestHeader(),data:e}).then(function(e){c.$log.info("[channelService] publishToChannel -- "+r+" -- success"),t(e)}).catch(function(e){c.$log.warn("[channelService] publishToChannel -- "+r+" -- failure -- "+e.message),n(e)})})},l.prototype.subscribeToChannel=function(r){var i=this;return this.$q(function(t,n){i.$http({method:"POST",url:i.portalURL+"/"+r.id+"/subscribe",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[channelService] subscribeToChannel -- "+r.id+" -- success"),r.subscribed=!0,i.updateChannelCount(r.id,1),t(e)}).catch(function(e){i.$log.warn("[channelService] subscribeToChannel -- "+r.id+" -- failure -- "+e.message),n(e)})})},l.prototype.unsubscribeToChannel=function(r){var i=this;return this.$q(function(t,n){i.$http({method:"DELETE",url:i.portalURL+"/"+r.id+"/subscribe",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[channelService] unsubscribeToChannel -- success"),r.subscribed=!1,i.updateChannelCount(r.id,-1),t(e)}).catch(function(e){i.$log.warn("[channelService] unsubscribeToChannel -- failure -- "+e.message),n(e)})})},l.prototype.updateChannel=function(r,e){var i=this;return this.$q(function(n,t){i.$http({method:"PUT",url:i.portalURL+"/"+r,headers:i.authService.getPostHeader(),data:e}).then(function(e){var t=i.getChannelFromCache(r);t.name=e.data.data.name,t.topic=e.data.data.topic,i.$log.info("[channelService] updateChannel ( "+r+") -- success"),i.$rootScope.$broadcast(i.CHANNEL_UPDATE_EVENT,i.LIST_EVENT_TYPE.UPDATE,t.id),n(t)}).catch(function(e){i.$log.warn("[channelService] updateChannel ( "+r+") -- failure -- "+e.message),t(e)})})},l.prototype.getChannelItems=function(e,r,i,a){var o=this;return void 0===i&&(i=null),void 0===a&&(a=null),this.$q(function(t,n){o.$http({method:"GET",url:o.portalURL+"/"+e+"/items",headers:o.authService.getRequestHeader(),params:{max:r,before:i,after:a}}).then(function(e){o.$log.info("[channelService] getChannelItems -- success"),o.chewReceivedItems(e.data.data.items),t(e.data.data.items)}).catch(function(e){o.$log.warn("[channelService] getChannelItems -- failure -- "+e.message),n(e)})})},l.prototype.deleteChannelItem=function(r,e){var i=this;return this.$q(function(t,n){i.$http({method:"DELETE",url:i.portalURL+"/"+r+"/items/"+e,headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[channelService] deleteChannelItem ("+r+") -- success"),t()}).catch(function(e){i.$log.warn("[channelService] deleteChannelItem ("+r+") -- failure -- "+e.message),n(e)})})},l.prototype.getChannelUsers=function(r,i){var a=this;return this.$q(function(t,n){var e={};i&&(i.format&&"string"==typeof i.format&&i.format.length&&(e.format=i.format),i.types&&"string"==typeof i.types&&i.types.length&&(e.types=i.types),i.limit&&"number"==typeof i.limit&&0<i.limit&&(e.limit=i.limit),i.offset&&"number"==typeof i.offset&&0<i.offset&&(e.offset=i.offset),i.sortField&&"string"==typeof i.sortField&&i.sortField.length&&(e.sortField=i.sortField),!i.sortOrder||"-1"!==i.sortOrder&&"1"!==i.sortOrder||(e.sortOrder=i.sortOrder)),a.$http({method:"GET",url:a.portalURL+"/"+r+"/users",headers:a.authService.getRequestHeader(),params:e}).then(function(e){a.$log.info("[channelService] getChannelUsers ("+r+") -- success"),t(e.data)}).catch(function(e){a.$log.warn("[channelService] getChannelUsers ("+r+") --  failed"),n(e)})})},l.prototype.searchUsersByName=function(r,e,i){var a=this;return i.displayName=e,this.$q(function(t,n){a.$http({method:"GET",url:a.portalURL+"/"+r+"/users/search",headers:a.authService.getRequestHeader(),params:i}).then(function(e){a.$log.info("[channelService] searchUsersByName ("+r+" -- success"),t(e.data.data)}).catch(function(e){a.$log.warn("[channelService] searchUsersByName ("+r+") -- failure -- "+e.message),n(e)})})},l.prototype.getChannelSuggestions=function(){var r=this;return this.$q(function(t,n){r.findChannels({subscribed:!1,sortField:"users_count",sortOrder:-1,limit:20}).then(function(e){r.$log.info("[channelService] getChannelSuggestions -- success"),t(e)}).catch(function(e){r.$log.warn("[channelService] getChannelSuggestions -- failure -- "+e.message),n(e)})})},l.prototype.usersUpdateHandler=function(e,t,n){var r=this.getChannelFromCache(t);if(null!==n&&(r.users_count+=n.added.length-n.removed.length,r.users.length)){for(var i=0;i<n.added.length;i++)this.contactService.getContactByDBId(n.added[i]).then(function(e){r.users.push(e)});for(i=0;i<n.removed.length;i++)for(var a=r.users.length-1;0<=a;a--)if(r.users[a].dbId===n.removed[i]){r.users.splice(a,1);break}}},l.prototype.retrieveUsers=function(n){var r=this;if(this.$log.info("Retrieving users"),0===n.users.length&&n.userRole===this.USER_ROLE.OWNER){var i,a=this.contactService.userContact;return a.type="owner",this.getChannelUsers(n.id,{format:"full",types:"publisher",limit:19}).then(function(e){return(i=e.data.length?e.data:[]).length<19?r.getChannelUsers(n.id,{format:"full",types:"member",limit:19-i.length}):[]}).then(function(e){i.push.apply(i,e.data);var t=i;return r.usersToContacts(t).then(function(e){return n.users=e,n.users.unshift(a),e})})}return this.$q.resolve(null)},l.prototype.usersToContacts=function(e){if(null!==e){for(var t=[],n=0;n<e.length;n++){var r=this.Contact.create(e[n].jid_im,e[n].firstName,e[n].lastName,e[n].company,e[n].loginEmail);r.dbId=e[n].id,r.lastAvatarUpdateDate=e[n].lastAvatarUpdateDate,r.type=e[n].type||e[n].affiliation,t.push(r.getAvatar())}return this.$q.all(t).then(function(e){return e})}},l.prototype.retrieveMessages=function(a){var o=this;return a.messageRetrieved?this.$q.resolve(null):this.getChannelItems(a.id,100,null,null).then(function(e){a.messages=e;for(var t=[],n=Array.from(new Set(a.messages.map(function(e){return e.from}))),r=0;r<n.length;r++){var i=o.contactService.getOrCreateContact(n[r]);t.push(i)}return o.$q.all(t).then(function(e){for(var t=function(t){a.messages[t].fromDetails=e.find(function(e){return e.id===a.messages[t].from})},n=0;n<a.messages.length;n++)t(n);return a.messageRetrieved=!0,o.$q.resolve(a.messages)})})},l.prototype.retrieveLatests=function(e,t){var n=this;return void 0===e&&(e=null),void 0===t&&(t=null),this.getLatestMessages(10,e,null).then(function(e){return t||n.feedChannel.messages.push.apply(n.feedChannel.messages,e),e.length})},l.prototype.incrementMessagesCounter=function(){this.messageCounter+=1,this.updateNotificationCounter()},l.prototype.decrementMessagesCounter=function(){this.messageCounter-=1,this.updateNotificationCounter()},l.prototype.incrementInvitationCounter=function(){this.invitationCounter+=1,this.updateNotificationCounter()},l.prototype.decrementInvitationCounter=function(){this.invitationCounter-=1,this.updateNotificationCounter()},l.prototype.ackMessages=function(){this.messageCounter=0,this.updateNotificationCounter(),this.feedChannel.messages.forEach(function(e){e.new=!1})},l.prototype.updateNotificationCounter=function(){this.notificationCounter=this.messageCounter+this.invitationCounter,this.notificationCounter<0&&(this.notificationCounter=0),this.$rootScope.$broadcast(this.CHANNEL_NOTIFICATION_NUMBER_UPDATED,this.notificationCounter)},l.prototype.updateChannelCount=function(e,t){var n=this.getChannelFromCache(e);n&&(n.users_count+=t)},l.prototype.removeAllUsersFromChannel=function(r){var i=this;return this.$q(function(t,n){i.$http({method:"DELETE",url:i.portalURL+"/"+r+"/users",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[channelService] Removed all users from channel success"),i.$rootScope.$broadcast(i.CHANNEL_USERS_UPDATE_EVENT,r,null),t(e)}).catch(function(e){i.$log.warn("[channelService] removeAllUsersFromChannel failed"),n(e)})})},l.prototype.updateChannelUsers=function(i,a,o){var s=this;return this.$q(function(n,t){for(var e=[],r=0;r<a.length;r++)e[r]={id:a[r].dbId,type:o};s.$http({method:"PUT",url:s.portalURL+"/"+i+"/users",headers:s.authService.getRequestHeader(),data:{data:e}}).then(function(e){s.$log.info("[channelService] updateChannelUsers success");var t=e.data.data;s.$rootScope.$broadcast(s.CHANNEL_USERS_UPDATE_EVENT,i,t),n(t)}).catch(function(e){s.$log.warn("[channelService] updateChannelUsers failed"),t(e)})})},l.prototype.getPortalInfos=function(){var r=this;return this.$q(function(t,n){r.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/channels/v1.0/about",headers:r.authService.getRequestHeader()}).then(function(e){r.$log.info("[channelService] successfully retrieved portal infos"),t(e.data)}).catch(function(e){r.$log.warn("[channelService] getPortalInfos failed"),n(e)})})},l.prototype.getLatestMessages=function(e,r,i){var a=this;return void 0===r&&(r=null),void 0===i&&(i=null),this.$q(function(t,n){a.$http({method:"GET",url:a.portalURL+"/latest-items",headers:a.authService.getRequestHeader(),params:{max:e,before:r,after:i}}).then(function(e){a.chewReceivedItems(e.data.data.items),t(e.data.data.items)}).catch(function(e){a.$log.warn("[channelService] getLatestMessages -- failure -- "+e.message),n(e)})})},l.prototype.deleteChannelAvatar=function(r){var i=this;return this.$q(function(t,n){i.$http({method:"DELETE",url:i.portalURL+"/"+r+"/avatar",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[channelService] Deleted avatar of channel "+r),t(e)}).catch(function(e){i.$log.warn("[channelService] deleteChannelAvatar failed"),n(e)})})},l.prototype.uploadChannelAvatar=function(i,e,t){var a=this;return this.roomService.resizeImage(e,t,t).then(function(e){var r=a.roomService.getBinaryData(e);return a.$q(function(t,n){a.$http({method:"POST",url:a.portalURL+"/"+i+"/avatar",headers:a.authService.getPostHeader("image/"+r.type),data:r.data,transformRequest:[]}).then(function(e){a.$log.info("[channelService] Upload avatar for channel "+i),t(e)}).catch(function(e){a.$log.warn("[channelService] uploadChannelAvatar failed"),n(e)})})})},l.prototype.acceptInvitation=function(r){var i=this;return this.$q(function(t,n){i.$http({method:"PUT",url:i.portalURL+"/"+r+"/accept",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[channelService] acceptInvitation ("+r+") -- success"),i.decrementInvitationCounter(),t(e)}).catch(function(e){i.$log.warn("[channelService] acceptInvitation -- failure -- "+e.message),n(e)})})},l.prototype.declineInvitation=function(r){var i=this;return this.$q(function(t,n){i.$http({method:"PUT",url:i.portalURL+"/"+r+"/decline",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[channelService] declineInvitation ("+r+") -- success"),i.decrementInvitationCounter(),t(e)}).catch(function(e){i.$log.warn("[channelService] declineInvitation -- failure -- "+e.message),n(e)})})},l.prototype.chewReceivedItems=function(e){e.forEach(function(e){"urn:xmpp:channels:simple"===e.type&&(e.entry={message:e.message},delete e.message)})},l.prototype.updateChannelsList=function(){var t=this;this.channelsList=Object.keys(this.channels).map(function(e){return t.channels[e]})},l.prototype.addChannelToCache=function(e){this.channels[e.id]=e,this.updateChannelsList()},l.PAGE_SIZE=10,l.$inject=["$q","$http","$log","$rootScope","authService","xmppService","contactService","errorHelperService","Channel","roomService","Contact","profileService"],l}();angular.module("rainbow").service("channelService",ChannelService),function(){"use strict";angular.module("rainbow").service("fileTransfertService",["$q","$log","$interval","xmppService","Blob",function(r,f,h,p,u){var v=this;this.started=!1,this.start=function(e){f.info(""),f.info("[fileTransfertService] === STARTING ===");var t=performance.now();this.started=!0,this.fsid=12345,this.chunksize=32768,this.fileTransfertHandler=null,this.fileTransferts={},v.attachHandlers();var n=Math.round(performance.now()-t);return e.push({service:"fileTransfertService",startDuration:n}),f.info("[fileTransfertService] === STARTED ("+n+" ms) ==="),r.when()},this.attachHandlers=function(){p.addFileTransfertHandlers(v.ibbHandler,v.fileHandler)},this.stop=function(){return f.info(""),f.info("[fileTransfertService] === STOPPING ==="),this.started=!1,f.info("[fileTransfertService] === STOPPED ==="),r.when()},this.sendFile=function(e,t,n,r){return f.info('[fileTransfertService] send file "'+e.name+'" ('+e.size+") to "+t),this.readFile(e).then(function(e){return v.transfertFile(r,e,t)})},this.addFileTransfertHandler=function(e){this.fileTransfertHandler=e},this.acceptInvitation=function(e,t,n){var r=this.getFileTransferByIndex(e);r.conversation_id=t,r.message_id=n,p.connection.si_filetransfer.responseOk(r.from,r.transfertId,r.requestId)},this.rejectInvitation=function(e){var t=this.getFileTransferByIndex(e);t&&p.connection.si_filetransfer.responseError(t.from,t.transfertId,t.requestId,403)},this.getFileTransferByIndex=function(e){for(var t in this.fileTransferts)if(this.fileTransferts.hasOwnProperty(t)){var n=this.fileTransferts[t];if(n.index===e)return n}return null},this.readFile=function(i,n){var a=r.defer();f.info('[fileTransfertService] readFile "'+i.name+'"');var e=new FileReader;return e.onload=function(e){f.info('[fileTransfertService] readFile "'+i.name+'" success');var t=e.target.result,n=new Uint8Array(t),r=base64EncArr(n);a.resolve(r)},e.onerror=function(e){f.error('[fileTransfertService] readFile "'+i.name+'" failure'+e.target.error.name),a.reject(new Error("ReadFile failure "+e.target.error.name))},n&&(e.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total;t<1&&n(t)}}),e.readAsArrayBuffer(i),a.promise};var e=function(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<12;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}(),t=0;this.transfertFile=function(s,c,l){var d=r.defer(),u="fsid_"+e+t++;return s.transfertId=u,f.info("[fileTransfertService] transfertFile (id:"+u+")"),s.status=FileTransfert.Status.WAIT,p.connection.si_filetransfer.send(l,u,s.filename,s.filesize,s.filetype,s.message,function(e){if(e)return s.status=FileTransfert.Status.REJECT,s.acceptHandler&&s.acceptHandler(!1),d.reject(new Error("TransfertFile : stream init failure "+e)),d.promise;s.status=FileTransfert.Status.TRANSFER,s.acceptHandler&&s.acceptHandler(!0),f.info("[fileTransfertService] open the connection  (id:"+u+")"),p.connection.ibb.open(l,u,v.chunksize,function(e){if(e)return d.reject(new Error("TransfertFile : open IBB failure "+e)),d.promise;s.progressHandler&&(s.progressSurvey=h(function(){s.progressHandler(s.progressValue),1<=s.progressValue&&(s.progressHandler(1),h.cancel(s.progressSurvey))},300));var t,n=c.length,r=0,i=0,a=0;s.progressValue=0;for(var o=function(e){if(e)return d.reject(new Error("TransfertFile : data IBB failure "+e)),d.promise;a+=1,s.progressValue=a*v.chunksize/c.length};n>=v.chunksize;)f.debug("[fileTransfertService] chunk seq: "+i+" size: "+v.chunksize),t=c.slice(r,r+v.chunksize),p.connection.ibb.data(l,u,i,t,o),n-=v.chunksize,r+=v.chunksize,i+=1;0<n&&(f.debug("[fileTransfertService] last chunk seq: "+i+" size: "+n),t=c.slice(r,r+n),p.connection.ibb.data(l,u,i,t,function(e){if(e)return d.reject(new Error("TransfertFile : last chunck data IBB failure "+e)),d.promise;s.progressValue=1,h.cancel(s.progressSurvey)})),s.status=FileTransfert.Status.FINISH,p.connection.ibb.close(l,u,function(e){s.progressValue=1,h.cancel(s.progressSurvey),s.progressHandler(1),f.debug("[fileTransfertService] close IBB success  (id:"+u+")"),d.resolve()})})}),d.promise},this.ibbHandler=function(e,t,n,r,i,a){var o=v.fileTransferts[n];switch(e){case"open":o.buffer="",o.status=FileTransfert.Status.TRANSFER,o.progressValue=0,o.progressHandler&&(o.progressSurvey=h(function(){o.progressHandler(o.progressValue),1<=o.progressValue&&h.cancel(o.progressSurvey)},300));break;case"data":o.buffer+=r,o.progressValue=i*v.chunksize/o.filesize;break;case"close":o.status=FileTransfert.Status.FINISH,o.progressHandler(1);var s=base64DecToArr(o.buffer);s.length===parseInt(o.filesize,10)?f.info("file is OK"):f.info("file has wrong length");var c=new u([s],{type:"application/octet-stream"}),l={data:c,filename:o.filename,conversation_id:o.conversation_id,message_id:o.message_id,transfert_id:o.transfertId};if(config.chromeApp){var d=function(){f.error("cmlsdfjlmkdfjgmdfksjgdfslmkghkfjhggsfk")};chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:o.filename},function(e){e.createWriter(function(e){e.onerror=d,e.onwriteend=function(){f.log("write complete")},f.error("writedoc"),e.write(c)},d)})}else v.saveAs(l);delete v.fileTransferts[n];break;default:throw new Error("shouldn't be here.")}},this.fileHandler=function(e,t,n,r,i,a,o){var s=new FileTransfert(e,t,n,r,i,a,o);v.fileTransferts[t]=s,v.fileTransfertHandler&&v.fileTransfertHandler(s)}}])}(),angular.module("rainbow").service("companyService",["$q","$log","$http","$rootScope","authService","errorHelperService","userInfoService","Company",function(r,s,c,a,l,d,o,u){"use strict";var f=this;f.start=function(e){s.info(""),s.info("[companyService] === STARTING ===");var t=performance.now();f.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",f.companies={};var n=Math.round(performance.now()-t);return e.push({service:"companyService",startDuration:n}),s.info("[companyService] === STARTED ("+n+" ms) ==="),a.$on("$destroy",a.$on("ON_COMPANY_CHANGE_EVENT",function(e,t){f.getCompanyById(t,!0)})),r.when()},f.stop=function(){return s.info(""),s.info("[companyService] === STOPPING ==="),s.info("[companyService] === STOPPED ==="),f.companies={},r.when()},f.searchCompanies=function(i,t,a,o){return r(function(r,n){var e=f.portalURL+"companies?name="+i+"&format=full";null!=t&&(e+="&hasBP="+t),null!=a&&(e+="&isBP="+a),o&&(e+="&bpType="+o),c({method:"GET",url:e,headers:l.getRequestHeader()}).then(function(e){var t=e.data.data,n=[];angular.forEach(t,function(e){if("Default"!==e.name&&"Rainbow"!==e.name&&"active"===e.status){var t=f.companies[e.id];t||(t=u.createFromData(e),f.companies[t.id]=t,f.getCompanyLogo(t)),n.push(t)}}),s.info("[companyService] searchCompanies with criteria '"+i+"' - success - found "+t.length+" companies : returns "+n.length+" companies"),r(n)},function(e){var t=d.handleError(e);s.error("[companyService] "+d.getErrorFullMessage(e,"searchCompanies")),n(t)})})},f.getCompanyById=function(a,e){return r(function(n,r){if(!a)return s.error("[companyService] getCompanyById -- missing companyId"),void r(new Error("[companyService] getCompanyById -- missing companyId"));var i=f.companies[a];i&&!e?(s.info("[companyService] getCompanyById (cache) "+a+" - success"),n(i)):c({method:"GET",url:f.portalURL+"companies/"+a,headers:l.getRequestHeader()}).then(function(e){var t=e.data.data;i?(i.updateFromData(t),s.info("[companyService] getCompanyById (update) "+a+" - success")):(i=u.createFromData(t),f.companies[i.id]=i,s.info("[companyService] getCompanyById "+a+" - success")),f.getCompanyLogo(i),f.getCompanyBanner(i),n(i)},function(e){var t=d.handleError(e);s.error("[companyService] "+d.getErrorFullMessage(e,"getCompanyById")),r(t)})})},f.getAdministratorIds=function(t){return r(function(r,n){var e=f.portalURL+"companies/"+t+"/administrators";c({method:"GET",url:e,headers:l.getRequestHeader()}).then(function(e){var t=e.data.data,n=[];t.forEach(function(e){n.push(e.id)}),s.info("[companyService] getAdministratorIds success)"),r(n)},function(e){var t=d.handleError(e);s.error("[companyService] "+d.getErrorFullMessage(e,"getAdministratorIds")),n(t)})})},f.getCompanyLogo=function(i){return r(function(t,n){var e=o.computeUserColor(i.name),r=i.name.substr(0,1);o.getAvatarImage(i.id,r,e.color,130,i.lastAvatarUpdateDate).then(function(e){i.logo=e,a.$broadcast("ON_COMPANY_LOGO_UPDATED",i.id),s.info("[companyService] getCompanyLogo - "+i.name+" - success"),t(e)}).catch(function(e){s.error("[companyService] getCompanyLogo - failure - "+e.message),n(e)})})},f.getCompanyBanner=function(i){return r(function(t){var e=new Image;if(i.lastBannerUpdateDate){var n=config.webservices.protocol+"://"+config.webservices.currentServer;a.cdn&&(n=a.cdnServer);var r=n+"/api/banner/"+i.id+"?size=831";r+="&update="+MD5.hexdigest(i.lastBannerUpdateDate),e.onload=function(){var e=this;a.$apply(function(){i.banner=e,a.$broadcast("ON_COMPANY_BANNER_UPDATED",i.id),s.log("[companyService] Load banner for "+i.name+" success"),t(e)})},e.onerror=function(){a.$apply(function(){s.warn("[companyService] Load banner for "+i.name+" failure"),t(null)})},e.src=r}else e.src="/cache/company-banner-01.svg",i.banner=e,a.$broadcast("ON_COMPANY_BANNER_UPDATED",i.id),s.log("[companyService] Load default banner for "+i.name+" success"),t(e)})}}]),function(){"use strict";angular.module("rainbow").service("browserService",[function(){this.extractBrowserVersion=function(e,t,n){var r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}}])}(),angular.module("rainbow").service("gRTCStatsService",[function(){"use strict";var v={};this.resetStatsForAllCalls=function(){v={}},this.resetStatsForCall=function(e){e in v&&delete v[e]},this.getCalls=function(){return v},this.nbCalls=function(){return Object.keys(v).length},this.hasStatsForCall=function(e){return e in v},this.addStreamToCall=function(e,t){e in v||(v[e]={});var n=v[e];n[t.id]={},n[t.id].stream=t},this.nbStreamsInACall=function(e){return e in v?Object.keys(v[e]).length:0},this.getBundlePolicyForCall=function(e){if(!(e in v))return"unknown";var t=v[e],n=0,r=this.nbStreamsInACall(e);for(var i in t)"selectedCandidatePairId"in t[i].stream&&n++;if(4===r)switch(n){case 0:return"failed";case 1:return"max-bundle";case 2:return"balanced";case 4:return"max-compat";default:return"unknown"}else{if(2!==r)return"unknown";switch(n){case 0:return"failed";case 1:return"max-bundle";case 2:return"max-compat";default:return"unknown"}}},this.addSSRCToStream=function(e,t){var n,r=null;"ssrc"===t.type&&e in v&&(n=v[e],t.transportId in n&&((r=n[t.transportId]).ssrc||(r.ssrc={}),r.ssrc[t.ssrc]=t))},this.hasSSRCInStream=function(e,t,n){var r,i;return e in v&&(t in(r=v[e])&&(!!(i=r[t]).ssrc&&n in i.ssrc))},this.getSSRCMediaType=function(e,t,n){var r,i;return e in v&&t in(r=v[e])&&(i=r[t]).ssrc&&n in i.ssrc?i.ssrc[n].mediaType:"unknown"},this.getSSRCDirection=function(e,t,n){var r,i,a;return e in v&&t in(r=v[e])&&(i=r[t]).ssrc&&n in i.ssrc?(a=i.ssrc[n],o(a.id)):"unknown"},this.getSSRCAudioCodecName=function(e,t,n){var r,i;return e in v&&t in(r=v[e])&&(i=r[t]).ssrc&&n in i.ssrc?i.ssrc[n].googCodecName:"unknown"},this.isSSRCFlowing=function(e,t,n){var r,i,a;if(!(e in v))return!1;if(!(t in(r=v[e])))return!1;if(!(i=r[t]).ssrc)return!1;if(!(n in i.ssrc))return!1;a=i.ssrc[n];return 0<("IN"===o(a.id)?parseInt(a.bytesReceived,10):parseInt(a.bytesSent,10))},this.getStreamsDetailsFromCall=function(e){var t=null,n=null;if(!(e in v))return[];t=v[e];var r=[];for(var i in t)if(t.hasOwnProperty(i)){n=t[i];var a="no",o="no",s=!1,c=!1,l=!1,d=!1;for(var u in n.ssrc)if(n.ssrc&&n.ssrc.hasOwnProperty&&n.ssrc.hasOwnProperty(u)){var f=this.getSSRCMediaType(e,i,u),h=this.getSSRCDirection(e,i,u),p=this.isSSRCFlowing(e,i,u);"audio"===f&&"IN"===h&&p?s=!0:"audio"===f&&"OUT"===h&&p?l=!0:"video"===f&&"IN"===h&&p?c=!0:"video"===f&&"OUT"===h&&p&&(d=!0)}s&&l?a="IN|OUT":s?a="IN":l&&(a="OUT"),c&&d?o="IN|OUT":c?o="IN":d&&(o="OUT"),s||l||c||d?r.push({id:i,streams:{audio:a,video:o}}):r.push({id:i,streams:{}})}return r},this.getCodecDetailsFromCall=function(e){var t=null,n=null,r="-",i="-",a={codec:{audio:r,video:i}};if(!(e in v))return a;for(var o in t=v[e])if(t.hasOwnProperty(o))for(var s in(n=t[o]).ssrc)"audio"===n.ssrc[s].mediaType&&(r=this.getSSRCAudioCodecName(e,o,s)),"video"===n.ssrc[s].mediaType&&(i=this.getSSRCAudioCodecName(e,o,s));return a.codec.audio=r,a.codec.video=i,a};var o=function(e){return-1<e.indexOf("recv")?"IN":"OUT"}}]),angular.module("rainbow").service("fRTCStatsService",[function(){"use strict";var o={};this.getCalls=function(){return o},this.nbCalls=function(){return Object.keys(o).length},this.addStreamToCall=function(e,t){if(!t.isRemote){e in o||(o[e]={});var n=o[e];n.streams||(n.streams={}),n.streams[t.id]={},n.streams[t.id]=t}},this.nbStreamsInACall=function(e){return e in o?Object.keys(o[e].streams).length:0},this.resetStatsForAllCalls=function(){o={}},this.resetStatsForCall=function(e){e in o&&delete o[e]},this.hasStatsForCall=function(e){return e in o},this.hasSSRCInStream=function(e,t,n){var r;return e in o&&(!!(r=o[e]).streams&&(t in r.streams&&r.streams[t].ssrc===n))},this.hasStreamInCall=function(e,t){return e in o&&t in o[e].streams},this.getSSRCMediaType=function(e,t){var n;return e in o&&t in(n=o[e]).streams?n.streams[t].mediaType:"unknown"},this.getStreamsDetailsFromCall=function(e){var t=null;if(!(e in o))return[];t=o[e];var n=[];for(var r in t.streams)if(t.streams.hasOwnProperty(r)){var i=this.getSSRCMediaType(e,r),a=s(r);"audio"===i?n.push({id:r,streams:{audio:a}}):"video"===i&&n.push({id:r,streams:{video:a}})}return n},this.addCandidatePairToCall=function(e,t){var n=null,r=!1;if(e in o){(n=o[e]).candidatesPairs||(n.candidatesPairs=[]);for(var i=0;i<n.candidatesPairs.length;i++)if(n.candidatesPairs[i].id===t.id){r=!0;break}!r&&"succeeded"===t.state&&t.selected&&n.candidatesPairs.push(t)}},this.getNbCandidatePairs=function(e){var t,n=0;return e in o&&(t=o[e]).candidatesPairs&&(n=t.candidatesPairs.length),n},this.getBundlePolicyForCall=function(e){var t="unknown";if(!(e in o))return t;switch(this.getNbCandidatePairs(e)){case 0:t="failed";break;case 1:t="max-bundle";break;case 2:t=2<this.nbStreamsInACall(e)?"balanced":"max-compat";break;default:t="max-compat"}return t};var s=function(e){return-1<e.indexOf("inbound")?"IN":"OUT"}}]),angular.module("rainbow").service("platformService",["$log","$rootScope","$window","$interval","settingsService","$q","$filter","$http","authService","errorHelperService",function(o,s,e,a,c,l,i,t,n,d){"use strict";var u=this,f=[];u.$q=l,this.isWin=0<=navigator.platform.toUpperCase().indexOf("WIN"),u.start=function(i){return l(function(e,t){var n=performance.now();o.info(""),o.info("[platformService] === STARTING ==="),u.languages=["en","fr","es","de","it"],f.push(s.$on("$translateChangeSuccess",function(){u.fixDeviceLabels()})),f.push(s.$on("ON_INPUT_DEVICE_CHANGED_EVENT",C)),f.push(s.$on("ON_OUTPUT_DEVICE_CHANGED_EVENT",b)),f.push(s.$on("ON_CONNECTION_STATE_CHANGE_EVENT",u.onAuthenticationStatusChangedEvent)),u.isAskingMedia=!1,u.hasAudioPermission=!1,u.hasVideoPermission=!1,u.stopWatcher(),a(u.startWatcher,2e3,1);var r=Math.round(performance.now()-n);i.push({service:"platformService",startDuration:r}),o.info("[platformService] === STARTED ("+r+" ms) ==="),e()})},u.stop=function(){return o.info("[platformService] === STOPPING ==="),f.forEach(function(e){e()}),u.stopWatcher(),this.mediaDevicesLength=0,this.mediaDevices=[],o.info("[platformService] === STOPPED ==="),l.when()},u.onAuthenticationStatusChangedEvent=function(e,t){"connected"===t&&(!u.allowDevicesManagement()||!angular.element("#globalAudioTag")[0]||angular.element("#globalAudioTag")[0].sinkId&&"default"!==angular.element("#globalAudioTag")[0].sinkId||(o.info("[platformService] onAuthenticationStatusChangedEvent -- update global audio tag"),u.getCurrentSpeaker().then(function(e){e&&e.id&&y(e.id)})),u.testGetUserMedia())},this.audioDevices=0,this.videoDevices=0,this.detectRTCLoaded=function(){u.hasAudioPermission=DetectRTC.isWebsiteHasMicrophonePermissions,u.hasVideoPermission=DetectRTC.isWebsiteHasWebcamPermissions,u.fixDeviceLabels();var e=!1,t=!1,n=u.shouldAskGetUserMedia();(DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length||DetectRTC.audioOutputDevices&&DetectRTC.audioOutputDevices.length)&&(!u.hasAudioPermission||n.audio?e=!0:h=!0),DetectRTC.videoInputDevices&&DetectRTC.videoInputDevices.length&&(!u.hasVideoPermission||n.video?t=!0:r=!0),e||t?u.isAskingMedia||(u.isAskingMedia=!0,u.getUserMedia(e,t)):(u.fixDeviceLabels(),w().then(function(){u.isDesktop()&&u.updateNewDesktopDevicesIds(),E(),u.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(u.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,u.audioMediaDeviceUpdated()),u.videoDevices!==DetectRTC.videoInputDevices.length&&(u.videoDevices=DetectRTC.videoInputDevices.length,u.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,function(e){e&&o.info("[PlatformService] DetectRTC.MediaDevices device "+e.id+" with kind "+e.kind+" with label "+e.label)}),u.getCurrentSpeaker().then(function(e){y(e.id)}),u.newDevice&&u.checkAndUpdateHandFreeProfile(),u.startWatcher()}))},this.testGetUserMedia=function(){if(u.hasAudioPermission){var r=performance.now();u.getCurrentMicrophone().then(function(e){var t={},n="default";e?(t.audio={optional:[{sourceId:e.id}]},n="id - "+e.id+" and label "+e.label):t.audio=!0,o.info("[PlatformService] testGetUserMedia -- getUserMedia for Mic "+n),navigator.mediaDevices.getUserMedia(t).then(function(e){var t=Math.round(performance.now()-r);o.info("[PlatformService] testGetUserMedia -- getUserMedia success for time : "+t+" ms"),angular.forEach(e.getTracks(),function(e){o.info("[PlatformService] testGetUserMedia mediaStreamTrack -- "+e.label),e.stop()}),u.isAskingMedia=!1}).catch(function(e){o.info("[PlatformService] testGetUserMedia -- getUserMedia error "+e),u.isAskingMedia=!1})})}else o.info("[PlatformService] testGetUserMedia -- no audio permission given")},this.shouldAskGetUserMedia=function(){var t={audio:!1,video:!1};return angular.forEach(DetectRTC.MediaDevices,function(e){e&&e.label&&-1!==e.label.indexOf("invoke getUserMedia")&&("audioinput"===e.kind||"audiooutput"===e.kind?t.audio=!0:t.video=!0)}),o.info("[platformService] shouldAskGetUserMedia : audio "+t.audio+" and video "+t.video),t},this.updateNewDesktopDevicesIds=function(){var t=c.getSetting("handFreeInputDeviceName"),n=c.getSetting("handFreeOutputDeviceName"),r=c.getSetting("headsetDeviceName"),i=c.getSetting("customMicrophoneName"),a=c.getSetting("customSpeakerName");(t||n||r||i||a)&&angular.forEach(DetectRTC.MediaDevices,function(e){"audioinput"===e.kind?(e.normalizedLabel===r&&c.setSetting("headsetMicrophone",e.id),e.normalizedLabel===t&&c.setSetting("microphone",e.id),e.normalizedLabel===i&&c.setSetting("customMicrophone",e.id)):"audiooutput"===e.kind&&(e.normalizedLabel===r&&c.setSetting("headsetSpeaker",e.id),e.normalizedLabel===n&&c.setSetting("speaker",e.id),e.normalizedLabel===a&&c.setSetting("customSpeaker",e.id))})},this.mediaDevicesLength=0,this.mediaDevices=[],this.newDevice=null,this.devicesWatcher=function(){navigator.mediaDevices.enumerateDevices().then(function(e){(u.mediaDevicesLength!==e.length||u.checkForIdChange(e))&&(o.debug("[platformService] MediaDevices count changed ! from "+u.mediaDevicesLength+" to "+e.length),o.debug("[platformService] MediaDevices brut devices list "+JSON.stringify(e)),e.length-u.mediaDevicesLength==1?u.newDevice=u.getNewDevice(u.mediaDevices,e):u.newDevice=null,u.mediaDevicesLength=e.length,u.mediaDevices=e,u.stopWatcher(),DetectRTC.load(u.detectRTCLoaded))})},u.checkAndUpdateHandFreeProfile=function(){o.info("[platformService] checkAndUpdateHandFreeProfile");var e=u.getActiveAudioProfile();1===e.key&&!0===e.available&&u.getCurrentSpeaker().then(function(e){e&&e.groupId===u.newDevice.groupId&&(o.info("[platformService] checkAndUpdateHandFreeProfile -- should update the Jack Mic"),s.$broadcast("ON_HANDFREE_JACK_MICROPHONE_EVENT",u.newDevice))})},u.checkForIdChange=function(r){var i=!1;return u.mediaDevices.length&&angular.forEach(u.mediaDevices,function(e){if("default"!==e.deviceId&&"communications"!==e.deviceId){for(var t=!1,n=0;n<r.length;n++)e.deviceId===r[n].deviceId&&(t=!0);t||(i=!0)}}),i&&o.info("[platformService] checkForIdChange "+i),i},u.getNewDevice=function(r,e){var i=null;return e.length&&angular.forEach(e,function(e){if("default"!==e.deviceId&&"communications"!==e.deviceId){for(var t=!1,n=0;n<r.length;n++)e.deviceId===r[n].deviceId&&(t=!0);t||"audioinput"!==e.kind||(i=e)}}),i},u.tryToGetUserMediaForEachDevice=function(){if(o.info("[platformService] tryToGetUserMediaForEachDevice"),DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length){for(var n=l.when(),e=0;e<DetectRTC.audioInputDevices.length;e++)!function(e){var t=DetectRTC.audioInputDevices[e];n=n.then(function(){return u.getUserMediaForAudioDevice(t.id)})}(e);n=n.finally(function(){if(o.info("[platformService] tryToGetUserMediaForEachDevice finally -- has audio permission "+u.hasAudioPermission),u.hasAudioPermission)u.loadDetectRTC();else{r=h=!1,u.isAskingMedia=!1;s.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"devicePermission",okLabel:"ok"}),u.startWatcher()}})}},u.getUserMediaForAudioDevice=function(n){return l(function(t){if(u.hasAudioPermission)return o.info("[platformService] getUserMediaForAudioDevice for id: "+n+" no longer needed !"),void t();if(!n)return o.info("[platformService] getUserMediaForAudioDevice missing id !"),void t();o.info("[platformService] getUserMediaForAudioDevice for id: "+n);var e={};e.audio={optional:[{sourceId:n}]},navigator.mediaDevices.getUserMedia(e).then(function(e){o.info("[platformService] getUserMediaForAudioDevice for id: "+n+" success"),angular.forEach(e.getAudioTracks(),function(e){e.stop()}),u.hasAudioPermission=!0,h=!0,u.hasVideoPermission=!0,r=!0,t()}).catch(function(e){o.info("[platformService] getUserMediaForAudioDevice for id: "+n+" failed with error "+e),t()})})},u.getUserMedia=function(t,n){o.info("[platformService] getUserMedia audio: "+t+" and video: "+n),navigator.mediaDevices.getUserMedia({audio:t,video:n}).then(function(e){o.info("[platformService] getUserMedia audio: "+t+" and video: "+n+" -- success!"),angular.forEach(e.getAudioTracks(),function(e){e.stop()}),angular.forEach(e.getVideoTracks(),function(e){e.stop()}),t&&(u.hasAudioPermission=!0,h=!0),n&&(u.hasVideoPermission=!0,r=!0),e=null,u.loadDetectRTC()}).catch(function(e){o.error("[platformService] getUserMedia -- error -- "+e),u.tryToGetUserMediaForEachDevice()})},u.loadDetectRTC=function(){DetectRTC.load(function(){u.fixDeviceLabels(),w().then(function(){u.isDesktop()&&u.updateNewDesktopDevicesIds(),E(),u.isAskingMedia=!1,u.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(u.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,u.audioMediaDeviceUpdated()),u.videoDevices!==DetectRTC.videoInputDevices.length&&(u.videoDevices=DetectRTC.videoInputDevices.length,u.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,function(e){e&&o.info("[PlatformService] DetectRTC.MediaDevices device "+e.id+" with kind "+e.kind+" with label "+e.label)}),u.getCurrentSpeaker().then(function(e){y(e.id)}),u.startWatcher()})})},u.getWhatsNew=function(){return l(function(r){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/settings/changelogs";t({method:"GET",url:e,headers:n.getRequestHeader()}).then(function(e){o.info("[adminPlatformService] getWhatsNew -- success");var t=e.data.data.changeLog.split("§%§"),n={};t.forEach(function(e,t){n[u.languages[t]]=e}),Object.keys(n).forEach(function(e){0===n[e].length&&(n[e]=n.en)}),n.en||(n={en:"",fr:"",es:"",de:"",it:""}),r(n)},function(e){r({en:"",fr:"",es:"",de:"",it:""}),o.error("[adminPlatformService] "+d.getErrorFullMessage(e,"getWhatsNew"))})})},u.getAvailableLanguage=function(e){var t=e.split("-")[0],n=u.languages.find(function(e){return e===t});return n||"en"},this.isDesktop=function(){return 0<=navigator.userAgent.indexOf(" Rainbow/")};var r=!(this.allowDevicesManagement=function(){return e.chrome||this.isDesktop()}),h=!(this.isWebsiteHasWebcamPermissions=function(){return!!u.allowDevicesManagement()&&r}),p={HANDFREE:{key:1,value:"handfree",available:!(this.isWebsiteHasMicrophonePermissions=function(){return!!u.allowDevicesManagement()&&h})},HEADSET:{key:2,value:"headset",available:!1},SPEAKERPHONE:{key:3,value:"speakerphone",available:!1},CUSTOM:{key:4,value:"custom",available:!1}};this.audioProfileEnum=p,this.getAudioProfiles=function(){return p},this.currentAudioProfile=p.HANDFREE,this.getCurrentAudioProfile=function(){var e=null;switch(c.getSetting("audioProfile")){case p.HEADSET.value:e=p.HEADSET;break;case p.HANDFREE.value:e=p.HANDFREE;break;case p.SPEAKERPHONE.value:e=p.SPEAKERPHONE;break;case p.CUSTOM.value:e=p.CUSTOM;break;default:e=p.HANDFREE,c.setSetting("audioProfile",e.value)}return e},this.getActiveAudioProfile=function(){var e=this.getCurrentAudioProfile();return e.key===p.HANDFREE.key||e.available?e:p.HANDFREE},this.setCurrentAudioProfile=function(e){e&&(u.currentAudioProfile=e)},this.isHandfreeAvailable=function(){return u.isHandfreeMicrophoneAvailable()&&u.isHandfreeSpeakerAvailable()},this.isHeadsetAvailable=function(){return u.isHeadsetMicrophoneAvailable()&&u.isHeadsetSpeakerAvailable()},this.isSpeakerphoneAvailable=function(){return u.isSpeakerphoneMicrophoneAvailable()&&u.isSpeakerphoneSpeakerAvailable()},this.isCustomAvailable=function(){return u.isCustomMicrophoneAvailable()&&u.isCustomSpeakerAvailable()},this.getCurrentMicrophone=function(){if("sdk"===c.getSetting("apiMode")){var e=u.getMicrophoneForSDK();if(e)return e}switch(u.getActiveAudioProfile()){case p.SPEAKERPHONE:return u.getSpeakerphoneMicrophone();case p.CUSTOM:return u.getCustomMicrophone();case p.HEADSET:return u.getHeadsetMicrophone();default:return u.getHandfreeMicrophone()}},this.getMicrophoneForSDK=function(){var t=l.defer();return u.getMicrophones().then(function(e){t.resolve(u.getDeviceWithId(e,c.getSetting("microphone")))}),t.promise},this.getSecondRingerStatusFromSettings=function(){return c.getSetting("hasSecondRinger")},this.setSecondRingerStatusFromSettings=function(e){return c.setSetting("hasSecondRinger",e)},this.getHandfreeMicrophoneFromSettings=function(){return c.getSetting("microphone")},this.getHandfreeMicrophone=function(){var t=l.defer();return u.getMicrophones().then(function(e){t.resolve(u.getDeviceWithId(e,u.getHandfreeMicrophoneFromSettings()))}),t.promise},this.getHeadsetMicrophoneFromSettings=function(){return c.getSetting("headsetMicrophone")},this.getHeadsetMicrophone=function(){var t=l.defer();return u.getMicrophones().then(function(e){t.resolve(u.getDeviceWithId(e,u.getHeadsetMicrophoneFromSettings()))}),t.promise},this.getHeadsetDeviceName=function(){var e=l.defer();return e.resolve(c.getSetting("headsetDeviceName")),e.promise},this.getSpeakerphoneMicrophoneFromSettings=function(){return c.getSetting("speakerphoneMicrophone")},this.getSpeakerphoneMicrophone=function(){var t=l.defer();return u.getMicrophones().then(function(e){t.resolve(u.getDeviceWithId(e,u.getSpeakerphoneMicrophoneFromSettings()))}),t.promise},this.getSpeakerphoneDeviceName=function(){var e=l.defer();return e.resolve(c.getSetting("speakerphoneDeviceName")),e.promise},this.getCustomMicrophoneFromSettings=function(){return c.getSetting("customMicrophone")},this.getCustomMicrophone=function(){var t=l.defer();return u.getMicrophones().then(function(e){t.resolve(u.getDeviceWithId(e,u.getCustomMicrophoneFromSettings()))}),t.promise},this.getMicrophones=function(){var t=l.defer();return this.allowDevicesManagement()||t.resolve([]),u.getAudioInputDevices().then(function(e){t.resolve(e&&e.constructor===Array&&h?e:[])}).catch(function(e){return o.info("[PlatformService] === SERVICES FAILURE === : "+e.message),t.reject(e),t.promise}),t.promise},this.isHandfreeMicrophoneAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getHandfreeMicrophoneFromSettings(),"audioinput")},this.isHeadsetMicrophoneAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getHeadsetMicrophoneFromSettings(),"audioinput")},this.isSpeakerphoneMicrophoneAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getSpeakerphoneMicrophoneFromSettings(),"audioinput")},this.isCustomMicrophoneAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getCustomMicrophoneFromSettings(),"audioinput")},this.getCurrentSpeaker=function(){if("sdk"===c.getSetting("apiMode")){var e=u.getSpeakerForSDK();if(e)return e}switch(u.getActiveAudioProfile()){case p.SPEAKERPHONE:return u.getSpeakerphoneSpeaker();case p.CUSTOM:return u.getCustomSpeaker();case p.HEADSET:return u.getHeadsetSpeaker();default:return u.getHandfreeSpeaker()}},this.getSpeakerForSDK=function(){var t=l.defer();return u.getSpeakers().then(function(e){t.resolve(u.getDeviceWithId(e,c.getSetting("speaker")))}),t.promise},this.getHandfreeSpeakerFromSettings=function(){return c.getSetting("speaker")},this.getHandfreeSpeaker=function(){var t=l.defer();return u.getSpeakers().then(function(e){t.resolve(u.getDeviceWithId(e,u.getHandfreeSpeakerFromSettings(),!0))}),t.promise},this.getHeadsetSpeakerFromSettings=function(){return c.getSetting("headsetSpeaker")},this.getHeadsetSpeaker=function(){var t=l.defer();return u.getSpeakers().then(function(e){t.resolve(u.getDeviceWithId(e,u.getHeadsetSpeakerFromSettings()))}),t.promise},this.getSpeakerphoneSpeakerFromSettings=function(){return c.getSetting("speakerphoneSpeaker")},this.getSpeakerphoneSpeaker=function(){var t=l.defer();return u.getSpeakers().then(function(e){t.resolve(u.getDeviceWithId(e,u.getSpeakerphoneSpeakerFromSettings()))}),t.promise},this.getCustomSpeakerFromSettings=function(){return c.getSetting("customSpeaker")},this.getCustomSpeaker=function(){var t=l.defer();return u.getSpeakers().then(function(e){t.resolve(u.getDeviceWithId(e,u.getCustomSpeakerFromSettings()))}),t.promise},this.getRingingSpeakerFromSettings=function(){return c.getSetting("ringingSpeaker")},this.getRingingSpeaker=function(){var t=l.defer();return u.getSpeakers().then(function(e){t.resolve(u.getDeviceWithId(e,u.getRingingSpeakerFromSettings()))}),t.promise},this.setSpeakerForElement=function(e,t){var n=l.defer();if(!e||!e.setSinkId)return o.warn("[platformService] setSpeakerForElement -- missing element"),l.when();if(this.allowDevicesManagement()){if(t===e.sinkId)return l.when();e.id&&o.log("[platformService] setSpeakerForElement "+e.id+" with "+t),e.setSinkId(t).then(function(){o.log("[platformService] Success, audio output device attached: "+t),angular.element("#globalAudioTag")[0]&&o.log("[platformService] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),n.resolve()}).catch(function(e){var t=e;"SecurityError"===e.name&&(t="[platformService] You need to use HTTPS for selecting audio output device: "+e),o.error("[platformService] "+t),n.resolve()})}else o.warn("[platformService] Browser does not support output device selection."),n.resolve();return n.promise},this.getSpeakers=function(){var t=l.defer();return u.allowDevicesManagement()||t.resolve([]),u.getAudioOutputDevices().then(function(e){t.resolve(e&&e.constructor===Array&&h?e:[])}).catch(function(e){return o.info("[PlatformService] === SERVICES FAILURE === : "+e.message),t.reject(e),t.promise}),t.promise};var v=!(this.isHandfreeSpeakerAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getHandfreeSpeakerFromSettings(),"audiooutput")});this.isHeadsetSpeakerAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getHeadsetSpeakerFromSettings(),"audiooutput")};var m=null;var g=!(this.isSpeakerphoneSpeakerAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getSpeakerphoneSpeakerFromSettings(),"audiooutput")});var S=!(this.isCustomSpeakerAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getCustomSpeakerFromSettings(),"audiooutput")});function C(){E(),u.isAskingMedia?o.info("[PlatformService] onAudioInputChange -- already asking media -- ignore"):(u.isAskingMedia=!0,a(u.testGetUserMedia,2e3,1))}function E(){var e,t,n,r;e=u.isHandfreeAvailable(),v!==e&&(o.info("[PlatformService] Handfree is now "+(e?"available":"unavailable")),v=e,p.HANDFREE.available=e,s.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",e),s.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),e||u.getCurrentSpeaker().then(function(e){y(e.id)})),t=u.isHeadsetAvailable(),m!==t&&(o.info("[PlatformService] Headset is now "+(t?"available":"unavailable")),m=t,(p.HEADSET.available=t)?c.getSetting("audioProfile")===p.HANDFREE.value&&(c.setSetting("audioProfile",p.HEADSET.value),u.getCurrentSpeaker().then(function(e){y(e.id)})):(c.getSetting("audioProfile")===p.HEADSET.value&&c.setSetting("audioProfile",p.HANDFREE.value),u.getCurrentSpeaker().then(function(e){y(e.id)})),s.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",t),s.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT")),n=u.isSpeakerphoneAvailable(),g!==n&&(o.info("[PlatformService] Speakerphone is now "+(n?"available":"unavailable")),g=n,p.SPEAKERPHONE.available=n,s.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",n),s.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),n||u.getCurrentSpeaker().then(function(e){y(e.id)})),r=u.isCustomAvailable(),S!==r&&(o.info("[PlatformService] Custom is now "+(r?"available":"unavailable")),S=r,p.CUSTOM.available=r,s.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",r),s.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),r||u.getCurrentSpeaker().then(function(e){y(e.id)}))}function b(e,t){E(),o.info("[PlatformService] updateOutputDevice "+t),u.allowDevicesManagement()&&t&&y(t)}var R="";function y(e){o.info("[PlatformService] updateCurrentOutputDevice "+e),angular.element("#globalAudioTag")[0]&&angular.element("#globalAudioTag")[0].sinkId!==e&&R!==e?(R=e,o.info("[PlatformService] updateCurrentOutputDevice current ID "+angular.element("#globalAudioTag")[0].sinkId+" new id "+e),u.setSpeakerForElement(angular.element("#globalAudioTag")[0],"default").then(function(){u.setSpeakerForElement(angular.element("#globalAudioTag")[0],e),R=""}).catch(function(){R=""})):o.info("[PlatformService] updateCurrentOutputDevice -- ignored ")}var T=[],I=[],N=[],A=[],O=[],D=!0,P=["realtek","soundmax","high definition audio","nomachine"];u.arrayContains=function(e,t){return e.some(function(e){return-1<t.indexOf(e)})},u.getDeviceType=function(e){return e=e.toLowerCase(),u.arrayContains(P,e)?p.HANDFREE:p.HEADSET},this.normalizeAnyLabel=function(e){return e?("default"===e.id||"communications"===e.id||e.normalizedLabel||(u.isWin?e.normalizedLabel=e.label.substring(e.label.indexOf("(")+1,e.label.indexOf(")")):e.normalizedLabel=e.label),e):null};var w=function(){var a=l.defer();return u.getMicrophones().then(function(e){return T=e,u.getSpeakers()}).then(function(e){I=e;var r=[];angular.forEach(T,function(n){"default"!==n.id&&"communications"!==n.id&&(n=u.normalizeAnyLabel(n),r.some(function(e){return e.microphone.normalizedLabel===n.normalizedLabel})||angular.forEach(I,function(e){if(e=u.normalizeAnyLabel(e),n.normalizedLabel===e.normalizedLabel&&u.getDeviceType(n.normalizedLabel)===p.HEADSET){var t={label:n.normalizedLabel,microphone:n,speaker:e};r.push(t),D&&N.push(t)}}))});var t=c.getSetting("headsetDeviceName");t&&"null"!==t||!r.length||(t=r[0].label,c.setSetting("headsetDeviceName",r[0].label),c.setSetting("headsetMicrophone",r[0].microphone.id),c.setSetting("headsetSpeaker",r[0].speaker.id));var n=[];D||(angular.forEach(r,function(t){A.some(function(e){return e.label===t.label})||(n.push(t),N.push(t))}),0<n.length&&(o.info("[PlatformService] hotplugged headset(s): "+(1<n.length?n.reduce(function(e,t){return{label:e.Label+", "+t.Label}}).label:n[0].label)),s.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:n,action:"add"})));var i=[];!D&&A.length>r.length&&(angular.forEach(A,function(t){if(!r.some(function(e){return e.label===t.label})){i.push(t);var e=N.map(function(e){return e.label}).indexOf(t.label);N.splice(e,1)}}),0<i.length&&(o.info("[PlatformService] unplugged headset(s): "+(1<i.length?i.reduce(function(e,t){return{label:e.Label+", "+t.Label}}).label:i[0].label)),s.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:i,action:"remove"}))),D=!1,A=r,a.resolve(r)}),a.promise};this.getHeadsetDevices=function(){return A};var M;this.getSpeakerphoneDevices=function(){return O},this.getAllDevices=function(){return N},this.getHandFreeDevice=function(){var r=l.defer();return u.getHandfreeMicrophone().then(function(e){var n=e;u.getHandfreeSpeaker().then(function(e){var t=e;(!u.handFreeDevice||u.handFreeDevice.microphone&&u.handFreeDevice.microphone.id!==n.id||u.handFreeDevice.speaker&&u.handFreeDevice.speaker.id!==t.id)&&(u.handFreeDevice={label:"",microphone:n,speaker:t,profile:p.HANDFREE}),r.resolve(u.handFreeDevice)})}),r.promise},this.getCustomDevice=function(){var r=l.defer();return u.getCustomMicrophone().then(function(e){var n=e;u.getCustomSpeaker().then(function(e){var t=e;(!u.customDevice||u.customDevice.microphone&&u.customDevice.microphone.id!==n.id||u.customDevice.speaker&&u.customDevice.speaker.id!==t.id)&&(u.customDevice={label:"",microphone:n,speaker:t,profile:p.CUSTOM}),r.resolve(u.customDevice)})}),r.promise},this.getAvailableDevices=function(){var t=l.defer(),n=[];return u.getHandFreeDevice().then(function(e){n.push(e),A.forEach(function(e){e.profile=p.HEADSET,n.push(e)}),O.forEach(function(e){e.profile=p.SPEAKERPHONE,n.push(e)}),u.getCustomDevice().then(function(e){n.push(e),t.resolve(n)})}),t.promise},this.getStoredDeviceList=function(){return c.getSetting("deviceList")},this.saveDeviceList=function(e){for(var t=[],n=0;n<e.length;n++)t[n]=e[n].label;c.setSetting("deviceList",angular.toJson(t))},this.getCurrentCamera=function(){var t=l.defer();return u.getCameras().then(function(e){t.resolve(u.getDeviceWithId(e,c.getSetting("camera")))}),t.promise},this.getCameraForSDK=function(){return{id:c.getSetting("camera")}},this.getCameras=function(){var t=l.defer();return this.allowDevicesManagement()||t.resolve([]),u.getVideoInputDevices().then(function(e){t.resolve(e&&e.constructor===Array&&r?e:[])}).catch(function(e){return o.info("[PlatformService] === SERVICES FAILURE === : "+e.message),t.reject(e),t.promise}),t.promise},this.isDeviceAvailable=function(e,t,n){var r=e.find(function(e){return e.kind===n&&e.deviceId===t});return angular.isDefined(r)},this.getDeviceWithId=function(e,t,n){if(e.constructor!==Array)return null;var r=null;"default"!==t&&"communications"!==t||(n?(i=u.mediaDevices.find(function(e){return e.deviceId===t&&"audioinput"===e.kind}))&&(r=e.find(function(e){return"default"!==e.id&&"communications"!==e.id&&i.groupId===e.groupId})):(i=e.find(function(e){return e.id===t}))&&(r=e.find(function(e){return"default"!==e.id&&"communications"!==e.id&&i.groupId===e.groupId})));if(r)return r;if(!(r=e.find(function(e){return e.id===t}))){var i;if(n)(i=u.mediaDevices.find(function(e){return"default"===e.deviceId&&"audioinput"===e.kind}))&&(r=e.find(function(e){return"default"!==e.id&&"communications"!==e.id&&i.groupId===e.groupId}));r||(i=e.find(function(e){return"default"===e.id}))&&(r=e.find(function(e){return"default"!==e.id&&"communications"!==e.id&&i.groupId===e.groupId}))}return r||(0<e.length?e[0]:null)},this.startWatcher=function(){if(u.allowDevicesManagement()){if(angular.isDefined(M))return;M=a(u.devicesWatcher,1e3)}},this.stopWatcher=function(){angular.isDefined(M)&&(a.cancel(M),M=void 0)},this.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},this.fixDeviceLabels=function(){angular.forEach(DetectRTC.MediaDevices,function(e){e&&("default"!==e.id||e.label&&"Default"!==e.label?e.id.length<64&&"Please invoke getUserMedia once."===e.label&&(e.label=u.capitalizeFirstLetter(e.id)):e.label=u.findAndUpdateDefaultDeviceLabel(e.kind,e.groupId),o.info("[PlatformService] fixDeviceLabels || update device "+e.id+" with kind "+e.kind+" with label "+e.label))})},this.findAndUpdateDefaultDeviceLabel=function(e,t){for(var n="audioinput"===e?i("translate")("yourComputerMicrophoneDevice"):i("translate")("yourComputerSpeakerDevice"),r=0;r<DetectRTC.MediaDevices.length;r++)if("default"!==DetectRTC.MediaDevices[r].id&&DetectRTC.MediaDevices[r].kind===e&&DetectRTC.MediaDevices[r].groupId===t){n=n+" - "+DetectRTC.MediaDevices[r].label;break}return n},this.updatePermissions=function(){var t=!1;return angular.forEach(DetectRTC.MediaDevices,function(e){e&&64<=e.id.length&&("Please invoke getUserMedia once."===e.label?t=!0:("videoinput"!==e.kind||r||(r=!0),"audioinput"!==e.kind||h||(h=!0)))}),t},this.isGetUserMediaRequested=function(){return(!r||!h)&&u.updatePermissions(DetectRTC.MediaDevices)},this.audioMediaDeviceUpdated=function(){u.fixDeviceLabels(),s.$broadcast("ON_USER_AUDIO_MEDIA_CHANGED_EVENT")},this.videoMediaDeviceUpdated=function(){u.fixDeviceLabels(),s.$broadcast("ON_USER_VIDEO_MEDIA_CHANGED_EVENT")};var _=function(e){var n=[];return angular.forEach(e,function(t){n.some(function(e){return e.id===t.id})||n.push(t)}),n};this.getAudioInputDevices=function(){return l.when(_(DetectRTC.audioInputDevices))},this.getAudioOutputDevices=function(){var e=l.defer();return e.resolve(_(DetectRTC.audioOutputDevices)),e.promise},this.getVideoInputDevices=function(){var e=l.defer();return e.resolve(_(DetectRTC.videoInputDevices)),e.promise}}]),angular.module("rainbow").service("gaService",[function(){"use strict";var t={category:"webrtc",action:"CallsSuccessRate",label:"error_failed"},n={category:"webrtc",action:"CallsSuccessRate",label:"success"},e={category:"webrtc",action:"CallsSuccessRate",label:"error_no_stun_candidate"},i={category:"webrtc",action:"ICEDistribution"},r={category:"webrtc",action:"ICETopology"},a={category:"webrtc",action:"ICENegotiation",label:"DurationMs"},o={category:"webrtc",action:"GetUserMediaRate",label:"success"},s={category:"webrtc",action:"GetUserMediaRate",label:"error_no_Track"},c={category:"webrtc",action:"GetUserMediaRate",label:"error"},l={category:"webrtc",action:"CodecsDistribution"},d={category:"webrtc",action:"CallsDistribution"},u={category:"webrtc",action:"CallsDurationRange"},f={category:"ux",action:"dragAndDrop"},h={category:"invitations",action:"inviteFromProvider"},p=null,v=null,m=!1,g=null,S=null,C=null;this.provideGA=function(e){C=e},this.hasGA=function(){return null!==C},this.trackICEUsed=function(e,t){if(C){var n="",r="";switch(e){case"local":n="host";break;case"peerreflexive":case"prflx":case"serverreflexive":n="stun";break;case"relayed":n="relay";break;default:n=e}switch(t){case"local":r="host";break;case"peerreflexive":case"prflx":case"serverreflexive":r="stun";break;case"relayed":r="relay";break;default:r=t}C.send("event",i.category,i.action,n+"|"+r)}},this.trackICEFailed=function(e){C&&e&&S!==e&&(C.send("event",t.category,t.action,t.label),S=e)},this.trackICESuccess=function(e){C&&e&&g!==e&&(C.send("event",n.category,n.action,n.label),g=e)},this.trackICENoSTUNCandidate=function(){C&&C.send("event",e.category,e.action,e.label)},this.trackICETopology=function(e){C&&C.send("event",r.category,r.action,e)},this.trackGetUserMediaSuccess=function(){C&&C.send("event",o.category,o.action,o.label)},this.trackGetUserMediaErrorNoTrack=function(){C&&C.send("event",s.category,s.action,s.label)},this.trackGetUserMediaError=function(){C&&C.send("event",c.category,c.action,c.label)},this.trackCodecsUsed=function(e,t){C&&C.send("event",l.category,l.action,e+"|"+t)},this.negotiationTime=function(){return v&&p?v<p?null:v-p:null},this.startNegotiationTime=function(e){p=e||(new Date).getTime(),m=!0},this.endNegotiationTime=function(e){m&&(v=e||(new Date).getTime(),m=!1)},this.trackNegotiationTime=function(){if(C){var e=this.negotiationTime();e&&C.send("event",a.category,a.action,a.label,e),p=v=null}},this.resetProvider=function(){C=null},this.trackCallSuccessNumber=function(e){e&&0<e.length&&C&&C.send("event",d.category,d.action,e)},this.trackCallDuration=function(e){if(C&&angular.isDefined(e)&&0<=e){var t="",n=Math.round(e/1e3);t=n<15?"very_short_less_15s":n<30?"very_short_less_30s":n<60?"short_less_60s":n<120?"short_less_120s":n<300?"short_less_300s":n<600?"normal_less_600s":n<1200?"normal_less_1200s":n<1800?"normal_less_1800s":n<3600?"long_less_3600s":"long_more_3600s",C.send("event",u.category,u.action,t)}},this.trackDragAndDrop=function(e){C&&C.send("event",f.category,f.action,e)},this.inviteContactsFromProvider=function(e,t){C&&C.send("event",h.category,h.action,e,t)}}]),angular.module("rainbow").service("countryService",["$translate",function(r){"use strict";var i=this;i.countries=[{name:"Australia","alpha-3":"AUS","country-code":"036","alpha-2":"AU"},{name:"Austria","alpha-3":"AUT","country-code":"040","alpha-2":"AT"},{name:"Belgium","alpha-3":"BEL","country-code":"056","alpha-2":"BE"},{name:"Brazil","alpha-3":"BRA","country-code":"076","alpha-2":"BR"},{name:"Canada","alpha-3":"CAN","country-code":"124","alpha-2":"CA"},{name:"China","alpha-3":"CHN","country-code":"156","alpha-2":"CN"},{name:"Czech Republic","alpha-3":"CZE","country-code":"203","alpha-2":"CZ"},{name:"Denmark","alpha-3":"DNK","country-code":"208","alpha-2":"DK"},{name:"Finland","alpha-3":"FIN","country-code":"246","alpha-2":"FI"},{name:"France","alpha-3":"FRA","country-code":"250",default:!0,"alpha-2":"FR"},{name:"Germany","alpha-3":"DEU","country-code":"276","alpha-2":"DE"},{name:"Hong Kong","alpha-3":"HKG","country-code":"344","alpha-2":"HK"},{name:"Ireland","alpha-3":"IRL","country-code":"372","alpha-2":"IE"},{name:"Israel","alpha-3":"ISR","country-code":"376","alpha-2":"IL"},{name:"Italy","alpha-3":"ITA","country-code":"380","alpha-2":"IT"},{name:"Mexico","alpha-3":"MEX","country-code":"484","alpha-2":"MX"},{name:"Netherlands","alpha-3":"NLD","country-code":"528","alpha-2":"NL"},{name:"Norway","alpha-3":"NOR","country-code":"578","alpha-2":"NO"},{name:"Poland","alpha-3":"POL","country-code":"616","alpha-2":"PL"},{name:"Portugal","alpha-3":"PRT","country-code":"620","alpha-2":"PT"},{name:"Russia","alpha-3":"RUS","country-code":"643","alpha-2":"RU"},{name:"South Africa","alpha-3":"ZAF","country-code":"710","alpha-2":"ZA"},{name:"South Korea","alpha-3":"KOR","country-code":"410","alpha-2":"KR"},{name:"Spain","alpha-3":"ESP","country-code":"724","alpha-2":"ES"},{name:"Sweden","alpha-3":"SWE","country-code":"752","alpha-2":"SE"},{name:"Switzerland","alpha-3":"CHE","country-code":"756","alpha-2":"CH"},{name:"Taiwan","alpha-3":"TWN","country-code":"158","alpha-2":"TW"},{name:"Turkey","alpha-3":"TUR","country-code":"792","alpha-2":"TR"},{name:"United Kingdom","alpha-3":"GBR","country-code":"826","alpha-2":"GB"},{name:"United States of America","alpha-3":"USA","country-code":"840","alpha-2":"US"},{name:"Afghanistan","alpha-3":"AFG","country-code":"004","alpha-2":"AF"},{name:"Albania","alpha-3":"ALB","country-code":"008","alpha-2":"AL"},{name:"Algeria","alpha-3":"DZA","country-code":"012","alpha-2":"DZ"},{name:"Andorra","alpha-3":"AND","country-code":"020","alpha-2":"AD"},{name:"Angola","alpha-3":"AGO","country-code":"024","alpha-2":"AO"},{name:"Anguilla","alpha-3":"AIA","country-code":"660","alpha-2":"AI"},{name:"Antigua and Barbuda","alpha-3":"ATG","country-code":"028","alpha-2":"AG"},{name:"Argentina","alpha-3":"ARG","country-code":"032","alpha-2":"AR"},{name:"Armenia","alpha-3":"ARM","country-code":"051","alpha-2":"AM"},{name:"Aruba","alpha-3":"ABW","country-code":"533","alpha-2":"AW"},{name:"Azerbaijan","alpha-3":"AZE","country-code":"031","alpha-2":"AZ"},{name:"Bahamas","alpha-3":"BHS","country-code":"044","alpha-2":"BS"},{name:"Bahrain","alpha-3":"BHR","country-code":"048","alpha-2":"BH"},{name:"Bangladesh","alpha-3":"BGD","country-code":"050","alpha-2":"BD"},{name:"Barbados","alpha-3":"BRB","country-code":"052","alpha-2":"BB"},{name:"Belarus","alpha-3":"BLR","country-code":"112","alpha-2":"BY"},{name:"Belize","alpha-3":"BLZ","country-code":"084","alpha-2":"BZ"},{name:"Benin","alpha-3":"BEN","country-code":"204","alpha-2":"BJ"},{name:"Bermuda","alpha-3":"BMU","country-code":"060","alpha-2":"BM"},{name:"Bhutan","alpha-3":"BTN","country-code":"064","alpha-2":"BT"},{name:"Bolivia","alpha-3":"BOL","country-code":"068","alpha-2":"BO"},{name:"Bosnia and Herzegovina","alpha-3":"BIH","country-code":"070","alpha-2":"BA"},{name:"Botswana","alpha-3":"BWA","country-code":"072","alpha-2":"BW"},{name:"British Virgin Islands","alpha-3":"VGB","country-code":"092","alpha-2":"VG"},{name:"Brunei Darussalam","alpha-3":"BRN","country-code":"096","alpha-2":"BN"},{name:"Bulgaria","alpha-3":"BGR","country-code":"100","alpha-2":"BG"},{name:"Burkina Faso","alpha-3":"BFA","country-code":"854","alpha-2":"BF"},{name:"Burundi","alpha-3":"BDI","country-code":"108","alpha-2":"BI"},{name:"Cambodia","alpha-3":"KHM","country-code":"116","alpha-2":"KH"},{name:"Cameroon","alpha-3":"CMR","country-code":"120","alpha-2":"CM"},{name:"Cape Verde","alpha-3":"CPV","country-code":"132","alpha-2":"CV"},{name:"Cayman Islands","alpha-3":"CYM","country-code":"136","alpha-2":"KY"},{name:"Central African Republic","alpha-3":"CAF","country-code":"140","alpha-2":"CF"},{name:"Chad","alpha-3":"TCD","country-code":"148","alpha-2":"TD"},{name:"Chile","alpha-3":"CHL","country-code":"152","alpha-2":"CL"},{name:"Colombia","alpha-3":"COL","country-code":"170","alpha-2":"CO"},{name:"Comoros","alpha-3":"COM","country-code":"174","alpha-2":"KM"},{name:"Congo","alpha-3":"COG","country-code":"178","alpha-2":"CG"},{name:"Congo, Democratic Republic of","alpha-3":"COD","country-code":"180","alpha-2":"CD"},{name:"Costa Rica","alpha-3":"CRI","country-code":"188","alpha-2":"CR"},{name:"Ivory Coast","alpha-3":"CIV","country-code":"384","alpha-2":"CI"},{name:"Croatia","alpha-3":"HRV","country-code":"191","alpha-2":"HR"},{name:"Cyprus","alpha-3":"CYP","country-code":"196","alpha-2":"CY"},{name:"Djibouti","alpha-3":"DJI","country-code":"262","alpha-2":"DJ"},{name:"Dominica","alpha-3":"DMA","country-code":"212","alpha-2":"DM"},{name:"Dominican Republic","alpha-3":"DOM","country-code":"214","alpha-2":"DO"},{name:"Ecuador","alpha-3":"ECU","country-code":"218","alpha-2":"EC"},{name:"El Salvador","alpha-3":"SLV","country-code":"222","alpha-2":"SV"},{name:"Egypt","alpha-3":"EGY","country-code":"818","alpha-2":"EG"},{name:"Eritrea","alpha-3":"ERI","country-code":"232","alpha-2":"ER"},{name:"Estonia","alpha-3":"EST","country-code":"233","alpha-2":"EE"},{name:"Ethiopia","alpha-3":"ETH","country-code":"231","alpha-2":"ET"},{name:"Fiji","alpha-3":"FJI","country-code":"242","alpha-2":"FJ"},{name:"Gabon","alpha-3":"GAB","country-code":"266","alpha-2":"GA"},{name:"Gambia","alpha-3":"GMB","country-code":"270","alpha-2":"GM"},{name:"Georgia","alpha-3":"GEO","country-code":"268","alpha-2":"GE"},{name:"Ghana","alpha-3":"GHA","country-code":"288","alpha-2":"GH"},{name:"Greece","alpha-3":"GRC","country-code":"300","alpha-2":"GR"},{name:"Grenada","alpha-3":"GRD","country-code":"308","alpha-2":"GD"},{name:"Guadeloupe","alpha-3":"GLP","country-code":"312","alpha-2":"GP"},{name:"Guatemala","alpha-3":"GTM","country-code":"320","alpha-2":"GT"},{name:"Guinea","alpha-3":"GIN","country-code":"324","alpha-2":"GN"},{name:"Guyana","alpha-3":"GUY","country-code":"328","alpha-2":"GY"},{name:"Haiti","alpha-3":"HTI","country-code":"332","alpha-2":"HT"},{name:"Honduras","alpha-3":"HND","country-code":"340","alpha-2":"HN"},{name:"Hungary","alpha-3":"HUN","country-code":"348","alpha-2":"HU"},{name:"Iceland","alpha-3":"ISL","country-code":"352","alpha-2":"IS"},{name:"India","alpha-3":"IND","country-code":"356","alpha-2":"IN"},{name:"Indonesia","alpha-3":"IDN","country-code":"360","alpha-2":"ID"},{name:"Iraq","alpha-3":"IRQ","country-code":"368","alpha-2":"IQ"},{name:"Jamaica","alpha-3":"JAM","country-code":"388","alpha-2":"JM"},{name:"Japan","alpha-3":"JPN","country-code":"392","alpha-2":"JP"},{name:"Jordan","alpha-3":"JOR","country-code":"400","alpha-2":"JO"},{name:"Kazakhstan","alpha-3":"KAZ","country-code":"398","alpha-2":"KZ"},{name:"Kenya","alpha-3":"KEN","country-code":"404","alpha-2":"KE"},{name:"Kuwait","alpha-3":"KWT","country-code":"414","alpha-2":"KW"},{name:"Kyrgyzstan","alpha-3":"KGZ","country-code":"417","alpha-2":"KG"},{name:"Latvia","alpha-3":"LVA","country-code":"428","alpha-2":"LV"},{name:"Lebanon","alpha-3":"LBN","country-code":"422","alpha-2":"LB"},{name:"Lesotho","alpha-3":"LSO","country-code":"426","alpha-2":"LS"},{name:"Liberia","alpha-3":"LBR","country-code":"430","alpha-2":"LR"},{name:"Libya","alpha-3":"LBY","country-code":"434","alpha-2":"LY"},{name:"Liechtenstein","alpha-3":"LIE","country-code":"438","alpha-2":"LI"},{name:"Lithuania","alpha-3":"LTU","country-code":"440","alpha-2":"LT"},{name:"Luxembourg","alpha-3":"LUX","country-code":"442","alpha-2":"LU"},{name:"Macao","alpha-3":"MAC","country-code":"446","alpha-2":"MO"},{name:"Macedonia","alpha-3":"MKD","country-code":"807","alpha-2":"MK"},{name:"Madagascar","alpha-3":"MDG","country-code":"450","alpha-2":"MG"},{name:"Malawi","alpha-3":"MWI","country-code":"454","alpha-2":"MW"},{name:"Malaysia","alpha-3":"MYS","country-code":"458","alpha-2":"MY"},{name:"Maldives","alpha-3":"MDV","country-code":"462","alpha-2":"MV"},{name:"Mali","alpha-3":"MLI","country-code":"466","alpha-2":"ML"},{name:"Malta","alpha-3":"MLT","country-code":"470","alpha-2":"MT"},{name:"Mauritius","alpha-3":"MUS","country-code":"480","alpha-2":"MU"},{name:"Mayotte","alpha-3":"MYT","country-code":"175","alpha-2":"YT"},{name:"Moldova","alpha-3":"MDA","country-code":"498","alpha-2":"MD"},{name:"Monaco","alpha-3":"MCO","country-code":"492","alpha-2":"MC"},{name:"Mongolia","alpha-3":"MNG","country-code":"496","alpha-2":"MN"},{name:"Montenegro","alpha-3":"MNE","country-code":"499","alpha-2":"ME"},{name:"Montserrat","alpha-3":"MSR","country-code":"500","alpha-2":"MS"},{name:"Morocco","alpha-3":"MAR","country-code":"504","alpha-2":"MA"},{name:"Mozambique","alpha-3":"MOZ","country-code":"508","alpha-2":"MZ"},{name:"Myanmar","alpha-3":"MMR","country-code":"104","alpha-2":"MM"},{name:"Namibia","alpha-3":"NAM","country-code":"516","alpha-2":"NA"},{name:"Nepal","alpha-3":"NPL","country-code":"524","alpha-2":"NP"},{name:"New Zealand","alpha-3":"NZL","country-code":"554","alpha-2":"NZ"},{name:"Nicaragua","alpha-3":"NIC","country-code":"558","alpha-2":"NI"},{name:"Niger","alpha-3":"NER","country-code":"562","alpha-2":"NE"},{name:"Nigeria","alpha-3":"NGA","country-code":"566","alpha-2":"NG"},{name:"Oman","alpha-3":"OMN","country-code":"512","alpha-2":"OM"},{name:"Pakistan","alpha-3":"PAK","country-code":"586","alpha-2":"PK"},{name:"Palestine","alpha-3":"PSE","country-code":"275","alpha-2":"PS"},{name:"Panama","alpha-3":"PAN","country-code":"591","alpha-2":"PA"},{name:"Paraguay","alpha-3":"PRY","country-code":"600","alpha-2":"PY"},{name:"Peru","alpha-3":"PER","country-code":"604","alpha-2":"PE"},{name:"Philippines","alpha-3":"PHL","country-code":"608","alpha-2":"PH"},{name:"Puerto Rico","alpha-3":"PRI","country-code":"630","alpha-2":"PR"},{name:"Qatar","alpha-3":"QAT","country-code":"634","alpha-2":"QA"},{name:"Romania","alpha-3":"ROU","country-code":"642","alpha-2":"RO"},{name:"Rwanda","alpha-3":"RWA","country-code":"646","alpha-2":"RW"},{name:"Saint Kitts and Nevis","alpha-3":"KNA","country-code":"659","alpha-2":"KN"},{name:"Saint Lucia","alpha-3":"LCA","country-code":"662","alpha-2":"LC"},{name:"Saint Vincent and the Grenadines","alpha-3":"VCT","country-code":"670","alpha-2":"VC"},{name:"Saudi Arabia","alpha-3":"SAU","country-code":"682","alpha-2":"SA"},{name:"Senegal","alpha-3":"SEN","country-code":"686","alpha-2":"SN"},{name:"Serbia","alpha-3":"SRB","country-code":"688","alpha-2":"RS"},{name:"Sierra Leone","alpha-3":"SLE","country-code":"694","alpha-2":"SL"},{name:"Singapore","alpha-3":"SGP","country-code":"702","alpha-2":"SG"},{name:"Slovakia","alpha-3":"SVK","country-code":"703","alpha-2":"SK"},{name:"Slovenia","alpha-3":"SVN","country-code":"705","alpha-2":"SI"},{name:"South Sudan","alpha-3":"SSD","country-code":"728","alpha-2":"SS"},{name:"Sri Lanka","alpha-3":"LKA","country-code":"144","alpha-2":"LK"},{name:"Sudan","alpha-3":"SDN","country-code":"729","alpha-2":"SD"},{name:"Swaziland","alpha-3":"SWZ","country-code":"748","alpha-2":"SZ"},{name:"Tajikistan","alpha-3":"TJK","country-code":"762","alpha-2":"TJ"},{name:"Tanzania","alpha-3":"TZA","country-code":"834","alpha-2":"TZ"},{name:"Thailand","alpha-3":"THA","country-code":"764","alpha-2":"TH"},{name:"Togo","alpha-3":"TGO","country-code":"768","alpha-2":"TG"},{name:"Trinidad and Tobago","alpha-3":"TTO","country-code":"780","alpha-2":"TT"},{name:"Tunisia","alpha-3":"TUN","country-code":"788","alpha-2":"TN"},{name:"Turkmenistan","alpha-3":"TKM","country-code":"795","alpha-2":"TM"},{name:"Turks and Caicos Islands","alpha-3":"TCA","country-code":"796","alpha-2":"TC"},{name:"Uganda","alpha-3":"UGA","country-code":"800","alpha-2":"UG"},{name:"Ukraine","alpha-3":"UKR","country-code":"804","alpha-2":"UA"},{name:"United Arab Emirates","alpha-3":"ARE","country-code":"784","alpha-2":"AE"},{name:"Virgin Islands, US","alpha-3":"VIR","country-code":"850","alpha-2":"VI"},{name:"Uruguay","alpha-3":"URY","country-code":"858","alpha-2":"UY"},{name:"Uzbekistan","alpha-3":"UZB","country-code":"860","alpha-2":"UZ"},{name:"Venezuela","alpha-3":"VEN","country-code":"862","alpha-2":"VE"},{name:"Vietnam","alpha-3":"VNM","country-code":"704","alpha-2":"VN"},{name:"Zambia","alpha-3":"ZMB","country-code":"894","alpha-2":"ZM"},{name:"Zimbabwe","alpha-3":"ZWE","country-code":"716","alpha-2":"ZW"}],i.statesOfAmerica={ALABAMA:"Alabama",ALASKA:"Alaska",ARIZONA:"Arizona",ARKANSAS:"Arkansas",CALIFORNIA:"California",COLORADO:"Colorado",CONNECTICUT:"Connecticut",DELAWARE:"Delaware",FLORIDA:"Florida",GEORGIA:"Georgia",HAVAII:"Hawaii",IDAHO:"Idaho",ILLINOIS:"Illinois",INDIANA:"Indiana",IOWA:"Iowa",KANSAS:"Kansas",KENTUCKY:"Kentucky",LOUISIANA:"Louisiana",MAINE:"Maine",MARYLAND:"Maryland",MASSACHUSSETTS:"Massachusetts",MICHIGAN:"Michigan",MINNESOTA:"Minnesota",MISSISSIPPI:"Mississippi",MISSOURI:"Missouri",MONTANA:"Montana",NEBRASKA:"Nebraska",NEVADA:"Nevada",NEW_HAMPSHIRE:"New Hampshire",NEW_JERSEY:"New Jersey",NEW_MEXICO:"New Mexico",NEW_YORK:"New York",NORTH_CAROLINA:"North Carolina",NOTH_DAKOTA:"North Dakota",OHIO:"Ohio",OKLAHOMA:"Oklahoma",OREGON:"Oregon",PENNSYLVANIA:"Pennsylvania",RODE_ISLAND:"Rhode Island",SOUTH_CAROLINA:"South Carolina",SOUTH_DAKOTA:"South Dakota",TENNESSEE:"Tennessee",TEXAS:"Texas",UTAH:"Utah",VERMONT:"Vermont",VIRGINIA:"Virginia",WASHINGTON:"Washington",WEST_VIRGINIA:"West Virginia",WISCONSIN:"Wisconsin",WYOMING:"Wyoming"},i.getCountries=function(e){var t=Object.assign([],i.countries).map(i.translateCountryName);if(e)t.sort(i.sortByCountryName);else{var n=t.splice(30).sort(i.sortByCountryName);t.sort(i.sortByCountryName),t.push({name:r.instant("otherCountries"),disabled:"true"}),t.push.apply(t,n)}return t},i.sortByCountryName=function(e,t){return e.name.localeCompare(t.name,r.use())},i.translateCountryName=function(e){var t=i.getCountryLabel(e["alpha-2"]);if(t){var n=r.instant(t);n!==t&&(e.name=n)}return e},i.getAmericanStates=function(){return i.statesOfAmerica},i.getCountry=function(t,e){if(!t)return e?i.getDefaultCountry():null;var n=i.countries.filter(function(e){return e["alpha-3"]===t});return 0<n.length?n[0]:null},i.getDefaultCountry=function(){var e=i.countries.filter(function(e){return!0===e.default});return 0<e.length?e[0]:i.countries[0]},i.getCountryName=function(e){return i.getCountry(e)?i.getCountry(e).name:null},i.getCountryCode=function(e){return e?e["alpha-3"]:null},i.getDefaultState=function(e){return e&&"USA"===e["alpha-3"]?"ALABAMA":null},i.getAlpha2Code=function(t){if(!t)return null;var e=i.countries.filter(function(e){return e["alpha-3"]===t});return 0<e.length?e[0]["alpha-2"]:null},i.getCountryLabel=function(e){if(3===e.length)var t=i.getAlpha2Code(e);else t=e;return t?"country"+t:null}}]),angular.module("rainbow").filter("countryFilter",["countryService",function(t){"use strict";return function(e){return t.getCountryName(e)}}]),angular.module("rainbow").service("usersService",["$q","$log","$rootScope","contactService",function(r,i,a,e){"use strict";var o=this,s=[];this.started=!1,this.start=function(e){i.info("[usersService] === STARTING ==="),o.started=!0;var t=performance.now();i.info("[usersService] start"),o.contactsInRoster=o.getAllRosterContacts(),o.lastNameList=o.orderContactsByLastName(),o.firstNameList=o.orderContactByFirstName(),o.companyNameList=o.orderContactsByCompany(),s.push(a.$on("ON_CONTACT_ROSTER_UPDATE_EVENT",o.onContactUpdatedEvent));var n=Math.round(performance.now()-t);return e.push({service:"usersService",startDuration:n}),i.info("[usersService] === STARTED ("+n+" ms) ==="),r.when()},this.stop=function(){var e;for(i.info("[usersService] === STOPPING ==="),o.started&&(o.started=!1);e=s.pop();)e();return i.info("[usersService] === STOPPED ==="),r.when()},this.onContactUpdatedEvent=function(){i.info("[usersService] onContactUpdatedEvent");var e=o.getAllRosterContacts();e.length-o.contactsInRoster.length!=0&&(i.info("[usersService] onContactUpdatedEvent - update all user lists"),o.contactsInRoster=e,o.lastNameList=o.orderContactsByLastName(),o.firstNameList=o.orderContactByFirstName(),o.companyNameList=o.orderContactsByCompany(),a.$broadcast("ON_USER_SERVICE_ROSTER_UPDATE_EVENT"))},this.getLastNameList=function(){return o.lastNameList},this.getFirstNameList=function(){return o.firstNameList},this.getCompanyNameList=function(){return o.companyNameList},this.getAllRosterContacts=function(){return e.getContacts().filter(function(e){return e.displayName&&e.roster})},this.addSeparatorsForLastname=function(e){var n=[],r="";return e.forEach(function(e){if(r!==e.lastname.charAt(0).toUpperCase()){var t={value:r=e.lastname.charAt(0).toUpperCase(),type:"separator",id:r};n.push(t)}n.push(e)}),n},this.orderContactsByLastName=function(){var e=o.contactsInRoster;return e=o.getOrderedUsers(e,"lastname"),o.addSeparatorsForLastname(e)},this.addSeparatorsForFirstname=function(e){var n=[],r="";return e.forEach(function(e){if(r!==e.firstname.charAt(0).toUpperCase()){var t={value:r=e.firstname.charAt(0).toUpperCase(),type:"separator",id:r};n.push(t)}n.push(e)}),n},this.orderContactByFirstName=function(){var e=o.contactsInRoster;return e=o.getOrderedUsers(e,"firstname"),o.addSeparatorsForFirstname(e)},this.addSeparatorsForCompany=function(e){var n=[],r="";return e.forEach(function(e){if(r!==e.company.name){var t={value:r=e.company.name,type:"separator",id:r};n.push(t)}n.push(e)}),n},this.orderContactsByCompany=function(){var e=o.contactsInRoster;return e=o.getOrderedUsers(e,"company"),o.addSeparatorsForCompany(e)},this.getFilterAndOrderUsersGroupedByOrderLabel=function(e,t,n,r){r=Boolean(!0&r);var i=o.getFilterAndOrderUsers(e,t,n,r);return"firstname"===t?o.addSeparatorsForFirstname(i):"company"===t?o.addSeparatorsForCompany(i):o.addSeparatorsForLastname(i)},this.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity=function(e,t,n,r){r=Boolean(!0&r);var i=o.getFilterAndOrderUsers(e,t,n,r);return"firstname"===t?o.addSeparatorsForFirstname(i):"company"===t?o.addSeparatorsForCompany(i):o.addSeparatorsForLastname(i)},this.getFilterAndOrderUsers=function(e,t,n,r){var i=o.getFilteredUsers(e,n,r);return o.getOrderedUsers(i,t)},this.getFilteredUsers=function(e,a,o){var n;return n=(n=e.filter(function(e){if("separator"===e.type)return!0;var t=e.displayName&&e.roster||o,n="offline"!==e.status&&"wait"!==e.status&&"xa"!==e.status&&"unknown"!==e.status,r="wait"===e.status,i=e.isTerminated;return"online"===a?t&&n:"offline"===a?t&&!n&&!i:"pending"===a?t&&r:"all"===a?t&&!i:t})).filter(function(e,t){return!!("separator"!==e.type||n[t+1]&&"separator"!==n[t+1].type)})},this.getOrderedUsers=function(e,i){return e.sort(function(e,t){var n;if("lastname"===i)return 0===(n=e.lastname.localeCompare(t.lastname))?e.firstname.localeCompare(t.firstname):n;if("firstname"===i)return 0===(n=e.firstname.localeCompare(t.firstname))?e.lastname.localeCompare(t.lastname):n;if("company"===i){var r=e.company.name.localeCompare(t.company.name);return 0===r?e.lastname.localeCompare(t.lastname):r}return 0})}}]),angular.module("rainbow").service("utilService",["$log",function(r){"use strict";var n=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];this.removeDiacritis=function(e){for(var t=0;t<n.length;t++)e=e.replace(n[t].letters,n[t].base);return e},this.escapeHtml=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},this.extractHtmlContent=function(e){var t=new DOMParser,n="{}";try{n=t.parseFromString(e,"text/html").documentElement.textContent}catch(e){r.error("[utilService] error in extractHtmlContent:",e),n="{}"}return n},this.sortAlphaNum=function(e,t){var n=/[^a-zA-Z]/g,r=/[^0-9]/g,i=e.replace(n,""),a=t.replace(n,"");if(i===a){var o=parseInt(e.replace(r,""),10),s=parseInt(t.replace(r,""),10);return o===s?0:s<o?1:-1}return a<i?1:-1}}]);var LocalImage=function(){function e(e,t){this.url=URL.createObjectURL(t),this.fd=e}return e.prototype.release=function(){URL.revokeObjectURL(this.url)},e}(),Capabilities=function(){},FileServerService=function(){function e(e,t,n,r,i,a,o,s,c,l,d){this.$q=e,this.$http=t,this.$log=n,this.authService=r,this.fileStorageService=i,this.TransfertPromiseQueue=a,this.FileDescriptorEventHandler=o,this.xmppService=s,this.errorHelperService=c,this.$rootScope=l,this.$interval=d,this.ONE_KILOBYTE=1024,this.ONE_MEGABYTE=1048576,this.ONE_GIGABYTE=1073741824,this.started=!1,this.thumbnailPromises=[]}return e.prototype.start=function(t){var n=this;this.$log.info("[FileServerService] === STARTING ===");var r=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files",this.getServercapabilities().then(function(){n.attachHandlers(),n.transfertPromiseQueue=n.TransfertPromiseQueue.create();var e=Math.round(performance.now()-r);t.push({service:"FileServerService",startDuration:e}),n.$log.info("[FileServerService] === STARTED ("+e+" ms) ===")}).catch(function(e){n.$log.error("[FileServerService] === STARTING FAILURE === "+e.message)}),this.$q.when()},e.prototype.stop=function(){return this.$log.info("[FileServerService] === STOPPING ==="),this.started&&(this.started=!1),this.$log.info("[FileServerService] === STOPPED ==="),this.$q.when()},e.prototype.attachHandlers=function(){var t=this;this.removeHandlers(),this.fileDescriptorEventHandler=this.FileDescriptorEventHandler.create(this),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=this.xmppService.addHandler(function(e){return t.$interval(function(){t.fileDescriptorEventHandler.onManagementMessageReceived(e)},250,1),!0},null,"message","management"))},e.prototype.removeHandlers=function(){this.fileDescriptorEventHandler=void 0,this.fileMessageHandlerRef=void 0},e.prototype.getLocalImage=function(i,a){var o=this;return this.$q(function(n,r){var e=o.fileStorageService.getFileDescriptorById(i);(e?o.$q.resolve(e):o.fileStorageService.retrieveAndStoreOneFileDescriptor(i)).then(function(t){(a&&t.previewBlob?o.$q.resolve(t.previewBlob):a?o.getBlobThumbnailFromFileDescriptor(t):o.getBlobFromFileDescriptor(t)).then(function(e){n(new LocalImage(t,e))})}).catch(function(e){var t="[fileServerService] getFileLocalURL -- no file descriptor found with "+i+" id.";o.$log.error(t),r(new Error(t))})})},e.prototype.getPartialDataFromServer=function(e,n,r,a){var o=this;return this.$q(function(t,i){o.$http({method:"GET",url:e,headers:o.authService.getRequestHeaderWithRange("bytes="+n+"-"+r),responseType:"arraybuffer"}).then(function(e){t({data:e.data,index:a})},function(e){var t=o.errorHelperService.handleError(e),n=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e.data))),r=o.errorHelperService.getLocalizedError(n.errorDetailsCode);o.$log.error(r),i(t)})})},e.prototype.getFileStorageService=function(){return this.fileStorageService},e.prototype.getBlobThumbnailFromFileDescriptor=function(t){var n=this;if(t.thumbnail.isThumbnailAvailable()||t.size<20*this.ONE_KILOBYTE){var e=this.thumbnailPromises[t.id];if(e)return this.$log.info("[FileServerService] getBlobThumbnailFromFileDescriptor "+t.id+" already lauched"),e.promise;var r=this.$q.defer();this.thumbnailPromises[t.id]=r;var i=t.url;return t.thumbnail.isThumbnailAvailable()&&t.size>=20*this.ONE_KILOBYTE?i+="?thumbnail=true":t.uploadedDate&&(i+="?update="+MD5.hexdigest(t.uploadedDate)),t.state="downloading",this.getBlobFromUrl(i,t.typeMIME,t.size,t.fileName).then(function(e){t.previewBlob=e,t.state="uploaded",n.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"download",url:i,fileId:t.id,mime:t.typeMIME,filename:t.fileName,filesize:t.size}),delete n.thumbnailPromises[t.id],r.resolve(e)}).catch(function(e){t.state="uploaded",n.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:e.message,url:i,fileId:t.id,mime:t.typeMIME,filename:t.fileName,filesize:t.size}),delete n.thumbnailPromises[t.id],r.reject(e)}),r.promise}return this.$q.reject()},e.prototype.getBlobFromFileDescriptor=function(i){var a=this;if(!i)return this.$log.warn("[FileServerService] getBlobFromFileDescriptor : missing file descriptor"),this.$q.reject();if(this.$log.info("[FileServerService] getBlobFromFileDescriptor: "+i.id),"uploaded"!==i.state&&"downloading"!==i.state)return this.$log.warn("[FileServerService] getBlobFromFileDescriptor : file is not in uploaded state="+i.state),this.$q.reject();var o=i.url;i.uploadedDate&&(o+="?update="+MD5.hexdigest(i.uploadedDate));var e=this.ONE_MEGABYTE;if(this.capabilities.maxChunkSizeDownload&&0!==i.size&&i.size>e){i.size>=100*e&&(e=i.size/100+this.ONE_KILOBYTE,this.$log.debug("[FileServerService] changing chunk size: "+e));var s=this.$q.defer(),c=new Array,l=[];i.state="downloading",i.chunkTotalNumber=Math.ceil(i.size/e),i.chunkPerformed=0,i.chunkPerformedPercent=0,this.$rootScope.$broadcast("ON_DOWNLOAD_FILE_MESSAGE",{fileId:i.id}),this.$log.info("[FileServerService] getBlobFromFileDescriptor: need to download "+i.chunkTotalNumber+" chunks");for(var d,t=function(e,n,r,t){r=r<i.size?r:i.size,l.push(function(){var t=a.$q.defer();return a.getPartialDataFromServer(o,n,r,e).then(function(e){return i.chunkPerformed++,i.chunkPerformedPercent=100*i.chunkPerformed/i.chunkTotalNumber,a.$log.info("[FileServerService] getBlobFromFileDescriptor : chunk downloaded="+i.chunkPerformed),c[e.index]=e.data,a.$rootScope.$broadcast("ON_DOWNLOAD_FILE_MESSAGE",{fileId:i.id}),t.resolve(e)}).catch(function(e){a.$log.info("[FileServerService] error on chunk download="+e),t.reject(e)}),t.promise}),d=r},n=0,r=0,u=e-1,f=Math.ceil(i.size/e);0<f;n++,f--,r+=e,u+=e)t(n,r,u),u=d;return this.transfertPromiseQueue.addPromiseArray(l,function(){var e=new Blob(c,{type:i.typeMIME});a.$log.info("[FileServerService] getBlobFromFileDescriptor success"),i.state="uploaded",i.chunkPerformed=0,i.chunkTotalNumber=0,i.chunkPerformedPercent=0,a.$rootScope.$broadcast("ON_DOWNLOAD_FILE_MESSAGE",{fileId:i.id}),s.resolve(e)},function(e){var t=a.errorHelperService.handleError(e),n=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e.data))),r=a.errorHelperService.getLocalizedError(n.errorDetailsCode);a.$log.error(r),a.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:r||t.message,url:o,fileId:i.id,mime:i.typeMIME,filename:i.fileName,filesize:i.size}),s.reject(t)}),s.promise}return i.state="downloading",i.chunkTotalNumber=1,i.chunkPerformed=0,i.chunkPerformedPercent=0,this.getBlobFromUrl(o,i.typeMIME,i.size,i.fileName).then(function(e){return i.state="uploaded",a.$q.resolve(e)}).catch(function(e){return a.$log.info("[FileServerService] arrayPromise : error "+e.message),a.$q.reject(e)})},e.prototype.getBlobFromUrl=function(e,r,t,n){var a=this;return this.$log.debug("[FileServerService] >getBlobFromUrl: "+e),this.$q(function(n,i){a.$http({method:"GET",url:e,headers:a.authService.getRequestHeader(),responseType:"arraybuffer"}).then(function(e){var t=new Blob([e.data],{type:r});a.$log.debug("[FileServerService] getBlobFromUrl success"),n(t)},function(e){var t=a.errorHelperService.handleError(e),n=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e.data))),r=a.errorHelperService.getLocalizedError(n.errorDetailsCode);a.$log.error(r),i(t)})})},e.prototype.getBlobUrlAndOrientationByFileDescriptorId=function(i){var a=this;return this.$q(function(n,t){var r=a.fileStorageService.getFileDescriptorById(i);r?a.getBlobFromFileDescriptor(r).then(function(e){var t={};if(t.blobUrl=URL.createObjectURL(e),t.id=i,r.orientation)return t.orientation=r.orientation,void n(t);a.setImageOrientationForFileDescriptor(r,e).then(function(e){t.orientation=e,n(t)}).catch(function(){n(t)})}).catch(function(e){t(e)}):(a.$log.error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found for ID "+i),t(new Error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found")))})},e.prototype.setImageOrientationForFileDescriptor=function(f,e){return this.$q(function(l,d){if(f&&f.isImage()){var u=new FileReader;u.onload=function(e){f.orientation=1;var t=new DataView(u.result);if(65496===t.getUint16(0,!1)){for(var n=t.byteLength,r=2;r<n;){if(t.getUint16(r+2,!1)<=8)return void d();var i=t.getUint16(r,!1);if(r+=2,65505===i){if(1165519206!==t.getUint32(r+=2,!1))return void d();var a=18761===t.getUint16(r+=6,!1);r+=t.getUint32(r+4,a);var o=t.getUint16(r,a);r+=2;for(var s=0;s<o;s++)if(274===t.getUint16(r+12*s,a)){var c=t.getUint16(r+12*s+8,a);return f.orientation=c,void l(c)}}else{if(65280!=(65280&i))break;r+=t.getUint16(r,!1)}}d()}else d()},u.readAsArrayBuffer(e)}else d()})},e.prototype.uploadAFile=function(i,a,o){var s=this;return this.$q(function(n,r){var e=s.fileStorageService.getFileDescriptorById(i);e&&(e.state="uploading"),s.$http({method:"PUT",url:s.portalURL+"/"+i,headers:s.authService.getPostHeader("application/octet-stream"),data:a,uploadEventHandlers:{progress:function(e){s.$log.log(e)}}}).then(function(e){var t=s.fileStorageService.getFileDescriptorById(i);t&&(t.state="uploaded"),s.$log.info("[FileServerService] uploadAFile success"),s.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",url:s.portalURL+"/"+i,fileId:i,mime:o,filename:a.name,filesize:a.size}),s.fileStorageService.orderDocuments(),n(t)},function(e){var t=s.errorHelperService.handleError(e);s.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",url:s.portalURL+"/"+i,fileId:i,mime:o,filename:a.name,filesize:a.size}),r(t),s.$log.error("[FileServerService] "+t.message)})})},e.prototype.sendPartialDataToServer=function(e,t,i,a,o,s){var c=this;return this.$q(function(n,r){c.$http({method:"PUT",url:c.portalURL+"/"+e+"/parts/"+s,headers:c.authService.getPostHeaderWithRange("bytes "+a+"-"+o+"/"+i,"application/octet-stream"),data:t,uploadEventHandlers:{progress:function(e){c.$log.log(e)}}}).then(function(e){var t=e.data.data;c.$log.info("[FileServerService] sendPartialDataToServer success"),n(t)},function(e){var t=c.errorHelperService.handleError(e);r(t),c.$log.error("[FileServerService] "+t.message)})})},e.prototype.uploadAFileByChunk=function(o,s,c,l){var d=this;this.$log.info("[FileServerService] >uploadAFileByChunk");var e=this.ONE_MEGABYTE;if(e<s.size){s.size>=100*e&&(e=s.size/100+this.ONE_KILOBYTE,this.$log.debug("[FileServerService] changing chunk size: "+e));var n=this.$q.defer();o.chunkTotalNumber=Math.ceil(s.size/e),o.chunkPerformed=0,o.chunkPerformedPercent=0,o.state="uploading";for(var u=[],t=function(e,n,t,r){var i=t<s.size?t:s.size,a=s.slice(n,i+1);u.push(function(){var t=d.$q.defer();return d.sendPartialDataToServer(o.id,a,s.size,n,i,e).then(function(e){return o.chunkPerformed++,o.chunkPerformedPercent=100*o.chunkPerformed/o.chunkTotalNumber,l(c,o),t.resolve(e)}).catch(function(e){d.$log.info("[FileServerService] error on chunk upload="+e),t.reject(e)}),t.promise})},r=0,i=0,a=e-1,f=Math.ceil(s.size/e);0<f;r++,f--,i+=e,a+=e)t(r,i,a);return this.transfertPromiseQueue.addPromiseArray(u,function(){d.$http({method:"PUT",url:d.portalURL+"/"+o.id+"/parts/end",headers:d.authService.getPostHeader("application/octet-stream"),uploadEventHandlers:{progress:function(e){d.$log.log(e)}}}).then(function(e){d.$log.info("[FileServerService] uploadAFileByChunk success"),o.state="uploaded",o.chunkPerformed=0,o.chunkTotalNumber=0,o.chunkPerformedPercent=0,l(c,o),d.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",url:d.portalURL+"/"+o.id+"/parts/end",fileId:o.id,mime:o.typeMIME,filename:s.name,filesize:s.size}),d.fileStorageService.orderDocuments(),d.fileStorageService.retrieveUserConsumption(),n.resolve(o)},function(e){var t=d.errorHelperService.handleError(e);d.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",url:d.portalURL+"/"+o.id+"/parts/end",fileId:o.id,mime:o.typeMIME,filename:s.name,filesize:s.size}),n.reject(t)})},function(e){var t=d.errorHelperService.handleError(e);d.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",url:d.portalURL+"/"+o.id+"/parts/end",fileId:o.id,mime:o.typeMIME,filename:s.name,filesize:s.size}),n.reject(t)}),n.promise}return l(c,o),this.uploadAFile(o.id,s,o.typeMIME).then(function(e){return d.$log.info("[FileServerService] uploadAFile success"),l(c,o),d.fileStorageService.retrieveUserConsumption(),d.$q.resolve(o)})},e.prototype.isTransferInProgress=function(){return this.transfertPromiseQueue.isTransferInProgress()},e.prototype.cancelAllTransfers=function(){this.transfertPromiseQueue.cancelAllTransfers()},e.prototype.getServercapabilities=function(){var r=this;return this.$q(function(t,n){r.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/fileserver/v1.0/capabilities",headers:r.authService.getRequestHeader()}).then(function(e){r.$log.info("[FileServerService] getServercapabilities -- success"),r.capabilities=e.data.data,t(r.capabilities)},function(e){var t=r.errorHelperService.handleError(e);r.$log.error("[FileServerService] getServercapabilities "+t.message),n(t)})})},e.prototype.getBlobFromUrlWithOptimization=function(l,d,u,e,t){var f=this;return void 0===u&&(u=0),void 0===e&&(e=""),void 0===t&&(t=""),0!==t.length&&(l+="?update="+MD5.hexdigest(t)),this.capabilities.maxChunkSizeDownload&&0!==u&&u>this.capabilities.maxChunkSizeDownload?this.$q(function(t,i){var e=f.capabilities.maxChunkSizeDownload;e>f.ONE_MEGABYTE&&(e=f.ONE_MEGABYTE);var n=0,r=e-1,a=Math.ceil(u/e),o=new Array(a);f.$log.debug("[FileServerService] getBlobFromUrlWithOptimization : "+a+" chunks to be downloaded");for(var s=[],c=0;0<a;c++,a--,n+=e,r+=e)s.push(f.getPartialDataFromServer(l,n,r,c).then(function(e){return o[e.index]=e.data,e.data}));f.$q.all(s).then(function(){var e=new Blob(o,{type:d});f.$log.debug("[FileServerService] getBlobFromUrlWithOptimization success"),t(e)},function(e){var t=f.errorHelperService.handleError(e),n=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e.data))),r=f.errorHelperService.getLocalizedError(n.errorDetailsCode);f.$log.error(r),i(t)})}):this.getBlobFromUrl(l,d,u,e)},e.prototype.getBlobUrlFromUrl=function(e,r,i,a){var o=this;return void 0===i&&(i=0),void 0===a&&(a=""),this.$q(function(t,n){o.getBlobFromUrlWithOptimization(e,r,i,a).then(function(e){t(URL.createObjectURL(e))}).catch(function(e){n(e)})})},e.$inject=["$q","$http","$log","authService","fileStorageService","TransfertPromiseQueue","FileDescriptorEventHandler","xmppService","errorHelperService","$rootScope","$interval"],e}();angular.module("rainbow").service("fileServerService",FileServerService);var FileStorageService=function(){function e(e,t,n,r,i,a,o,s,c,l,d,u,f,h){this.$injector=e,this.$q=t,this.$http=n,this.$log=r,this.$rootScope=i,this.authService=a,this.fileViewerFactory=o,this.errorHelperService=s,this.orderByFilter=c,this.contactService=l,this.fileTransfertService=d,this.helpersService=u,this.fileViewerElementFactory=f,this.fileDescriptorFactory=h,this.started=!1,this.rotationValues={1:"rotate(0deg)",3:"rotate(180deg)",6:"rotate(90deg)",8:"rotate(270deg)"}}return e.prototype.start=function(t){var r=this;this.$log.info("[FileStorageService] === STARTING ===");var n=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/filestorage/v1.0/files",this.fileDescriptors=[],this.fileDescriptorsByDate=[],this.fileDescriptorsByName=[],this.fileDescriptorsBySize=[],this.receivedFileDescriptors=[],this.receivedFileDescriptorsByName=[],this.receivedFileDescriptorsByDate=[],this.receivedFileDescriptorsBySize=[],this.consumptionData={},this.channelService=this.$injector.get("channelService"),this.retrieveFileDescriptorsListPerOwner().then(function(){return r.retrieveReceivedFiles(r.contactService.userContact.dbId)}).then(function(){return r.orderDocuments(),r.retrieveUserConsumption()}).then(function(){r.started=!0;var e=Math.round(performance.now()-n);t.push({service:"FileStorageService",startDuration:e}),r.$log.info("[FileStorageService] === STARTED ("+e+" ms) ===")}).catch(function(e){r.$log.error("[FileStorageService] === STARTING === failure -- "+e.message)}),this.$rootScope.$on("ROOM_UPDATE_EVENT",function(e,t,n){n&&"remove"===n&&(r.$log.info("[FileStorageService] ROOM_UPDATE_EVENT REMOVED for roomId="+t.dbId),r.removeRoomFileViewer(t))}),this.$q.when()},e.prototype.stop=function(){return this.$log.info("[FileStorageService] === STOPPING ==="),this.started&&(this.started=!1),this.$log.info("[FileStorageService] === STOPPED ==="),this.$q.when()},e.prototype.reinit=function(n){var r=this;return this.$q(function(e,t){if(!n)return r.$log.info("[FileStorageService] === reinit not blocking ==="),e(),void r.reinitInternal();r.$log.info("[FileStorageService] === reinit blocking ==="),r.reinitInternal().then(function(){e()}).catch(function(){t()})})},e.prototype.reinitInternal=function(){var n=this;return this.$q(function(e,t){n.retrieveFileDescriptorsListPerOwner().then(function(){return n.retrieveReceivedFiles(n.contactService.userContact.dbId)}).then(function(){n.orderDocuments(),n.$log.info("[FileStorageService] reinitInternal done"),e()}).catch(function(e){n.$log.error("[FileStorageService] reinitInternal failure -- "+e.message),t()})})},e.prototype.removeRoomFileViewer=function(t){var e;this.$log.info("[FileStorageService] >removeRoomFileViewer: "+t.dbId);do{if(e=this.getFileDescriptorByViewerId(t.dbId)){var n=e.viewers.find(function(e){return e.viewerId===t.dbId});n&&(this.$log.info("[FileStorageService] >viewer found delete it"),e.viewers.splice(e.viewers.indexOf(n),1))}}while(e)},e.prototype.getFileDescriptorByViewerId=function(e){for(var t=0,n=this.fileDescriptors;t<n.length;t++)for(var r=0,i=(s=n[t]).viewers;r<i.length;r++){if(i[r].viewerId===e)return s}for(var a=0,o=this.receivedFileDescriptors;a<o.length;a++){var s;if((s=o[a]).id===e)return s}return null},e.prototype.getFileDescriptorById=function(e){for(var t=0,n=this.fileDescriptors;t<n.length;t++){if((a=n[t]).id===e)return a}for(var r=0,i=this.receivedFileDescriptors;r<i.length;r++){var a;if((a=i[r]).id===e)return a}return null},e.prototype.getCompleteFileDescriptorById=function(s){var c=this;return this.$q(function(e,n){var t;if(c.fileDescriptors.some(function(e){return e.id===s&&(t=e,!0)})){for(var r=[],i=function(t){"user"===t.type&&r.push(c.contactService.getContactByDBId(t.viewerId).then(function(e){return t.contact=e,t}).catch(function(e){c.$log.error("[FileStorageService] "+e),n(e)}))},a=0,o=t.viewers;a<o.length;a++){i(o[a])}c.$q.all(r).then(function(){e(t)}).catch(function(e){c.$log.error("[FileStorageService] "+e),n(e)})}else n()})},e.prototype.getDocuments=function(){return this.fileDescriptors},e.prototype.getReceivedDocuments=function(){return this.receivedFileDescriptors},e.prototype.getDocumentsByName=function(e){return e?this.receivedFileDescriptorsByName:this.fileDescriptorsByName},e.prototype.getDocumentsByDate=function(e){return e?this.receivedFileDescriptorsByDate:this.fileDescriptorsByDate},e.prototype.getDocumentsBySize=function(e){return e?this.receivedFileDescriptorsBySize:this.fileDescriptorsBySize},e.prototype.getReceivedFilesFromContact=function(t){return this.receivedFileDescriptorsByDate.filter(function(e){return e.ownerId===t})},e.prototype.getSentFilesToContact=function(n){return this.fileDescriptorsByDate.filter(function(e){for(var t=0;t<e.viewers.length;t++)if(e.viewers[t].viewerId===n)return!0;return!1})},e.prototype.getReceivedFilesForRoom=function(n){var r=this;return this.receivedFileDescriptorsByDate.filter(function(e){for(var t=0;t<e.viewers.length;t++)if(e.viewers[t].viewerId===n&&e.ownerId!==r.contactService.userContact.dbId)return!0;return!1})},e.prototype.getConsumptionData=function(){return this.consumptionData},e.prototype.createFileDescriptor=function(e,t,i,a){var o=this;return this.$q(function(n,r){o.$http({method:"POST",url:o.portalURL,headers:o.authService.getRequestHeader(),data:{fileName:e,extension:t,size:i,viewers:a}}).then(function(e){var t=o.createFileDescriptorFromData(e.data.data);o.$log.info("[FileStorageService] createFileDescriptor -- "+t.id+" -- success"),t&&o.fileDescriptors.push(t),o.orderDocuments(),n(t)}).catch(function(e){var t=o.errorHelperService.handleError(e,"createFileDescriptor");o.$log.error("[FileStorageService] "+t.message),r(t)})})},e.prototype.createFileDescriptorFromData=function(e){if(e){var t=[];if(e.viewers)for(var n=0,r=e.viewers;n<r.length;n++){var i=r[n];t.push(this.fileViewerElementFactory(i.viewerId,i.type,i.contact,this.contactService,this.channelService))}var a=e.url;a||(a=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+e.id);var o="unknown";return o=e.isUploaded?"uploaded":"not_uploaded",this.fileDescriptorFactory(e.id,a,e.ownerId,e.fileName,e.extension,e.typeMIME,e.size,e.registrationDate,e.uploadedDate,e.dateToSort,t,o,e.thumbnail,e.orientation)}},e.prototype.deleteFileDescriptor=function(t){var r=this;return this.$q(function(e,n){r.$http({method:"DELETE",url:r.portalURL+"/"+t,headers:r.authService.getRequestHeader()}).then(function(){r.$log.info("[FileStorageService] deleteFileDescriptor -- success"),r.deleteFileDescriptorFromCache(t,!1),r.$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:t}),r.retrieveUserConsumption(),e(void 0)}).catch(function(e){var t=r.errorHelperService.handleError(e,"deleteFileDescriptor");n(t),r.$log.error("[FileStorageService] "+t.message)})})},e.prototype.deleteAllFileDescriptor=function(){var r=this;return this.$q(function(e,n){r.$http({method:"DELETE",url:r.portalURL+"/all",headers:r.authService.getRequestHeader()}).then(function(){r.$log.info("[FileStorageService] deleteAllFileDescriptor -- success"),r.deleteAllFilesDescriptorsFromCache(),r.retrieveUserConsumption(),e()}).catch(function(e){var t=r.errorHelperService.handleError(e,"deleteAllFileDescriptor");r.$log.error("[FileStorageService]"+t.message),n(t)})})},e.prototype.retrieveFileDescriptorsListPerOwner=function(){var d=this;return this.fileDescriptors||(this.fileDescriptors=[]),this.$q(function(l,n){d.$http({method:"GET",url:d.portalURL+"?format=full&limit=1000",headers:d.authService.getRequestHeader()}).then(function(e){d.fileDescriptors=[];var a=e.data.data;a||l();var t=e.data.limit,n=e.data.total,r=null;if(n<=t)r=d.$q.resolve([]);else{for(var i=t,o=n/t,s=[],c=1;c<o;c++)s.push(d.retrieveFileDescriptorsListPerOwnerwithOffset(i,t)),i+=t;r=d.$q.all(s)}r.then(function(e){e.forEach(function(e){a=a.concat(e)});for(var t=0,n=a;t<n.length;t++){var r=n[t],i=d.createFileDescriptorFromData(r);d.fileDescriptors.push(i)}d.$log.info("[FileStorageService] retrieveFileDescriptorsListPerOwner -- success"),l(d.fileDescriptors)})}).catch(function(e){var t=d.errorHelperService.handleError(e,"retrieveFileDescriptorsListPerOwner");n(t),d.$log.error("[FileStorageService] "+t.message)})})},e.prototype.retrieveFileDescriptorsListPerOwnerwithOffset=function(n,r){var i=this;return this.$q(function(t,e){i.$http({method:"GET",url:i.portalURL+"?format=full&limit="+r+"&offset="+n,headers:i.authService.getRequestHeader()}).then(function(e){t(e.data.data)})})},e.prototype.retrieveFilesReceivedFromPeer=function(e,t){var c=this;return this.$q(function(s,n){c.$http({method:"GET",url:c.portalURL+"/viewers/"+e+"?ownerId="+t+"&format=full",headers:c.authService.getRequestHeader()}).then(function(e){var t=[],n=e.data.data;if(n)for(var r=0,i=n;r<i.length;r++){var a=i[r],o=c.createFileDescriptorFromData(a);t.push(o)}c.$log.info("[FileStorageService] retrieveFilesReceivedFromPeer success"),s(t)}).catch(function(e){var t=c.errorHelperService.handleError(e,"retrieveFilesReceivedFromPeer");c.$log.error("[FileStorageService] "+t.message),n(t)})})},e.prototype.retrieveSentFiles=function(e){var c=this;return this.$q(function(s,n){c.$http({method:"GET",url:c.portalURL+"?format=full&viewerId="+e,headers:c.authService.getRequestHeader()}).then(function(e){var t=[],n=e.data.data;if(n)for(var r=0,i=n;r<i.length;r++){var a=i[r],o=c.createFileDescriptorFromData(a);t.push(o)}c.$log.info("[FileStorageService] retrieveSentFiles success"),s(t)}).catch(function(e){var t=c.errorHelperService.handleError(e,"retrieveSentFiles");c.$log.error("[FileStorageService] "+t.message),n(t)})})},e.prototype.retrieveReceivedFilesForRoom=function(e){var i=this;return this.$q(function(r,n){i.$http({method:"GET",url:i.portalURL+"/viewers/"+e+"?format=full",headers:i.authService.getRequestHeader()}).then(function(e){var t=e.data.data,n=[];t&&t.forEach(function(t){if(t.ownerId!==i.contactService.userContact.dbId){t.viewers=[];var e=i.createFileDescriptorFromData(t);n.push(e),i.receivedFileDescriptors.find(function(e){return e.id===t.id})||i.receivedFileDescriptors.push(e)}}),r(n)}).catch(function(e){var t=i.errorHelperService.handleError(e,"retrieveReceivedFilesForRoom");i.$log.error("[FileStorageService] "+t.message),n(t)})})},e.prototype.retrieveReceivedFiles=function(d){var u=this;return this.receivedFileDescriptors||(this.receivedFileDescriptors=[]),this.$q(function(l,n){u.$http({method:"GET",url:u.portalURL+"/viewers/"+d+"?format=full&limit=1000",headers:u.authService.getRequestHeader()}).then(function(e){u.receivedFileDescriptors=[];var o=e.data.data;if(o){var t=e.data.limit,n=e.data.total,r=null;if(n<=t)r=u.$q.resolve([]);else{for(var i=t,a=n/t,s=[],c=1;c<a;c++)s.push(u.retrieveReceivedFilesWithOffset(d,i,t)),i+=t;r=u.$q.all(s)}r.then(function(e){e.forEach(function(e){o=o.concat(e)});for(var t=0,n=o;t<n.length;t++){var r=n[t],i=u.createFileDescriptorFromData(r);if(i.ownerId!==u.contactService.userContact.dbId){var a=u.getFileDescriptorById(i.id);a&&(i.previewBlob=a.previewBlob),u.receivedFileDescriptors.push(i)}}u.orderReceivedDocuments(),u.$log.info("[FileStorageService] retrieveReceivedFiles -- success"),l(u.receivedFileDescriptors)})}else l()}).catch(function(e){var t=u.errorHelperService.handleError(e,"retrieveReceivedFiles");u.$log.error("[FileStorageService] "+t.message),n(t)})})},e.prototype.retrieveReceivedFilesWithOffset=function(n,r,i){var a=this;return this.$q(function(t,e){a.$http({method:"GET",url:a.portalURL+"/viewers/"+n+"?format=full&limit="+i+"&offset="+r,headers:a.authService.getRequestHeader()}).then(function(e){t(e.data.data)})})},e.prototype.retrieveUserConsumption=function(){var r=this;return this.$q(function(t,n){r.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/filestorage/v1.0/users/consumption",headers:r.authService.getRequestHeader()}).then(function(e){r.consumptionData=e.data.data,r.$log.info("[FileStorageService] retrieveUserConsumption success"),r.$rootScope.$broadcast("ON_CONSUMPTION_DATA_UPDATED_EVENT"),t(r.consumptionData)}).catch(function(e){var t=r.errorHelperService.handleError(e,"retrieveUserConsumption");r.$log.error("[FileStorageService] "+t.message),n(t)})})},e.prototype.deleteFileViewer=function(a,o){var s=this;return this.$q(function(i,n){s.$http({method:"DELETE",url:s.portalURL+"/"+o+"/viewers/"+a,headers:s.authService.getRequestHeader()}).then(function(e){s.$log.info("[FileStorageService] deleteFileViewer "+e.statusText);var t=s.getFileDescriptorById(o);if(t){for(var n=-1,r=0;r<t.viewers.length;r++)if(t.viewers[r].viewerId===a){n=r;break}-1!==n&&t.viewers.splice(n,1)}i()},function(e){var t=s.errorHelperService.handleError(e,"deleteFileViewer");n(t),s.$log.error("[FileStorageService] "+t.message)})})},e.prototype.addFileViewer=function(a,o,e){var s=this,t=this.getFileDescriptorById(a);return t&&t.isAlreadyFileViewer(o)?this.$q.resolve(t):this.$q(function(r,i){s.$http({method:"POST",url:s.portalURL+"/"+a+"/viewers",headers:s.authService.getRequestHeader(),data:{viewerId:o,type:e}}).then(function(e){s.$log.info("[FileStorageService] addFileViewer success");var t=s.getFileDescriptorById(a);if(t){var n=s.fileViewerFactory([{viewerId:e.data.data.viewerId,type:e.data.data.type}])[0];"user"===n.type?s.contactService.getContactByDBId(o).then(function(e){n.contact=e,t.viewers.push(n),r(t)}).catch(function(e){s.$log.error("[FileStorageService] "+e),i(e)}):(t.viewers.push(n),r(t))}},function(e){var t=s.errorHelperService.handleError(e,"addFileViewer");i(t),s.$log.error("[FileStorageService] "+t.message)})})},e.prototype.copyFileToUserCloudStorage=function(r){var i=this;return this.$q(function(t,n){i.$http({method:"POST",url:i.portalURL+"/"+r+"/copy",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[FileStorageService] copyFileToUserCloudStorage | copyFile "+r+" -- success"),i.retrieveAndStoreOneFileDescriptor(e.data.data.id,!0).then(function(e){t(e)}).catch(function(e){n(e)})}).catch(function(e){var t=i.errorHelperService.handleError(e,"copyFileToUserCloudStorage");i.$log.error("[FileStorageService] copyFileToUserCloudStorage "+t.message),n(t)})})},e.prototype.retrieveOneFileDescriptor=function(i){var a=this;return this.$q(function(n,r){a.$http({method:"GET",url:a.portalURL+"/"+i+"?format=full",headers:a.authService.getRequestHeader()}).then(function(e){var t=a.createFileDescriptorFromData(e.data.data);a.$log.info("[FileStorageService] getOneFileDescriptor "+i+" -- success"),n(t)}).catch(function(e){var t=a.errorHelperService.handleError(e,"getOneFileDescriptor");a.$log.error("[FileStorageService] "+t.message),r(t)})})},e.prototype.retrieveAndStoreOneFileDescriptor=function(e,t){var r=this,i=this.getFileDescriptorById(e);return i&&!t?(this.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- return existing fileDescriptor "+e),this.$q.resolve(i)):this.retrieveOneFileDescriptor(e).then(function(t){i&&i.isImage()&&(t.previewBlob=i.previewBlob);var e=r.helpersService.findIndex(r.fileDescriptors,function(e){return e.id===t.id});-1<e&&r.fileDescriptors.splice(e,1);var n=r.helpersService.findIndex(r.receivedFileDescriptors,function(e){return e.id===t.id});if(-1<n&&r.receivedFileDescriptors.splice(n,1),t.ownerId===r.contactService.userContact.dbId)r.fileDescriptors.push(t),r.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+t.id+" -- now stored in my files");else{r.receivedFileDescriptors.push(t),r.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+t.id+" -- now stored in received files"),r.$rootScope.$broadcast("ON_MESSAGE_WITH_FILE_RECEIVED_EVENT")}return r.orderDocuments(),r.$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:t.id}),r.$q.resolve(t)}).catch(function(e){r.$log.warn("[FileStorageService] Error on getting FileDescriptor: "+e.errorDetailsCode);var t=r.errorHelperService.handleError(e,"retrieveAndStoreOneFileDescriptor");return 400<=t.status&&t.status<500&&i&&(404===t.status&&r.deleteFileDescriptorFromCache(i.id,!0),r.orderDocuments(),r.$log.debug("[FileStorageService] Sending ON_FILE_REMOVED_FROM_STORE_EVENT"),r.$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:i.id})),r.$q.reject(e)})},e.prototype.deleteFileDescriptorFromCache=function(e,t){this.$log.info("[FileStorageService] deleteFileDescriptorFromCache "+e);for(var n=0;n<this.receivedFileDescriptors.length;n++)if(this.receivedFileDescriptors[n].id===e){this.receivedFileDescriptors.splice(n,1);break}for(n=0;n<this.fileDescriptors.length;n++)if(this.fileDescriptors[n].id===e){t?this.fileDescriptors.splice(n,1):this.fileDescriptors[n].state="deleted";break}this.orderDocuments()},e.prototype.deleteAllFilesDescriptorsFromCache=function(){var r=this;this.$log.info("[FileStorageService] deleteAllFilesDesceiptorsFromCache"),this.fileDescriptors.forEach(function(n){n.state="deleted",r.receivedFileDescriptors.forEach(function(e,t){e.id===n.id&&r.receivedFileDescriptors.splice(t,1)})}),this.fileDescriptors=[],this.orderDocuments()},e.prototype.orderDocuments=function(){this.$log.debug("[FileStorageService] orderDocuments: "+this.fileDescriptors.length),this.replaceOrderedByFilter(this.fileDescriptorsByDate,this.fileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.fileDescriptorsByName,this.fileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.fileDescriptorsBySize,this.fileDescriptors,this.getSize,!1,this.sortBySize),this.orderReceivedDocuments()},e.prototype.orderReceivedDocuments=function(){this.$log.debug("[FileStorageService] orderReceivedDocuments: "+this.receivedFileDescriptors.length),this.replaceOrderedByFilter(this.receivedFileDescriptorsByName,this.receivedFileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.receivedFileDescriptorsByDate,this.receivedFileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.receivedFileDescriptorsBySize,this.receivedFileDescriptors,this.getSize,!1,this.sortBySize)},e.prototype.orderDocumentsForRoom=function(e){return this.orderByFilter(e,this.getDate,!1,this.sortByDate)},e.prototype.replaceOrderedByFilter=function(e,t,n,r,i){this.$log.debug("[FileStorageService] replaceOrderedByFilter");for(var a=e.length=0,o=this.orderByFilter(t,n,r,i);a<o.length;a++){var s=o[a];"deleted"!==s.state&&e.push(s)}},e.prototype.getName=function(e){var t,n={name:"",date:""};return e.fileName&&(n.name=e.fileName),t=e.uploadedDate?new Date(e.uploadedDate):e.registrationDate?new Date(e.registrationDate):new Date(e.dateToSort),n.date=t.getTime(),n},e.prototype.getDate=function(e){return(e.uploadedDate?new Date(e.uploadedDate):e.registrationDate?new Date(e.registrationDate):new Date(e.dateToSort)).getTime()},e.prototype.getSize=function(e){var t={name:"",size:""};return e.name&&(t.name=e.fileName),t.size=e.size,t},e.prototype.sortByName=function(e,t){var n=-1;return e.value.name&&t.value.name&&0===(n=e.value.name.localeCompare(t.value.name))&&(n=t.value.date-e.value.date),n},e.prototype.sortBySize=function(e,t){var n=-1;return e.value.size&&t.value.size&&(n=t.value.size-e.value.size),n},e.prototype.sortByDate=function(e,t){var n=1;return e&&t&&(n=t.value-e.value),n},e.prototype.extractFileIdFromUrl=function(e){var t=e.split("/");return t.pop()||t.pop()},e.$inject=["$injector","$q","$http","$log","$rootScope","authService","fileViewerFactory","errorHelperService","orderByFilter","contactService","fileTransfertService","helpersService","fileViewerElementFactory","fileDescriptorFactory"],e}();angular.module("rainbow").service("fileStorageService",FileStorageService),angular.module("rainbow").factory("FileDescriptorEventHandler",["$log","$rootScope","contactService",function(l,d,s){"use strict";function t(e){this.fileServerService=e,this.fileStorageService=e.getFileStorageService()}return t.create=function(e){return new t(e)},t.prototype.onManagementMessageReceived=function(e){try{var t=$(e);return 0<t.find("file").length?this.manageFileStanzaData(t.find("file")):0<t.find("thumbnail").length?this.manageThumbnailStanzaData(t.find("thumbnail")):l.info("[FileDescriptorEventHandler] onManagementMessageReceived  -- ignore the message"),!0}catch(e){return l.error("[FileDescriptorEventHandler] onManagementMessageReceived ERROR "+e),!0}},t.prototype.manageFileStanzaData=function(e){for(var t=$(e).attr("action"),n=$(e).find("fileid"),r=!1,i=0;i<n.length;i++){var a=$(n[i]).text(),o=this.fileStorageService.getFileDescriptorById(a);switch(l.info("[FileDescriptorEventHandler] manageFileStanzaData -- "+t+" fileDescriptor "+a),t){case"create":l.debug("[FileDescriptorEventHandler] fileDescriptor "+a+" created on server -- do nothing");break;case"delete":o&&(o.ownerId===s.userContact.dbId&&"deleted"!==o.state&&(r=!0),this.fileStorageService.deleteFileDescriptorFromCache(a),d.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:a}));break;case"update":o||(r=!0),this.fileStorageService.retrieveAndStoreOneFileDescriptor(a,!0)}}r&&this.fileStorageService.retrieveUserConsumption()},t.prototype.manageThumbnailStanzaData=function(e){var t=$(e).attr("action"),n=$(e).find("fileid").text(),r=$(e).find("url").text(),i=$(e).find("mime").text(),a=$(e).find("filename").text(),o=$(e).find("size").text(),s=$(e).find("md5sum").text();if(l.info("[FileDescriptorEventHandler] manageThumbnailStanzaData -- "+t+" fileDescriptor "+n),l.debug("[FileDescriptorEventHandler]   fileUrl="+r),l.debug("[FileDescriptorEventHandler]   fileMime="+i),l.debug("[FileDescriptorEventHandler]   fileName="+a),l.debug("[FileDescriptorEventHandler]   fileSize="+o),l.debug("[FileDescriptorEventHandler]   md5sum="+s),l.debug("[FileDescriptorEventHandler]   fileId="+n),"create"===t||"update"===t){var c=this.fileStorageService.getFileDescriptorById(n);c?(l.debug("[FileDescriptorEventHandler] updating Thumbnail of found FileDescriptor "+n),c.previewBlob&&!c.thumbnail.availableThumbnail||!c.previewBlob?(d.$broadcast("ON_FILE_DESCRIPTOR_THUMBNAIL_READY",c.id),c.thumbnail.availableThumbnail=!0,c.thumbnail.md5sum=s,c.thumbnail.size=o,l.info("[FileDescriptorEventHandler] preview not already downloaded for "+n+" -- download it"),this.fileServerService.getBlobThumbnailFromFileDescriptor(c).then(function(){d.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:c.id})})):(d.$broadcast("ON_FILE_DESCRIPTOR_THUMBNAIL_READY",c.id),l.info("[FileDescriptorEventHandler] preview already downloaded for "+n+" -- do nothing"))):l.error("[FileDescriptorEventHandler] FileDescriptor not found and we do nothing and its not OK")}},t}]),angular.module("rainbow").service("extensionSharingService",["$q","$log","$rootScope",function(a,n,o){"use strict";var s=this;this.extensionFound=!1,this.minVersion="1.5.1",this.port=null,this.currentStreamId="screen",this.start=function(){this.extensionId=this.extensionId||this.getExtensionId(config.webservices.server);var t=a.defer();return n.info("[extensionService] === STARTING ==="),config.extensionSharing?window.chrome&&window.chrome.runtime?(n.info("[extensionService] Chrome extension - try to ping...",this.extensionId),chrome.runtime.sendMessage(this.extensionId,{type:"ping",data:null},null,function(e){e&&"pong"===e.type?(n.info("[extensionService] Chrome extension - pong received"),n.info("[extensionService] Chrome extension - extension installed and detected"),n.info("[extensionService] Chrome extension - try to connect..."),s.port=chrome.runtime.connect(s.extensionId),s.port?(n.info("[extensionService] Chrome extension - port created"),s.port.onDisconnect.addListener(function(){n.info("Extension DISCONNECTED"),s.extensionFound=!1,s.port=null}),s.port.onMessage.addListener(function(e){switch(n.info("[extensionService] Chrome extension - connected"),e.type){case"loginResponse":s.extensionFound=!0,n.info("[extensionService] Chrome extension - ready!"),n.info("[extensionService] === STARTED ==="),o.$broadcast("ON_EXTENSION_SHARING_READY"),t.resolve();break;case"getVersionResponse":0===e.code&&e.version?(o.$broadcast("ON_EXTENSION_VERSION_UPDATED",e.version),n.info("[extensionService] Chrome extension - Detected version "+e.version)):(o.$broadcast("ON_EXTENSION_VERSION_UPDATED",null),n.error("[extensionService] Chrome extension - No version received"));break;case"startsharingResponse":0===e.code&&e.streamID?(n.info("[extensionService] Chrome extension - stream ID received "+e.streamID),o.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",e.streamID)):(n.info("[extensionService] Chrome extension - No stream ID received"),o.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",null));break;case"endsharingResponse":n.info("[extensionService] Chrome extension - end sharing session received")}}),s.port.postMessage({type:"login",data:null})):(n.info("[extensionService] Chrome extension - can't create port to contact the extension!!!"),n.info("[extensionService] === STARTED ==="),t.resolve())):(n.info("[extensionService] Chrome extension - not found"),chrome.runtime.lastError&&n.info("[extensionService] Chrome extension - error "+chrome.runtime.lastError),t.resolve())})):(n.info("[extensionService] Not in chrome"),n.info("[extensionService] === STARTED ==="),t.resolve()):(n.info("[extensionService] === STARTED ==="),t.resolve()),t.promise},this.stop=function(){return n.info("[extensionService] === STOPPING ==="),n.info("[extensionService] === STOPPED ==="),a.when()},this.getExtensionId=function(e){return n.info("Detected domain : "+e),-1!==e.indexOf("openrainbow.net")?"koefhabbjedbiecnldkolbijjfjinogj":-1!==e.indexOf("openrainbow.org")?"ehamhlkmecdnidihfedapmplddlbidee":(-1!==e.indexOf("openrainbow.com")||n.error("Unkown domain, extension may not be available"),"mgneongoclkopahpapenfhbbeckhdmnj")},this.setExtensionId=function(e){n.info("set extensionId to : "+e),this.extensionId=e},this.getStreamToShareFromExtension=function(n){var r=a.defer(),i=o.$on("ON_EXTENSION_SHARING_STREAM_FOUND",function(e,t){s.currentStreamId=t,i(),t?(n.video.mandatory.chromeMediaSourceId=t,r.resolve()):r.reject()});return this.port.postMessage({type:"startsharing",data:null}),r.promise},this.getStreamId=function(){return this.currentStreamId},this.isExtensionInstalled=function(){var e=a.defer();return this.extensionFound?e.resolve(!0):this.start().then(function(){e.resolve(s.extensionFound)}),e.promise},this.getExtensionVersion=function(){var n=a.defer(),r=o.$on("ON_EXTENSION_VERSION_UPDATED",function(e,t){r(),t?n.resolve(t):n.reject()});return this.port.postMessage({type:"getVersion",data:null}),n.promise},this.checkExtensionStatus=function(){var t=a.defer();return"chrome"!==adapter.browserDetails.browser?t.resolve("notNeeded"):this.isExtensionInstalled().then(function(e){e?s.checkVersion().then(function(e){e?t.resolve("good"):t.resolve("needUpdate")}):t.resolve("notInstalled")}),t.promise},this.checkVersion=function(){var t=a.defer();return this.getExtensionVersion().then(function(e){t.resolve(0<=s.cmpVersions(e,s.minVersion))}),t.promise},this.cmpVersions=function(e,t){var n,r,i=/(\.0+)+$/,a=e.replace(i,"").split("."),o=t.replace(i,"").split("."),s=Math.min(a.length,o.length);for(n=0;n<s;n++)if(r=parseInt(a[n],10)-parseInt(o[n],10))return r;return a.length-o.length}}]);var PstnConferenceService=function(){function e(e,t,n,r,i,a,o,s,c,l,d,u,f,h){this.$q=e,this.$rootScope=t,this.$log=n,this.$http=r,this.authService=i,this.errorHelperService=a,this.ConferenceSession=o,this.profileService=s,this.xmppService=c,this.countryService=l,this.Conference=d,this.contactService=u,this.$translate=f,this.conferenceUserFactory=h,this.MEDIATYPE={PSTNAUDIO:"pstnAudio",WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.listeners=[],this.conferenceProvisionRef=null,this.isPstnConferenceAvailable=!1,this.conferenceSessions={},this.pstnConferenceEndpoints={},this.pstnConferenceUser=null,this.pstnInstantConferenceEndpoint=null,this.pstnConferencePhoneNumbers=null}return e.prototype.start=function(r){var i=this;return this.$q(function(e){var t=performance.now();i.$log.info("[PstnConferenceService] === STARTING ==="),i.isPstnConferenceAvailable=!1,i.conferenceSessions={},i.pstnConferenceEndpoints={},i.pstnConferenceUser=null,i.pstnInstantConferenceEndpoint=null,i.pstnConferencePhoneNumbers=null,i.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",i.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",i.listeners.push(i.$rootScope.$on("ON_PROFILE_FEATURES_UPDATED",function(){i.onMyProfileFeaturesChanged()})),i.started=!0;var n=Math.round(performance.now()-t);r.push({service:"pstnConferenceService",startDuration:n}),i.$log.info("[PstnConferenceService] === STARTED ("+n+" ms) ==="),e()})},e.prototype.stop=function(){var t=this;return this.$q(function(e){t.$log.info(""),t.$log.info("[PstnConferenceService] === STOPPING ==="),t.listeners&&t.listeners.forEach(function(e){e()}),t.started=!1,t.$log.info("[PstnConferenceService] === STOPPED ==="),e()})},e.prototype.onMyProfileFeaturesChanged=function(){var e=this,t=this.isPstnConferenceAvailable;this.computePstnConferencePremission(),!1===this.isPstnConferenceAvailable&&!0===t&&this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"pgiRightsRemovedWarning",okLabel:"ok"}),this.retrievePstnConferences().then(function(){return e.pstnInstantConferenceEndpoint?e.retrieveConferenceUser(e.contactService.userContact.dbId):e.$q.when()})},e.prototype.updateConference=function(e,t){var i=this;return this.$log.info("[PstnConferenceService] updateConference"),this.$q(function(r,n){if(e)i.$http({method:"PUT",url:i.confProvPortalURL+"conferences/"+e,headers:i.authService.getRequestHeader(),data:t}).then(function(e){var t=e.data.data,n=i.Conference.createFromData(t);t.hasOwnProperty("id")&&(i.pstnConferenceEndpoints[t.id]&&delete i.pstnConferenceEndpoints[t.id],i.pstnConferenceEndpoints[t.id]=n,t.scheduled||(delete i.pstnInstantConferenceEndpoint,i.pstnInstantConferenceEndpoint=n)),i.$log.info("[PstnConferenceService] updateConference successfully"),r(n)},function(e){var t="updateConference failure: "+(e.data?e.data.errorDetails:e.data);i.$log.error("[PstnConferenceService] "+t),n(new Error(t))});else{i.$log.error("[PstnConferenceService] updateConference failure : No confEndpoint"),n(new Error("updateConference failure: No confEndpoint"))}})},e.prototype.retrieveConferenceUser=function(e){var i=this;return this.$log.info("[PstnConferenceService] retrieveConferenceUser"),e?this.pstnConferenceUser?this.$q.resolve(this.pstnConferenceUser):this.$q(function(n,r){i.$http({method:"GET",url:i.confProvPortalURL+"users?userId="+e,headers:i.authService.getRequestHeader()}).then(function(e){var t=e.data.data;t&&t.length?(i.pstnConferenceUser=i.conferenceUserFactory(t[0]),i.$log.info("[PstnConferenceService] retrieveConferenceUser successfully"),n(i.pstnConferenceUser)):(i.$log.warn("[PstnConferenceService] retrieveConferenceUser no ConferenceUser found"),r())},function(e){var t="retrieveConferenceUser failure: "+(e.data?e.data.errorDetails:e.data);i.$log.error("[PstnConferenceService] "+t),r(new Error(t))})}):(this.$log.warn("[PstnConferenceService] retrieveConferenceUser missing userId"),this.$q.reject())},e.prototype.retrievePstnConferences=function(t,i){var a=this;return this.$log.info("[PstnConferenceService] retrievePstnConferences with scheduled="+t),this.$q(function(n,r){if(!a.isPstnConferenceAvailable)return a.$log.warn("[PstnConferenceService] retrieveConference - user is not allowed"),void r(new Error("notAllowed"));var e="?format=full&userId="+a.contactService.userContact.dbId+"&mediaType="+a.MEDIATYPE.PSTNAUDIO;angular.isDefined(t)&&(e+="&scheduled="+t),i&&(e+="&provisioning=true"),a.$http({method:"GET",url:a.confProvPortalURL+"conferences"+e,headers:a.authService.getRequestHeader()}).then(function(e){var t=e.data.data;a.$log.info("[PstnConferenceService] retrievePstnConferences successfully"),n(t)},function(e){var t="retrievePstnConferences failure: "+(e.data?e.data.errorDetails:e.data);a.$log.error("[PstnConferenceService] "+t),r(new Error(t))})})},e.prototype.computePstnConferencePremission=function(){var t=this,e=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED),n=!0,r=this.profileService.getMyProfiles();r&&0<r.length&&r.forEach(function(e){-1!==e.profileName.toLowerCase().indexOf("conference")&&-1!==e.status.toLowerCase().indexOf("active")&&e.provisioningNeeded&&0<e.provisioningNeeded.length&&e.provisioningNeeded.forEach(function(e){-1!==e.providerType.toLowerCase().indexOf("pgi")&&(n=e.provisioningOngoing)&&(t.conferenceProvisionRef&&(t.xmppService.connection.deleteHandler(t.conferenceProvisionRef),t.conferenceProvisionRef=null),t.conferenceProvisionRef=t.xmppService.connection.addHandler(function(e){return t.onConferenceProvisionUpdate(e)},null,"message","management"))})}),this.isPstnConferenceAvailable=e&&!n,this.$rootScope.$broadcast("ON_CONFERENCE_FEATURES_UPDATED")},e.prototype.onConferenceProvisionUpdate=function(e){return 0<$(e).find("confuseractivated ").length&&(this.conferenceProvisionRef&&(this.xmppService.connection.deleteHandler(this.conferenceProvisionRef),this.conferenceProvisionRef=null),this.isPstnConferenceAvailable=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED),this.$rootScope.$broadcast("ON_CONFERENCE_FEATURES_UPDATED")),!0},e.prototype.updateOrCreateConferenceSession=function(e,t){var n=this;if(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession for "+e),!e||!t||!t.data)return this.$log.error("[PstnConferenceService] updateOrCreateConferenceSession - Not enough data"),null;var r=this.conferenceSessions[e];return r?t.data.active!==r.active&&(this.$log.debug((t.data.active,"active")),r.updateActiveState(t.data.active),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r)):(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession - create new conferencesession with id "+e+"and data: \n"+JSON.stringify(t.data)),r=this.ConferenceSession.createFromData(e,[],t.data.active,this.MEDIATYPE.PSTNAUDIO),this.conferenceSessions[e]=r,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r)),t.data.participants&&0<t.data.participants.length&&(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession - update participants for "+e+" with:\n"+JSON.stringify(t.data.participants)),r.updateParticipants(t.data.participants).then(function(){n.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",r)})),r},e.prototype.updateOrCreatePstnConferenceEndpoint=function(e){if(this.$log.info("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint for "+e.id),!e)return this.$log.error("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint - no conference data !"),null;if(e.mediaType!==this.MEDIATYPE.PSTNAUDIO)return this.$log.error("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint - wrong mediaType:"+e.mediaType),null;var t=this.Conference.createFromData(e);return(this.pstnConferenceEndpoints[e.id]=t).scheduled||(this.pstnInstantConferenceEndpoint=t,this.pstnInstantConferenceEndpoint.name||this.updateConference(this.pstnInstantConferenceEndpoint.id,{name:this.$translate.instant("namePersonalConference",{name:this.contactService.userContact.displayName})})),this.pstnConferenceEndpoints[e.id]},e.prototype.formatPstnPhoneNumbers=function(e){var n=this;this.$log.info("[PstnConferenceService] formatPstnPhoneNumbers");var r={};return e.forEach(function(e){if(e.locationcode){var t=n.countryService.getAlpha2Code(e.locationcode.substr(0,3));t&&(r[t]||(r[t]={numbersList:[]})),r[t].numbersList.push({number:e.number,locationName:e.location,city:e.location.split(", ")[1],numberType:e.numberType,needLanguageSelection:e.needLanguageSelection})}}),r},e.prototype.retrievePstnPhoneNumbers=function(r){var i=this;return this.$log.info("[ConferenceService] retrievePstnPhoneNumbers"),this.pstnConferencePhoneNumbers?r?this.$q.resolve(this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers)):this.$q.resolve(this.pstnConferencePhoneNumbers):this.$q(function(t,n){i.$http({method:"GET",url:i.confProvPortalURL+"conferences/audio/phonenumbers?shortList=false",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[PstnConferenceService] retrievePstnPhoneNumbers successfully"),i.pstnConferencePhoneNumbers=e.data.data.phoneNumberList,t(r?i.formatPstnPhoneNumbers(i.pstnConferencePhoneNumbers):i.pstnConferencePhoneNumbers)},function(e){var t="retrievePstnPhoneNumbers failure: "+(e.data?e.data.errorDetails:e.data);i.$log.error("[PstnConferenceService] "+t),n(new Error(t))})})},e.prototype.retrievePstnInstantConference=function(){var r=this;return this.isPstnConferenceAvailable?this.retrievePstnConferences(!1).then(function(n){return n.forEach(function(e){if(e.hasOwnProperty("id")){var t=r.Conference.createFromData(e);t.mediaType!==r.MEDIATYPE.PSTNAUDIO||t.userId!==r.contactService.userContact.dbId||t.scheduled||(r.pstnConferenceEndpoints[n.id]=t,r.pstnInstantConferenceEndpoint=t,r.pstnInstantConferenceEndpoint.name||r.updateConference(r.pstnInstantConferenceEndpoint.id,{name:r.$translate.instant("namePersonalConference",{name:r.contactService.userContact.displayName})}))}}),!r.pstnInstantConferenceEndpoint&&r.isPstnConferenceAvailable&&(r.$log.info("[PstnConferenceService] User has no instant conference : we create a new one"),r.retrieveConferenceUser(r.contactService.userContact.dbId).then(function(e){r.createInstantConference(e.id,"instantConference").then(function(e){r.pstnInstantConferenceEndpoint=e})})),r.$q.resolve()},function(){return r.$log.warn("[PstnConferenceService] retrievePstnInstantConference - issue retrieving instant conference"),r.$q.resolve()}):(this.$log.info("[PstnConferenceService] retrievePstnInstantConference -- No conference rights"),this.$q.resolve())},e.prototype.createInstantConference=function(e,t){var i=this;return void 0===t&&(t=""),this.$q(function(r,n){i.$log.info("[PstnConferenceService] createInstantConference"),i.$http({method:"POST",url:i.confProvPortalURL+"conferences",headers:i.authService.getRequestHeader(),data:{confUserId:e,name:t}}).then(function(e){var t=e.data.data,n=i.Conference.createFromData(t);t.hasOwnProperty("id")&&(i.pstnConferenceEndpoints[t.id]=n),i.$log.info("[PstnConferenceService] createInstantConference successfully"),r(n)},function(e){var t="createInstantConference failure: "+(e.data?e.data.errorDetails:e.data);i.$log.error("[PstnConferenceService] "+t),n(new Error(t))})})},e.prototype.getConferenceSessionById=function(e){return this.conferenceSessions[e]},e.prototype.removeConferenceSession=function(e){e&&delete this.conferenceSessions[e]},e.prototype.initiatesCallParticipant=function(i,e,t,a){var o=this;return this.$log.info("[PstnConferenceService] initiatesCallParticipant( confId="+i+", PhoneNumber="+e+", role="+t.role+" country = "+a+" )"),i&&e?this.$q(function(n,r){o.$http({method:"POST",url:o.confPortalURL+i+"/join",headers:o.authService.getPostHeader(),data:{participantPhoneNumber:e,participant:t,country:a}}).then(function(e){var t=e.data.status;o.$log.info("[PstnConferenceService] initiatesCallParticipant( confId="+i+") success : "+t),n()},function(e){var t=e.data?e.data.errorDetails:e.data,n="initiatesCallParticipant( confId="+i+") failure: "+t;o.$log.error("[PstnConferenceService] "+n),r(new Error(n))})}):(this.$log.error("[PstnConferenceService] initiatesCallParticipant - missing parameter"),this.$q.reject())},e.prototype.initiatesAudio=function(t){var r=this;return this.$log.info("[PstnConferenceService] initiatesAudio( confId="+t+")"),t?this.conferenceSessions[t]&&this.conferenceSessions[t].isActive()?(this.$log.info("[PstnConferenceService] initiatesAudio : conference already started"),this.$q.resolve()):this.$q(function(e,n){r.$http({method:"PUT",url:r.confPortalURL+t+"/start",headers:r.authService.getRequestHeader()}).then(function(){r.$log.info("[PstnConferenceService] initiatesAudio( confId="+t+") successfully"),e()},function(e){var t=r.errorHelperService.handleError(e);n(t)})}):(this.$log.error("[PstnConferenceService] initiatesAudio - missing parameter"),this.$q.reject())},e.prototype.initiatesAudioRecording=function(i,a,t,n){var o=this;return this.$log.info("[PstnConferenceService] initiatesAudioRecording( confId="+i+"participantId="+a+"fileName="+t+"fileExtension="+n+")"),i&&a?this.$q(function(e,r){o.$http({method:"POST",url:o.confPortalURL+i+"/participants/"+a+"/start-recording",headers:o.authService.getPostHeader(),data:{fileName:t,fileExtension:n}}).then(function(){o.$log.info("[PstnConferenceService] initiatesAudioRecording( confId="+i+"participantId="+a+") successfully"),e()},function(e){var t=e.data?e.data.errorDetails:e.data,n="initiatesAudioRecording( confId="+i+"participantId="+a+") failure: "+t;o.$log.error("[PstnConferenceService] "+n),r(new Error(n))})}):(this.$log.error("[PstnConferenceService] initiatesAudioRecording - missing parameter"),this.$q.reject())},e.prototype.stopsAudioRecording=function(i,a){var o=this;return this.$q(function(e,r){if(o.$log.info("[PstnConferenceService] stopsAudioRecording( confId="+i+"participantId="+a+")"),!i||!a)return o.$log.error("[PstnConferenceService] initiatesAudioRecording - missing parameter"),o.$q.reject();o.$http({method:"POST",url:o.confPortalURL+i+"/participants/"+a+"/stop-recording",headers:o.authService.getPostHeader()}).then(function(){o.$log.info("[PstnConferenceService] stopsAudioRecording( confId="+i+"participantId="+a+") successfully"),e()},function(e){var t=e.data?e.data.errorDetails:e.data,n="stopsAudioRecording( confId="+i+"participantId="+a+") failure: "+t;o.$log.error("[PstnConferenceService] "+n),r(new Error(n))})})},e.prototype.pausesAudioRecording=function(i,a){var o=this;return this.$q(function(e,r){if(o.$log.info("[PstnConferenceService] pausesAudioRecording( confId="+i+"participantId="+a+")"),!i||!a)return o.$log.error("[PstnConferenceService] pausesAudioRecording - missing parameter"),o.$q.reject();o.$http({method:"POST",url:o.confPortalURL+i+"/participants/"+a+"/pause-recording",headers:o.authService.getPostHeader()}).then(function(){o.$log.info("[PstnConferenceService] pausesAudioRecording( confId="+i+"participantId="+a+") successfully"),e()},function(e){var t=e.data?e.data.errorDetails:e.data,n="pausesAudioRecording( confId="+i+"participantId="+a+") failure: "+t;o.$log.error("[PstnConferenceService] "+n),r(new Error(n))})})},e.prototype.resumesAudioRecording=function(i,a){var o=this;return this.$q(function(e,r){if(o.$log.info("[PstnConferenceService] resumesAudioRecording( confId="+i+"participantId="+a+")"),!i||!a)return o.$log.error("[PstnConferenceService] resumesAudioRecording - missing parameter"),o.$q.reject();o.$http({method:"POST",url:o.confPortalURL+i+"/participants/"+a+"/resume-recording",headers:o.authService.getPostHeader()}).then(function(){o.$log.info("[PstnConferenceService] resumesAudioRecording( confId="+i+"participantId="+a+") successfully"),e()},function(e){var t=e.data?e.data.errorDetails:e.data,n="resumesAudioRecording( confId="+i+"participantId="+a+") failure: "+t;o.$log.error("[PstnConferenceService] "+n),r(new Error(n))})})},e.prototype.makeSnapshotForConfId=function(r){var i=this;if(void 0===r&&(r=null),!r){var e="[PstnConferenceService] makeSnapshotForConfId - No confId !!";return this.$log.error(e),this.$q.reject(e)}return this.$q(function(n,t){i.$http({method:"GET",url:i.confPortalURL+r+"/snapshot?mediaType=pstnAudio",headers:i.authService.getRequestHeader()}).then(function(e){i.$log.info("[PstnConferenceService] makeSnapshotForConfId success for confId "+r);var t=e.data;i.updateOrCreateConferenceSession(r,t),n(t.data)}).catch(function(e){i.$log.info("[PstnConferenceService] makeSnapshotForConfId failure for confID "+r),404===e.status?i.$log.error("[PstnConferenceService] makeSnapshotForConfId - confId "+r+" not found on server"):i.$log.error("[PstnConferenceService] makeSnapshotForConfId - inconsistent object on server"),i.conferenceSessions[r]&&i.removeConferenceSession(r),t()})})},e.prototype.refreshConferenceSessions=function(){var a=this;return this.$log.info("[PstnConferenceService] refreshConferenceSessions"),this.$q(function(e,t){var n=[];for(var r in a.conferenceSessions)if(a.conferenceSessions.hasOwnProperty(r)){var i=a.conferenceSessions[r];n.push(a.makeSnapshotForConfId(i.id))}a.$q.all(n).then(function(){a.$log.info("[PstnConferenceService] refreshConferenceSessions -- success"),e()}).catch(function(){a.$log.error("[PstnConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions"),a.removeAllConferenceSessions(),t()})})},e.prototype.removeAllConferenceSessions=function(){for(var e in this.$log.info("[PstnConferenceService] removeAllConferenceSessions"),this.conferenceSessions)this.conferenceSessions.hasOwnProperty(e)&&this.removeConferenceSession(e)},e.$inject=["$q","$rootScope","$log","$http","authService","errorHelperService","ConferenceSession","profileService","xmppService","countryService","Conference","contactService","$translate","conferenceUserFactory"],e}();angular.module("rainbow").service("pstnConferenceService",PstnConferenceService);var WebConferenceService=function(){function e(e,t,n,r,i,a,o,s,c,l,d,u,f,h,p,v){var m=this;this.$q=e,this.$rootScope=t,this.$log=n,this.$http=r,this.uuid4=i,this.$interval=a,this.authService=o,this.xmppService=s,this.videoService=c,this.roomService=l,this.errorHelperService=d,this.ConferenceSession=u,this.contactService=f,this.platformService=h,this.Conference=p,this.profileService=v,this.MEDIATYPE={WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.connected=!1,this.disconnecting=!1,this.reconnecting=!1,this.audioProfileChanging=!1,this.conferenceEndpoints={},this.attachLocalMediaStream=function(e,t){if(e){var n;if(t.hasLocalVideo)if(n=t.sessions[t.localVideoSessionId]){var r=t.localStreams[n.localStreamId];m.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPip"),r,n.sid),m.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPipSmall"),r,n.sid)}if(t.hasLocalSharing)if(n=t.sessions[t.localSharingSessionId]){r=t.localStreams[n.localStreamId];m.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceSharingPip"),r,n.sid)}}else m.videoService.RTC.clearMediaStream(angular.element("#minivideo"),null)}}return e.prototype.start=function(r){var i=this;return this.$q(function(e){var t=performance.now();i.$log.info("[WebConferenceService] === STARTING ==="),i.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",i.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",i.conferenceEndpoints={},i.conferenceSessions={},i.listeners=[],i.statsIntervals=[],i.connected=!0,i.disconnecting=!1,i.webConferenceRoom=null,i.webrtcConferenceId=null,i.webrtcSharingOnlyRoom=null,i.webrtcSharingOnlyConferenceId=null,i.jingleJid=null,i.makingCall=!1,i.videoGalleryElements=[],i.attachHandlers(),i.videoGalleryElementsNumber=4,i.started=!0;var n=Math.round(performance.now()-t);r.push({service:"WebConferenceService",startDuration:n}),i.$log.info("[WebConferenceService] === STARTED ("+n+" ms) ==="),e()})},e.prototype.stop=function(){return this.$log.info("[WebConferenceService] === STOPPING ==="),this.started=!1,this.makingCall=!1,this.listeners&&this.listeners.forEach(function(e){e()}),this.$log.info("[WebConferenceService] === STOPPED ==="),this.$q.when()},e.prototype.attachHandlers=function(){var o=this;this.listeners.push(this.$rootScope.$on(this.roomService.ROOM_ADD_CONF_ENDPOINT_EVENT,function(e){if(e&&e.confEndpoints&&e.confEndpoints.length)for(var t=0;t<e.confEndpoints.length;t++)e.confEndpoints[t].mediaType===o.MEDIATYPE.WEBRTC?o.webConferenceRoom=e:e.confEndpoints[t].mediaType===o.MEDIATYPE.WEBRTCSHARINGONLY&&(o.webrtcSharingOnlyRoom=e)})),this.listeners.push(this.$rootScope.$on(this.roomService.ROOM_REMOVE_CONF_ENDPOINT_EVENT,function(e){e&&(o.webConferenceRoom||o.webrtcSharingOnlyRoom)&&(o.webConferenceRoom&&o.webConferenceRoom.dbId===e.dbId&&(o.webConferenceRoom=null),o.webrtcSharingOnlyRoom&&o.webrtcSharingOnlyRoom.dbId===e.dbId&&(o.webrtcSharingOnlyRoom=null))})),this.listeners.push(this.$rootScope.$on("ON_INPUT_DEVICE_CHANGED_EVENT",function(){o.onAudioProfileChangeEvent()})),this.listeners.push(this.$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",function(e,t){o.$log.info("[WebConferenceService] onConnectionStateChangeEvent : "+t);try{if("disconnected"===t)o.$log.info("[WebConferenceService] onConnectionStateChangeEvent : disconnected"),o.connected=!1;else if("connected"===t)for(var n in o.$log.info("[WebConferenceService] onConnectionStateChangeEvent : connected"),o.connected=!0,o.conferenceSessions)if(o.conferenceSessions.hasOwnProperty(n)){var r=o.conferenceSessions[n];if("reconnecting"===r.status)for(var i in r.sessions)if(r.sessions.hasOwnProperty(i)){var a=r.sessions[i];"audio"===a.localType&&o.sendTransportReplaceForSession(a,1e4)}}}catch(e){o.$log.info("[WebConferenceService] onConnectionStateChangeEvent error : "+e)}}))},e.prototype.retrieveWebConferences=function(t){var i=this;return void 0===t&&(t=this.MEDIATYPE.WEBRTC),this.$log.info("[WebConferenceService] retrieveWebConferences with mediaType="+t),this.$q(function(n,r){if(!i.profileService.isFeatureEnabled(i.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)&&t!==i.MEDIATYPE.WEBRTCSHARINGONLY)return i.$log.warn("[WebConferenceService] retrieveWebConferences - user is not allowed"),void r(new Error("notAllowed"));var e="?format=full&userId="+i.contactService.userContact.dbId;angular.isDefined(t)&&(e+="&mediaType="+t),i.$http({method:"GET",url:i.confProvPortalURL+"conferences"+e,headers:i.authService.getRequestHeader()}).then(function(e){var t=e.data.data;i.$log.info("[WebConferenceService] retrieveWebConferences successfully"),n(t)},function(e){var t="retrieveWebConferences failure: "+(e.data?e.data.errorDetails:e.data);i.$log.error("[WebConferenceService] "+t),r(new Error(t))})})},e.prototype.updateConference=function(e,t){var i=this;return this.$log.info("[WebConferenceService] updateConference"),this.$q(function(r,n){if(e)i.$http({method:"PUT",url:i.confProvPortalURL+"conferences/"+e,headers:i.authService.getRequestHeader(),data:t}).then(function(e){var t=e.data.data,n=i.Conference.createFromData(t);t.hasOwnProperty("id")&&(i.conferenceEndpoints[t.id]&&delete i.conferenceEndpoints[t.id],i.conferenceEndpoints[t.id]=n),i.$log.info("[WebConferenceService] updateConference successfully"),r(n)},function(e){var t="updateConference failure: "+(e.data?e.data.errorDetails:e.data);i.$log.error("[WebConferenceService] "+t),n(new Error(t))});else{i.$log.error("[WebConferenceService] updateConference failure : No confEndpoint"),n(new Error("updateConference failure: No confEndpoint"))}})},e.prototype.createVideoGalleryElements=function(){this.videoGalleryElements=[];for(var e=1;e<=this.videoGalleryElementsNumber;e++){var t={state:"free",sessionId:"",id:"videoGallery_"+e,publisherId:"",publisherJid:""};this.videoGalleryElements.push(t)}},e.prototype.setVideoGalleryElementsNumber=function(e){this.videoGalleryElementsNumber=e},e.prototype.getConferenceSessions=function(){return this.conferenceSessions},e.prototype.getConferenceEndpoints=function(){return this.conferenceEndpoints},e.prototype.addConferenceEndpoint=function(e,t){e?this.conferenceEndpoints[e]=t:this.$log.warn("[WebConferenceService] addConferenceEndpoint - missing conferenceEndpointId")},e.prototype.startOrJoinWebConference=function(e,t){if(!e)return this.$log.error("[webConferenceService] startOrJoinWebConference error - missing parameters for room"),this.$q.reject();var n=this.getPontConfIdForRoom(e);n=n||this.webrtcConferenceId;var r=this.conferenceSessions[n],i=e.owner?"moderator":"member";return n?(this.$log.info("[webConferenceService] startOrJoinWebConference for room "+e.dbId+" and web pont conference "+n),!e.owner||r&&r.active?(this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",e),this.joinWebConference(n,i,t)):this.startWebConference(e,n,i,t)):(this.$log.error("[webConferenceService] startOrJoinWebConference error - no available pont conference"),this.$q.reject())},e.prototype.startWebConference=function(r,i,a,o,s){var c=this;return void 0===a&&(a="moderator"),void 0===o&&(o=null),void 0===s&&(s=!0),this.makingCall?(this.$log.warn("[webConferenceService] already starting a conference"),this.$q.resolve()):i&&r?(this.makingCall=!0,this.$log.info("[webConferenceService] startWebConference wtih ID "+i),this.makeSnapshotForConfId(i,o||"webrtc").then(function(){if(c.conferenceSessions[i].active)return c.$log.info("[webConferenceService] startWebConference - No need to start an already active conference"),s?c.$q.resolve(c.joinWebConference(i,a,o,!0,!1)):c.$q.resolve();c.conferenceSessions[i].status="ringing",c.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",c.conferenceSessions[i]);var n=c.confPortalURL+i+"/start";return c.$q(function(e,t){c.$http({method:"PUT",url:n,headers:c.authService.getRequestHeader(),data:{mediaType:"sharing"===o?c.MEDIATYPE.WEBRTCSHARINGONLY:c.MEDIATYPE.WEBRTC,roomId:r.dbId}}).then(function(){if(s)return c.joinWebConference(i,a,o,!0,!1).then(function(){e()});e()},function(e){c.makingCall=!1,c.$log.error("[webConferenceService] startWebConference wtih ID "+i+" failure ... -- "+c.errorHelperService.getErrorFullMessage(e)),c.leaveWebConference(i),c.removeConferenceSession(i),c.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),t(c.errorHelperService.handleError(e))})})}).catch(function(e){return c.makingCall=!1,c.$log.error("[webConferenceService] startWebConference - error on server, can't start conference"),o&&"sharing"===o||c.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:"startMeetingFailure",okLabel:"ok"}),c.$q.reject(e)})):(this.$log.error("[startWebConference] No webPontConferenceId or Room!"),o&&"sharing"===o||this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:"startMeetingFailure",okLabel:"ok"}),this.$q.reject())},e.prototype.joinWebConference=function(o,s,c,l,t){var d=this;return void 0===c&&(c=null),void 0===l&&(l=!0),void 0===t&&(t=!0),this.$log.info("[webConferenceService] joinWebConference with ID "+o+" and role "+s),o?this.$q(function(e){t?(d.$log.debug("[webConferenceService] joinWebConference - trigger snapshot for "+o),e(d.makeSnapshotForConfId(o,c||"webrtc"))):e()}).then(function(){return d.$q(function(n,i){d.makingCall=!0,d.createVideoGalleryElements(),d.conferenceSessions[o].videoGallery=d.videoGalleryElements,"ringing"!==d.conferenceSessions[o].status&&(d.conferenceSessions[o].status="ringing",d.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",d.conferenceSessions[o]));var r="web_"+d.uuid4.generate(),e="unmuted";"sharing"===c&&(e="muted");var t=d.confPortalURL+o+"/join",a={participant:{role:s,type:e},mediaType:"sharing"===c?d.MEDIATYPE.WEBRTCSHARINGONLY:d.MEDIATYPE.WEBRTC};d.getUserMediaForSession(o,l).then(function(e){d.$http({method:"POST",url:t,headers:d.authService.getRequestHeader(),data:a}).then(function(e){var t=e.data.data;d.jingleJid=t.jingleJid,l?d.initCall(d.jingleJid,o,r,c):(d.$log.info("[webConferenceService] joinWebConference with ID success - jingleJid: "+d.jingleJid),d.conferenceSessions[o].jingleJid=d.jingleJid),d.conferenceSessions[o].haveJoined=!0,d.makingCall=!1,n()},function(e){if(e){var t=e.data?e.data.errorDetails:e.data,n="joinWebConference( confId="+o+") failure: "+t;d.$log.error("[conferenceService] "+n)}d.makingCall=!1;var r={popupTitle:"warning",popupBody:"joinMeetingFailure",okLabel:"ok"};e&&e.data&&403615===e.data.errorDetailsCode&&(r.popupBody="maximumNumberConferenceParticipantsReach"),d.leaveWebConference(o),delete d.conferenceSessions[o],d.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),"sharing"!==c&&d.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",r),i(d.errorHelperService.handleError(e))})}).catch(function(e){d.$log.error("[webConferenceService] joinWebConference - getUserMediaForSession reject -- "+e),d.makingCall=!1,"ignore"!==e&&d.leaveWebConference(o),i()})})}).catch(function(){return d.makingCall=!1,d.$log.error("[webConferenceService] joinWebConference - error on server, can't join conference"),d.$q.reject()}):(this.$log.error("[webConferenceService] joinWebConference - No webPontConferenceId !"),this.$q.reject())},e.prototype.stopWebConference=function(r){var i=this;return this.$q(function(e,t){if(r){var n=i.confPortalURL+i.webrtcConferenceId+"/stop";i.$http({method:"PUT",url:n,headers:i.authService.getRequestHeader(),data:{mediaType:i.MEDIATYPE.WEBRTC,roomId:r.dbId}}).then(function(){e()},function(e){t(i.errorHelperService.handleError(e))})}else t()})},e.prototype.getFreeVideoGalleryElement=function(e){this.$log.info("[webConferenceService] getFreeVideoGalleryElement "+e);var t=this.conferenceSessions[e],n=null;if(t){t.videoGallery||(this.createVideoGalleryElements(),t.videoGallery=this.videoGalleryElements);for(var r=0;r<t.videoGallery.length;r++)if("free"===t.videoGallery[r].state){n=t.videoGallery[r];break}}return n},e.prototype.askToAddSharingToConferenceSession=function(e,t){!this.videoService.askToAddSharing(e.id,"sharing")&&this.addMediaToConferenceSession(t,"sharing")},e.prototype.addMediaToConferenceSession=function(r,i){var a=this;if(r){var e=[i],t=20;"video"!==i&&(t=3),"sharing"===i&&this.contactService.setBusyState("dnd","sharing"),this.$log.info("[webConferenceService] addMediaToConferenceSession to session "+r.id+" with media "+i),this.videoService.getBrowserMedia(e,640,480,t).then(function(e){var t=[e],n=a.xmppService.connection.jingle.initiate(r.jingleJid,a.xmppService.connection.jid,i,t,null,r.id);r.sessions[n.sid]=n,r.localStreams.push(e),n.localStreamId=r.localStreams.length-1,"video"===i?(r.hasLocalVideo=!0,r.localVideoSessionId=n.sid):(r.hasLocalSharing=!0,r.localSharingSessionId=n.sid),a.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r),a.videoService.callsStats[n.sid]={},a.updateStatisticsForSession(r.id,n.sid),a.statsIntervals.push(n.getStats(5e3))})}},e.prototype.removeMediaFromConferenceSession=function(e,t){if(e){"sharing"===t&&this.contactService.setBusyState("dnd","audio"),this.$log.info("[webConferenceService] removeMediaFromConferenceSession from session "+e.id);var n="video"===t?e.localVideoSessionId:e.localSharingSessionId;if(e.sessions[n]){var r=e.sessions[n];this.updateStatisticsForSession(e.id,n),this.videoService.disableAudioVideoMedia(r),this.xmppService.connection.jingle.terminate(r.sid),delete e.sessions[n],delete e.localStreams[r.localStreamId],delete this.videoService.callsStats[n],"video"===t?(e.hasLocalVideo=!1,e.localVideoSessionId=null):(e.hasLocalSharing=!1,e.localSharingSessionId=null)}this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e)}},e.prototype.dropRemoteVideoSession=function(e,t){if(e){if(this.$log.info("[webConferenceService] dropRemoteVideoSession fom conference "+e.id+" and session "+t),e.sessions[t]){var n=e.sessions[t];this.updateStatisticsForSession(e.id,t),this.xmppService.connection.jingle.terminate(n.sid),delete e.sessions[t],delete this.videoService.callsStats[t]}this.removeSessionFromVideoGallery(e,t),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e)}},e.prototype.getUserMediaForSession=function(a,t){var o=this;return this.$q(function(r,i){if(t){var e=o.conferenceSessions[a];if(e){e.status="ringing",e.haveJoined=!0,o.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e);o.videoService.getBrowserMedia(["audio"]).then(function(e){o.$log.info("[webConferenceService] getUserMediaForSession -- sucess");var t=o.conferenceSessions[a];if(!t||"ended"===t.status)return o.$log.info("[webConferenceService] getUserMediaForSession -- missing conference"),o.disableMediaStream(e),void i("conference does not exist anymore");if(!o.makingCall)return o.$log.info("[webConferenceService] getUserMediaForSession -- already in the conference -- ignore"),o.disableMediaStream(e),void i("ignore");var n=[e];t.localStreams=n,r()}).catch(function(){o.$log.error("[webConferenceService] getUserMediaForSession error -- getUserMedia failed");o.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"devicePermission",okLabel:"ok"}),i("failed to get user media")})}else i()}else r()})},e.prototype.disableMediaStream=function(e){e&&(e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null)},e.prototype.initCall=function(t,n,r,i){var a=this,o=this.conferenceSessions[n];return this.$q(function(e){o||(a.$log.warn("[webConferenceService] initCall - no conferenceSession as though we are trying to init call"),e(a.makeSnapshotForConfId(n,i))),e()}).then(function(){var e=a.xmppService.connection.jingle.initiate(t,a.xmppService.connection.jid,"audio",o.localStreams,r,n);o.jingleJid=t,o.sessions[e.sid]=e,o.status="ringing",a.createStatisticsForSession(n,e.sid),a.statsIntervals.push(e.getStats(5e3)),a.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",o)})},e.prototype.muteAudio=function(e,t){if(e.webConferenceSession){for(var n in e.webConferenceSession.sessions){if(e.webConferenceSession.sessions.hasOwnProperty(n))e.webConferenceSession.sessions[n].muteAudio(t)}e.isMutedAudio=t,this.$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e})}else this.$log.info("[webConferenceService] muteAudio trying to mute a non existing session ")},e.prototype.createStatisticsForSession=function(t,n){var r=this;if(this.$log.info("[webConferenceService] createStatisticsForSession for conf "+t+" and session "+n),t&&n){this.videoService.callsStats[n]={};var e=[];e.push({connectionId:n,stats:this.videoService.callsStats[n]}),this.videoService.createStatisticsForSession(t,t,"pending",e).then(function(e){r.$log.info("[webConferenceService] createStatisticsForSession success "+e),r.videoService.callsStats[n].id=e,r.conferenceSessions[t].metricsId=e,r.conferenceSessions[t].metricsState="pending"}).catch(function(e){r.$log.error("[webConferenceService] createStatisticsForSession error for conf "+t)})}else this.$log.warn("[webConferenceService] createStatisticsForSession -- missing parameters")},e.prototype.updateStatisticsForSession=function(e,t){if(this.$log.info("[webConferenceService] updateStatisticsForSession for conf "+e+" and session "+t),e&&t){var n=this.conferenceSessions[e];if(n&&n.metricsId){n.metricsState||(n.metricsState="pending");var r=[];return this.videoService.callsStats[t]?(r.push({connectionId:t,stats:this.videoService.callsStats[t]}),void this.videoService.updateStatisticsForCall(n.metricsId,e,e,n.metricsState,r)):void 0}this.$log.warn("[webConferenceService] updateStatisticsForSession -- missing webConference or no metricsId")}else this.$log.warn("[webConferenceService] updateStatisticsForSession -- missing parameters")},e.prototype.leaveWebConference=function(e){if(this.$log.info("[WebConferenceService] leaveWebConference - "+e),this.contactService.resetBusyState(),e){var t=this.conferenceSessions[e];if(t){for(var n in t.metricsState="ended",t.sessions)if(t.sessions.hasOwnProperty(n)){var r=t.sessions[n];this.updateStatisticsForSession(t.id,r.sid),this.videoService.disableAudioVideoMedia(r),this.xmppService.connection.jingle.terminate(r.sid),delete this.videoService.callsStats[r.sid]}var i;for(t.cleanupSessionData(),this.createVideoGalleryElements(),t.videoGallery=this.videoGalleryElements,t.sessions={};this.statsIntervals.length;)(i=this.statsIntervals.pop())&&(this.$interval.cancel(i),i=null);this.makingCall=!1,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",t)}else this.$log.warn("[WebConferenceService] leaveWebConference - webConference does not exist")}},e.prototype.attachDistantMediaStream=function(e,n){var r=this;if(e){var i=this.getRemoteVideoSessions(n.id);this.updateMainSessionIfNeeded(i),this.$log.info("[WebConferenceService] attachDistantMediaStream for session "+n.id);var a=this.getRemoteSharingSession(n.id);if(a&&a.remoteStreams.forEach(function(e){0<e.getVideoTracks().length&&r.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,a.sid)}),i.length)for(var o in i)i.hasOwnProperty(o)&&i[o].remoteStreams&&i[o].remoteStreams.forEach(function(e){if(0<e.getVideoTracks().length){!a&&i[o].mainSession&&r.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,i[o].sid);for(var t=0;t<n.videoGallery.length;t++)if(n.videoGallery[t].sessionId===i[o].sid){r.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#"+n.videoGallery[t].id),e,n.videoGallery[t].sessionId);break}}});var t=this.getRemoteAudioSession(n.id);t&&t.remoteStreams&&t.remoteStreams.forEach(function(e){0<e.getAudioTracks().length&&r.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e)})}},e.prototype.attachMainMediaStream=function(t){var n=this;t&&(this.$log.info("[webConferenceService] attachMainMediaStream"),t.remoteStreams.forEach(function(e){0<e.getVideoTracks().length&&n.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,t.sid)}))},e.prototype.attachVideosToGallery=function(e){},e.prototype.updateMainSessionIfNeeded=function(e){if(this.$log.info("[webConferenceService] updateMainSessionIfNeeded"),e&&e.length){var t=null,n=!0;for(var r in e)e.hasOwnProperty(r)&&(t||(t=e[r]),e[r].mainSession&&(n=!1));n&&(t.mainSession=!0)}},e.prototype.getRelatedRoomToActiveConferenceSession=function(){return this.webConferenceRoom},e.prototype.getRelatedRoomToActiveSharingOnlyConferenceSession=function(){return this.webrtcSharingOnlyRoom},e.prototype.getConferenceBySessionId=function(e){var t=null;for(var n in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(n)&&this.conferenceSessions[n].sessions)for(var r in this.conferenceSessions[n].sessions)if(this.conferenceSessions[n].sessions.hasOwnProperty(r)&&this.conferenceSessions[n].sessions[r].sid===e)return t=this.conferenceSessions[n];return t},e.prototype.getPontConfIdForRoom=function(e){if(e.confEndpoints&&e.confEndpoints.length)for(var t=0;t<e.confEndpoints.length;t++)if(e.confEndpoints[t].mediaType===this.MEDIATYPE.WEBRTC&&e.confEndpoints[t].userId===e.ownerContact.dbId)return e.confEndpoints[t].confEndpointId;return""},e.prototype.getConferenceSessionById=function(e){return this.conferenceSessions[e]},e.prototype.updateWebConferenceInfos=function(e){var n=this;this.$log.info("[WebConferenceService] updateWebConferenceInfos"),Object.assign(this.conferenceEndpoints,e),this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.webrtcConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then(function(e){var t="nothing";e&&(t=e.name),n.webConferenceRoom=e,n.$log.info("[WebConferenceService] === updateWebConferenceInfos : webrtcConferenceId is currently attached to "+t)},function(){n.$log.info("[WebConferenceService] === updateWebConferenceInfos FAILURE ===")})},e.prototype.updateWebSharingOnlyConferenceInfos=function(e){var n=this;this.$log.info("[WebConferenceService] updateWebSharingOnlyConferenceInfos"),Object.assign(this.conferenceEndpoints,e),this.webrtcSharingOnlyConferenceId=this.getWebRtcSharingOnlyConfEndpointId(),this.webrtcSharingOnlyConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcSharingOnlyConferenceId).then(function(e){var t=e&&e.name?e.name:"nothing";n.webrtcSharingOnlyRoom=e,n.$log.info("[WebConferenceService] === updateWebSharingOnlyConferenceInfos : webrtcSharingOnlyConferenceId is currently attached to "+t)},function(){n.$log.info("[WebConferenceService] === updateWebSharingOnlyConferenceInfos FAILURE ===")})},e.prototype.updateWebConferenceRoom=function(){var r=this;return this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.$q(function(n,e){r.roomService.getRoomByConferenceEndpointId(r.webrtcConferenceId).then(function(e){var t="nothing";e&&(t=e.name),r.webConferenceRoom=e,r.$log.info("[WebConferenceService] === updateWebConferenceRoom : room is currently attached to "+t),n()},function(){r.$log.info("[WebConferenceService] === updateWebConferenceRoom FAILURE==="),e()})})},e.prototype.getWebRtcConfEndpointId=function(){for(var e in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(e)&&this.conferenceEndpoints[e].mediaType===this.MEDIATYPE.WEBRTC)return this.conferenceEndpoints[e].id;return null},e.prototype.getWebRtcSharingOnlyConfEndpointId=function(){for(var e in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(e)&&this.conferenceEndpoints[e].mediaType===this.MEDIATYPE.WEBRTCSHARINGONLY)return this.conferenceEndpoints[e].id;return null},e.prototype.isJoinWebConferenceAllowed=function(){return!0},e.prototype.getWebConference=function(e){if(e)return this.conferenceSessions[e]},e.prototype.removeConferenceSession=function(e){if(e){var t;for(this.removeAllJingleSessionsForConferenceSession(e),delete this.conferenceSessions[e];this.statsIntervals.length;)(t=this.statsIntervals.pop())&&(this.$interval.cancel(t),t=null);this.makingCall=!1}},e.prototype.removeAllJingleSessionsForConferenceSession=function(e){if(e){var t=this.conferenceSessions[e];if(t){for(var n in t.metricsState="ended",t.sessions)if(t.sessions.hasOwnProperty(n)){var r=t.sessions[n];this.updateStatisticsForSession(t.id,r.sid),delete this.videoService.callsStats[r.sid],this.videoService.disableAudioVideoMedia(r),this.xmppService.connection.jingle.terminate(r.sid)}t.sessions=[]}}},e.prototype.hasActiveConferenceSession=function(){for(var e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)&&this.conferenceSessions[e].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[e].isActive()&&(this.conferenceSessions[e].getParticipantByJid(this.contactService.userContact.jid)||this.conferenceSessions[e].haveJoined))return!0;return!1},e.prototype.getActiveConferenceSession=function(){var e=null;for(var t in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(t)&&this.conferenceSessions[t].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[t].isActive()&&(this.conferenceSessions[t].getParticipantByJid(this.contactService.userContact.jid)||this.conferenceSessions[t].haveJoined)&&(e=this.conferenceSessions[t]);return e},e.prototype.hasActiveSharingOnlyConferenceSession=function(){for(var e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)&&this.conferenceSessions[e].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[e].isActive())return!0;return!1},e.prototype.getActiveSharingOnlyConferenceSession=function(){var e=null;for(var t in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(t)&&this.conferenceSessions[t].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[t].isActive()&&(e=this.conferenceSessions[t]);return e},e.prototype.hasIncomingVideoStream=function(e){if(e){var t=this.conferenceSessions[e];if(t)for(var n in t.sessions)if(t.sessions.hasOwnProperty(n)){var r=t.sessions[n];if(!r.isInitiator&&("video"===r.remoteType||"sharing"===r.remoteType))return!0}return!1}},e.prototype.getRemoteSessionsWithVideoOrSharingStreams=function(e){var t=[];if(!e)return t;var n=this.conferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];i.isInitiator||"video"!==i.remoteType&&"sharing"!==i.remoteType||t.push(i)}return t},e.prototype.getRemoteSharingSession=function(e){var t=null;if(!e)return t;var n=this.conferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];if(!i.isInitiator&&"sharing"===i.remoteType){t=i;break}}return t},e.prototype.getRemoteVideoSessions=function(e){var t=[];if(!e)return t;var n=this.conferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];i.isInitiator||"video"!==i.remoteType||t.push(i)}return t},e.prototype.getRemoteAudioSession=function(e){var t;if(!e)return t;var n=this.conferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];if("audio"===i.localType){t=i;break}}return t},e.prototype.getRemoteMainVideoSession=function(e){var t;if(!e)return t;var n=this.conferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];if(!i.isInitiator&&"video"===i.remoteType&&i.mainSession){t=i;break}}return t},e.prototype.isAlreadySubscribedToPublisher=function(e,t){if(!e||!t)return!1;var n=!1,r=this.conferenceSessions[e];if(r&&r.videoGallery)for(var i=0;i<r.videoGallery.length;i++)if(r.videoGallery[i].publisherId===t){n=!0;break}return n},e.prototype.relatePublisherToElement=function(e,t,n){if(!e||!t||!n)return!1;this.$log.info("[WebConferenceService] relatePublisherToElement");var r=this.conferenceSessions[e];if(r)for(var i=0;i<r.videoGallery.length;i++)if(r.videoGallery[i].id===n){r.videoGallery[i].state="busy",r.videoGallery[i].publisherId=t.participantId,r.videoGallery[i].publisherJidIm=t.jid_im,r.videoGallery[i].displayName=t.participantId;var a=this.contactService.getContactByJid(t.jid_im);a&&(r.videoGallery[i].displayName=a.displayName);break}},e.prototype.getRelatedPublisherToElement=function(e,t){if(!e||!t)return null;this.$log.info("[WebConferenceService] getRelatedPublisherToElement");var n=null,r=this.conferenceSessions[e];if(r&&r.videoGallery)for(var i=0;i<r.videoGallery.length;i++)if(t===r.videoGallery[i].id&&r.videoGallery[i].publisherId){n=r.videoGallery[i];break}return n},e.prototype.relateSessionToPublisher=function(e,t,n){if(e&&t&&n){this.$log.info("[WebConferenceService] relateSessionToPublisher pubId "+t+" sessionId "+n);var r=this.conferenceSessions[e];if(r){for(var i=0;i<r.videoGallery.length;i++)if(t===r.videoGallery[i].publisherId&&!r.videoGallery[i].sessionId){r.videoGallery[i].sessionId=n;break}this.$log.info(r.videoGallery)}}},e.prototype.removeSessionFromVideoGallery=function(e,t){if(e&&t){e.videoGallery||(this.createVideoGalleryElements(),e.videoGallery=this.videoGalleryElements),this.$log.info("[WebConferenceService] removeSessionFromVideoGallery for conference "+e.id+" sessionId "+t);for(var n=0;n<e.videoGallery.length;n++)e.videoGallery[n].sessionId===t&&(e.videoGallery[n].sessionId="",e.videoGallery[n].state="free",e.videoGallery[n].publisherId="",e.videoGallery[n].publisherJidIm="",e.videoGallery[n].displayName="")}},e.prototype.reInitialiseVideoGalleryElementById=function(e,t){if(e&&t){e.videoGallery||(this.createVideoGalleryElements(),e.videoGallery=this.videoGalleryElements),this.$log.info("[WebConferenceService] reInitialiseVideoGalleryElementById for conference "+e.id+" elementId "+t);for(var n=0;n<e.videoGallery.length;n++)e.videoGallery[n].id===t&&(e.videoGallery[n].sessionId&&this.dropRemoteVideoSession(e,e.videoGallery[n].sessionId),e.videoGallery[n].sessionId="",e.videoGallery[n].state="free",e.videoGallery[n].publisherId="",e.videoGallery[n].publisherJidIm="",e.videoGallery[n].displayName="")}},e.prototype.updateMainScreenSession=function(e,t){if(e&&t){this.$log.info("[WebConferenceService] updateMainScreenSession");var n=this.conferenceSessions[e],r=null;if(n)for(var i in n.sessions)if(n.sessions.hasOwnProperty(i)){var a=n.sessions[i];t===a.sid?(a.mainSession=!0,r=a):a.mainSession=!1}r&&this.attachMainMediaStream(r)}},e.prototype.getListOfAvailableRemoteVideoPublishers=function(e){var r=this;if(e){this.$log.info("[WebConferenceService] getListOfAvailableRemoteVideoPublishers");var i=this.conferenceSessions[e],t=[];return i&&(i.videoGallery||(this.createVideoGalleryElements(),i.videoGallery=this.videoGalleryElements),t=(t=i.getListOfRemoteVideoPublishers()).filter(function(e){for(var t=0;t<i.videoGallery.length;t++)if(i.videoGallery[t].publisherId===e.participantId)return!1;var n=r.contactService.getContactByJid(e.jid_im);return e.displayName=n?n.displayName:e.participantId,!0})),t}},e.prototype.sendTransportReplaceForSession=function(e,t){if(e)if(this.reconnecting)this.$log.warn("[WebConferenceService] sendTransportReplaceForSession already reconnecting !");else{var n=this;this.reconnecting=!0,t||(t=5e3),this.$interval(function(e){n.reconnecting=!1,n.connected&&e&&e.peerconnection&&"stable"===e.peerconnection.signalingState&&"failed"===e.peerconnection.iceConnectionState&&(n.$log.info("[WebConferenceService] sendTransportReplaceForSession for session "+e.sid),e.connection=n.xmppService.connection,e.sendTransportReplace())},t,1,!0,e)}else this.$log.warn("[WebConferenceService] sendTransportReplaceForSession missing session !")},e.prototype.onAudioProfileChangeEvent=function(){var n=this;if(this.$log.info("[WebConferenceService] onAudioProfileChangeEvent"),this.audioProfileChanging)this.$log.info("[WebConferenceService] onAudioProfileChangeEvent -- already changing");else for(var e in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(e)){var t=this.conferenceSessions[e];for(var r in t.sessions)if(t.sessions.hasOwnProperty(r)){var i=t.sessions[r];"audio"===i.localType&&(this.audioProfileChanging=!0,this.$interval(function(t){n.audioProfileChanging=!1;n.videoService.getBrowserMedia(["audio"]).then(function(e){t.removeStream(t.localStreams[0]),n.videoService.stopActiveAudioVideoStreams(t),t.localStreams.push(e),t.addStream(t.localStreams[0]),t.sendTransportReplace()})},500,1,!0,i))}}},e.prototype.onJingleError=function(e){this.$log.info("[WebConferenceService] onJingleError -- "+e);var t=this.getConferenceBySessionId(e);t&&t.sessions&&("audio"===t.sessions[e].localType?this.leaveWebConference(t.id):(this.updateStatisticsForSession(t.id,e),t.localVideoSessionId===e?this.removeMediaFromConferenceSession(t,"video"):t.localSharingSessionId===e?this.removeMediaFromConferenceSession(t,"sharing"):(this.removeSessionFromVideoGallery(t,e),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",t))))},e.prototype.onIceConnectionFailedForSession=function(e,t){if(this.$log.info("[WebConferenceService] onIceConnectionFailedForSession -- "+t),e&&e.sessions){var n=e.sessions[t];"audio"===n.localType?(e.status="reconnecting",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e),this.connected&&this.sendTransportReplaceForSession(n,5e3)):e.localVideoSessionId===t?this.removeMediaFromConferenceSession(e,"video"):e.localSharingSessionId===t?this.removeMediaFromConferenceSession(e,"sharing"):(this.updateStatisticsForSession(e.id,t),delete this.videoService.callsStats[t],this.removeSessionFromVideoGallery(e,t),delete e.sessions[t],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e))}},e.prototype.onIncomingCall=function(e){this.$log.info("[WebConferenceService] onIncomingCall -- "+e);var t=this.xmppService.connection.jingle.sessions[e],n=t.confId,r=this.conferenceSessions[n];r?((r.sessions[e]=t).localType=t.remoteType,t.sendAnswer(),t.accept(),t.publisherId&&"sharing"!==t.remoteType&&this.relateSessionToPublisher(n,t.publisherId,t.sid),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r),this.videoService.callsStats[t.sid]={},this.updateStatisticsForSession(r.id,t.sid),this.statsIntervals.push(t.getStats(5e3))):this.$log.error("[WebConferenceService] onIncomingCall no such conferenceSession "+n)},e.prototype.onTerminatedCall=function(e){this.$log.info("[WebConferenceService] onTerminatedCall -- "+e);var t=this.xmppService.connection.jingle.sessions[e];if(t){var n=t.confId,r=this.conferenceSessions[n];r?(this.updateStatisticsForSession(r.id,e),this.removeSessionFromVideoGallery(r,e),this.videoService.disableAudioVideoMedia(t),this.xmppService.connection.jingle.terminate(t.sid),delete r.sessions[t.sid],delete this.videoService.callsStats[e],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r)):this.$log.error("[WebConferenceService] onTerminatedCall no such conferenceSession "+n)}else{var i=this.getActiveConferenceSession()?this.getActiveConferenceSession():this.getActiveSharingOnlyConferenceSession();i&&i.sessions&&(i.sessions[e]&&(i.metricsState="ended",this.updateStatisticsForSession(i.id,e)),this.removeSessionFromVideoGallery(i,e),this.videoService.disableAudioVideoMedia(i.sessions[e]),delete i.sessions[e],delete this.videoService.callsStats[e],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",i))}},e.prototype.onConferenceCallSwitched=function(e){this.$log.info("[WebConferenceService] onConferenceCallSwitched -- "+e);var t=this.getActiveConferenceSession();t&&this.leaveWebConference(t.id)},e.prototype.onIceConnectionStateChange=function(e,t){var n=this;this.$log.info("[WebConferenceService] onIceConnectionStateChange for session "+e);var r=this.getConferenceBySessionId(e);try{r&&t.peerconnection&&("stable"===t.peerconnection.signalingState&&"connected"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection established successfully"),r.status="connected",t.remoteStreams&&t.remoteStreams.forEach(function(e){0<e.getAudioTracks().length&&(n.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e),n.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r)),"stable"===t.peerconnection.signalingState&&"completed"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection completed successfully"),"connected"!==r.status&&(r.status="connected",t.remoteStreams&&t.remoteStreams.forEach(function(e){0<e.getAudioTracks().length&&(n.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e),n.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r))),"stable"===t.peerconnection.signalingState&&"disconnected"===t.peerconnection.iceConnectionState&&this.$log.info("[WebConferenceService] ICE Connection State disconnected"),"stable"===t.peerconnection.signalingState&&"failed"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection State failed"),this.onIceConnectionFailedForSession(r,e)))}catch(e){this.$log.error("[WebConferenceService] onIceConnectionStateChange error "+e)}},e.prototype.updateOrCreateConferenceSession=function(e,t,n){var r=this;if(void 0===n&&(n="webrtc"),this.$log.debug("[webConferenceService] updateOrCreateConferenceSession for "+e),!e||!t||!t.data)return this.$log.error("[webConferenceService] updateOrCreateConferenceSession - Not enough data"),null;var i=this.conferenceSessions[e];return i?t.data.active!==i.active&&(this.$log.debug((t.data.active,"active")),i.updateActiveState(t.data.active),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",i)):(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession - create new conferencesession with id "+e+"and data: \n"+JSON.stringify(t.data)),i=this.ConferenceSession.createFromData(e,[],t.data.active,n),this.conferenceSessions[e]=i,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",i)),t.data.participants&&0<t.data.participants.length&&(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession - update participants for "+e+" with:\n"+JSON.stringify(t.data.participants)),i.updateParticipants(t.data.participants).then(function(){r.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",i)})),i},e.prototype.updateOrCreateWebConferenceEndpoint=function(e){if(this.$log.info("[WebConferenceService] updateOrCreateWebConferenceEndpoint for "+e.id),!e)return this.$log.error("[WebConferenceService] updateOrCreateWebConferenceEndpoint - no conference data !"),null;if(e.mediaType!==this.MEDIATYPE.WEBRTC&&e.mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.error("[WebConferenceService] updateOrCreateWebConferenceEndpoint - wrong mediaType:"+e.mediaType),null;var t=this.Conference.createFromData(e);return(this.conferenceEndpoints[e.id]=t).mediaType===this.MEDIATYPE.WEBRTC?this.updateWebConferenceInfos([t]):this.updateWebSharingOnlyConferenceInfos([t]),this.conferenceEndpoints[e.id]},e.prototype.makeSnapshotForConfId=function(r,i){var a=this;if(void 0===r&&(r=null),!r){var e="[webConferenceService] makeSnapshotForConfId - No confId !!";return this.$log.error(e),this.$q.reject(e)}return this.$q(function(n,t){a.$http({method:"GET",url:a.confPortalURL+r+"/snapshot?mediaType=webrtc",headers:a.authService.getRequestHeader()}).then(function(e){a.$log.info("[webConferenceService] makeSnapshotForConfId success for confId "+r);var t=e.data;a.updateOrCreateConferenceSession(r,t,i),n(t.data)}).catch(function(e){a.$log.info("[webConferenceService] makeSnapshotForConfId failure for confID "+r),404===e.status?a.$log.error("[webConferenceService] makeSnapshotForConfId - confId "+r+" not found on server"):a.$log.error("[webConferenceService] makeSnapshotForConfId - inconsistent object on server"),a.conferenceSessions[r]&&a.removeConferenceSession(r),t()})})},e.prototype.refreshConferenceSessions=function(){var a=this;return this.$log.info("[webConferenceService] refreshConferenceSessions"),this.$q(function(e,t){var n=[];for(var r in a.conferenceSessions)if(a.conferenceSessions.hasOwnProperty(r)){var i=a.conferenceSessions[r];n.push(a.makeSnapshotForConfId(i.id,i.type))}a.$q.all(n).then(function(){a.$log.info("[webConferenceService] refreshConferenceSessions -- success"),e()}).catch(function(){a.$log.error("[webConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions"),a.removeAllConferenceSessions(),t()})})},e.prototype.removeAllConferenceSessions=function(){for(var e in this.$log.info("[webConferenceService] removeAllConferenceSessions"),this.conferenceSessions)this.conferenceSessions.hasOwnProperty(e)&&this.removeConferenceSession(e)},e.$inject=["$q","$rootScope","$log","$http","uuid4","$interval","authService","xmppService","videoService","roomService","errorHelperService","ConferenceSession","contactService","platformService","Conference","profileService"],e}();angular.module("rainbow").service("webConferenceService",WebConferenceService);var ConferenceService=function(){function e(e,t,n,r,i,a,o,s,c,l,d,u,f,h){this.$q=e,this.$log=t,this.$rootScope=n,this.$interval=r,this.$translate=i,this.$http=a,this.xmppService=o,this.authService=s,this.Conference=c,this.profileService=l,this.contactService=d,this.webConferenceService=u,this.pstnConferenceService=f,this.roomService=h,this.MEDIATYPE={PSTNAUDIO:"pstnAudio",WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.conferenceRef=null}return e.prototype.start=function(r){var i=this;return this.$q(function(t){var n=performance.now();return i.$log.info("[ConferenceService] === STARTING ==="),i.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",i.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",i.pstnConferenceService.computePstnConferencePremission(),i.attachHandlers(),i.pstnConferenceService.retrievePstnPhoneNumbers(),i.retrieveConferences(null,!1).then(function(){return i.pstnConferenceService.pstnInstantConferenceEndpoint?i.retrieveConferenceUser(i.contactService.userContact.dbId):i.$q.when()}).then(function(){return i.makeSnapshots()}).then(function(){i.started=!0;var e=Math.round(performance.now()-n);r.push({service:"conferenceService",startDuration:e}),i.$log.info("[ConferenceService] === STARTED ("+e+" ms) ==="),t()}).catch(function(e){i.$log.info("[ConferenceService] === STARTING FAILURE === "+e.message),t()})})},e.prototype.stop=function(){var t=this;return this.$q(function(e){t.$log.info(""),t.$log.info("[ConferenceService] === STOPPING ==="),t.started=!1,t.$log.info("[ConferenceService] === STOPPED ==="),e()})},e.prototype.attachHandlers=function(){var t=this;this.$log.info("[ConferenceService] attachHandlers"),this.conferenceRef&&(this.xmppService.connection.deleteHandler(this.conferenceRef),this.conferenceRef=null),this.conferenceRef=this.xmppService.connection.addHandler(function(e){return t.onConferenceUpdate(e)},"jabber:iq:conference","message",null)},e.prototype.reconnectService=function(){this.$log.info("[ConferenceService] reconnectService"),this.attachHandlers(),this.refreshConferenceSessions()},e.prototype.getPstnInstantConferenceEndpoint=function(){return this.pstnConferenceService.pstnInstantConferenceEndpoint},e.prototype.getPstnInstantConferenceEndpointId=function(){return this.pstnConferenceService.pstnInstantConferenceEndpoint?this.pstnConferenceService.pstnInstantConferenceEndpoint.id:-1},e.prototype.getPstnConferenceUser=function(){return this.pstnConferenceService.pstnConferenceUser},e.prototype.getWebConferenceEndpoints=function(){return this.webConferenceService.conferenceEndpoints},e.prototype.createConference=function(e,t,i,a,o,s){var c=this;return this.$q(function(r,n){c.$log.info("[conferenceService] createConference"),c.$http({method:"POST",url:c.confProvPortalURL+"conferences",headers:c.authService.getRequestHeader(),data:{confUserId:e,name:t,startDate:i,endDate:a,timeZone:o,provisioning:!!s}}).then(function(e){var t=e.data.data,n=c.Conference.createFromData(t);t.hasOwnProperty("id")&&(t.mediaType===c.MEDIATYPE.PSTNAUDIO?c.pstnConferenceService.pstnConferenceEndpoints[t.id]=n:c.webConferenceService.conferenceEndpoints[t.id]=n),c.$log.info("[conferenceService] createConference successfully"),r(n)},function(e){var t="createConference failure: "+(e.data?e.data.errorDetails:e.data);c.$log.error("[conferenceService] "+t),n(new Error(t))})})},e.prototype.deleteConference=function(t){var r=this;return this.$q(function(e,n){r.$log.info("[conferenceService] deleteConference"),r.$http({method:"DELETE",url:r.confProvPortalURL+"conferences/"+t,headers:r.authService.getRequestHeader()}).then(function(){r.pstnConferenceService.pstnConferenceEndpoints[t]&&r.pstnConferenceService.pstnInstantConferenceEndpoint&&r.pstnConferenceService.pstnInstantConferenceEndpoint.id!==t&&delete r.pstnConferenceService.pstnConferenceEndpoints[t],r.webConferenceService.conferenceEndpoints[t]&&delete r.webConferenceService.conferenceEndpoints[t],r.$log.info("[conferenceService] deleteConference successfully"),e()},function(e){var t="deleteConference failure: "+(e.data?e.data.errorDetails:e.data);r.$log.error("[conferenceService] "+t),n(new Error(t))})})},e.prototype.makeSnapshotsForList=function(r){var i=this;return this.$q(function(e){if(i.$log.info("[ConferenceService] makeSnapshotsForList"),r&&r.length){for(var t=[],n=0;n<r.length;n++)t.push(i.makeSnapshotForConfId(r[n].confEndpointId,r[n].mediaType));i.$q.all(t).finally(function(){e(i.getConferenceSessionForRoom(r))})}else e()})},e.prototype.getConferenceSessionForRoom=function(e){var t=null,n=null;if(e&&e.length)for(var r=0;r<e.length;r++)e[r].mediaType===this.MEDIATYPE.PSTNAUDIO?t=this.pstnConferenceService.conferenceSessions[e[r].confEndpointId]:n=this.webConferenceService.conferenceSessions[e[r].confEndpointId];return t||n},e.prototype.makeSnapshots=function(){var i=this;return this.$log.info("[ConferenceService] makeSnapshots"),this.$q(function(e){var t=[];for(var n in i.pstnConferenceService.pstnInstantConferenceEndpoint&&t.push(i.makeSnapshotForConfId(i.pstnConferenceService.pstnInstantConferenceEndpoint.id,i.pstnConferenceService.pstnInstantConferenceEndpoint.mediaType)),i.webConferenceService.conferenceEndpoints)if(i.webConferenceService.conferenceEndpoints.hasOwnProperty(n)){var r=i.webConferenceService.conferenceEndpoints[n];t.push(i.makeSnapshotForConfId(r.id,r.mediaType))}i.$q.all(t).finally(function(){i.$log.info("[ConferenceService] makeSnapshots done"),e()})})},e.prototype.retrieveConferenceUser=function(e){return this.pstnConferenceService.retrieveConferenceUser(e)},e.prototype.onConferenceUpdate=function(e){this.$log.info("[ConferenceService] onConferenceUpdate message: "+e.innerHTML);var t=$(e).find("conference-id").text(),n=$(e).find("media-type"),r=this.MEDIATYPE.PSTNAUDIO;if(n&&n.length&&n.text&&(r=$(n[0]).text()),t){var i=null;if(i=r===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[t]:this.webConferenceService.conferenceSessions[t])this.updateConferenceSession(e,i);else switch(this.$log.info("[ConferenceService] no such session for ID "+t),r){case"webrtc":break;case"webrtcsharing":var a=$(e).find("publisher"),o=a.find("jid-im").text(),s={participantId:a.find("publisher-id").text(),mediaType:r,jid_im:o};this.subscribeToPublisher(t,s)}}return!0},e.prototype.makeSnapshotForConfId=function(i,a){var o=this;return void 0===a&&(a=this.MEDIATYPE.PSTNAUDIO),this.$log.info("[ConferenceService] makeSnapshotForConfId "+i),this.$q(function(n,t){if(!i)return o.$log.error("[ConferenceService] makeSnapshotForConfId missing conf ID !"),void t();var r=a===o.MEDIATYPE.WEBRTC||a===o.MEDIATYPE.WEBRTCSHARINGONLY?o.MEDIATYPE.WEBRTC:o.MEDIATYPE.PSTNAUDIO;o.$http({method:"GET",url:o.confPortalURL+i+"/snapshot?mediaType="+r,headers:o.authService.getRequestHeader()}).then(function(e){o.$log.info("[ConferenceService] makeSnapshotForConfId success for confId "+i);var t=e.data;r===o.MEDIATYPE.PSTNAUDIO?o.pstnConferenceService.updateOrCreateConferenceSession(i,t):o.webConferenceService.updateOrCreateConferenceSession(i,t,a),n(t.data)}).catch(function(e){o.$log.info("[ConferenceService] makeSnapshotForConfId failure for confID "+i),404===e.status?o.$log.error("[ConferenceService] makeSnapshotForConfId - confId "+i+" not found on server"):o.$log.error("[ConferenceService] makeSnapshotForConfId - inconsistent object on server"),r===o.MEDIATYPE.PSTNAUDIO?delete o.pstnConferenceService.conferenceSessions[i]:delete o.webConferenceService.conferenceSessions[i],t()})})},e.prototype.retrieveConferences=function(e,t,n){var o=this;switch(this.$log.info("[ConferenceService] retrieveConferences with mediaType="+e+" and scheduled="+t),e){case this.MEDIATYPE.PSTNAUDIO:return this.pstnConferenceService.retrievePstnConferences(t,n);case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:return this.webConferenceService.retrieveWebConferences(e)}return this.$q(function(a,n){if(!o.pstnConferenceService.isPstnConferenceAvailable&&!o.profileService.isFeatureEnabled(o.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED))return o.$log.warn("[ConferenceService] retrieveConferences - user is not allowed"),void n(new Error("notAllowed"));var e="conferences?format=full&userId="+o.contactService.userContact.dbId;angular.isDefined(t)&&(e+="&scheduled="+t),o.$http({method:"GET",url:o.confProvPortalURL+e,headers:o.authService.getRequestHeader()}).then(function(e){for(var t=e.data.data,n=0,r=t;n<r.length;n++){var i=r[n];switch(i.mediaType){case o.MEDIATYPE.PSTNAUDIO:o.pstnConferenceService.updateOrCreatePstnConferenceEndpoint(i);break;case o.MEDIATYPE.WEBRTC:case o.MEDIATYPE.WEBRTCSHARINGONLY:o.webConferenceService.updateOrCreateWebConferenceEndpoint(i)}}o.$log.info("[ConferenceService] retrieveConferences successfully"),a(t)},function(e){var t="retrieveConferences failure: "+(e.data?e.data.errorDetails:e.data);o.$log.error("[ConferenceService] "+t),n(new Error(t))})})},e.prototype.retrieveConference=function(e){var i=this;return this.$log.info("[ConferenceService] retrieveConference"),e?this.$q(function(r,n){i.pstnConferenceService.pstnConferenceEndpoints[e]?r(i.pstnConferenceService.pstnConferenceEndpoints[e]):i.webConferenceService.conferenceEndpoints[e]?r(i.webConferenceService.conferenceEndpoints[e]):i.$http({method:"GET",url:i.confProvPortalURL+"conferences/"+e,headers:i.authService.getRequestHeader()}).then(function(e){var t=e.data.data;if(t&&t.hasOwnProperty("id")){var n=i.Conference.createFromData(t);t.mediaType===i.MEDIATYPE.PSTNAUDIO?i.pstnConferenceService.pstnConferenceEndpoints[t.id]=n:i.webConferenceService.conferenceEndpoints[t.id]=n}i.$log.info("[ConferenceService] retrieveConference successfully"),r(t)},function(e){var t="retrieveConference failure: "+(e.data?e.data.errorDetails:e.data);i.$log.error("[ConferenceService] "+t),n(new Error(t))})}):(this.$log.warn("[ConferenceService] retrieveConference - missing confID"),this.$q.reject())},e.prototype.updateConferenceSession=function(e,s){var o=this;this.$log.info("[ConferenceService] updateConferenceSession");var t=$(e).find("conference-state");if(t.length){var n="true"===t.find("active").text(),r="true"===t.find("talker-active").text(),i="true"===t.find("recording-started").text();this.updateState(s,n,r,i)}var a=$(e).find("talkers");if(a.length){var c=[];a.find("participant-id").each(function(e,t){var n=$(t).text();c.push(n)}),this.updateTalkers(s,c)}var l=$(e).find("participants");if(0===l.length&&(l=$(e).find("updated-participants")),l.length||(l=$(e).find("added-participants")),l.length){var d=[];l.find("participant").each(function(e,t){var n=$(t),r=n.find("participant-id").text(),i=n.find("jid-im").text(),a=n.find("phone-number").text(),o=n.find("role").text(),s=n.find("mute").text(),c=n.find("hold").text(),l=n.find("cnx-state").text();d.push({participantId:r,jid_im:i,phoneNumber:a,participantRole:o,mute:"on"===s,held:"on"===c,participantState:l})}),this.createOrUpdateParticipants(s,d)}var u=$(e).find("removed-participants");if(u.length){var f=[];u.find("participant-id").each(function(e,t){var n=$(t).text();f.push(n)}),this.removeParticipants(s,f)}var h=$(e).find("added-publishers");h.length&&(h.find("publisher").each(function(e,t){var n=$(t),r=n.find("publisher-id").text(),i=n.find("media-type").text(),a=n.find("jid-im").text();o.addPublisher(s,r,i,a)}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",s));var p=$(e).find("removed-publishers");p.length&&(p.find("publisher").each(function(e,t){for(var n=$(t),r=n.find("participant-id").text(),i=n.find("media-type").text(),a=0;a<s.publishers.length;a++){var o=s.publishers[a];if(o.participantId===r&&o.mediaType===i){s.publishers.splice(a,1);break}}}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",s));var v=$(e).find("publishers");return v.length&&(v.find("publisher").each(function(e,t){var n=$(t),r=n.find("publisher-id").text(),i=n.find("media-type").text(),a=n.find("jid-im").text();o.addPublisher(s,r,i,a)}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",s)),!0},e.prototype.updateState=function(e,t,n,r){if(t||this.contactService.resetBusyState(),e.active&&!t){if(this.contactService.userContact.guestMode&&e.type!==this.MEDIATYPE.WEBRTCSHARINGONLY)this.$rootScope.$broadcast("ON_OPEN_POPUP","concludeInvitationEndMeeting");else{var i=this.roomService.findRoomsWithConfId(e.id);if(i&&i.length&&i[0].ownerContact.id!==this.contactService.userContact.id)switch(e.type){case this.MEDIATYPE.WEBRTCSHARINGONLY:break;case this.MEDIATYPE.PSTNAUDIO:case this.MEDIATYPE.WEBRTC:default:if(e.isParticipantConnectedByJid(this.contactService.userContact.dbId)){var a={popupTitle:"information",popupBodyTranslated:this.$translate.instant("meetingEndBy",{owner:i[0].ownerContact.displayName,meeting:i[0].name}),okLabel:"ok"};this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",a)}}}e.participants=[],e.status="ended"}e.updateStateFromData(t,n,r),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",e)},e.prototype.updateTalkers=function(e,t){e.updateTalkers(t),this.$rootScope.$broadcast("ON_CONFERENCE_TALKER_EVENT",e)},e.prototype.createOrUpdateParticipants=function(t,e){var n=this;t.updateParticipants(e).then(function(e){t.participants.find(function(e){return e.jid_im===n.contactService.userContact.id&&"disconnected"!==e.state})&&n.contactService.setBusyState("dnd","audio"),n.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",t),"webrtc"===t.type&&e&&n.$rootScope.$broadcast("ON_WEB_CONFENRECE_PARTICIPANT_JOINED_EVENT",t)})},e.prototype.removeParticipants=function(e,t){var n=this;if(e.removeParticipants(t),!e.participants.find(function(e){return e.jid_im===n.contactService.userContact.id}))switch(this.contactService.resetBusyState(),e.type){case this.MEDIATYPE.WEBRTC:if(this.webConferenceService.removeAllJingleSessionsForConferenceSession(e.id),e.active){var r=this.roomService.findRoomsWithConfId(e.id);if(r.length&&!r[0].owner){var i={popupTitle:"information",popupBodyTranslated:this.$translate.instant("meetingDisconnect",{meeting:r[0].name}),okLabel:"ok"};this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",i)}}e.cleanupSessionData();break;case this.MEDIATYPE.WEBRTCSHARINGONLY:this.webConferenceService.removeAllJingleSessionsForConferenceSession(e.id),e.cleanupSessionData();break;case this.MEDIATYPE.PSTNAUDIO:var a=this.roomService.findRoomsWithConfId(e.id);if(a&&a.length&&a[0].getSFUSharingConfEndpointId()){var o=a[0].getSFUSharingConfEndpointId();if(a[0].owner)this.stopConference(o,this.MEDIATYPE.WEBRTC,a[0].dbId).catch(function(){n.$log.warn("[ConferenceService] - error stoping the conference, trying to just leave it ..."),n.webConferenceService.leaveWebConference(o)});else{var s=this.webConferenceService.getConferenceSessionById(o),c=s?s.getParticipantByJid(this.contactService.userContact.jid):null;this.webConferenceService.leaveWebConference(o),c&&this.disconnectsParticipant(o,c.participantId,this.MEDIATYPE.WEBRTC)}}}this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",e)},e.prototype.addPublisher=function(e,t,n,r){for(var i=this,a=!0,o=0;o<e.publishers.length;o++){var s=e.publishers[o];if(s.participantId===t&&s.mediaType===n){a=!1;break}}var c={participantId:t,mediaType:n,jid_im:r};if(a&&e.publishers.push(c),a&&"video"===n){var l=this.webConferenceService.getFreeVideoGalleryElement(e.id);l&&!this.webConferenceService.isAlreadySubscribedToPublisher(e.id,c.participantId)&&(this.$log.info("[ConferenceService] subscribe to publisher "+e.id+" for id "+t+"and element id "+l.id),l.state="busy",l.publisherId=c.participantId,this.$interval(function(e,t,n){i.$log.info("[ConferenceService] subscribe to publisher "+e.id+" for id "+t.participantId+"and element id "+l.id),i.subscribeToPublisher(e.id,t,n).catch(function(){i.$log.error("[ConferenceService] subscribe to publisher failed, reset the video gallery element with id "+n),i.webConferenceService.reInitialiseVideoGalleryElementById(e,n)})},2500,1,!0,e,c,l.id))}},e.prototype.stopConference=function(a,o,e){var s=this;if(void 0===a&&(a=""),void 0===o&&(o=this.MEDIATYPE.PSTNAUDIO),void 0===e&&(e=""),this.$log.info("[ConferenceService] stopConference( confId="+a+", type="+o+")"),!a||!e&&o!==this.MEDIATYPE.PSTNAUDIO)return this.$log.warn("[ConferenceService] stopConference missing conf ID or roomID"),this.$q.reject();var t=this.pstnConferenceService.conferenceSessions[a]?this.pstnConferenceService.conferenceSessions[a]:this.webConferenceService.conferenceSessions[a];return t&&t.isActive()?this.$q(function(t,i){s.$http({method:"PUT",url:s.confPortalURL+a+"/stop",headers:s.authService.getPostHeader(),data:{mediaType:o,roomId:e}}).then(function(){s.contactService.resetBusyState();var e=null;(e=o===s.MEDIATYPE.PSTNAUDIO?s.pstnConferenceService.conferenceSessions[a]:s.webConferenceService.conferenceSessions[a])&&(e.updateActiveState(!1),e.cleanupSessionData(),s.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",e)),s.$log.info("[ConferenceService] stopConference( confId="+a+") successfully"),t()},function(e){var t=e.data?e.data.errorDetails:e.data,n="stopConference( confId="+a+") failure: "+t;if(s.$log.error("[ConferenceService] "+n),404e3!==e.data.errorDetailsCode)s.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"stopMeetingFailure",okLabel:"ok"});else{var r=null;(r=o===s.MEDIATYPE.PSTNAUDIO?s.pstnConferenceService.conferenceSessions[a]:s.webConferenceService.conferenceSessions[a])&&(r.active=!1,r.participants=[],s.removeConferenceSession(r),s.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r))}i(new Error(n))})}):(this.$log.warn("[ConferenceService] stopConference - no active conference session to stop"),this.$q.reject())},e.prototype.removeConferenceSession=function(e){void 0===e&&(e=null),e&&(e.type===this.MEDIATYPE.WEBRTC||e.type===this.MEDIATYPE.WEBRTCSHARINGONLY?this.webConferenceService.removeConferenceSession(e.id):delete this.pstnConferenceService.conferenceSessions[e.id])},e.prototype.disconnectsParticipant=function(i,a,t){var o=this;return void 0===t&&(t=this.MEDIATYPE.PSTNAUDIO),i&&a?this.$q(function(e,r){o.$log.info("[ConferenceService] disconnectsParticipant( confId="+i+"participantId="+a+")"),o.$http({method:"DELETE",url:o.confPortalURL+i+"/participants/"+a+"?mediaType="+t,headers:o.authService.getRequestHeader()}).then(function(){o.$log.info("[ConferenceService] disconnectsParticipant( confId="+i+"participantId="+a+") successfully"),e()},function(e){var t=e.data?e.data.errorDetails:e.data,n="disconnectsParticipant( confId="+i+"participantId="+a+") failure: "+t;o.$log.error("[ConferenceService] "+n),r(new Error(n))})}):(this.$log.warn("[ConferenceService] disconnectsParticipant missing conf ID or participantId"),this.$q.reject())},e.prototype.updateConference=function(e,t,n){if(void 0===n&&(n=this.MEDIATYPE.PSTNAUDIO),n===this.MEDIATYPE.PSTNAUDIO)return this.pstnConferenceService.updateConference(e,t);this.webConferenceService.updateConference(e,t)},e.prototype.updateConferenceState=function(i,t,a){var o=this;return void 0===a&&(a=this.MEDIATYPE.PSTNAUDIO),this.$log.info("[ConferenceService] updateConferenceState( confId="+i+", option="+t+" mediaType="+a+")"),i&&t?this.$q(function(n,r){var e=null;if(!(e=a===o.MEDIATYPE.PSTNAUDIO?o.pstnConferenceService.conferenceSessions[i]:o.webConferenceService.conferenceSessions[i]))return o.$log.error("[ConferenceService] updateConferenceState - no corresponding conference session to update"),void r();o.$http({method:"PUT",url:o.confPortalURL+i+"/update",headers:o.authService.getRequestHeader(),data:{option:t,mediaType:e.type}}).then(function(e){var t=e.data.data;o.$log.info("[ConferenceService] updateConferenceState( confId="+i+") successfully"),n(t)},function(e){var t=e.data?e.data.errorDetails:e.data,n="updatsConferenceState( confId="+i+") failure: "+t;o.$log.error("[ConferenceService] "+n),r(new Error(n))})}):(this.$log.error("[ConferenceService] updateConferenceState - missing a parameter"),this.$q.reject())},e.prototype.updateParticipantState=function(i,a,t,o){var s=this;return void 0===o&&(o=this.MEDIATYPE.PSTNAUDIO),this.$log.info("[ConferenceService] updateParticipantState( confId="+i+"participantId="+a+" option="+t+" mediaType="+o+")"),i&&a&&t?this.$q(function(n,r){var e=null;if(!(e=o===s.MEDIATYPE.PSTNAUDIO?s.pstnConferenceService.conferenceSessions[i]:s.webConferenceService.conferenceSessions[i]))return s.$log.error("[ConferenceService] updateParticipantState - no corresponding conference session to update"),void r();s.$http({method:"PUT",url:s.confPortalURL+i+"/participants/"+a,headers:s.authService.getRequestHeader(),data:{option:t,mediaType:e.type}}).then(function(e){var t=e.data.data;s.$log.info("[ConferenceService] updateParticipantState( confId="+i+"participantId="+a+") successfully"),n(t)},function(e){var t=e.data?e.data.errorDetails:e.data,n="updateParticipantState( confId="+i+"participantId="+a+") failure: "+t;s.$log.error("[ConferenceService] "+n),r(new Error(n))})}):(this.$log.error("[ConferenceService] updateParticipantState - missing a parameter"),this.$q.reject())},e.prototype.retrievePstnPhoneNumbers=function(e){return void 0===e&&(e=!1),this.pstnConferenceService.retrievePstnPhoneNumbers(e)},e.prototype.joinPstnConference=function(e,t,n,r,i){var a=this;return this.$log.info("[ConferenceService] joinPstnConference with ( confId = "+e+" participantPhoneNumber = "+t+" country = "+r+" )"),e&&i?this.makeSnapshotForConfId(e,this.MEDIATYPE.PSTNAUDIO).then(function(){return a.pstnConferenceService.initiatesCallParticipant(e,t,n,r).then(function(){if(i.owner)return a.$q.resolve();for(var e=0;e<i.confEndpoints.length;e++)if(i.confEndpoints[e].mediaType===a.MEDIATYPE.WEBRTCSHARINGONLY)return a.webConferenceService.joinWebConference(i.confEndpoints[e].confEndpointId,"member","sharing",!1,!1),a.$q.resolve()})}).catch(function(e){return a.$q.reject("[ConferenceService] joinPstnConference - unable to join")}):(this.$log.error("[ConferenceService] joinPstnConference - missing parameter"),this.$q.reject())},e.prototype.subscribeToPublisher=function(e,r,i){var a=this;return void 0===e&&(e=""),void 0===r&&(r=null),void 0===i&&(i=""),this.$q(function(t,n){if(!e||!r)return a.$log.warn("[ConferenceService] subscribeToPublisher missing parameters !! Ignore !"),void t();a.$log.info("[ConferenceService] subscribeToPublisher for confId "+e+" and publisher "+r.participantId),i&&a.webConferenceService.relatePublisherToElement(e,r,i),a.$http({method:"POST",url:a.confPortalURL+e+"/participants/"+r.participantId+"/subscribe",headers:a.authService.getRequestHeader()}).then(function(e){a.$log.info("[ConferenceService] subscribeToPublisher successfully"),t(e.data)},function(e){var t="subscribeToPublisher failure: "+(e.data?e.data.errorDetails:e.data);a.$log.error("[ConferenceService] "+t),n(new Error(t))})})},e.prototype.isUserContactInCall=function(){for(var e in this.webConferenceService.conferenceSessions){if(this.webConferenceService.conferenceSessions.hasOwnProperty(e))if(this.webConferenceService.conferenceSessions[e].isParticipantConnectedByJid(this.contactService.userContact.jid))return!0}return!1},e.prototype.stopAllConferencesFromRoom=function(e){var t=[],n=e.getPstnConfEndpointId(),r=e.getSFUSharingConfEndpointId(),i=e.getSFUConfEndpointId();return n&&t.push(this.stopConference(n)),r&&t.push(this.stopConference(r,"webrtc")),i&&t.push(this.stopConference(i,"webrtc")),this.$q.all(t)},e.prototype.refreshConferenceSessions=function(){var e=[];return e.push(this.webConferenceService.refreshConferenceSessions()),e.push(this.pstnConferenceService.refreshConferenceSessions()),this.$q.all(e)},e.$inject=["$q","$log","$rootScope","$interval","$translate","$http","xmppService","authService","Conference","profileService","contactService","webConferenceService","pstnConferenceService","roomService"],e}();angular.module("rainbow").service("conferenceService",ConferenceService),angular.module("rainbow").service("profileService",["$q","$rootScope","$log","$http","$interval","Offer","authService","contactService",function(e,a,o,i,t,r,s,c){"use strict";var l=this;l.FeaturesEnum={COMPANY_ADMIN_COUNT:"COMPANY_ADMIN_COUNT",COMPANY_LOGO_MODIFICATION:"COMPANY_LOGO_MODIFICATION",COMPANY_DOMAIN_NAME_MODIFICATION:"COMPANY_DOMAIN_NAME_MODIFICATION",COMPANY_DETAILS_MODIFICATION:"COMPANY_DETAILS_MODIFICATION",WEBRTC_FOR_MOBILE:"WEBRTC_FOR_MOBILE",BUBBLE_PARTICIPANT_COUNT:"BUBBLE_PARTICIPANT_COUNT",TELEPHONY_BASIC_CALL:"TELEPHONY_BASIC_CALL",TELEPHONY_SECOND_CALL:"TELEPHONY_SECOND_CALL",TELEPHONY_TRANSFER_CALL:"TELEPHONY_TRANSFER_CALL",TELEPHONY_CONFERENCE_CALL:"TELEPHONY_CONFERENCE_CALL",TELEPHONY_DEFLECT_CALL:"TELEPHONY_DEFLECT_CALL",TELEPHONY_PHONE_BOOK:"TELEPHONY_PHONE_BOOK",TELEPHONY_VOICE_MAIL:"TELEPHONY_VOICE_MAIL",TELEPHONY_CALL_FORWARD:"TELEPHONY_CALL_FORWARD",TELEPHONY_NOMADIC:"TELEPHONY_NOMADIC",CONFERENCE_PARTICIPANT_COUNT:"CONFERENCE_PARTICIPANT_COUNT",CONFERENCE_PARTICIPANT_ALLOWED:"CONFERENCE_PARTICIPANT_ALLOWED",WEBRTC_CONFERENCE_ALLOWED:"WEBRTC_CONFERENCE_ALLOWED",WEBRTC_CONFERENCE_PARTICIPANT_COUNT:"WEBRTC_CONFERENCE_PARTICIPANT_COUNT",WEBRTC_PARTICIPANT_ALLOWED:"WEBRTC_PARTICIPANT_ALLOWED",CONFERENCE_ALLOWED:"CONFERENCE_ALLOWED",CONFERENCE_DIAL_OUT:"CONFERENCE_DIAL_OUT",CONFERENCE_RECORDING:"CONFERENCE_RECORDING",MSO365_CALENDAR_PRESENCE:"MSO365_CALENDAR_PRESENCE",MSO365_DIRECTORY_SEARCH:"MSO365_DIRECTORY_SEARCH",MS_OUTLOOK_PLUGIN:"MS_OUTLOOK_PLUGIN",MS_SKYPE_PLUGIN:"MS_SKYPE_PLUGIN",FILE_SHARING_QUOTA_GB:"FILE_SHARING_QUOTA_GB",GOOGLE_CALENDAR_PRESENCE:"GOOGLE_CALENDAR_PRESENCE",WEBRTC_P2P_RECORDING:"WEBRTC_P2P_RECORDING",BUBBLE_PROMOTE_MEMBER:"BUBBLE_PROMOTE_MEMBER",BUBBLE_GUESTS_ALLOWED:"BUBBLE_GUESTS_ALLOWED",TELEPHONY_WEBRTC_GATEWAY:"TELEPHONY_WEBRTC_GATEWAY",TELEPHONY_WEBRTC_PSTN_CALLING:"TELEPHONY_WEBRTC_PSTN_CALLING",ANALYTICS_DASHBOARD_EC:"ANALYTICS_DASHBOARD_EC",ANALYTICS_DASHBOARD_BP:"ANALYTICS_DASHBOARD_BP",TELEPHONY_CALL_SUBJECT:"CALL_SUBJECT",CHANNEL_CREATE:"CHANNEL_CREATE",CHANNEL_CREATE_ADMIN_ROLE_BYPASS:"CHANNEL_CREATE_ADMIN_ROLE_BYPASS",CHANNEL_ACTIVATED:"CHANNEL_ACTIVATED"},l.started=!1,l.start=function(r){o.info(""),o.info("[profileService] === STARTING ==="),l.features={},l.profiles=[],l.mainOffers=[];var i=performance.now();return e(function(t,n){l.getServerProfile().then(function(){l.started=!0;var e=Math.round(performance.now()-i);r.push({service:"profileService",startDuration:e}),o.info("[profileService] === STARTED ("+e+" ms) ==="),a.$broadcast("ON_PROFILE_FEATURES_UPDATED"),a.$on("$destroy",a.$on("ON_PROFILE_FEATURES_UPDATE_NEEDED",l.onUserUpdateNeeded)),t()}).catch(function(e){o.info("[profileService] === STARTING FAILURE === "+e.message),n(e)})})},l.stop=function(){return o.info("[profileService] === STOPPING ==="),l.started=!1,o.info("[profileService] === STOPPED ==="),e.when()},l.restart=function(){o.info("[profileService] === RESTART ==="),l.onUserUpdateNeeded()},l.onUserUpdateNeeded=function(e){l.timer||(l.timer=t(function(){l.getServerProfile().then(function(){a.$broadcast("ON_PROFILE_FEATURES_UPDATED"),l.timer=null}).catch(function(e){l.timer=null,o.info("[profileService] === onUserUpdateNeeded FAILURE === "+e.message)})},3e3,1))},l.getServerProfile=function(){return e.all([l.getServerProfiles(),l.getServerProfilesFeatures()])},l.getServerProfiles=function(){return e(function(t,n){i({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+c.userContact.dbId+"/profiles",headers:s.getRequestHeader()}).then(function(e){l.profiles=[],l.mainOffers=[],e.data.data.forEach(function(e){o.debug("[profileService] getServerProfiles === response ==="+e),l.profiles.push(e);var t=r.createFromProfileData(e);(t.isExclusive||t.isDefault)&&l.mainOffers.push(t)}),l.mainOffers.sort(r.offerComparator),t()},function(e){var t="getServerProfiles failure: no server response";e&&(t="getServerProfiles failure: "+JSON.stringify(e)),o.error("[profileService] "+t),n(new Error(t))})})},l.getServerProfilesFeatures=function(){return e(function(t,n){i({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+c.userContact.dbId+"/profiles/features",headers:s.getRequestHeader()}).then(function(e){l.features={},e.data.data.forEach(function(e){o.debug("[profileService] getServerProfilesFeatures === response ==="+JSON.stringify(e)),e.hasOwnProperty("featureUniqueRef")&&(l.features[e.featureUniqueRef]=e)}),t()},function(e){var t="getServerProfilesFeatures failure: no server response";e&&(t="getServerProfilesFeatures failure: "+JSON.stringify(e)),o.error("[profileService] "+t),n(new Error(t))})})},l.getUserData=function(){return s.getUserData()},l.setUserData=function(r){return e(function(t,n){var e=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+c.userContact.dbId;i({method:"PUT",url:e,headers:s.getRequestHeader(),data:r}).then(function(e){o.info("[profileService] setUserData "+JSON.stringify(r)+" -- success"),t(e.data)},function(e){var t="setUserData failure: no server response";e&&(t="setUserData failure: "+JSON.stringify(e)),o.error("[profileService] "+t),n(new Error(t))})})},l.isFeatureEnabled=function(e){if(l.started&&l.features.hasOwnProperty(e)&&l.features[e].hasOwnProperty("featureType")&&"boolean"===l.features[e].featureType&&l.features[e].hasOwnProperty("isEnabled")){var t=l.features[e].isEnabled;return o.debug("[profileService] isFeatureEnabled("+e+"): "+t),t}return o.info("[profileService] isFeatureEnabled("+e+"): service not started or feature not enabled"),!1},l.getFeatureLimitMax=function(e){if(l.started&&l.features.hasOwnProperty(e)&&l.features[e].hasOwnProperty("featureType")&&"number"===l.features[e].featureType&&l.features[e].hasOwnProperty("limitMax")){var t=l.features[e].limitMax;return o.debug("[profileService] getFeatureLimitMax("+e+"): "+t),t}return o.info("[profileService] getFeatureLimitMax("+e+"): service not started or feature not enabled"),0},l.getFeatureLimitMin=function(e){if(l.started&&l.features.hasOwnProperty(e)&&l.features[e].hasOwnProperty("featureType")&&"number"===l.features[e].featureType&&l.features[e].hasOwnProperty("limitMin")){var t=l.features[e].limitMin;return o.debug("[profileService] getFeatureLimitMin("+e+"): "+t),t}return o.info("[profileService] getFeatureLimitMin("+e+"): service not started or feature not enabled"),0},l.getMyProfileOffer=function(){return 0<l.mainOffers.length?l.mainOffers.slice(-1)[0]:null},l.getMyProfileName=function(){var e=this.getMyProfileOffer();return e?e.name:null},l.getMyProfiles=function(){var e=[];return l.started?e=l.profiles:o.warn("[profileService] getMyProfiles(): service not started"),e},l.getMyProfileFeatures=function(){var r={};return l.started?Object.keys(l.features).forEach(function(e){var t=l.features[e],n={};Object.keys(t).filter(function(e){return"featureUniqueRef"===e||"featureType"===e||"limitMin"===e||"limitMax"===e||"isEnabled"===e}).forEach(function(e){n[e]=t[e]}),r[e]=n}):o.warn("[profileService] getMyProfileFeatures(): service not started"),r}}]),angular.module("rainbow").service("updatingService",["$http","$log","$rootScope","$interval","randomString","centralizedService",function(e,i,a,t,n,o){"use strict";var r=this;r.url=window.location.origin+"/app/"+version+"/js/version.js",r.started=!1,r.start=function(){i.info("[updatingService] === STARTING ==="),r.started=!0,i.info("[updatingService] === STARTED ==="),-1===r.url.indexOf("localhost")?(r.interval&&t.cancel(r.interval),r.interval=t(r.checkUpdate,6e5),o.isDesktopApp()&&(r.intervalDesktop&&t.cancel(r.intervalDesktop),r.intervalDesktop=t(r.checkUpdateForDesktop,6e4))):i.info("[updatingService] Do not start on localhost")},r.checkUpdate=function(){i.info("[updatingService] - Checking if a new version is online..."),e({method:"GET",url:r.url+"?rand="+n()}).then(function(){i.info("[updatingService] - The web client is up to date")},function(e){404===e.status?a.$broadcast("ON_AVAILABLE_UPDATE"):i.info("[updatingService] - An unknow error has been encountered.")})},r.checkUpdateForDesktop=function(){var e=o.containerVersion();if(i.info("[updatingService] - Checking if a new desktop version is available... "+e),!e){var t=navigator.userAgent.substring(navigator.userAgent.indexOf("Rainbow"));t&&(e=t.split("/")[1])}if(e){var n=e.split(".");if(parseInt(n[1],10)<35||35===parseInt(n[1],10)&&parseInt(n[2],10)<=4){i.info("[updatingService] - should update from version "+e);var r={popupTitle:"updatingDesktopTitle",popupBody:"updatingDesktopMessage",okLabel:"download",okLink:config.autorizationMicrosoftLink,blockingPopup:!0};0<=navigator.platform.toUpperCase().indexOf("MAC")?r.okLink=config.clientsURL.mac:r.okLink=config.clientsURL.windows,a.$broadcast("ON_OPEN_GLOBAL_POPUP",r)}}else i.error("[updatingService] - no desktop version found !! ")},r.stop=function(){i.info("[updatingService] === STOPPING ==="),r.started=!1,r.interval&&t.cancel(r.interval),r.intervalDesktop&&t.cancel(r.intervalDesktop),i.info("[updatingService] === STOPPED ===")}}]),angular.module("rainbow").service("calendarService",["$q","$rootScope","$log","$http","$interval","authService","contactService","xmppService","errorHelperService","profileService","conversationService","settingsService",function(o,s,c,l,r,d,u,e,i,a,t,f){"use strict";var h=this;this.intervalID=null,this.start=function(e){c.info(""),c.info("[calendarService] === STARTING ===");var t=performance.now();h.autorizationLink="",h.autorizationPopup=null,h.serviceActivated=!1,c.info("[calendarService] listen 'out of office' status for roster contacts"),r(h.getAutoReplyForEachContact,5e3,1),h.intervalID=r(h.updateAutoReplyForEachContact,9e5),h.officeCalendarPresenceEnabled=a.isFeatureEnabled(a.FeaturesEnum.MSO365_CALENDAR_PRESENCE),h.googleCalendarPresenceEnabled=a.isFeatureEnabled(a.FeaturesEnum.GOOGLE_CALENDAR_PRESENCE),h.calendarPresenceEnabled=h.officeCalendarPresenceEnabled||h.googleCalendarPresenceEnabled,c.info("[calendarService] calendar presence status from profileService : "+h.calendarPresenceEnabled),h.disableCalendarPresencePrompt="true"===f.getSetting("disableCalendarPresence"),c.info("[calendarService] calendar presence prompt status from userSettings : "+!h.disableCalendarPresencePrompt);var n=Math.round(performance.now()-t);return e.push({service:"calendarService",startDuration:n}),c.info("[calendarService] === STARTED ("+n+" ms) ==="),h.calendarPresenceEnabled&&!u.userContact.guestMode&&(h.attachHandlers(),h.calendarPresenceChangeListener=s.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",h.onCalendarPresenceChange),h.connectionStateChangeListener=s.$on("ON_CONNECTION_STATE_CHANGE_EVENT",h.onConnectionStateChange),h.getCalendarState().then(function(e){if("none"!==e.status&&"deleted"!==e.status){h.serviceActivated=!0;var t=e.until?new Date(e.until):null,n=e.busy?"busy":"online";h.updateCalendarPresenceForUser(u.userContact.jid,n,t)}else"consent_required"===e.status?(c.info("[calendarService] calendar status -- "+e.status+" -- showPopup"),h.registerCalendars(!1)):h.disableCalendarPresencePrompt||(c.info("[calendarService] calendar status -- "+e.status+" -- showPopup"),h.registerCalendars(!1))}).catch(function(e){console.error(e),h.serviceActivated=!1,c.error("[calendarService] === STARTING FAILURE ===")})),o.when()},this.stop=function(){return c.info("[calendarService] === STOPPING ==="),h.serviceActivated=!1,h.calendarPresenceChangeListener&&h.calendarPresenceChangeListener(),h.connectionStateChangeListener&&h.connectionStateChangeListener(),this.messageHandlerRef&&(e.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),h.intervalID&&r.cancel(h.intervalID),c.info("[calendarService] === STOPPED ==="),o.when()},this.attachHandlers=function(){c.info("[calendarService] attachHandlers"),this.messageHandlerRef&&(e.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.messageHandlerRef=e.addHandler(function(e){return h.onUpdateMessageReceived(e),!0},"jabber:iq:configuration","message",null)},this.onConnectionStateChange=function(e,t){"connected"===t&&(c.info("[calendarService] onConnectionStateChange state:"+t),h.getCalendarState().then(function(e){if("none"!==e.status&&"deleted"!==e.status&&"consent_required"!==e.status){h.serviceActivated=!0;var t=new Date(e.until),n=e.busy?"busy":"online";h.updateCalendarPresenceForUser(u.userContact.jid,n,t)}}))},this.onUpdateMessageReceived=function(e){var t=$(e).find("calendar");if(t.length){var n=t.attr("status");c.info("[calendarService] onUpdateMessageReceived with status : "+n),h.serviceActivated="enabled"===n,s.$broadcast("ON_CALENDAR_STATUS_CHANGE",h.serviceActivated)}return!0},this.onCalendarPresenceChange=function(e,t){if(u.isTelJid(t.jid)&&"calendar"===u.getRessourceFromJid(t.jid)){var n=u.getImJid(t.jid);n&&(c.info("[calendarService] onCalendarPresenceChange -- status "+t.status),h.updateCalendarPresenceForUser(n,t.status,t.until,t.message))}},this.updateAutoReplyForEachContact=function(){h.getAutoReplyInfoForContact(u.userContact),h.getAutoReplyForEachContact()},this.getAutoReplyForEachContact=function(){c.info("[calendarService] getAutoReplyForEachContact"),t.getConversations().forEach(function(e){null!==e.contact&&h.getAutoReplyInfoForContact(e.contact)})},this.getAutoReplyInfoForContact=function(r){return o(function(t,n){if(!r.calendarState.status)return c.info("[calendarService] getAutoReplyInfoForContact user has no calendar state"),void t();if(r.calendarState.lastUpdate){var e=moment.duration(r.calendarState.lastUpdate.diff(moment()));if(Math.abs(Math.floor(e.asMinutes()))<15)return c.info("[calendarService] getAutoReplyInfoForContact state has been updated in the last 15min"),void t()}r.calendarState.lastUpdate=moment(),l({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/automatic_reply?userid="+r.jid,headers:d.getRequestHeader()}).then(function(e){h.treatOutOfOfficeState(e.data,r),c.info("[calendarService] getAutoReplyInfoForContact success for contact "+r.jid),t()},function(e){var t=i.handleError(e);c.error("[calendarService] "+i.getErrorFullMessage(e,"getAutoReplyInfoForContact")),n(t)})})},this.getCalendarState=function(){return o(function(t,e){l({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:d.getRequestHeader()}).then(function(e){c.info("[calendarService] getCalendarState success -- status "+e.data.status),t(e.data)},function(){c.error("[calendarService] getCalendarState failure -- CalendarService portal not responding"),e()})})},this.registerCalendars=function(n){return o(function(t){if(h.serviceActivated)c.warn("[calendarService] registerCalendars -- already registered, ignore !"),t();else{c.info("[calendarService] registerCalendars");var e=[];h.officeCalendarPresenceEnabled&&e.push(h.getCalendarRegistrationInfo("office365")),h.googleCalendarPresenceEnabled&&e.push(h.getCalendarRegistrationInfo("googleCalendar")),o.all(e).finally(function(){if(h.autorizationGoogleLink||h.autorizationMicrosoftLink){var e={authentMicrosoftUrl:h.autorizationMicrosoftLink,authentGoogleUrl:h.autorizationGoogleLink,fromSettings:n};c.info("[calendarService] registerCalendars -- show registration popup"),s.$broadcast("ON_OPEN_CALENDARSELECTION_POPUP",e),t()}else c.error("[calendarService] registerCalendars -- no calendar provider response"),t()})}})},this.getCalendarRegistrationInfo=function(r){var i="o365",a="office365";return"googleCalendar"===r&&(i="gcal",a="google"),o(function(t,n){var e=f.getAppliLanguage().code;l({method:"POST",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/register",headers:d.getRequestHeader(),data:{type:a,callback:window.location.origin+"/redirectO365.html?provider="+i+"&lang="+e}}).then(function(e){c.info("[calendarService] getCalendarRegistrationInfo for "+r+" -- success"),h.autorizationLink=e.data.url,"googleCalendar"===r?h.autorizationGoogleLink=h.autorizationLink:h.autorizationMicrosoftLink=h.autorizationLink,t(h.autorizationLink)},function(e){c.error("[calendarService] getCalendarRegistrationInfo failure"),c.error(e),n()})})},this.deactivateCalendar=function(){return c.info("[calendarService] deactivateCalendar"),o(function(e,t){l({method:"DELETE",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:d.getRequestHeader()}).then(function(){c.info("[calendarService] deactivateCalendar success"),h.serviceActivated=!1,e()},function(e){c.error("[calendarService] deactivateCalendar failure"),c.error(e),t()})})},this.updateCalendarPresenceForUser=function(n,r,i,a){u.getOrCreateContact(n).then(function(e){e.calendarState.status=r,e.calendarState.message=a;var t=null;"online"===r||i||(i=new Date),i&&(t=moment(i)),(e.calendarState.mdate=t)?t.isSame(moment(),"d")?(e.calendarState.until=t.format("LT"),e.calendarState.untilDate=!1):(e.calendarState.until=t.format("ll"),e.calendarState.untilDate=!0):(i||(i=new Date),e.calendarState.until=i,e.calendarState.untilDate=!1),u.isUserContact(e)?(c.info("[calendarService] updateCalendarPresenceForUser for my user : "+r+" until "+i),h.serviceActivated||"offline"===r||(h.serviceActivated=!0,s.$broadcast("ON_CALENDAR_STATUS_CHANGE",h.serviceActivated)),h.getAutoReplyInfoForContact(u.userContact)):c.info("[calendarService] updateCalendarPresenceForUser for user : "+n+" with : "+r+" until "+i),s.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",e)}).catch(function(e){c.error("[calendarService] updateCalendarPresenceForUser failure for user "+n+" with error : "+e)})},this.treatOutOfOfficeState=function(e,t){if(c.info("[calendarService] treatOutOfOfficeState for user : "+t.jid+" with data enabled "+e.enabled+" and text "+e.message_text+" and date end "+e.end),e.enabled){if(t.calendarState.autoReplyOn=!0,t.calendarState.autoReplyInfos={},e.message_text&&(t.calendarState.autoReplyInfos.message=e.message_text),e.end){var n=moment(e.end);(t.calendarState.autoReplyInfos.mdate=n)?n.isSame(moment(),"d")?(t.calendarState.autoReplyInfos.until=n.format("LT"),t.calendarState.autoReplyInfos.untilDate=!1):(t.calendarState.autoReplyInfos.until=n.format("ll"),t.calendarState.autoReplyInfos.untilDate=!0):(t.calendarState.autoReplyInfos.until=e.end,t.calendarState.autoReplyInfos.untilDate=!0)}s.$broadcast("ON_CALENDAR_STATUS_CHANGE",h.serviceActivated)}else t.calendarState.autoReplyOn=!1,t.calendarState.autoReplyInfos={};s.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",t)},this.calendarCancelCallback=function(){h.serviceActivated=!1,f.setSetting("disableCalendarPresence",!0),u.setUserSettings({promptForCalendarPresence:!1}),s.$broadcast("ON_CALENDAR_STATUS_CHANGE",!1)},this.calendarLaterCallback=function(){h.serviceActivated=!1,s.$broadcast("ON_CALENDAR_STATUS_CHANGE",!1)}}]);var RecordsService=function(){function e(e,t,n,r,i,a,o){this.$q=e,this.$rootScope=t,this.$log=n,this.fileServerService=r,this.fileStorageService=i,this.xmppService=a,this.$interval=o,this.started=!1,this.recording=!1,this.upload=!1,this.filename="",this.recordStopOrigin="LOCAL"}return e.prototype.start=function(){return this.started=!1,this.recording=!1,this.recorder=null,this.data=[],this.audioContext=null,this.recordBuffer=null,this.recordFile=null,this.initConversationRecordContext(),this.$log.info("[RecordsService] start"),this.$q.when()},e.prototype.stop=function(){return this.$log.info("[RecordsService stop"),this.started&&(this.started=!1),this.$q.when()},e.prototype.onDataAvailable=function(e){this.$log.info("[RecordService] >onDataAvailable: size = "+e.data.size),0<e.data.size&&this.data.push(e.data)},e.prototype.onStop=function(){this.recordBuffer=new Blob(this.data,{type:"video/mp4"}),this.recordFile={name:this.filename,extension:"mp4",size:this.recordBuffer.size},this.data=[],this.recording=!1,this.recorder=null,this.$rootScope.$broadcast("ON_OPEN_RECORDINGFILESTORAGE_POPUP",this.recordFile,this.recordStopOrigin),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_SAVED",this.recordFile,this.recordBuffer,this.recordStopOrigin),this.recordStopOrigin="LOCAL"},e.prototype.closeAudioContext=function(){this.audioContext&&(this.audioContext.destination&&this.audioContext.destination.disconnect(),"closed"!==this.audioContext.state&&(this.audioContext.close(),this.audioContext=null))},e.prototype.cleanRecord=function(){!1!==this.recording?this.$log.error("[RecordsService] Unexpected record cleaning while recording not stopped"):(this.recordBuffer=null,this.recordFile=null)},e.prototype.onError=function(e){this.$log.error("[RecordService] error : "+e.message||e.name),this.recording=!1,this.stopConvTimer(),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_ERROR")},e.prototype.createRecord=function(e,t,n,r,i,a){var o=this;void 0===t&&(t="REMOTE"),void 0===n&&(n=!1),void 0===r&&(r=""),void 0===i&&(i=!1);var s=null,c=null,l=null,d=null,u=[];this.recorder=null,this.upload=n,this.filename=r;var f=!1,h=null,p=null,v=null;if(a&&MediaRecorder.isTypeSupported(a)?s={mimeType:a}:MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?s={mimeType:"video/webm; codecs=vp9"}:MediaRecorder.isTypeSupported("video/webm;codecs=vp8")?s={mimeType:"video/webm; codecs=vp8"}:MediaRecorder.isTypeSupported("video/webm;codecs=h264")?s={mimeType:"video/webm; codecs=h264"}:MediaRecorder.isTypeSupported("video/mpeg")&&(s={mimeType:"video/mpeg"}),null===s)return this.$log.error("[RecordsService] Codecs : "+a+" are not available for the navigator"),!1;if(this.$log.info("[RecordsService] createRecord -- mimeType used "+s.mimeType),c=this.xmppService.connection.jingle.sessions[e].localStreams,l=this.xmppService.connection.jingle.sessions[e].remoteStreams,f=c&&c.length&&null!==c[0]||l&&l.length&&null!==l[0],null!==this.recorder||!f)return this.$log.error("[RecordsService] Cannot get Stream"),!1;var m,g=null;for(m=0;m<l.length;m++)l[m]&&null!=l[m]&&(l[g=m].getAudioTracks().forEach(function(e){u.push(e),v=m,g=null}),null!==g&&(p=g));for(g=null,m=0;m<c.length;m++)c[m]&&null!=c[m]&&(c[g=m].getAudioTracks().forEach(function(e){u.push(e),m,g=null}),null!==g&&(h=g));if(this.audioContext&&(this.$log.error("[RecordsService] anomaly audio Context not previously released"),this.closeAudioContext()),u.length){this.audioContext=new AudioContext;var S=u.map(function(e){return o.audioContext.createMediaStreamSource(new MediaStream([e]))}),C=this.audioContext.createMediaStreamDestination();S.forEach(function(e){return e.connect(C)}),d=new MediaStream(C.stream)}else d=new MediaStream;return i||("LOCAL"===t&&null!==h?c[h].getVideoTracks().forEach(function(e){d.addTrack(e)}):null!==p?l[p].getVideoTracks().forEach(function(e){d.addTrack(e)}):l[v].getVideoTracks().forEach(function(e){d.addTrack(e)})),this.recorder=new MediaRecorder(d,s),this.recorder.ondataavailable=this.onDataAvailable.bind(this),this.recorder.onstop=this.onStop.bind(this),this.recorder.onerror=this.onError.bind(this),!0},e.prototype.uploadFile=function(){var i=this;return this.$q(function(t,n){var r=i.recordBuffer,e=i.recordFile;!1!==i.recording&&(i.$log.error("[RecordsService] Unexpected uploading file when recording not stopped"),n("recording not stopped pb")),0===e.size&&(i.$log.error("[RecordsService] error uploading empty file"),n("empty file pb")),i.fileStorageService.createFileDescriptor(e.name,e.extension,e.size).then(function(e){i.fileServerService.uploadAFileByChunk(e,r,void 0,function(){}).then(function(e){i.$log.info("[RecordsService] uploadFile success"),i.cleanRecord(),t()}).catch(function(e){i.$log.error("[RecordsService] Unexpected error while uploading file",e),n("server pb")})}).catch(function(e){i.$log.error("[RecordsService] Unexpected error while creating file descriptor!",e),n("file descriptor pb")})})},e.prototype.setRecordStopOrigin=function(e){e&&""!==e&&(this.recordStopOrigin=e)},e.prototype.localSaveFile=function(){var e=this.recordBuffer,t=this.recordFile;!1===this.recording?(this.downloadFile(e,null,null,t.name,!0),this.cleanRecord()):this.$log.error("[RecordsService] Unexpected file local storage when recording not stopped")},e.prototype.downloadFile=function(e,t,n,r,i){this.$log.info("[RecordsService] downloadFile -- default function")},e.prototype.startRecording=function(e){null!==this.recorder&&(e?this.recorder.start(e):this.recorder.start(),this.recording=!0,this.startConvTimer())},e.prototype.stopRecording=function(){null!==this.recorder&&(this.recorder.stop(),this.recording=!1,this.closeAudioContext()),this.stopConvTimer(),this.initConversationRecordContext()},e.prototype.pauseResumeRecording=function(){null!==this.recorder&&("recording"===this.recorder.state?(this.recorder.pause(),this.conversationRecordContext.pause=!0,this.stopConvTimer()):(this.recorder.resume(),this.conversationRecordContext.pause=!1,this.startConvTimer()))},e.prototype.setOnDataAvailableCallback=function(e){null!==this.recorder&&(this.recorder.ondataavailable=e)},e.prototype.setOnErrorCallback=function(e){null!==this.recorder&&(this.recorder.onerror=e)},e.prototype.setOnPauseCallback=function(e){null!==this.recorder&&(this.recorder.onpause=e)},e.prototype.setOnResumeCallback=function(e){null!==this.recorder&&(this.recorder.onresume=e)},e.prototype.setOnStartCallback=function(e){null!==this.recorder&&(this.recorder.onstart=e)},e.prototype.setOnStopCallback=function(e){null!==this.recorder&&(this.recorder.onstop=e)},e.prototype.initConversationRecordContext=function(){this.conversationRecordContext={conversationId:"",recorder:!1,pause:!1,actualRecordTime:0,updateTimer:null,recordStopSource:"LOCAL"}},e.prototype.getConversationRecordContext=function(e){return e===this.conversationRecordContext.conversationId?this.conversationRecordContext:null},e.prototype.setConversationRecordContext=function(e,t,n,r,i){e&&""!==e&&(this.conversationRecordContext.conversationId=e,this.conversationRecordContext.recorder=t&&this.recording,this.conversationRecordContext.pause=n,this.conversationRecordContext.actualRecordTime=r,this.conversationRecordContext.recordStopSource=i)},e.prototype.startConvTimer=function(){var e=this;this.conversationRecordContext.updateTimer=this.$interval(function(){e.conversationRecordContext.actualRecordTime++},1e3)},e.prototype.stopConvTimer=function(){null!==this.conversationRecordContext.updateTimer&&(this.$interval.cancel(this.conversationRecordContext.updateTimer),this.conversationRecordContext.updateTimer=null)},e.$inject=["$q","$rootScope","$log","fileServerService","fileStorageService","xmppService","$interval"],e}();angular.module("rainbow").service("recordsService",RecordsService),function(){"use strict";angular.module("rainbow").service("phonebookService",["$q","$rootScope","$log","$http","contactService","authService","orderByFilter","profileService","conversationService",function(e,i,a,o,s,c,l,d,t){this.search=function(n){return a.info("[phonebookService] search PBXContact from phonebook with text "+n),e(function(r,t){if(config.permitSearchFromPhoneBook||d.isFeatureEnabled(d.FeaturesEnum.TELEPHONY_PHONE_BOOK)){var e=config.restServerUrl+"/api/rainbow/search/v1.0/phonebooks?limit=20&name="+encodeURIComponent(n);o({method:"GET",url:e,headers:c.getRequestHeader()}).then(function(e){var t=e.data.phoneBooks;a.info("[phonebookService] search find "+t.length+" phonebooks contact(s)");var n=[];t.forEach(function(e){var t=s.createBasicContact(null,e.number);t.updateName(e.firstName,e.lastName),t.getAvatar(),n.push(t)}),n=l(n,"_displayName",!1),r(n)},function(e){e.data&&(401===e.data.errorCode&&i.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),a.warn("[phonebookService] search failure "+e.data.errorMsg)),t(new Error("phonebook service failure"))})}else{a.info("[phonebookService] search from phonebook not allowed for the user profile");r([])}})}}])}(),angular.module("rainbow").service("adminCompanyService",["$q","$log","$http","$rootScope","authService","errorHelperService","Company","contactService","settingsService","Site","CompanyInvitation","pushImageHelperService","CompanyRequest","companyService",function(v,m,g,o,S,C,E,b,c,i,s,l,a,R){"use strict";var y=this;y.start=function(){return m.info("[adminCompanyService] === STARTING ==="),y.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",m.info("[adminCompanyService] === STARTED ==="),v.when()},y.stop=function(){return m.info("[adminCompanyService] === STOPPING ==="),m.info("[adminCompanyService] === STOPPED ==="),v.when()},y.getCompanies=function(e,t,n,r,i,a,o,s,c,l,d,u){var f=v.defer(),h=b.userContact;if(!h.isSuperadmin()&&!h.isBPAdmin()&&!h.isOrganizationAdmin())return y.getCompany(h.company.id).then(function(e){return{companies:[e]}});var p=y.portalURL+"companies?format="+(i||"full");return e&&(p+="&organisationId="+e),t&&n&&(p+="&offset="+n*(t-1)),n&&(p+="&limit="+n),r&&(p+="&name="+r),a&&(p+="&bpId="+a),o&&(Array.isArray(o)?o.forEach(function(e){p+="&status="+e}):p+="&status="+o),null!=s&&(p+="&isBP="+s),c&&(p+="&bpType="+c),l&&(p+="&offerCanBeSold="+l),d&&(p+="&externalReference="+d),g({method:"GET",url:p,headers:S.getRequestHeader()}).then(function(e){var t=e.data.data;m.info("[adminCompanyService] getCompanies success");var n=[];t.forEach(function(e){var t=E.createFromData(e);!angular.isUndefined(u)&&u||R.getCompanyLogo(t),n.push(t)}),f.resolve({companies:n,limit:e.data.limit,offset:e.data.offset,total:e.data.total})},function(e){var t=C.handleError(e);f.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getCompanies"))}),f.promise},y.getAllCompaniesSmall=function(e,t,n,r,i){return y.getAllCompanies(e,t,n,r,i,"small")},y.getAllCompanies=function(a,e,n,r,o,s){return v(function(i,t){y.getCompanies(a,1,1e3,null,s,e,n,r,o).then(function(t){if(t.total>t.limit){for(var e=[],n=Math.ceil(t.total/1e3),r=2;r<=n;r++)e.push(y.getCompanies(a,r,1e3,null,"small").then(function(e){t.companies=t.companies.concat(e.companies),t.limit+=e.limit}));v.all(e).then(function(){i(t)})}else i(t)}).catch(function(e){t(e)})})},y.getCompany=function(e){return v(function(r,n){g({method:"GET",url:y.portalURL+"companies/"+e,headers:S.getRequestHeader()}).then(function(e){m.info("[adminCompanyService] getCompany success");var t=e.data.data,n=E.createFromData(t);R.getCompanyLogo(n),R.getCompanyBanner(n),r(n)},function(e){var t=C.handleError(e);n(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getCompany"))})})},y.getDefaultCompany=function(){return v(function(r,n){g({method:"GET",url:y.portalURL+"companies/default",headers:S.getRequestHeader()}).then(function(e){m.info("[adminCompanyService] getDefaultCompany success");var t=e.data.data,n=E.createFromData(t);r(n)},function(e){var t=C.handleError(e);n(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getDefaultCompany"))})})},y.searchCompanies=function(e){var n=v.defer(),r=e.toLowerCase();return y.getCompanies().then(function(e){var t=e.companies.filter(function(e){return-1<e.name.toLowerCase().indexOf(r)});n.resolve(t)}),n.promise},y.createCompany=function(e){var t=E.prune(e,b.userContact),n=v.defer();return g({method:"POST",url:y.portalURL+"companies",headers:S.getRequestHeader(),data:t}).then(function(e){m.info("[adminCompanyService] createCompany success");var t=E.createFromData(e.data.data);o.$broadcast("ADMIN_COMPANIES_CHANGE"),n.resolve(t)},function(e){var t=C.handleError(e);n.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"createCompany"))}),n.promise},y.createCompanyEndUser=function(e){var t=E.prune(e,b.userContact),r=v.defer();return g({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/companies",headers:S.getRequestHeader(),data:t}).then(function(e){m.info("[adminCompanyService] createCompany success");var t=e.data.data,n=E.createFromData(t);r.resolve(n)},function(e){var t=C.handleError(e);r.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"createCompanyEndUser"))}),r.promise},y.updateCompany=function(r){var e=E.prune(r,b.userContact),i=v.defer();return g({method:"PUT",url:y.portalURL+"companies/"+r.id,headers:S.getRequestHeader(),data:e}).then(function(e){m.info("[adminCompanyService] updateCompany success");var t=e.data.data,n=E.createFromData(t);i.resolve(n),o.$broadcast("ON_COMPANY_CHANGE_EVENT",r.id)},function(e){var t=C.handleError(e);i.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"updateCompany"))}),i.promise},y.addVisibility=function(e,t){var n=v.defer();return g({method:"POST",url:y.portalURL+"companies/"+e+"/visible-by/"+t,headers:S.getRequestHeader()}).then(function(){m.info("[adminCompanyService] addVisibility success"),n.resolve()},function(e){var t=C.handleError(e);n.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"addVisibility"))}),n.promise},y.removeVisibility=function(e,t){var n=v.defer();return g({method:"DELETE",url:y.portalURL+"companies/"+e+"/visible-by/"+t,headers:S.getRequestHeader()}).then(function(){m.info("[adminCompanyService] removeVisibility success"),n.resolve()},function(e){var t=C.handleError(e);n.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"removeVisibility"))}),n.promise},y.getAllSiteCompany=function(e){var r=v.defer();return g({method:"GET",url:y.portalURL+"companies/"+e+"/sites",headers:S.getRequestHeader()}).then(function(e){m.info("[adminCompanyService] getAllSiteCompany success");var t=e.data.data,n=[];t.forEach(function(e){var t=i.createFromData(e);n.push(t)}),r.resolve(n)},function(e){var t=C.handleError(e);r.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getAllSiteCompany"))}),r.promise},y.getCompanyAdministrators=function(e){return v(function(r,n){g({method:"GET",url:y.portalURL+"companies/"+e+"/administrators",headers:S.getRequestHeader()}).then(function(e){m.info("[adminCompanyService] getCompanyAdministrators success");var t=e.data.data,n=[];t.forEach(function(e){var t={id:e.id};n.push(t)}),r(n)},function(e){var t=C.handleError(e);n(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getCompanyAdministrators"))})})},y.deleteCompany=function(e){var n=v.defer();return g({method:"DELETE",url:y.portalURL+"companies/"+e,headers:S.getRequestHeader()}).then(function(){m.info("[adminCompanyService] deleteCompany success"),n.resolve()},function(e){var t=C.handleError(e);n.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"deleteCompany"))}),n.promise},y.pushLogo=function(r,i,a){return v(function(e,t){var n=y.portalURL+"companies/"+r+"/avatar";(angular.isDefined(i)&&null!==i?l.pushImage(n,i):v.resolve()).then(function(){return y.getCompany(r)}).then(function(e){return e.avatarShape=a,y.updateCompany(e)}).then(function(){o.$broadcast("ON_COMPANY_CHANGE_EVENT",r),m.info("[adminCompanyService] pushLogo success"),e()}).catch(function(e){t(e)})})},y.deleteLogo=function(t){return v(function(e,n){g({method:"DELETE",url:y.portalURL+"companies/"+t+"/avatar",headers:S.getRequestHeader()}).then(function(){o.$broadcast("ON_COMPANY_CHANGE_EVENT",t),y.getCompany(t).then(function(e){return e.avatarShape="circle",y.updateCompany(e)}).then(function(){m.info("[adminCompanyService] deleteLogo success"),e()}).catch(function(e){n(e)})},function(e){var t=C.handleError(e);n(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"deleteLogo"))})})},y.pushBanner=function(r,i,a){return v(function(e,t){var n=y.portalURL+"companies/"+r+"/banner";return l.pushImage(n,i,a).then(function(){o.$broadcast("ON_COMPANY_CHANGE_EVENT",r),e()}).catch(function(e){t(e)})})},y.deleteBanner=function(t){return v(function(e,n){g({method:"DELETE",url:y.portalURL+"companies/"+t+"/banner",headers:S.getRequestHeader()}).then(function(){o.$broadcast("ON_COMPANY_CHANGE_EVENT",t),m.info("[adminCompanyService] deleteBanner success"),e()},function(e){var t=C.handleError(e);n(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"deleteBanner"))})})},y.getCompanyInvitations=function(r,i,a){return v(function(t,n){var e=y.portalURL+"companies/"+r+"/join-companies/invitations?format=medium&status=pending declined&limit="+a;i&&(e+="&offset="+a*(i-1)),g({method:"GET",url:e,headers:S.getRequestHeader()}).then(function(e){var n=[];e.data.data.forEach(function(e){var t=s.createFromData(e);n.push(t)}),m.info("[adminCompanyService] getCompanyInvitations success (found "+n.length+" invitation(s))"),t({invitations:n,total:e.data.total})},function(e){var t=C.handleError(e);n(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getCompanyInvitations"))})})},y.joinCompanyInvitation=function(e,t,n,r,i,a){var o=v.defer(),s={lang:c.getAppliLanguageCodeForServer()};return r&&(s.customMessage=r),n?s.invitedUserId=n:t&&(s.email=t),i&&(s.invitedToBeCompanyAdmin=i),a&&(s.invitedToBeBpAdmin=a),g({method:"POST",url:y.portalURL+"companies/"+e+"/join-companies/invitations",headers:S.getRequestHeader(),data:s}).then(function(){m.info("[adminCompanyService] joinCompanyInvitation success"),o.resolve()},function(e){var t=C.handleError(e);o.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"joinCompanyInvitation"))}),o.promise},y.cancelJoinCompanyInvitation=function(e,t){var n=v.defer();return g({method:"POST",url:y.portalURL+"companies/"+e+"/join-companies/invitations/"+t+"/cancel",headers:S.getRequestHeader()}).then(function(e){var t=s.createFromData(e.data.data);m.info("[adminCompanyService] cancelJoinCompanyInvitation success"),n.resolve(t)},function(e){var t=C.handleError(e);n.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"cancelJoinCompanyInvitation"))}),n.promise},y.resendJoinCompanyInvitation=function(e,t){var n=v.defer();return g({method:"POST",url:y.portalURL+"companies/"+e+"/join-companies/invitations/"+t+"/re-send",headers:S.getRequestHeader()}).then(function(e){var t=s.createFromData(e.data.data);m.info("[adminCompanyService] resendJoinCompanyInvitation success"),n.resolve(t)},function(e){var t=C.handleError(e);n.reject(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"resendJoinCompanyInvitation"))}),n.promise},y.getCompanyJoinRequests=function(e){return v(function(t,n){g({method:"GET",url:y.portalURL+"companies/"+e+"/join-companies/requests?format=medium&status=pending",headers:S.getRequestHeader()}).then(function(e){var n=[];e.data.data.forEach(function(e){var t=a.createFromData(e);n.push(t)}),m.info("[adminCompanyService] getCompanyJoinRequests success (found "+e.data.total+" invitation(s))"),t({companyRequests:n,total:e.data.total})},function(e){var t=C.handleError(e);n(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getCompanyJoinRequests"))})})},y.getJoinCompanyRequest=function(e,t){return v(function(n,r){g({method:"GET",url:y.portalURL+"companies/"+e+"/join-companies/requests/"+t+"?status=pending",headers:S.getRequestHeader()}).then(function(e){var t=a.createFromData(e.data.data);m.info("[adminCompanyService] getJoinCompanyRequest success"),n(t)},function(e){var t=C.handleError(e);r(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getJoinCompanyRequest"))})})},y.acceptCompanyJoinRequests=function(e,t){return v(function(n,r){g({method:"POST",url:y.portalURL+"companies/"+e+"/join-companies/requests/"+t+"/accept",headers:S.getRequestHeader()}).then(function(e){var t=a.createFromData(e.data.data);m.info("[adminCompanyService] acceptCompanyJoinRequests success"),n(t)},function(e){var t=C.handleError(e);m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"acceptCompanyJoinRequests")),r(t)})})},y.declineCompanyJoinRequests=function(e,t){return v(function(n,r){g({method:"POST",url:y.portalURL+"companies/"+e+"/join-companies/requests/"+t+"/decline",headers:S.getRequestHeader()}).then(function(e){var t=a.createFromData(e.data.data);m.info("[adminCompanyService] declineCompanyJoinRequests success"),n(t)},function(e){var t=C.handleError(e);m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"declineCompanyJoinRequests")),r(t)})})},y.getOAuthConsentUrl=function(){var e=c.getAppliLanguage().code;return v(function(n,r){g({method:"GET",url:config.restServerUrl+"/api/rainbow/office365/v1.0/consent?callback="+window.location.origin+"/redirectO365.html?provider=o365&lang="+e,headers:S.getRequestHeader()}).then(function(e){var t=e.data.url;m.info("[adminCompanyService] getOAuthConsentUrl success: "+t),n(t)},function(e){var t=C.handleError(e);m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getOAuthConsentUrl")),r(t)})})},y.getCompanyConferenceSettings=function(e){return v(function(n,r){g({method:"GET",url:y.portalURL+"companies/"+e+"/settings/conferences",headers:S.getRequestHeader()}).then(function(e){m.info("[adminCompanyService] getCompanyConferenceSettings success");var t=e.data.data;n(t)},function(e){var t=C.handleError(e);r(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"getCompanyConferenceSettings"))})})},y.setCompanyConferenceSettings=function(t,i){return v(function(n,r){var e={confDialOutDisabled:!i};g({method:"PUT",url:y.portalURL+"companies/"+t+"/settings/conferences",headers:S.getRequestHeader(),data:e}).then(function(e){m.info("[adminCompanyService] setCompanyConferenceSettings success");var t=e.data.data;n(t)},function(e){var t=C.handleError(e);r(t),m.error("[adminCompanyService] "+C.getErrorFullMessage(e,"setCompanyConferenceSettings"))})})}}]),angular.module("rainbow").service("adminUserService",["$q","$log","$http","authService","errorHelperService","Company","User","Site","Organisation","userInfoService","contactService","PhoneNumber",function(d,u,f,h,p,v,m,g,S,n,r,a){"use strict";var C=this;C.start=function(){return u.info("[adminUserService] === STARTING ==="),C.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",u.info("[adminUserService] === STARTED ==="),d.when()},C.stop=function(){return u.info("[adminUserService] === STOPPING ==="),u.info("[adminUserService] === STOPPED ==="),d.when()},C.getUsersByEmail=function(t,i){return d(function(r,n){var e=C.portalURL+"users?format=full";t&&t instanceof S&&(e+="&organisationId="+t.id),t&&t instanceof v&&(e+="&companyId="+t.id),t&&t instanceof g&&(e+="&siteId="+t.id),i&&(e+="&email="+encodeURIComponent(i)),f({method:"GET",url:e,headers:h.getRequestHeader()}).then(function(e){var t=e.data.data;u.info("[adminUserService] getUsersByEmail success (find "+e.data.total+" user(s))");var n=[];t.forEach(function(e){var t=m.createFromData(e);n.push(t)}),r({users:n,total:e.data.total})},function(e){var t=p.handleError(e);n(t),u.error("[adminOfferSubscriptionService] "+p.getErrorFullMessage(e,"getUsersByEmail"))})})},C.getUsers=function(t,i,a,o,s,c,l){return d(function(r,n){var e=C.portalURL+"users?format=full&limit="+a;t&&t instanceof S&&(e+="&organisationId="+t.id),t&&t instanceof v&&(e+="&companyId="+t.id),t&&t instanceof g&&(e+="&siteId="+t.id),i&&(e+="&offset="+a*(i-1)),o&&(e+="&displayName="+encodeURIComponent(o)+"&useEmails=true"),null!=s&&(e+="&isTerminated="+s),c&&(e+="&roles=admin&roles=bp_admin&roles=bp_finance&roles=superadmin"),f({method:"GET",url:e,headers:h.getRequestHeader()}).then(function(e){var t=e.data.data;u.info("[adminUserService] getUsers success (find "+e.data.total+" user(s))");var n=[];t.forEach(function(e){var t=m.createFromData(e,l);n.push(t)}),r({users:n,limit:e.data.limit,offset:e.data.offset,total:e.data.total})},function(e){var t=p.handleError(e);n(t),u.error("[adminOfferSubscriptionService] "+p.getErrorFullMessage(e,"getUsers"))})})},C.searchUsers=function(t,i,a,o){return d(function(r,n){var e=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit="+a;t&&(e+="&companyId="+t.id),i&&(e+="&offset="+a*(i-1)),o&&(e+="&displayName="+encodeURIComponent(o)),f({method:"GET",url:e,headers:h.getRequestHeader()}).then(function(e){var t=e.data.data;u.info("[adminUserService] searchUsers success (find "+e.data.total+" user(s))");var n=[];t.forEach(function(e){var t=m.createFromData(e);n.push(t)}),r({users:n,total:e.data.total})},function(e){var t=p.handleError(e);n(t),u.error("[adminOfferSubscriptionService] "+p.getErrorFullMessage(e,"searchUsers"))})})},C.getUser=function(e){var r=d.defer();return f({method:"GET",url:C.portalURL+"users/"+e,headers:h.getRequestHeader()}).then(function(e){u.info("[adminUserService] getUser success");var t=e.data.data,n=m.createFromData(t);r.resolve(n)},function(e){var t=p.handleError(e);r.reject(t),u.error("[adminUserService] "+p.getErrorFullMessage(e,"getUser"))}),r.promise},C.createUser=function(e){var t=m.prune(e,r.userContact),n=d.defer();return f({method:"POST",url:C.portalURL+"users",headers:h.getRequestHeader(),data:t}).then(function(e){var t=m.createFromData(e.data.data);u.info("[adminUserService] createUser success"),n.resolve(t)},function(e){var t=p.handleError(e);n.reject(t),u.error("[adminUserService] "+p.getErrorFullMessage(e,"createUser"))}),n.promise},C.deleteUser=function(e){var n=d.defer();return f({method:"DELETE",url:C.portalURL+"users/"+e.id,headers:h.getRequestHeader()}).then(function(){u.info("[adminUserService] deleteUser success"),n.resolve()},function(e){var t=p.handleError(e);n.reject(t),u.error("[adminUserService] "+p.getErrorFullMessage(e,"deleteUser"))}),n.promise},C.updateUser=function(e){var t=m.prune(e,r.userContact),n=d.defer();return f({method:"PUT",url:C.portalURL+"users/"+e.id,headers:h.getRequestHeader(),data:t}).then(function(){u.info("[adminUserService] updateUser success"),n.resolve()},function(e){var t=p.handleError(e);n.reject(t),u.error("[adminUserService] "+p.getErrorFullMessage(e,"updateUser"))}),n.promise},C.getUserAvatar=function(t){var e=n.computeUserColor(t.firstName+" "+t.lastName).color;n.getAvatarImage(t.id,t.initials,e,50,t.lastAvatarUpdateDate).then(function(e){t.image=e})},C.expandTelephonyInfo=function(e){var i={};return e.phoneNumbers&&e.phoneNumbers.forEach(function(e){var t=e.number,n=e.numberE164,r=e.deviceType;switch(e.type){case"work":"landline"===r&&(i.phoneProNumber&&i.phoneProNumber.systemId||(i.phonePro=t,i.phoneProCan=n,i.phoneProExt=e.shortNumber,i.phoneProIsMonitored=e.isMonitored,i.phoneProNumber=a.createFromData(e))),"mobile"===r&&(i.mobilePro=t,i.mobileProCan=n);break;case"home":"landline"===r&&(i.phonePerso=t,i.phonePersoCan=n),"mobile"===r&&(i.mobilePerso=t,i.mobilePersoCan=n);break;case"rainbow":i.rainbowPhoneNumber=t}}),i},C.getAllUsers=function(a,o){return d(function(i,t){C.getUsers(a,1,1e3,void 0,void 0,void 0,o).then(function(t){if(t.total>t.limit){for(var e=[],n=Math.ceil(t.total/1e3),r=2;r<=n;r++)e.push(C.getUsers(a,r,1e3,void 0,void 0,void 0,o).then(function(e){t.users=t.users.concat(e.users),t.limit+=e.limit}));d.all(e).then(function(){i(t)})}else i(t)}).catch(function(e){t(e)})})}}]),function(){"use strict";angular.module("rainbow").filter("emojione",["$sce","$sanitize",function(n,r){return function(e){if(!angular.isString(e))return e;var t=emojione.shortnameToImage(e);return r(n.trustAsHtml(t))}}]),angular.module("rainbow").filter("emojiUnicodeToShort",["$sce","$sanitize",function(e,t){return function(e){return angular.isString(e)?emojione.toShort(e):e}}]),angular.module("rainbow").filter("emojiShortToUnicode",["$sce","$sanitize",function(e,t){return function(e){return angular.isString(e)?emojione.shortnameToUnicode(e):e}}])}(),angular.module("rainbow").factory("PromiseQueue",["$log",function(i){"use strict";function e(){var r=this;this.queue=[],this.started=!1,this.add=function(e){this.queue.push(e),this.started||(this.started=!0,this.execute())},this.execute=function(){var e=this.queue.shift();if(e)try{e().catch(function(e){var t=e&&e.message?e.message:"Unknown error";i.error("[PromiseQueue] execute failure -- "+t)}).finally(function(){r.execute()})}catch(e){var t=e&&e.message?e.message:"Unknown error",n=e&&e.stack?e.stack:"Unknown stack";i.error("[PromiseQueue] execution exception  -- "+t+" : "+n),r.execute()}else this.started=!1}}return e.create=function(){return new e},e}]),angular.module("rainbow").factory("TransfertPromiseQueue",["$log","$q",function(a,o){"use strict";function e(){var i=this;i.fileQueue=[],i.clearContext=function(){i.currentQueue=[],i.promiseCompletion=void 0,i.promiseReject=void 0,i.initialQueueSize=0,i.promisesDone=0,i.chunkErrorCounter=0,i.currentPromise=void 0},i.clearContext(),i.addPromiseArray=function(e,t,n){a.debug("[TransfertPromiseQueue] adding promiseArray");var r={};return r.promiseArray=e,r.promiseCompletion=t,r.promiseReject=n,0!==i.fileQueue.length||i.currentPromise?(i.fileQueue.push(r),a.debug("[TransfertPromiseQueue] adding PromiseArray in FileQueue: "+i.fileQueue.length)):(a.debug("[TransfertPromiseQueue] configuring file to transfert: "+r.promiseArray.length),i.fileQueue.push(r),i.popFileQueue()),a.debug("[TransfertPromiseQueue] adding promise on FileQueue: "+i.fileQueue.length),o},i.popFileQueue=function(){if(0<i.fileQueue.length){a.debug("[TransfertPromiseQueue] go to next file");var e=i.fileQueue.shift();i.currentQueue=e.promiseArray,i.promiseCompletion=e.promiseCompletion,i.promiseReject=e.promiseReject,i.initialQueueSize=i.currentQueue.length,i.promisesDone=0,i.chunkErrorCounter=0,i.currentPromise=i.currentQueue.shift(),i.execute()}else a.debug("[TransfertPromiseQueue] no more file to transfert"),i.clearContext()},i.execute=function(){a.debug("[TransfertPromiseQueue] execute"),i.currentPromise?(a.debug("[TransfertPromiseQueue] performing promise: "+i.promisesDone),i.currentPromise().then(function(){a.debug("[TransfertPromiseQueue] promise success go to next one"),i.promisesDone++,i.chunkErrorCounter=0,i.promisesDone>=i.initialQueueSize?(i.promiseCompletion(),i.popFileQueue()):(i.currentPromise=i.currentQueue.shift(),i.execute())}).catch(function(e){var t=e&&e.message?e.message:"Unknown error";a.error("[TransfertPromiseQueue] failure executing promise -- "+t),i.chunkErrorCounter++,500<=e.errorDetailsCode&&i.chunkErrorCounter<=3?i.execute():(a.error("[TransfertPromiseQueue] 3 chunk failed - ABORT File Upload"),i.promiseReject(e),i.popFileQueue())})):(a.debug("[TransfertPromiseQueue] no promise to perform"),i.currentPromise=void 0)},i.isTransferInProgress=function(){return a.debug("[TransfertPromiseQueue] >isTransferInProgress: "+i.fileQueue.length+"/"+i.currentQueue.length),0<i.fileQueue.length||0<i.currentQueue.length||i.currentPromise},i.cancelAllTransfers=function(){a.debug("[TransfertPromiseQueue] cancelAllTransfers"),i.fileQueue=[],i.currentQueue=[]}}return e.create=function(){return a.debug("[TransfertPromiseQueue] >create"),new e},e}]),window.sdk=angular.module("sdk",["pascalprecht.translate","ngSanitize","angularRandomString","ngFileSaver","angular-jwt","uuid4","rainbow","rainbowAdmin"],function(){});var code={OK:1,ERROR:-1,ERRORUNAUTHORIZED:-2,ERRORXMPP:-4,ERRORXMPPJID:-8,ERRORBADREQUEST:-16,ERRORUNSUPPORTED:-32,ERRORNOTFOUND:-64};sdk.constant("SDK",code),sdk.remoteConsole={debug:!1,log:!1,info:!1,warn:!1,error:!1},sdk.hasVerboseLog=!1,sdk.useAngularEvents=!1,sdk.hasBeenLaunchedFromConfig=!1,sdk.key={appID:"",appSecret:"",host:"openrainbow.com"},sdk.config(["consoleLogsProvider","$provide","$httpProvider","$translateProvider",function(o,e,t,n){"use strict";var s=function(e){return e.toDateString()+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)};e.decorator("$log",["$delegate",function(e){var n=e.debug;e.debug=function(){var e=[].slice.call(arguments);sdk.remoteConsole.debug&&console.re.debug(e[0]),sdk.hasVerboseLog&&n.apply(null,e),o.setLogs(["["+s(new Date)+"]"]+"debug : "+e+"\n")};var t=e.log;e.log=function(){var e=[].slice.call(arguments);sdk.remoteConsole.log&&console.re.log(e[0]),sdk.hasVerboseLog&&t.apply(null,e),o.setLogs(["["+s(new Date)+"]"]+"log : "+e+"\n")};var r=e.info;e.info=function(){var e=[].slice.call(arguments);sdk.remoteConsole.info&&console.re.info(e[0]),sdk.hasVerboseLog&&r.apply(null,e),o.setLogs(["["+s(new Date)+"]"]+"info : "+e+"\n")};var i=e.warn;e.warn=function(){var e=[].slice.call(arguments);sdk.remoteConsole.warn&&console.re.warn(e[0]),i.apply(null,e),o.setLogs(["["+s(new Date)+"]"]+"warn : "+e+"\n")};var a=e.error;return e.error=function(){var e=[].slice.call(arguments);sdk.remoteConsole.error&&console.re.error(e[0]),a.apply(null,e),o.setLogs(["["+s(new Date)+"]"]+"error : "+e+"\n")},e.webrtc=function(){var e=[].slice.call(arguments),t="rtcweb : "+e[0];e[0]="%c "+s(new Date)+" | RTCWEB | "+e[0],e[e.length]="color:green",sdk.remoteConsole.log&&console.re.log(e[0]),n.apply(null,e),o.setLogs(["["+s(new Date)+"]"]+t+"\n")},e.sdk=function(){var e=[].slice.call(arguments),t="RBW-SDK : "+e[0];e[0]="%c "+s(new Date)+" | RBW-SDK | "+e[0],e[e.length]="color:green",sdk.remoteConsole.log&&console.re.log(e[0]),n.apply(null,e),o.setLogs(["["+s(new Date)+"]"]+t+"\n")},e}]),t.defaults.useXDomain=!0,n.useSanitizeValueStrategy(null)}]),sdk.run([function(){}]),sdk.provider("consoleLogs",[function(){"use strict";this.logsBuffer=[],this.logsMaxLength=2e6,this.$get=function(){var e=this.logsBuffer;return{getLogs:function(){return e}}},this.cleanBuffer=function(){this.logsBuffer.length>this.logsMaxLength&&(this.logsBuffer=this.logsBuffer.slice(-this.logsMaxLength))},this.setLogs=function(e){1e3===this.logsBuffer&&this.logsBuffer.shift(),this.logsBuffer.push(e)}}]),window.config={xmpp:{protocol:"wss",server:"sandbox.openrainbow.com",port:"443",pingInterval:"60000"},webservices:{protocol:"https",server:"sandbox.openrainbow.com",port:"443"},cpaas:{protocol:"https",server:"",port:"8887"}},angular.module("sdk").service("connectionService",["$q","$log","$rootScope","authService","xmppService","companyService","contactService","botService","fileTransfertService","fileServerService","fileStorageService","roomService","groupService","videoService","webrtcServiceEventHandler","telephonyService","conferenceService","pstnConferenceService","webConferenceService","conversationService","callLogService","platformService","invitationService","adminCompanyService","adminUserService","profileService","channelService","cpaasService","webrtcGatewayService","recordsService","SDK",function(o,s,c,l,d,u,f,h,p,v,m,g,S,C,E,b,R,y,T,I,N,A,O,D,P,w,M,e,_,U,F){"use strict";var L=this,k="ConnectSrv | ",n="disconnected";this.RAINBOW_ONCONNECTIONSTATECHANGED="rainbowconnectionstatechanged",this.RAINBOW_ONSTARTED="started",this.RAINBOW_ONSIGNED="signed",this.RAINBOW_ONSTOPPED="stopped",this.RAINBOW_CONNECTIONINPROGRESS="inProgress",this.RAINBOW_ONUSERTOKENRENEW="userTokenRenew",this.RAINBOW_ONUSERTOKENRENEWFAILED="userTokenRenewFailed",this.RAINBOW_ONAPPTOKENRENEW="applicationTokenRenew",this.RAINBOW_ONAPPTOKENRENEWFAILED="applicationTokenRenewFailed",this.RAINBOW_CONNECTIONCONNECTED="connected",this.RAINBOW_CONNECTIONDISCONNECTED="disconnected",this.RAINBOW_OFFICIAL_HOST="openrainbow.com",this.RAINBOW_BETA_HOST="openrainbow.net",this.RAINBOW_DEV_HOST="openrainbow.org",this.RAINBOW_SANDBOX_HOST="sandbox.openrainbow.com";var B=this.RAINBOW_SANDBOX_HOST;this.RAINBOW_CPAASPREPROD_HOST="cpaaspreprod.openrainbow.net";B=this.RAINBOW_CPAASPREPROD_HOST;this.signin=function(e,t){return B=this.RAINBOW_SANDBOX_HOST,r(e,t,null)},this.signinOnRainbowOfficial=function(e,t){return B=this.RAINBOW_OFFICIAL_HOST,r(e,t,null)},this.signinOnRainbowBeta=function(e,t){return B=this.RAINBOW_BETA_HOST,r(e,t,null)},this.signinOnRainbowCPaasPreProd=function(e,t){return B=this.RAINBOW_CPAASPREPROD_HOST,r(e,t,null)},this.signinOnRainbowDev=function(e,t){return B=this.RAINBOW_DEV_HOST,r(e,t,null)},this.signinOnRainbowHosted=function(e,t,n){return B=n,r(e,t,null)},this.signinSandBoxWithToken=function(e){return B=this.RAINBOW_SANDBOX_HOST,r(null,null,e)},this.signinOnRainbowOfficialWithToken=function(e){return B=this.RAINBOW_OFFICIAL_HOST,r(null,null,e)},this.signinOnRainbowBetaWithToken=function(e){return B=this.RAINBOW_BETA_HOST,r(null,null,e)},this.signinOnRainbowDevWithToken=function(e){return B=this.RAINBOW_DEV_HOST,r(null,null,e)},this.signinOnRainbowHostedWithToken=function(e,t){return B=t,r(null,null,e)},this.signout=function(){var t=o.defer(),e={code:F.OK,label:"OK"};return s.sdk(k+"[signout    ] :: Try to sign-out..."),C.stop().then(function(){return s.sdk(k+"[signout    ] :: Video service stopped"),E.stop()}).then(function(){return s.sdk(k+"[signout    ] :: WebRTCEventHandler service stopped"),f.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Contact service stopped"),h.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Bot service stopped"),w.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Profile service stopped"),I.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Conversation service stopped"),R.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Conference service stopped"),T.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Web Conference service stopped"),y.stop()}).then(function(){return s.sdk(k+"[signout    ] :: PTSN Conference service stopped"),N.stop()}).then(function(){return s.sdk(k+"[signout    ] :: ChannelService service stopped"),M.stop()}).then(function(){return s.sdk(k+"[signout    ] :: CallLog service stopped"),b.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Telephony service stopped"),p.stop()}).then(function(){return s.sdk(k+"[signout    ] :: FileTransfert service stopped"),v.stop()}).then(function(){return s.sdk(k+"[signout    ] :: FileServer service stopped"),m.stop()}).then(function(){return s.sdk(k+"[signout    ] :: FileStorage service stopped"),O.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Group service stopped"),S.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Room service stopped"),g.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Company service stopped"),u.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Admin Company service stopped"),D.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Admin User service stopped"),P.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Invitation service stopped"),_.stop()}).then(function(){return s.sdk(k+"[signout    ] :: webrtcGateway service stopped"),d.stop()}).then(function(){return s.sdk(k+"[signout    ] :: Records service stopped"),U.stop()}).then(function(){s.sdk(k+"[signout    ] :: XMPP service stopped"),s.sdk(k+"[signout    ] :: Services Successfully unloaded!"),sdk.useAngularEvents?c.$broadcast(L.RAINBOW_ONSTOPPED):$(document).trigger(L.RAINBOW_ONSTOPPED,null),t.resolve(e)}).catch(function(e){return s.sdk(k+"[signout    ] :: Error during signout..."),t.reject(e),t.promise}),t.promise},this.updateUserPassword=function(e,t){return f.updateUserPassword(e,t,!1)},this.getState=function(){return n},this.getToken=function(){return l.token},this.getToken=function(){return l.token};var r=function(n,e,t){var r=o.defer(),i=!1;if(t)i=!0,e=n=null;else{if(!n)return r.reject({code:F.ERRORBADREQUEST,label:"Parameter 'login' is missing or empty"});if(!e)return r.reject({code:F.ERRORBADREQUEST,label:"Parameter 'password' is missing or empty"})}s.sdk(k+"[signin     ] :: Rainbow host used "+B),i?s.sdk(k+"[signin     ] :: Try to sign-in with given token"):s.sdk(k+"[signin     ] :: Try to sign-in with "+n+"...");var a={code:F.OK,label:"",account:null};return l.removeCredentials(),l.authenticateOnHost(n,e,B,{appID:sdk.key.appID,appSecret:sdk.key.appSecret},t).then(function(e){a.account={},a.label="ok",a.account.userId=l.userId,a.account.companyId=l.companyId,a.account.loginEmail=l.login,a.account.roles=l.userData.roles,a.token=l.token,a.userData=l.userData;var t=[];s.sdk(k+"[signin     ] :: Successfully sign-in with "+n+" | "+l.jidIm),sdk.useAngularEvents?c.$broadcast(L.RAINBOW_ONSIGNED,a):$(document).trigger(L.RAINBOW_ONSIGNED,[a]),l.startTokenSurvey(),s.sdk(k+"[signin     ] :: Start services..."),d.disconnectionHandler=H,d.start(t).then(function(){return s.sdk(k+"[signin     ] :: XMPP service ready!"),u.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Company service ready!"),D.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Admin company service ready!"),P.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Admin user service ready!"),f.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Contact service ready!"),w.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Profile service ready!"),O.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Invitation service ready!"),p.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: FileTransfert service ready!"),v.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: FileServer service ready!"),m.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: FileStorage service ready!"),g.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Room service ready!"),S.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Group service ready!"),_.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: WebrtcGateway service ready!"),C.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Video service ready!"),E.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: WebRTCEventHandler service ready!"),b.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Telephony service ready!"),y.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: PSTN Conference service ready!"),T.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Web Conference service ready!"),I.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Conversation service ready!"),s.sdk(k+"[signin     ] :: Send initial presence"),f.sendPresenceFromConfiguration(),o.when()}).then(function(){return s.sdk(k+"[signin     ] :: Initial presence sent !"),N.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: CallLog service ready!"),A.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Platform service ready!"),h.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Bot service ready!"),R.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Conference service ready!"),U.start(t)}).then(function(){return s.sdk(k+"[signin     ] :: Records service ready!"),M.start(t)}).then(function(){s.sdk(k+"[signin     ] :: Channel service ready!"),s.sdk(k+"[signin     ] :: Services Successfully loaded!"),c.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","connected"),sdk.useAngularEvents?c.$broadcast(L.RAINBOW_ONSTARTED):$(document).trigger(L.RAINBOW_ONSTARTED,a),r.resolve(a)}).catch(function(e){s.sdk(k+"[signin     ] :: Error during signin"),a.code=F.ERRORXMPP,a.label="errorXMPP",a.account=null,r.reject(a)})}).catch(function(e){s.sdk(k+"[signin     ] :: Error during signin"),a.code=F.ERRORUNAUTHORIZED,a.label="errorUnauthorized",r.reject(a)}),r.promise},H=function(){s.sdk(k+"[discHandler] :: Disconnected from the XMPP Rainbow Cloud Services")},t=function(e,t){s.sdk(k+"[onChange   ] :: Connection state changed to "+t),n=t,sdk.useAngularEvents?c.$broadcast(L.RAINBOW_ONCONNECTIONSTATECHANGED,t):$(document).trigger(L.RAINBOW_ONCONNECTIONSTATECHANGED,[t])};c.$on("$destroy",c.$on("ON_CONNECTION_STATE_CHANGE_EVENT",t)),c.$on("$destroy",c.$on("ON_AUTH_TOKEN_RENEW",function(e){sdk.useAngularEvents?c.$broadcast(L.RAINBOW_ONUSERTOKENRENEW):$(document).trigger(L.RAINBOW_ONUSERTOKENRENEW)})),c.$on("$destroy",c.$on("ON_AUTH_TOKEN_EXPIRE",function(e){sdk.useAngularEvents?c.$broadcast(L.RAINBOW_ONUSERTOKENRENEWFAILED):$(document).trigger(L.RAINBOW_ONUSERTOKENRENEWFAILED,null),signout()})),c.$on("$destroy",c.$on("ON_AUTH_TOKEN_RENEW",function(e){sdk.useAngularEvents?c.$broadcast(L.RAINBOW_ONAPPTOKENRENEW):$(document).trigger(L.RAINBOW_ONAPPTOKENRENEW,null)})),c.$on("$destroy",c.$on("ON_AUTH_TOKEN_EXPIRE",function(e){sdk.useAngularEvents?c.$broadcast(L.RAINBOW_ONAPPTOKENRENEWFAILED):$(document).trigger(L.RAINBOW_ONAPPTOKENRENEWFAILED,null),signout()}))}]),angular.module("sdk").service("presenceService",["$log","$rootScope","xmppService","contactService","SDK",function(i,a,o,t,n){"use strict";var s=this,c="PresenceSvr| ";this.RAINBOW_PRESENCE_ONLINE="online",this.RAINBOW_PRESENCE_AWAY="away",this.RAINBOW_PRESENCE_DONOTDISTURB="dnd",this.RAINBOW_PRESENCE_OFFLINE="xa",this.RAINBOW_PRESENCE_BUSY="busy",this.RAINBOW_PRESENCE_UNKNOW="unknow",this.RAINBOW_ONCONTACTPRESENCECHANGED="rainbowcontactpresencechanged",this.RAINBOW_ONPRESENCECHANGED="rainbowpresencechanged",this.RAINBOW_ONCONTACTRICHPRESENCECHANGED="rainbowcontactrichpresencechanged",this.RAINBOW_ONRICHPRESENCECHANGED="rainbowrichpresencechanged",this.setPresenceTo=function(e){return e!==this.RAINBOW_PRESENCE_DONOTDISTURB&&e!==this.RAINBOW_PRESENCE_AWAY&&e!==this.RAINBOW_PRESENCE_OFFLINE&&e!==this.RAINBOW_PRESENCE_ONLINE?{code:n.ERRORBADREQUEST,label:"Parameter 'strPresenceState' should be 'dnd', 'away', 'xa' (invisible) or 'online'"}:(i.sdk(c+"[setPresTo  ] :: Set presence to "+e),t.changeMyPresence(e),{code:n.OK,label:"OK"})};a.$on("$destroy",a.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",function(e,t){var n=t.message||"''";t.jid===o.fullJid?(i.sdk(c+"[onChange   ] :: Presence changed for me ("+t.jid+") to  "+t.status+" | "+n),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONPRESENCECHANGED,t):$(document).trigger(s.RAINBOW_ONPRESENCECHANGED,[t])):(i.sdk(c+"[onChange   ] :: Presence changed for contact ("+t.jid+") to  "+t.status+" | "+n),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCONTACTPRESENCECHANGED,t):$(document).trigger(s.RAINBOW_ONCONTACTPRESENCECHANGED,[t]))})),a.$on("$destroy",a.$on("ON_UPDATE_CONTACT_RICH_STATUS_EVENT",function(e,t){var n=t.message||"''",r=t.telStatus||"''";o.fullJid.includes(t.jid)?(i.sdk(c+"[onChange   ] :: Rich Presence changed for myself to status "+t.status+", message "+n+" and telStatus "+r),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONRICHPRESENCECHANGED,t):$(document).trigger(s.RAINBOW_ONRICHPRESENCECHANGED,[t])):(i.sdk(c+"[onChange   ] :: Rich Presence changed for contact ("+t.jid+") to status "+t.status+", message "+n+" and telStatus "+r),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCONTACTRICHPRESENCECHANGED,t):$(document).trigger(s.RAINBOW_ONCONTACTRICHPRESENCECHANGED,[t]))}))}]),angular.module("sdk").service("userProfileService",["$q","$log","$rootScope","contactService","xmppService","profileService","adminUserService","SDK",function(s,c,e,n,t,l,r,d){"use strict";var u="UserProfile| ";this.getProfile=function(){var n=s.defer();return l.getUserData().then(function(e){c.sdk(u+"[getProfile] :: got");var t={name:e.lastName,firstName:e.firstName,phoneNumbers:e.phoneNumbers};n.resolve(t)}).catch(function(e){c.sdk(u+"[getProfile] :: Error when trying to get Profile - "+e),n.reject(e)}),n.promise},this.updateFirstName=function(e){var n=s.defer();if(!e||"string"!=typeof e||e.length<1)n.reject({code:d.ERRORBADREQUEST,label:"Parameter 'strFirstname' is missing, empty or null"});else{var t={firstName:e};l.setUserData(t).then(function(e){c.sdk(u+"[updateFirstName] :: First name updated");var t={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};n.resolve(t)}).catch(function(e){c.sdk(u+"[updateFirstName] :: Error when updating first name - "+e),n.reject(e)})}return n.promise},this.updateLastName=function(e){var n=s.defer();if(!e||"string"!=typeof e||e.length<1)n.reject({code:d.ERRORBADREQUEST,label:"Parameter 'strName' is missing, empty or null"});else{var t={lastName:e};l.setUserData(t).then(function(e){c.sdk(u+"[updateName] :: Name updated");var t={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};n.resolve(t)}).catch(function(e){c.sdk(u+"[updateName] :: Error when updating name - "+e),n.reject(e)})}return n.promise},this.updatePhoneNumber=function(n,r,i,e){var a=s.defer();if((!n||"string"!=typeof n||["home","work","other"].indexOf(n)<0)&&a.reject({code:d.ERRORBADREQUEST,label:"Parameter 'type' is missing or not in 'home', 'work', 'other'"}),!r||"string"!=typeof r||["landline","mobile","fax","other"].indexOf(r)<0)a.reject({code:d.ERRORBADREQUEST,label:"Parameter 'deviceType' is missing or not in 'landline', 'mobile', 'fax', 'other'"});else if(i&&"string"==typeof i){var o={phoneNumbers:[{type:n,deviceType:r,number:i}]};e&&"string"==typeof e&&(o.country=e),l.getUserData().then(function(e){if(e.phoneNumbers.length){if(!e.phoneNumbers.some(function(e){return e.type===n&&e.deviceType===r&&(e.number=i,!0)})){var t={type:n,deviceType:r,number:i};e.phoneNumbers.push(t)}return l.setUserData(e)}return l.setUserData(o)}).then(function(e){c.sdk(u+"[updatePhoneNumber] :: Phone number updated");var t={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};a.resolve(t)}).catch(function(e){c.sdk(u+"[updatePhoneNumber] :: Error when updating phone number - "+e),a.reject(e)})}else a.reject({code:d.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing, empty or null"});return a.promise},this.updatePhotoFromUrl=function(e){var t=s.defer();return!e||"string"!=typeof e||e.length<1?t.reject({code:d.ERRORBADREQUEST,label:"Parameter 'imgUrl' is missing, empty or null"}):n.pushAvatarImage(e).then(function(){c.sdk(u+"[updatePhotoFromUrl] :: Photo updated"),t.resolve()}).catch(function(e){c.sdk(u+"[updatePhotoFromUrl] :: Error when updating Photo - "+e),t.reject(e)}),t.promise}}]),angular.module("sdk").service("contactsService",["$log","$q","$rootScope","contactService","directoryService","invitationService","SDK",function(n,r,i,a,o,s,c){"use strict";var l=this,d="ContactsSrv| ";this.RAINBOW_ONCONTACTINFORMATIONCHANGED="rainbowcontactinformationchanged",this.RAINBOW_ONINFORMATIONCHANGED="rainbowinformationchanged",this.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED="rainbowsubscriptionnumberchanged",this.RAINBOW_ONCONTACTINVITATIONRECEIVED="rainbowinvitationreceived",this.getContactByJID=function(e){return e?a.getContactByJid(e):{code:c.ERRORBADREQUEST,label:"Parameter 'strJID' is missing or empty"}},this.getContactById=function(e){return e?a.getContactById(e):{code:c.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"}},this.getAll=function(){return a.getContacts().filter(function(e){return e.id!==a.userContact.id&&!e.isBot})},this.getConnectedUser=function(){return a.userContact||null},this.getConnectedUserPhone=function(){return a.userContact?0===a.userContact.pbxId.length?null:{phoneNumber:a.userContact.phonePbx,pbxId:a.userContact.pbxId}:null},this.searchByName=function(e,t){var n=r.defer();return e?(t||(t=20),o.search(e,!0,t).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)})):n.reject({code:c.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),n.promise},this.searchByLogin=function(e){var t=r.defer();return e?o.searchUserByLogin(e).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject({code:c.ERRORBADREQUEST,label:"Parameter 'strLogin' is missing or empty"}),t.promise},this.searchByJid=function(e){var t=r.defer();return e?o.searchUserByJid(e).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject({code:c.ERRORBADREQUEST,label:"Parameter 'strJid' is missing or empty"}),t.promise},this.searchById=function(e){var t=r.defer();return e?a.getContactByDBId(e,!0).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject({code:c.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"}),t.promise},this.acceptInvitation=function(e){var t=r.defer();return e?s.acceptInvitation(e).then(function(){t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject({code:c.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"}),t.promise},this.declineInvitation=function(e){var t=r.defer();return e?(s.declineInvitation(e).then(function(){t.resolve(e)}).catch(function(e){t.reject(e)}),t.promise):{code:c.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"}},this.addToContactsList=function(e){var t=r.defer();return e?(s.joinContactInvitation(e).then(function(){t.resolve(e)}).catch(function(e){t.reject(e)}),t.promise):{code:c.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.sendInvitationByEmail=function(e,t){var n=r.defer();return e?(s.sendInvitationByEmail(e,t).then(function(){n.resolve(contact)}).catch(function(e){n.reject(e)}),n.promise):{code:c.ERRORBADREQUEST,label:"Parameter 'email' is missing or null"}},this.removeFromContactsList=function(e){return e?a.removeContact(e):{code:c.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.getInvitationById=function(e){return e?s.getInvitation(e):{code:c.ERRORBADREQUEST,label:"Parameter 'strInvitationId' is missing or null"}},this.getInvitationsReceived=function(){return s.getReceivedInvitations()},this.getInvitationsSent=function(){return s.getSentInvitations()};i.$on("$destroy",i.$on("ON_CONTACT_UPDATED_EVENT",function(e,t){n.sdk(d+"[onChange   ] :: Information changed for contact "+t.displayNameForLog()),sdk.useAngularEvents?i.$broadcast(l.RAINBOW_ONCONTACTINFORMATIONCHANGED,t):$(document).trigger(l.RAINBOW_ONCONTACTINFORMATIONCHANGED,[t])})),i.$on("$destroy",i.$on("ON_USER_CONTACT_UPDATED_EVENT",function(e,t){n.sdk(d+"[onChange   ] :: Information changed for me ("+t.displayNameForLog()+")"),sdk.useAngularEvents?i.$broadcast(l.RAINBOW_ONINFORMATIONCHANGED,t):$(document).trigger(l.RAINBOW_ONINFORMATIONCHANGED,[t])})),i.$on("$destroy",i.$on("ON_INVITATIONS_NUMBER_UPDATED",function(e){n.sdk(d+"[onChange   ] :: Invitation number changed"),sdk.useAngularEvents?i.$broadcast(l.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED):$(document).trigger(l.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED,[])})),i.$on("$destroy",i.$on("ON_INVITATION_CHANGED",function(e,t){n.sdk(d+"[onChange   ] :: Invitation received"),sdk.useAngularEvents?i.$broadcast(l.RAINBOW_ONCONTACTINVITATIONRECEIVED,t):$(document).trigger(l.RAINBOW_ONCONTACTINVITATIONRECEIVED,[t])}))}]),angular.module("sdk").service("pbxService",["$q","$log","$rootScope","telephonyService","Call","SDK",function(r,n,i,a,o,s){"use strict";var c=this,l="TelphonySrv| ";this.RAINBOW_ONTELEPHONYCALLSTATECHANGED="rainbowontelephonycallstatechanged",this.RAINBOW_ONTELEPHONYSTARTED="rainbowontelephonystarted",this.RAINBOW_ONTELEPHONYSTOPPED="rainbowontelephonystopped",this.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED="rainbowontelephonyforwardstatechanged",this.RAINBOW_TELEPHONYDIALING="dialing",this.RAINBOW_TELEPHONYRINGINGOUTGOING="ringingOutgoing",this.RAINBOW_TELEPHONYINCOMING="incomingCall",this.RAINBOW_TELEPHONYACTIVE="active",this.RAINBOW_TELEPHONYRELEASING="releasing",this.RAINBOW_TELEPHONYUNKNOW="Unknown",this.isTelephonyAvailable=function(){return a.started},this.getAgentVersion=function(){return a.agentStatus.agentVersion||"unknown"},this.getXMPPAgentStatus=function(){return a.agentStatus.xmppAgent||"unknown"},this.getPhoneAPIStatus=function(){return a.agentStatus.phoneApi||"unknown"},this.callByNumber=function(e){var t=r.defer();return e?a.makeCallByPhoneNumber(e).then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"}),t.promise},this.calls=function(){return a.calls},this.release=function(e){var t=r.defer();return e?a.releaseCall(e).then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),t.promise},this.deflectToVM=function(e){var t=r.defer();return e?a.deflectCallToVM(e).then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),t.promise},this.forwardToDevice=function(e){var t=r.defer();return e&&"string"==typeof e&&0!==e.length?a.forwardToDevice(e).then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"}),t.promise},this.forwardToVoicemail=function(){var t=r.defer();return a.forwardToVoicemail().then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}),t.promise},this.cancelForward=function(){var t=r.defer();return a.cancelForward().then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}),t.promise},this.getForwardStatusFromServer=function(){var t=r.defer();return a.getForwardStatus().then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}),t.promise},this.getForwardStatus=function(){return a.getForwardObject()},this.answer=function(e){var t=r.defer();return e?a.answerCall(e).then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),t.promise},this.hold=function(e){var t=r.defer();return e?a.holdCall(e).then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),t.promise},this.retrieve=function(e){var t=r.defer();return e?a.retrieveCall(e).then(function(){t.resolve({code:s.OK,label:"OK"})}).catch(function(e){t.reject({code:s.ERROR,label:e})}):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),t.promise},this.transfertCall=function(e,t){var n=r.defer();return e?t?a.transfertCall(e,t).then(function(){n.resolve({code:s.OK,label:"OK"})}).catch(function(e){n.reject({code:s.ERROR,label:e})}):n.reject({code:s.ERRORBADREQUEST,label:"Parameter 'heldCall' is missing or null"}):n.reject({code:s.ERRORBADREQUEST,label:"Parameter 'activeCall' is missing or null"}),n.promise},this.conferenceCall=function(e,t){var n=r.defer();return e?t?a.conferenceCall(e,t).then(function(){n.resolve({code:s.OK,label:"OK"})}).catch(function(e){n.reject({code:s.ERROR,label:e})}):n.reject({code:s.ERRORBADREQUEST,label:"Parameter 'heldCall' is missing or null"}):n.reject({code:s.ERRORBADREQUEST,label:"Parameter 'activeCall' is missing or null"}),n.promise};i.$on("$destroy",i.$on("ON_CALL_FORWARDED_EVENT",function(e,t){n.sdk(l+"[onForwardChange] :: Forward state changed to "+t),sdk.useAngularEvents?i.$broadcast(c.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED,t):$(document).trigger(c.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED,[t])})),i.$on("$destroy",i.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",function(e,t){n.sdk(l+"[onChange   ] :: PBX state changed to "+t),"started"===t?sdk.useAngularEvents?i.$broadcast(c.RAINBOW_ONTELEPHONYSTARTED):$(document).trigger(c.RAINBOW_ONTELEPHONYSTARTED,null):sdk.useAngularEvents?i.$broadcast(c.RAINBOW_ONTELEPHONYSTOPPED):$(document).trigger(c.RAINBOW_ONTELEPHONYSTOPPED,null)})),i.$on("$destroy",i.$on("ON_CALL_UPDATED_EVENT",function(e,t){t.type.value===o.Type.PHONE.value&&(n.sdk(l+"[onTelChange] :: Telephony state changed to "+t),sdk.useAngularEvents?i.$broadcast(c.RAINBOW_ONTELEPHONYCALLSTATECHANGED,t):$(document).trigger(c.RAINBOW_ONTELEPHONYCALLSTATECHANGED,[t]))}))}]),angular.module("sdk").service("conversationsService",["$q","$log","$rootScope","Conversation","conversationService","SDK",function(n,r,i,a,o,s){"use strict";var c=this,l="ConversSrv | ";this.RAINBOW_ONCONVERSATIONREMOVED="rainbowconversationremoved",this.RAINBOW_ONCONVERSATIONCHANGED="rainbowconversationchanged",this.RAINBOW_ONCONVERSATIONSCHANGED="rainbowconversationschanged",this.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED="rainbowconversationsmissedcounterchanged";this.getAllConversations=function(){var e=o.getConversations(),t=[];return e.forEach(function(e){t.push(e)}),t},this.getCallById=function(t){if(!t)return{code:s.ERRORBADREQUEST,label:"Parameter 'strCallId' is missing or empty"};var e=o.getConversations(),n=null;return e.forEach(function(e){e.videoCall&&e.videoCall.id===t?n=e.videoCall:e.audioCall&&e.audioCall.id===t&&(n=e.audioCall)}),n},this.getConversationById=function(e){return e?o.getConversationById(e):{code:s.ERRORBADREQUEST,label:"Parameter 'callId' is missing or empty"}},this.getConversationByBubbleId=function(e){return e?o.getConversationByRoomDbId(e):{code:s.ERRORBADREQUEST,label:"Parameter 'strBubbleId' is missing or empty"}},this.openConversationForContact=function(e){var t=n.defer();return e?(r.sdk(l+"[createConve] :: Try to create of get a conversation with "+e.lastname+" "+e.firstname),o.getOrCreateOneToOneConversation(e.jid).then(function(e){r.sdk(l+"[createConve] :: Conversation retrieved or created "+e.id),t.resolve(e)}).catch(function(e){r.sdk(l+"[createConve] :: Error"),t.reject(e)})):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),t.promise},this.openConversationForBubble=function(e){var t=n.defer();return e?(r.sdk(l+"[createConve] :: Try to create or get a conversation for a bubble "+e.name+"("+e.id+")"),o.getRoomConversation(e.jid).then(function(e){r.sdk(l+"[createConve] :: Conversation retrieved or created "+e.id),t.resolve(e)}).catch(function(e){r.sdk(l+"[createConve] :: Error"),t.reject(e)})):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),t.promise},this.closeConversation=function(e){var t=n.defer();return e?o.closeConversation(e).then(function(){t.resolve(null)}).catch(function(e){t.reject(e)}):t.reject({code:s.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),t.promise},i.$on("$destroy",i.$on("ON_CONVERSATIONS_UPDATED_EVENT",function(e,t,n){void 0!==t&&void 0!==n&&n===a.EventType.NEW&&(sdk.useAngularEvents?i.$broadcast(c.RAINBOW_ONCONVERSATIONSCHANGED,t):$(document).trigger(c.RAINBOW_ONCONVERSATIONSCHANGED,[t]))})),i.$on("$destroy",i.$on("ON_CONVERSATION_REMOVE_EVENT",function(e,t){sdk.useAngularEvents?i.$broadcast(c.RAINBOW_ONCONVERSATIONREMOVED,t):$(document).trigger(c.RAINBOW_ONCONVERSATIONREMOVED,[t])})),i.$on("$destroy",i.$on("ON_CONVERSATION_UPDATED_EVENT",function(e,t){sdk.useAngularEvents?i.$broadcast(c.RAINBOW_ONCONVERSATIONCHANGED,t):$(document).trigger(c.RAINBOW_ONCONVERSATIONCHANGED,[t])})),i.$on("$destroy",i.$on("ON_MISSED_COUNTER_CHANGED_EVENT",function(e,t){sdk.useAngularEvents?i.$broadcast(c.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,t):$(document).trigger(c.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,[t])}))}]),angular.module("sdk").service("imService",["$q","$rootScope","$log","fileStorageService","conversationService","Conversation","Message","SDK",function(i,a,n,o,s,c,r,l){"use strict";var d=this;this.RAINBOW_ONNEWIMMESSAGERECEIVED="rainbownewimmessagereceived",this.RAINBOW_ONNEWIMRECEIPTRECEIVED="rainbownewimreceiptreceived",this.RAINBOW_ONNEWPARTICIPANTSTATUS="rainbownewparticipantstatus",this.getMessagesFromConversation=function(e,t){var n=i.defer();return e?(t=t?Math.min(t,100):30,s.getHistoryPage(e,t)):(n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),n.promise)},this.getMessageFromConversationById=function(e,t){if(!e)return{code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"};if(!t)return{code:l.ERRORBADREQUEST,label:"Parameter 'strMessageId' is missing or empty"};var n=e.getMessageById(t);return n&&n.fileId&&(n.shortFileDescriptor=o.getFileDescriptorById(n.fileId)),n},this.getMessageFromBubbleById=function(e,t){if(!e)return{code:l.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"};if(!t)return{code:l.ERRORBADREQUEST,label:"Parameter 'strMessageId' is missing or empty"};var n=s.getConversationByRoomDbId(e.dbId);if(!n)return{code:l.ERRORBADREQUEST,label:"Parameter 'bubble' don't have a conversation"};if(n.type!==c.Type.ROOM)return{code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is not a bubble conversation"};var r=n.getMessageById(t);return r&&r.fileId&&(r.shortFileDescriptor=o.getFileDescriptorById(r.fileId)),r},this.sendMessageToConversation=function(e,t){return n.sdk("IMSrv      | [sendMessage] :: Try to send a message..."),e?t?1024<t.length?{code:l.ERRORBADREQUEST,label:"Parameter 'strMessage' should be lower than 1024 characters"}:s.sendChatMessage(e,t):{code:l.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}:{code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.sendIsTypingStateInConversation=function(e,t){var n=i.defer();return e?"boolean"!=typeof t?n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'status' is missing or null"}):(e=e.id?s.getConversationById(e.id):null)?(s.sendIsTypingState(e,t),n.resolve()):n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'conversation': this conversation doesn't exist"}):n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),n.promise},this.sendMessageToBubble=function(e,n){var r=i.defer();return e?n?1024<n.length?r.reject({code:l.ERRORBADREQUEST,label:"Parameter 'strMessage' should be lower than 1024 characters"}):s.getRoomConversation(e.jid).then(function(e){if(e){var t=s.sendChatMessage(e,n);r.resolve(t)}else r.reject({code:l.ERRORNOTFOUND,label:"No 'conversation' found"})}):r.reject({code:l.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}):r.reject({code:l.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),r.promise},this.sendIsTypingStateInBubble=function(e,t){var n=i.defer();return e?"boolean"!=typeof t?n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'status' is missing or null"}):e.jid?s.getRoomConversation(e.jid).then(function(e){e?(s.sendIsTypingState(e,t),n.resolve()):n.reject({code:l.ERRORNOTFOUND,label:"No 'conversation' found for this bubble"})}):n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'bubble': this bubble isn't a valid one"}):n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),n.promise},this.removeAllMessagesFromConversation=function(e){var t=i.defer();return e?e.type!==c.Type.ONE_TO_ONE?t.reject({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):s.removeAllMessages(e).then(function(){t.resolve({code:l.OK,label:"OK"})}).catch(function(e){t.reject(e)}):t.reject({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),t.promise},this.markMessageFromConversationAsRead=function(e,t){return t?e?t.receiptStatus===r.ReceiptStatus.READ?{code:l.ERRORBADREQUEST,label:"Parameter 'message' is aldready marked as read"}:(e.sendAckReadMessage(t),t.receiptStatus===r.ReceiptStatus.READ&&s.decreaseMissedIMCounterForConversation(e),{code:l.OK,label:"OK"}):{code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}:{code:l.ERRORBADREQUEST,label:"Parameter 'message' is missing or empty"}},a.$on("$destroy",a.$on("ON_CONVERSATION_MESSAGE_RECEIVED",function(e,t,n,r){sdk.useAngularEvents?a.$broadcast(d.RAINBOW_ONNEWIMMESSAGERECEIVED,t,n,r):$(document).trigger(d.RAINBOW_ONNEWIMMESSAGERECEIVED,[t,n,r])})),a.$on("$destroy",a.$on("ON_CONVERSATION_RECEIPT_RECEIVED",function(e,t,n,r){sdk.useAngularEvents?a.$broadcast(d.RAINBOW_ONNEWIMRECEIPTRECEIVED,t,n,r):$(document).trigger(d.RAINBOW_ONNEWIMRECEIPTRECEIVED,[t,n,r])})),a.$on("$destroy",a.$on("ON_CONVERSATIONS_STATUS_MESSAGE_EVENT",function(e,t,n,r){r&&r.value&&(sdk.useAngularEvents?a.$broadcast(d.RAINBOW_ONNEWPARTICIPANTSTATUS,n,t,r.value):$(document).trigger(d.RAINBOW_ONNEWPARTICIPANTSTATUS,[n,t,r.value]))}))}]),angular.module("sdk").service("webRTCService",["$q","$log","$rootScope","videoService","platformService","settingsService","xmppService","extensionSharingService","Call","webrtcGatewayService","recordsService","conversationService","SDK",function(r,s,c,i,t,n,a,o,l,d,u,f,h){"use strict";var p=this,v="webRTCSrv  | ";this.isChromeExtensionInstalled=!1,this.RAINBOW_ONWEBRTCCALLSTATECHANGED="rainbowonwebrtccallstatechanged",this.RAINBOW_ONWEBRTCMEDIADEVICECHANGED="rainbowonwebrtcmediadevicechanged",this.RAINBOW_ONWEBRTCERRORHANDLED="rainbowonwebrtcerrorhandled",this.RAINBOW_ONWEBRTCSTREAMADDED="rainbowonwebrtcstreamadded",this.RAINBOW_ONWEBRTCTRACKCHANGED="rainbowonwebrtctrackchanged",this.RAINBOW_ONWEBRTCTMEDIAERROROCCURED="rainbowonwebrtcmediaerroroccured",this.RAINBOW_ONWEBRTCTRECORDSTARTED="rainbowonwebrtcrecordstarted",this.RAINBOW_ONWEBRTCTRECORDSTOPPED="rainbowonwebrtcrecordstopped",this.RAINBOW_ONWEBRTCTRECORDPAUSED="rainbowonwebrtcrecordpaused",this.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED="rainbowonwebrtcrecordremotestarted",this.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED="rainbowonwebrtcrecordremotestopped",this.RAINBOW_ONWEBRTCTRECORDDONE="rainbowonwebrtcrecorddone",this.RAINBOW_ONWEBRTCTRECORDERROR="rainbowonwebrtcrecorderror",this.canMakeAudioVideoCall=function(){return"https:"===location.protocol&&DetectRTC.isWebRTCSupported&&DetectRTC.isGetUserMediaSupported},this.hasAMicrophone=function(){return DetectRTC.hasMicrophone},this.hasACamera=function(){return DetectRTC.hasWebcam},this.useMicrophone=function(e){return e?(n.setSetting("microphone",e),n.setSetting("headsetMicrophone",e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'strMicrophoneId' is missing or empty"}},this.useSpeaker=function(e){return e?(n.setSetting("speaker",e),n.setSetting("headsetSpeaker",e),n.setSetting("ringingSpeaker",e),t.setSpeakerForElement(document.getElementById("largevideo"),e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'strSpeakerId' is missing or empty"}},this.useCamera=function(e){return e?(n.setSetting("camera",e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'strCameraId' is missing or empty"}},this.callInAudio=function(e,t){return e?this.canMakeAudioVideoCall()?(i.makeCall(e,"audio",t),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.callInVideo=function(e,t){return e?this.canMakeAudioVideoCall()?(i.makeCall(e,"video",t),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.callInSharing=function(e,t){var n=r.defer();return e?this.canMakeDesktopSharingCall().then(function(){i.makeDesktopSharingCall(e,"sharingOnly",t),n.resolve({code:h.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),n.promise},this.callinAudioWithSharing=function(e,t){var n=r.defer();return e?this.canMakeDesktopSharingCall().then(function(){i.makeDesktopSharingCall(e,t),n.resolve({code:h.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:h.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),n.promise},this.answerInAudio=function(e){return e?this.canMakeAudioVideoCall()?(i.answerCall(e,"audio"),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.answerInVideo=function(e){return e?this.canMakeAudioVideoCall()?(i.answerCall(e,"video"),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.showLocalVideo=function(){return this.canMakeAudioVideoCall()?(i.attachLocalMediaStream(!0),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.hideLocalVideo=function(){return this.canMakeAudioVideoCall()?(i.attachLocalMediaStream(!1),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.showRemoteVideo=function(e){return e?this.canMakeAudioVideoCall()?(i.attachDistantMediaStream(!0,e),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.hideRemoteVideo=function(e){return e?this.canMakeAudioVideoCall()?(i.attachDistantMediaStream(!1,e),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.addVideoToCall=function(e){return this.canMakeAudioVideoCall()?(i.addVideoToCall(e,!1),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.addSharingToCall=function(e){var t=r.defer();return this.canMakeDesktopSharingCall().then(function(){i.addSharingToCall(e),t.resolve({code:h.OK,label:"OK"})}).catch(function(e){t.reject(e)}),t.promise},this.removeVideoFromCall=function(e){return this.canMakeAudioVideoCall()?(i.removeVideoFromCall(e),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.removeSharingFromCall=function(e){return this.canMakeAudioVideoCall()||this.isChromeExtensionInstalled?(i.removeSharingFromCall(e),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC or Sharing is not supported by your browser"}},this.release=function(e){return e?(this.canMakeAudioVideoCall()||s.warn("[webRTCService] release called but WebRTC is not supported by your browser"),i.rejectCall(e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.muteAudioCall=function(e){return e?this.canMakeAudioVideoCall()?(i.muteAudio(e,!0),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.muteVideoCall=function(e){return e?this.canMakeAudioVideoCall()?(i.muteVideo(e,!0),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.unmuteAudioCall=function(e){return e?this.canMakeAudioVideoCall()?(i.muteAudio(e,!1),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.unmuteVideoCall=function(e){return e?this.canMakeAudioVideoCall()?(i.muteVideo(e,!1),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.getLocalStreamsFromCall=function(e){if(!(e&&"id"in e))return{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(e.type!==l.Type.WEBRTC)return{code:h.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};var t=a.connection.jingle.sessions[e.id];return t?t.localStreams:[]},this.getRemoteStreamsFromCall=function(e){if(!(e&&"id"in e))return{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(e.type!==l.Type.WEBRTC)return{code:h.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};var t=a.connection.jingle.sessions[e.id];return t?t.remoteStreams:[]},this.setChromeExtensionIdForSharing=function(e){return e?(o.setExtensionId(e),{code:h.OK,label:"OK"}):{code:h.ERRORBADREQUEST,label:"Parameter 'strExtensionId' is missing or empty"}},this.canMakeDesktopSharingCall=function(){var t=r.defer();return o.isExtensionInstalled().then(function(e){e?(p.isChromeExtensionInstalled=!0,t.resolve({code:h.OK,label:"OK"})):(p.isChromeExtensionInstalled=!1,t.reject({code:h.ERRORUNSUPPORTED,label:"Not Chrome Extension installed for desktop sharing"}))}).catch(function(e){t.reject(e)}),t.promise},this.startRecording=function(e,t,n,r,i,a){if(s.sdk(v+"[startRecording] :: Enter"),!e)return{code:h.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"};if(!t)return{code:h.ERRORBADREQUEST,label:"Parameter 'fileName' is missing or null"};if(n=null==n||n,r=null==r||r,i=null!=i&&i,a=null==a?"video/webm;codecs=vp9":a,s.sdk(v+"[startRecording] :: Prepare recording..."),u.createRecord(e.id,n?"REMOTE":"LOCAL",r,t,i,a)){u.setOnPauseCallback(function(){s.sdk(v+"[onRTCChange] :: WebRTC recording paused"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRECORDPAUSED):$(document).trigger(p.RAINBOW_ONWEBRTCTRECORDPAUSED,null)}),s.sdk(v+"[startRecording] :: Start recording..."),u.startRecording();var o=f.getConversationById(e.conversationId);return o?(s.sdk(v+"[startRecording] :: Notify remote peer",o),f.sendRecordingMessage(o,"start")):s.sdk(v+"[startRecording] :: No conversation found - can't notify remote peer"),s.sdk(v+"[startRecording] :: WebRTC recording started"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRECORDSTARTED):$(document).trigger(p.RAINBOW_ONWEBRTCTRECORDSTARTED,null),{code:h.OK,label:"OK"}}return s.sdk(v+"[startRecording] :: can't start a webRTC recording"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRECORDERROR):$(document).trigger(p.RAINBOW_ONWEBRTCTRECORDERROR,null),{code:h.ERRORBADREQUEST,label:"Can't record the conversation"}},this.stopRecording=function(e){s.sdk(v+"[stopRecording] :: Stop current WebRTC recording"),u.setOnPauseCallback(null),u.stopRecording();var t=f.getConversationById(e.conversationId);return t?(s.sdk(v+"[stopRecording] :: Notify remote peer",t),f.sendRecordingMessage(t,"stop")):s.sdk(v+"[stopRecording] :: No conversation found - can't notify remote peer"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRECORDSTOPPED):$(document).trigger(p.RAINBOW_ONWEBRTCTRECORDSTOPPED,null),{code:h.OK,label:"OK"}},this.callUsingMediaPillar=function(e){return e?this.canMakeAudioVideoCall()?(d.mediaPillarMakeCall(e,null),{code:h.OK,label:"OK"}):{code:h.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:h.ERRORBADREQUEST,label:"Parameter 'number' is missing or null"}};c.$on("$destroy",c.$on("ON_CALL_UPDATED_EVENT",function(e,t){t.type.value===l.Type.WEBRTC.value&&(s.sdk(v+"[onRTCChange] :: WebRTC state changed to "+t),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCCALLSTATECHANGED,t):$(document).trigger(p.RAINBOW_ONWEBRTCCALLSTATECHANGED,[t]))})),c.$on("$destroy",c.$on("ON_WEBRTC_CALL_ERROR_EVENT",function(e,t){s.sdk(v+"[onRTCError ] :: WebRTC Error"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCERRORHANDLED,t):$(document).trigger(p.RAINBOW_ONWEBRTCERRORHANDLED,[t])})),c.$on("$destroy",c.$on("ON_WEBRTC_REMOTE_STREAM_ADDED",function(e,t){s.sdk(v+"[onRTCStream] :: WebRTC remote stream added"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCSTREAMADDED,t):$(document).trigger(p.RAINBOW_ONWEBRTCSTREAMADDED,[t])})),c.$on("$destroy",c.$on("ON_WEBRTC_CALL_ESCALATION_SUCCESS",function(e,t){s.sdk(v+"[onRTCEsc   ] :: WebRTC Escalade"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRACKCHANGED,t):$(document).trigger(p.RAINBOW_ONWEBRTCTRACKCHANGED,[t])})),c.$on("$destroy",c.$on("ON_WEBRTC_GETUSERMEDIA_ERROR",function(e,t){s.sdk(v+"[onRTCError ] :: WebRTC getUserMedia error"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTMEDIAERROROCCURED,t):$(document).trigger(p.RAINBOW_ONWEBRTCMEDIAERROROCCURED,[t])})),c.$on("$destroy",c.$on("ON_WEBRTC_RECORD_SAVED",function(e,t,n,r){s.sdk(v+"[onRTCRec   ] :: WebRTC record received"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRECORDDONE,t,n,r):$(document).trigger(p.RAINBOW_ONWEBRTCTRECORDDONE,[t,n,r])})),c.$on("$destroy",c.$on("ON_WEBRTC_RECORD_ERROR",function(e){s.sdk(v+"[onRTCRec   ] :: WebRTC record error"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRECORDERROR):$(document).trigger(p.RAINBOW_ONWEBRTCTRECORDERROR,null)})),c.$on("$destroy",c.$on("ON_RECORDING_START_MSG_RECEIVED",function(e){s.sdk(v+"[onRTCRecRem] :: WebRTC record started by remote peer"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED):$(document).trigger(p.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED,null)})),c.$on("$destroy",c.$on("ON_RECORDING_STOP_MSG_RECEIVED",function(e){s.sdk(v+"[onRTCRecRem] :: WebRTC record stopped by remote peer"),sdk.useAngularEvents?c.$broadcast(p.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED):$(document).trigger(p.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED,null)}))}]),angular.module("sdk").service("bubblesService",["$q","$rootScope","$log","roomService","Room","conversationService","contactService","conferenceService","profileService","webConferenceService","PromiseQueue","SDK",function(f,r,h,p,v,l,i,a,e,o,n,m){"use strict";var s=this,g="BubbleSrv  | ",c=null,d=null;this.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED="rainbowbubblerequesttojoin",this.RAINBOW_ONBUBBLEUPDATED="rainbowbubbleupdated",this.RAINBOW_ONBUBBLEAVATARUPDATED="rainbowbubbleavatarupdated",this.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED="rainbowbubbleconferencestartinvitation",this.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED="rainbowbubblesharingconferencestartinvitation",this.createBubble=function(t,e,n,r,i){var a=f.defer(),o=null,s=e||"",c=!1;return n&&(c=!0),r=!!r,t?p.createRoom(t,s,c,i,r).then(function(e){return o=e,l.getRoomConversation(o.jid)}).then(function(e){h.sdk(g+"[create     ] :: New bubble "+t+" created successfully"),p.sendInitialRoomPresence(e.room),a.resolve(o)}).catch(function(e){h.sdk(g+"[create     ] :: Error when creating a bubble"),a.reject(e)}):a.reject({code:m.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),a.promise},this.deleteBubble=function(e){var t=f.defer();return(e=e&&e.dbId?p.getRoomById(e.dbId):null)?this.closeBubble(e).then(function(e){return p.ownerDeleteRoom(e)}).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),t.promise},this.deleteAllBubbles=function(){var t=n.create();return p.getMyRooms().forEach(function(e){t.add(function(){return s.deleteBubble(e)})}),t.execute()},this.inviteContactToBubble=function(t,e,n,r){var i=f.defer();if(e=e&&e.dbId?p.getRoomById(e.dbId):null,t)if(e){var a=v.Privilege.USER;n&&(a=v.Privilege.MODERATOR);var o=!1;"boolean"==typeof r&&(o=!r);var s=!1,c=!1,l=!1,d=!1,u=!1;e.users.forEach(function(e){if(e.contact.id===t.id)switch(e.status){case"invited":l=!0;break;case"accepted":s=!0;break;case"unsubscribed":c=!0;break;case"rejected":d=!0;break;case"deleted":u=!0}}),s||l?i.reject({code:m.ERRORBADREQUEST,label:"Contact has been already invited or is already a member of the room"}):c||d?p.ownerReinviteRejectedUser(e,t,null,a,o).then(function(e){e.updateAvatarInfo(),i.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when inviting a contact"),i.reject(e)}):u?p.ownerReinviteDeletedUser(e,t,null,a).then(function(e){e.updateAvatarInfo(),i.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when inviting a contact"),i.reject(e)}):p.addRoomUser(e,t,null,a,o).then(function(e){e.updateAvatarInfo(),i.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when inviting a contact"),i.reject(e)})}else i.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});else i.reject({code:m.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return i.promise},this.removeContactFromBubble=function(t,e){var n=f.defer();if(e=e&&e.dbId?p.getRoomById(e.dbId):null,t)if(e){var r="";switch(e.users.forEach(function(e){e.contact.id===t.id&&(r=e.status)}),r){case p.RoomUserStatus.INVITED:p.ownerDeletesUserFromRoom(e,t).then(function(e){e.updateAvatarInfo(),n.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when removing a contact"),n.reject(e)});break;case p.RoomUserStatus.ACCEPTED:p.unsubscribeUserFromRoom(e,t).then(function(e){e.updateAvatarInfo(),n.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when removing a contact"),n.reject(e)});break;default:n.resolve(e)}}else n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"});else n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return n.promise},this.promoteContactToModerator=function(e,t){var n=f.defer();return t=t&&t.dbId?p.getRoomById(t.dbId):null,e?t?p.updateRoomUser(t,e,null,"moderator").then(function(e){e.updateAvatarInfo(),n.resolve(e)}).catch(function(e){h.sdk(g+"[promote    ] :: Error when promoving a contact"),n.reject(e)}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),n.promise},this.demoteContactFromModerator=function(e,t){var n=f.defer();return t=t&&t.dbId?p.getRoomById(t.dbId):null,e?t?p.updateRoomUser(t,e,null,"user").then(function(e){e.updateAvatarInfo(),n.resolve(e)}).catch(function(e){h.sdk(g+"[demote     ] :: Error when demoting a contact"),n.reject(e)}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),n.promise},this.changeOwner=function(e,t){var n=f.defer();return t=t&&t.dbId?p.getRoomById(t.dbId):null,e?t?p.changeRoomOwner(t,e).then(function(e){e.updateAvatarInfo(),n.resolve(e)}).catch(function(e){h.sdk(g+"[changeOwner] :: Error when changing bubble owner"),n.reject(e)}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),n.promise},this.acceptInvitationToJoinBubble=function(e){var t=f.defer();return(e=e&&e.dbId?p.getRoomById(e.dbId):null)?p.acceptRoomInvitation(e).then(function(){t.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when joining a bubble"),t.reject(e)}):t.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),t.promise},this.declineInvitationToJoinBubble=function(e){var t=f.defer();return(e=e&&e.dbId?p.getRoomById(e.dbId):null)?p.declineRoomInvitation(e).then(function(e){t.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when joining a bubble"),t.reject(e)}):t.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),t.promise},this.leaveBubble=function(e){var t=f.defer();if(e=e&&e.dbId?p.getRoomById(e.dbId):null){var n=!1;if(e.users.forEach(function(e){i.isUserContact(e)||"moderator"===e.privilege&&"accepted"===e.status&&(n=!0)}),n)switch(e.status){case p.RoomUserStatus.UNSUBSCRIBED:p.participantCloseRoom(e).then(function(e){t.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when leaving a bubble"),t.reject(e)});break;default:p.unsubscribeMeFromRoom(e).then(function(e){t.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when leaving a bubble"),t.reject(e)})}else t.reject({code:m.ERRORBADREQUEST,label:"Can't leave the bubble. No other moderator"})}else t.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});return t.promise},this.closeBubble=function(e){var t=f.defer();return(e=e&&e.dbId?p.getRoomById(e.dbId):null)?this.isBubbleArchived(e)?t.resolve(e):p.ownerArchiveRoom(e).then(function(e){t.resolve(e)}).catch(function(e){h.sdk(g+"[invite     ] :: Error when closing a bubble"),t.reject(e)}):t.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),t.promise},this.isBubbleArchived=function(e){var t=!0;return(e=e&&e.dbId?p.getRoomById(e.dbId):null)?e.status!==p.RoomUserStatus.UNSUBSCRIBED?t=!1:e.users.forEach(function(e){e.status!==p.RoomUserStatus.UNSUBSCRIBED&&e.status!==p.RoomUserStatus.DELETED&&(t=!1)}):t=!1,t},this.getAllBubbles=function(){return p.getRooms()},this.getAllOwnedBubbles=function(){return p.getMyRooms()},this.getAllPendingBubbles=function(){return p.getRooms().filter(function(e){return"invited"===e.status})},this.getBubbleById=function(e){return e?p.getRoomById(e):{code:m.ERRORBADREQUEST,label:"Parameter 'strBubbleId' is missing or empty"}},this.updateDescriptionForBubble=function(e,t){var n=f.defer();return t=t&&t.dbId?p.getRoomById(t.dbId):null,e?t?(t.desc=e,p.ownerUpdateRoom(t).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)})):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'strDescription' is missing or empty"}),n.promise},this.updateAvatarForBubble=function(e,t){var n=f.defer();return t=t&&t.dbId?p.getRoomById(t.dbId):null,e?t?(t.id=t.dbId,p.setAvatarRoom(t,e).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)})):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'urlAvatar' is missing or empty"}),n.promise},this.deleteAvatarFromBubble=function(e){var t=f.defer();return(e=e&&e.dbId?p.getRoomById(e.dbId):null)?p.deleteAvatarRoom(e.dbId).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),t.promise},this.updateCustomDataForBubble=function(e,t){var n=f.defer();return t=t&&t.dbId?p.getRoomById(t.dbId):null,e?t?(t.customData=e,p.ownerUpdateRoomCustomData(t).then(function(e){t.customData=e,n.resolve(t)}).catch(function(e){n.reject(e)})):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'customData' is missing or empty"}),n.promise},this.deleteCustomDataForBubble=function(t){var n=f.defer();return(t=t&&t.dbId?p.getRoomById(t.dbId):null)?(t.customData={},p.ownerUpdateRoomCustomData(t).then(function(e){t.customData=e,n.resolve(t)}).catch(function(e){n.reject(e)})):n.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),n.promise},this.isWebRtcConferenceAllowed=function(){return e.isFeatureEnabled(e.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)},this.hasActiveConferenceSession=function(){return o.hasActiveConferenceSession()},this.getWebRtcConferenceBubble=function(){return o.getRelatedRoomToActiveConferenceSession()},this.startOrJoinWebRtcConference=function(e){var t=f.defer();return(e=e&&e.dbId?p.getRoomById(e.dbId):null)?this.hasActiveConferenceSession()?t.reject({code:m.ERROR,label:"Already in a conference"}):o.startOrJoinWebConference(e,"webrtc").then(function(){c=e,d="webrtc",t.resolve(p.getRoomById(e.dbId))}).catch(function(e){t.reject(e)}):t.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),t.promise},this.startOrJoinSharingWebRtcConference=function(e){var t=f.defer();return(e=e&&e.dbId?p.getRoomById(e.dbId):null)?this.hasActiveConferenceSession()?t.reject({code:m.ERROR,label:"Already in a conference"}):o.startOrJoinWebConference(e,"sharing").then(function(){t.resolve(p.getRoomById(e.dbId)),c=e,d="sharing"}).catch(function(e){t.reject(e)}):t.reject({code:m.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),t.promise},this.stopWebRtcConference=function(){var t=f.defer();if(c=c&&c.dbId?p.getRoomById(c.dbId):null,this.hasActiveConferenceSession()&&c){var e="";e="webrtc"===d?c.getSFUConfEndpointId():c.getSFUSharingConfEndpointId();var n=o.getConferenceSessionById(e),r=n?n.getParticipantByJid(i.userContact.jid):null;"moderator"!==r.role?a.disconnectsParticipant(e,r.participantId,d).then(function(){d=c=null,t.resolve()}).catch(function(e){t.reject(e)}):a.stopConference(e,d,c.dbId).then(function(){d=c=null,t.resolve()}).catch(function(e){t.reject(e)})}else t.reject({code:m.ERRORBADREQUEST,label:"No known conference in a Bubble"});return t.promise},r.$on("$destroy",r.$on(p.ROOM_UPDATE_EVENT,function(e,t){sdk.useAngularEvents?r.$broadcast(s.RAINBOW_ONBUBBLEUPDATED,t):$(document).trigger(s.RAINBOW_ONBUBBLEUPDATED,[t])})),r.$on("$destroy",r.$on(p.ROOM_AVATAR_UPDATE_EVENT,function(e,t){sdk.useAngularEvents?r.$broadcast(s.RAINBOW_ONBUBBLEAVATARUPDATED,t):$(document).trigger(s.RAINBOW_ONBUBBLEAVATARUPDATED,[t])})),r.$on("$destroy",r.$on(p.ROOM_INVITATION,function(e,t){sdk.useAngularEvents?r.$broadcast(s.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,t):$(document).trigger(s.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,[t])})),r.$on("$destroy",r.$on("ON_CONFERENCE_STARTED_INVITATION",function(e,t){var n=t.confEndpoints;n&&n.forEach(function(e){"webrtc"===e.mediaType&&(sdk.useAngularEvents?r.$broadcast(s.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED,t):$(document).trigger(s.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED,[t])),"webrtcSharingOnly"===e.mediaType&&(sdk.useAngularEvents?r.$broadcast(s.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED,t):$(document).trigger(s.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED,[t]))})}))}]),angular.module("sdk").service("groupsService",["$q","$rootScope","$log","groupService","Group","contactService","PromiseQueue","SDK",function(o,a,s,c,l,e,n,d){"use strict";var u=this,f="GroupSrv  | ";this.RAINBOW_ONGROUPCREATED="rainbowgroupcreated",this.RAINBOW_ONGROUPUPDATED="rainbowgroupupdated",this.RAINBOW_ONGROUPDELETED="rainbowgroupdeleted",this.RAINBOW_ONGROUPUSERADDED="rainbowgroupuseradded",this.RAINBOW_ONGROUPUSERREMOVED="rainbowgroupuserdeleted",this.createGroup=function(t,e,n){var r=o.defer(),i=null,a=!1;return"boolean"==typeof n&&(a=n),t?(i=new l(null,t,e||"",a),c.addGroup(i).then(function(e){s.sdk(f+"[create     ] :: New group "+t+" created successfully"),r.resolve(e)}).catch(function(e){s.sdk(f+"[create     ] :: Error when creating a group"),r.reject(e)})):r.reject({code:d.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),r.promise},this.deleteGroup=function(e){var t=o.defer(),n=e.name;return c.removeGroup(e.id).then(function(){s.sdk(f+"[delete     ] :: Group "+n+" deleted successfully"),t.resolve()}).catch(function(e){s.sdk(f+"[delete     ] :: Error when deleting a group"),t.reject(e)}),t.promise},this.deleteAllGroups=function(){var t=n.create();return c.getGroupsAsArray().forEach(function(e){t.add(function(){return u.deleteBubble(e)})}),t.execute()},this.getGroups=function(){return c.getGroupsAsArray()},this.getGroupById=function(t){var n=null;return c.getGroupsAsArray().some(function(e){return t===e.id&&(n=e,!0)}),n},this.addContactInGroup=function(e,t){var n=o.defer();return e?t?c.addGroupUser(t,e).then(function(e){var t=e?e.name?e.name:"[error NULL group name]":"[error NULL group]";s.sdk(f+"[addContactInGroup] :: Group "+t+" successfully"),n.resolve(e.id)}).catch(function(e){s.sdk(f+"[addContactInGroup] :: Error when adding a contact in a group"),n.reject(e)}):n.reject({code:d.ERRORBADREQUEST,label:"Parameter 'group' is missing or null"}):n.reject({code:d.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),n.promise},this.removeContactFromGroup=function(e,t){var n=o.defer();if(e){if(t)return c.removeGroupUser(t.id,e);n.reject({code:d.ERRORBADREQUEST,label:"Parameter 'group' is missing or null"})}else n.reject({code:d.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return n.promise},a.$on("$destroy",a.$on(c.ON_UPDATE_GROUP_EVENT,function(e,t,n,r,i){sdk.useAngularEvents?a.$broadcast(u.RAINBOW_ONGROUPUPDATED,t,n,r,i):$(document).trigger(u.RAINBOW_ONGROUPUPDATED,[t,n,r,i])})),a.$on("$destroy",a.$on(c.ON_CREATED_GROUP_EVENT,function(e,t){sdk.useAngularEvents?a.$broadcast(u.RAINBOW_ONGROUPCREATED,t):$(document).trigger(u.RAINBOW_ONGROUPCREATED,[t])})),a.$on("$destroy",a.$on(c.ON_REMOVED_GROUP_EVENT,function(e,t){sdk.useAngularEvents?a.$broadcast(u.RAINBOW_ONGROUPDELETED,t):$(document).trigger(u.RAINBOW_ONGROUPDELETED,[t])})),a.$on("$destroy",a.$on(c.ON_ADD_GROUP_USER_EVENT,function(e,t,n){sdk.useAngularEvents?a.$broadcast(u.RAINBOW_ONGROUPUSERADDED,t,n):$(document).trigger(u.RAINBOW_ONGROUPUSERADDED,[t,n])})),a.$on("$destroy",a.$on(c.ON_REMOVE_GROUP_USER_EVENT,function(e,t,n){sdk.useAngularEvents?a.$broadcast(u.RAINBOW_ONGROUPUSERREMOVED,t,n):$(document).trigger(u.RAINBOW_ONGROUPUSERREMOVED,[t,n])}))}]),angular.module("sdk").service("callsLogService",["$q","$rootScope","$log","callLogService",function(e,n,t,o){"use strict";var r=this,i=!1;this.RAINBOW_ONCALLLOGUPDATED="rainbowcalllogupdated",this.RAINBOW_ONCALLLOGACKUPDATED="rainbowcalllogackupdated",this.getAll=function(){o.orderCallLogsFunction();for(var e=o.getSimplifiedCallLogs(),t=0;t<e.length;t++){var n=0,r=e[t].duration;if(r&&"string"==typeof r&&r.match(/^(?:(?:([01]?\d|2[0-3])h )?([0-5]?\d)m )?([0-5]?\ds)$/)){for(var i=(r=r.replace(/[hms]/g,"")).split(" ").reverse(),a=0;a<i.length;a++)n+=i[a]*Math.pow(60,a);e[t].duration=1e3*n}}return e},this.getMissedCallLogCounter=function(){return o.getMissedCallLogCounter()},this.deleteOneCallLog=function(e){return o.deleteOneCallLog(e)},this.deleteCallLogsForContact=function(e){return o.deleteCallLogsForContact(e)},this.deleteAllCallLogs=function(){return o.deleteAllCallLogs()},this.markCallLogAsRead=function(e){return o.markCallLogAsRead(e)},this.markAllCallsLogsAsRead=function(){return o.markAllCallsLogsAsRead()},this.isInitialized=function(){return i},n.$on("$destroy",n.$on("ON_CALL_LOG_UPDATED",function(e,t){i=!0,sdk.useAngularEvents?n.$broadcast(r.RAINBOW_ONCALLLOGUPDATED,t):$(document).trigger(r.RAINBOW_ONCALLLOGUPDATED,[t])})),n.$on("$destroy",n.$on("ON_CALL_LOG_ACK_UPDATED",function(e,t){i=!0,sdk.useAngularEvents?n.$broadcast(r.RAINBOW_ONCALLLOGACKUPDATED,t):$(document).trigger(r.RAINBOW_ONCALLLOGACKUPDATED,[t])}))}]),angular.module("sdk").service("cpaasService",["$q","$log","$rootScope","$http","SDK",function(a,o,e,s,t){"use strict";var c=this,l="CPaaSSrv   | ",d="",u="",r="",f="openrainbow.com";this.isAuthenticated=!1,this.hasSession=!1,this.RAINBOW_ONCPAAS_SESSION_CREATED="rainbowoncpaassessioncreated",this.authenticate=function(e,t,n){var r=a.defer();if(o.sdk(l+"[authent    ] :: Try to authenticate application "+e),0<e.length){var i=btoa(e+":"+t);n&&(f=n),s({method:"GET",url:"https://"+f+":443/api/rainbow/applications/v1.0/authentication/login",headers:{Accept:"application/json",Authorization:"Basic "+i}}).success(function(e){o.sdk(l+"[authent    ] :: Authentication is successfull for application "+e.loggedInApplication.id),d=e.token,u=e.loggedInApplication.id,c.isAuthenticated=!0,r.resolve(e.data)}).error(function(e){o.sdk(l+"[authent    ] :: Authentication fails: "+e.errorDetails),r.resolve()})}else r.resolve();return r.promise},this.createSession=function(e,t){var n=a.defer();return o.sdk(l+"[session    ] :: Try to create a new session for userID"+e+" on app "+u),this.isAuthenticated?s({method:"POST",url:"https://"+f+":443/api/v1.0/sdk/applications/"+u+"/sessions",headers:i(),data:{event:"session_start",data:{localUserURI:e,localUserSessionURI:t}}}).success(function(e){o.sdk(l+"[session    ] :: Session successfully created "+e.data.session.id),r=e.data.session.id,c.hasSession=!0,n.resolve(e.data)}).error(function(e){n.reject(e)}):o.sdk(l+"[session    ] :: Warning, the application is not authenticated. No way to track sessions..."),n.promise},this.appToken=function(){return d},this.updateSession=function(e){var t=a.defer();return o.sdk(l+"[session    ] :: Try to update information on the session "+r),this.isAuthenticated&&this.hasSession?s({method:"PUT",url:"https://"+f+":443/api/v1.0/sdk/applications/"+u+"/sessions/"+r+"/info",headers:i(),data:{event:"session_info",data:e}}).success(function(e){o.sdk(l+"[session    ] :: Information successfully updated for session "+r),t.resolve(e.data)}).error(function(e){t.reject(e)}):o.sdk(l+"[session    ] :: Warning, the application is not authenticated. No way to track sessions..."),t.promise};var i=function(){return{"x-access-sdk-token":d,Accept:"application/json"}};e.$on("$destroy",function(){null})}]),angular.module("sdk").service("filesStorageService",["$q","$rootScope","$log","Conversation","fileStorageService","fileServerService","conversationService","contactService","SDK",function(e,n,o,s,a,i,c,r,l){"use strict";var d=this,u="StorageSrv   | ";this.RAINBOW_ONFILEUPLOADED="rainbowfileuploaded",this.RAINBOW_ONFILEUPLOADED_ERROR="rainbowfileuploadederror",this.RAINBOW_ONFILEDOWNLOADED="rainbowfiledownloaded",this.RAINBOW_ONFILEDOWNLOADED_ERROR="rainbowfiledownloadederror";var f={success:{download:this.RAINBOW_ONFILEDOWNLOADED,upload:this.RAINBOW_ONFILEUPLOADED},error:{download:this.RAINBOW_ONFILEDOWNLOADED_ERROR,upload:this.RAINBOW_ONFILEUPLOADED_ERROR}};this._addFileToConversation=function(r,i,a){return e(function(t,n){return e(function(n){if("string"==typeof i){var r=new XMLHttpRequest;r.open("GET",i,!0),r.onreadystatechange=function(){if(r.readyState===XMLHttpRequest.DONE){var e=r.response,t=new File([e],i.replace(/^.*[\\\/]/,""),{type:"",lastModified:Date.now()});n(t)}},r.responseType="blob",r.send()}else n(i)}).then(function(e){1e8<e.size?n({code:l.ERRORBADREQUEST,label:"The file is to large (limited to 100MB)"}):c.sendFSMessage(r,e,a).then(function(e){t(e)})})})},this.uploadFileToConversation=function(e,r,i){return new Promise(function(t,n){e?r?e.type!==s.Type.ONE_TO_ONE?n({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):(o.sdk(u+"[addFileCnv ] ::  Try to add a file "+r+" to the conversation "+e.id),d._addFileToConversation(e,r,i).then(function(e){o.sdk(u+"[addFileCnv ] ::  file added"),t(e)}).catch(function(e){n(e)})):n({code:l.ERRORBADREQUEST,label:"Parameter 'file' is missing or null"}):n({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.uploadFileToBubble=function(r,i,a){return new Promise(function(t,n){if(r)if(i){var e=c.getConversationByRoomDbId(r.dbId);e?e.type!==s.Type.ROOM?n({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is not a bubble conversation"}):(o.sdk(u+"[addFileBub ] ::  Try to add a file "+i+" to the bubble "+r.dbId),d._addFileToConversation(e,i,a).then(function(e){o.sdk(u+"[addFileBub ] ::  file added"),t(e)}).catch(function(e){n(e)})):n({code:l.ERRORBADREQUEST,label:"Parameter 'bubble' don't have a conversation"})}else n({code:l.ERRORBADREQUEST,label:"Parameter 'file' is missing or null"});else n({code:l.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.downloadFile=function(r){return new Promise(function(t,n){if(r){o.sdk(u+"[getFile    ] ::  Try to get a file "+r.filename);var e={url:r.url||config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+r.id,mime:r.mime||r.typeMime,filesize:r.filesize||r.size,filename:r.filename||r.fileName};i.getBlobFromUrlWithOptimization(e.url,e.mime,e.filesize,e.filename).then(function(e){o.sdk(u+"[getFile    ] ::  file downloaded"),t(e)}).catch(function(e){n(e)})}else n({code:l.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' is missing or null"})})},this.removeFile=function(i){return new Promise(function(e,t){if(i||t({code:l.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' is missing or null"}),i.id||i.url){o.sdk(u+"[removeFile ] ::  Try to remove a file "+i.filename);var n=i.id;if(!n){var r=i.url.split("/");n=r.pop()||r.pop()}a.deleteFileDescriptor(n).then(function(){o.sdk(u+"[getFile    ] ::  file removed"),e({code:l.OK,label:"OK"})}).catch(function(e){t(e)})}else t({code:l.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' don't contain information to remove the file"})})},this.getFileDescriptorFromId=function(e){return o.sdk(u+"[getFileDescriptorFromId] ::  get file descriptor "+e),a.getFileDescriptorById(e)},this.getFilesReceivedInConversation=function(e){return new Promise(function(t,n){e?e.type!==s.Type.ONE_TO_ONE?n({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):(o.sdk(u+"[getFilesRcv] ::  get files received in conversation "+e.id+"..."),a.retrieveFilesReceivedFromPeer(r.userContact.dbId,e.contact.dbId).then(function(e){o.sdk(u+"[getFilesRcv] ::  shared "+e.length),t(e)}).catch(function(e){n(e)})):n({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.getFilesReceivedInBubble=function(e){return new Promise(function(t,n){e?(o.sdk(u+"[getFilesRcv] ::  get files received in bubble "+e.dbId+"..."),a.retrieveReceivedFilesForRoom(e.dbId).then(function(e){o.sdk(u+"[getFilesRcv] ::  shared "+e.length),t(e)}).catch(function(e){n(e)})):n({code:l.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.getFilesSentInConversation=function(e){return new Promise(function(t,n){e?e.type!==s.Type.ONE_TO_ONE?n({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):(o.sdk(u+"[getFilesSnd] ::  get files sent in conversation "+e.id+"..."),a.retrieveSentFiles(e.contact.dbId).then(function(e){o.sdk(u+"[getFilesSnd] ::  shared "+e.length),t(e)}).catch(function(e){n(e)})):n({code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.getFilesSentInBubble=function(e){return new Promise(function(t,n){e?(o.sdk(u+"[getFilesRcv] ::  get files received in bubble "+e.dbId+"..."),a.retrieveSentFiles(e.dbId).then(function(e){o.sdk(u+"[getFilesSnd] ::  shared "+e.length),t(e)}).catch(function(e){n(e)})):n({code:l.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.getUserQuotaConsumption=function(){return new Promise(function(t,e){a.retrieveUserConsumption().then(function(e){t(e)})})},this.getAllFilesSent=function(){return a.getDocuments()},this.getAllFilesReceived=function(){return a.getReceivedDocuments()};n.$on("$destroy",n.$on("ON_FILE_TRANSFER_EVENT",function(e,t){t.result&&t.type&&(o.sdk(u+"[OnFileTrans] ::  file transfered..."),sdk.useAngularEvents?n.$broadcast(f[t.result][t.type],t):$(document).trigger(f[t.result][t.type],[t]))}))}]),angular.module("sdk").service("capabilitiesService",["profileService",function(e){"use strict";this.getAll=function(){return e.getMyProfileFeatures()},this.hasS4BExtensionEnabled=function(){return e.isFeatureEnabled("MS_SKYPE_PLUGIN")},this.hasOutlookExtensionEnabled=function(){return e.isFeatureEnabled("MS_OUTLOOK_PLUGIN")},this.hasCalendarPresenceEnabled=function(){return e.isFeatureEnabled("MSO365_CALENDAR_PRESENCE")},this.hasTelephonyBasicCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_BASIC_CALL")},this.hasTelephonySecondCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_SECOND_CALL")},this.hasTelephonyTransferCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_TRANSFER_CALL")},this.hasTelephonyConferenceCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_CONFERENCE_CALL")},this.hasTelephonyDeflectCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_DEFLECT_CALL")},this.hasTelephonyForwardCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_FORWARD_CALL")},this.hasTelephonyPhoneBookEnabled=function(){return e.isFeatureEnabled("TELEPHONY_PHONE_BOOK")},this.hasTelephonyVoiceMailEnabled=function(){return e.isFeatureEnabled("TELEPHONY_VOICE_MAIL")},this.hasWebRTCAudioMobileEnabled=function(){return e.isFeatureEnabled("WEBRTC_FOR_MOBILE")},this.hasWebRTCVideoMobileEnabled=function(){return e.isFeatureEnabled("WEBRTC_FOR_MOBILE_VIDEO")},this.hasBridgeConferenceEnabled=function(){return e.isFeatureEnabled("CONFERENCE_ALLOWED")},this.hasBridgeConferenceRecordEnabled=function(){return e.isFeatureEnabled("CONFERENCE_RECORDING")},this.hasBridgeConferenceDialOutEnabled=function(){return e.isFeatureEnabled("CONFERENCE_DIAL_OUT")},this.maxParticipantsPerBubbleAllowed=function(){return e.getFeatureLimitMax("BUBBLE_PARTICIPANT_COUNT")},this.maxParticipantsPerBridgeConferenceAllowed=function(){return e.getFeatureLimitMax("CONFERENCE_PARTICIPANT_COUNT")},this.maxFileStorageQuotaAllowed=function(){return e.getFeatureLimitMax("FILE_SHARING_QUOTA_GB")}}]),angular.module("sdk").service("adminService",["$q","$rootScope","$log","Company","User","adminCompanyService","adminUserService","SDK",function(t,e,n,o,c,s,l,r){"use strict";this.createEssentialCompany=function(r,i){return t(function(t,n){var e=o.create(null,"");e.name=r,e.country=i,s.createCompanyEndUser(e).then(function(e){t(e)}).catch(function(e){n(e)})})},this.createCompany=function(r,i,a){return t(function(t,n){var e=o.create(null,"");e.name=r,e.country=i,a&&(e.state=a),e.economicActivityClassification="",s.createCompany(e).then(function(e){t(e)}).catch(function(e){n(e)})})},this.removeCompany=function(n){return t(function(e,t){s.deleteCompany(n.id).then(function(){e(n)}).catch(function(e){t(e)})})},this.createUserForCompany=function(r,i,a,o,s){return t(function(t,n){var e=c.create();e.loginEmail=r,e.firstName=i,e.lastName=a,e.password=o,e.language="en",e.companyId=s.id,e.adminType="undefined",e.isActive=!0,e.isInitialized=!0,l.createUser(e).then(function(e){t(e)}).catch(function(e){n(e)})})},this.removeUserFromCompany=function(n){return t(function(e,t){l.deleteUser(n).then(function(){e(n)}).catch(function(e){t(e)})})},this.setVisibilityForCompany=function(n,r){return t(function(e,t){s.addVisibility(n.id,r.id).then(function(){e(n)}).catch(function(e){t(e)})})},this.promoteCompanyToBP=function(e,r,i){return t(function(t,n){e.isBP=!0,e.bpType=r,e.bpBusinessModel="resell",e.bpApplicantNumber=i,e.bpCRDid=i,e.supportEmail="rford@sandbox.westworld.com",s.updateCompany(e).then(function(e){t(e)}).catch(function(e){n(e)})})}}]),angular.module("sdk").service("channelsService",["$log","$q","$rootScope","channelService","contactService","SDK",function(c,l,a,d,o,u){"use strict";var s=this,f="ChannelsSrv| ";this.RAINBOW_ONCHANNELMESSAGERECEIVED="rainbowchannelmessagereceived",this.RAINBOW_ONCHANNELUPDATED="rainbowchannelupdate",this.RAINBOW_ONCHANNELDELETED="rainbowchanneldeleted",this.RAINBOW_ONCHANNELUSERSUPDATED="rainbowchannelusersupdate",this.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED="rainbowchannelretractmessage",this.RAINBOW_ONCHANNELAVATARUPDATED="rainbowchannelavatarupdate",this.RAINBOW_ONCHANNELUSERSUBSCRIBED="rainbowchannelusersubscribed",this.RAINBOW_ONCHANNELUSERUNSUBSCRIBED="rainbowchanneluserunsubscribed",this.getMyChannels=function(){return d.getMyChannels()},this.createChannel=function(e,t,n,r){var i=l.defer();return c.sdk(f+"[createCha  ] :: Try to create a new channel..."),e?(n=n||"company",r=r||100,t=t||"",d.createChannel(e,t,n,r).then(function(e){c.sdk(f+"[createCha  ] :: created: "+e.id),i.resolve(e)}).catch(function(e){i.reject(e)})):i.reject({code:u.ERRORBADREQUEST,label:"Parameter 'channelName' is missing or empty"}),i.promise},this.createPublicChannel=function(e,t,n){var r=l.defer();if(c.sdk(f+"[createCha  ] :: Try to create a new public channel..."),e){n=n||100,t=t||"",d.createChannel(e,t,"company",n).then(function(e){c.sdk(f+"[createCha  ] :: created: "+e.id),r.resolve(e)}).catch(function(e){r.reject(e)})}else r.reject({code:u.ERRORBADREQUEST,label:"Parameter 'channelName' is missing or empty"});return r.promise},this.createPrivateChannel=function(e,t,n){var r=l.defer();if(c.sdk(f+"[createCha  ] :: Try to create a new private channel..."),e){n=n||100,t=t||"",d.createChannel(e,t,"private",n).then(function(e){c.sdk(f+"[createCha  ] :: created: "+e.id),r.resolve(e)}).catch(function(e){r.reject(e)})}else r.reject({code:u.ERRORBADREQUEST,label:"Parameter 'channelName' is missing or empty"});return r.promise},this.deleteChannel=function(e){var t=l.defer();return c.sdk(f+"[deleteCha  ] :: Try to delete a channel..."),e?(d.deleteChannel(e).then(function(){c.sdk(f+"[deleteCha  ] :: deleted: "+e),t.resolve({code:u.OK,label:"OK"})}).catch(function(e){t.reject(e)}),t.promise):t.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"})},this.findChannels=function(e){var t=l.defer();return c.sdk(f+"[findCha    ] :: Try to find channels..."),e?d.findChannels(e).then(function(e){c.sdk(f+"[findCha    ] :: found: "+e.length),t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject({code:u.ERRORBADREQUEST,label:"Parameter 'filter' is missing or empty"}),t.promise},this.getChannel=function(e){var t=l.defer();return c.sdk(f+"[getChannel ] :: Try to get a channel..."),e?d.getChannel(e).then(function(e){c.sdk(f+"[getChannel ] :: got: "+e.id),t.resolve(e)}).catch(function(e){t.reject(e)}):t.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),t.promise},this.publishToChannel=function(e,t,n,r){var i=l.defer();return c.sdk(f+"[publishTo  ] :: Try to publish a channel..."),e?t?(n=n||"",r=r||"",d.publishToChannel(e.id,t,n,r).then(function(){c.sdk(f+"[publishTo  ] :: published: "+e.id),i.resolve({code:u.OK,label:"OK"})}).catch(function(e){i.reject(e)})):i.reject({code:u.ERRORBADREQUEST,label:"Parameter 'message' is missing or empty"}):i.reject({code:u.ERRORBADREQUEST,label:"Parameter 'channel' is missing or empty"}),i.promise},this.subscribeToChannelById=function(t){var n=l.defer();c.sdk(f+"[subscribeTo] :: Try to subscribe to a channel..."),t||n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or null"});var e=d.getChannelFromCache(t);return e?d.subscribeToChannel(e).then(function(){c.sdk(f+"[subscribeTo] :: subscribed: "+t),n.resolve({code:u.OK,label:"OK"})}).catch(function(e){n.reject(e)}):d.getChannel(t).then(function(e){if(!e)return n.reject({code:u.ERRORBADREQUEST,label:"No channel found with id "+t});d.subscribeToChannel(e).then(function(){c.sdk(f+"[subscribeTo] :: subscribed: "+t),n.resolve({code:u.OK,label:"OK"})}).catch(function(e){n.reject(e)})}),n.promise},this.subscribeToChannel=function(e){var t=l.defer();return c.sdk(f+"[subscribeTo] :: Try to subscribe to a channel..."),e?d.subscribeToChannel(e).then(function(){c.sdk(f+"[subscribeTo] :: subscribed: "+e.id),t.resolve({code:u.OK,label:"OK"})}).catch(function(e){t.reject(e)}):t.reject({code:u.ERRORBADREQUEST,label:"Parameter 'channel' is missing or null"}),t.promise},this.unsubscribeFromChannelById=function(t){var n=l.defer();c.sdk(f+"[unsubscribe] :: Try to unsubscribe from a channel..."),t||n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var e=d.getChannelFromCache(t);return e?d.unsubscribeToChannel(e).then(function(){c.sdk(f+"[unsubscribe] :: unsubscribed: "+t),n.resolve({code:u.OK,label:"OK"})}).catch(function(e){n.reject(e)}):d.getChannel(t).then(function(e){if(!e)return n.reject({code:u.ERRORBADREQUEST,label:"No channel found with id "+t});d.unsubscribeToChannel(e).then(function(){c.sdk(f+"[unsubscribe] :: unsubscribed: "+t),n.resolve({code:u.OK,label:"OK"})}).catch(function(e){n.reject(e)})}),n.promise},this.unsubscribeFromChannel=function(e){var t=l.defer();return c.sdk(f+"[unsubscribe] :: Try to unsubscribe from a channel..."),e?d.unsubscribeToChannel(e).then(function(){c.sdk(f+"[unsubscribe] :: unsubscribed: "+e.id),t.resolve({code:u.OK,label:"OK"})}).catch(function(e){t.reject(e)}):t.reject({code:u.ERRORBADREQUEST,label:"Parameter 'channel' is missing or null"}),t.promise},this.updateChannel=function(t,e,n,r,i,a){var o=l.defer();if(c.sdk(f+"[updateCha  ] :: Try to update a channel..."),!t)return o.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var s={};return null!=e&&(s.topic=e),null!=n&&(s.visibility=n),null!=r&&(s.max_items=r),null!=i&&(s.max_payload_size=i),null!=a&&(s.name=a),d.updateChannel(t,s).then(function(e){e.visibility=s.visibility,c.sdk(f+"[updateCha  ] :: updated: "+t),o.resolve(e)}).catch(function(e){o.reject(e)}),o.promise},this.updateChannelVisibility=function(t,e){var n=l.defer();if(c.sdk(f+"[updateCha  ] :: Try to update visibility of a channel..."),t)if(e){var r={};null!=e&&(r.visibility=e),d.updateChannel(t,r).then(function(e){c.sdk(f+"[updateCha  ] :: updated: "+t),e.visibility=r.visibility,n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'visibility' is missing or empty"});else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.setChannelVisibilityToPublic=function(t){var n=l.defer();if(c.sdk(f+"[setChannel ] :: Try to update visibility to visible for a channel..."),t){var r={visibility:"company"};d.updateChannel(t,r).then(function(e){c.sdk(f+"[setChannel ] :: updated: "+t),e.visibility=r.visibility,n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.setChannelVisibilityToPrivate=function(t){var n=l.defer();if(c.sdk(f+"[setChannel ] :: Try to update visibility to private for a channel..."),t){var r={visibility:"private"};d.updateChannel(t,r).then(function(e){c.sdk(f+"[setChannel ] :: updated: "+t),e.visibility=r.visibility,n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.updateChannelName=function(t,e){var n=l.defer();if(c.sdk(f+"[updateCha  ] :: Try to update the name of a channel..."),t){var r={};null!=e&&(r.name=e),d.updateChannel(t,r).then(function(e){c.sdk(f+"[updateCha  ] :: updated: "+t),n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.updateChannelTopic=function(t,e){var n=l.defer();if(c.sdk(f+"[updateCha  ] :: Try to update the topic of a channel..."),t){var r={};null!=e&&(r.topic=e),d.updateChannel(t,r).then(function(e){c.sdk(f+"[updateCha  ] :: updated: "+t),n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.uploadChannelAvatar=function(e,t){var n=l.defer();return c.sdk(f+"[uploadCha  ] :: Try to update the avatar of a channel..."),e?t?d.uploadChannelAvatar(e,t,512).then(function(){c.sdk(f+"[uploadCha  ] :: updated: "+e),n.resolve({code:u.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'urlAvatar' is missing or empty"}):n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),n.promise},this.deleteChannelAvatar=function(e){var t=l.defer();return c.sdk(f+"[deleteCha  ] :: Try to delete the avatar of a channel..."),e?d.deleteChannelAvatar(e).then(function(){c.sdk(f+"[deleteCha  ] :: updated: "+e),t.resolve({code:u.OK,label:"OK"})}).catch(function(e){t.reject(e)}):t.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),t.promise},this.getChannelUsers=function(t,e){var n=l.defer();return c.sdk(f+"[getUsers   ] :: Try to get users of a channel..."),t?d.getChannelUsers(t,e).then(function(e){c.sdk(f+"[getUsers   ] :: got: "+t),n.resolve(e.data)}).catch(function(e){n.reject(e)}):n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),n.promise},this.removeAllUsersFromChannel=function(t){var n=l.defer();return c.sdk(f+"[removeAllUs] :: Try to get remove all users of a channel..."),t?d.removeAllUsersFromChannel(t).then(function(){return d.getChannel(t)}).then(function(e){c.sdk(f+"[removeAllUs] :: removed: "+t),n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),n.promise},this.updateChannelUsers=function(t,e,n){var r=l.defer();return c.sdk(f+"[updateCha  ] :: Try to get updated users of a channel..."),t?(n=n||"member",d.updateChannelUsers(t,e,n).then(function(e){c.sdk(f+"[updateCha  ] :: updated: "+t),r.resolve(e)}).catch(function(e){r.reject(e)})):r.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),r.promise},this.addMembersToChannel=function(t,e){var n=l.defer();if(c.sdk(f+"[updateCha  ] :: Try to add members to a channel..."),t){d.updateChannelUsers(t,e,"member").then(function(e){c.sdk(f+"[updateCha  ] :: updated: "+t),n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.addPublishersToChannel=function(t,e){var n=l.defer();if(c.sdk(f+"[updateCha  ] :: Try to add publishers to a channel..."),t){d.updateChannelUsers(t,e,"publisher").then(function(e){c.sdk(f+"[updateCha  ] :: updated: "+t),n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.addOwnersToChannel=function(t,e){var n=l.defer();if(c.sdk(f+"[updateCha  ] :: Try to add owners to a channel..."),t){d.updateChannelUsers(t,e,"owner").then(function(e){c.sdk(f+"[updateCha  ] :: updated: "+t),n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.removeUsersFromChannel=function(t,e){var n=l.defer();if(c.sdk(f+"[updateCha  ] :: Try to remove users from a channel..."),t){d.updateChannelUsers(t,e,"none").then(function(e){c.sdk(f+"[updateCha  ] :: updated: "+t),n.resolve(e)}).catch(function(e){n.reject(e)})}else n.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});return n.promise},this.getChannelItems=function(t,e,n,r){var i=l.defer();return c.sdk(f+"[getItems   ] :: Try to get messages of a channel..."),t?d.getChannelItems(t,e,n,r).then(function(e){c.sdk(f+"[getItems   ] :: got: "+t),i.resolve(e)}).catch(function(e){i.reject(e)}):i.reject({code:u.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"}),i.promise};a.$on("$destroy",a.$on("CHANNEL_MESSAGE_RECEIVED",function(e,t,n){c.sdk(f+"[Channel    ] :: got a message"),s.getChannel(n.channelId).then(function(e){0===t?sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCHANNELMESSAGERECEIVED,e,n):$(document).trigger(s.RAINBOW_ONCHANNELMESSAGERECEIVED,[e,n]):(c.sdk(f+"[Channel    ] :: got a retracted message"),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED,e,n):$(document).trigger(s.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED,[e,n]))})}));a.$on("$destroy",a.$on("CHANNEL_UPDATE_EVENT",function(e,t,n){c.sdk(f+"[Channel    ] :: channel updated ("+t+") id:"+n),3!==t?s.getChannel(n).then(function(e){sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCHANNELUPDATED,e,t):$(document).trigger(s.RAINBOW_ONCHANNELUPDATED,[e,t])}):sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCHANNELDELETED,n):$(document).trigger(s.RAINBOW_ONCHANNELDELETED,[n])}));a.$on("$destroy",a.$on("CHANNEL_USERS_UPDATE_EVENT",function(e,t,n){c.sdk(f+"[Channel    ] :: channel users updated, id:"+t),s.getChannel(t).then(function(e){sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCHANNELUSERSUPDATED,e,n):$(document).trigger(s.RAINBOW_ONCHANNELUSERSUPDATED,[e,n])})}));a.$on("$destroy",a.$on("ON_UPDATE_CHANNEL_AVATAR",function(e,t){s.getChannel(channelId).then(function(e){c.sdk(f+"[Channel    ] :: avatar updated for channel id:"+e.id),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCHANNELAVATARUPDATED,e):$(document).trigger(s.RAINBOW_ONCHANNELAVATARUPDATED,[e])})}));a.$on("$destroy",a.$on("CHANNEL_USER_SUBSCRIPTION_EVENT",function(e,t,n,r){var i=null;s.getChannel(n).then(function(e){return i=e,o.getContactByDBId(r,!0)}).then(function(e){e=e||r,4===t?(c.sdk(f+"[Channel    ] :: user subscribed to a channel: "+n),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCHANNELUSERSUBSCRIBED,i,e):$(document).trigger(s.RAINBOW_ONCHANNELUSERSUBSCRIBED,[i,e])):(c.sdk(f+"[Channel    ] :: user unsubscribed from a channel: "+n),sdk.useAngularEvents?a.$broadcast(s.RAINBOW_ONCHANNELUSERUNSUBSCRIBED,i,e):$(document).trigger(s.RAINBOW_ONCHANNELUSERUNSUBSCRIBED,[i,e]))})}))}]),angular.module("sdk").service("rainbowSDK",["$log","$q","$rootScope","connectionService","presenceService","contactsService","conversationsService","imService","pbxService","webRTCService","bubblesService","groupsService","callsLogService","userProfileService","settingsService","cpaasService","filesStorageService","capabilitiesService","channelsService","adminService","SDK",function(r,i,n,e,t,a,o,s,c,l,d,u,f,h,p,v,m,g,S,C,E){"use strict";var b=this,R=null;this.isReady=!1,this.RAINBOW_ONREADY="ready",this.RAINBOW_ONLOADED="loaded",this.connection=e,this.presence=t,this.contacts=a,this.conversations=o,this.im=s,this.telephony=c,this.webRTC=l,this.bubbles=d,this.groups=u,this.callsLog=f,this.userProfile=h,this.fileStorage=m,this.caps=g,this.channels=S,this.admin=C,this.version=function(){return window.version},this.mode=function(){return p.getSetting("apiMode")},this.setVerboseLog=function(e){return sdk.hasVerboseLog=e,sdk.hasVerboseLog},this.useAngularEvents=function(e){return sdk.useAngularEvents=e,sdk.useAngularEvents},this.setKeyFromConfig=function(e,t){return r.sdk("SDKSrv     | [initialize ] :: Linked to application ID "+e+" from configuration file"),sdk.key.appID=e,sdk.key.appSecret=t,!0},this.hasBeenLaunchedFromConfig=function(e){var t=e?"YES":"NO";return r.sdk("SDKSrv     | [initialize ] :: SDK lauched from a configuration file "+t),sdk.hasBeenLaunchedFromConfig=e,sdk.hasBeenLaunchedFromConfig},this.initialize=function(e,t){var n=i.defer();return e&&0<e.length?(sdk.key.appID=e,r.sdk("SDKSrv     | [initialize ] :: Initialize the SDK for the application"+sdk.key.appID+"...")):r.sdk("SDKSrv     | [initialize ] :: Initialize the SDK without an application key..."),t&&0<t.length&&(sdk.key.appSecret=t),y().then(function(){r.sdk("SDKSrv     | [initialize ] :: Initialize step 1/2 ok"),T().then(function(){r.sdk("SDKSrv     | [initialize ] :: Initialize step 2/2 ok"),r.sdk("SDKSrv     | [initialize ] :: SDK Initialized successfully!"),n.resolve()})}),n.promise};var y=function(){var e=i.defer();if(b.isReady)e.resolve();else var t=n.$on("RAINBOW_INTERNAL_READY",function(){t(),e.resolve()});return e.promise},T=function(){var e=i.defer();return DetectRTC.load(function(){I(),e.resolve()}),e.promise};this.load=function(){r.sdk("SDKSrv     | [initialize ] :: Rainbow SDK loaded!"),sdk.useAngularEvents?n.$broadcast(b.RAINBOW_ONLOADED):$(document).trigger(b.RAINBOW_ONLOADED,null)},this.ready=function(){r.sdk("SDKSrv     | [initialize ] :: Rainbow SDK ready!"),sdk.useAngularEvents?n.$broadcast(b.RAINBOW_ONREADY):$(document).trigger(b.RAINBOW_ONREADY,null)};var I=function(){r.sdk("SDKSrv     | [initialize ] :: Initializing the Rainbow SDK..."),r.sdk("SDKSrv     | [initialize ] :: -----------------------------"),r.sdk("SDKSrv     | [initialize ] :: Platform    | "+DetectRTC.osName+" "+DetectRTC.osVersion),r.sdk("SDKSrv     | [initialize ] :: Screen      | "+window.screen.width+"x"+window.screen.height),r.sdk("SDKSrv     | [initialize ] :: Cookie      | "+navigator.cookieEnabled),r.sdk("SDKSrv     | [initialize ] :: Java        | "+navigator.javaEnabled()),r.sdk("SDKSrv     | [initialize ] :: Server      | "+config.webservices.server),r.sdk("SDKSrv     | [initialize ] :: Version WEB | "+window.version),r.sdk("SDKSrv     | [initialize ] :: Version SDK | "+window.sdkversion),r.sdk("SDKSrv     | [initialize ] :: Browser     | "+DetectRTC.browser.name+" "+DetectRTC.browser.fullVersion),r.sdk("SDKSrv     | [initialize ] :: Microphone  | "+DetectRTC.hasMicrophone),r.sdk("SDKSrv     | [initialize ] :: Camera      | "+DetectRTC.hasWebcam),r.sdk("SDKSrv     | [initialize ] :: Speakers    | "+DetectRTC.hasSpeakers),r.sdk("SDKSrv     | [initialize ] :: WebRTC      | "+DetectRTC.isWebRTCSupported),r.sdk("SDKSrv     | [initialize ] :: Mode        | "+b.mode()),r.sdk("SDKSrv     | [initialize ] :: verboseLog  | "+sdk.hasVerboseLog),r.sdk("SDKSrv     | [initialize ] :: ng-events   | "+sdk.useAngularEvents),r.sdk("SDKSrv     | [initialize ] :: launcher    | "+sdk.hasBeenLaunchedFromConfig),r.sdk("SDKSrv     | [initialize ] :: appID       | "+sdk.key.appID),r.sdk("SDKSrv     | [initialize ] :: -----------------------------"),r.sdk("SDKSrv     | [initialize ] :: Initialized!"),b.ready()},N=function(){R();var e={browser:{name:DetectRTC.browser.name,fullVersion:DetectRTC.browser.fullVersion,version:DetectRTC.browser.version},screen:{displayResolution:DetectRTC.displayResolution},os:{name:DetectRTC.osName,version:DetectRTC.osVersion,isMobileDevice:!1},ua:navigator.userAgent};v.updateSession(e).then(function(){}).catch(function(){})};r.sdk("SDKSrv     | [           ] :: Welcome to the Rainbow SDK for Web!"),window.rainbowSDK=b,p.setSetting("apiMode","sdk"),config.webservices.currentServer=config.webservices.server,R=n.$on(v.RAINBOW_ONCPAAS_SESSION_CREATED,N),b.isReady=!0,n.$broadcast("RAINBOW_INTERNAL_READY"),n.$on("$destroy",function(){R&&R()})}]);